window.Laya=function(e){"use strict";class t{}t.isAntialias=!0,t.useWebGL2=!0,t.matUseUBO=!0,t.enableUniformBufferObject=!0,t.FPS=60,t.useRetinalCanvas=!1,t.animationInterval=50,t.webGL2D_MeshAllocMaxMem=!0,t.defaultFontSize=12,t.defaultFont="Arial",t.isAlpha=!1,t.isDepth=!1,t.isfailIfMajorPerformanceCaveat=!1,t.powerPreference="default",t.premultipliedAlpha=!0,t.isStencil=!0,t.preserveDrawingBuffer=!1,t.printWebglOrder=!1,t.fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"},t.fixedFrames=!0,t.destroyResourceImmediatelyDefault=!0,t._enableWindowRAFFunction=!0;const i={};class r{constructor(){}static isZero(e){return Math.abs(e)<r.zeroTolerance}static nearEqual(e,t){return!!r.isZero(e-t)}static fastInvSqrt(e){return r.isZero(e)?e:1/Math.sqrt(e)}}r.zeroTolerance=1e-6,r.MaxValue=340282347e30,r.MinValue=-340282347e30,r.Deg2Rad=Math.PI/180;class s{constructor(e=0,t=0,i=0,r=0){this.x=e,this.y=t,this.z=i,this.w=r}setValue(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}toArray(){return[this.x,this.y,this.z,this.w]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w}cloneTo(e){return e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e}clone(){var e=new s;return this.cloneTo(e),e}static lerp(e,t,i,r){var s=e.x,a=e.y,n=e.z,o=e.w;r.x=s+i*(t.x-s),r.y=a+i*(t.y-a),r.z=n+i*(t.z-n),r.w=o+i*(t.w-o)}static transformByM4x4(e,t,i){var r=e.x,s=e.y,a=e.z,n=e.w,o=t.elements;i.x=r*o[0]+s*o[4]+a*o[8]+n*o[12],i.y=r*o[1]+s*o[5]+a*o[9]+n*o[13],i.z=r*o[2]+s*o[6]+a*o[10]+n*o[14],i.w=r*o[3]+s*o[7]+a*o[11]+n*o[15]}static equals_(e,t){return r.nearEqual(Math.abs(e.x),Math.abs(t.x))&&r.nearEqual(Math.abs(e.y),Math.abs(t.y))&&r.nearEqual(Math.abs(e.z),Math.abs(t.z))&&r.nearEqual(Math.abs(e.w),Math.abs(t.w))}static equals(e,t){return r.nearEqual(e.x,t.x)&&r.nearEqual(e.y,t.y)&&r.nearEqual(e.z,t.z)&&r.nearEqual(e.w,t.w)}equal(e){return s.equals(this,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(e,t){var i=e.length();if(i>0){var r=1/i;t.x=e.x*r,t.y=e.y*r,t.z=e.z*r,t.w=e.w*r}}static add(e,t,i){i.x=e.x+t.x,i.y=e.y+t.y,i.z=e.z+t.z,i.w=e.w+t.w}static subtract(e,t,i){i.x=e.x-t.x,i.y=e.y-t.y,i.z=e.z-t.z,i.w=e.w-t.w}static multiply(e,t,i){i.x=e.x*t.x,i.y=e.y*t.y,i.z=e.z*t.z,i.w=e.w*t.w}static scale(e,t,i){i.x=e.x*t,i.y=e.y*t,i.z=e.z*t,i.w=e.w*t}static Clamp(e,t,i,r){var s=e.x,a=e.y,n=e.z,o=e.w,h=t.x,l=t.y,u=t.z,d=t.w,c=i.x,_=i.y,p=i.z,g=i.w;s=(s=s>c?c:s)<h?h:s,a=(a=a>_?_:a)<l?l:a,n=(n=n>p?p:n)<u?u:n,o=(o=o>g?g:o)<d?d:o,r.x=s,r.y=a,r.z=n,r.w=o}static distanceSquared(e,t){var i=e.x-t.x,r=e.y-t.y,s=e.z-t.z,a=e.w-t.w;return i*i+r*r+s*s+a*a}static distance(e,t){var i=e.x-t.x,r=e.y-t.y,s=e.z-t.z,a=e.w-t.w;return Math.sqrt(i*i+r*r+s*s+a*a)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static min(e,t,i){i.x=Math.min(e.x,t.x),i.y=Math.min(e.y,t.y),i.z=Math.min(e.z,t.z),i.w=Math.min(e.w,t.w)}static max(e,t,i){i.x=Math.max(e.x,t.x),i.y=Math.max(e.y,t.y),i.z=Math.max(e.z,t.z),i.w=Math.max(e.w,t.w)}}s.ZERO=new s,s.ONE=new s(1,1,1,1),s.UnitX=new s(1,0,0,0),s.UnitY=new s(0,1,0,0),s.UnitZ=new s(0,0,1,0),s.UnitW=new s(0,0,0,1),s.TEMP=new s(0,0,0,0);class a{static distanceSquared(e,t){var i=e.x-t.x,r=e.y-t.y,s=e.z-t.z;return i*i+r*r+s*s}static distance(e,t){var i=e.x-t.x,r=e.y-t.y,s=e.z-t.z;return Math.sqrt(i*i+r*r+s*s)}static min(e,t,i){i.x=Math.min(e.x,t.x),i.y=Math.min(e.y,t.y),i.z=Math.min(e.z,t.z)}static max(e,t,i){i.x=Math.max(e.x,t.x),i.y=Math.max(e.y,t.y),i.z=Math.max(e.z,t.z)}static transformQuat(e,t,i){var r=e.x,s=e.y,a=e.z,n=t.x,o=t.y,h=t.z,l=t.w,u=l*r+o*a-h*s,d=l*s+h*r-n*a,c=l*a+n*s-o*r,_=-n*r-o*s-h*a;i.x=u*l+_*-n+d*-h-c*-o,i.y=d*l+_*-o+c*-n-u*-h,i.z=c*l+_*-h+u*-o-d*-n}static scalarLength(e){var t=e.x,i=e.y,r=e.z;return Math.sqrt(t*t+i*i+r*r)}static scalarLengthSquared(e){var t=e.x,i=e.y,r=e.z;return t*t+i*i+r*r}static normalize(e,t){var i=e.x,r=e.y,s=e.z,a=i*i+r*r+s*s;a>0&&(a=1/Math.sqrt(a),t.x=i*a,t.y=r*a,t.z=s*a)}static multiply(e,t,i){i.x=e.x*t.x,i.y=e.y*t.y,i.z=e.z*t.z}static scale(e,t,i){i.x=e.x*t,i.y=e.y*t,i.z=e.z*t}static lerp(e,t,i,r){var s=e.x,a=e.y,n=e.z;r.x=s+i*(t.x-s),r.y=a+i*(t.y-a),r.z=n+i*(t.z-n)}static transformV3ToV3(e,t,i){a.transformV3ToV4(e,t,n),i.x=n.x,i.y=n.y,i.z=n.z}static transformV3ToV4(e,t,i){var r=e.x,s=e.y,a=e.z,n=t.elements;i.x=r*n[0]+s*n[4]+a*n[8]+n[12],i.y=r*n[1]+s*n[5]+a*n[9]+n[13],i.z=r*n[2]+s*n[6]+a*n[10]+n[14],i.w=r*n[3]+s*n[7]+a*n[11]+n[15]}static TransformNormal(e,t,i){var r=e.x,s=e.y,a=e.z,n=t.elements;i.x=r*n[0]+s*n[4]+a*n[8],i.y=r*n[1]+s*n[5]+a*n[9],i.z=r*n[2]+s*n[6]+a*n[10]}static transformCoordinate(e,t,i){var r=e.x,s=e.y,a=e.z,n=t.elements,o=r*n[3]+s*n[7]+a*n[11]+n[15];i.x=(r*n[0]+s*n[4]+a*n[8]+n[12])/o,i.y=(r*n[1]+s*n[5]+a*n[9]+n[13])/o,i.z=(r*n[2]+s*n[6]+a*n[10]+n[14])/o}static Clamp(e,t,i,r){var s=e.x,a=e.y,n=e.z,o=t.x,h=t.y,l=t.z,u=i.x,d=i.y,c=i.z;s=(s=s>u?u:s)<o?o:s,a=(a=a>d?d:a)<h?h:a,n=(n=n>c?c:n)<l?l:n,r.x=s,r.y=a,r.z=n}static add(e,t,i){i.x=e.x+t.x,i.y=e.y+t.y,i.z=e.z+t.z}static subtract(e,t,i){i.x=e.x-t.x,i.y=e.y-t.y,i.z=e.z-t.z}static cross(e,t,i){var r=e.x,s=e.y,a=e.z,n=t.x,o=t.y,h=t.z;i.x=s*h-a*o,i.y=a*n-r*h,i.z=r*o-s*n}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static equals(e,t){return r.nearEqual(e.x,t.x)&&r.nearEqual(e.y,t.y)&&r.nearEqual(e.z,t.z)}constructor(e=0,t=0,i=0){this.x=e,this.y=t,this.z=i}equal(e){return a.equals(this,e)}setValue(e,t,i){return this.x=e,this.y=t,this.z=i,this}set(e,t,i){return this.x=e,this.y=t,this.z=i,this}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}toArray(){return[this.x,this.y,this.z]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}vsub(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t}vadd(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t}scale(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t}normalize(){let e=this.x,t=this.y,i=this.z;var r=e*e+t*t+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=i*r),this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e,t){var i=this.x,r=this.y,s=this.z,a=e.x,n=e.y,o=e.z;return t.x=r*o-s*n,t.y=s*a-i*o,t.z=i*n-r*a,t}cloneTo(e){return e.x=this.x,e.y=this.y,e.z=this.z,e}clone(){var e=new a;return this.cloneTo(e),e}toDefault(){this.x=0,this.y=0,this.z=0}}a.ZERO=new a(0,0,0),a.ONE=new a(1,1,1),a.NegativeUnitX=new a(-1,0,0),a.UnitX=new a(1,0,0),a.UnitY=new a(0,1,0),a.UnitZ=new a(0,0,1),a.ForwardRH=new a(0,0,-1),a.ForwardLH=new a(0,0,1),a.Up=new a(0,1,0),a.TEMP=new a;const n=new s;class o{static setResolution(e,t){o.customResolution=!0,o._resoluWidth=e,o._resoluHeight=t}}o.enableDynamicBatch=!0,o.enableStaticBatch=!0,o.pixelRatio=1,o.customResolution=!1,o.defaultCacheRTMemory=256,o.defaultPhysicsMemory=16,o.enableMultiLight=!0,o.maxLightCount=32,o.lightClusterCount=new a(12,12,12),o.maxMorphTargetCount=32,o.useBVHCull=!1,o.BVH_max_SpatialCount=7,o.BVH_limit_size=32,o.BVH_Min_Build_nums=10,o._resoluWidth=-1,o._resoluHeight=-1,o.debugFrustumCulling=!1;class h{}h.Loader=null,h.Context=null,h.Browser=null,h.InputManager=null,h.Laya=null,h.loader=null,h.timer=null,h.systemTimer=null,h.physicsTimer=null,h.stage=null;class l{static getPoolBySign(e){return l._poolDic[e]||(l._poolDic[e]=[])}static clearBySign(e){l._poolDic[e]&&(l._poolDic[e].length=0)}static recover(e,t){t[l.POOLSIGN]||(t[l.POOLSIGN]=!0,l.getPoolBySign(e).push(t))}static recoverByClass(e){if(e){var t=e.__className||e.constructor._$gid;t&&l.recover(t,e)}}static _getClassSign(e){var t=e.__className||e._$gid;return t||(e._$gid=t=l._CLSID+"",l._CLSID++),t}static createByClass(e){return l.getItemByClass(l._getClassSign(e),e)}static getItemByClass(e,t){let i,r=l.getPoolBySign(e);return i=r.length?r.pop():new t,i[l.POOLSIGN]=!1,i}static getItemByCreateFun(e,t,i=null){var r=l.getPoolBySign(e),s=r.length?r.pop():t.call(i);return s[l.POOLSIGN]=!1,s}static getItem(e){var t=l.getPoolBySign(e),i=t.length?t.pop():null;return i&&(i[l.POOLSIGN]=!1),i}static createPool(e,t,i){return new u(e,t,i)}}l._CLSID=0,l.POOLSIGN="__InPool",l._poolDic={};class u{constructor(e,t,i){this._init=t,this._reset=i,this._ct=e,this.pool=[]}take(...e){let t;return t=this.pool.length>0?this.pool.pop():new this._ct,this._init&&this._init(t,...e),t}recover(e){if(Array.isArray(e)){for(let t=0,i=e.length;t<i;t++){let i=e[t];this._reset&&this._reset(i),this.pool.push(i)}e.length=0}else this._reset&&this._reset(e),this.pool.push(e)}}class d{constructor(e=0,t=0){this.x=e,this.y=t}static create(){return l.getItemByClass("Point",d)}setTo(e,t){return this.x=e,this.y=t,this}reset(){return this.x=this.y=0,this}recover(){l.recover("Point",this.reset())}distance(e,t){return Math.sqrt((this.x-e)*(this.x-e)+(this.y-t)*(this.y-t))}toString(){return this.x+","+this.y}normalize(){var e=Math.sqrt(this.x*this.x+this.y*this.y);if(e>0){var t=1/e;this.x*=t,this.y*=t}}copy(e){return this.setTo(e.x,e.y)}}d.TEMP=new d,d.EMPTY=new d;class c{static isMouseEvent(e){return _.has(e)}constructor(){this.touchId=0,this.delta=0,this.button=0,this.touchPos=new d}setTo(e,t,i){return this.type=e,this.currentTarget=t,this.target=i,this}stopPropagation(){this._stopped=!0}preventDefault(){this._defaultPrevented=!0}get touches(){return this._touches}get altKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.altKey}get ctrlKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.ctrlKey}get shiftKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.shiftKey}get metaKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.metaKey}get key(){return this.nativeEvent.key}get keyCode(){return this.nativeEvent.keyCode}get charCode(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.code}get keyLocation(){return this.nativeEvent?this.nativeEvent.location||this.nativeEvent.keyLocation:0}get stageX(){return this.touchPos.x}get stageY(){return this.touchPos.y}}c.EMPTY=new c,c.MOUSE_DOWN="mousedown",c.MOUSE_UP="mouseup",c.RIGHT_MOUSE_DOWN="rightmousedown",c.RIGHT_MOUSE_UP="rightmouseup",c.CLICK="click",c.RIGHT_CLICK="rightclick",c.MOUSE_MOVE="mousemove",c.MOUSE_OVER="mouseover",c.MOUSE_OUT="mouseout",c.MOUSE_WHEEL="mousewheel",c.ROLL_OVER="mouseover",c.ROLL_OUT="mouseout",c.DOUBLE_CLICK="doubleclick",c.MOUSE_DRAG="mousedrag",c.MOUSE_DRAG_END="mousedragend",c.DRAG_START="dragstart",c.DRAG_MOVE="dragmove",c.DRAG_END="dragend",c.DROP="drop",c.KEY_DOWN="keydown",c.KEY_PRESS="keypress",c.KEY_UP="keyup",c.CHANGE="changed",c.CHANGED="changed",c.MOVED="moved",c.WILL_RESIZE="willResize",c.RESIZE="resize",c.ADDED="added",c.REMOVED="removed",c.DISPLAY="display",c.UNDISPLAY="undisplay",c.ERROR="error",c.COMPLETE="complete",c.LOADED="loaded",c.READY="ready",c.PROGRESS="progress",c.INPUT="input",c.RENDER="render",c.OPEN="open",c.MESSAGE="message",c.CLOSE="close",c.FRAME="enterframe",c.ENTER="enter",c.SELECT="select",c.BLUR="blur",c.FOCUS="focus",c.VISIBILITY_CHANGE="visibilitychange",c.FOCUS_CHANGE="focuschange",c.PLAYED="played",c.PAUSED="paused",c.STOPPED="stopped",c.START="start",c.END="end",c.LINK="link",c.LABEL="label",c.FULL_SCREEN_CHANGE="fullscreenchange",c.DEVICE_LOST="devicelost",c.TRANSFORM_CHANGED="transformchanged",c.LAYER_CHANGE="layerChange",c.STATIC_MASK="staticMask",c.TRIGGER_ENTER="triggerenter",c.TRIGGER_STAY="triggerstay",c.TRIGGER_EXIT="triggerexit",c.COLLISION_ENTER="collisionenter",c.COLLISION_STAY="collisionstay",c.COLLISION_EXIT="collisionexit",c.JOINT_BREAK="jointbreak",c.UPDATE_PHY_EVENT_FILTER="physics3dEventFilter";const _=new Set([c.MOUSE_DOWN,c.MOUSE_UP,c.MOUSE_MOVE,c.CLICK,c.DOUBLE_CLICK,c.RIGHT_CLICK,c.RIGHT_MOUSE_DOWN,c.RIGHT_MOUSE_UP,c.MOUSE_OVER,c.MOUSE_OUT,c.MOUSE_WHEEL,c.MOUSE_DRAG,c.MOUSE_DRAG_END]);class p{}p.version="3.3.0-beta.2",p.isPlaying=!0,p.isPreview=!1,p.isConch=!!window&&null!=window.conch;class g{}class m{static hexToString(e){if(e<0||isNaN(e))return"#000000";let t=Math.floor(e).toString(16);for(;t.length<6;)t="0"+t;return"#"+t}static stringToHex(e){if(!e)return 0;if(e.indexOf("rgba(")>=0||e.indexOf("rgb(")>=0){let t=e.indexOf("("),i=e.indexOf(")");if(-1==t||-1==i)return 0;let r=(e=e.substring(t+1,i)).split(","),s=r.length;for(let e=0;e<s;e++)r[e]=parseFloat(r[e]),isNaN(r[e])&&(r[e]=0);return 4==r.length?(r[0]<<24)+(r[1]<<16)+(r[2]<<8)+Math.round(255*r[3]):(r[0]<<16)+(r[1]<<8)+r[2]}{"#"===e.charAt(0)&&(e=e.substring(1));let t=e.length;if(3===t||4===t){let i="";for(let r=0;r<t;r++)i+=e[r]+e[r];e=i}return parseInt(e,16)}}static gammaToLinearSpace(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}static linearToGammaSpace(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}constructor(e=1,t=1,i=1,r=1){this.r=e,this.g=t,this.b=i,this.a=r}equal(e){if(!e)return!1;const t=(e,t)=>{var i=1e-5;return-i<e-t&&e-t<i};return t(e.r,this.r)&&t(e.g,this.g)&&t(e.b,this.b)&&t(e.a,this.a)}toLinear(e){e.r=m.gammaToLinearSpace(this.r),e.g=m.gammaToLinearSpace(this.g),e.b=m.gammaToLinearSpace(this.b),e.a=this.a}toGamma(e){e.r=m.linearToGammaSpace(this.r),e.g=m.linearToGammaSpace(this.g),e.b=m.linearToGammaSpace(this.b),e.a=this.a}cloneTo(e){e.r=this.r,e.g=this.g,e.b=this.b,e.a=this.a}scale(e){return this.r=this.r*e,this.g=this.g*e,this.b=this.b*e,this}setValue(e,t,i,r){return this.r=e,this.g=t,this.b=i,this.a=r,this}fromArray(e,t=0){this.r=e[t+0],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3]}toArray(){return[this.r,this.g,this.b,this.a]}writeTo(e,t=0){e[t+0]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a}clone(){var e=new m;return this.cloneTo(e),e}}var f,T,y,x;m.RED=new m(1,0,0,1),m.GREEN=new m(0,1,0,1),m.BLUE=new m(0,0,1,1),m.CYAN=new m(0,1,1,1),m.YELLOW=new m(1,.92,.016,1),m.MAGENTA=new m(1,0,1,1),m.GRAY=new m(.5,.5,.5,1),m.WHITE=new m(1,1,1,1),m.BLACK=new m(0,0,0,1),m.CLEAR=new m(0,0,0,0),e.RenderTargetFormat=void 0,(f=e.RenderTargetFormat||(e.RenderTargetFormat={}))[f.None=-1]="None",f[f.R8G8B8=0]="R8G8B8",f[f.R8G8B8A8=1]="R8G8B8A8",f[f.R16G16B16A16=17]="R16G16B16A16",f[f.R32G32B32=30]="R32G32B32",f[f.R32G32B32A32=15]="R32G32B32A32",f[f.R16G16B16=31]="R16G16B16",f[f.DEPTH_16=35]="DEPTH_16",f[f.STENCIL_8=36]="STENCIL_8",f[f.DEPTHSTENCIL_24_8=37]="DEPTHSTENCIL_24_8",f[f.DEPTH_32=38]="DEPTH_32",f[f.DEPTHSTENCIL_24_Plus=39]="DEPTHSTENCIL_24_Plus",e.TextureDimension=void 0,(T=e.TextureDimension||(e.TextureDimension={}))[T.Tex2D=0]="Tex2D",T[T.Cube=1]="Cube",T[T.Tex3D=2]="Tex3D",T[T.Texture2DArray=3]="Texture2DArray",T[T.CubeArray=4]="CubeArray",T[T.Unkonw=5]="Unkonw",T[T.None=6]="None",e.HDREncodeFormat=void 0,(y=e.HDREncodeFormat||(e.HDREncodeFormat={}))[y.NONE=0]="NONE",y[y.RGBM=1]="RGBM",y[y.RGBD=2]="RGBD",e.TextureFormat=void 0,(x=e.TextureFormat||(e.TextureFormat={}))[x.R8G8B8=0]="R8G8B8",x[x.R8G8B8A8=1]="R8G8B8A8",x[x.R5G6B5=16]="R5G6B5",x[x.Alpha8=2]="Alpha8",x[x.DXT1=3]="DXT1",x[x.DXT3=29]="DXT3",x[x.DXT5=4]="DXT5",x[x.ETC1RGB=5]="ETC1RGB",x[x.ETC2RGB=6]="ETC2RGB",x[x.ETC2RGBA=7]="ETC2RGBA",x[x.ETC2SRGB_Alpha8=8]="ETC2SRGB_Alpha8",x[x.ETC2SRGB=28]="ETC2SRGB",x[x.ETC2RGB_Alpha1=32]="ETC2RGB_Alpha1",x[x.ETC2SRGB_Alpha1=33]="ETC2SRGB_Alpha1",x[x.PVRTCRGB_2BPPV=9]="PVRTCRGB_2BPPV",x[x.PVRTCRGBA_2BPPV=10]="PVRTCRGBA_2BPPV",x[x.PVRTCRGB_4BPPV=11]="PVRTCRGB_4BPPV",x[x.PVRTCRGBA_4BPPV=12]="PVRTCRGBA_4BPPV",x[x.R32G32B32A32=15]="R32G32B32A32",x[x.R32G32B32=30]="R32G32B32",x[x.R16G16B16A16=17]="R16G16B16A16",x[x.R16G16B16=31]="R16G16B16",x[x.ASTC4x4=18]="ASTC4x4",x[x.ASTC4x4SRGB=23]="ASTC4x4SRGB",x[x.ASTC6x6=19]="ASTC6x6",x[x.ASTC6x6SRGB=24]="ASTC6x6SRGB",x[x.ASTC8x8=20]="ASTC8x8",x[x.ASTC8x8SRGB=25]="ASTC8x8SRGB",x[x.ASTC10x10=21]="ASTC10x10",x[x.ASTC10x10SRGB=26]="ASTC10x10SRGB",x[x.ASTC12x12=22]="ASTC12x12",x[x.ASTC12x12SRGB=27]="ASTC12x12SRGB",x[x.KTXTEXTURE=-1]="KTXTEXTURE",x[x.PVRTEXTURE=-2]="PVRTEXTURE";class v{constructor(){this._flag=0,this._items=[]}add(e,t,i){let r=this._items,s=r.findIndex(((i,r,s)=>i==e&&s[r+1]==t));-1!=s?(r[s+2]=i,r[s+3]=1):r.push(e,t,i,1)}once(e,t,i){let r=this._items,s=r.findIndex(((i,r,s)=>i==e&&s[r+1]==t));-1!=s?(r[s+2]=i,r[s+3]=2):r.push(e,t,i,2)}remove(e,t){let i=this._items,r=i.findIndex(((i,r,s)=>i==e&&s[r+1]==t));-1!=r&&(0!=this._flag?(i[r+3]=0,this._flag=2):i.splice(r,4))}clear(){let e=this._items;0!=this._flag?(e.forEach(((e,t,i)=>{t%4==3&&(i[t]=0)})),this._flag=2):e.length=0}clearForTarget(e){if(!e)return;let t=this._items;if(0!=this._flag)t.forEach(((t,i,r)=>{i%4==1&&r[i]==e&&(r[i+2]=0)})),this._flag=2;else{let i=t.length-4;for(;i>=0;)t[i+1]==e&&t.splice(i,4),i-=4}}get count(){return this._items.length/4}invoke(...e){if(0!=this._flag)return;this._flag=1;let t=this._items,i=t.length;for(let r=0;r<i;r+=4){if(0==t[r+3])continue;let i=t[r+2];try{null!=i?t[r].call(t[r+1],...i,...e):t[r].call(t[r+1],...e)}catch(e){console.error(e)}2==t[r+3]&&(t[r+3]=0,this._flag=2)}if(2==this._flag){let e=t.length,i=0;for(;i<e;)0!=t[i+3]?i+=4:(t.splice(i,4),e-=4)}this._flag=0}}const S=[];class D{onStartListeningToType(e){}hasListener(e){let t=this._events&&this._events[e];return!!t&&t.count>0}event(e,t){let i=this._events&&this._events[e];if(!i)return!1;let r=i.count>0;if(Array.isArray(t))i.invoke(...t);else if(void 0!==t)i.invoke(t);else if(t===c.EMPTY){let t=S.length>0?S.pop():new c;i.invoke(t.setTo(e,this,this)),t.target=t.currentTarget=null,S.push(t)}else i.invoke();return r}on(e,t,i,r){2==arguments.length&&(i=t,t=null),this._events||(this._events={});let s=this._events[e];return s||(this.onStartListeningToType(e),this._events[e]=s=new v),s.add(i,t,r),this}once(e,t,i,r){2==arguments.length&&(i=t,t=null),this._events||(this._events={});let s=this._events[e];return s||(this.onStartListeningToType(e),this._events[e]=s=new v),s.once(i,t,r),this}off(e,t,i){2==arguments.length&&(i=t,t=null);let r=this._events&&this._events[e];return r&&r.remove(i,t),this}offAll(e){if(null==e)this._events=null;else{let t=this._events&&this._events[e];t&&t.clear()}return this}offAllCaller(e){if(e&&this._events)for(let t in this._events)this._events[t].clearForTarget(e);return this}}var E,w=0,R=0,C=0;class A extends D{static get cpuMemory(){return A._cpuMemory}static get gpuMemory(){return A._gpuMemory}static _addCPUMemory(e){A._cpuMemory+=e}static _addGPUMemory(e){A._gpuMemory+=e}static _addMemory(e,t){A._cpuMemory+=e,A._gpuMemory+=t}static destroyUnusedResources(){R=0,C=0,h.loader.loading?h.timer.frameLoop(1,A,A._destroyUnusedResources):A._destroyUnusedResources(!0)}static _destroyUnusedResources(e){if(!e&&h.loader.loading)return;h.timer.clear(A,A._destroyUnusedResources);let t=0;for(let e in A._idResourcesMap){let i=A._idResourcesMap[e];i.lock||0!==i._referenceCount||(i.destroy(),t++)}A.DEBUG&&t>0&&console.debug(`destroyUnusedResources(${t})`),t>0&&C<5&&(C++,h.timer.frameLoop(1,A,A._destroyUnusedResources))}get id(){return this._id}get cpuMemory(){return this._cpuMemory}get gpuMemory(){return this._gpuMemory}get destroyed(){return this._destroyed}get obsolute(){return this._obsolute}set obsolute(e){this._obsolute!=e&&(this._obsolute=e,e&&!p.isPlaying&&this.event("obsolute"))}get deps(){return this._deps}get referenceCount(){return this._referenceCount}constructor(e){super(),this._cpuMemory=0,this._gpuMemory=0,this._id=0,this._referenceCount=0,this._id=++w,this._destroyed=!1,this._referenceCount=0,(null==e||e)&&(A._idResourcesMap[this._id]=this),this.lock=!1,this.destroyedImmediately=!0,this._deps=[],this._traceDeps=!1}_setCPUMemory(e){var t=e-this._cpuMemory;this._cpuMemory=e,A._addCPUMemory(t)}_setGPUMemory(e){var t=e-this._gpuMemory;this._gpuMemory=e,A._addGPUMemory(t)}_setCreateURL(e,t){this.url=e,this.uuid=t}isCreateFromURL(e){return this.uuid&&e.length===this.uuid.length+6&&e.endsWith(this.uuid)||this.url===e}_addReference(e=1){this._referenceCount+=e}_removeReference(e=1){this._referenceCount-=e,R>0&&this._referenceCount<=0&&!this.lock&&this.destroyedImmediately&&this.destroy()}_clearReference(){this._referenceCount=0}addDep(e){e instanceof A&&(e._addReference(),this._deps.push(e),!p.isPlaying&&e._traceDeps&&e.on("obsolute",this,this.onDepObsolute))}addDeps(e){for(let t of e)t instanceof A&&(t._addReference(),this._deps.push(t),!p.isPlaying&&t._traceDeps&&t.on("obsolute",this,this.onDepObsolute))}onDepObsolute(){this.obsolute=!0}_disposeResource(){}destroy(){if(!this._destroyed){this._destroyed=!0,this.lock=!1,R++,this._disposeResource();for(let e of this._deps)e._removeReference(),!p.isPlaying&&e._traceDeps&&e.off("obsolute",this,this.onDepObsolute);R--,this.offAll(),delete A._idResourcesMap[this.id],this.url&&(A.DEBUG&&console.debug(`destroy ${Object.getPrototypeOf(this).constructor.name} ${this.url}`),h.loader.clearRes(this.url,this))}}}A._idResourcesMap={},A._cpuMemory=0,A._gpuMemory=0,A.DEBUG=!1;class M extends A{get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}get dimension(){return this._dimension}get format(){return this._format}get mipmap(){return this._texture.mipmap}get mipmapCount(){return this._texture.mipmapCount}get anisoLevel(){return this._texture.anisoLevel}set anisoLevel(e){this._texture.anisoLevel=e}get filterMode(){return this._texture.filterMode}set filterMode(e){this._texture.filterMode=e}get wrapModeU(){return this._texture.wrapU}set wrapModeU(e){this._texture.wrapU=e}get wrapModeV(){return this._texture.wrapV}set wrapModeV(e){this._texture.wrapV=e}get wrapModeW(){return this._texture.wrapW}set wrapModeW(e){this._texture.wrapW=e}get compareMode(){return this._texture.compareMode}set compareMode(e){this._texture.compareMode=g.textureContext.setTextureCompareMode(this._texture,e)}get gammaCorrection(){return this._texture.gammaCorrection}get baseMipmapLevel(){return this._texture.baseMipmapLevel}set baseMipmapLevel(e){this._texture.baseMipmapLevel=e}get maxMipmapLevel(){return this._texture.maxMipmapLevel}set maxMipmapLevel(e){this._texture.maxMipmapLevel=e}get gammaSpace(){return this._texture.useSRGBLoad||this._texture.gammaCorrection>1}constructor(i,r,s){super(),this._gammaSpace=!1,this._width=i,this._height=r,this._format=s,this.destroyedImmediately=t.destroyResourceImmediatelyDefault,this.hdrEncodeFormat=e.HDREncodeFormat.NONE}gpuCompressFormat(){switch(this._format){case e.TextureFormat.R8G8B8:case e.TextureFormat.R8G8B8A8:case e.TextureFormat.R16G16B16:case e.TextureFormat.R16G16B16A16:case e.TextureFormat.R32G32B32:case e.TextureFormat.R32G32B32A32:case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return!1;case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:case e.TextureFormat.ETC1RGB:case e.TextureFormat.ETC2RGB:case e.TextureFormat.ETC2RGBA:case e.TextureFormat.ETC2SRGB_Alpha8:case e.TextureFormat.ETC2SRGB:case e.TextureFormat.ETC2RGB_Alpha1:case e.TextureFormat.ETC2SRGB_Alpha1:case e.TextureFormat.PVRTCRGB_2BPPV:case e.TextureFormat.PVRTCRGBA_2BPPV:case e.TextureFormat.PVRTCRGB_4BPPV:case e.TextureFormat.PVRTCRGBA_4BPPV:case e.TextureFormat.ASTC4x4:case e.TextureFormat.ASTC4x4SRGB:case e.TextureFormat.ASTC6x6:case e.TextureFormat.ASTC6x6SRGB:case e.TextureFormat.ASTC8x8:case e.TextureFormat.ASTC8x8SRGB:case e.TextureFormat.ASTC10x10:case e.TextureFormat.ASTC10x10SRGB:case e.TextureFormat.ASTC12x12:case e.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}_getFormatByteCount(){switch(this._format){case e.TextureFormat.R8G8B8:return 3;case e.TextureFormat.R8G8B8A8:return 4;case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return 1;case e.TextureFormat.R16G16B16A16:return 2;case e.TextureFormat.R32G32B32A32:return 4;default:throw"Texture2D: unknown format."}}_getSource(){return this._texture.resource}get defaultTexture(){throw"defaulte"}_disposeResource(){this._texture.dispose()}}e.DepthTextureMode=void 0,(E=e.DepthTextureMode||(e.DepthTextureMode={}))[E.None=0]="None",E[E.Depth=1]="Depth",E[E.DepthNormals=2]="DepthNormals",E[E.DepthAndDepthNormals=3]="DepthAndDepthNormals",E[E.MotionVectors=4]="MotionVectors";class b extends M{static createFromPool(e,t,i,r,s=!1,a=1,n=!1,o=!1){s=s&&0==(e&e-1)&&0==(t&t-1);let h=b._pool.length;for(let l=0;l<h;l++){let u=b._pool[l];if(u.width==e&&u.height==t&&u.colorFormat==i&&u.depthStencilFormat==r&&u._generateMipmap==s&&u.multiSamples==a&&u.generateDepthTexture==n&&u._gammaSpace==o){u._inPool=!1;let e=b._pool[h-1];return b._pool[l]=e,b._pool.length-=1,b._poolMemory-=u._renderTarget.gpuMemory/1024/1024,u}}let l=new b(e,t,i,r,s,a,n,o);return l.lock=!0,l}static recoverToPool(e){e._inPool||e.destroyed||(b._pool.push(e),b._poolMemory+=e._renderTarget.gpuMemory/1024/1024,e._inPool=!0)}static clearPool(){if(!(b._poolMemory<o.defaultCacheRTMemory)){for(var e in b._pool)b._pool[e].destroy();b._pool=[],b._poolMemory=0}}static get bindCanvasRender(){return b._bindCanvasRender}static set bindCanvasRender(e){e!=this._bindCanvasRender&&(this._bindCanvasRender=e)}get generateDepthTexture(){return this._generateDepthTexture}set generateDepthTexture(t){this.depthStencilFormat!=e.RenderTargetFormat.None?(t&&!this._depthStencilTexture&&(this._depthStencilTexture=new M(this.width,this.height,this.depthStencilFormat),this._depthStencilTexture._dimension=e.TextureDimension.Tex2D,this._depthStencilTexture._texture=g.textureContext.createRenderTargetDepthTexture(this._renderTarget,e.TextureDimension.Tex2D,this.width,this.height)),this._generateDepthTexture=t):this._generateDepthTexture=!1}get depthStencilTexture(){return this._depthStencilTexture}get colorFormat(){return this._renderTarget.colorFormat}get depthStencilFormat(){return this._renderTarget.depthStencilFormat}get multiSamples(){return this._renderTarget._samples}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}constructor(t,i,r,s,a=!1,n=1,o=!1,h=!1){super(t,i,r),this._inPool=!1,this._isCameraTarget=!1,this._generateDepthTexture=!1,this._gammaSpace=h,this._depthStencilFormat=null==s?e.RenderTargetFormat.None:s,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=o,this._createRenderTarget()}_createRenderTarget(){this._dimension=e.TextureDimension.Tex2D,this._renderTarget=g.textureContext.createRenderTargetInternal(this.width,this.height,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._generateMipmap=this._renderTarget._generateMipmap,this._renderTarget._texturesResolve?this._texture=this._renderTarget._texturesResolve[0]:this._texture=this._renderTarget._textures[0],this.generateDepthTexture=this._generateDepthTexture}recreate(t,i,r,s,a=!1,n=1,o=!1,h=!1){this._width=t,this._height=i,this._format=r,this._gammaSpace=h,this._depthStencilFormat=null==s?e.RenderTargetFormat.None:s,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=o,this._disposeResource(),this._createRenderTarget()}getData(e,t,i,r,s){return g.textureContext.readRenderTargetPixelData(this._renderTarget,e,t,i,r,s),s}getDataAsync(e,t,i,r,s){return g.textureContext.readRenderTargetPixelDataAsync(this._renderTarget,e,t,i,r,s)}_disposeResource(){var e;this._renderTarget.dispose(),this._renderTarget=null,null===(e=this._depthStencilTexture)||void 0===e||e.destroy(),this._depthStencilTexture=null}}b._pool=[],b._poolMemory=0;class I{static __init__(){var e;let i=window.Laya||h.Laya;if(I._window)return I._window;let r,s=I._window=window,a=I._document=s.document,n=I.userAgent=s.navigator.userAgent,o=s.navigator.maxTouchPoints||0,l=s.navigator.platform;window.conch&&"conchUseWXAdapter"in I.window&&(r=["wxMiniGame","MiniAdpter","wx"]),"my"in I.window&&(n.indexOf("TB/")>-1||n.indexOf("Taobao/")>-1||n.indexOf("TM/")>-1?r=["tbMiniGame","TBMiniAdapter","my"]:n.indexOf("AlipayMiniGame")>-1&&(r=["aliPayMiniGame","ALIMiniAdapter","my"])),(-1==n.indexOf("OPPO")&&n.indexOf("MiniGame")>-1||-1!=n.indexOf("runtime")||-1!=n.indexOf("miniprogram")&&window.isWXMiMi)&&"wx"in I.window&&(r="tt"in I.window?["ttMiniGame","TTMiniAdapter","tt"]:"bl"in I.window?["biliMiniGame","BLMiniAdapter",null]:"qq"in I.window?["qqMiniGame","QQMiniAdapter",null]:["wxMiniGame","MiniAdpter","wx"]),"hbs"in I.window&&(r=["hwMiniGame","HWMiniAdapter",null]),n.indexOf("SwanGame")>-1&&(r=["bdMiniGame","BMiniAdapter",null]),n.indexOf("QuickGame")>-1&&(r=["miMiniGame","KGMiniAdapter","qg"]),n.indexOf("OPPO")>-1&&n.indexOf("MiniGame")>-1&&(r=["qgMiniGame","QGMiniAdapter","qg"],t.fixedFrames=!1),n.indexOf("VVGame")>-1&&(r=["vvMiniGame","VVMiniAdapter","qg"],t.fixedFrames=!1),null!=r&&(I.window[r[0]](i,i),i[r[1]].enable(),I.miniGameContext=I.window[r[2]]),s.trace=console.log,s.requestAnimationFrame=s.requestAnimationFrame||s.webkitRequestAnimationFrame||s.mozRequestAnimationFrame||s.oRequestAnimationFrame||s.msRequestAnimationFrame||function(e){return s.setTimeout(e,1e3/60)};var u=a.body.style;u.margin=0,u.overflow="hidden",u["-webkit-user-select"]="none",u["-webkit-tap-highlight-color"]="rgba(200,200,200,0)";var d=a.getElementsByTagName("meta");let c,_={width:"device-width","initial-scale":"1.0","minimum-scale":"1.0","maximum-scale":"1.0","user-scalable":"no"};for(const e of d)if("viewport"==e.name){c=e;break}if(c){let e=(c.content||"").split(",");for(let t of e){let e=t.split("=");_[e[0].trim()]||(_[e[0]]=e[1])}}else c=a.createElement("meta"),c.name="viewport",null===(e=a.getElementsByTagName("head")[0])||void 0===e||e.appendChild(c);return c.content=Object.keys(_).map((e=>e+"="+_[e])),I.onMobile=!!window.conch||n.indexOf("Mobile")>-1,I.onIOS=!!n.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),I.onIPhone=n.indexOf("iPhone")>-1,I.onMac=n.indexOf("Mac OS X")>-1,I.onIPad=n.indexOf("iPad")>-1||"MacIntel"===l&&o>1,I.onAndroid=n.indexOf("Android")>-1||n.indexOf("Adr")>-1,I.onOpenHarmonyOS=n.indexOf("OpenHarmony")>-1,I.onWP=n.indexOf("Windows Phone")>-1,I.onQQBrowser=n.indexOf("QQBrowser")>-1,I.onMQQBrowser=n.indexOf("MQQBrowser")>-1||n.indexOf("Mobile")>-1&&n.indexOf("QQ")>-1,I.onIE=!!s.ActiveXObject||"ActiveXObject"in s,I.onWeiXin=n.indexOf("MicroMessenger")>-1,I.onSafari=n.indexOf("Safari")>-1&&-1===n.indexOf("Chrome"),I.onChrome=n.indexOf("Chrome")>-1,I.onPC=!I.onMobile,I.onFirefox=n.indexOf("Firefox")>-1,I.onEdge=n.indexOf("Edge")>-1||n.indexOf("Edg")>-1,I.onMiniGame=n.indexOf("MiniGame")>-1,I.onBDMiniGame=n.indexOf("SwanGame")>-1,I.onLayaRuntime=!!window.conch,n.indexOf("OPPO")>-1&&n.indexOf("MiniGame")>-1?(I.onQGMiniGame=!0,I.onMiniGame=!1):"qq"in I.window&&n.indexOf("MiniGame")>-1?(I.onQQMiniGame=!0,I.onMiniGame=!1):"bl"in I.window&&n.indexOf("MiniGame")>-1?(I.onBLMiniGame=!0,I.onMiniGame=!1):"tt"in I.window&&n.indexOf("MiniGame")>-1&&(I.onTTMiniGame=!0,I.onMiniGame=!1),I.onHWMiniGame="hbs"in I.window,I.onVVMiniGame=n.indexOf("VVGame")>-1,I.onKGMiniGame=n.indexOf("QuickGame")>-1,n.indexOf("AlipayMiniGame")>-1&&(I.onAlipayMiniGame=!0,I.onMiniGame=!1),(n.indexOf("TB/")>-1||n.indexOf("Taobao/")>-1||n.indexOf("TM/")>-1)&&(I.onTBMiniGame=!0),(I.onAndroid||I.onIOS)&&(!l||-1==l.indexOf("Win")&&-1==l.indexOf("Mac"))?I.onAndroid?I.platform=I.PLATFORM_ANDROID:I.platform=I.PLATFORM_IOS:I.platform=I.PLATFORM_PC,I.isTouchDevice=I.onMobile||o>0||"ontouchstart"in window,s}static get _isMiniGame(){return I.onMiniGame||I.onBDMiniGame||I.onQGMiniGame||I.onKGMiniGame||I.onVVMiniGame||I.onAlipayMiniGame||I.onQQMiniGame||I.onBLMiniGame||I.onTTMiniGame||I.onHWMiniGame||I.onTBMiniGame||I.window&&I.window.isWXMiMi}static createElement(e){return I.__init__(),I._document.createElement(e)}static getElementById(e){return I.__init__(),I._document.getElementById(e)}static removeElement(e){e&&e.parentNode&&e.parentNode.removeChild(e)}static now(){return Date.now()}static get clientWidth(){return I.__init__(),I._clientWidth||I._window.innerWidth||I._document.body.clientWidth}static set clientWidth(e){I._clientWidth=e}static get clientHeight(){return I.__init__(),I._clientHeight||I._window.innerHeight||I._document.body.clientHeight||I._document.documentElement.clientHeight}static set clientHeight(e){I._clientHeight=e}static get width(){return I.__init__(),(h.stage&&h.stage.canvasRotation?I.clientHeight:I.clientWidth)*I.pixelRatio}static get height(){return I.__init__(),(h.stage&&h.stage.canvasRotation?I.clientWidth:I.clientHeight)*I.pixelRatio}static get pixelRatio(){return I._pixelRatio<0&&(I.__init__(),I.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?I._pixelRatio=2:(I._pixelRatio=I._window.devicePixelRatio||1,I._pixelRatio<1&&(I._pixelRatio=1))),I._pixelRatio}static get container(){return I._container||(I.__init__(),I._container=I.createElement("div"),I._container.id="layaContainer",I._document.body.appendChild(I._container)),I._container}static set container(e){I._container=e}static get window(){return I._window||I.__init__()}static get document(){return I.__init__(),I._document}static getQueryString(e){if(I.onMiniGame)return null;if(!window.location||!window.location.search)return null;var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),i=window.location.search.substring(1).match(t);return null!=i?unescape(i[2]):null}static getSafariToolbarOffset(){return(I.window.__innerHeight||I.document.body.clientHeight||I.document.documentElement.clientHeight)-I.window.innerHeight}static loadLib(e){return new Promise(((t,i)=>{let r=I.document.createElement("script");r.onload=function(){t()},r.onerror=function(){i(`load ${e} failed`)},r.src=e,I.document.body.appendChild(r)}))}}I.PLATFORM_PC=0,I.PLATFORM_ANDROID=1,I.PLATFORM_IOS=2,I.bundles=new Map,I._pixelRatio=-1,I.mainCanvas=null,I.hanzi=new RegExp("^[一-龥]$"),I.fontMap={},I.measureText=function(e,t){let i=I.hanzi.test(e);if(i&&I.fontMap[t])return I.fontMap[t];let r=I.context;r.font=t;let s=r.measureText(e);return i&&(I.fontMap[t]=s),s};let B=window;B.__getBundle_=function(e){let t=I.bundles.get(e);return t||I.bundles.set(e,t={}),t},B.__setBundle_=function(e,t,i){let r=I.bundles.get(e);r&&function(e,t,i){var r;if(t&&"object"==typeof t||"function"==typeof t)for(let s of Object.getOwnPropertyNames(t))e.hasOwnProperty(s)||s===i||Object.defineProperty(e,s,{get:()=>t[s],enumerable:!(r=Object.getOwnPropertyDescriptor(t,s))||r.enumerable})}(r,t,"default"),I.bundles.set(e,t),i&&(B[i]=t)};var L=1;const P=180/Math.PI,N=Math.PI/180;class O{static toRadian(e){return e*N}static toAngle(e){return e*P}static toHexColor(e){return m.hexToString(e)}static fromStringColor(e){return m.stringToHex(e)}static getGID(e,t){return(e?e[F]||(e[F]=L++):0)+"_"+(t?"string"==typeof t?t:t[F]||(t[F]=L++):0)}static copyArray(e,t){if(e||(e=[]),!t)return e;e.length=t.length;var i=t.length;for(let r=0;r<i;r++)e[r]=t[r];return e}static parseInt(e,t=0){var i=parseInt(e,t);return isNaN(i)?0:i}static getBaseName(e){let t=e.lastIndexOf("/");return-1!=t&&(e=e.substring(t+1)),t=e.indexOf("?"),-1!=t&&(e=e.substring(0,t)),e}static getFileExtension(e){let t=e.lastIndexOf(".");if(-1!=t){let i=e.substring(t+1).toLowerCase(),r=i.indexOf("?");if(-1!=r&&(i=i.substring(0,r)),"ls"===i){let r=e.lastIndexOf(".",t-1);if(-1!=r){let s=e.substring(r+1,t+1)+i;if("lanit.ls"===s||"ltcb.ls"===s)return s}}return i}return""}static replaceFileExtension(e,t,i){if(!e)return e;let r=e.lastIndexOf(".");if(t.length>0&&!i&&(t="."+t),-1!=r){let i=e.indexOf("?",r);return-1!=i?e.substring(0,r)+t+e.substring(i):e.substring(0,r)+t}return e+t}static isUUID(e){return e&&e.length>=36&&45===e.charCodeAt(8)&&45===e.charCodeAt(13)}static uint8ArrayToArrayBuffer(t){let i;const r=t.width,s=t.height,a=r*s*4,n=t instanceof b?t.colorFormat:t.getColorFormat();switch(n){case e.RenderTargetFormat.R8G8B8:case e.RenderTargetFormat.R8G8B8A8:i=new Uint8Array(a);break;case e.RenderTargetFormat.R16G16B16A16:i=new Float32Array(a);break;default:throw"this function is not surpprt "+t.format.toString()+"format Material"}if(g.textureContext.readRenderTargetPixelData(t._renderTarget,0,0,r,s,i),n===e.RenderTargetFormat.R16G16B16A16){const e=i,t=new Uint8Array(a);for(let i=0,r=e.length;i<r;i++)t[i]=Math.min(Math.floor(255*e[i]),255);i=t}const o=i,h=I.createElement("canvas");h.height=s,h.width=r;const l=h.getContext("2d"),u=l.createImageData(r,s);u.data.set(new Uint8ClampedArray(o)),l.putImageData(u,0,0);const d=h.toDataURL();return h.remove(),d}static uint8ArrayToArrayBufferAsync(t){let i;const r=t.width,s=t.height,a=r*s*4,n=t instanceof b?t.colorFormat:t.getColorFormat();switch(n){case e.RenderTargetFormat.R8G8B8:case e.RenderTargetFormat.R8G8B8A8:i=new Uint8Array(a);break;case e.RenderTargetFormat.R16G16B16A16:i=new Float32Array(a);break;default:throw"this function is not surpprt "+t.format.toString()+"format Material"}return t.getDataAsync(0,0,r,s,i).then((()=>{if(n===e.RenderTargetFormat.R16G16B16A16){const e=i,t=new Uint8Array(a);for(let i=0,r=e.length;i<r;i++)t[i]=Math.min(Math.floor(255*e[i]),255);i=t}const t=i,o=I.createElement("canvas");o.height=s,o.width=r;const h=o.getContext("2d"),l=h.createImageData(r,s);l.data.set(new Uint8ClampedArray(t)),h.putImageData(l,0,0);const u=o.toDataURL();return o.remove(),Promise.resolve(u)}))}static parseTemplate(e,t){let i,r,s,a,n=0,o="";for(;-1!=(i=e.indexOf("{",n));)if(i>0&&92==e.charCodeAt(i-1))o+=e.substring(n,i-1),o+="{",n=i+1;else{if(o+=e.substring(n,i),n=i,i=e.indexOf("}",n),-1==i)break;i!=n+1?(s=e.substring(n+1,i),r=s.indexOf("="),-1!=r?(a=t[s.substring(0,r)],o+=null==a?s.substring(r+1):a):(a=t[s],null!=a&&(o+=a)),n=i+1):(o+=e.substring(n,n+2),n=i+1)}return n<e.length&&(o+=e.substring(n)),o}}const F=Symbol();class U{constructor(){this.uuidMap={},this.shaderNameMap={},this.metaMap={},this.i18nUrlMap={}}UUID_to_URL(e){return this.uuidMap[e]}UUID_to_URL_async(e){return Promise.resolve(null)}URL_to_UUID_async(e){return Promise.resolve(null)}resolveURL(e,t){if(e.startsWith("res://")){let i=e.substring(6);return U.inst.UUID_to_URL_async(i).then((e=>(t&&t(e),e)))}return t&&t(e),Promise.resolve(e)}shaderName_to_URL(e){return this.shaderNameMap[e]}shaderName_to_URL_async(e){return Promise.resolve(null)}getMeta(e,t){return Promise.resolve(null)}getSubAssetURL(e,t,i,r){return i?`${O.replaceFileExtension(e,"")}@${i}.${r}`:e}getI18nSettingsURL(e){return this.i18nUrlMap[e]}}U.inst=new U;class k{static __init__(){null==k.basePath&&(k.basePath=location&&null!=location.protocol&&""!=location.protocol?k.getPath(location.protocol+"//"+location.host+location.pathname):"")}static initMiniGameExtensionOverrides(){p.isPreview||(Object.assign(this.overrideFileExts,this.safeFileExtConversionMap),this.hasExtOverrides=!0,this.usingSafeFileExts=!0)}constructor(e){this._url=k.formatURL(e),this._path=k.getPath(e)}get url(){return this._url}get path(){return this._path}static get rootPath(){return k.basePaths["~/"]}static set rootPath(e){k.basePaths["~/"]=e}static formatURL(e,t){if(!e)return t||k.basePath||"";if(e.startsWith("res://")){let t=e.substring(6),i=U.inst.UUID_to_URL(t);if(!i)return e;e=i}if(-1==e.indexOf(":")&&47!==e.charCodeAt(0)){null!=k.customFormat&&(e=k.customFormat(e));let i=k.version[e];if(null!=i){let t=e.lastIndexOf(".");e=e.substring(0,t)+"-"+i+e.substring(t)}if(null==t){t=k.basePath;for(let i in k.basePaths)if(e.startsWith(i)){126===i.charCodeAt(0)&&(e=e.substring(i.length)),t=k.basePaths[i];break}}e=k.join(t,e)}return e}static postFormatURL(e){if(k.hasExtOverrides){let t=O.getFileExtension(e),i=k.overrideFileExts[t];null!=i&&(e=O.replaceFileExtension(e,i))}return e}static normalize(e){if(-1==e.indexOf("./"))return e;let t=e.split("/"),i=t.length,r=0;for(;r<i;)if("."!=t[r]){if(".."==t[r]){let e=r-1;if(e>=0&&".."!==t[e]){t.splice(e,2),i-=2,r--;continue}}r++}else t.splice(r,1),i--;return t.length=i,t.join("/")}static getResURLByUUID(e){return O.isUUID(e)?"res://"+e:e}static join(e,t){if(!t)return"";if(t.indexOf(":")>0)return t;if(e){let i=t.charCodeAt(0);126!==i&&47!==i&&(t=47!==e.charCodeAt(e.length-1)?e+"/"+t:e+t)}return k.normalize(t)}static getPath(e){var t=e.lastIndexOf("/");return t>0?e.substring(0,t+1):""}static getFileName(e){var t=e.lastIndexOf("/");return t>0?e.substring(t+1):e}static getURLVerion(e){var t=e.indexOf("?");return t>=0?e.substring(t):null}static overrideExtension(e,t,i){if(!i||k.usingSafeFileExts){for(let i of e)k.overrideFileExts[i]=t;k.hasExtOverrides=!0}else for(let i of e)k.safeFileExtConversionMap[i]=t}}k.version={},k.basePaths={},k.overrideFileExts={},k.hasExtOverrides=!1,k.usingSafeFileExts=!1,k.safeFileExtConversionMap={rendertexture:"rt.json",videotexture:"rt.json",controller:"controller.json",mc:"mc.bin",mcc:"mcc.json",shader:"shader.json",fui:"fui.json",glsl:"glsl.txt",skel:"skel.bin",lavm:"lavm.json"},k.customFormat=function(e){return e};class G{constructor(e=0,t=0,i=0,r=0){this.x=e,this.y=t,this.width=i,this.height=r}get right(){return this.x+this.width}set right(e){this.width=e-this.x}get bottom(){return this.y+this.height}set bottom(e){this.height=e-this.y}setTo(e,t,i,r){return this.x=e,this.y=t,this.width=i,this.height=r,this}reset(){return this.x=this.y=this.width=this.height=0,this}recover(){this!=G.TEMP&&this!=G.EMPTY&&l.recover("Rectangle",this.reset())}static create(){return l.getItemByClass("Rectangle",G)}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}contains(e,t){return!(this.width<=0||this.height<=0)&&(e>=this.x&&e<this.right&&t>=this.y&&t<this.bottom)}intersects(e){return!(e.x>this.x+this.width||e.x+e.width<this.x||e.y>this.y+this.height||e.y+e.height<this.y)}intersection(e,t){return this.intersects(e)?(t||(t=new G),t.x=Math.max(this.x,e.x),t.y=Math.max(this.y,e.y),t.width=Math.min(this.right,e.right)-t.x,t.height=Math.min(this.bottom,e.bottom)-t.y,t):null}union(e,t){return t||(t=new G),this.cloneTo(t),e.width<=0||e.height<=0||(t.addPoint(e.x,e.y),t.addPoint(e.right,e.bottom)),t}scale(e,t){return this.x*=e,this.y*=t,this.width*=e,this.height*=t,this}toString(){return this.x+","+this.y+","+this.width+","+this.height}equals(e){return!(!e||e.x!==this.x||e.y!==this.y||e.width!==this.width||e.height!==this.height)}addPoint(e,t){return this.x>e&&(this.width+=this.x-e,this.x=e),this.y>t&&(this.height+=this.y-t,this.y=t),this.width<e-this.x&&(this.width=e-this.x),this.height<t-this.y&&(this.height=t-this.y),this}getBoundPoints(e){return e=e||[],0==this.width||0==this.height||e.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),e}static _getWrapRec(e,t){if(t=t||new G,!e||e.length<1)return t.setTo(0,0,0,0);let i,r,s,a,n,o=e.length;for(r=a=99999,s=n=-r,i=0;i<o;i+=2){let t=e[i],o=e[i+1];r=r<t?r:t,a=a<o?a:o,s=s>t?s:t,n=n>o?n:o}return t.setTo(r,a,s-r,n-a)}isEmpty(){return this.width<=0||this.height<=0}clone(e){return e||(e=new G),this.cloneTo(e),e}cloneTo(e){e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height}}G.EMPTY=new G,G.TEMP=new G;class V{constructor(e=1,t=0,i=0,r=1,s=0,a=0,n=0){if(this._bTransform=!1,null!=V._createFun)return V._createFun(e,t,i,r,s,a,n);this.a=e,this.b=t,this.c=i,this.d=r,this.tx=s,this.ty=a,this._checkTransform()}identity(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this._bTransform=!1,this}_checkTransform(){return this._bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d}setTranslate(e,t){return this.tx=e,this.ty=t,this}translate(e,t){return this.tx+=e,this.ty+=t,this}scale(e,t){return this.a*=e,this.d*=t,this.c*=e,this.b*=t,this.tx*=e,this.ty*=t,this._bTransform=!0,this}rotate(e){var t=Math.cos(e),i=Math.sin(e),r=this.a,s=this.c,a=this.tx;return this.a=r*t-this.b*i,this.b=r*i+this.b*t,this.c=s*t-this.d*i,this.d=s*i+this.d*t,this.tx=a*t-this.ty*i,this.ty=a*i+this.ty*t,this._bTransform=!0,this}skew(e,t){var i=Math.sin(e),r=Math.cos(e),s=Math.sin(t),a=Math.cos(t),n=this.a,o=this.c,h=this.tx;return this.a=a*n+i*this.b,this.b=s*n+r*this.b,this.c=a*o+i*this.d,this.d=s*o+r*this.d,this.tx=a*h+i*this.ty,this.ty=s*h+r*this.ty,this._bTransform=!0,this}invertTransformPoint(e){var t=this.a,i=this.b,r=this.c,s=this.d,a=this.tx,n=t*s-i*r,o=s/n,h=-i/n,l=-r/n,u=t/n,d=(r*this.ty-s*a)/n,c=-(t*this.ty-i*a)/n;return e.setTo(o*e.x+l*e.y+d,h*e.x+u*e.y+c)}transformPoint(e){return e.setTo(this.a*e.x+this.c*e.y+this.tx,this.b*e.x+this.d*e.y+this.ty)}transformPointN(e){return e.setTo(this.a*e.x+this.c*e.y,this.b*e.x+this.d*e.y)}getScaleX(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)}getScaleY(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)}invert(){var e=this.a,t=this.b,i=this.c,r=this.d,s=this.tx,a=e*r-t*i;return this.a=r/a,this.b=-t/a,this.c=-i/a,this.d=e/a,this.tx=(i*this.ty-r*s)/a,this.ty=-(e*this.ty-t*s)/a,this}setTo(e,t,i,r,s,a){return this.a=e,this.b=t,this.c=i,this.d=r,this.tx=s,this.ty=a,this}concat(e){var t=this.a,i=this.c,r=this.tx;return this.a=t*e.a+this.b*e.c,this.b=t*e.b+this.b*e.d,this.c=i*e.a+this.d*e.c,this.d=i*e.b+this.d*e.d,this.tx=r*e.a+this.ty*e.c+e.tx,this.ty=r*e.b+this.ty*e.d+e.ty,this}static mul(e,t,i){var r=e.a,s=e.b,a=e.c,n=e.d,o=e.tx,h=e.ty,l=t.a,u=t.b,d=t.c,c=t.d,_=t.tx,p=t.ty;return 0!==u||0!==d?(i.a=r*l+s*d,i.b=r*u+s*c,i.c=a*l+n*d,i.d=a*u+n*c,i.tx=l*o+d*h+_,i.ty=u*o+c*h+p):(i.a=r*l,i.b=s*c,i.c=a*l,i.d=n*c,i.tx=l*o+_,i.ty=c*h+p),i}static mul16(e,t,i){var r=e.a,s=e.b,a=e.c,n=e.d,o=e.tx,h=e.ty,l=t.a,u=t.b,d=t.c,c=t.d,_=t.tx,p=t.ty;return 0!==u||0!==d?(i[0]=r*l+s*d,i[1]=r*u+s*c,i[4]=a*l+n*d,i[5]=a*u+n*c,i[12]=l*o+d*h+_,i[13]=u*o+c*h+p):(i[0]=r*l,i[1]=s*c,i[4]=a*l,i[5]=n*c,i[12]=l*o+_,i[13]=c*h+p),i}scaleEx(e,t){var i=this.a,r=this.b,s=this.c,a=this.d;0!==r||0!==s?(this.a=e*i,this.b=e*r,this.c=t*s,this.d=t*a):(this.a=e*i,this.b=0*a,this.c=0*i,this.d=t*a),this._bTransform=!0}rotateEx(e){var t=Math.cos(e),i=Math.sin(e),r=this.a,s=this.b,a=this.c,n=this.d;0!==s||0!==a?(this.a=t*r+i*a,this.b=t*s+i*n,this.c=-i*r+t*a,this.d=-i*s+t*n):(this.a=t*r,this.b=i*n,this.c=-i*r,this.d=t*n),this._bTransform=!0}clone(){var e=new V;return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}copyTo(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}setMatrix(e,t,i,r,s,a,n,o,h){s=O.toRadian(s),a=O.toRadian(a),n=O.toRadian(n);const l=Math.cos(s),u=Math.sin(s),d=Math.cos(a),c=Math.sin(a),_=Math.cos(n),p=Math.sin(n);return this.a=(l*_-u*p)*i,this.b=(u*_+l*p)*i,this.c=(l*c-u*d)*r,this.d=(u*c+l*d)*r,this.tx=e-this.a*o-this.c*h,this.ty=t-this.b*o-this.d*h,this._checkTransform(),this}toString(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty}destroy(){this.recover()}recover(){l.recover("Matrix",this.identity())}static create(){return l.getItemByClass("Matrix",V)}}V.EMPTY=new V,V.TEMP=new V,V._createFun=null;class z extends Error{constructor(){super("Not implemented.")}}class H extends Error{constructor(e){super(`Index out of range: ${e}`)}}class W extends Error{constructor(){super("readable flag need to be true.")}}class Y{static getSystemEndian(){if(!Y._sysEndian){var e=new ArrayBuffer(2);new DataView(e).setInt16(0,256,!0),Y._sysEndian=256===new Int16Array(e)[0]?Y.LITTLE_ENDIAN:Y.BIG_ENDIAN}return Y._sysEndian}constructor(e=null){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,e?(this._u8d_=new Uint8Array(e),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this._resizeBuffer(this._allocated_)}get buffer(){var e=this._d_.buffer;return e.byteLength===this._length?e:e.slice(0,this._length)}get endian(){return this._xd_?Y.LITTLE_ENDIAN:Y.BIG_ENDIAN}set endian(e){this._xd_=e===Y.LITTLE_ENDIAN}set length(e){this._allocated_<e?this._resizeBuffer(this._allocated_=Math.floor(Math.max(e,2*this._allocated_))):this._allocated_>e&&this._resizeBuffer(this._allocated_=e),this._length=e}get length(){return this._length}_resizeBuffer(e){try{var t=new Uint8Array(e);null!=this._u8d_&&(this._u8d_.length<=e?t.set(this._u8d_):t.set(this._u8d_.subarray(0,e))),this._u8d_=t,this._d_=new DataView(t.buffer)}catch(t){throw"Invalid typed array length:"+e}}getString(){return this.readString()}readString(){return this._rUTF(this.getUint16())}getFloat32Array(e,t){return this.readFloat32Array(e,t)}readFloat32Array(e,t){var i=e+t;i=i>this._length?this._length:i;var r=new Float32Array(this._d_.buffer.slice(e,i));return this._pos_=i,r}getUint8Array(e,t){return this.readUint8Array(e,t)}readUint8Array(e,t){var i=e+t;i=i>this._length?this._length:i;var r=new Uint8Array(this._d_.buffer.slice(e,i));return this._pos_=i,r}getInt16Array(e,t){return this.readInt16Array(e,t)}readInt16Array(e,t){var i=e+t;i=i>this._length?this._length:i;var r=new Int16Array(this._d_.buffer.slice(e,i));return this._pos_=i,r}getFloat32(){return this.readFloat32()}readFloat32(){if(this._pos_+4>this._length)throw new H(this._pos_+4);var e=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,e}getFloat64(){return this.readFloat64()}readFloat64(){if(this._pos_+8>this._length)throw new H(this._pos_+8);var e=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,e}writeFloat32(e){this._ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,e,this._xd_),this._pos_+=4}writeFloat64(e){this._ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,e,this._xd_),this._pos_+=8}getInt32(){return this.readInt32()}readInt32(){if(this._pos_+4>this._length)throw new H(this._pos_+4);var e=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,e}getUint32(){return this.readUint32()}readUint32(){if(this._pos_+4>this._length)throw new H(this._pos_+4);var e=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,e}writeInt32(e){this._ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,e,this._xd_),this._pos_+=4}writeUint32(e){this._ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,e,this._xd_),this._pos_+=4}getInt16(){return this.readInt16()}readInt16(){if(this._pos_+2>this._length)throw new H(this._pos_+2);var e=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,e}getUint16(){return this.readUint16()}readUint16(){if(this._pos_+2>this._length)throw new H(this._pos_+2);var e=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,e}writeUint16(e){this._ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,e,this._xd_),this._pos_+=2}writeInt16(e){this._ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,e,this._xd_),this._pos_+=2}getUint8(){return this.readUint8()}readUint8(){if(this._pos_+1>this._length)throw new H(this._pos_+1);return this._u8d_[this._pos_++]}writeUint8(e){this._ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,e),this._pos_++}_getUInt8(e){return this._readUInt8(e)}_readUInt8(e){return this._d_.getUint8(e)}_getUint16(e){return this._readUint16(e)}_readUint16(e){return this._d_.getUint16(e,this._xd_)}_getMatrix(){return this._readMatrix()}_readMatrix(){return new V(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32())}_rUTF(e){var t,i,r=this._pos_+e,s=String.fromCharCode,a=this._u8d_,n=[],o=0;for(n.length=1e3;this._pos_<r;)if((t=a[this._pos_++])<128)0!=t&&(n[o++]=s(t));else if(t<224)n[o++]=s((63&t)<<6|127&a[this._pos_++]);else if(t<240)i=a[this._pos_++],n[o++]=s((31&t)<<12|(127&i)<<6|127&a[this._pos_++]);else{const e=(15&t)<<18|(127&(i=a[this._pos_++]))<<12|(127&a[this._pos_++])<<6|127&a[this._pos_++];if(e>=65536){const t=e-65536,i=55296|t>>10,r=56320|1023&t;n[o++]=s(i),n[o++]=s(r)}else n[o++]=s(e)}return n.length=o,n.join("")}getCustomString(e){return this.readCustomString(e)}readCustomString(e){for(var t,i="",r=0,s=String.fromCharCode,a=this._u8d_;e>0;)if((t=a[this._pos_])<128)i+=s(t),this._pos_++,e--;else for(r=t-128,this._pos_++,e-=r;r>0;)t=a[this._pos_++],i+=s(a[this._pos_++]<<8|t),r--;return i}get pos(){return this._pos_}set pos(e){this._pos_=e}get bytesAvailable(){return this._length-this._pos_}clear(){this._pos_=0,this.length=0}__getBuffer(){return this._d_.buffer}writeUTFBytes(e){for(var t=0,i=(e+="").length;t<i;t++){var r=e.charCodeAt(t);if(r<=127)this.writeByte(r);else if(r<=2047)this._ensureWrite(this._pos_+2),this._u8d_.set([192|r>>6,128|63&r],this._pos_),this._pos_+=2;else if(r>=55296&&r<=56319){t++;const i=e.charCodeAt(t);if(!Number.isNaN(i)&&i>=56320&&i<=57343){const e=64+(1023&r),t=1023&i,s=240|e>>8&63,a=128|e>>2&63,n=128|(3&e)<<4|t>>6&15,o=128|63&t;this._ensureWrite(this._pos_+4),this._u8d_.set([s,a,n,o],this._pos_),this._pos_+=4}}else r<=65535?(this._ensureWrite(this._pos_+3),this._u8d_.set([224|r>>12,128|r>>6&63,128|63&r],this._pos_),this._pos_+=3):(this._ensureWrite(this._pos_+4),this._u8d_.set([240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r],this._pos_),this._pos_+=4)}}writeUTFString(e){var t=this.pos;this.writeUint16(1),this.writeUTFBytes(e);var i=this.pos-t-2;this._d_.setUint16(t,i,this._xd_)}writeUTFString32(e){var t=this.pos;this.writeUint32(1),this.writeUTFBytes(e);var i=this.pos-t-4;this._d_.setUint32(t,i,this._xd_)}readUTFString(){return this.readUTFBytes(this.getUint16())}readUTFString32(){return this.readUTFBytes(this.getUint32())}getUTFString(){return this.readUTFString()}readUTFBytes(e=-1){if(0===e)return"";var t=this.bytesAvailable;if(e>t)throw new H(this._pos_+e);return e=e>0?e:t,this._rUTF(e)}getUTFBytes(e=-1){return this.readUTFBytes(e)}writeByte(e){this._ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,e),this._pos_+=1}readByte(){if(this._pos_+1>this._length)throw new H(this._pos_+1);return this._d_.getInt8(this._pos_++)}getByte(){return this.readByte()}_ensureWrite(e){this._length<e&&(this._length=e),this._allocated_<e&&(this.length=e)}writeArrayBuffer(e,t=0,i=0){if(t<0||i<0)throw new H(t+i);0==i&&(i=e.byteLength-t),this._ensureWrite(this._pos_+i);var r=new Uint8Array(e);this._u8d_.set(r.subarray(t,t+i),this._pos_),this._pos_+=i}readArrayBuffer(e){var t;return t=this._u8d_.buffer.slice(this._pos_,this._pos_+e),this._pos_=this._pos_+e,t}}Y.BIG_ENDIAN="bigEndian",Y.LITTLE_ENDIAN="littleEndian",Y._sysEndian=null;class X{static __init__(){for(var e=0;e<256;++e){var t=e-127;t<-27?($[0|e]=0,$[256|e]=32768,Q[0|e]=24,Q[256|e]=24):t<-14?($[0|e]=1024>>-t-14,$[256|e]=1024>>-t-14|32768,Q[0|e]=-t-1,Q[256|e]=-t-1):t<=15?($[0|e]=t+15<<10,$[256|e]=t+15<<10|32768,Q[0|e]=13,Q[256|e]=13):t<128?($[0|e]=31744,$[256|e]=64512,Q[0|e]=24,Q[256|e]=24):($[0|e]=31744,$[256|e]=64512,Q[0|e]=13,Q[256|e]=13)}for(Z[0]=0,e=1;e<1024;++e){var i=e<<13;for(t=0;0==(8388608&i);)t-=8388608,i<<=1;i&=-8388609,t+=947912704,Z[e]=i|t}for(e=1024;e<2048;++e)Z[e]=939524096+(e-1024<<13);for(J[0]=0,e=1;e<31;++e)J[e]=e<<23;for(J[31]=1199570944,J[32]=2147483648,e=33;e<63;++e)J[e]=2147483648+(e-32<<23);for(J[63]=3347054592,ee[0]=0,e=1;e<64;++e)ee[e]=32===e?0:1024}static roundToFloat16Bits(e){j[0]=e;var t=K[0],i=t>>23&511;return $[i]+((8388607&t)>>Q[i])}static convertToNumber(e){var t=e>>10;return K[0]=Z[ee[t]+(1023&e)]+J[t],j[0]}}const q=new ArrayBuffer(4),j=new Float32Array(q),K=new Uint32Array(q),$=new Uint32Array(512),Q=new Uint32Array(512),Z=new Uint32Array(2048),J=new Uint32Array(64),ee=new Uint32Array(64);var te,ie;e.FilterMode=void 0,(te=e.FilterMode||(e.FilterMode={}))[te.Point=0]="Point",te[te.Bilinear=1]="Bilinear",te[te.Trilinear=2]="Trilinear",e.RenderCapable=void 0,(ie=e.RenderCapable||(e.RenderCapable={}))[ie.Element_Index_Uint32=0]="Element_Index_Uint32",ie[ie.Element_Index_Uint8=1]="Element_Index_Uint8",ie[ie.TextureFormat_R32G32B32A32=2]="TextureFormat_R32G32B32A32",ie[ie.TextureFormat_R16G16B16A16=3]="TextureFormat_R16G16B16A16",ie[ie.Texture_anisotropic=4]="Texture_anisotropic",ie[ie.RenderTextureFormat_R16G16B16A16=5]="RenderTextureFormat_R16G16B16A16",ie[ie.RenderTextureFormat_R32G32B32A32=6]="RenderTextureFormat_R32G32B32A32",ie[ie.RenderTextureFormat_Depth=7]="RenderTextureFormat_Depth",ie[ie.RenderTextureFormat_ShadowMap=8]="RenderTextureFormat_ShadowMap",ie[ie.Vertex_VAO=9]="Vertex_VAO",ie[ie.DrawElement_Instance=10]="DrawElement_Instance",ie[ie.Shader_TextureLod=11]="Shader_TextureLod",ie[ie.COMPRESS_TEXTURE_S3TC=12]="COMPRESS_TEXTURE_S3TC",ie[ie.COMPRESS_TEXTURE_S3TC_SRGB=13]="COMPRESS_TEXTURE_S3TC_SRGB",ie[ie.COMPRESS_TEXTURE_PVRTC=14]="COMPRESS_TEXTURE_PVRTC",ie[ie.COMPRESS_TEXTURE_ETC1=15]="COMPRESS_TEXTURE_ETC1",ie[ie.COMPRESS_TEXTURE_ETC=16]="COMPRESS_TEXTURE_ETC",ie[ie.COMPRESS_TEXTURE_ASTC=17]="COMPRESS_TEXTURE_ASTC",ie[ie.Texture_SRGB=18]="Texture_SRGB",ie[ie.MSAA=19]="MSAA",ie[ie.UnifromBufferObject=20]="UnifromBufferObject",ie[ie.Texture3D=21]="Texture3D",ie[ie.Texture_FloatLinearFiltering=22]="Texture_FloatLinearFiltering",ie[ie.Texture_HalfFloatLinearFiltering=23]="Texture_HalfFloatLinearFiltering";const re=827611204,se=861165636,ae=877942852,ne=894720068,oe=131072;class he{constructor(e,t,i,r,s,a,n,o,h,l){this.width=e,this.height=t,this.mipmapCount=i,this.isCube=r,this.blockBytes=a,this.dataOffset=n,this.format=o,this.source=l,this.bpp=s,this.compressed=h}static getDDSTextureInfo(t){let i=new Int32Array(t,0,31),r=i[4],s=i[3],a=1;131072&i[2]&&(a=Math.max(1,i[7]));let n=i[21],o=4==(4&i[20]),h=64==(64&i[20]),l=(i[20]&oe)===oe,u=512==(512&i[28]),d=n===re||n===se||n===ne||n===ae,c=e.TextureFormat.DXT1,_=i[1]+4,p=1;switch(n){case re:c=e.TextureFormat.DXT1,p=8;break;case se:c=e.TextureFormat.DXT3,p=16;break;case ae:case ne:c=e.TextureFormat.DXT5,p=16;break;case 113:c=e.TextureFormat.R16G16B16A16,p=4;break;case 116:c=e.TextureFormat.R32G32B32A32,p=4;break;default:throw"Unsupported format "+(m=n,String.fromCharCode(255&m,m>>8&255,m>>16&255,m>>24&255))}var m;if(542327876!==i[0])throw"Invalid magic number in DDS header";if(!o&&!h&&!l)throw"Unsupported format, must contain a FourCC, RGB or LUMINANCE code";let f=g.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC)||g.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB);if(d&&!f)throw"Compressed textures are not supported on this platform.";return new he(r,s,a,u,0,p,_,c,d,t)}}const le=6408,ue=6407,de=5121;class ce{static getLayaFormat(t,i,r,s){if(0!=t){if(t==le&&32856==i&&r==de)return{format:e.TextureFormat.R8G8B8A8,sRGB:!1};if(t==le&&35907==i&&r==de)return{format:e.TextureFormat.R8G8B8A8,sRGB:!0};if(t==le&&34836==i&&5126==r)return{format:e.TextureFormat.R32G32B32A32,sRGB:!1};if(t==le&&34842==i&&5131==r)return{format:e.TextureFormat.R16G16B16A16,sRGB:!1};if(t==ue&&34837==i&&5126==r)return{format:e.TextureFormat.R32G32B32,sRGB:!1};if(t==ue&&34843==i&&5131==r)return{format:e.TextureFormat.R16G16B16,sRGB:!1};if(t==ue&&35905==i&&r==de)return{format:e.TextureFormat.R8G8B8,sRGB:!0};if(t==ue&&32849==i&&r==de)return{format:e.TextureFormat.R8G8B8,sRGB:!1};throw"ktx: Unsupported UnCompressed image data."}switch(i){case 36196:return{format:e.TextureFormat.ETC1RGB,sRGB:!1};case 37496:return{format:e.TextureFormat.ETC2RGBA,sRGB:!1};case 37492:return{format:e.TextureFormat.ETC2RGB,sRGB:!1};case 37497:return{format:e.TextureFormat.ETC2SRGB_Alpha8,sRGB:!0};case 37493:return{format:e.TextureFormat.ETC2SRGB,sRGB:!0};case 37494:return{format:e.TextureFormat.ETC2RGB_Alpha1,sRGB:!1};case 37495:return{format:e.TextureFormat.ETC2SRGB_Alpha1,sRGB:!0};case 37808:return{format:e.TextureFormat.ASTC4x4,sRGB:!1};case 37812:return{format:e.TextureFormat.ASTC6x6,sRGB:!1};case 37815:return{format:e.TextureFormat.ASTC8x8,sRGB:!1};case 37819:return{format:e.TextureFormat.ASTC10x10,sRGB:!1};case 37821:return{format:e.TextureFormat.ASTC12x12,sRGB:!1};case 37840:return{format:e.TextureFormat.ASTC4x4SRGB,sRGB:!0};case 37844:return{format:e.TextureFormat.ASTC6x6SRGB,sRGB:!0};case 37847:return{format:e.TextureFormat.ASTC8x8SRGB,sRGB:!0};case 37851:return{format:e.TextureFormat.ASTC10x10SRGB,sRGB:!0};case 37853:return{format:e.TextureFormat.ASTC12x12SRGB,sRGB:!0};default:throw"KTX: UnSupported Compressed format."}}static getKTXTextureInfo(e){let t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])throw"ktx2 !";if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return ce.createKTX1Info(e);throw"ktx data wrong, not ktx1 or ktx2 buffer!"}static createKTX1Info(t){let i=Uint32Array.BYTES_PER_ELEMENT,r=new DataView(t,12,13*i),s=67305985==r.getUint32(0,!0),a=r.getUint32(1*i,s),n=r.getUint32(2*i,s),o=r.getUint32(3*i,s),h=r.getUint32(4*i,s);r.getUint32(5*i,s);let l=r.getUint32(6*i,s),u=r.getUint32(7*i,s);r.getUint32(8*i,s);let d=r.getUint32(9*i,s),c=r.getUint32(10*i,s),_=r.getUint32(11*i,s),p=r.getUint32(12*i,s),g=ce.getLayaFormat(o,h,a,n),m=g.format,f=g.sRGB,T=e.TextureDimension.Tex2D;c>1&&d>1?T=e.TextureDimension.CubeArray:c>1&&d<=1?T=e.TextureDimension.Cube:c<=1&&d>1&&(T=e.TextureDimension.Texture2DArray);return new ce(t,0==o,f,T,l,u,m,_||1,p,64)}constructor(e,t,i,r,s,a,n,o,h,l){this.source=e,this.compress=t,this.sRGB=i,this.dimension=r,this.width=s,this.height=a,this.format=n,this.mipmapCount=o,this.bytesOfKeyValueData=h,this.headerOffset=l}}class _e extends M{static __init__(){var t=new Uint8Array(4);if(t[0]=128,t[1]=128,t[2]=128,t[3]=255,_e.grayTexture=new _e(1,1,e.TextureFormat.R8G8B8A8,!1,!1),_e.grayTexture.setPixelsData(t,!1,!1),_e.grayTexture.lock=!0,_e.grayTexture.name="Default_Gray",t[0]=255,t[1]=255,t[2]=255,t[3]=255,_e.whiteTexture=new _e(1,1,e.TextureFormat.R8G8B8A8,!1,!1),_e.whiteTexture.setPixelsData(t,!1,!1),_e.whiteTexture.lock=!0,_e.whiteTexture.name="Default_White",t[0]=0,t[1]=0,t[2]=0,t[3]=255,_e.blackTexture=new _e(1,1,e.TextureFormat.R8G8B8A8,!1,!1),_e.blackTexture.setPixelsData(t,!1,!1),_e.blackTexture.lock=!0,_e.blackTexture.name="Default_Black",g.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16)){let t=new Uint16Array(4);t[0]=14336,t[1]=14336,t[2]=15360,t[3]=15360,_e.normalTexture=new _e(1,1,e.TextureFormat.R16G16B16A16,!1,!1,!1),_e.normalTexture.setPixelsData(t,!1,!1)}else t[0]=128,t[1]=128,t[2]=255,t[3]=255,_e.normalTexture=new _e(1,1,e.TextureFormat.R8G8B8A8,!1,!1,!1),_e.normalTexture.setPixelsData(t,!1,!1);_e.normalTexture.lock=!0,_e.normalTexture.name="Default_Normal",_e.errorTexture=_e.whiteTexture}static _SimpleAnimatorTextureParse(t,i=null,r=null){var s,a,n=new Y(t);switch(n.readUTFString()){case"LAYAANIMATORTEXTURE:0000":var o,h=n.readInt32(),l=n.readInt32();s=new Float32Array(h*h*4),a=new Float32Array(n.readArrayBuffer(4*l)),s.set(a,0),(o=new _e(h,h,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(s,!1,!1),o.filterMode=e.FilterMode.Point;break;case"LAYACOMPRESSANIMATORTEXTURE:0000":h=n.readInt32(),l=n.readInt32();if(s=new Uint16Array(n.readArrayBuffer(2*l)),g.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16))(a=new Uint16Array(h*h*4)).set(s,0),(o=new _e(h,h,e.TextureFormat.R16G16B16A16,!1,!1)).setPixelsData(a,!1,!1),o.filterMode=e.FilterMode.Point;else{console.log("The platform does not support 16-bit floating-point textures"),g.renderEngine.getCapable(e.RenderCapable.TextureFormat_R32G32B32A32)||console.error("The platform does not support 32-bit floating-point textures"),a=new Float32Array(h*h*4);for(var u=0,d=s.length;u<d;u++)a[u]=X.convertToNumber(s[u]);(o=new _e(h,h,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(a,!1,!1),o.filterMode=e.FilterMode.Point}break;default:throw"Laya3D:unknow version."}return o}static _parseImage(t,i=null,r=null){let s=r?r[2]:e.TextureFormat.R8G8B8A8,a=!r||r[3],n=!!r&&r[4],o=!!r&&r[5],l=!!i&&i.premultiplyAlpha,u=new _e(t.width,t.height,s,a,n,o,l);return i?(u.setImageData(t,l,!1),u.setProperties(i)):u.setImageData(t,!1,!1),n&&(p.isConch&&t._nativeObj?u._pixels=new Uint8Array(t._nativeObj.getImageData(0,0,t.width,t.height)):(h.Browser.canvas.size(t.width,t.height),h.Browser.canvas.clear(),h.Browser.context.drawImage(t,0,0,t.width,t.height),u._pixels=new Uint8Array(h.Browser.context.getImageData(0,0,t.width,t.height).data.buffer))),u}static _parseDDS(e,t=null,i=null){let r=he.getDDSTextureInfo(e),s=i[5],a=new _e(r.width,r.height,r.format,r.mipmapCount>1,!1,s);return a.setDDSData(r),t&&a.setProperties(t),a}static _parseKTX(e,t=null,i=null){let r=ce.getKTXTextureInfo(e),s=new _e(r.width,r.height,r.format,r.mipmapCount>1,!1,r.sRGB);return s.setKTXData(r),t&&s.setProperties(t),s}static _parsePVR(e,t=null,i=null){throw"pvr !"}static load(e,t){h.loader.load(e,t,null,h.Loader.TEXTURE2D)}constructor(t,i,r,s=!0,a,n=!1,o=!1){super(t,i,r),this._canRead=!1,this._premultiplyAlpha=!1,this._dimension=e.TextureDimension.Tex2D,this._gammaSpace=n,this._canRead=a,this._premultiplyAlpha=o,this._texture=g.textureContext.createTextureInternal(this._dimension,t,i,r,s,n,o)}setImageData(e,t,i){let r=this._texture;g.textureContext.setTextureImageData(r,e,t,i)}setPixelsData(e,t,i){let r=this._texture;g.textureContext.setTexturePixelsData(r,e,t,i)}setSubPixelsData(e,t,i,r,s,a,n,o,h){let l=this._texture;g.textureContext.setTextureSubPixelsData(l,s,a,n,e,t,i,r,o,h)}setDDSData(e){let t=this._texture;g.textureContext.setTextureDDSData(t,e)}setKTXData(e){let t=this._texture;g.textureContext.setTextureKTXData(t,e)}setHDRData(e){let t=this._texture;g.textureContext.setTextureHDRData(t,e)}get defaultTexture(){return _e.grayTexture}getPixels(){if(this._canRead&&this._pixels)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")}setProperties(e){e&&(null!=e.wrapModeU&&(this.wrapModeU=e.wrapModeU),null!=e.wrapModeV&&(this.wrapModeV=e.wrapModeV),null!=e.filterMode&&(this.filterMode=e.filterMode),null!=e.anisoLevel&&(this.anisoLevel=e.anisoLevel))}}_e.TEXTURE2D="TEXTURE2D",_e.grayTexture=null,_e.whiteTexture=null,_e.blackTexture=null,_e.normalTexture=null,_e.errorTexture=null;class pe extends M{static get currentActive(){return pe._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return _e.grayTexture}getIsReady(){return!0}getColorFormat(){return this._colorFormat}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(t,i,r=e.RenderTargetFormat.R8G8B8,s=e.RenderTargetFormat.None){super(t,i,r),this._mgrKey=0,this._invertY=!1,this._colorFormat=r,this._depthStencilFormat=s,0!=t&&0!=i&&this._create(),this.lock=!0}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}_start(){throw new z}_end(){throw new z}_create(){this._renderTarget=g.textureContext.createRenderTargetInternal(this.width,this.height,this._colorFormat,this.depthStencilFormat,!1,!1,1),this._texture=this._renderTarget._textures[0],this._texture.gammaCorrection=2.2}clear(e=0,t=0,i=0,r=1){pe._clearColor.r=e,pe._clearColor.g=t,pe._clearColor.b=i,pe._clearColor.a=r,pe._clear=!0}getData(t,i,r,s){const a=r*s*4;let n;switch(this._renderTarget.colorFormat){case e.RenderTargetFormat.R8G8B8:case e.RenderTargetFormat.R8G8B8A8:n=new Uint8Array(a);break;case e.RenderTargetFormat.R16G16B16A16:n=new Float32Array(a);break;default:throw"this function is not surpprt "+this._renderTarget.colorFormat.toString()+"format Material"}return g.textureContext.readRenderTargetPixelData(this._renderTarget,t,i,r,s,n),n}getDataAsync(e,t,i,r,s){return g.textureContext.readRenderTargetPixelDataAsync(this._renderTarget,e,t,i,r,s)}recycle(){}_disposeResource(){this._renderTarget&&this._renderTarget.dispose()}}pe._clearColor=new m(0,0,0,0),pe._clear=!1,pe._clearLinearColor=new m,pe.defuv=[0,0,1,0,1,1,0,1],pe.flipyuv=[0,1,1,1,1,0,0,0];const ge=new G,me=new G;class fe extends A{static create(e,t,i,r,s,a=0,n=0,o=0,h=0){return fe._create(e,t,i,r,s,a,n,o,h)}static _create(e,t,i,r,s,a=0,n=0,o=0,h=0,l=null){var u,d=e instanceof fe,c=d?e.uv:fe.DEF_UV,_=d?e.bitmap:e;_.width&&t+r>_.width&&(r=_.width-t),_.height&&i+s>_.height&&(s=_.height-i),l?(u=l).setTo(_,null,o||r,h||s):u=new fe(_,null,o||r,h||s),u.width=r,u.height=s,u.offsetX=a,u.offsetY=n;var p=1/_.width,g=1/_.height;t*=p,i*=g,r*=p,s*=g;var m=u.uv[0],f=u.uv[1],T=u.uv[4],y=u.uv[5],x=T-m,v=y-f,S=function(e,t,i){for(var r=0;r<8;r+=2)i[r]+=e,i[r+1]+=t;return i}(c[0],c[1],[t,i,t+r,i,t+r,i+s,t,i+s]);u.uv=new Float32Array([m+S[0]*x,f+S[1]*v,T-(1-S[2])*x,f+S[3]*v,T-(1-S[4])*x,y-(1-S[5])*v,m+S[6]*x,y-(1-S[7])*v]);var D=e.scaleRate;return D&&1!=D?(u.sourceWidth/=D,u.sourceHeight/=D,u.width/=D,u.height/=D,u.scaleRate=D,u.offsetX/=D,u.offsetY/=D):u.scaleRate=1,u}static createFromTexture(e,t,i,r,s){var a=e.scaleRate;1!=a&&(t*=a,i*=a,r*=a,s*=a);var n=G.TEMP.setTo(t-e.offsetX,i-e.offsetY,r,s),o=n.intersection(ge.setTo(0,0,e.width,e.height),me);return o?fe.create(e,o.x,o.y,o.width,o.height,o.x-n.x,o.y-n.y,r,s):null}get uv(){return this._uv}set uv(e){this.uvrect[0]=Math.min(e[0],e[2],e[4],e[6]),this.uvrect[1]=Math.min(e[1],e[3],e[5],e[7]),this.uvrect[2]=Math.max(e[0],e[2],e[4],e[6])-this.uvrect[0],this.uvrect[3]=Math.max(e[1],e[3],e[5],e[7])-this.uvrect[1],this._uv=e}get width(){return this._w?this._w:this.bitmap?this.uv&&this.uv!==fe.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width:0}set width(e){this._w=e,this.sourceWidth||(this.sourceWidth=e)}get height(){return this._h?this._h:this.bitmap?this.uv&&this.uv!==fe.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height:0}set height(e){this._h=e,this.sourceHeight||(this.sourceHeight=e)}get bitmap(){return this._bitmap}set bitmap(e){this._bitmap!=e&&(this._bitmap&&this._bitmap._removeReference(this._referenceCount),this._bitmap=e,e&&e._addReference(this._referenceCount))}constructor(e=null,t=null,i=0,r=0){super(!1),this.uvrect=[0,0,1,1],this._w=0,this._h=0,this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this.scaleRate=1;let s=e instanceof fe?e.bitmap:e;this.setTo(s,t,i,r)}_addReference(e=1){var t,i;super._addReference(e),null===(t=this._bitmap)||void 0===t||t._addReference(e),null===(i=this._atlas)||void 0===i||i._addReference(e)}_removeReference(e=1){var t,i;null===(t=this._bitmap)||void 0===t||t._removeReference(e),null===(i=this._atlas)||void 0===i||i._removeReference(e),super._removeReference(e)}_getSource(e=null){return this._destroyed||!this._bitmap?null:(this.recoverBitmap(e),this._bitmap.destroyed?null:this.bitmap._getSource())}setTo(e=null,t=null,i=0,r=0){this.bitmap=e,this.sourceWidth=i,this.sourceHeight=r,e&&(this._w=e.width,this._h=e.height,this.sourceWidth=this.sourceWidth||e.width,this.sourceHeight=this.sourceHeight||e.height),this.uv=t||fe.DEF_UV}load(e,t){return this._destroyed?Promise.resolve():h.loader.load(e).then((e=>{let i=e.bitmap;this.bitmap=i,this.sourceWidth=this._w=i.width,this.sourceHeight=this._h=i.height,t&&t.run(),this.event(c.READY,this)}))}getTexturePixels(t,i,r,s){var a,n,o,l=this.bitmap,u=this._w,d=this._h,c=this.sourceWidth,_=this.sourceHeight,p=l.width,g=l.height,m=this.offsetX,f=this.offsetY;let T=r,y=s;if(t+r>u+m&&(T-=t+r-u-m),t+r>c&&(r-=t+r-c),i+s>d+f&&(y-=i+s-d-f),i+s>_&&(s-=i+s-_),r<=0||s<=0)return null;let x=m>t?m-t:0,v=f>i?f-i:0,S=t>m?t-m:0,D=i>f?i-f:0;T-=x,y-=v;var E=4*r,w=null;try{w=l.getPixels()}catch(e){}if(w){if(0==t&&0==i&&r==p&&s==g)return w;let e=this._uv.slice(),h=Math.round(e[0]*p),l=Math.round(e[1]*g);var R=new Uint8Array(r*s*4);for(a=4*h+4*S+(n=(l+D)*(E=4*p)),o=0;o<y;o++)R.set(w.slice(a,a+4*T),4*r*(o+v)+4*x),a+=E;return R}var C=new h.Context;C.size(r,s);let A=new pe(r,s,e.RenderTargetFormat.R8G8B8A8);C.render2D=C.render2D.clone(A);var M=null;if(0!=t||0!=i||r!=p||s!=g){var b=(M=this._uv.slice())[0],I=M[1],B=(M[2]-b)/u,L=(M[7]-I)/d;M=[b+S*B,I+D*L,b+(S+T)*B,I+D*L,b+(S+T)*B,I+(D+y)*L,b+S*B,I+(D+y)*L]}C.startRender(),C._drawTextureM(this,x,v,T,y,null,1,M,4294967295),C.endRender();var P=A.getData(0,0,r,s);for(C.destroy(),A.destroy(),R=new Uint8Array(r*s*4),a=0,n=(s-1)*E,o=s-1;o>=0;o--)R.set(P.slice(n,n+E),a),a+=E,n-=E;return R}getPixels(e,t,i,r){return this.getTexturePixels(e,t,i,r)}recoverBitmap(e){var t=this._bitmap.url;this._destroyed||this._bitmap&&!this._bitmap.destroyed||!t||h.loader.load(t).then((t=>{this.bitmap=t.bitmap,e&&e()}))}disposeBitmap(){!this._destroyed&&this._bitmap&&this._bitmap.destroy()}get valid(){return!this._destroyed&&this._bitmap&&!this._bitmap.destroyed}get obsolute(){return this._obsolute||!this._bitmap||this._bitmap.destroyed||this._bitmap.obsolute}set obsolute(e){this._obsolute=e}_disposeResource(){let e=this._bitmap;this._bitmap=null,e&&e._removeReference(this._referenceCount);let t=this._atlas;this._atlas=null,t&&t._removeReference(this._referenceCount)}getCachedClip(e,t,i,r){if(this.destroyed)return null;let s=`${e}_${t}_${i}_${r}`;this._clipCache||(this._clipCache=new Map);let a=this._clipCache.get(s);return a||(a=fe.createFromTexture(this,e,t,i,r),a&&(a._sizeGrid=this._sizeGrid),this._clipCache.size>100&&this._clipCache.clear(),this._clipCache.set(s,a),a)}}fe.DEF_UV=new Float32Array([0,0,1,0,1,1,0,1]),fe.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]),fe.INV_UV=new Float32Array([0,1,1,1,1,0,0,0]);class Te{static enable(e,t=null){h.loader.fetch(e,"json").then((e=>{e&&(Te.addAtlases(e),t&&t.run())}))}static addAtlases(e){let t=Te._fileLoadDic;for(let i in e){let r=e[i],s=k.formatURL(r[0]),a=r[1],n=a.length,o={url:i};for(let e=0;e<n;e++)t[s+a[e]]=o}}static addAtlas(e,t,i){t=k.formatURL(t);let r=Te._fileLoadDic,s={url:e};for(let e of i)r[t+e]=s}static getFileLoadPath(e){return Te._fileLoadDic[e]}}Te._fileLoadDic={};class ye{static workerSupported(){return!!Worker}static get enable(){return ye._enable}static set enable(e){if(ye._enable!=e){if(e){if(!Worker)return;ye._worker||(ye._worker=new Worker(i.workerLoaderLib||ye.workerPath),ye._worker.onmessage=ye.workerMessage,ye._dispatcher=new D)}ye._enable=e}}static load(e,t){return new Promise(((i,r)=>{ye._worker.postMessage({url:e,options:t}),ye._dispatcher.once(e,(e=>{e.imageBitmap?i(e.imageBitmap):r(e.msg)}))}))}static workerMessage(e){let t=e.data;if(t)switch(t.type){case"Image":ye._dispatcher.event(t.url,t);break;case"Disable":ye.enable=!1}}}ye.workerPath="libs/laya.workerloader.js",ye._enable=!1;class xe extends A{constructor(e,t,i){super(),this.dir=e,this.textures=t,this.frames=i;for(let e of i)e._addReference(),e._atlas=this;for(let e of t)e._addReference(),e._atlas=this}_disposeResource(){for(let e of this.textures)e._atlas=null,e._removeReference();for(let e of this.frames)e._atlas=null,e._removeReference();this.frames.length=0,this.textures.length=0}}class ve{constructor(e){this._callback=e,this._items=[],this._weights=[],this._progress=0}get itemCount(){return this._items.length}reset(){this._items.length=0,this._weights.length=0,this._progress=0}createCallback(e){let t=this._items.length;return this._items.push(0),null==e?this._weights.push(null):this._weights.push(Math.max(0,Math.min(e,1))),e=>this.update(t,e)}update(e,t){if(-1!=e){this._items[e]=Math.max(0,Math.min(t,1));let i=0,r=this._items,s=this._weights,a=1/r.length;for(let e=0;e<r.length;e++){let t=r[e],n=s[e];null!=t&&(i+=t*(null!=n?n:a))}(t=i)>1&&(t=1)}t>this._progress&&(this._progress=t,this._callback(t))}}class Se{constructor(e=null,t=null,i=null,r=!1){this.once=!1,this._id=0,this.setTo(e,t,i,r)}setTo(e,t,i,r=!1){return this._id=Se._gid++,this.caller=e,this.method=t,this.args=i,this.once=r,this}run(){if(null==this.method)return null;var e=this._id,t=this.method.apply(this.caller,this.args);return this._id===e&&this.once&&this.recover(),t}runWith(e){if(null==this.method)return null;var t=this._id;if(null==e)var i=this.method.apply(this.caller,this.args);else i=this.args||e.unshift?this.args?this.method.apply(this.caller,this.args.concat(e)):this.method.apply(this.caller,e):this.method.call(this.caller,e);return this._id===t&&this.once&&this.recover(),i}clear(){return this.caller=null,this.method=null,this.args=null,this}recover(){this._id>0&&(this._id=0,Se._pool.push(this.clear()))}static create(e,t,i=null,r=!0){return Se._pool.length?Se._pool.pop().setTo(e,t,i,r):new Se(e,t,i,r)}}Se._pool=[],Se._gid=1;class De{static compareVersion(e,t){let i=e.split("."),r=t.split(".");const s=Math.max(i.length,r.length);for(;i.length<s;)i.push("0");for(;r.length<s;)r.push("0");for(let e=0;e<s;e++){const t=parseInt(i[e]),s=parseInt(r[e]);if(t>s)return!0;if(t<s)return!1}return!0}static get isSupport(){if(I._isMiniGame){var e=I.window.wx.getSystemInfoSync().SDKVersion;return De.compareVersion(e,"2.14.0")}return!!I.onLayaRuntime||!!I.window.Blob&&!!I.window.Blob}static arrayBufferToURL(e,t){if(!De.isSupport)return e;if(De.data[e])return De.data[e];var i="";if(I._isMiniGame||I.onLayaRuntime)i=I.window.wx.createBufferURL(t);else if(I.window.Blob){let e=new Blob([t],{type:"application/octet-binary"});i=I.window.URL.createObjectURL(e)}return De.isSavaData&&(De.data[e]=i),i}static _arrayBufferToURL(e){if(!De.isSupport)return null;var t="";if(I._isMiniGame||I.onLayaRuntime)t=I.window.wx.createBufferURL(e);else if(I.window.Blob){let i=new Blob([e],{type:"application/octet-binary"});t=I.window.URL.createObjectURL(i)}return t}static destroy(e){if(De.isSupport){var t=De.data[e];t&&(I._isMiniGame||I.onLayaRuntime?I.window.wx.revokeBufferURL(t):I.window.Blob&&I.window.URL.revokeObjectURL(t),delete De.data[e])}}}De.data={},De.isSavaData=!1;class Ee{static decodeString(e){let t=e.length,i="",r=0,s=0;for(;;){if(s=e.indexOf("&",r),-1==s){i+=e.substring(r);break}i+=e.substring(r,s),r=s+1,s=r;let a=Math.min(t,s+10);for(;s<a&&";"!=e[s];s++);if(s<a&&s>r){let t=e.substring(r,s),a=0;if("#"==t[0])t.length>1?(a="x"==t[1]?parseInt(t.substring(2),16):parseInt(t.substring(1)),i+=String.fromCharCode(a),r=s+1):i+="&";else{switch(t){case"amp":a=38;break;case"apos":a=39;break;case"gt":a=62;break;case"lt":a=60;break;case"nbsp":a=32;break;case"quot":a=34}a>0?(i+=String.fromCharCode(a),r=s+1):i+="&"}}else i+="&"}return i}static encodeString(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,"&quot;")}static getString(e,t,i){if(null==e)return null==i?null:i;let r=e[t];return null!=r?""+r:null==i?null:i}static getInt(e,t,i){let r=this.getString(e,t);if(null!=r&&r.length>0)if("%"==r[r.length-1]){let e=parseInt(r.substring(0,r.length-1));if(!isNaN(e))return Math.ceil(e/100*i)}else{let e=parseInt(r);if(!isNaN(e))return e}return null==i?0:i}static getFloat(e,t,i){let r=this.getString(e,t);if(null==r||0==r.length)return null==i?0:i;let s=parseFloat(r);return isNaN(s)?null==i?0:i:s}static getBool(e,t,i){let r=this.getString(e,t);return null==r||0==r.length?null!=i&&i:"true"==r||"1"==r||"false"!=r&&"0"!=r&&(null!=i&&i)}}var we;e.XMLTagType=void 0,(we=e.XMLTagType||(e.XMLTagType={}))[we.Start=0]="Start",we[we.End=1]="End",we[we.Void=2]="Void",we[we.CDATA=3]="CDATA",we[we.Comment=4]="Comment",we[we.Instruction=5]="Instruction";class Re{static begin(e,t){Re.source=e,Re.lowerCaseName=t,this.sourceLen=e.length,this.parsePos=0,this.lastTagEnd=0,this.tagPos=0,this.tagLength=0,this.tagName=null}static nextTag(){let t,i,r="";for(this.tagType=e.XMLTagType.Start,this.lastTagEnd=this.parsePos,this.attrParsed=!1,this.lastTagName=this.tagName;-1!=(t=this.source.indexOf("<",this.parsePos))&&(this.parsePos=t,t++,t!=this.sourceLen);){if(i=this.source[t],"!"==i){if(this.sourceLen>t+7&&"<![CDATA["==this.source.substring(t-1,t+8))return t=this.source.indexOf("]]>",t),this.tagType=e.XMLTagType.CDATA,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;if(this.sourceLen>t+2&&"\x3c!--"==this.source.substring(t-1,t+3))return t=this.source.indexOf("--\x3e",t),this.tagType=e.XMLTagType.Comment,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;t++,this.tagType=e.XMLTagType.Instruction}else"/"==i?(t++,this.tagType=e.XMLTagType.End):"?"==i&&(t++,this.tagType=e.XMLTagType.Instruction);for(;t<this.sourceLen&&(i=this.source[t],-1==" \t\n\r\v".indexOf(i)&&">"!=i&&"/"!=i);t++);if(t==this.sourceLen)break;r+=this.source.substring(this.parsePos+1,t),r.length>0&&"/"==r[0]&&(r=r.substring(1));let s=!1,a=!1,n=-1;for(;t<this.sourceLen;t++)if(i=this.source[t],'"'==i?s||(a=!a):"'"==i&&(a||(s=!s)),">"==i){if(!s&&!a){n=-1;break}n=t}else if("<"==i)break;if(-1!=n&&(t=n),t==this.sourceLen)break;return"/"==this.source[t-1]&&(this.tagType=e.XMLTagType.Void),this.tagName=r,this.lowerCaseName&&(this.tagName=this.tagName.toLowerCase()),this.tagPos=this.parsePos,this.tagLength=t+1-this.parsePos,this.parsePos+=this.tagLength,!0}return this.tagPos=this.sourceLen,this.tagLength=0,this.tagName=null,!1}static getTagSource(){return this.source.substring(this.tagPos,this.tagPos+this.tagLength)}static getRawText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":this.source.substring(e,this.tagPos).trim()}return this.source.substring(this.lastTagEnd,this.tagPos)}static getText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":Ee.decodeString(this.source.substring(e,this.tagPos)).trimEnd()}return Ee.decodeString(this.source.substring(this.lastTagEnd,this.tagPos))}static get attributes(){if(!this.attrParsed){for(let e in this._attrs)delete this._attrs[e];this.parseAttributes(this._attrs),this.attrParsed=!0}return this._attrs}static getAttribute(e){return this.attributes[e]}static parseAttributes(e){let t,i=0,r=0,s=!1,a=0,n="",o=this.tagPos,h=this.tagPos+this.tagLength;if(o<h&&"<"==this.source[o])for(;o<h;o++){let e=this.source[o];if(-1!=" \t\n\r\v".indexOf(e)||">"==e||"/"==e)break}for(;o<h;o++){let l=this.source[o];if("="==l){i=-1,r=-1,a=0;for(let e=o+1;e<h;e++){let t=this.source[e];if(-1!=" \t\n\r\v".indexOf(t)){if(-1!=i&&0==a){r=e-1;break}}else if(">"==t){if(0==a){r=e-1;break}}else if('"'==t)if(-1!=i){if(1!=a){r=e-1;break}}else a=2,i=e+1;else if("'"==t)if(-1!=i){if(2!=a){r=e-1;break}}else a=1,i=e+1;else-1==i&&(i=e)}if(-1==i||-1==r)break;t=n,this.lowerCaseName&&(t=t.toLowerCase()),n="",e[t]=Ee.decodeString(this.source.substring(i,r+1)),o=r+1}else-1==" \t\n\r\v".indexOf(l)?((s||"/"==l||">"==l)&&(n.length>0&&(t=n,this.lowerCaseName&&(t=t.toLowerCase()),e[t]="",n=""),s=!1),"/"!=l&&">"!=l&&(n+=l)):n.length>0&&(s=!0)}}}Re._attrs={},String.prototype.trimEnd||(String.prototype.trimEnd=function(){return this.replace(/\s+$/g,"")});class Ce{constructor(e){e&&this.parse(e)}get attributes(){return this._attrs||(this._attrs={}),this._attrs}getAttrString(e,t){return Ee.getString(this._attrs,e,t)}getAttrInt(e,t){return Ee.getInt(this._attrs,e,t)}getAttrFloat(e,t){return Ee.getFloat(this._attrs,e,t)}getAttrBool(e,t){return Ee.getBool(this._attrs,e,t)}setAttribute(e,t){this._attrs||(this._attrs={}),this._attrs[e]=t}getNode(e){return this._children?this._children.find((t=>t.name==e)):null}elements(e){return this._children||(this._children=new Array),e?this._children.filter((t=>t.name==e)):this._children}parse(t){let i;this.reset();let r=new Array;for(Re.begin(t);Re.nextTag();)if(Re.tagType==e.XMLTagType.Start||Re.tagType==e.XMLTagType.Void){let t;if(i)t=new Ce;else{if(null!=this.name)throw this.reset(),new Error("Invalid xml format - no root node.");t=this}t.name=Re.tagName,t._attrs=Object.assign({},Re.attributes),i&&(Re.tagType!=e.XMLTagType.Void&&r.push(i),null==i._children&&(i._children=new Array),i._children.push(t)),Re.tagType!=e.XMLTagType.Void&&(i=t)}else if(Re.tagType==e.XMLTagType.End){if(null==i||i.name!=Re.tagName)throw this.reset(),new Error("Invalid xml format - <"+Re.tagName+"> dismatched.");null!=i._children&&0!=i._children.length||(i.text=Re.getText()),i=r.length>0?r.pop():null}}reset(){this._attrs=null,null!=this._children&&this._children.length,this.text=null}}class Ae extends D{constructor(){super(...arguments),this._http=new XMLHttpRequest}send(e,t=null,i="get",r="text",s){this._responseType=r,this._data=null,(I.onVVMiniGame||I.onQGMiniGame||I.onQQMiniGame||I.onAlipayMiniGame||I.onBLMiniGame||I.onHWMiniGame||I.onTTMiniGame||I.onTBMiniGame)&&(e=Ae._urlEncode(e)),this._url=e;let a=this._http;if(a.open(i,e,!0),t?"string"==typeof t?a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):(a.setRequestHeader("Content-Type","application/json"),t instanceof ArrayBuffer||(t=JSON.stringify(t))):I.onBLMiniGame&&I.onAndroid&&(t={}),s)for(let e=0;e<s.length;e++)a.setRequestHeader(s[e++],s[e]);let n="arraybuffer"!==r?"text":"arraybuffer";a.responseType=n,a.dataType&&(a.dataType=n),a.onerror=e=>{this._onError(e)},a.onabort=e=>{this._onAbort(e)},a.onprogress=e=>{this._onProgress(e)},a.onload=e=>{this._onLoad(e)},a.send(t)}_onProgress(e){e&&e.lengthComputable&&this.event(c.PROGRESS,e.loaded/e.total)}_onAbort(e){this.error("Request was aborted by user")}_onError(e){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}_onLoad(e){var t=this._http,i=void 0!==t.status?t.status:200;200===i||204===i||0===i?this.complete():this.error("["+t.status+"]"+t.statusText+":"+t.responseURL)}error(e){this.clear(),this.event(c.ERROR,e)}complete(){this.clear();var e=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=new Ce(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(t){e=!1,this.error(t.message)}e&&this.event(c.COMPLETE,this._data instanceof Array?[this._data]:this._data)}clear(){var e=this._http;e.onerror=e.onabort=e.onprogress=e.onload=null}get url(){return this._url}get data(){return this._data}get http(){return this._http}reset(){this.offAll(),this._data=null}}Ae._urlEncode=encodeURI;class Me{constructor(){this.httpRequestPool=[]}common(e,t,i,r,s,a){let n=this.getRequestInst();n.on(c.COMPLETE,(()=>{let e=n.data;this.returnRequestInst(n),a(e)})),n.on(c.ERROR,null,(e=>{this.returnRequestInst(n),a(null,e)})),s&&n.on(c.PROGRESS,s),n.send(t,null,"get",r),e.$ref=n}image(e,t,i,r,s){let a=new I.window.Image;a.crossOrigin="",a.onload=()=>{a.onload=null,a.onerror=null,s(a)},a.onerror=()=>{a.onload=null,a.onerror=null,s(null,"")},a.src=t,e.$ref=a}imageWithBlob(e,t,i,r,s){let a=De.arrayBufferToURL(i,t);this.image(e,a,i,r,s)}imageWithWorker(e,t,i,r,s){ye.enable=!0,ye.enable?ye.load(t,e.workerLoaderOptions).then(s).catch((e=>s(null,e))):this.image(e,t,i,r,s)}audio(e,t,i,r,s){let a=I.createElement("audio");a.crossOrigin="",a.oncanplaythrough=()=>{a.oncanplaythrough=null,a.onerror=null,s(a)},a.onerror=()=>{a.oncanplaythrough=null,a.onerror=null,s(null,"")},a.src=t,e.$ref=a}getRequestInst(){return 0==this.httpRequestPool.length||I.onVVMiniGame||I.onHWMiniGame?new Ae:this.httpRequestPool.pop()}returnRequestInst(e){e.reset(),this.httpRequestPool.length<10&&this.httpRequestPool.push(e)}}var be=0;const Ie={ext:null,typeId:null,main:!1,loaderType:null};class Be extends D{static registerLoader(e,t,i,r){let s;i?(s=Be.typeMap[i],s?s.loaderType!=t&&(s={typeId:s.typeId,loaderType:t}):Be.typeMap[i]=s={typeId:be++,loaderType:t}):s={typeId:be++,loaderType:t},r&&(Be.hotReloadableFlags[s.typeId]=!0);for(let r of e){let e=Be.extMap[r];if(e&&i){let i=e.findIndex((e=>e.typeId==s.typeId));-1==i?e.push(s):e[i].loaderType=t}else Be.extMap[r]=[s]}}constructor(){super(),this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loadings=new Map,this._queue=[],this._downloadings=new Set}get loading(){return this._loadings.size>0}load(e,t,i,r,s,a,n,o,h){let l,u,d,c,_=Ne;if(t instanceof Se?(l=t,u=r):"string"==typeof t?u=t:null!=t&&(u=t.type,_=t),null==s&&null==a&&null==o&&null==n&&null==h||(_=_===Ne?{priority:s,cache:a,ignoreCache:o,group:n,useWorkerLoader:h}:Object.assign(_,{priority:s,cache:a,ignoreCache:o,group:n,useWorkerLoader:h})),!1===_.cache&&(_.ignoreCache=!0),d=i instanceof Se?e=>i.runWith(e):i,Array.isArray(e)){let t;d&&(t=new ve(d));let i=[];for(let r=0;r<e.length;r++){let s=e[r];s&&("string"==typeof s?i.push(this._load1(s,u,_,null==t?void 0:t.createCallback())):i.push(this._load1(s.url,s.type||u,_!==Ne?Object.assign({},_,s):s,null==t?void 0:t.createCallback())))}c=Promise.all(i)}else c="string"==typeof e?this._load1(e,u,_,d):this._load1(e.url,e.type||u,_!==Ne?Object.assign({},_,e):e,d);return l?c.then((e=>(l.runWith(e),e))):c}_load1(e,t,i,r){if(p.isPreview){if(e.startsWith("res://")){let s=e.substring(6);return U.inst.UUID_to_URL_async(s).then((a=>{var n;return a?this._load2(a,s,t,i,r):(!i.silent&&Be.warnFailed(e,void 0,null===(n=i.initiator)||void 0===n?void 0:n.url),Promise.resolve(null))}))}return U.inst.URL_to_UUID_async(e).then((s=>this._load2(e,s,t,i,r)))}return this._load2(e,null,t,i,r)}_load2(e,t,i,r,s){var a,n;let{ext:o,typeId:h,main:l,loaderType:u}=Be.getURLInfo(e,i);if(!u)return!r.silent&&Be.warnFailed(e,void 0,null===(a=r.initiator)||void 0===a?void 0:a.url),Promise.resolve(null);let d,_=k.formatURL(e);if(r.group){let e=Be.groupMap[r.group];e||(e=Be.groupMap[r.group]=new Set),e.add(_)}if(!r.ignoreCache){let e=Be._getRes(_,i);if(void 0!==e){if(null==e)return Promise.resolve(null);if(!(e instanceof A))return Promise.resolve(e);if(e.obsolute&&(d=e),!(d||e.uuid&&t&&t!=e.uuid))return Promise.resolve(e)}}let p=_;l||(p+="@"+h);let g=this._loadings.get(p);if(g){let e=r.initiator;for(;e;){if(e===g)return Promise.resolve();e=e.options.initiator}return null!=g.result?g.result:(s&&g.onProgress.add(s),new Promise((e=>g.onComplete.add(e))))}let m=Te.getFileLoadPath(_);if(m)return this.load(m.url,{type:Be.ATLAS,baseUrl:m.baseUrl}).then((()=>Be.getRes(e,i)));g=Pe.length>0?Pe.pop():new Le,g.type=i,g.url=e,g.uuid=t,g.ext=o,delete(r=Object.assign(g.options,r)).type,null==r.priority&&(r.priority=0),null==r.useWorkerLoader&&(r.useWorkerLoader=ye.enable),s&&g.onProgress.add(s),g.loader=this,g.obsoluteInst=d;let f,T=new u;this._loadings.set(p,g);try{Be.LoaderStat_LoaderResourceCount++,this._tempTime=performance.now(),f=T.load(g)}catch(t){!r.silent&&Be.warnFailed(e,t,null===(n=r.initiator)||void 0===n?void 0:n.url),f=Promise.resolve(null)}return f.then((i=>(Be.LoaderStat_LoadResourceTime+=performance.now()-this._tempTime,i instanceof A&&(i.obsolute=!1,i._setCreateURL(e,t)),!1!==g.options.cache&&Be._cacheRes(_,i,h,l),null!=i&&null!=T.postLoad?(g.result=i,T.postLoad(g,i).then((()=>(g.progress.update(-1,1),g.onComplete.invoke(i),i)))):(g.progress.update(-1,1),g.onComplete.invoke(i),i)))).catch((t=>{var i;return!r.silent&&Be.warnFailed(e,t,null===(i=r.initiator)||void 0===i?void 0:i.url),!1!==g.options.cache&&Be._cacheRes(_,null,h,l),g.onComplete.invoke(null),null})).then((e=>(this._loadings.delete(p),g.reset(),Pe.push(g),0==this._loadings.size&&this.event(c.COMPLETE),e)))}fetch(e,t,i,r){var s;let a={originalUrl:e,url:e,contentType:t,priority:null!==(s=(r=r||Ne).priority)&&void 0!==s?s:1,retryCnt:0,onProgress:i,onComplete:null};return r.useWorkerLoader&&(a.useWorkerLoader=!0,a.workerLoaderOptions=r.workerLoaderOptions),r.blob&&(a.blob=r.blob),r.noRetry&&(a.retryCnt=-1),r.silent&&(a.silent=!0),U.inst.resolveURL(e).then((e=>e?new Promise((t=>{a.url=k.formatURL(e),a.onComplete=t,this.queueToDownload(a)})):null))}queueToDownload(e){if(this._downloadings.size<this.maxLoader)return void this.download(e);let t=e.priority;if(0==t)this._queue.push(e);else{let i=this._queue.findIndex((e=>e.priority<t));-1!=i?this._queue.splice(i,0,e):this._queue.push(e)}}download(e){this._downloadings.add(e),Be.LoaderStat_LoadRequestCount++,e.startTime=performance.now();let t=k.postFormatURL(e.url);if("image"==e.contentType){let i=Be.preLoadedMap[e.url];if(i){if(!(i instanceof ArrayBuffer))return void this.completeItem(e,i);e.blob=i}e.blob?Be.downloader.imageWithBlob(e,e.blob,e.originalUrl,e.onProgress,((t,i)=>{t||(e.retryCnt=-1),this.completeItem(e,t,i)})):e.useWorkerLoader?Be.downloader.imageWithWorker(e,t,e.originalUrl,e.onProgress,((t,i)=>{t||(e.useWorkerLoader=!1,e.silent||Be.warnFailed(e.url,i)),this.completeItem(e,t,i)})):Be.downloader.image(e,t,e.originalUrl,e.onProgress,((t,i)=>this.completeItem(e,t,i)))}else if("sound"==e.contentType)Be.downloader.audio(e,t,e.originalUrl,e.onProgress,((t,i)=>this.completeItem(e,t,i)));else{let i=Be.preLoadedMap[e.url];if(i)return void this.completeItem(e,i);Be.downloader.common(e,t,e.originalUrl,e.contentType,e.onProgress,((t,i)=>this.completeItem(e,t,i)))}}completeItem(e,t,i){this._downloadings.delete(e),Be.LoaderStat_LoadRequestTime+=performance.now()-e.startTime,t?(this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),e.onProgress&&e.onProgress(1),e.onComplete(t)):-1!=e.retryCnt&&e.retryCnt<this.retryNum?(e.retryCnt++,e.silent||console.debug(`Retry to load ${e.url} (${e.retryCnt})`),h.systemTimer.once(this.retryDelay,this,this.queueToDownload,[e],!1)):(!e.silent&&Be.warnFailed(e.url,i),e.onProgress&&e.onProgress(1),this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),e.onComplete(null))}static getURLInfo(e,t){let i,r,s,a,n=e.startsWith("data:")?"png":O.getFileExtension(e);if(n.length>0&&(i=Be.extMap[n]),t){let e=Be.typeMap[t];if(!e)return Ie;r=e.typeId;let n=0;i?i[0].typeId===r||-1!=(n=i.findIndex((e=>e.typeId===r)))?(s=0==n,a=i[n].loaderType):(s=!1,a=e.loaderType):(s=t!=Be.TEXTURE2D,a=e.loaderType)}else{if(!i)return Ie;s=!0,r=i[0].typeId,a=i[0].loaderType}return{ext:n,main:s,typeId:r,loaderType:a}}static warnFailed(e,t,i){i?this.warn(`Failed to load '${e}' (in '${i}')`,t):this.warn(`Failed to load '${e}'`,t)}static warn(e,t){t?console.warn(e,t):console.warn(e)}static getRes(e,t){return e=k.formatURL(e),Be._getRes(e,t)||null}static _getRes(e,t){let i,r=Be.loadedMap[e];if(r){if(t){let e=Be.typeMap[t];if(!e)return;if(2==r.length)r[0]==e.typeId&&(i=r[1]);else{let t=r.indexOf(e.typeId);-1!=t&&(i=r[t+1])}}else i=r[1];return i instanceof A&&i.destroyed?void 0:i}}static getTexture2D(e){return Be.getRes(e,Be.TEXTURE2D)}static getBaseTexture(e){return Be.getRes(e,Be.TEXTURE2D)}static getAtlas(e){return Be.getRes(e,Be.ATLAS)}getRes(e,t){return Be.getRes(e,t)}static createNodes(e){var t;return null===(t=Be.getRes(e))||void 0===t?void 0:t.create()}static cacheRes(e,t,i){e=k.formatURL(e);let r=Be.getURLInfo(e,i);null!=r.typeId&&Be._cacheRes(e,t,r.typeId,r.main)}static _cacheRes(e,t,i,r){let s=Be.loadedMap[e];if(r)s?(s[0]=i,s[1]=t):s=Be.loadedMap[e]=[i,t];else if(s){let e=s.findIndex((e=>e===i));-1!=e?s[e+1]=t:s.push(i,t)}else s=Be.loadedMap[e]=[null,void 0,i,t]}cacheRes(e,t,i){Be.cacheRes(e,t,i)}static clearRes(e,t){e=k.formatURL(e),Be._clearRes(e,t)}clearRes(e,t){e=k.formatURL(e),Be._clearRes(e,t)}static _clearRes(e,t){let i=Be.loadedMap[e];if(i)if(t){if(i[1]==t)2==i.length?delete Be.loadedMap[e]:i[1]=void 0;else{let r=i.indexOf(t);if(-1==r)return;4==i.length&&null==i[0]?delete Be.loadedMap[e]:i.splice(r-1,2)}t instanceof A&&!t.destroyed&&t.destroy()}else if(delete Be.loadedMap[e],i.length>2)for(let e=1;e<i.length;e+=2){let t=i[e];t instanceof A&&!t.destroyed&&t.destroy()}else{let e=i[1];e instanceof A&&!e.destroyed&&e.destroy()}}clearTextureRes(e){e=k.formatURL(e);let t=Be.loadedMap[e];if(!t)return;let i=t[1];if(i instanceof fe)i.disposeBitmap();else if(i instanceof xe)for(let e of i.textures)e.disposeBitmap()}static setGroup(e,t){e=k.formatURL(e);let i=Be.groupMap[t];i||(i=Be.groupMap[t]=new Set),i.add(e)}static clearResByGroup(e){let t=Be.groupMap[e];if(t)for(let e of t)Be._clearRes(e)}clearUnLoaded(){if(0==this._queue.length)return;let e=this._queue.concat();this._queue.length=0;for(let t of e)t.onComplete(null)}cancelLoadByUrls(e){if(e)for(var t=0,i=e.length;t<i;t++)this.cancelLoadByUrl(e[t])}cancelLoadByUrl(e){e=k.formatURL(e);let t=this._queue.findIndex((t=>t.url==e));if(-1!=t){let e=this._queue[t];this._queue.splice(t,1),e.onComplete(null)}}loadPackage(e,t,i){let r,s;if("string"==typeof t?(s=t,r=i):r=i||t,s)return s.endsWith("/")||(s+="/"),k.basePaths[e.length>0?e+"/":e]=s,this._loadSubFileConfig(e,null,r);{if(p.isPreview)return Promise.resolve();let t=h.Browser.miniGameContext;return null==t?this._loadSubFileConfig(e,null,r):this._loadMiniPackage(t,e,r).then((()=>this._loadSubFileConfig(e,t,r)))}}_loadMiniPackage(e,t,i){return e.subPkgNameSeperator&&(t=t.replace(/\//g,e.subPkgNameSeperator)),t.length>0?new Promise(((r,s)=>{let a=e.loadSubpackage({name:t,success:e=>{r(e)},fail:e=>{s(e)}});a.onProgressUpdate&&a.onProgressUpdate((e=>{i&&i(e)}))})):Promise.resolve()}_loadSubFileConfig(e,t,i){return t&&t.subPkgPathSeperator&&(e=e.replace(/\//g,t.subPkgPathSeperator)),e.length>0&&(e+="/"),this.fetch(e+"fileconfig.json","json",i).then((i=>{let r=[],s=i.files;for(let e in s)if(e.length>0)for(let t of s[e])r.push(e+"/"+t);else for(let t of s[e])r.push(t);if(i.hash){let e=0,t=k.version;for(let s of i.hash)null!=s&&(t[r[e]]=s),e++}let a,n,o=i.config,l=o.length,u=0,d=0,c=0,_=0,p=0,g=U.inst.metaMap;for(;;){if(null==a){if(u>=l)break;n=o[u],a=n.i,Array.isArray(a)?p=a.length:(c=a,p=0,_=1),d=0}if(0==_){if(d>=p){u++,a=null;continue}_=a[d++],_>0?(c=_,_=0):_=-_}else _--;let e=r[c+_];switch(n.t){case 0:g[e]=n;break;case 1:Te.addAtlas(e,n.prefix,n.frames);break;case 2:U.inst.shaderNameMap[n.shaderName]=e;break;case 3:Be.preLoadedMap[k.formatURL(e)]=n}}return!t&&i.entry?h.Browser.loadLib(k.formatURL(e+i.entry)):Promise.resolve()}))}}Be.TEXT="text",Be.JSON="json",Be.XML="xml",Be.BUFFER="arraybuffer",Be.IMAGE="image",Be.SOUND="sound",Be.VIDEO="video",Be.ATLAS="atlas",Be.FONT="font",Be.TTF="ttf",Be.HIERARCHY="HIERARCHY",Be.MESH="MESH",Be.MATERIAL="MATERIAL",Be.TEXTURE2D="TEXTURE2D",Be.TEXTURECUBE="TEXTURE2D",Be.TEXTURE2DARRAY="TEXTURE2D",Be.ANIMATIONCLIP="ANIMATIONCLIP",Be.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Be.TERRAINRES="TERRAIN",Be.SPINE="SPINE",Be.extMap={},Be.typeMap={},Be.hotReloadableFlags={},Be.downloader=new Me,Be.groupMap={},Be.loadedMap={},Be.preLoadedMap={};class Le{constructor(){this.options={},this.onProgress=new v,this.onComplete=new v,this.progress=new ve((e=>this.onProgress.invoke(e)))}reset(){for(let e in this.options)delete this.options[e];this.onProgress.clear(),this.onComplete.clear(),this.progress.reset(),this.obsoluteInst=null,this.result=null}}const Pe=[],Ne={};class Oe{static regClass(e,t){Oe._classMap[e]=t}static getClass(e){return Oe._classMap[e]}static regRuntime(e,t){Oe._runtimeMap[e]=t}static getRuntime(e){return Oe._runtimeMap[e]}}function Fe(){}Oe._classMap={},Oe._runtimeMap={};class Ue{}Ue.ENUM_TEXTALIGN_DEFAULT=0,Ue.ENUM_TEXTALIGN_CENTER=1,Ue.ENUM_TEXTALIGN_RIGHT=2,Ue.INDEX_BYTES=2,Ue.MAX_CLIP_SIZE=99999999;class ke{}ke.ACTIVE=1,ke.ACTIVE_INHIERARCHY=2,ke.AWAKED=4,ke.ACTUAL_VISIBLE=8,ke.DISPLAY=16,ke.HAS_ZORDER=32,ke.AREA_2D=64,ke.DISPLAYED_INSTAGE=128,ke.DRAWCALL_OPTIMIZE=256,ke.CHECK_INPUT=512,ke.DEMAND_TRANS_EVENT=1024,ke.HAS_SCRIPT=2048,ke.ESCAPE_DRAWING_TO_TEXTURE=4096,ke.DISABLE_INNER_CLIPPING=8192,ke.DISABLE_OUTER_CLIPPING=16384,ke.FORCE_VISIBLE=32768,ke.EDITING_NODE=65536,ke.HIDE_BY_EDITOR=131072,ke.LOCK_BY_EDITOR=262144,ke.FORCE_HIDDEN=524288,ke.NOT_IN_PAGE=1048576,ke.ESCAPE_LAYOUT=2097152,ke.EDITING_ROOT_NODE=4194304;class Ge{}Ge.HideInHierarchy=1,Ge.HideInInspector=2,Ge.DontSave=4,Ge.HideAndDontSave=7;class Ve{static _getPoints(e,t=!1,i=null){for(;ze.length<e;)ze.push(new d);return i||(i=[]),i.length=0,t?Ve.getFrom(i,ze,e):Ve.getFromR(i,ze,e),i}static getFrom(e,t,i){var r;for(r=0;r<i;r++)e.push(t[r]);return e}static getFromR(e,t,i){var r;for(r=0;r<i;r++)e.push(t.pop());return e}static pListToPointList(e,t){var i,r=e.length/2,s=Ve._getPoints(r,t,He);for(i=0;i<r;i++)s[i].setTo(e[i+i],e[i+i+1]);return s}static pointListToPlist(e){var t,i,r=e.length,s=We;for(s.length=0,t=0;t<r;t++)i=e[t],s.push(i.x,i.y);return s}static scanPList(e){O.copyArray(e,Ve.pointListToPlist(Ve.scan(Ve.pListToPointList(e,!0))))}static scan(e){let t,i,r=0,s=e.length,a={},n=Ye;for(n.length=0,s=e.length,t=s-1;t>=0;t--){let i=e[t],r=i.x+"_"+i.y;r in a||(a[r]=!0,n.push(i))}for(s=n.length,O.copyArray(e,n),t=1;t<s;t++)(e[t].y<e[r].y||e[t].y==e[r].y&&e[t].x<e[r].x)&&(r=t);let o=e[0];for(e[0]=e[r],e[r]=o,t=1;t<s-1;t++){for(r=t,i=t+1;i<s;i++)(Xe(e[i],e[r],e[0])>0||0==Xe(e[i],e[r],e[0])&&qe(e[0],e[i])<qe(e[0],e[r]))&&(r=i);let a=e[t];e[t]=e[r],e[r]=a}if(n.length=0,e.length<3)return O.copyArray(n,e);for(n.push(e[0],e[1],e[2]),t=3;t<s;t++){for(;n.length>=2&&Xe(e[t],n[n.length-1],n[n.length-2])>=0;)n.pop();e[t]&&n.push(e[t])}return n}}const ze=[],He=[],We=[],Ye=[];function Xe(e,t,i){return(e.x-i.x)*(t.y-i.y)-(t.x-i.x)*(e.y-i.y)}function qe(e,t){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)}class je{}var Ke,$e,Qe,Ze,Je,et,tt,it,rt;je.ALPHA=1,je.TRANSFORM=2,je.BLEND=4,je.CANVAS=8,je.FILTERS=16,je.MASK=32,je.CLIP=64,je.TEXTURE=128,je.GRAPHICS=256,je.RENDERNODE2D=512,je.CUSTOM=1024,je.HITAREA=2048,je.CHILDS=4096,je.REPAINT_NONE=0,je.REPAINT_NODE=1,je.REPAINT_CACHE=2,je.REPAINT_ALL=3,e.TransformKind=void 0,(Ke=e.TransformKind||(e.TransformKind={}))[Ke.Pos=1]="Pos",Ke[Ke.Width=2]="Width",Ke[Ke.Height=4]="Height",Ke[Ke.Anchor=8]="Anchor",Ke[Ke.Scale=16]="Scale",Ke[Ke.Skew=32]="Skew",Ke[Ke.Rotation=64]="Rotation",Ke[Ke.Matrix=128]="Matrix",Ke[Ke.Size=6]="Size",Ke[Ke.Layout=30]="Layout",Ke[Ke.TRS=81]="TRS",e.RenderParams=void 0,($e=e.RenderParams||(e.RenderParams={}))[$e.Max_Active_Texture_Count=0]="Max_Active_Texture_Count",$e[$e.Max_Uniform_Count=1]="Max_Uniform_Count",$e[$e.Max_AnisoLevel_Count=2]="Max_AnisoLevel_Count",$e[$e.MAX_Texture_Size=3]="MAX_Texture_Size",$e[$e.MAX_Texture_Image_Uint=4]="MAX_Texture_Image_Uint",$e[$e.SHADER_CAPAILITY_LEVEL=5]="SHADER_CAPAILITY_LEVEL",$e[$e.FLOAT=6]="FLOAT",$e[$e.UNSIGNED_BYTE=7]="UNSIGNED_BYTE",$e[$e.BYTE=8]="BYTE",$e[$e.UNSIGNED_SHORT=9]="UNSIGNED_SHORT";class st{static __init__(){st._elementInfos={single:[1,g.renderEngine.getParams(e.RenderParams.FLOAT),0],vector2:[2,g.renderEngine.getParams(e.RenderParams.FLOAT),0],vector3:[3,g.renderEngine.getParams(e.RenderParams.FLOAT),0],vector4:[4,g.renderEngine.getParams(e.RenderParams.FLOAT),0],color:[4,g.renderEngine.getParams(e.RenderParams.FLOAT),0],byte4:[4,g.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte3:[3,g.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte2:[2,g.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte:[1,g.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],short2:[2,g.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],short4:[4,g.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],normalizedshort2:[2,g.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],normalizedshort4:[4,g.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],halfvector2:[2,g.renderEngine.getParams(e.RenderParams.FLOAT),0],halfvector4:[4,g.renderEngine.getParams(e.RenderParams.FLOAT),0],nbyte4:[4,g.renderEngine.getParams(e.RenderParams.BYTE),1],ubyte4:[4,g.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),1]}}static getElementInfos(e){var t=st._elementInfos[e];if(t)return t;throw"VertexElementFormat: this vertexElementFormat is not implement."}}st.Single="single",st.Vector2="vector2",st.Vector3="vector3",st.Vector4="vector4",st.Color="color",st.Byte4="byte4",st.Byte3="byte3",st.Byte2="byte2",st.ByteOne="byte",st.Short2="short2",st.Short4="short4",st.NormalizedShort2="normalizedshort2",st.NormalizedShort4="normalizedshort4",st.HalfVector2="halfvector2",st.HalfVector4="halfvector4",st.NorByte4="nbyte4",st.NorUByte4="ubyte4";class at{}class nt{get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}constructor(e,t){this._id=++nt._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t,this._VAElements=[];var i=t.length;this._shaderValues={};for(var r=0;r<i;r++){var s=t[r],a=s._elementUsage;this._vertexElementsDic[a]=s;var n=new at,o=st.getElementInfos(s._elementFormat);n.elementString=s._elementFormat,n.elementCount=o[0],n.elementType=o[1],n.normalized=o[2],n.vertexStride=this._vertexStride,n.elementOffset=s._offset,this._shaderValues[a]=n,this._VAElements.push({format:s._elementFormat,stride:s._offset,shaderLocation:a})}}getVertexElementByIndex(e){return this._vertexElements[e]}getVertexElementByUsage(e){return this._vertexElementsDic[e]}}nt._uniqueIDCounter=1;class ot{get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}constructor(e,t,i){this._offset=e,this._elementFormat=t,this._elementUsage=i}}class ht{constructor(e,t,i){this._stride=0,this._vertNum=0,this._indexNum=0,this._stride=e,this._VBBuff=new ArrayBuffer(t||32),this._IBBuff=new ArrayBuffer(i||8),this.onVBRealloc(this._VBBuff),this.onIBRealloc(this._IBBuff)}get vbBuffer(){return this._VBBuff}get ibBuffer(){return this._IBBuff}get indexNum(){return this._indexNum}get vertexNum(){return this._vertNum}clearMesh(){this._vertNum=0,this._indexNum=0}expVBSize(e){if(e){let t=this._vertNum*this._stride;if(t+e>this._VBBuff.byteLength){let i=this._VBBuff;this._VBBuff=new ArrayBuffer(t+8*e),new Uint8Array(this._VBBuff,0,t).set(new Uint8Array(i,0,t)),this.onVBRealloc(this._VBBuff)}}}expIBSize(e){if(e){let t=2*this._indexNum;if(t+e>this._IBBuff.byteLength){let i=this._IBBuff;this._IBBuff=new ArrayBuffer(t+8*e),new Uint8Array(this._IBBuff,0,t).set(new Uint8Array(i,0,t)),this.onIBRealloc(this._IBBuff)}}}}class lt extends ht{static __int__(){lt._fixib=function(e){let t=new Y(6*e*2),i=new Uint16Array(t.buffer);for(var r=0,s=0,a=0;a<e;a++)i[r++]=s,i[r++]=s+2,i[r++]=s+1,i[r++]=s,i[r++]=s+3,i[r++]=s+2,s+=4;return i}(lt._maxIB),lt.VertexDeclarition=new nt(48,[new ot(0,st.Vector4,0),new ot(16,st.Vector4,1),new ot(32,st.Vector4,2)])}constructor(e=4){super(lt.const_stride,e,4),this._curVBPos=0}onVBRealloc(e){this._vbFloat32Array=new Float32Array(e)}onIBRealloc(e){}addQuad(e,t,i,r){this.expVBSize(lt.const_stride);var s=this._vbFloat32Array;let a=(i>>>16&255)/255,n=(i>>>8&255)/255,o=(255&i)/255,h=(i>>>24)/255;var l=this._curVBPos,u=r?1:0;s[l++]=e[0],s[l++]=e[1],s[l++]=t[0],s[l++]=t[1],s[l++]=o,s[l++]=n,s[l++]=a,s[l++]=h,s[l++]=u,l+=3,s[l++]=e[2],s[l++]=e[3],s[l++]=t[2],s[l++]=t[3],s[l++]=o,s[l++]=n,s[l++]=a,s[l++]=h,s[l++]=u,l+=3,s[l++]=e[4],s[l++]=e[5],s[l++]=t[4],s[l++]=t[5],s[l++]=o,s[l++]=n,s[l++]=a,s[l++]=h,s[l++]=u,l+=3,s[l++]=e[6],s[l++]=e[7],s[l++]=t[6],s[l++]=t[7],s[l++]=o,s[l++]=n,s[l++]=a,s[l++]=h,s[l++]=u,l+=3,this._curVBPos=l,this._vertNum+=4,this._indexNum+=6}clearMesh(){super.clearMesh(),this._curVBPos=0}get ibBuffer(){return lt._fixib.buffer}get vertexDeclarition(){return lt.VertexDeclarition}}lt.const_stride=48,lt._maxIB=16384;class ut extends D{constructor(){super(),this.left=0,this.top=0,this.width=0,this.height=0;let e=this._rectMeshNormY=new lt;e.addQuad([0,0,1,0,1,1,0,1],[0,0,1,0,1,1,0,1],4294967295,!0),this._rectMeshVBNormY=new Float32Array(e.vbBuffer);let t=this._rectMeshInvY=new lt;t.addQuad([0,0,1,0,1,1,0,1],[0,1,1,1,1,0,0,0],4294967295,!0),this._rectMeshVBInvY=new Float32Array(t.vbBuffer),this.useFlipY(!1)}onChange(){this.event(c.CHANGED)}useFlipY(e){this._rectMesh=e?this._rectMeshInvY:this._rectMeshNormY,this._rectMeshVB=e?this._rectMeshVBInvY:this._rectMeshVBNormY}set render2D(e){this._render2D=e}get type(){return-1}}ut.COLOR=32,ut._filter=function(e,t,i,r){var s=this._next;if(!s)return;var a=e.filters,n=a.length;if(1==n&&a[0].type==ut.COLOR)return t.save(),t.setColorFilter(a[0]),s._fun.call(s,e,t,i,r),void t.restore();let o=e._getCacheStyle(),h=0,l=0;if(this._renderNextToCacheRT(e,t,16,16,16,16)){h=o.cacheRect.x,l=o.cacheRect.y;let e=o.renderTexture,i=e,r=e.width,s=e.height;for(let o=0;o<n;o++){e=i;var u=a[o];u._render2D=t.render2D,u.useFlipY(0!=o),u.render(e,r,s),r=u.width,s=u.height,i=u.texture,h+=u.left,l+=u.top}o.renderTexture=i,o.renderTexOffx=h,o.renderTexOffy=l}o.renderTexture&&t._drawRenderTexture(o.renderTexture,i+o.renderTexOffx,r+o.renderTexOffy,o.renderTexture.width,o.renderTexture.height,null,1,pe.defuv)},e.GPUEngineStatisticsInfo=void 0,(Qe=e.GPUEngineStatisticsInfo||(e.GPUEngineStatisticsInfo={}))[Qe.C_UniformBufferUploadCount=0]="C_UniformBufferUploadCount",Qe[Qe.C_GeometryBufferUploadCount=1]="C_GeometryBufferUploadCount",Qe[Qe.C_TriangleCount=2]="C_TriangleCount",Qe[Qe.C_SetRenderPassCount=3]="C_SetRenderPassCount",Qe[Qe.C_DrawCallCount=4]="C_DrawCallCount",Qe[Qe.C_Instancing_DrawCallCount=5]="C_Instancing_DrawCallCount",Qe[Qe.C_ShaderCompile=6]="C_ShaderCompile",Qe[Qe.T_ShaderCompile=7]="T_ShaderCompile",Qe[Qe.FrameClearCount=8]="FrameClearCount",Qe[Qe.M_GPUMemory=9]="M_GPUMemory",Qe[Qe.M_GPUBuffer=10]="M_GPUBuffer",Qe[Qe.M_VertexBuffer=11]="M_VertexBuffer",Qe[Qe.M_IndexBuffer=12]="M_IndexBuffer",Qe[Qe.M_UniformBlockBuffer=13]="M_UniformBlockBuffer",Qe[Qe.RC_GPUBuffer=14]="RC_GPUBuffer",Qe[Qe.RC_VertexBuffer=15]="RC_VertexBuffer",Qe[Qe.RC_IndexBuffer=16]="RC_IndexBuffer",Qe[Qe.RC_UniformBlockBuffer=17]="RC_UniformBlockBuffer",Qe[Qe.M_ALLTexture=18]="M_ALLTexture",Qe[Qe.M_Texture2D=19]="M_Texture2D",Qe[Qe.M_TextureCube=20]="M_TextureCube",Qe[Qe.M_Texture3D=21]="M_Texture3D",Qe[Qe.M_Texture2DArray=22]="M_Texture2DArray",Qe[Qe.RC_ALLTexture=23]="RC_ALLTexture",Qe[Qe.RC_Texture2D=24]="RC_Texture2D",Qe[Qe.RC_TextureCube=25]="RC_TextureCube",Qe[Qe.RC_Texture3D=26]="RC_Texture3D",Qe[Qe.RC_Texture2DArray=27]="RC_Texture2DArray",Qe[Qe.M_ALLRenderTexture=28]="M_ALLRenderTexture",Qe[Qe.RC_ALLRenderTexture=29]="RC_ALLRenderTexture",Qe[Qe.Count=30]="Count",e.RenderPassStatisticsInfo=void 0,(Ze=e.RenderPassStatisticsInfo||(e.RenderPassStatisticsInfo={}))[Ze.T_CameraRender=0]="T_CameraRender",Ze[Ze.T_Render_OpaqueRender=1]="T_Render_OpaqueRender",Ze[Ze.T_Render_TransparentRender=2]="T_Render_TransparentRender",Ze[Ze.T_Render_PostProcess=3]="T_Render_PostProcess",Ze[Ze.T_Render_CameraEventCMD=4]="T_Render_CameraEventCMD",Ze[Ze.T_Render_ShadowPassMode=5]="T_Render_ShadowPassMode",Ze[Ze.T_Render_CameraOtherDest=6]="T_Render_CameraOtherDest",Ze[Ze.T_RenderPreUpdate=7]="T_RenderPreUpdate",Ze[Ze.T_OtherRender=8]="T_OtherRender",Ze[Ze.T_OnlyMeshRender=9]="T_OnlyMeshRender",Ze[Ze.T_OnlySkinnedMeshRender=10]="T_OnlySkinnedMeshRender",Ze[Ze.T_OnlyShurikenParticleRender=11]="T_OnlyShurikenParticleRender",Ze[Ze.T_CameraMainCull=12]="T_CameraMainCull",Ze[Ze.T_ShadowMapCull=13]="T_ShadowMapCull",Ze[Ze.RenderPassStatisticCount=14]="RenderPassStatisticCount";class dt{static show(e,t,i){dt._statUI||(dt._statUI=new dt._statUIClass),this.hide(),dt._show=!0,g.renderEngine._enableStatistics=!0,dt._currentShowArray=i||dt.AllShow,dt._statUI.show(e,t,dt._currentShowArray),h.systemTimer.frameLoop(1,null,dt.loop),h.timer.frameLoop(1,null,dt.clear)}static hide(){dt._show&&(dt._show=!1,dt._currentShowArray=null,h.timer.clear(null,dt.loop),h.timer.clear(null,dt.clear),dt._statUI&&dt._statUI.hide())}static loop(){dt._count++;let e=I.now();if(e-dt._timer<1e3)return;let t=dt._count;if(dt.FPS=Math.round(1e3*t/(e-dt._timer)),dt._show){dt.updateEngineData();let e=dt.FPS>0?Math.floor(1e3/dt.FPS).toString():" ";dt._fpsStr=dt.FPS+(dt.renderSlow?" slow":"")+" "+e+"ms",dt._statUI.update()}dt._count=0,dt._timer=e}static updateEngineData(){dt.trianglesFaces+=g.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.C_TriangleCount),dt.drawCall+=g.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.C_DrawCallCount),dt.instanceDrawCall+=g.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.C_Instancing_DrawCallCount),dt.gpuMemory=g.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.M_GPUMemory),dt.textureMemory=g.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.M_ALLTexture),dt.renderTextureMemory=g.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.M_ALLRenderTexture),dt.bufferMemory=g.renderEngine.getStatisticsInfo(e.GPUEngineStatisticsInfo.M_GPUBuffer)}static clear(){dt._currentShowArray&&!dt._count&&(dt._currentShowArray.forEach((e=>{"average"==e.mode&&(dt[e.value]=0)})),g.renderEngine.clearStatisticsInfo(),dt.renderPassStatArray.fill(0))}static render(e,t,i){dt._show&&dt._statUI.render(e,t,i)}}dt.FPSStatUIParams={title:"FPS",value:"_fpsStr",color:"yellow",units:"int",mode:"summit"},dt.NodeStatUIParams={title:"Node",value:"spriteCount",color:"white",units:"int",mode:"summit"},dt.Sprite3DStatUIParams={title:"Sprite3D",value:"sprite3DCount",color:"white",units:"int",mode:"summit"},dt.DrawCall={title:"DrawCall",value:"drawCall",color:"white",units:"int",mode:"average"},dt.TriangleFace={title:"TriangleFace",value:"trianglesFaces",color:"white",units:"int",mode:"average"},dt.RenderNode={title:"RenderNode",value:"renderNode",color:"white",units:"int",mode:"summit"},dt.SkinRenderNode={title:"SkinRenderNode",value:"skinRenderNode",color:"white",units:"int",mode:"summit"},dt.ParticleRenderNode={title:"ParticleRenderNode",value:"particleRenderNode",color:"white",units:"int",mode:"summit"},dt.FrustumCulling={title:"FrustumCulling",value:"frustumCulling",color:"white",units:"int",mode:"average"},dt.UniformUpload={title:"UniformUpload",value:"uniformUpload",color:"white",units:"int",mode:"average"},dt.OpaqueDrawCall={title:"OpaqueDrawCall",value:"opaqueDrawCall",color:"white",units:"int",mode:"average"},dt.TransDrawCall={title:"TransDrawCall",value:"transDrawCall",color:"white",units:"int",mode:"average"},dt.DepthCastDrawCall={title:"DepthCastDrawCall",value:"depthCastDrawCall",color:"white",units:"int",mode:"average"},dt.ShadowDrawCall={title:"ShadowDrawCall",value:"shadowMapDrawCall",color:"white",units:"int",mode:"average"},dt.InstanceDrawCall={title:"InstanceDrawCall",value:"instanceDrawCall",color:"white",units:"int",mode:"average"},dt.CMDDrawCall={title:"CMDDrawCall",value:"cmdDrawCall",color:"white",units:"int",mode:"average"},dt.BlitDrawCall={title:"BlitDrawCall",value:"blitDrawCall",color:"white",units:"int",mode:"average"},dt.GPUMemory={title:"GPUMemory",value:"gpuMemory",color:"white",units:"M",mode:"summit"},dt.TextureMemeory={title:"TextureMemory",value:"textureMemory",color:"white",units:"M",mode:"summit"},dt.RenderTextureMemory={title:"RenderTextureMemory",value:"renderTextureMemory",color:"white",units:"M",mode:"summit"},dt.BufferMemory={title:"BufferMemory",value:"bufferMemory",color:"white",units:"M",mode:"summit"},dt.uploadUniformNum={title:"UploadUniformNum",value:"uploadUniform",color:"white",units:"int",mode:"average"},dt.AllShow=[dt.FPSStatUIParams,dt.NodeStatUIParams,dt.Sprite3DStatUIParams,dt.DrawCall,dt.TriangleFace,dt.RenderNode,dt.SkinRenderNode,dt.ParticleRenderNode,dt.FrustumCulling,dt.OpaqueDrawCall,dt.TransDrawCall,dt.ShadowDrawCall,dt.DepthCastDrawCall,dt.InstanceDrawCall,dt.CMDDrawCall,dt.BlitDrawCall,dt.GPUMemory,dt.TextureMemeory,dt.RenderTextureMemory,dt.BufferMemory,dt.uploadUniformNum],dt.memoryShow=[dt.GPUMemory,dt.TextureMemeory,dt.RenderTextureMemory,dt.BufferMemory],dt.renderShow=[dt.DrawCall,dt.TriangleFace,dt.OpaqueDrawCall,dt.TransDrawCall,dt.ShadowDrawCall,dt.DepthCastDrawCall,dt.InstanceDrawCall,dt.CMDDrawCall,dt.BlitDrawCall],dt.toogle_Shadow={title:"Shadow",value:"enableShadow",color:"white"},dt.toogle_MulLight={title:"MulLight",value:"enableMulLight",color:"white"},dt.toogle_Light={title:"Light",value:"enableLight",color:"white"},dt.toogle_Postprocess={title:"Postprocess",value:"enablePostprocess",color:"white"},dt.toogle_AnimatorUpdate={title:"AnimatorUpdate",value:"enableAnimatorUpdate",color:"white"},dt.toogle_PhysicsUpdate={title:"PhysicsUpdate",value:"enablePhysicsUpdate",color:"white"},dt.toogle_Skin={title:"Skin",value:"enableSkin",color:"white"},dt.toogle_Transparent={title:"Transparent",value:"enableTransparent",color:"white"},dt.toogle_Particle={title:"Particle",value:"enableParticle",color:"white"},dt.toogle_msaa={title:"MSAA",value:"enablemsaa",color:"white"},dt.toogle_CameraCMD={title:"CameraCMD",value:"enableCameraCMD",color:"white"},dt.toogle_Opaque={title:"Opaque",value:"enableOpaque",color:"white"},dt.AllToggle=[dt.toogle_Shadow,dt.toogle_Light,dt.toogle_MulLight,dt.toogle_Postprocess,dt.toogle_AnimatorUpdate,dt.toogle_PhysicsUpdate,dt.toogle_Opaque,dt.toogle_Transparent,dt.toogle_CameraCMD,dt.toogle_Skin,dt.toogle_Particle,dt.toogle_msaa],dt.RenderModeToggle=[dt.toogle_Shadow,dt.toogle_Light,dt.toogle_MulLight,dt.toogle_Postprocess,dt.toogle_AnimatorUpdate,dt.toogle_PhysicsUpdate],dt.RenderFuncToggle=[dt.toogle_Opaque,dt.toogle_Transparent,dt.toogle_CameraCMD,dt.toogle_Skin,dt.toogle_Particle,dt.toogle_msaa],dt.FPS=0,dt.loopCount=0,dt.spriteRenderUseCacheCount=0,dt.canvasNormal=0,dt.canvasBitmap=0,dt.canvasReCache=0,dt.renderSlow=!1,dt._timer=0,dt._count=0,dt._fpsStr="",dt.spriteCount=0,dt.sprite3DCount=0,dt.drawCall=0,dt.draw2D=0,dt.trianglesFaces=0,dt.renderNode=0,dt.meshRenderNode=0,dt.skinRenderNode=0,dt.particleRenderNode=0,dt.frustumCulling=0,dt.uniformUpload=0,dt.opaqueDrawCall=0,dt.transDrawCall=0,dt.depthCastDrawCall=0,dt.shadowMapDrawCall=0,dt.instanceDrawCall=0,dt.cmdDrawCall=0,dt.blitDrawCall=0,dt.renderPassStatArray=[],dt.enableRenderPassStatArray=!1,dt.textureMemory=0,dt.renderTextureMemory=0,dt.bufferMemory=0,dt.uploadUniform=0,dt.enableShadow=!0,dt.enableMulLight=!0,dt.enableLight=!0,dt.enableCameraCMD=!0,dt.enablePostprocess=!0,dt.enableSkin=!0,dt.enableTransparent=!0,dt.enableParticle=!0,dt.enableAnimatorUpdate=!0,dt.enablePhysicsUpdate=!0,dt.enablemsaa=!0,dt.enableOpaque=!0,window.Stat=dt,e.BufferTargetType=void 0,(Je=e.BufferTargetType||(e.BufferTargetType={}))[Je.ARRAY_BUFFER=0]="ARRAY_BUFFER",Je[Je.ELEMENT_ARRAY_BUFFER=1]="ELEMENT_ARRAY_BUFFER",Je[Je.UNIFORM_BUFFER=2]="UNIFORM_BUFFER",Je[Je.COPY_READ_BUFFER=3]="COPY_READ_BUFFER",Je[Je.COPY_WRITE_BUFFER=4]="COPY_WRITE_BUFFER",Je[Je.TRANSFORM_FEEDBACK_BUFFER=5]="TRANSFORM_FEEDBACK_BUFFER",e.BufferUsage=void 0,(et=e.BufferUsage||(e.BufferUsage={}))[et.Static=0]="Static",et[et.Dynamic=1]="Dynamic",et[et.Stream=2]="Stream",e.DrawType=void 0,(tt=e.DrawType||(e.DrawType={}))[tt.DrawArray=0]="DrawArray",tt[tt.DrawArrayInstance=1]="DrawArrayInstance",tt[tt.DrawElement=2]="DrawElement",tt[tt.DrawElementInstance=3]="DrawElementInstance",e.IndexFormat=void 0,(it=e.IndexFormat||(e.IndexFormat={}))[it.UInt8=0]="UInt8",it[it.UInt16=1]="UInt16",it[it.UInt32=2]="UInt32",e.MeshTopology=void 0,(rt=e.MeshTopology||(e.MeshTopology={}))[rt.Points=0]="Points",rt[rt.Lines=1]="Lines",rt[rt.LineLoop=2]="LineLoop",rt[rt.LineStrip=3]="LineStrip",rt[rt.Triangles=4]="Triangles",rt[rt.TriangleStrip=5]="TriangleStrip",rt[rt.TriangleFan=6]="TriangleFan";const ct=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];class _t{static restoreTempArray(){ct[0]=1,ct[1]=0,ct[4]=0,ct[5]=1,ct[12]=0,ct[13]=0}static clear(){_t.worldAlpha=1}}_t.worldMatrix4=ct,_t.worldMatrix=new V,_t.matWVP=null,_t.worldAlpha=1,_t.worldScissorTest=!1,_t.width=0,_t.height=0,_t.InvertY=!1;class pt{}pt.curRT=null;class gt{constructor(e=null){this._renderTexture=null,this._renderTexture=e}}class mt extends gt{constructor(e=null){super(e),this._lastRT=null,mt.rendercontext2D||(mt.rendercontext2D=g.render2DRenderPassFactory.createRenderContext2D()),this._renderElement=g.render2DRenderPassFactory.createRenderElement2D(),this._renderElement.nodeCommonMap=["Sprite2D"]}clone(e){return new mt(e)}_createMesh(t){let i=g.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement),r=g.renderDeviceFactory.createBufferState();i.bufferState=r;let s=g.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Dynamic);s.vertexDeclaration=t;let a=g.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Dynamic);return r.applyState([s],a),i.indexFormat=e.IndexFormat.UInt16,i}getGeo(e){let t=mt._geoMap[e.id];return null==t&&(t=this._createMesh(e),mt._geoMap[e.id]=t),t}renderStart(e,t){this._lastRT=pt.curRT,this._renderTexture?(mt.rendercontext2D.invertY=this._renderTexture._invertY,mt.rendercontext2D.setRenderTarget(this._renderTexture._renderTarget,e,t),pt.curRT=this._renderTexture):(mt.rendercontext2D.invertY=!1,mt.rendercontext2D.setOffscreenView(_t.width,_t.height),pt.curRT||mt.rendercontext2D.setRenderTarget(null,e,t)),pe._clear=!1}drawElement(e){mt.rendercontext2D.drawRenderElementOne(e)}draw(e,t,i,r,s,a,n){dt.draw2D++;let o=this.getGeo(e.vertexDeclarition),h=o.bufferState,l=h._vertexBuffers[0],u=h._bindedIndexBuffer;l.setDataLength(i),l.setData(e.vbBuffer,t,0,i),u._setIndexDataLength(s),u._setIndexData(new Uint16Array(e.ibBuffer,r,s/2),0),o.clearRenderParams(),o.setDrawElemenParams(s/2,0);let d=n;this._renderElement.geometry=o,this._renderElement.value2DShaderData=a.shaderData,d?(this._renderElement.subShader=d._shader.getSubShaderAt(0),this._renderElement.materialShaderData=d.shaderData):(this._renderElement.subShader=a._defaultShader.getSubShaderAt(0),this._renderElement.materialShaderData=null),mt.rendercontext2D.drawRenderElementOne(this._renderElement)}renderEnd(){let e=this._lastRT?this._lastRT._renderTarget:null;mt.rendercontext2D.invertY=!1,mt.rendercontext2D.setRenderTarget(e,!1,m.BLACK),pt.curRT=this._lastRT,this._lastRT=null}}mt._geoMap={};class ft{constructor(){this.elements=[],this.length=0}_add(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}add(e){let t=this.elements.indexOf(e);"number"!=typeof e&&-1!=t&&t<this.length||(this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e,this.length++)}indexof(e){let t=this.elements.indexOf(e);return-1!=t&&t<this.length?t:-1}remove(e){let t=this.elements.indexOf(e);-1!=t&&t<this.length&&(this.elements[t]=this.elements[this.length-1],this.elements[this.length-1]=null,this.length--)}clear(){this.elements=[],this.length=0}clean(){this.elements.length=this.length}cloneTo(e){e.length=this.length,e.elements=this.elements.slice()}destroy(){this.elements=null}}class Tt extends ft{add(e){this._add(e),this.length++}}class yt{constructor(){this.batchFun=null,this.batch=!1,this.indexStart=-1,this.elementLenth=0}static create(){return 0!=this._pool.length?this._pool.pop():new yt}static recover(e){this._pool.push(e)}}yt._pool=[];class xt{static regisBatch(e,t){if(xt._batchMapManager[e])throw"Overlapping batch optimization";xt._batchMapManager[e]=t}get list(){return this._list}set list(e){this._list=e}constructor(){this._lastRenderNodeType=-1,this._renderEnd=!0,this.list=new Tt,this._renderElementList=new Tt,this._batchInfoList=new Tt}addRenderObject(e){this.list.add(e)}removeRenderObject(e){this.list.remove(e)}clearList(){this._list.clear(),this._renderElementList.clear();for(var e=0,t=this._batchInfoList.length;e<t;e++){let t=this._batchInfoList.elements[e];t.batch&&t.batchFun.recover(),yt.recover(t)}this._batchInfoList.clear()}renderUpdate(){var e=mt.rendercontext2D;let t=this._list.elements;for(let i=0,r=this._list.length;i<r;i++){let r=t[i];r.renderUpdate&&r._renderUpdateMask!=dt.loopCount&&(r.renderUpdate(e),r._renderUpdateMask=dt.loopCount)}}render(e){this.renderUpdate();for(var t=0,i=this._list.length;t<i;t++)this._cull(this._list.elements[t],e);this._batch(),e.drawRenderElementList(this._renderElementList),this.endRender()}_cull(e,t){{e.preRenderUpdate&&e.preRenderUpdate(t);let r=e._renderElements.length;if(1==r)this._batchStart(e._renderType,1),this._renderElementList.add(e._renderElements[0]);else{this._batchStart(e._renderType,r);for(var i=0;i<r;i++)this._renderElementList.add(e._renderElements[i])}}}_batch(){this._batchInfoList.add(this._lastbatch2DInfo),this._renderElementList.length=0;for(var e=0,t=this._batchInfoList.length;e<t;e++){let t=this._batchInfoList.elements[e];if(t.batch)t.batchFun.batchRenderElement(this._renderElementList,t.indexStart,t.elementLenth);else for(let e=t.indexStart,i=t.elementLenth+t.indexStart;e<i;e++)this._renderElementList.add(this._renderElementList.elements[e])}}_batchStart(e,t){if(-1==this._lastRenderNodeType)return this._lastbatch2DInfo=yt.create(),this._lastbatch2DInfo.batch=!1,this._lastbatch2DInfo.batchFun=xt._batchMapManager[e],this._lastbatch2DInfo.indexStart=0,this._lastbatch2DInfo.elementLenth=t,void(this._lastRenderNodeType=e);this._lastRenderNodeType==e?(this._lastbatch2DInfo.batch=!!this._lastbatch2DInfo.batchFun,this._lastbatch2DInfo.elementLenth+=t):(this._batchInfoList.add(this._lastbatch2DInfo),this._lastbatch2DInfo=yt.create(),this._lastbatch2DInfo.batch=!1,this._lastbatch2DInfo.batchFun=xt._batchMapManager[e],this._lastbatch2DInfo.indexStart=this._renderElementList.length,this._lastbatch2DInfo.elementLenth=t,this._lastRenderNodeType=e)}endRender(){this.clearList(),this._renderEnd=!0,this._lastRenderNodeType=-1}}var vt,St,Dt,Et,wt,Rt,Ct;xt._batchMapManager={},e.BlendEquationSeparate=void 0,(vt=e.BlendEquationSeparate||(e.BlendEquationSeparate={}))[vt.ADD=0]="ADD",vt[vt.SUBTRACT=1]="SUBTRACT",vt[vt.REVERSE_SUBTRACT=2]="REVERSE_SUBTRACT",vt[vt.MIN=3]="MIN",vt[vt.MAX=4]="MAX",e.BlendFactor=void 0,(St=e.BlendFactor||(e.BlendFactor={}))[St.Zero=0]="Zero",St[St.One=1]="One",St[St.SourceColor=2]="SourceColor",St[St.OneMinusSourceColor=3]="OneMinusSourceColor",St[St.DestinationColor=4]="DestinationColor",St[St.OneMinusDestinationColor=5]="OneMinusDestinationColor",St[St.SourceAlpha=6]="SourceAlpha",St[St.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",St[St.DestinationAlpha=8]="DestinationAlpha",St[St.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",St[St.SourceAlphaSaturate=10]="SourceAlphaSaturate",St[St.BlendColor=11]="BlendColor",St[St.OneMinusBlendColor=12]="OneMinusBlendColor",e.BlendType=void 0,(Dt=e.BlendType||(e.BlendType={}))[Dt.BLEND_DISABLE=0]="BLEND_DISABLE",Dt[Dt.BLEND_ENABLE_ALL=1]="BLEND_ENABLE_ALL",Dt[Dt.BLEND_ENABLE_SEPERATE=2]="BLEND_ENABLE_SEPERATE",e.CompareFunction=void 0,(Et=e.CompareFunction||(e.CompareFunction={}))[Et.Never=0]="Never",Et[Et.Less=1]="Less",Et[Et.Equal=2]="Equal",Et[Et.LessEqual=3]="LessEqual",Et[Et.Greater=4]="Greater",Et[Et.NotEqual=5]="NotEqual",Et[Et.GreaterEqual=6]="GreaterEqual",Et[Et.Always=7]="Always",Et[Et.Off=8]="Off",e.CullMode=void 0,(wt=e.CullMode||(e.CullMode={}))[wt.Off=0]="Off",wt[wt.Front=1]="Front",wt[wt.Back=2]="Back",e.FrontFace=void 0,(Rt=e.FrontFace||(e.FrontFace={}))[Rt.CW=0]="CW",Rt[Rt.CCW=1]="CCW",e.StencilOperation=void 0,(Ct=e.StencilOperation||(e.StencilOperation={}))[Ct.Keep=0]="Keep",Ct[Ct.Zero=1]="Zero",Ct[Ct.Replace=2]="Replace",Ct[Ct.IncrementSaturate=3]="IncrementSaturate",Ct[Ct.DecrementSaturate=4]="DecrementSaturate",Ct[Ct.Invert=5]="Invert",Ct[Ct.IncrementWrap=6]="IncrementWrap",Ct[Ct.DecrementWrap=7]="DecrementWrap";class At{get cull(){return this._cull}set cull(e){this._cull=e}get blend(){return this._blend}set blend(e){this._blend=e}get srcBlend(){return this._srcBlend}set srcBlend(e){this._srcBlend=e}get dstBlend(){return this._dstBlend}set dstBlend(e){this._dstBlend=e}get srcBlendRGB(){return this._srcBlendRGB}set srcBlendRGB(e){this._srcBlendRGB=e}get dstBlendRGB(){return this._dstBlendRGB}set dstBlendRGB(e){this._dstBlendRGB=e}get srcBlendAlpha(){return this._srcBlendAlpha}set srcBlendAlpha(e){this._srcBlendAlpha=e}get dstBlendAlpha(){return this._dstBlendAlpha}set dstBlendAlpha(e){this._dstBlendAlpha=e}get blendEquation(){return this._blendEquation}set blendEquation(e){this._blendEquation=e}get blendEquationRGB(){return this._blendEquationRGB}set blendEquationRGB(e){this._blendEquationRGB=e}get blendEquationAlpha(){return this._blendEquationAlpha}set blendEquationAlpha(e){this._blendEquationAlpha=e}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest=e}get depthWrite(){return this._depthWrite}set depthWrite(e){this._depthWrite=e}get stencilWrite(){return this._stencilWrite}set stencilWrite(e){this._stencilWrite=e}get stencilTest(){return this._stencilTest}set stencilTest(e){this._stencilTest=e}get stencilRef(){return this._stencilRef}set stencilRef(e){this._stencilRef=e}get stencilOp(){return this._stencilOp}set stencilOp(e){this._stencilOp=e}createObj(){}constructor(){this._stencilOp=new a,this.createObj(),this.cull=At.CULL_BACK,this.blend=At.BLEND_DISABLE,this.srcBlend=At.BLENDPARAM_ONE,this.dstBlend=At.BLENDPARAM_ZERO,this.srcBlendRGB=At.BLENDPARAM_ONE,this.dstBlendRGB=At.BLENDPARAM_ZERO,this.srcBlendAlpha=At.BLENDPARAM_ONE,this.dstBlendAlpha=At.BLENDPARAM_ZERO,this.blendEquation=At.BLENDEQUATION_ADD,this.blendEquationRGB=At.BLENDEQUATION_ADD,this.blendEquationAlpha=At.BLENDEQUATION_ADD,this.depthTest=At.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=At.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new a(At.STENCILOP_KEEP,At.STENCILOP_KEEP,At.STENCILOP_REPLACE)}setNull(){this.cull=null,this.blend=null,this.srcBlend=null,this.dstBlend=null,this.srcBlendRGB=null,this.dstBlendRGB=null,this.srcBlendAlpha=null,this.dstBlendAlpha=null,this.blendEquation=null,this.blendEquationRGB=null,this.blendEquationAlpha=null,this.depthTest=null,this.depthWrite=null,this.stencilRef=null,this.stencilTest=null,this.stencilWrite=null,this.stencilOp.set(null,null,null)}cloneTo(e){e.cull=this.cull,e.blend=this.blend,e.srcBlend=this.srcBlend,e.dstBlend=this.dstBlend,e.srcBlendRGB=this.srcBlendRGB,e.dstBlendRGB=this.dstBlendRGB,e.srcBlendAlpha=this.srcBlendAlpha,e.dstBlendAlpha=this.dstBlendAlpha,e.blendEquation=this.blendEquation,e.blendEquationRGB=this.blendEquationRGB,e.blendEquationAlpha=this.blendEquationAlpha,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.stencilRef=this.stencilRef,e.stencilTest=this.stencilTest,e.stencilWrite=this.stencilWrite,this.stencilOp.cloneTo(e.stencilOp)}clone(){var e=new At;return this.cloneTo(e),e}}At.CULL_NONE=e.CullMode.Off,At.CULL_FRONT=e.CullMode.Front,At.CULL_BACK=e.CullMode.Back,At.BLEND_DISABLE=e.BlendType.BLEND_DISABLE,At.BLEND_ENABLE_ALL=e.BlendType.BLEND_ENABLE_ALL,At.BLEND_ENABLE_SEPERATE=e.BlendType.BLEND_ENABLE_SEPERATE,At.BLENDPARAM_ZERO=e.BlendFactor.Zero,At.BLENDPARAM_ONE=e.BlendFactor.One,At.BLENDPARAM_SRC_COLOR=e.BlendFactor.SourceColor,At.BLENDPARAM_ONE_MINUS_SRC_COLOR=e.BlendFactor.OneMinusSourceColor,At.BLENDPARAM_DST_COLOR=e.BlendFactor.DestinationColor,At.BLENDPARAM_ONE_MINUS_DST_COLOR=e.BlendFactor.OneMinusDestinationColor,At.BLENDPARAM_SRC_ALPHA=e.BlendFactor.SourceAlpha,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA=e.BlendFactor.OneMinusSourceAlpha,At.BLENDPARAM_DST_ALPHA=e.BlendFactor.DestinationAlpha,At.BLENDPARAM_ONE_MINUS_DST_ALPHA=e.BlendFactor.OneMinusDestinationAlpha,At.BLENDPARAM_SRC_ALPHA_SATURATE=e.BlendFactor.SourceAlphaSaturate,At.BLENDPARAM_BLENDCOLOR=e.BlendFactor.BlendColor,At.BLENDPARAM_BLEND_ONEMINUS_COLOR=e.BlendFactor.OneMinusBlendColor,At.BLENDEQUATION_ADD=e.BlendEquationSeparate.ADD,At.BLENDEQUATION_SUBTRACT=e.BlendEquationSeparate.SUBTRACT,At.BLENDEQUATION_REVERSE_SUBTRACT=e.BlendEquationSeparate.REVERSE_SUBTRACT,At.BLENDEQUATION_MIN=e.BlendEquationSeparate.MIN,At.BLENDEQUATION_MAX=e.BlendEquationSeparate.MAX,At.DEPTHTEST_OFF=e.CompareFunction.Off,At.DEPTHTEST_NEVER=e.CompareFunction.Never,At.DEPTHTEST_LESS=e.CompareFunction.Less,At.DEPTHTEST_EQUAL=e.CompareFunction.Equal,At.DEPTHTEST_LEQUAL=e.CompareFunction.LessEqual,At.DEPTHTEST_GREATER=e.CompareFunction.Greater,At.DEPTHTEST_NOTEQUAL=e.CompareFunction.NotEqual,At.DEPTHTEST_GEQUAL=e.CompareFunction.GreaterEqual,At.DEPTHTEST_ALWAYS=e.CompareFunction.Always,At.STENCILTEST_OFF=e.CompareFunction.Off,At.STENCILTEST_NEVER=e.CompareFunction.Never,At.STENCILTEST_LESS=e.CompareFunction.Less,At.STENCILTEST_EQUAL=e.CompareFunction.Equal,At.STENCILTEST_LEQUAL=e.CompareFunction.LessEqual,At.STENCILTEST_GREATER=e.CompareFunction.Greater,At.STENCILTEST_NOTEQUAL=e.CompareFunction.NotEqual,At.STENCILTEST_GEQUAL=e.CompareFunction.GreaterEqual,At.STENCILTEST_ALWAYS=e.CompareFunction.Always,At.STENCILOP_KEEP=e.StencilOperation.Keep,At.STENCILOP_ZERO=e.StencilOperation.Zero,At.STENCILOP_REPLACE=e.StencilOperation.Replace,At.STENCILOP_INCR=e.StencilOperation.IncrementSaturate,At.STENCILOP_INCR_WRAP=e.StencilOperation.IncrementWrap,At.STENCILOP_DECR=e.StencilOperation.DecrementSaturate,At.STENCILOP_DECR_WRAP=e.StencilOperation.DecrementWrap,At.STENCILOP_INVERT=e.StencilOperation.Invert,At.Default=new At;class Mt{static splitToWords(e,t){for(var i,r,s=[],a=-1,n=0,o=e.length;n<o;n++)if(i=e.charAt(n)," \t=+-*/&%!<>()'\",;".indexOf(i)>=0){if(a>=0&&n-a>1&&(r=e.substr(a,n-a),s.push(r)),'"'==i||"'"==i){var h=e.indexOf(i,n+1);if(h<0)throw"Sharder err:"+e;s.push(e.substr(n+1,h-n-1)),n=h,a=-1;continue}"("==i&&t&&s.length>0&&(r=s[s.length-1]+";","vec4;main;".indexOf(r)<0&&(t.useFuns+=r)),a=-1}else a<0&&(a=n);return a<o&&o-a>1&&(r=e.substr(a,o-a),s.push(r)),s}constructor(e){this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=e;for(var t,i,r=0;!((r=e.indexOf("#begin",r))<0);){for(i=r+5;!((i=e.indexOf("#end",i))<0)&&"i"===e.charAt(i+4);)i+=5;if(i<0)throw"add include err,no #end:"+e;t=e.indexOf("\n",r);var s=Mt.splitToWords(e.substr(r,t-r),null);"code"==s[1]?this.codes[s[2]]=e.substr(t+1,i-t-1):"function"==s[1]&&(t=e.indexOf("function",r),t+=8,this.funs[s[3]]=e.substr(t+1,i-t-1),this.funnames+=s[3]+";"),r=i+1}}getWith(e=null){var t=e?this.codes[e]:this.script;if(!t)throw"get with error:"+e;return t}getFunsScript(e){var t="";for(var i in this.funs)e.indexOf(i+";")>=0&&(t+=this.funs[i]);return t}}class bt{constructor(e){this.childs=[],this.text="",this.useFuns="",this.z=0,this.includefiles=e}setParent(e){e.childs.push(this),this.z=e.z+1,this.parent=e}setCondition(e,t){e&&(this.conditionType=t,e=e.replace(/(\s*$)/g,""),this.condition=function(){return this[e]},this.condition.__condition=e)}toscript(e,t){return this._toscript(e,t,++bt.__id)}_toscript(e,t,i){if(this.childs.length<1&&!this.text)return t;if(t.length,this.condition){var r=!!this.condition.call(e);if(2===this.conditionType&&(r=!r),!r&&bt.__noCompileEnable)return t}if(!this.noCompile&&bt.__noCompileEnable||this.text&&t.push(this.text),this.childs.length>0&&this.childs.forEach((function(r,s,a){r._toscript(e,t,i)})),this.includefiles.length>0&&this.useFuns.length>0)for(var s,a=0,n=this.includefiles.length;a<n;a++)this.includefiles[a].curUseID!=i&&(s=this.includefiles[a].file.getFunsScript(this.useFuns)).length>0&&(this.includefiles[a].curUseID=i,t[0]=s+t[0]);return t}}bt.__id=1,bt.__noCompileEnable=!0;const It=new RegExp("\r","g"),Bt=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g"),Lt={Back:e.CullMode.Back,Front:e.CullMode.Front,Off:e.CullMode.Off},Pt={Disable:e.BlendType.BLEND_DISABLE,All:e.BlendType.BLEND_ENABLE_ALL,Seperate:e.BlendType.BLEND_ENABLE_SEPERATE},Nt={Zero:e.BlendFactor.Zero,One:e.BlendFactor.One,SourceColor:e.BlendFactor.SourceColor,OneMinusSourceColor:e.BlendFactor.OneMinusSourceColor,DestinationColor:e.BlendFactor.DestinationColor,OneMinusDestinationColor:e.BlendFactor.OneMinusDestinationColor,SourceAlpha:e.BlendFactor.SourceAlpha,OneMinusSourceAlpha:e.BlendFactor.OneMinusSourceAlpha,DestinationAlpha:e.BlendFactor.DestinationAlpha,OneMinusDestinationAlpha:e.BlendFactor.OneMinusDestinationAlpha,SourceAlphaSaturate:e.BlendFactor.SourceAlphaSaturate,BlendColor:e.BlendFactor.BlendColor,OneMinusBlendColor:e.BlendFactor.OneMinusBlendColor},Ot={Add:e.BlendEquationSeparate.ADD,Subtract:e.BlendEquationSeparate.SUBTRACT,Reverse_substract:e.BlendEquationSeparate.REVERSE_SUBTRACT,Min:e.BlendEquationSeparate.MIN,Max:e.BlendEquationSeparate.MAX},Ft={Never:e.CompareFunction.Never,Less:e.CompareFunction.Less,Equal:e.CompareFunction.Equal,LessEqual:e.CompareFunction.LessEqual,Greater:e.CompareFunction.Greater,NotEqual:e.CompareFunction.NotEqual,GreaterEqual:e.CompareFunction.GreaterEqual,Always:e.CompareFunction.Always,Off:e.CompareFunction.Off},Ut={Keep:e.StencilOperation.Keep,Zero:e.StencilOperation.Zero,Replace:e.StencilOperation.Replace,IncrementSaturate:e.StencilOperation.IncrementSaturate,DecrementSaturate:e.StencilOperation.DecrementSaturate,Invert:e.StencilOperation.Invert,IncrementWrap:e.StencilOperation.IncrementWrap,DecrementWrap:e.StencilOperation.DecrementWrap};class kt{static addInclude(e,t,i){if(!t||0===t.length)return console.error("shader include file err:"+e),null;if(!i&&kt.includes[e])return console.warn("shader include file already exists:"+e),kt.includes[e];t=t.replace(It,"");let r=new Mt(t);return kt.includes[e]=r,r}static compile(e,t,i){let r={vsNode:new bt([]),psNode:new bt([]),includeNames:new Set,defs:new Set},s=[];e=e.replace(It,""),t=t.replace(It,""),kt._compileToTree(r.vsNode,e,r.defs,s,i),kt._compileToTree(r.psNode,t,r.defs,s,i);for(let e of s)e.file?r.includeNames.add(e.name):console.warn(`ShaderCompile missing file ${e.name}`);return r}static compileAsync(e,t,i){let r={vsNode:new bt([]),psNode:new bt([]),includeNames:new Set,defs:new Set},s=[];return e=e.replace(It,""),t=t.replace(It,""),kt._compileToTree(r.vsNode,e,r.defs,s,i),kt._compileToTree(r.psNode,t,r.defs,s,i),this._loadIncludesDeep(r,s,0)}static _loadIncludesDeep(e,t,i){let r,s=t.length;for(let a=i;a<s;a++){let i=t[a];i.file?e.includeNames.add(i.name):(r||(r=[]),r.push(i))}return r?h.loader.load(r.map((e=>e.name))).then((i=>{let a=r.length;for(let s=0;s<a;s++){let a=r[s],n=i[s];if(n){e.includeNames.add(a.name);let i=n.getWith(a.codeName);a.node.condition?a.node.text=i:(kt._compileToTree(a.node,i,e.defs,t,k.getPath(a.name)),a.node.text="")}else{let e=a.node.parent.childs;e.splice(e.indexOf(a.node),1)}}return t.length>s?kt._loadIncludesDeep(e,t,s):e})):Promise.resolve(e)}static _compileToTree(e,t,i,r,s){let a,n,o,h,l,u,d,c,_,p,g=t.split("\n");for(c=0;c<g.length;c++)if(o=g[c],!(o.length<1)&&(u=o.indexOf("//"),0!==u))if(u>=0&&(o=o.substr(0,u)),(u=o.indexOf("#"))<0){n=e.childs[e.childs.length-1];let t=e.includefiles;if(n&&!n.name){t.length>0&&Mt.splitToWords(o,n),n.text+="\n"+o;continue}a=new bt(t),a.text=o,a.noCompile=!0,t.length>0&&Mt.splitToWords(o,a),a.setParent(e)}else{for(a=new bt(e.includefiles),a.text=o,a.noCompile=!0,h="#",p=u+1,_=o.length;p<_;p++){let e=o.charAt(p);if(" "===e||"\t"===e||"?"===e)break;h+=e}switch(a.name=h,h){case"#ifdef":case"#ifndef":for(a.src=o,a.noCompile=null!=o.match(/[!&|()=<>]/),a.noCompile?console.log("function():Boolean{return "+o.substr(u+a.name.length)+"}"):(d=o.replace(/^\s*/,"").split(/\s+/),a.setCondition(d[1],"#ifdef"===h?kt.IFDEF_YES:kt.IFDEF_ELSE),a.text=a.text),a.setParent(e),e=a,d=o.substr(p).split(Bt),p=0;p<d.length;p++)o=d[p],o.length&&i.add(o);break;case"#if":case"#elif":for(a.src=o,a.noCompile=!0,"#elif"==h&&(n=(e=e.parent).childs[e.childs.length-1],n.text=n.src,n.noCompile=!0,n.condition=null),a.setParent(e),e=a,d=o.substr(p).split(Bt),p=0;p<d.length;p++)o=d[p],o.length&&"defined"!=o&&i.add(o);break;case"#else":a.src=o,n=(e=e.parent).childs[e.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.condition=n.condition,a.conditionType=n.conditionType==kt.IFDEF_YES?kt.IFDEF_ELSE:kt.IFDEF_YES),a.setParent(e),e=a;break;case"#endif":n=(e=e.parent).childs[e.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.text=a.text),a.setParent(e);break;case"#include":d=Mt.splitToWords(o,null);let t,c=d[1];c.startsWith(".")?c=k.join(s,c):c.startsWith("/")?c=k.formatURL(c.substring(1)):(t=kt.includes[c],t||(c="internal/"+c)),t=kt.includes[c],!t&&kt.loadIncludeFileSync&&(kt.loadIncludeFileSync(c),t=kt.includes[c]);let _="with"==d[2]?d[3]:null;r.push({name:c,codeName:_,node:a,file:t}),a.setParent(e),(u=d[0].indexOf("?"))<0?(t&&(o=t.getWith(_),this._compileToTree(a,o,i,r,k.getPath(c))),a.text=""):(a.setCondition(d[0].substr(u+1),kt.IFDEF_YES),t&&(a.text=t.getWith(_)));break;case"#import":d=Mt.splitToWords(o,null),l=d[1],a.includefiles.push({node:a,file:kt.includes[l],ofs:a.text.length});break;default:a.setParent(e)}}}static getRenderState(e,t){if(!e)return;t.cull=Lt[e.cull],t.blend=Pt[e.blend],t.srcBlend=Nt[e.srcBlend],t.dstBlend=Nt[e.dstBlend],t.srcBlendRGB=Nt[e.srcBlendRGB],t.dstBlendRGB=Nt[e.dstBlendRGB],t.srcBlendAlpha=Nt[e.srcBlendAlpha],t.dstBlendAlpha=Nt[e.dstBlendAlpha],t.blendEquation=Ot[e.blendEquation],t.blendEquationRGB=Ot[e.blendEquationRGB],t.blendEquationAlpha=Ot[e.blendEquationAlpha],t.depthTest=Ft[e.depthTest],t.depthWrite=e.depthWrite,t.stencilRef=e.stencilRef,t.stencilTest=Ft[e.stencilTest],t.stencilWrite=e.stencilWrite;let i=e.stencilOp,r=i?i[0]:null,s=i?i[1]:null,a=i?i[2]:null;t.stencilOp.x=Ut[r],t.stencilOp.y=Ut[s],t.stencilOp.z=Ut[a]}}kt.IFDEF_NO=0,kt.IFDEF_YES=1,kt.IFDEF_ELSE=2,kt.IFDEF_PARENT=3,kt.includes={};class Gt{constructor(e=0,t=0){this.x=e,this.y=t}setValue(e,t){return this.x=e,this.y=t,this}static scale(e,t,i){i.x=e.x*t,i.y=e.y*t}static equals(e,t){return r.nearEqual(e.x,t.x)&&r.nearEqual(e.y,t.y)}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1]}toArray(){return[this.x,this.y]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y}cloneTo(e){return e.x=this.x,e.y=this.y,e}static dot(e,t){return e.x*t.x+e.y*t.y}static normalize(e,t){var i=e.x,r=e.y,s=i*i+r*r;s>0&&(s=1/Math.sqrt(s),t.x=i*s,t.y=r*s)}static scalarLength(e){var t=e.x,i=e.y;return Math.sqrt(t*t+i*i)}static distance(e,t){let i=e.x-t.x,r=e.y-t.y;return Math.sqrt(i*i+r*r)}clone(){var e=new Gt;return this.cloneTo(e),e}}Gt.ZERO=new Gt(0,0),Gt.ONE=new Gt(1,1),Gt.TEMP=new Gt;const Vt=new Float32Array([1,0,0,0,1,0,0,0,1]);class zt{static createRotationQuaternion(e,t){var i=e.x,r=e.y,s=e.z,a=e.w,n=i*i,o=r*r,h=s*s,l=i*r,u=s*a,d=s*i,c=r*a,_=r*s,p=i*a,g=t.elements;g[0]=1-2*(o+h),g[1]=2*(l+u),g[2]=2*(d-c),g[3]=2*(l-u),g[4]=1-2*(h+n),g[5]=2*(_+p),g[6]=2*(d+c),g[7]=2*(_-p),g[8]=1-2*(o+n)}static createFromTranslation(e,t){var i=t.elements;i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=1,i[5]=0,i[6]=e.x,i[7]=e.y,i[8]=1}static createMatrixFromValue(e,t,i=Gt.ONE,r){var s=r.elements,a=Math.sin(t),n=Math.cos(t);s[0]=n*i.x,s[1]=a*i.x,s[2]=0,s[3]=-a*i.y,s[4]=n*i.y,s[5]=0,s[6]=e.x,s[7]=e.y,s[8]=1}static createFromRotation(e,t){var i=t.elements,r=Math.sin(e),s=Math.cos(e);i[0]=s,i[1]=r,i[2]=0,i[3]=-r,i[4]=s,i[5]=0,i[6]=0,i[7]=0,i[8]=1}static createFromScaling(e,t){var i=t.elements;i[0]=e.x,i[1]=0,i[2]=0,i[3]=0,i[4]=e.y,i[5]=0,i[6]=0,i[7]=0,i[8]=e.z}static createFromMatrix4x4(e,t){var i=e.elements,r=t.elements;r[0]=i[0],r[1]=i[1],r[2]=i[2],r[3]=i[4],r[4]=i[5],r[5]=i[6],r[6]=i[8],r[7]=i[9],r[8]=i[10]}static multiply(e,t,i){var r=e.elements,s=t.elements,a=i.elements,n=r[0],o=r[1],h=r[2],l=r[3],u=r[4],d=r[5],c=r[6],_=r[7],p=r[8],g=s[0],m=s[1],f=s[2],T=s[3],y=s[4],x=s[5],v=s[6],S=s[7],D=s[8];a[0]=g*n+m*l+f*c,a[1]=g*o+m*u+f*S,a[2]=g*h+m*d+f*p,a[3]=T*n+y*l+x*c,a[4]=T*o+y*u+x*_,a[5]=T*h+y*d+x*p,a[6]=v*n+S*l+D*c,a[7]=v*o+S*u+D*_,a[8]=v*h+S*d+D*p}constructor(e=!0){e&&(this.elements=Vt.slice())}cloneByArray(e){this.elements.set(e)}determinant(){var e=this.elements,t=e[0],i=e[1],r=e[2],s=e[3],a=e[4],n=e[5],o=e[6],h=e[7],l=e[8];return t*(l*a-n*h)+i*(-l*s+n*o)+r*(h*s-a*o)}translate(e,t){var i=t.elements,r=this.elements,s=r[0],a=r[1],n=r[2],o=r[3],h=r[4],l=r[5],u=r[6],d=r[7],c=r[8],_=e.x,p=e.y;i[0]=s,i[1]=a,i[2]=n,i[3]=o,i[4]=h,i[5]=l,i[6]=_*s+p*o+u,i[7]=_*a+p*h+d,i[8]=_*n+p*l+c}rotate(e,t){var i=t.elements,r=this.elements,s=r[0],a=r[1],n=r[2],o=r[3],h=r[4],l=r[5],u=r[6],d=r[7],c=r[8],_=Math.sin(e),p=Math.cos(e);i[0]=p*s+_*o,i[1]=p*a+_*h,i[2]=p*n+_*l,i[3]=p*o-_*s,i[4]=p*h-_*a,i[5]=p*l-_*n,i[6]=u,i[7]=d,i[8]=c}scale(e,t){var i=t.elements,r=this.elements,s=e.x,a=e.y;i[0]=s*r[0],i[1]=s*r[1],i[2]=s*r[2],i[3]=a*r[3],i[4]=a*r[4],i[5]=a*r[5],i[6]=r[6],i[7]=r[7],i[8]=r[8]}invert(e){var t=e.elements,i=this.elements,r=i[0],s=i[1],a=i[2],n=i[3],o=i[4],h=i[5],l=i[6],u=i[7],d=i[8],c=d*o-h*u,_=-d*n+h*l,p=u*n-o*l,g=r*c+s*_+a*p;g&&(g=1/g,t[0]=c*g,t[1]=(-d*s+a*u)*g,t[2]=(h*s-a*o)*g,t[3]=_*g,t[4]=(d*r-a*l)*g,t[5]=(-h*r+a*n)*g,t[6]=p*g,t[7]=(-u*r+s*l)*g,t[8]=(o*r-s*n)*g)}transpose(e){var t=e.elements,i=this.elements;if(e===this){var r=i[1],s=i[2],a=i[5];t[1]=i[3],t[2]=i[6],t[3]=r,t[5]=i[7],t[6]=s,t[7]=a}else t[0]=i[0],t[1]=i[3],t[2]=i[6],t[3]=i[1],t[4]=i[4],t[5]=i[7],t[6]=i[2],t[7]=i[5],t[8]=i[8]}identity(){this.elements.set(Vt)}cloneTo(e){var t,i;(t=this.elements)!==(i=e.elements)&&i.set(t)}clone(){var e=new zt(!1);return e.elements=this.elements.slice(),e}static lookAt(e,t,i,r){a.subtract(e,t,Ht),a.normalize(Ht,Ht),a.cross(i,Ht,Wt),a.normalize(Wt,Wt),a.cross(Ht,Wt,Yt);var s=Ht,n=Wt,o=Yt,h=r.elements;h[0]=n.x,h[3]=n.y,h[6]=n.z,h[1]=o.x,h[4]=o.y,h[7]=o.z,h[2]=s.x,h[5]=s.y,h[8]=s.z}static forwardLookAt(e,t,i,r){var s=Wt,a=Yt,n=Ht;t.vsub(e,n).normalize(),i.cross(n,s).normalize(),n.cross(s,a);var o=r.elements;o[0]=s.x,o[1]=s.y,o[2]=s.z,o[3]=a.x,o[4]=a.y,o[5]=a.z,o[6]=n.x,o[7]=n.y,o[8]=n.z}}zt.DEFAULT=new zt,zt.TEMP=new zt;const Ht=new a,Wt=new a,Yt=new a;class Xt{static createFromYawPitchRoll(e,t,i,r){var s=.5*i,a=.5*t,n=.5*e,o=Math.sin(s),h=Math.cos(s),l=Math.sin(a),u=Math.cos(a),d=Math.sin(n),c=Math.cos(n);r.x=c*l*h+d*u*o,r.y=d*u*h-c*l*o,r.z=c*u*o-d*l*h,r.w=c*u*h+d*l*o}static multiply(e,t,i){var r=e.x,s=e.y,a=e.z,n=e.w,o=t.x,h=t.y,l=t.z,u=t.w,d=s*l-a*h,c=a*o-r*l,_=r*h-s*o,p=r*o+s*h+a*l;i.x=r*u+o*n+d,i.y=s*u+h*n+c,i.z=a*u+l*n+_,i.w=n*u-p}static rotationAxisAngle(e,t,i){const r=a.TEMP;a.normalize(e,r),t*=.5;const s=Math.sin(t);i.x=r.x*s,i.y=r.y*s,i.z=r.z*s,i.w=Math.cos(t)}static arcTanAngle(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}static angleTo(e,t,i){a.subtract(t,e,qt),a.normalize(qt,qt),i.x=Math.asin(qt.y),i.y=Xt.arcTanAngle(-qt.z,-qt.x)}static createFromAxisAngle(e,t,i){t*=.5;var r=Math.sin(t);i.x=r*e.x,i.y=r*e.y,i.z=r*e.z,i.w=Math.cos(t)}static createFromMatrix4x4(e,t){var i,r,s=e.elements,a=s[0]+s[5]+s[10];a>0?(i=Math.sqrt(a+1),t.w=.5*i,i=.5/i,t.x=(s[6]-s[9])*i,t.y=(s[8]-s[2])*i,t.z=(s[1]-s[4])*i):s[0]>=s[5]&&s[0]>=s[10]?(r=.5/(i=Math.sqrt(1+s[0]-s[5]-s[10])),t.x=.5*i,t.y=(s[1]+s[4])*r,t.z=(s[2]+s[8])*r,t.w=(s[6]-s[9])*r):s[5]>s[10]?(r=.5/(i=Math.sqrt(1+s[5]-s[0]-s[10])),t.x=(s[4]+s[1])*r,t.y=.5*i,t.z=(s[9]+s[6])*r,t.w=(s[8]-s[2])*r):(r=.5/(i=Math.sqrt(1+s[10]-s[0]-s[5])),t.x=(s[8]+s[2])*r,t.y=(s[9]+s[6])*r,t.z=.5*i,t.w=(s[1]-s[4])*r)}static slerp(e,t,i,r){var s,a,n,o,h,l=e.x,u=e.y,d=e.z,c=e.w,_=t.x,p=t.y,g=t.z,m=t.w;return(a=l*_+u*p+d*g+c*m)<0&&(a=-a,_=-_,p=-p,g=-g,m=-m),1-a>1e-6?(s=Math.acos(a),n=Math.sin(s),o=Math.sin((1-i)*s)/n,h=Math.sin(i*s)/n):(o=1-i,h=i),r.x=o*l+h*_,r.y=o*u+h*p,r.z=o*d+h*g,r.w=o*c+h*m,r}static lerp(e,t,i,r){var s=1-i;Xt.dot(e,t)>=0?(r.x=s*e.x+i*t.x,r.y=s*e.y+i*t.y,r.z=s*e.z+i*t.z,r.w=s*e.w+i*t.w):(r.x=s*e.x-i*t.x,r.y=s*e.y-i*t.y,r.z=s*e.z-i*t.z,r.w=s*e.w-i*t.w),r.normalize(r)}static add(e,t,i){i.x=e.x+t.x,i.y=e.y+t.y,i.z=e.z+t.z,i.w=e.w+t.w}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}constructor(e=0,t=0,i=0,r=1){this.x=e,this.y=t,this.z=i,this.w=r}setValue(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r}set(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this}scaling(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}normalize(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(e,t){e*=.5;var i=Math.sin(e),r=Math.cos(e);t.x=this.x*r+this.w*i,t.y=this.y*r+this.z*i,t.z=this.z*r-this.y*i,t.w=this.w*r-this.x*i}rotateY(e,t){e*=.5;var i=Math.sin(e),r=Math.cos(e);t.x=this.x*r-this.z*i,t.y=this.y*r+this.w*i,t.z=this.z*r+this.x*i,t.w=this.w*r-this.y*i}rotateZ(e,t){e*=.5;var i=Math.sin(e),r=Math.cos(e);t.x=this.x*r+this.y*i,t.y=this.y*r-this.x*i,t.z=this.z*r+this.w*i,t.w=this.w*r-this.z*i}getYawPitchRoll(e){a.transformQuat(a.ForwardRH,this,jt);let t=Kt,i=$t;a.transformQuat(a.Up,this,t),Xt.angleTo(a.ZERO,jt,i),i.x==Math.PI/2?(i.y=Xt.arcTanAngle(t.z,t.x),i.z=0):i.x==-Math.PI/2?(i.y=Xt.arcTanAngle(-t.z,-t.x),i.z=0):(Zt.createRotationY(-i.y,Zt.TEMP),a.transformCoordinate(t,Zt.TEMP,t),Zt.createRotationX(-i.x,Zt.TEMP),a.transformCoordinate(t,Zt.TEMP,t),i.z=Xt.arcTanAngle(t.y,-t.x)),i.y<=-Math.PI&&(i.y=Math.PI),i.z<=-Math.PI&&(i.z=Math.PI),i.y>=Math.PI&&i.z>=Math.PI&&(i.y=0,i.z=0,i.x=Math.PI-i.x);var r=e;r.x=i.y,r.y=i.x,r.z=i.z}invert(e){var t=this.x,i=this.y,r=this.z,s=this.w,a=t*t+i*i+r*r+s*s,n=a?1/a:0;e.x=-t*n,e.y=-i*n,e.z=-r*n,e.w=s*n}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}cloneTo(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}clone(){var e=new Xt;return this.cloneTo(e),e}equals(e){return r.nearEqual(this.x,e.x)&&r.nearEqual(this.y,e.y)&&r.nearEqual(this.z,e.z)&&r.nearEqual(this.w,e.w)}static rotationLookAt(e,t,i){Xt.lookAt(a.ZERO,e,t,i)}static lookAt(e,t,i,r){zt.lookAt(e,t,i,zt.TEMP),Xt.rotationMatrix(zt.TEMP,r)}static forwardLookAt(e,t,i,r){zt.forwardLookAt(e,t,i,zt.TEMP),Xt.rotationMatrix(zt.TEMP,r)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(e,t){var i=e.lengthSquared();r.isZero(i)||(i=1/i,t.x=-e.x*i,t.y=-e.y*i,t.z=-e.z*i,t.w=e.w*i)}static rotationMatrix(e,t){var i,r,s=e.elements,a=s[0],n=s[1],o=s[2],h=s[3],l=s[4],u=s[5],d=s[6],c=s[7],_=s[8],p=a+l+_;p>0?(i=Math.sqrt(p+1),t.w=.5*i,i=.5/i,t.x=(u-c)*i,t.y=(d-o)*i,t.z=(n-h)*i):a>=l&&a>=_?(r=.5/(i=Math.sqrt(1+a-l-_)),t.x=.5*i,t.y=(n+h)*r,t.z=(o+d)*r,t.w=(u-c)*r):l>_?(r=.5/(i=Math.sqrt(1+l-a-_)),t.x=(h+n)*r,t.y=.5*i,t.z=(c+u)*r,t.w=(d-o)*r):(r=.5/(i=Math.sqrt(1+_-a-l)),t.x=(d+o)*r,t.y=(c+u)*r,t.z=.5*i,t.w=(n-h)*r)}}Xt.TEMP=new Xt,Xt.DEFAULT=new Xt,Xt.NAN=new Xt(NaN,NaN,NaN,NaN);const qt=new a,jt=new a,Kt=new a,$t=new a,Qt=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Zt{static createRotationX(e,t){var i=t.elements,r=Math.sin(e),s=Math.cos(e);i[1]=i[2]=i[3]=i[4]=i[7]=i[8]=i[11]=i[12]=i[13]=i[14]=0,i[0]=i[15]=1,i[5]=i[10]=s,i[6]=r,i[9]=-r}static createRotationY(e,t){var i=t.elements,r=Math.sin(e),s=Math.cos(e);i[1]=i[3]=i[4]=i[6]=i[7]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[5]=i[15]=1,i[0]=i[10]=s,i[2]=-r,i[8]=r}static createRotationZ(e,t){var i=t.elements,r=Math.sin(e),s=Math.cos(e);i[2]=i[3]=i[6]=i[7]=i[8]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[10]=i[15]=1,i[0]=i[5]=s,i[1]=r,i[4]=-r}static createRotationYawPitchRoll(e,t,i,r){Xt.createFromYawPitchRoll(e,t,i,Xt.TEMP),Zt.createRotationQuaternion(Xt.TEMP,r)}static createRotationAxis(e,t,i){var r=e.x,s=e.y,a=e.z,n=Math.cos(t),o=Math.sin(t),h=r*r,l=s*s,u=a*a,d=r*s,c=r*a,_=s*a,p=i.elements;p[3]=p[7]=p[11]=p[12]=p[13]=p[14]=0,p[15]=1,p[0]=h+n*(1-h),p[1]=d-n*d+o*a,p[2]=c-n*c-o*s,p[4]=d-n*d-o*a,p[5]=l+n*(1-l),p[6]=_-n*_+o*r,p[8]=c-n*c+o*s,p[9]=_-n*_-o*r,p[10]=u+n*(1-u)}static createRotationQuaternion(e,t){var i=t.elements,r=e.x,s=e.y,a=e.z,n=e.w,o=r*r,h=s*s,l=a*a,u=r*s,d=a*n,c=a*r,_=s*n,p=s*a,g=r*n;i[3]=i[7]=i[11]=i[12]=i[13]=i[14]=0,i[15]=1,i[0]=1-2*(h+l),i[1]=2*(u+d),i[2]=2*(c-_),i[4]=2*(u-d),i[5]=1-2*(l+o),i[6]=2*(p+g),i[8]=2*(c+_),i[9]=2*(p-g),i[10]=1-2*(h+o)}static createTranslate(e,t){var i=t.elements;i[4]=i[8]=i[1]=i[9]=i[2]=i[6]=i[3]=i[7]=i[11]=0,i[0]=i[5]=i[10]=i[15]=1,i[12]=e.x,i[13]=e.y,i[14]=e.z}static createScaling(e,t){var i=t.elements;i[0]=e.x,i[5]=e.y,i[10]=e.z,i[1]=i[4]=i[8]=i[12]=i[9]=i[13]=i[2]=i[6]=i[14]=i[3]=i[7]=i[11]=0,i[15]=1}static multiply(e,t,i){var r=t.elements,s=e.elements,a=i.elements,n=r[0],o=r[1],h=r[2],l=r[3],u=r[4],d=r[5],c=r[6],_=r[7],p=r[8],g=r[9],m=r[10],f=r[11],T=r[12],y=r[13],x=r[14],v=r[15],S=s[0],D=s[1],E=s[2],w=s[3],R=s[4],C=s[5],A=s[6],M=s[7],b=s[8],I=s[9],B=s[10],L=s[11],P=s[12],N=s[13],O=s[14],F=s[15];a[0]=n*S+o*R+h*b+l*P,a[1]=n*D+o*C+h*I+l*N,a[2]=n*E+o*A+h*B+l*O,a[3]=n*w+o*M+h*L+l*F,a[4]=u*S+d*R+c*b+_*P,a[5]=u*D+d*C+c*I+_*N,a[6]=u*E+d*A+c*B+_*O,a[7]=u*w+d*M+c*L+_*F,a[8]=p*S+g*R+m*b+f*P,a[9]=p*D+g*C+m*I+f*N,a[10]=p*E+g*A+m*B+f*O,a[11]=p*w+g*M+m*L+f*F,a[12]=T*S+y*R+x*b+v*P,a[13]=T*D+y*C+x*I+v*N,a[14]=T*E+y*A+x*B+v*O,a[15]=T*w+y*M+x*L+v*F}static createFromQuaternion(e,t){var i=t.elements,r=e.x,s=e.y,a=e.z,n=e.w,o=r+r,h=s+s,l=a+a,u=r*o,d=s*o,c=s*h,_=a*o,p=a*h,g=a*l,m=n*o,f=n*h,T=n*l;i[0]=1-c-g,i[1]=d+T,i[2]=_-f,i[3]=0,i[4]=d-T,i[5]=1-u-g,i[6]=p+m,i[7]=0,i[8]=_+f,i[9]=p-m,i[10]=1-u-c,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1}static createAffineTransformation(e,t,i,r){var s=r.elements,a=t.x,n=t.y,o=t.z,h=t.w,l=a+a,u=n+n,d=o+o,c=a*l,_=a*u,p=a*d,g=n*u,m=n*d,f=o*d,T=h*l,y=h*u,x=h*d,v=i.x,S=i.y,D=i.z;s[0]=(1-(g+f))*v,s[1]=(_+x)*v,s[2]=(p-y)*v,s[3]=0,s[4]=(_-x)*S,s[5]=(1-(c+f))*S,s[6]=(m+T)*S,s[7]=0,s[8]=(p+y)*D,s[9]=(m-T)*D,s[10]=(1-(c+g))*D,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1}static createLookAt(e,t,i,r){var s=r.elements,n=Jt,o=ei,h=ti;a.subtract(e,t,h),a.normalize(h,h),a.cross(i,h,n),a.normalize(n,n),a.cross(h,n,o),s[3]=s[7]=s[11]=0,s[15]=1,s[0]=n.x,s[4]=n.y,s[8]=n.z,s[1]=o.x,s[5]=o.y,s[9]=o.z,s[2]=h.x,s[6]=h.y,s[10]=h.z,s[12]=-a.dot(n,e),s[13]=-a.dot(o,e),s[14]=-a.dot(h,e)}static createPerspective(e,t,i,r,s){var a=1/Math.tan(.5*e),n=i/(a/t),o=i/a;Zt.createPerspectiveOffCenter(-n,n,-o,o,i,r,s)}static createPerspectiveOffCenter(e,t,i,r,s,a,n){var o=n.elements,h=a/(a-s);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[12]=o[13]=o[15]=0,o[0]=2*s/(t-e),o[5]=2*s/(r-i),o[8]=(e+t)/(t-e),o[9]=(r+i)/(r-i),o[10]=-h,o[11]=-1,o[14]=-s*h}static createOrthoOffCenter(e,t,i,r,s,a,n){var o=n.elements,h=1/(a-s);o[1]=o[2]=o[3]=o[4]=o[6]=o[8]=o[7]=o[9]=o[11]=0,o[15]=1,o[0]=2/(t-e),o[5]=2/(r-i),o[10]=-h,o[12]=(e+t)/(e-t),o[13]=(r+i)/(i-r),o[14]=-s*h}constructor(e=1,t=0,i=0,r=0,s=0,a=1,n=0,o=0,h=0,l=0,u=1,d=0,c=0,_=0,p=0,g=1,m=null){if(0!=arguments.length){if(1!==arguments.length||null!==arguments[0]){var f=this.elements=m||new Float32Array(16);f[0]=e,f[1]=t,f[2]=i,f[3]=r,f[4]=s,f[5]=a,f[6]=n,f[7]=o,f[8]=h,f[9]=l,f[10]=u,f[11]=d,f[12]=c,f[13]=_,f[14]=p,f[15]=g}}else this.elements=Qt.slice()}getElementByRowColumn(e,t){if(e<0||e>3)throw new Error("row for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}setElementByRowColumn(e,t,i){if(e<0||e>3)throw new Error("row for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=i}setRotation(e){var t=e.x,i=e.y,r=e.z,s=e.w,a=t*t,n=i*i,o=r*r,h=t*i,l=r*s,u=r*t,d=i*s,c=i*r,_=t*s,p=this.elements;p[0]=1-2*(n+o),p[1]=2*(h+l),p[2]=2*(u-d),p[4]=2*(h-l),p[5]=1-2*(o+a),p[6]=2*(c+_),p[8]=2*(u+d),p[9]=2*(c-_),p[10]=1-2*(n+a)}setPosition(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}equalsOtherMatrix(e){var t=this.elements,i=e.elements;return r.nearEqual(t[0],i[0])&&r.nearEqual(t[1],i[1])&&r.nearEqual(t[2],i[2])&&r.nearEqual(t[3],i[3])&&r.nearEqual(t[4],i[4])&&r.nearEqual(t[5],i[5])&&r.nearEqual(t[6],i[6])&&r.nearEqual(t[7],i[7])&&r.nearEqual(t[8],i[8])&&r.nearEqual(t[9],i[9])&&r.nearEqual(t[10],i[10])&&r.nearEqual(t[11],i[11])&&r.nearEqual(t[12],i[12])&&r.nearEqual(t[13],i[13])&&r.nearEqual(t[14],i[14])&&r.nearEqual(t[15],i[15])}decomposeTransRotScale(e,t,i){var r=ri;return this.decomposeTransRotMatScale(e,r,i)?(Xt.createFromMatrix4x4(r,t),!0):(t.identity(),!1)}decomposeTransRotMatScale(e,t,i){var s=this.elements,n=e,o=t.elements,h=i;n.x=s[12],n.y=s[13],n.z=s[14];var l=s[0],u=s[1],d=s[2],c=s[4],_=s[5],p=s[6],g=s[8],m=s[9],f=s[10],T=h.x=Math.sqrt(l*l+u*u+d*d),y=h.y=Math.sqrt(c*c+_*_+p*p),x=h.z=Math.sqrt(g*g+m*m+f*f);if(r.isZero(T)||r.isZero(y)||r.isZero(x))return o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=o[12]=o[13]=o[14]=0,o[0]=o[5]=o[10]=o[15]=1,!1;var v=Jt;v.x=g/x,v.y=m/x,v.z=f/x;var S=ei;S.x=l/T,S.y=u/T,S.z=d/T;var D=ti;a.cross(v,S,D);var E=ei;return a.cross(D,v,E),o[3]=o[7]=o[11]=o[12]=o[13]=o[14]=0,o[15]=1,o[0]=E.x,o[1]=E.y,o[2]=E.z,o[4]=D.x,o[5]=D.y,o[6]=D.z,o[8]=v.x,o[9]=v.y,o[10]=v.z,o[0]*l+o[1]*u+o[2]*d<0&&(h.x=-T),o[4]*c+o[5]*_+o[6]*p<0&&(h.y=-y),o[8]*g+o[9]*m+o[10]*f<0&&(h.z=-x),!0}decomposeYawPitchRoll(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>r.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}normalize(){var e=this.elements,t=e[0],i=e[1],r=e[2],s=Math.sqrt(t*t+i*i+r*r);if(!s)return e[0]=0,e[1]=0,void(e[2]=0);1!=s&&(s=1/s,e[0]=t*s,e[1]=i*s,e[2]=r*s)}transpose(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invert(e){var t=this.elements,i=e.elements,r=t[0],s=t[1],a=t[2],n=t[3],o=t[4],h=t[5],l=t[6],u=t[7],d=t[8],c=t[9],_=t[10],p=t[11],g=t[12],m=t[13],f=t[14],T=t[15],y=r*h-s*o,x=r*l-a*o,v=r*u-n*o,S=s*l-a*h,D=s*u-n*h,E=a*u-n*l,w=d*m-c*g,R=d*f-_*g,C=d*T-p*g,A=c*f-_*m,M=c*T-p*m,b=_*T-p*f,I=y*b-x*M+v*A+S*C-D*R+E*w;0!==Math.abs(I)&&(I=1/I,i[0]=(h*b-l*M+u*A)*I,i[1]=(a*M-s*b-n*A)*I,i[2]=(m*E-f*D+T*S)*I,i[3]=(_*D-c*E-p*S)*I,i[4]=(l*C-o*b-u*R)*I,i[5]=(r*b-a*C+n*R)*I,i[6]=(f*v-g*E-T*x)*I,i[7]=(d*E-_*v+p*x)*I,i[8]=(o*M-h*C+u*w)*I,i[9]=(s*C-r*M-n*w)*I,i[10]=(g*D-m*v+T*y)*I,i[11]=(c*v-d*D-p*y)*I,i[12]=(h*R-o*A-l*w)*I,i[13]=(r*A-s*R+a*w)*I,i[14]=(m*x-g*S-f*y)*I,i[15]=(d*S-c*x+_*y)*I)}static billboard(e,t,i,s,n){a.subtract(e,t,Jt);var o=a.scalarLengthSquared(Jt);r.isZero(o)?(a.scale(s,-1,ei),ei.cloneTo(Jt)):a.scale(Jt,1/Math.sqrt(o),Jt),a.cross(i,Jt,ti),a.normalize(ti,ti),a.cross(Jt,ti,ii);var h=ti,l=ii,u=Jt,d=e,c=n.elements;c[0]=h.x,c[1]=h.y,c[2]=h.z,c[3]=0,c[4]=l.x,c[5]=l.y,c[6]=l.z,c[7]=0,c[8]=u.x,c[9]=u.y,c[10]=u.z,c[11]=0,c[12]=d.x,c[13]=d.y,c[14]=d.z,c[15]=1}identity(){this.elements.set(Qt)}isIdentity(){let e=this.elements,t=Zt.DEFAULT.elements;for(let s=0,a=e.length;s<a;s++)if(i=e[s],r=t[s],!(Math.abs(i-r)<1e-7))return!1;var i,r;return!0}cloneTo(e){this.elements!==e.elements&&e.elements.set(this.elements)}cloneByArray(e){this.elements.set(e)}clone(){var e=new Zt(null);return e.elements=this.elements.slice(),e}static translation(e,t){var i=t.elements;i[0]=i[5]=i[10]=i[15]=1,i[12]=e.x,i[13]=e.y,i[14]=e.z}getTranslationVector(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}setTranslationVector(e){var t=this.elements,i=e;t[12]=i.x,t[13]=i.y,t[14]=i.z}getForward(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}setForward(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}getInvertFront(){this.decomposeTransRotScale(Jt,Xt.TEMP,ei);var e=ei,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}}Zt.TEMP=new Zt,Zt.DEFAULT=new Zt,Zt.DEFAULTINVERT=new Zt(-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),Zt.ZERO=new Zt(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const Jt=new a,ei=new a,ti=new a,ii=new a,ri=new Zt;var si;function ai(t,i){let r=!1;switch(i){case e.ShaderDataType.Int:case e.ShaderDataType.Float:r="number"==typeof t;break;case e.ShaderDataType.Bool:r="boolean"==typeof t;break;case e.ShaderDataType.Vector2:r=t instanceof Gt;break;case e.ShaderDataType.Vector3:r=t instanceof a;break;case e.ShaderDataType.Vector4:r=t instanceof s;break;case e.ShaderDataType.Color:r=t instanceof m;break;case e.ShaderDataType.Matrix4x4:r=t instanceof Zt;break;case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:r=t instanceof M;break;case e.ShaderDataType.Buffer:r=t instanceof ArrayBuffer;break;case e.ShaderDataType.Matrix3x3:r=t instanceof zt;break;default:r=!1}return r||console.warn("The setting value and Shader type do not match"),r}function ni(t){switch(t){case e.ShaderDataType.Int:return 0;case e.ShaderDataType.Bool:return!1;case e.ShaderDataType.Float:return 0;case e.ShaderDataType.Vector2:return Gt.ZERO;case e.ShaderDataType.Vector3:return a.ZERO;case e.ShaderDataType.Vector4:return s.ZERO;case e.ShaderDataType.Color:return m.BLACK;case e.ShaderDataType.Matrix4x4:return Zt.DEFAULT;case e.ShaderDataType.Matrix3x3:return zt.DEFAULT}return null}e.ShaderDataType=void 0,(si=e.ShaderDataType||(e.ShaderDataType={}))[si.None=0]="None",si[si.Int=1]="Int",si[si.Bool=2]="Bool",si[si.Float=3]="Float",si[si.Vector2=4]="Vector2",si[si.Vector3=5]="Vector3",si[si.Vector4=6]="Vector4",si[si.Color=7]="Color",si[si.Matrix4x4=8]="Matrix4x4",si[si.Texture2D=9]="Texture2D",si[si.Texture3D=10]="Texture3D",si[si.TextureCube=11]="TextureCube",si[si.Buffer=12]="Buffer",si[si.Matrix3x3=13]="Matrix3x3",si[si.Texture2DArray=14]="Texture2DArray";class oi{constructor(e,t,i){this._owner=e,this.name=t,this._VS=i.vsNode,this._PS=i.psNode,this._defs=i.defs,this._validDefine=g.unitRenderModuleDataFactory.createDefineDatas();for(let e of i.defs)this._validDefine.add(gi.getDefineByName(e))}withCompile(e){return null}}class hi{get shader(){return this._shader}get subShaderIndex(){return this._subShaderIndex}get passIndex(){return this._passIndex}get defineNames(){return this._defineNames}constructor(e,t,i,r){this._subShaderIndex=0,this._passIndex=0,this.setValue(e,t,i,r)}setValue(e,t,i,r){if(!e)throw"ShaderVariantInfo:Shader can't be null.";var s=e.getSubShaderAt(t);if(!s)throw`ShaderVariantInfo:Shader don't have subShaderIndex of ${t}.`;var a=s._passes[i];if(!a)throw`ShaderVariantInfo:Shader don't have passIndex of ${i}.`;for(var n=a._validDefine,o=0,h=r.length;o<h;o++){var l=r[o];if(!n.has(gi.getDefineByName(l)))throw`ShaderVariantInfo:Invalid defineName ${l} in ${e._name} subShaderIndex of ${t} passIndex of ${i}.`}this._shader=e,this._subShaderIndex=t,this._passIndex=i,this._defineNames=r}equal(e){if(this._shader!==e._shader||this._subShaderIndex!==e._subShaderIndex||this._passIndex!==e._passIndex)return!1;var t=this._defineNames,i=e._defineNames;if(t.length!==i.length)return!1;for(var r=0,s=this._defineNames.length;r<s;r++)if(t[r]!==i[r])return!1;return!0}clone(){return new hi(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}}class li{constructor(e){this.items=e||{}}add(e,t){let i=e._owner._owner,r=i._subShaders.indexOf(e._owner),s=e._owner._passes.indexOf(e),a=e.nodeCommonMap;if(!a)return;t=t.filter((e=>!gi._configDefineValues.has(gi.getDefineByName(e))));let n=this.items[i._name];n||(n=[],this.items[i._name]=n),n.some((e=>e.subShaderIndex===r&&e.passIndex===s&&e.defines.length===t.length&&e.defines.every(((e,i)=>e===t[i]))&&e.nodeCommonMap.length===a.length&&e.nodeCommonMap.every(((e,t)=>e===a[t]))))||(n.push({subShaderIndex:r,passIndex:s,defines:t,nodeCommonMap:a.concat()}),console.debug(`Shader variant: ${i._name}/${r}/${s}/${t.join(",")}/${a?a.join(","):""}`))}compileAll(){let e=this.items;for(let t in e){let i=e[t];for(let e of i){let i=gi.compileShaderByDefineNames(t,e.subShaderIndex,e.passIndex,e.defines,e.nodeCommonMap),r=`${t}/${e.subShaderIndex}/${e.passIndex}/${e.defines.join(",")}/${e.nodeCommonMap?e.nodeCommonMap.join(","):""}`;i?console.debug("Warm up",r):console.warn("Warm up failed!",r)}}}}li.active=new li;class ui extends oi{get pipelineMode(){return this._pipelineMode}set pipelineMode(e){this._pipelineMode=e,this.moduleData.pipelineMode=e}set nodeCommonMap(e){this._nodeUniformCommonMap=e,this.moduleData.nodeCommonMap=e}get nodeCommonMap(){return this._nodeUniformCommonMap}get statefirst(){return this._statefirst}set statefirst(e){this._statefirst=e,this.moduleData.statefirst=e}get renderState(){return this.moduleData.renderState}constructor(e,t){super(e,null,t),this._statefirst=!1,this.moduleData=g.unitRenderModuleDataFactory.createShaderPass(this),this.moduleData.validDefine=this._validDefine}static createShaderInstance(e,t,i){di.length=0,gi._getNamesByDefineData(i,di);let r={is2D:t,vs:e._VS,ps:e._PS,attributeMap:e._owner._attributeMap,uniformMap:e._owner._uniformMap,defineString:di};return gi.debugMode&&li.active.add(e,di),g.renderDeviceFactory.createShaderInstance(r,e)}withCompile(e,t=!1){var i=this.moduleData.getCacheShader(e);return i||(i=ui.createShaderInstance(this,t,e),this.moduleData.setCacheShader(e,i),i)}withComplieByBin(e,t=!1,i){var r=this.moduleData.getCacheShader(e);return r||(this.moduleData.setCacheShader(e,r),null)}}const di=[];class ci{static __init__(){ci.instanceWorldMatrixDeclaration=new nt(64,[new ot(0,st.Vector4,ci.MESH_WORLDMATRIX_ROW0),new ot(16,st.Vector4,ci.MESH_WORLDMATRIX_ROW1),new ot(32,st.Vector4,ci.MESH_WORLDMATRIX_ROW2),new ot(48,st.Vector4,ci.MESH_WORLDMATRIX_ROW3)]),ci.instanceSimpleAnimatorDeclaration=new nt(16,[new ot(0,st.Vector4,ci.MESH_SIMPLEANIMATOR)]),ci.instanceLightMapScaleOffsetDeclaration=new nt(16,[new ot(0,st.Vector4,ci.MESH_LIGHTMAPSCALEOFFSET)])}static getVertexDeclaration(e,t=!0){var i=ci._vertexDeclarationMap[e+(t?"_0":"_1")];if(!i){for(var r=e.split(","),s=0,a=[],n=0,o=r.length;n<o;n++){var h;switch(r[n]){case"POSITION":h=new ot(s,st.Vector3,ci.MESH_POSITION0),s+=12;break;case"NORMAL":h=new ot(s,st.Vector3,ci.MESH_NORMAL0),s+=12;break;case"COLOR":h=new ot(s,st.Vector4,ci.MESH_COLOR0),s+=16;break;case"UV":h=new ot(s,st.Vector2,ci.MESH_TEXTURECOORDINATE0),s+=8;break;case"UV1":h=new ot(s,st.Vector2,ci.MESH_TEXTURECOORDINATE1),s+=8;break;case"BLENDWEIGHT":h=new ot(s,st.Vector4,ci.MESH_BLENDWEIGHT0),s+=16;break;case"BLENDINDICES":t?(h=new ot(s,st.Vector4,ci.MESH_BLENDINDICES0),s+=16):(h=new ot(s,st.Byte4,ci.MESH_BLENDINDICES0),s+=4);break;case"TANGENT":h=new ot(s,st.Vector4,ci.MESH_TANGENT0),s+=16;break;case"NORMAL_BYTE":h=new ot(s,st.NorByte4,ci.MESH_NORMAL0),s+=4;break;default:throw"VertexMesh: unknown vertex flag."}a.push(h)}i=new nt(s,a),ci._vertexDeclarationMap[e+(t?"_0":"_1")]=i}return i}}ci.MESH_POSITION0=0,ci.MESH_COLOR0=1,ci.MESH_TEXTURECOORDINATE0=2,ci.MESH_NORMAL0=3,ci.MESH_TANGENT0=4,ci.MESH_BLENDINDICES0=5,ci.MESH_BLENDWEIGHT0=6,ci.MESH_TEXTURECOORDINATE1=7,ci.MESH_WORLDMATRIX_ROW0=8,ci.MESH_WORLDMATRIX_ROW1=9,ci.MESH_WORLDMATRIX_ROW2=10,ci.MESH_WORLDMATRIX_ROW3=11,ci.MESH_SIMPLEANIMATOR=12,ci.MESH_LIGHTMAPSCALEOFFSET=13,ci.MESH_CUSTOME0=12,ci.MESH_CUSTOME1=13,ci.MESH_CUSTOME2=14,ci.MESH_CUSTOME3=15,ci._vertexDeclarationMap={};class _i{static regIncludeBindUnifrom(e,t,i){let r={},s=r[e]={};s.uniformMap=t,s.defaultValue=i,Object.assign(_i.IncludeUniformMap,r)}constructor(t=_i.DefaultAttributeMap,i={},r=null){this._flags={},this._passes=[],this.moduleData=g.unitRenderModuleDataFactory.createSubShader(),this._attributeMap=t,this._uniformDefaultValue=r,this._uniformMap=new Map;for(const t in i)if("object"==typeof i[t]){let e=i[t];for(const t in e){let i=e[t];this.addUniform(t,i)}}else{let r=i[t];if(this.addUniform(t,r),r==e.ShaderDataType.Texture2D||r==e.ShaderDataType.TextureCube||r==e.ShaderDataType.Texture3D||r==e.ShaderDataType.Texture2DArray){let e=gi.getDefineByName(`Gamma_${t}`),i=gi.propertyNameToID(t);g.renderEngine.addTexGammaDefine(i,e)}}this.moduleData.setUniformMap(this._uniformMap)}addUniform(t,i){let r=t,s=function(e){let t=e.lastIndexOf("]"),i=e.lastIndexOf("[");if(-1!=i&&t==e.length-1){let r=e.slice(i+1,t),s=parseInt(r);if(!isNaN(s)&&s>0)return s}return 0}(t);s>0&&(r=t.substring(0,t.lastIndexOf("[")));let a={id:gi.propertyNameToID(r),propertyName:t,uniformtype:i,arrayLength:s};if(this._uniformMap.set(a.id,a),i==e.ShaderDataType.Texture2D||i==e.ShaderDataType.TextureCube||i==e.ShaderDataType.Texture3D||i==e.ShaderDataType.Texture2DArray){let e=gi.getDefineByName(`Gamma_${t}`);g.renderEngine.addTexGammaDefine(a.id,e)}}addShaderPass(e,t,i="Forward"){return this._addShaderPass(kt.compile(e,t),i)}_addShaderPass(e,t="Forward"){var i=new ui(this,e);return i.pipelineMode=t,this._passes.push(i),this.moduleData.addShaderPass(i.moduleData),this._addIncludeUniform(e.includeNames),i}_addIncludeUniform(e){for(let i of e)if(_i.IncludeUniformMap[i]){let e=_i.IncludeUniformMap[i],r=e.uniformMap,s=e.defaultValue;for(var t in r)this._uniformMap.has(gi.propertyNameToID(t))||this.addUniform(t,r[t]);for(var t in s)this._uniformDefaultValue[t]||(this._uniformDefaultValue[t]=s[t])}}}var pi;_i.IncludeUniformMap={},_i.DefaultAttributeMap={a_Position:[ci.MESH_POSITION0,e.ShaderDataType.Vector4],a_Normal:[ci.MESH_NORMAL0,e.ShaderDataType.Vector3],a_Tangent0:[ci.MESH_TANGENT0,e.ShaderDataType.Vector4],a_Texcoord0:[ci.MESH_TEXTURECOORDINATE0,e.ShaderDataType.Vector2],a_Texcoord1:[ci.MESH_TEXTURECOORDINATE1,e.ShaderDataType.Vector2],a_Color:[ci.MESH_COLOR0,e.ShaderDataType.Vector4],a_BoneWeights:[ci.MESH_BLENDWEIGHT0,e.ShaderDataType.Vector4],a_BoneIndices:[ci.MESH_BLENDINDICES0,e.ShaderDataType.Vector4],a_WorldMat:[ci.MESH_WORLDMATRIX_ROW0,e.ShaderDataType.Matrix4x4],a_SimpleTextureParams:[ci.MESH_SIMPLEANIMATOR,e.ShaderDataType.Vector4],a_LightmapScaleOffset:[ci.MESH_LIGHTMAPSCALEOFFSET,e.ShaderDataType.Vector4]},e.ShaderFeatureType=void 0,(pi=e.ShaderFeatureType||(e.ShaderFeatureType={}))[pi.DEFAULT=0]="DEFAULT",pi[pi.D3=1]="D3",pi[pi.D2_primitive=2]="D2_primitive",pi[pi.D2_TextureSV=3]="D2_TextureSV",pi[pi.D2_BaseRednerNode2D=4]="D2_BaseRednerNode2D",pi[pi.PostProcess=5]="PostProcess",pi[pi.Sky=6]="Sky",pi[pi.Effect=7]="Effect";class gi{static init(){gi._configDefineValues=g.unitRenderModuleDataFactory.createDefineDatas(),gi.SHADERDEFINE_REMAP_POSITIONZ=gi.getDefineByName("REMAP_Z"),gi.SHADERDEFINE_LOD_TEXTURE_SAMPLE=gi.getDefineByName("LOD_TEXTURE_SAMPLE"),gi.SHADERDEFINE_BREAK_TEXTURE_SAMPLE=gi.getDefineByName("BREAK_TEXTURE_SAMPLE"),g.renderEngine._remapZ&&gi._configDefineValues.add(gi.SHADERDEFINE_REMAP_POSITIONZ),g.renderEngine._lodTextureSample&&gi._configDefineValues.add(gi.SHADERDEFINE_LOD_TEXTURE_SAMPLE),g.renderEngine._breakTextureSample&&gi._configDefineValues.add(gi.SHADERDEFINE_BREAK_TEXTURE_SAMPLE),gi._compileDefineDatas=g.unitRenderModuleDataFactory.createDefineDatas()}static _getNamesByDefineData(e,t){return g.renderEngine.getNamesByDefineData(e,t),t}static getDefineByName(e){return g.renderEngine.getDefineByName(e)}static propertyNameToID(e){return g.renderEngine.propertyNameToID(e)}static propertyIDToName(e){return g.renderEngine.propertyIDToName(e)}static addInclude(e,t){kt.addInclude(e,t)}static compileShaderByDefineNames(e,t,i,r,s){var a=gi.find(e);if(a){var n=a.getSubShaderAt(t);if(n){var o=n._passes[i];if(o.nodeCommonMap=s,o){var h=gi._compileDefineDatas;gi._configDefineValues.cloneTo(h);for(let e of r)h.add(gi.getDefineByName(e));return o.withCompile(h),!0}}}return!1}static compileShaderByBin(e,t,i,r,s,a){var n=gi.find(e);if(n){var o=n.getSubShaderAt(t);if(o){var h=o._passes[i];if(h.nodeCommonMap=s,h){var l=gi._compileDefineDatas;l.clear();for(let e of r)l.add(gi.getDefineByName(e));h.withComplieByBin(l,!1,a)}}}}static add(e,t=!1,i=!1){return gi._preCompileShader[e]=new gi(e,t,i)}static find(e){return gi._preCompileShader[e]}static parse(e,t){var i;e.name||console.warn("shader name is empty",e),e.uniformMap||console.warn(`${e.name}: uniformMap is empty`);let r=gi.add(e.name,e.enableInstancing,e.supportReflectionProbe);r._surportVolumetricGI=e.surportVolumetricGI,r.shaderType=e.shaderType;let s=new _i(e.attributeMap?e.attributeMap:_i.DefaultAttributeMap,e.uniformMap,e.defaultValue);r.addSubShader(s);let a=e.shaderPass;for(var n in a){let r=a[n];if(!r.VS){console.warn(`${e.name}: VS of pass ${n} is empty`);continue}if(!r.FS){console.warn(`${e.name}: FS of pass ${n} is empty`);continue}let o=s._addShaderPass(kt.compile(r.VS,r.FS,t),r.pipeline);o.statefirst=null!==(i=r.statefirst)&&void 0!==i&&i,kt.getRenderState(r.renderState,o.renderState)}return r}get name(){return this._name}constructor(e,t,i){this._enableInstancing=!1,this._supportReflectionProbe=!1,this._surportVolumetricGI=!1,this._subShaders=[],this._name=e,this._enableInstancing=t,this._supportReflectionProbe=i}addSubShader(e){this._subShaders.push(e),e._owner=this,e.moduleData.enableInstance=this._enableInstancing,e.moduleData.shaderName=this._name}getSubShaderAt(e){return this._subShaders[e]}}gi.PERIOD_CUSTOM=0,gi.PERIOD_MATERIAL=1,gi.PERIOD_SPRITE=2,gi.PERIOD_CAMERA=3,gi.PERIOD_SCENE=4,gi._propertyNameMap={},gi._preCompileShader={},gi.debugMode=!1;class mi{static getPoints(e,t=5,i=2,r){r=r||[];let s=e.length;if(s<2*(i+1))return r;switch(i){case 2:Ti=Si;break;case 3:Ti=Di;break;default:return[]}for(;fi.length<=i;)fi.push(new d);for(let t=0;t<2*i;t+=2)vi(e[t],e[t+1]);for(let a=2*i;a<s;a+=2)vi(e[a],e[a+1]),a/2%i==0&&Ei(t,r);return r}static getRate(e,t,i,r,s){let a,n=function(e,t,i,r){return 100*(100*(100*(100*e+t)+i)+r)}(t,i,r,s),o=100*n+e;if(yi[o])return yi[o];var h;xi[n]?a=xi[n]:(h=[0,0,t,i,r,s,1,1],a=mi.getPoints(h,100,3),xi[n]=a);let l=a.length;for(let t=0;t<l;t+=2)if(e<=a[t])return yi[o]=a[t+1],a[t+1];return yi[o]=1,1}}const fi=[new d,new d,new d];var Ti=Si;const yi={},xi={};function vi(e,t){let i=fi.shift();i.setTo(e,t),fi.push(i)}function Si(e,t){var i=fi[0],r=fi[1],s=fi[2],a=Math.pow(1-e,2)*i.x+2*e*(1-e)*r.x+Math.pow(e,2)*s.x,n=Math.pow(1-e,2)*i.y+2*e*(1-e)*r.y+Math.pow(e,2)*s.y;t.push(a,n)}function Di(e,t){var i=fi[0],r=fi[1],s=fi[2],a=fi[3],n=Math.pow(1-e,3)*i.x+3*r.x*e*(1-e)*(1-e)+3*s.x*e*e*(1-e)+a.x*Math.pow(e,3),o=Math.pow(1-e,3)*i.y+3*r.y*e*(1-e)*(1-e)+3*s.y*e*e*(1-e)+a.y*Math.pow(e,3);t.push(n,o)}function Ei(e,t){var i,r;for(r=1/(e=e>0?e:5),i=0;i<=1;i+=r)Ti(i,t)}class wi{static __init__(){}static setDepthTest(e){g.renderEngine._GLRenderState.setDepthTest(e)}static setDepthMask(e){g.renderEngine._GLRenderState.setDepthMask(e)}static setDepthFunc(e){g.renderEngine._GLRenderState.setDepthFunc(e)}static setStencilTest(e){g.renderEngine._GLRenderState.setStencilTest(e)}static setStencilMask(e){g.renderEngine._GLRenderState.setStencilMask(e)}static setStencilFunc(e,t){g.renderEngine._GLRenderState.setStencilFunc(e,t)}static setstencilOp(e,t,i){g.renderEngine._GLRenderState.setstencilOp(e,t,i)}static setBlend(e){g.renderEngine._GLRenderState.setBlend(e)}static setBlendEquation(e){g.renderEngine._GLRenderState.setBlendEquation(e)}static setBlendEquationSeparate(e,t){g.renderEngine._GLRenderState.setBlendEquationSeparate(e,t)}static setBlendFunc(e,t){g.renderEngine._GLRenderState.setBlendFunc(e,t)}static setBlendFuncSeperate(e,t,i,r){g.renderEngine._GLRenderState.setBlendFuncSeperate(e,t,i,r)}static setCullFace(e){g.renderEngine._GLRenderState.setCullFace(e)}static setFrontFace(e){g.renderEngine._GLRenderState.setFrontFace(e)}}wi.stencilFuncArray=new Array(2),wi.blendEquationSeparateArray=new Array(2),wi.blenfunArray=new Array(2),wi.blendFuncSeperateArray=new Array(4),wi.stencilOpArray=new Array(3);class Ri{static _init_(){Ri.fns=[Ri.BlendNormal,Ri.BlendAdd,Ri.BlendMultiply,Ri.BlendScreen,Ri.BlendOverlay,Ri.BlendLight,Ri.BlendMask,Ri.BlendDestinationOut,Ri.BlendAddOld,Ri.BlendSourceAlpha],Ri.targetFns=[Ri.BlendNormalTarget,Ri.BlendAddTarget,Ri.BlendMultiplyTarget,Ri.BlendScreenTarget,Ri.BlendOverlayTarget,Ri.BlendLightTarget,Ri.BlendMask,Ri.BlendDestinationOut,Ri.BlendAddTargetOld,Ri.BlendSourceAlpha]}static BlendNormal(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendAddOld(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.DestinationAlpha)}static BlendAdd(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMultiply(){wi.setBlendFunc(e.BlendFactor.DestinationColor,e.BlendFactor.OneMinusSourceAlpha)}static BlendScreen(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendOverlay(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendLight(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendNormalTarget(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendAddTargetOld(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.DestinationAlpha)}static BlendAddTarget(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMultiplyTarget(){wi.setBlendFunc(e.BlendFactor.DestinationColor,e.BlendFactor.OneMinusSourceAlpha)}static BlendScreenTarget(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendOverlayTarget(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceColor)}static BlendLightTarget(){wi.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMask(){wi.setBlendFunc(e.BlendFactor.Zero,e.BlendFactor.SourceAlpha)}static BlendDestinationOut(){wi.setBlendFunc(e.BlendFactor.Zero,e.BlendFactor.Zero)}static BlendSourceAlpha(){wi.setBlendFunc(e.BlendFactor.SourceAlpha,e.BlendFactor.OneMinusSourceAlpha)}}Ri.activeBlendFunction=null,Ri.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out","add_old"],Ri.TOINT={normal:0,add:1,multiply:2,screen:3,overlay:4,light:5,mask:6,"destination-out":7,lighter:1,lighter_old:8,add_old:8},Ri.NORMAL="normal",Ri.MASK="mask",Ri.LIGHTER="lighter";const Ci={purple:"#800080",orange:"#ffa500",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#808080"};class Ai{constructor(e){if(this.arrColor=[],Ai._DEFAULT||Ai._initDefault(),null==e||"none"==e)return this.strColor="#00000000",this.numColor=0,void(this.arrColor=[0,0,0,0]);let t;"string"==typeof e?(t=m.stringToHex(e),this.strColor=e):(t=e,this.strColor=m.hexToString(t)),this.strColor.indexOf("rgba")>=0||9===this.strColor.length?(this.arrColor=[((4278190080&t)>>>24)/255,((16711680&t)>>16)/255,((65280&t)>>8)/255,(255&t)/255],this.numColor=(4278190080&t)>>>24|(16711680&t)>>8|(65280&t)<<8|(255&t)<<24):(this.arrColor=[((16711680&t)>>16)/255,((65280&t)>>8)/255,(255&t)/255,1],this.numColor=4278190080|(16711680&t)>>16|65280&t|(255&t)<<16)}static _initDefault(){for(var e in Ai._DEFAULT={},Ci)Ai._SAVE[e]=Ai._DEFAULT[e]=new Ai(Ci[e]);return Ai._DEFAULT}static _initSaveMap(){Ai._SAVE_SIZE=0,Ai._SAVE=Object.assign({},Ai._DEFAULT)}static create(e){let t=e+"",i=Ai._SAVE[t];return null!=i?i:(Ai._SAVE_SIZE>500&&Ai._initSaveMap(),Ai._SAVE_SIZE++,Ai._SAVE[t]=new Ai(e))}}Ai._SAVE={},Ai._SAVE_SIZE=0;class Mi{static _Defaultinit(){Mi.DEFAULT=new Mi("#000000")}static create(e){if(e){var t=e instanceof Ai?e:Ai.create(e);return t._drawStyle||(t._drawStyle=new Mi(e))}return Mi.DEFAULT}constructor(e){this.setValue(e)}setValue(e){this._color=e?e instanceof Ai?e:Ai.create(e):Ai.create("#000000")}reset(){this._color=Ai.create("#000000")}toInt(){return this._color.numColor}equal(e){return"string"==typeof e?this._color.strColor===e:e instanceof Ai&&this._color.numColor===e.numColor}toColorStr(){return this._color.strColor}}class bi{constructor(){this._lastOriX=0,this._lastOriY=0,this.paths=[],this._curPath=null}beginPath(e){this.paths.length=1,this._curPath=this.paths[0]=new Ii,this._curPath.convex=e}closePath(){this._curPath.loop=!0}newPath(){this._curPath=new Ii,this.paths.push(this._curPath)}addPoint(e,t){this._curPath.path.push(e,t)}push(e,t){this._curPath?this._curPath.path.length>0&&(this._curPath=new Ii,this.paths.push(this._curPath)):(this._curPath=new Ii,this.paths.push(this._curPath));var i=this._curPath;i.path=e.slice(),i.convex=t}reset(){this.paths.length=0}}class Ii{constructor(){this.path=[],this.loop=!1,this.convex=!1}}class Bi{constructor(){}static _createArray(){var e=[];return e._length=0,e}static _init(){var e=Bi._namemap={};return e[Bi.TYPE_ALPHA]="ALPHA",e[Bi.TYPE_FILESTYLE]="fillStyle",e[Bi.TYPE_FONT]="font",e[Bi.TYPE_LINEWIDTH]="lineWidth",e[Bi.TYPE_STROKESTYLE]="strokeStyle",e[Bi.TYPE_ENABLEMERGE]="_mergeID",e[Bi.TYPE_MARK]=e[Bi.TYPE_TRANSFORM]=e[Bi.TYPE_TRANSLATE]=[],e[Bi.TYPE_TEXTBASELINE]="textBaseline",e[Bi.TYPE_TEXTALIGN]="textAlign",e[Bi.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType",e[Bi.TYPE_SHADER]="shader",e[Bi.TYPE_FILTERS]="filters",e[Bi.TYPE_COLORFILTER]="_colorFiler",e}isSaveMark(){return!1}restore(e){this._dataObj[this._valueName]=this._value,Bi.POOL[Bi.POOL._length++]=this,this._newSubmit&&(e.stopMerge=!0)}static save(e,t,i,r){if((e._saveMark._saveuse&t)!==t){e._saveMark._saveuse|=t;var s=Bi.POOL,a=s._length>0?s[--s._length]:new Bi;a._value=i[a._valueName=Bi._namemap[t]],a._dataObj=i,a._newSubmit=r;var n=e._save;n[n._length++]=a}}}Bi.TYPE_ALPHA=1,Bi.TYPE_FILESTYLE=2,Bi.TYPE_FONT=8,Bi.TYPE_LINEWIDTH=256,Bi.TYPE_STROKESTYLE=512,Bi.TYPE_MARK=1024,Bi.TYPE_TRANSFORM=2048,Bi.TYPE_TRANSLATE=4096,Bi.TYPE_ENABLEMERGE=8192,Bi.TYPE_TEXTBASELINE=16384,Bi.TYPE_TEXTALIGN=32768,Bi.TYPE_GLOBALCOMPOSITEOPERATION=65536,Bi.TYPE_CLIPRECT=131072,Bi.TYPE_CLIPRECT_STENCIL=262144,Bi.TYPE_IBVB=524288,Bi.TYPE_SHADER=1048576,Bi.TYPE_FILTERS=2097152,Bi.TYPE_FILTERS_TYPE=4194304,Bi.TYPE_COLORFILTER=8388608,Bi.POOL=Bi._createArray(),Bi._namemap=Bi._init();class Li{constructor(){this._globalClipMatrix=new V,this._clipInfoID=-1,this._clipRect=new G}isSaveMark(){return!1}restore(e){this._globalClipMatrix.copyTo(e._globalClipMatrix),this._clipRect.clone(e._clipRect),e._clipInfoID=this._clipInfoID,Li.POOL[Li.POOL._length++]=this}static save(e){if((e._saveMark._saveuse&Bi.TYPE_CLIPRECT)!=Bi.TYPE_CLIPRECT){e._saveMark._saveuse|=Bi.TYPE_CLIPRECT;var t=Li.POOL,i=t._length>0?t[--t._length]:new Li;e._globalClipMatrix.copyTo(i._globalClipMatrix),e._clipRect.clone(i._clipRect),i._clipInfoID=e._clipInfoID;var r=e._save;r[r._length++]=i}}}Li.POOL=Bi._createArray();class Pi{constructor(){this._saveuse=0}isSaveMark(){return!0}restore(e){e._saveMark=this._preSaveMark,Pi.POOL[Pi.POOL._length++]=this}static Create(e){var t=Pi.POOL,i=t._length>0?t[--t._length]:new Pi;return i._saveuse=0,i._preSaveMark=e._saveMark,e._saveMark=i,i}}Pi.POOL=Bi._createArray();class Ni{constructor(){this._matrix=new V}isSaveMark(){return!1}restore(e){e._curMat=this._savematrix,Ni.POOL[Ni.POOL._length++]=this}static save(e){var t=e._saveMark;if((t._saveuse&Bi.TYPE_TRANSFORM)!==Bi.TYPE_TRANSFORM){t._saveuse|=Bi.TYPE_TRANSFORM;var i=Ni.POOL,r=i._length>0?i[--i._length]:new Ni;r._savematrix=e._curMat,e._curMat=e._curMat.copyTo(r._matrix);var s=e._save;s[s._length++]=r}}}Ni.POOL=Bi._createArray();class Oi{constructor(){this._mat=new V}isSaveMark(){return!1}restore(e){this._mat.copyTo(e._curMat),Oi.POOL[Oi.POOL._length++]=this}static save(e){var t=Oi.POOL,i=t._length>0?t[--t._length]:new Oi;e._curMat.copyTo(i._mat);var r=e._save;r[r._length++]=i}}Oi.POOL=Bi._createArray();var Fi;class Ui{destroy(){}static __init__(){gi.addInclude("Sprite2DFrag.glsl","vec3 gammaToLinear(in vec3 value){return pow((value+0.055)/1.055,vec3(2.4));}vec4 gammaToLinear(in vec4 value){return vec4(gammaToLinear(value.rgb),value.a);}vec3 linearToGamma(in vec3 value){return vec3(mix(pow(value.rgb,vec3(0.41666))*1.055-vec3(0.055),value.rgb*12.92,vec3(lessThanEqual(value.rgb,vec3(0.0031308)))));}vec4 linearToGamma(in vec4 value){return vec4(linearToGamma(value.rgb),value.a);}vec4 transspaceColor(vec4 color){\n#ifndef GAMMATEXTURE\n#ifdef GAMMASPACE\ncolor.xyz=linearToGamma(color.xyz);\n#endif\n#else\n#ifndef GAMMASPACE\ncolor.xyz=gammaToLinear(color.xyz);\n#endif\n#endif\nreturn color;}varying vec2 v_cliped;\n#if defined(PRIMITIVEMESH)\nvarying vec4 v_color;vec4 getGlColor(vec4 color){\n#ifdef GAMMASPACE\nreturn color;\n#else\nreturn gammaToLinear(color);\n#endif\n}\n#elif defined(TEXTUREVS)\nvarying vec4 v_texcoordAlpha;varying vec4 v_color;varying float v_useTex;uniform sampler2D u_spriteTexture;\n#ifdef BLUR_FILTER\nuniform vec4 u_strength_sig2_2sig2_gauss1;uniform vec2 u_blurInfo;\n#define PI 3.141593\n#endif\n#ifdef COLOR_FILTER\nuniform vec4 u_colorAlpha;uniform mat4 u_colorMat;\n#endif\n#ifdef GLOW_FILTER\nuniform vec4 u_color;uniform vec4 u_blurInfo1;uniform vec4 u_blurInfo2;\n#endif\n#ifdef COLOR_ADD\nuniform vec4 u_colorAdd;\n#endif\n#ifdef FILLTEXTURE\nuniform vec4 u_TexRange;\n#endif\n#ifdef BLUR_FILTER\nfloat getGaussian(float x,float y){return u_strength_sig2_2sig2_gauss1.w*exp(-(x*x+y*y)/u_strength_sig2_2sig2_gauss1.z);}vec4 blur(){const float blurw=9.0;vec4 vec4Color=vec4(0.0,0.0,0.0,0.0);vec2 halfsz=vec2(blurw,blurw)/2.0/u_blurInfo;vec2 startpos=v_texcoordAlpha.xy-halfsz;vec2 ctexcoord=startpos;vec2 step=1.0/u_blurInfo;for(float y=0.0;y<=blurw;++y){ctexcoord.x=startpos.x;for(float x=0.0;x<=blurw;++x){vec4Color+=transspaceColor(texture2D(u_spriteTexture,ctexcoord)*getGaussian(x-blurw/2.0,y-blurw/2.0));ctexcoord.x+=step.x;}ctexcoord.y+=step.y;}return vec4Color;}\n#endif\nvec4 getSpriteTextureColor(){\n#ifdef FILLTEXTURE\nvec4 color=texture2D(u_spriteTexture,fract(v_texcoordAlpha.xy)*u_TexRange.zw+u_TexRange.xy);\n#else\nvec4 color=texture2D(u_spriteTexture,v_texcoordAlpha.xy);\n#endif\nreturn transspaceColor(color);}void setglColor(in vec4 color){if(v_useTex<=0.)color=vec4(1.,1.,1.,1.);color.a*=v_color.w;vec4 transColor=v_color;\n#ifndef GAMMASPACE\ntransColor=gammaToLinear(v_color);\n#endif\ncolor.rgb*=transColor.rgb;gl_FragColor=color;\n#ifdef COLOR_ADD\ngl_FragColor=vec4(u_colorAdd.rgb,u_colorAdd.a*gl_FragColor.a);gl_FragColor.xyz*=u_colorAdd.a;\n#endif\n#ifdef BLUR_FILTER\ngl_FragColor=blur();gl_FragColor.w*=v_color.w;\n#endif\n#ifdef COLOR_FILTER\nmat4 alphaMat=u_colorMat;alphaMat[0][3]*=gl_FragColor.a;alphaMat[1][3]*=gl_FragColor.a;alphaMat[2][3]*=gl_FragColor.a;gl_FragColor=gl_FragColor*alphaMat;gl_FragColor+=u_colorAlpha/255.0*gl_FragColor.a;\n#endif\n#ifdef GLOW_FILTER\nconst float c_IterationTime=10.0;float floatIterationTotalTime=c_IterationTime*c_IterationTime;vec4 vec4Color=vec4(0.0,0.0,0.0,0.0);vec2 vec2FilterDir=vec2(-u_blurInfo1.z/u_blurInfo2.x,-u_blurInfo1.w/u_blurInfo2.y);vec2 vec2FilterOff=vec2(u_blurInfo1.x/u_blurInfo2.x/c_IterationTime*2.0,u_blurInfo1.y/u_blurInfo2.y/c_IterationTime*2.0);float maxNum=u_blurInfo1.x*u_blurInfo1.y;vec2 vec2Off=vec2(0.0,0.0);float floatOff=c_IterationTime/2.0;for(float i=0.0;i<=c_IterationTime;++i){for(float j=0.0;j<=c_IterationTime;++j){vec2Off=vec2(vec2FilterOff.x*(i-floatOff),vec2FilterOff.y*(j-floatOff));vec4Color+=transspaceColor(texture2D(u_spriteTexture,v_texcoordAlpha.xy+vec2FilterDir+vec2Off));}}vec4Color/=floatIterationTotalTime;gl_FragColor=vec4(u_color.rgb,vec4Color.a*u_blurInfo2.z);gl_FragColor.rgb*=gl_FragColor.a;\n#endif\n}\n#endif\n#ifdef BASERENDER2D\nvarying vec2 v_texcoord;varying vec4 v_color;uniform sampler2D u_baseRender2DTexture;uniform vec4 u_baseRenderColor;\n#ifdef LIGHT2D_ENABLE\nvarying vec2 v_lightUV;uniform vec3 u_LightDirection;uniform vec4 u_LightAndShadow2DParam;uniform vec4 u_LightAndShadow2DAmbient;uniform sampler2D u_LightAndShadow2D;\n#ifdef LIGHT2D_SCENEMODE_ADD\nuniform sampler2D u_LightAndShadow2D_AddMode;\n#endif\n#ifdef LIGHT2D_SCENEMODE_SUB\nuniform sampler2D u_LightAndShadow2D_SubMode;\n#endif\n#ifdef LIGHT2D_NORMAL_PARAM\nuniform sampler2D u_normal2DTexture;uniform float u_normal2DStrength;\n#endif\nvoid lightAndShadow(inout vec4 color){\n#ifdef LIGHT2D_EMPTY\ncolor.rgb*=u_LightAndShadow2DAmbient.rgb;\n#else\nvec2 uv=v_lightUV;vec2 tt=step(vec2(0.0),uv)*step(uv,vec2(1.0));float side=tt.x*tt.y;vec3 ambient=color.rgb*u_LightAndShadow2DAmbient.rgb;color.rgb=color.rgb*texture2D(u_LightAndShadow2D,uv).rgb*side;side*=color.a;\n#ifdef LIGHT2D_SCENEMODE_ADD\ncolor.rgb=min(vec3(1.0),color.rgb+texture2D(u_LightAndShadow2D_AddMode,uv).rgb*side);\n#endif\n#ifdef LIGHT2D_SCENEMODE_SUB\ncolor.rgb=max(vec3(0.0),color.rgb-texture2D(u_LightAndShadow2D_SubMode,uv).rgb*side);\n#endif\n#ifdef LIGHT2D_NORMAL_PARAM\nvec3 dr=normalize(u_LightDirection);vec3 normal=normalize(texture2D(u_normal2DTexture,v_texcoord).rgb*2.0-1.0);color.rgb=color.rgb*((1.0-u_normal2DStrength)+abs(dot(dr,normal.rgb))*u_normal2DStrength);\n#endif\ncolor.rgb=min(vec3(1.0),color.rgb+ambient);\n#endif\n}\n#endif\nvoid setglColor(in vec4 color){color.a*=v_color.w;vec4 transColor=v_color;\n#ifndef GAMMASPACE\ntransColor=gammaToLinear(v_color);\n#endif\ncolor.rgb*=transColor.rgb;gl_FragColor=color;}vec2 transformUV(in vec2 texcoord,in vec4 tilingOffset){vec2 uv=texcoord*tilingOffset.zw+tilingOffset.xy;return uv;}\n#endif\nvoid clip(){if(v_cliped.x<0.)discard;if(v_cliped.x>1.)discard;if(v_cliped.y<0.)discard;if(v_cliped.y>1.)discard;}"),gi.addInclude("Sprite2DVertex.glsl",'#include "Sprite2DShaderInfo.glsl";\n#ifdef CAMERA2D\nuniform mat3 u_view2D;\n#endif\n#ifdef WORLDMAT\nuniform mat4 u_mmat;vec4 transedPos;\n#endif\n#ifdef PRIMITIVEMESH\nuniform vec4 u_clipMatDir;uniform vec2 u_clipMatPos;uniform vec2 u_size;uniform float u_VertAlpha;varying vec2 v_cliped;varying vec4 v_color;void getVertexInfo(inout vertexInfo info){info.color=a_attribColor;info.color.a*=u_VertAlpha;float clipw=length(u_clipMatDir.xy);float cliph=length(u_clipMatDir.zw);\n#ifdef WORLDMAT\nvec2 clippos=transedPos.xy-u_clipMatPos.xy;\n#else\nvec2 clippos=a_position.xy-u_clipMatPos.xy;\n#endif\nif(clipw>20000.&&cliph>20000.)info.cliped=vec2(0.5,0.5);else{info.cliped=vec2(dot(clippos,u_clipMatDir.xy)/clipw/clipw,dot(clippos,u_clipMatDir.zw)/cliph/cliph);}}void getPosition(inout vec4 pos){pos=vec4(a_position.xy,0.,1.);\n#ifdef WORLDMAT\npos=u_mmat*pos;transedPos=pos;\n#ifdef CAMERA2D\npos.xy=(u_view2D*vec3(pos.x,pos.y,1.0)).xy+u_size/2.;\n#endif\npos=vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,pos.z,1.0);\n#else\n#ifdef CAMERA2D\npos.xy=(u_view2D*vec3(pos.x,pos.y,1.0)).xy+u_size/2.;\n#endif\npos=vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,pos.z,1.0);\n#endif\n#ifdef INVERTY\npos.y=-pos.y;\n#endif\n}\n#endif\n#ifdef TEXTUREVS\nuniform vec4 u_clipMatDir;uniform vec2 u_clipMatPos;uniform vec2 u_size;uniform float u_VertAlpha;varying vec2 v_cliped;varying vec4 v_color;\n#ifdef MVP3D\nuniform mat4 u_MvpMatrix;\n#endif\nvarying vec4 v_texcoordAlpha;varying float v_useTex;void getVertexInfo(inout vertexInfo info){info.texcoordAlpha.xy=a_posuv.zw;info.color=a_attribColor;info.color.a*=u_VertAlpha;info.color.xyz*=info.color.w;info.useTex=a_attribFlags.r;}void getPosition(inout vec4 glPosition){vec4 pos=vec4(a_posuv.xy,0.,1.);\n#ifdef WORLDMAT\npos=u_mmat*pos;transedPos=pos;\n#endif\n#ifdef CAMERA2D\npos.xy=(u_view2D*vec3(pos.x,pos.y,1.0)).xy+u_size/2.;\n#endif\nfloat clipw=length(u_clipMatDir.xy);float cliph=length(u_clipMatDir.zw);vec2 clpos=u_clipMatPos.xy;\n#ifdef WORLDMAT\nvec2 clippos=transedPos.xy-clpos;\n#else\nvec2 clippos=pos.xy-clpos;\n#endif\nif(clipw>20000.&&cliph>20000.)v_cliped=vec2(0.5,0.5);else{v_cliped=vec2(dot(clippos,u_clipMatDir.xy)/clipw/clipw,dot(clippos,u_clipMatDir.zw)/cliph/cliph);}vec4 pos1=vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,0.,1.0);\n#ifdef MVP3D\nglPosition=u_MvpMatrix*pos1;\n#else\nglPosition=pos1;\n#endif\n#ifdef INVERTY\nglPosition.y=-glPosition.y;\n#endif\n}\n#endif\n#ifdef BASERENDER2D\nvarying vec2 v_texcoord;varying vec4 v_color;varying vec2 v_cliped;uniform vec3 u_NMatrix_0;uniform vec3 u_NMatrix_1;uniform vec2 u_baseRenderSize2D;uniform vec4 u_baseRenderColor;uniform vec4 u_clipMatDir;uniform vec2 u_clipMatPos;struct vertexInfo{vec4 color;vec2 uv;vec2 pos;vec2 lightUV;};\n#ifdef LIGHT2D_ENABLE\nvarying vec2 v_lightUV;uniform vec4 u_LightAndShadow2DParam;uniform vec3 u_LightAndShadow2DSceneInv0;uniform vec3 u_LightAndShadow2DSceneInv1;uniform vec3 u_LightAndShadow2DStageMat0;uniform vec3 u_LightAndShadow2DStageMat1;void lightAndShadow(vertexInfo info){v_lightUV=info.lightUV;}void invertMat(inout vec3 v1,inout vec3 v2){float a1=v1.x;float b1=v2.x;float c1=v1.y;float d1=v2.y;float tx1=v1.z;float ty1=v2.z;float n=a1*d1-b1*c1;v1.x=d1/n;v2.x=-b1/n;v1.y=-c1/n;v2.y=a1/n;v1.z=(c1*ty1-d1*tx1)/n;v2.z=-(a1*ty1-b1*tx1)/n;}\n#endif\nvoid transfrom(vec2 pos,vec3 xDir,vec3 yDir,out vec2 outPos){outPos.x=xDir.x*pos.x+xDir.y*pos.y+xDir.z;outPos.y=yDir.x*pos.x+yDir.y*pos.y+yDir.z;}void getGlobalPos(in vec2 localPos,out vec2 globalPos){transfrom(localPos,u_NMatrix_0,u_NMatrix_1,globalPos);}void getViewPos(in vec2 globalPos,out vec2 viewPos){\n#ifdef CAMERA2D\nviewPos.xy=(u_view2D*vec3(globalPos,1.0)).xy+u_baseRenderSize2D/2.;\n#else\nviewPos.xy=globalPos;\n#endif\n}void getVertexInfo(inout vertexInfo info){info.pos=a_position.xy;info.color=vec4(1.0,1.0,1.0,1.0);\n#ifdef COLOR\ninfo.color=a_color;\n#endif\ninfo.color*=u_baseRenderColor;\n#ifdef UV\ninfo.uv=a_uv;\n#endif\n#ifdef LIGHT2D_ENABLE\nvec2 global;vec3 stageInv0=vec3(u_LightAndShadow2DStageMat0.x,u_LightAndShadow2DStageMat0.y,u_LightAndShadow2DStageMat0.z);vec3 stageInv1=vec3(u_LightAndShadow2DStageMat1.x,u_LightAndShadow2DStageMat1.y,u_LightAndShadow2DStageMat1.z);invertMat(stageInv0,stageInv1);getGlobalPos(info.pos,global);transfrom(global,stageInv0,stageInv1,global);transfrom(global,u_LightAndShadow2DSceneInv0,u_LightAndShadow2DSceneInv1,global);transfrom(global,u_LightAndShadow2DStageMat0,u_LightAndShadow2DStageMat1,global);info.lightUV.x=(global.x-u_LightAndShadow2DParam.x)/u_LightAndShadow2DParam.z;info.lightUV.y=1.0-(global.y-u_LightAndShadow2DParam.y)/u_LightAndShadow2DParam.w;\n#endif\n}vec2 getClipedInfo(vec2 screenPos){vec2 cliped;float clipw=length(u_clipMatDir.xy);float cliph=length(u_clipMatDir.zw);vec2 clippos=screenPos-u_clipMatPos.xy;if(clipw>20000.&&cliph>20000.)cliped=vec2(0.5,0.5);else{cliped=vec2(dot(clippos,u_clipMatDir.xy)/clipw/clipw,dot(clippos,u_clipMatDir.zw)/cliph/cliph);}return cliped;}void getProjectPos(in vec2 viewPos,out vec4 projectPos){projectPos=vec4((viewPos.x/u_baseRenderSize2D.x-0.5)*2.0,(0.5-viewPos.y/u_baseRenderSize2D.y)*2.0,0.,1.0);\n#ifdef INVERTY\nprojectPos.y=-projectPos.y;\n#endif\n}void getPosition(inout vec4 pos){vec2 globalPos;getGlobalPos(a_position.xy,globalPos);vec2 viewPos;getViewPos(globalPos,viewPos);v_cliped=getClipedInfo(viewPos);getProjectPos(viewPos,pos);}\n#endif\n'),gi.addInclude("Sprite2DShaderInfo.glsl","\n#if defined(PRIMITIVEMESH)\nstruct vertexInfo{vec4 color;vec2 cliped;};\n#elif defined(TEXTUREVS)\nstruct vertexInfo{vec4 color;vec2 cliped;vec4 texcoordAlpha;float useTex;};\n#endif\n"),gi.addInclude("Color.glsl",'#if !defined(Color_lib)\n#define Color_lib\n#include "Math.glsl";\nvec3 linearToGamma(in vec3 value){return pow(value,vec3(1.0/2.2));}vec4 linearToGamma(in vec4 value){return vec4(linearToGamma(value.rgb),value.a);}vec3 gammaToLinear(in vec3 value){return pow(value,vec3(2.2));}vec4 gammaToLinear(in vec4 value){return vec4(gammaToLinear(value.rgb),value.a);}const float c_RGBDMaxRange=255.0;vec4 encodeRGBD(in vec3 color){float maxRGB=max(vecmax(color),FLT_EPS);float d=max(1.0,c_RGBDMaxRange/maxRGB);d=saturate(d/255.0);vec3 rgb=color.rgb*d;rgb=saturate(rgb);return vec4(rgb,d);}vec3 decodeRGBD(in vec4 rgbd){vec3 color=rgbd.rgb*(1.0/rgbd.a);return color;}vec4 encodeRGBM(in vec3 color,float range){color*=1.0/range;float maxRGB=max(vecmax(color),FLT_EPS);float m=ceil(maxRGB*255.0)/255.0;vec3 rgb=color.rgb*1.0/m;vec4 rgbm=vec4(rgb,m);return rgbm;}vec3 decodeRGBM(in vec4 rgbm,float range){return range*rgbm.rgb*rgbm.a;}\n#include "OutputTransform.glsl";\n#endif\n'),gi.addInclude("Math.glsl","#if !defined(Math_lib)\n#define Math_lib\n#ifndef GRAPHICS_API_GLES3\nmat2 inverse(mat2 m){return mat2(m[1][1],-m[0][1],-m[1][0],m[0][0])/(m[0][0]*m[1][1]-m[0][1]*m[1][0]);}mat3 inverse(mat3 m){float a00=m[0][0],a01=m[0][1],a02=m[0][2];float a10=m[1][0],a11=m[1][1],a12=m[1][2];float a20=m[2][0],a21=m[2][1],a22=m[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}mat4 inverse(mat4 m){float a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;return mat4(a11*b11-a12*b10+a13*b09,a02*b10-a01*b11-a03*b09,a31*b05-a32*b04+a33*b03,a22*b04-a21*b05-a23*b03,a12*b08-a10*b11-a13*b07,a00*b11-a02*b08+a03*b07,a32*b02-a30*b05-a33*b01,a20*b05-a22*b02+a23*b01,a10*b10-a11*b08+a13*b06,a01*b08-a00*b10-a03*b06,a30*b04-a31*b02+a33*b00,a21*b02-a20*b04-a23*b00,a11*b07-a10*b09-a12*b06,a00*b09-a01*b07+a02*b06,a31*b01-a30*b03-a32*b00,a20*b03-a21*b01+a22*b00)/det;}mat4 transpose(mat4 m){return mat4(m[0][0],m[1][0],m[2][0],m[3][0],m[0][1],m[1][1],m[2][1],m[3][1],m[0][2],m[1][2],m[2][2],m[3][2],m[0][3],m[1][3],m[2][3],m[3][3]);}mat3 transpose(mat3 m){return mat3(m[0][0],m[1][0],m[2][0],m[0][1],m[1][1],m[2][1],m[0][2],m[1][2],m[2][2]);}\n#endif\n#define PI 3.14159265359\n#define INVERT_PI 0.31830988618\n#define HALF_PI 1.570796327\n#define MEDIUMP_FLT_MAX 65504.0\n#define MEDIUMP_FLT_MIN 0.00006103515625\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n#define FLT_EPS 1e-5\n#define saturateMediump(x) x\n#else\n#define FLT_EPS MEDIUMP_FLT_MIN\n#define saturateMediump(x) min(x, MEDIUMP_FLT_MAX)\n#endif\n#define saturate(x) clamp(x, 0.0, 1.0)\nfloat pow2(float x){return x*x;}vec3 pow2(vec3 x){return x*x;}float pow5(float x){float x2=x*x;return x2*x2*x;}const float INVERT_LOG10=0.43429448190325176;float log10(float x){return log(x)*INVERT_LOG10;}float vecmax(const vec2 v){return max(v.x,v.y);}float vecmax(const vec3 v){return max(v.x,max(v.y,v.z));}float vecmax(const vec4 v){return max(max(v.x,v.y),max(v.z,v.w));}float vecmin(const vec2 v){return min(v.x,v.y);}float vecmin(const vec3 v){return min(v.x,min(v.y,v.z));}float vecmin(const vec4 v){return min(min(v.x,v.y),min(v.z,v.w));}vec3 SafeNormalize(in vec3 inVec){float dp3=max(0.001,dot(inVec,inVec));return inVec*inversesqrt(dp3);}vec3 normalScale(in vec3 normal,in float scale){normal*=vec3(scale,scale,1.0);return normalize(normal);}/***Approximates acos(x)with a max absolute error of 9.0x10^-3.*Valid in the range-1..1.*/float acosFast(float x){float y=abs(x);float p=-0.1565827*y+1.570796;p*=sqrt(1.0-y);return x>=0.0 ? p : PI-p;}/***Approximates acos(x)with a max absolute error of 9.0x10^-3.*Valid only in the range 0..1.*/float acosFastPositive(float x){float p=-0.1565827*x+1.570796;return p*sqrt(1.0-x);}/**Random number between 0 and 1,using interleaved gradient noise.*w must not be normalized(e.g. window coordinates)*/float interleavedGradientNoise(const highp vec2 w){const vec3 m=vec3(0.06711056,0.00583715,52.9829189);return fract(m.z*fract(dot(w,m.xy)));}/**vertex rotate by Euler*/vec3 rotationByEuler(in vec3 vector,in vec3 rot){float halfRoll=rot.z*0.5;float halfPitch=rot.x*0.5;float halfYaw=rot.y*0.5;float sinRoll=sin(halfRoll);float cosRoll=cos(halfRoll);float sinPitch=sin(halfPitch);float cosPitch=cos(halfPitch);float sinYaw=sin(halfYaw);float cosYaw=cos(halfYaw);float quaX=(cosYaw*sinPitch*cosRoll)+(sinYaw*cosPitch*sinRoll);float quaY=(sinYaw*cosPitch*cosRoll)-(cosYaw*sinPitch*sinRoll);float quaZ=(cosYaw*cosPitch*sinRoll)-(sinYaw*sinPitch*cosRoll);float quaW=(cosYaw*cosPitch*cosRoll)+(sinYaw*sinPitch*sinRoll);float x=quaX+quaX;float y=quaY+quaY;float z=quaZ+quaZ;float wx=quaW*x;float wy=quaW*y;float wz=quaW*z;float xx=quaX*x;float xy=quaX*y;float xz=quaX*z;float yy=quaY*y;float yz=quaY*z;float zz=quaZ*z;return vec3(((vector.x*((1.0-yy)-zz))+(vector.y*(xy-wz)))+(vector.z*(xz+wy)),((vector.x*(xy+wz))+(vector.y*((1.0-xx)-zz)))+(vector.z*(yz-wx)),((vector.x*(xz-wy))+(vector.y*(yz+wx)))+(vector.z*((1.0-xx)-yy)));}/**Assume that axis has been normalized*point rotate by one axis*/vec3 rotationByAxis(in vec3 vector,in vec3 axis,in float angle){float halfAngle=angle*0.5;float sinf=sin(halfAngle);float quaX=axis.x*sinf;float quaY=axis.y*sinf;float quaZ=axis.z*sinf;float quaW=cos(halfAngle);float x=quaX+quaX;float y=quaY+quaY;float z=quaZ+quaZ;float wx=quaW*x;float wy=quaW*y;float wz=quaW*z;float xx=quaX*x;float xy=quaX*y;float xz=quaX*z;float yy=quaY*y;float yz=quaY*z;float zz=quaZ*z;return vec3(((vector.x*((1.0-yy)-zz))+(vector.y*(xy-wz)))+(vector.z*(xz+wy)),((vector.x*(xy+wz))+(vector.y*((1.0-xx)-zz)))+(vector.z*(yz-wx)),((vector.x*(xz-wy))+(vector.y*(yz+wx)))+(vector.z*((1.0-xx)-yy)));}/**rotate by quaternions*/vec3 rotationByQuaternions(in vec3 v,in vec4 q){return v+2.0*cross(q.xyz,cross(q.xyz,v)+q.w*v);}\n#endif\n"),Ui.textureShader=gi.add("Sprite2DTexture",!1,!1),Ui.textureShader.shaderType=e.ShaderFeatureType.D2_TextureSV;let t=new _i(Ui.textureAttribute,{},{});Ui.textureShader.addSubShader(t),t.addShaderPass('#define SHADER_NAME TextureVS2D\n#include "Sprite2DVertex.glsl";\nvoid main(){vec4 pos;getPosition(pos);vertexInfo info;getVertexInfo(info);v_texcoordAlpha=info.texcoordAlpha;v_useTex=info.useTex;v_color=info.color;gl_Position=pos;}','#define SHADER_NAME TextureFS2D\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n#include "Sprite2DFrag.glsl";\nvoid main(){clip();vec4 color=getSpriteTextureColor();setglColor(color);}'),Ui.primitiveShader=gi.add("Sprite2DPrimitive",!1,!1),Ui.primitiveShader.shaderType=e.ShaderFeatureType.D2_primitive,t=new _i(Ui.primitiveAttribute,{},{}),Ui.primitiveShader.addSubShader(t),t.addShaderPass('#define SHADER_NAME PrimitiveVS2D\n#include "Sprite2DVertex.glsl";\n#ifdef WORLDMAT\nuniform mat4 mmat;\n#endif\nvoid main(){vec4 pos;getPosition(pos);vertexInfo info;getVertexInfo(info);v_color=info.color;v_cliped=info.cliped;gl_Position=pos;}','#define SHADER_NAME PrimitiveFS2D\nprecision mediump float;\n#include "Sprite2DFrag.glsl";\nvoid main(){clip();gl_FragColor=getGlColor(v_color);gl_FragColor.rgb*=gl_FragColor.a;}'),Ui.render2DNodeShader=gi.add("baseRender2D",!1,!1),Ui.render2DNodeShader.shaderType=e.ShaderFeatureType.D2_BaseRednerNode2D,t=new _i(Ui.Render2DNodeAttribute,{},{}),Ui.render2DNodeShader.addSubShader(t),t.addShaderPass('#define SHADER_NAME BaseRender2DVS\n#include "Sprite2DVertex.glsl";\nvoid main(){vec4 pos;getPosition(pos);vertexInfo info;getVertexInfo(info);v_texcoord=info.uv;v_color=info.color;\n#ifdef LIGHT2D_ENABLE\nlightAndShadow(info);\n#endif\ngl_Position=pos;}','#define SHADER_NAME BaseRender2DPS\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n#include "Sprite2DFrag.glsl";\nvoid main(){clip();vec4 textureColor=texture2D(u_baseRender2DTexture,v_texcoord);\n#ifdef LIGHT2D_ENABLE\nlightAndShadow(textureColor);\n#endif\ntextureColor=transspaceColor(textureColor);setglColor(textureColor);}')}}Ui.primitiveAttribute={a_position:[0,e.ShaderDataType.Vector4],a_attribColor:[1,e.ShaderDataType.Vector4]},Ui.textureAttribute={a_posuv:[0,e.ShaderDataType.Vector4],a_attribColor:[1,e.ShaderDataType.Vector4],a_attribFlags:[2,e.ShaderDataType.Vector4]},Ui.Render2DNodeAttribute={a_position:[0,e.ShaderDataType.Vector4],a_color:[1,e.ShaderDataType.Vector4],a_uv:[2,e.ShaderDataType.Vector2]};class ki{static __init__(){ki.TEXTURE2D=gi.getDefineByName("TEXTURE2D"),ki.PRIMITIVE=gi.getDefineByName("PRIMITIVE"),ki.FILTERGLOW=gi.getDefineByName("GLOW_FILTER"),ki.FILTERBLUR=gi.getDefineByName("BLUR_FILTER"),ki.FILTERCOLOR=gi.getDefineByName("COLOR_FILTER"),ki.COLORADD=gi.getDefineByName("COLOR_ADD"),ki.WORLDMAT=gi.getDefineByName("WORLDMAT"),ki.FILLTEXTURE=gi.getDefineByName("FILLTEXTURE"),ki.MVP3D=gi.getDefineByName("MVP3D"),ki.GAMMASPACE=gi.getDefineByName("GAMMASPACE"),ki.INVERTY=gi.getDefineByName("INVERTY"),ki.GAMMATEXTURE=gi.getDefineByName("GAMMATEXTURE"),ki.TEXTURESHADER=gi.getDefineByName("TEXTUREVS"),ki.PRIMITIVESHADER=gi.getDefineByName("PRIMITIVEMESH"),ki.initSprite2DCommandEncoder()}static initSprite2DCommandEncoder(){ki.UNIFORM_MMAT=gi.propertyNameToID("u_mmat"),ki.UNIFORM_CLIPMATDIR=gi.propertyNameToID("u_clipMatDir"),ki.UNIFORM_CLIPMATPOS=gi.propertyNameToID("u_clipMatPos"),ki.UNIFORM_MMAT2=gi.propertyNameToID("u_mmat2"),ki.UNIFORM_SIZE=gi.propertyNameToID("u_size"),ki.UNIFORM_VERTALPHA=gi.propertyNameToID("u_VertAlpha"),ki.UNIFORM_MVPMatrix=gi.propertyNameToID("u_MvpMatrix"),ki.UNIFORM_SPRITETEXTURE=gi.propertyNameToID("u_spriteTexture"),ki.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1=gi.propertyNameToID("u_strength_sig2_2sig2_gauss1"),ki.UNIFORM_BLURINFO=gi.propertyNameToID("u_blurInfo"),ki.UNIFORM_COLORALPHA=gi.propertyNameToID("u_colorAlpha"),ki.UNIFORM_COLORMAT=gi.propertyNameToID("u_colorMat"),ki.UNIFORM_COLOR=gi.propertyNameToID("u_color"),ki.UNIFORM_BLURINFO1=gi.propertyNameToID("u_blurInfo1"),ki.UNIFORM_BLURINFO2=gi.propertyNameToID("u_blurInfo2"),ki.UNIFORM_COLORADD=gi.propertyNameToID("u_colorAdd"),ki.UNIFORM_TEXRANGE=gi.propertyNameToID("u_TexRange");const t=g.renderDeviceFactory.createGlobalUniformMap("Sprite2D");t.addShaderUniform(ki.UNIFORM_MMAT,"u_mmat",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ki.UNIFORM_CLIPMATDIR,"u_clipMatDir",e.ShaderDataType.Vector4),t.addShaderUniform(ki.UNIFORM_CLIPMATPOS,"u_clipMatPos",e.ShaderDataType.Vector2),t.addShaderUniform(ki.UNIFORM_MMAT2,"u_mmat2",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ki.UNIFORM_SIZE,"u_size",e.ShaderDataType.Vector2),t.addShaderUniform(ki.UNIFORM_VERTALPHA,"u_VertAlpha",e.ShaderDataType.Float),t.addShaderUniform(ki.UNIFORM_MVPMatrix,"u_MvpMatrix",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ki.UNIFORM_SPRITETEXTURE,"u_spriteTexture",e.ShaderDataType.Texture2D),t.addShaderUniform(ki.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,"u_strength_sig2_2sig2_gauss1",e.ShaderDataType.Vector4),t.addShaderUniform(ki.UNIFORM_BLURINFO,"u_blurInfo",e.ShaderDataType.Vector2),t.addShaderUniform(ki.UNIFORM_COLORALPHA,"u_colorAlpha",e.ShaderDataType.Vector4),t.addShaderUniform(ki.UNIFORM_COLORMAT,"u_colorMat",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ki.UNIFORM_COLOR,"u_color",e.ShaderDataType.Vector4),t.addShaderUniform(ki.UNIFORM_BLURINFO1,"u_blurInfo1",e.ShaderDataType.Vector4),t.addShaderUniform(ki.UNIFORM_BLURINFO2,"u_blurInfo2",e.ShaderDataType.Vector4),t.addShaderUniform(ki.UNIFORM_COLORADD,"u_colorAdd",e.ShaderDataType.Vector4),t.addShaderUniform(ki.UNIFORM_TEXRANGE,"u_TexRange",e.ShaderDataType.Vector4)}}e.RenderSpriteData=void 0,(Fi=e.RenderSpriteData||(e.RenderSpriteData={}))[Fi.Zero=0]="Zero",Fi[Fi.Texture2D=1]="Texture2D",Fi[Fi.Primitive=2]="Primitive";class Gi{constructor(t){this._needRelease=!1,this.mainID=e.RenderSpriteData.Zero,this.ref=1,this._cacheID=0,this.mainID=t,Gi.prototype.initialize.call(this)}initialize(){let t=this.mainID;this.shaderData=this.shaderData||g.renderDeviceFactory.createShaderData(null),this.mainID==e.RenderSpriteData.Texture2D&&this.shaderData.addDefine(ki.TEXTURESHADER),this.mainID==e.RenderSpriteData.Primitive&&this.shaderData.addDefine(ki.PRIMITIVESHADER),this.textureHost=null,this.clipMatDir=new s(Ue.MAX_CLIP_SIZE,0,0,Ue.MAX_CLIP_SIZE),this.clipMatPos=new Gt,this._cacheID=t;let i=Gi._cache[this._cacheID];t>0&&!i&&(i=Gi._cache[this._cacheID]=[],i._length=0),this.shaderData.setBool(gi.DEPTH_WRITE,!1),this.shaderData.setInt(gi.DEPTH_TEST,At.DEPTHTEST_OFF),this.shaderData.setInt(gi.BLEND,At.BLEND_ENABLE_ALL),this.shaderData.setInt(gi.BLEND_EQUATION,At.BLENDEQUATION_ADD),this.shaderData.setInt(gi.BLEND_SRC,At.BLENDPARAM_ONE),this.shaderData.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA),this.shaderData.setNumber(ki.UNIFORM_VERTALPHA,1),this.shaderData.setInt(gi.CULL,At.CULL_NONE)}reinit(){this.initialize()}static _initone(e,t){Gi._compileDefine=g.unitRenderModuleDataFactory.createDefineDatas(),Gi._typeClass[e]=t,Gi._cache[e]=[],Gi._cache[e]._length=0}static create(e){var t=Gi._cache[e]?Gi._cache[e]:[];if(t._length){let e=t[--t._length];return e.reinit(),e}return new Gi._typeClass[e]}set size(e){this.shaderData.setVector2(ki.UNIFORM_SIZE,e)}get size(){return this.shaderData.getVector2(ki.UNIFORM_SIZE)}set vertAlpha(e){this.shaderData.setNumber(ki.UNIFORM_VERTALPHA,e)}get vertAlpha(){return this.shaderData.getNumber(ki.UNIFORM_VERTALPHA)}set mmat(e){this.shaderData.setMatrix4x4(ki.UNIFORM_MMAT,e)}get mmat(){return this.shaderData.getMatrix4x4(ki.UNIFORM_MMAT)}set u_MvpMatrix(e){this.shaderData.setMatrix4x4(ki.UNIFORM_MVPMatrix,e)}get u_MvpMatrix(){return this.shaderData.getMatrix4x4(ki.UNIFORM_MVPMatrix)}get textureHost(){return this._textureHost}set textureHost(e){this._textureHost=e;let t,i=!1;this.textureHost&&(this.textureHost instanceof M?i=1!=this.textureHost.gammaCorrection:this.textureHost instanceof fe&&this.textureHost.bitmap&&(i=1!=this.textureHost.bitmap.gammaCorrection)),i?this.shaderData.addDefine(ki.GAMMATEXTURE):this.shaderData.removeDefine(ki.GAMMATEXTURE),t=e instanceof fe?e.bitmap:e,this.shaderData.setTexture(ki.UNIFORM_SPRITETEXTURE,t)}set color(e){e&&this.shaderData.setVector(ki.UNIFORM_COLOR,e)}get color(){return this.shaderData.getVector(ki.UNIFORM_COLOR)}set colorAdd(e){this.shaderData.setVector(ki.UNIFORM_COLORADD,e)}get colorAdd(){return this.shaderData.getVector(ki.UNIFORM_COLORADD)}set clipMatDir(e){this.shaderData.setVector(ki.UNIFORM_CLIPMATDIR,e)}get clipMatDir(){return this.shaderData.getVector(ki.UNIFORM_CLIPMATDIR)}set clipMatPos(e){this.shaderData.setVector2(ki.UNIFORM_CLIPMATPOS,e)}get clipMatPos(){return this.shaderData.getVector2(ki.UNIFORM_CLIPMATPOS)}upload(e,t){}setFilter(e){e&&this.shaderData.addDefine(e.typeDefine)}clear(){this.shaderData&&this.shaderData.clearDefine(),this.textureHost=null}blendNormal(){this.shaderData.setInt(gi.BLEND_SRC,At.BLENDPARAM_SRC_ALPHA),this.shaderData.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}blendPremulAlpha(){this.shaderData.setInt(gi.BLEND_SRC,At.BLENDPARAM_ONE),this.shaderData.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}blendAdd(){this.shaderData.setInt(gi.BLEND_SRC,At.BLENDPARAM_ONE),this.shaderData.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE)}blendMask(){this.shaderData.setInt(gi.BLEND_SRC,At.BLENDPARAM_ZERO),this.shaderData.setInt(gi.BLEND_DST,At.BLENDPARAM_SRC_ALPHA)}release(){if(--this.ref<1){let e=Gi._cache[this._cacheID];e&&(e[e._length++]=this),this.clear(),this.filters=null,this.ref=1}}}Gi._cache=[],Gi._typeClass=[];const Vi=15*Math.PI/180,zi=new Array(256),Hi=new Array(4),Wi=new Gt;class Yi{static _checkMinAngle(e,t,i,r,s,a){const n=i-e,o=r-t,h=s-i,l=a-r,u=(n*h+o*l)/(Math.sqrt(n*n+o*o)*Math.sqrt(h*h+l*l)),d=Math.acos(Math.abs(u));return Math.abs(d)<Vi}static createLine2(e,t,i,r,s,a){if(e.length<4)return null;let n=r;var o=zi.length>e.length+2?zi:new Array(e.length+2);o[0]=e[0],o[1]=e[1];var h=2,l=0,u=e.length;for(l=2;l<u;l+=2)Math.abs(e[l]-e[l-2])+Math.abs(e[l+1]-e[l-1])>.01&&(o[h++]=e[l],o[h++]=e[l+1]);let d=Math.abs(e[0]-o[h-2])+Math.abs(e[1]-o[h-1]);a&&d>0&&(d>1e-13?(o[h++]=e[0],o[h++]=e[1]):(o[h-2]=e[0],o[h-1]=e[1]));var c=s;u=h/2;var _,p,g,m,f,T,y=i/2;for(_=o[0],p=o[1],g=o[2],m=o[3],this.getNormal(_,p,g,m,y,Wi),c.push(_-Wi.x,p-Wi.y,_+Wi.x,p+Wi.y),l=1;l<u-1;l++)_=o[2*(l-1)],p=o[2*(l-1)+1],g=o[2*l],m=o[2*l+1],f=o[2*(l+1)],T=o[2*(l+1)+1],t.push(r+0,r+1,r+3,r+3,r+2,r+0),r+=2,r+=this._setMiddleVertexs(_,p,g,m,f,T,y,c,Wi,t,r);if(_=o[h-4],p=o[h-3],g=o[h-2],m=o[h-1],this.getNormal(_,p,g,m,y,Wi),c.push(g-Wi.x,m-Wi.y,g+Wi.x,m+Wi.y),t.push(r+0,r+1,r+3,r+3,r+2,r+0),g==o[0]&&m==o[1]){f=o[2],T=o[3];let e=c.length/2;r+=4,Hi[0]=n+e-2,Hi[1]=n+e-1,Hi[2]=n,Hi[3]=n+1,this._setMiddleVertexs(_,p,g,m,f,T,y,c,Wi,t,r,Hi)}return c}static _setMiddleVertexs(e,t,i,r,s,a,n,o,h,l,u,d=null){this.getNormal(e,t,i,r,n,h);let c=h.x,_=h.y;this.getNormal(i,r,s,a,n,h);let p=h.x,g=h.y;if(this._checkMinAngle(e,t,i,r,s,a))return d?l.push(d[0],d[1],d[3],d[3],d[2],d[0]):(o.push(i-c,r-_,i+c,r+_),o.push(i-p,r-g,i+p,r+g),l.push(u+0,u+1,u+3,u+3,u+2,u+0)),2;let m=-_+t-(-_+r),f=-c+i-(-c+e),T=(-c+e)*(-_+r)-(-c+i)*(-_+t),y=-g+a-(-g+r),x=-p+i-(-p+s),v=(-p+s)*(-g+r)-(-p+i)*(-g+a),S=m*x-y*f;if(S=m*x-y*f,Math.abs(S)<.1)return S+=10.1,o.push(i-c,r-_,i+c,r+_),0;let D=(f*v-x*T)/S,E=(y*T-m*v)/S;return d?S>0?(o.push(D,E,i,r),l.push(d[0],u+0,d[2]),l.push(d[2],u+1,d[0])):(o.push(i-(D-i),r-(E-r),i,r),l.push(d[1],u+0,d[3]),l.push(d[3],u+1,d[1])):(o.push(i-c,r-_,i+c,r+_),S>0?(o.push(D,E,i,r),l.push(u+0,u+2,u+4),l.push(u+4,u+3,u+0)):(o.push(i-(D-i),r-(E-r),i,r),l.push(u+1,u+2,u+5),l.push(u+5,u+3,u+1)),o.push(i-p,r-g,i+p,r+g)),4}static getNormal(e,t,i,r,s,a){a||(a=new Gt);let n=r-t,o=e-i,h=Math.sqrt(n*n+o*o);return a.x=n/h*s,a.y=o/h*s,a}static createLineTriangle(e,t,i,r,s,a,n){var o=e.slice(),h=o.length,l=o[0],u=o[1],d=o[2],c=(o[2],0),_=0,p=0,g=0,m=h/2;if(!(m<=1)&&2!=m){for(var f=new Array(4*m),T=0,y=0,x=0;x<m-1;x++)l=o[y++],u=o[y++],d=o[y++],g=o[y++]-u,0!=(p=d-l)&&0!=g&&(c=Math.sqrt(p*p+g*g))>.001&&(f[_=4*T]=l,f[_+1]=u,f[_+2]=p/c,f[_+3]=g/c,T++);for(r?(l=o[h-2],u=o[h-1],d=o[0],g=o[1]-u,0!=(p=d-l)&&0!=g&&(c=Math.sqrt(p*p+g*g))>.001&&(f[_=4*T]=l,f[_+1]=u,f[_+2]=p/c,f[_+3]=g/c,T++)):(f[_=4*T]=l,f[_+1]=u,f[_+2]=p/c,f[_+3]=g/c,T++),y=0,x=0;x<m;x++)l=o[y],u=o[y+1],d=o[y+2],o[y+3]}}}class Xi{constructor(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}class qi{static earcut(e,t,i){i=i||2;var r,s,a,n,o,h,l,u=t&&t.length,d=u?t[0]*i:e.length,c=qi.linkedList(e,0,d,i,!0),_=[];if(!c)return _;if(u&&(c=qi.eliminateHoles(e,t,c,i)),e.length>80*i){r=a=e[0],s=n=e[1];for(var p=i;p<d;p+=i)(o=e[p])<r&&(r=o),(h=e[p+1])<s&&(s=h),o>a&&(a=o),h>n&&(n=h);l=0!==(l=Math.max(a-r,n-s))?1/l:0}return qi.earcutLinked(c,_,i,r,s,l),_}static linkedList(e,t,i,r,s){var a,n;if(s===qi.signedArea(e,t,i,r)>0)for(a=t;a<i;a+=r)n=qi.insertNode(a,e[a],e[a+1],n);else for(a=i-r;a>=t;a-=r)n=qi.insertNode(a,e[a],e[a+1],n);return n&&qi.equals(n,n.next)&&(qi.removeNode(n),n=n.next),n}static filterPoints(e,t){if(!e)return e;t||(t=e);var i,r=e;do{if(i=!1,r.steiner||!qi.equals(r,r.next)&&0!==qi.area(r.prev,r,r.next))r=r.next;else{if(qi.removeNode(r),(r=t=r.prev)===r.next)break;i=!0}}while(i||r!==t);return t}static earcutLinked(e,t,i,r,s,a,n=null){if(e){!n&&a&&qi.indexCurve(e,r,s,a);for(var o,h,l=e;e.prev!==e.next;)if(o=e.prev,h=e.next,a?qi.isEarHashed(e,r,s,a):qi.isEar(e))t.push(o.i/i),t.push(e.i/i),t.push(h.i/i),qi.removeNode(e),e=h.next,l=h.next;else if((e=h)===l){n?1===n?(e=qi.cureLocalIntersections(e,t,i),qi.earcutLinked(e,t,i,r,s,a,2)):2===n&&qi.splitEarcut(e,t,i,r,s,a):qi.earcutLinked(qi.filterPoints(e,null),t,i,r,s,a,1);break}}}static isEar(e){var t=e.prev,i=e,r=e.next;if(qi.area(t,i,r)>=0)return!1;for(var s=e.next.next;s!==e.prev;){if(qi.pointInTriangle(t.x,t.y,i.x,i.y,r.x,r.y,s.x,s.y)&&qi.area(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}static isEarHashed(e,t,i,r){var s=e.prev,a=e,n=e.next;if(qi.area(s,a,n)>=0)return!1;for(var o=s.x<a.x?s.x<n.x?s.x:n.x:a.x<n.x?a.x:n.x,h=s.y<a.y?s.y<n.y?s.y:n.y:a.y<n.y?a.y:n.y,l=s.x>a.x?s.x>n.x?s.x:n.x:a.x>n.x?a.x:n.x,u=s.y>a.y?s.y>n.y?s.y:n.y:a.y>n.y?a.y:n.y,d=qi.zOrder(o,h,t,i,r),c=qi.zOrder(l,u,t,i,r),_=e.nextZ;_&&_.z<=c;){if(_!==e.prev&&_!==e.next&&qi.pointInTriangle(s.x,s.y,a.x,a.y,n.x,n.y,_.x,_.y)&&qi.area(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=e.prevZ;_&&_.z>=d;){if(_!==e.prev&&_!==e.next&&qi.pointInTriangle(s.x,s.y,a.x,a.y,n.x,n.y,_.x,_.y)&&qi.area(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}static cureLocalIntersections(e,t,i){var r=e;do{var s=r.prev,a=r.next.next;!qi.equals(s,a)&&qi.intersects(s,r,r.next,a)&&qi.locallyInside(s,a)&&qi.locallyInside(a,s)&&(t.push(s.i/i),t.push(r.i/i),t.push(a.i/i),qi.removeNode(r),qi.removeNode(r.next),r=e=a),r=r.next}while(r!==e);return r}static splitEarcut(e,t,i,r,s,a){var n=e;do{for(var o=n.next.next;o!==n.prev;){if(n.i!==o.i&&qi.isValidDiagonal(n,o)){var h=qi.splitPolygon(n,o);return n=qi.filterPoints(n,n.next),h=qi.filterPoints(h,h.next),qi.earcutLinked(n,t,i,r,s,a),void qi.earcutLinked(h,t,i,r,s,a)}o=o.next}n=n.next}while(n!==e)}static eliminateHoles(e,t,i,r){var s,a,n,o,h,l=[];for(s=0,a=t.length;s<a;s++)n=t[s]*r,o=s<a-1?t[s+1]*r:e.length,(h=qi.linkedList(e,n,o,r,!1))===h.next&&(h.steiner=!0),l.push(qi.getLeftmost(h));for(l.sort(qi.compareX),s=0;s<l.length;s++)qi.eliminateHole(l[s],i),i=qi.filterPoints(i,i.next);return i}static compareX(e,t){return e.x-t.x}static eliminateHole(e,t){if(t=qi.findHoleBridge(e,t)){var i=qi.splitPolygon(t,e);qi.filterPoints(i,i.next)}}static findHoleBridge(e,t){var i,r=t,s=e.x,a=e.y,n=-1/0;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){var o=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(o<=s&&o>n){if(n=o,o===s){if(a===r.y)return r;if(a===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!i)return null;if(s===n)return i.prev;var h,l=i,u=i.x,d=i.y,c=1/0;for(r=i.next;r!==l;)s>=r.x&&r.x>=u&&s!==r.x&&qi.pointInTriangle(a<d?s:n,a,u,d,a<d?n:s,a,r.x,r.y)&&((h=Math.abs(a-r.y)/(s-r.x))<c||h===c&&r.x>i.x)&&qi.locallyInside(r,e)&&(i=r,c=h),r=r.next;return i}static indexCurve(e,t,i,r){var s=e;do{null===s.z&&(s.z=qi.zOrder(s.x,s.y,t,i,r)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,qi.sortLinked(s)}static sortLinked(e){var t,i,r,s,a,n,o,h,l=1;do{for(i=e,e=null,a=null,n=0;i;){for(n++,r=i,o=0,t=0;t<l&&(o++,r=r.nextZ);t++);for(h=l;o>0||h>0&&r;)0!==o&&(0===h||!r||i.z<=r.z)?(s=i,i=i.nextZ,o--):(s=r,r=r.nextZ,h--),a?a.nextZ=s:e=s,s.prevZ=a,a=s;i=r}a.nextZ=null,l*=2}while(n>1);return e}static zOrder(e,t,i,r,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*s)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}static getLeftmost(e){var t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}static pointInTriangle(e,t,i,r,s,a,n,o){return(s-n)*(t-o)-(e-n)*(a-o)>=0&&(e-n)*(r-o)-(i-n)*(t-o)>=0&&(i-n)*(a-o)-(s-n)*(r-o)>=0}static isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!qi.intersectsPolygon(e,t)&&qi.locallyInside(e,t)&&qi.locallyInside(t,e)&&qi.middleInside(e,t)}static area(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}static equals(e,t){return e.x===t.x&&e.y===t.y}static intersects(e,t,i,r){return!!(qi.equals(e,t)&&qi.equals(i,r)||qi.equals(e,r)&&qi.equals(i,t))||qi.area(e,t,i)>0!=qi.area(e,t,r)>0&&qi.area(i,r,e)>0!=qi.area(i,r,t)>0}static intersectsPolygon(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&qi.intersects(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}static locallyInside(e,t){return qi.area(e.prev,e,e.next)<0?qi.area(e,t,e.next)>=0&&qi.area(e,e.prev,t)>=0:qi.area(e,t,e.prev)<0||qi.area(e,e.next,t)<0}static middleInside(e,t){var i=e,r=!1,s=(e.x+t.x)/2,a=(e.y+t.y)/2;do{i.y>a!=i.next.y>a&&i.next.y!==i.y&&s<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==e);return r}static splitPolygon(e,t){var i=new Xi(e.i,e.x,e.y),r=new Xi(t.i,t.x,t.y),s=e.next,a=t.prev;return e.next=t,t.prev=e,i.next=s,s.prev=i,r.next=i,i.prev=r,a.next=r,r.prev=a,r}static insertNode(e,t,i,r){var s=new Xi(e,t,i);return r?(s.next=r.next,s.prev=r,r.next.prev=s,r.next=s):(s.prev=s,s.next=s),s}static removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}static signedArea(e,t,i,r){for(var s=0,a=t,n=i-r;a<i;a+=r)s+=(e[n]-e[a])*(e[a+1]+e[n+1]),n=a;return s}}class ji{constructor(){this.clear()}clear(){this.submitType=-1,this.blendShader=this.other=0}}class Ki{constructor(){this.clipInfoID=-1,this.blendType=-1,this._id=0,this._renderType=0,this._key=new ji,this._startIdx=0,this._numEle=0,this._colorFiler=null,this.shaderValue=null,this._id=++Ki.ID}static create(e,t,i){var r=new Ki;r._mesh=t,r._key.clear(),r._key.submitType=Ki.KEY_DRAWTEXTURE,r._startIdx=t.indexNum*Ue.INDEX_BYTES,r._numEle=0;var s=e._nBlendType;return r._key.blendShader=s,r.shaderValue=i,r.material=e._material,r._colorFiler=e._colorFiler,r}}Ki.KEY_ONCE=-1,Ki.KEY_FILLRECT=1,Ki.KEY_DRAWTEXTURE=2,Ki.KEY_VG=3,Ki.KEY_TRIANGLES=4,Ki.ID=1,Ki.RENDERBASE=new Ki;class $i{}$i.loopStTm=0,$i.loopCount=0;class Qi{constructor(e){this._data=[],this._ndata=0,this._clipid=-1,this._clipMatrix=new V,this._enable=!1,this._clipid=e._clipInfoID,e._globalClipMatrix.copyTo(this._clipMatrix)}clear(){this._tex=null,this._imgId=-1,this._ndata=0,this._enable=!1,this._colorFiler=null}destroy(){this.clear(),this._data.length=0,this._data=null}add(e,t,i,r,s,a){this._ndata>0&&(this._tex!=t||this._imgId!=i||this._clipid>=0&&this._clipid!=e._clipInfoID)&&this.submit(e),this._clipid=e._clipInfoID,e._globalClipMatrix.copyTo(this._clipMatrix),this._tex=t,this._imgId=i,this._colorFiler=e._colorFiler,this._data[this._ndata]=r,this._data[this._ndata+1]=s,this._data[this._ndata+2]=a,this._ndata+=3}getPos(){return 0==Qi.__nPosPool?new Array(8):Qi.__posPool[--Qi.__nPosPool]}enable(e,t){e!==this._enable&&(this._enable=e,this._enable||this.submit(t))}submit(t){var i=this._ndata;if(!i)return;t.drawLeftData();let r=Gi.create(e.RenderSpriteData.Texture2D);t.fillShaderValue(r),r.textureHost=this._tex;let s=t._mesh=t._meshQuatTex,a=t._curSubmit=Ki.create(t,s,r);a._key.other=this._imgId,a._colorFiler=this._colorFiler;var n=r.clipMatDir;let o=this._clipMatrix;n.x=o.a,n.y=o.b,n.z=o.c,n.w=o.d,r.clipMatDir=n;var h=r.clipMatPos;h.x=o.tx,h.y=o.ty,r.clipMatPos=h,a.clipInfoID=this._clipid;for(var l=0;l<i;l+=3)s.addQuad(this._data[l],this._data[l+1],this._data[l+2],!0),Qi.__posPool[Qi.__nPosPool++]=this._data[l];this._ndata=0,$i.loopCount%100==0&&(this._data.length=0),t.drawLeftData()}}Qi.__posPool=[],Qi.__nPosPool=0;class Zi{constructor(){this.isRandomTouch=!0,this.char="",this.deleted=!1,this.uv=new Array(8),this.pos=0,this.orix=0,this.oriy=0,this.touchTick=0,this.isSpace=!1}touch(){var e=$i.loopCount;this.touchTick!=e&&(this.texture.touchRect(this,e),this.touchTick=e)}}var Ji=[0,0,0,0];const er=new Zi;class tr{constructor(e){this.charRender=e}getFontSizeInfo(e,t){let i="bold "+t+"px "+e;Ji[0]=t/2,Ji[1]=t/2,Ji[2]=t,Ji[3]=t;this.charRender.scale(1,1),er.height=t,this.charRender.fontsz=t;var r=this.charRender.getCharBmp("g",i,0,"red",null,er,16,16,16,16);return this.bmpData32=new Uint32Array(r.data.buffer),this.updateBbx(r,Ji,!1),r=this.charRender.getCharBmp("有",i,0,"red",null,er,16,16,16,16),this.bmpData32=new Uint32Array(r.data.buffer),Ji[2]<16+er.width&&(Ji[2]=16+er.width),this.updateBbx(r,Ji,!1),Math.max(16-Ji[0],0)<<24|Math.max(16-Ji[1],0)<<16|Ji[2]-Ji[0]<<8|Ji[3]-Ji[1]}checkBmpLine(e,t,i,r){this.bmpData32.buffer!=e.data.buffer&&(this.bmpData32=new Uint32Array(e.data.buffer));for(var s=e.width*t+i,a=i;a<r;a++)if(0!=this.bmpData32[s++])return!0;return!1}updateBbx(e,t,i=!1){var r=e.width,s=e.height,a=0,n=t[1],o=0,h=n;if(this.checkBmpLine(e,n,0,r))for(;;){if((h=(n+o)/2|0)+1>=n){t[1]=h;break}this.checkBmpLine(e,h,0,r)?n=h:o=h}if(t[3]>s)t[3]=s;else if(h=n=t[3],o=s,this.checkBmpLine(e,n,0,r))for(;;){if((h=(n+o)/2|0)-1<=n){t[3]=h;break}this.checkBmpLine(e,h,0,r)?n=h:o=h}if(!i){var l=t[0],u=r*t[1];for(h=t[1];h<t[3];h++){for(a=0;a<l;a++)if(0!=this.bmpData32[u+a]){l=a;break}u+=r}t[0]=l;var d=t[2];for(u=r*t[1],h=t[1];h<t[3];h++){for(a=d;a<r;a++)if(0!=this.bmpData32[u+a]){d=a;break}u+=r}t[2]=d}}}class ir{constructor(e=0,t=0,i=0){this.atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._used=0,this._cells=null,this._rowInfo=null,this.atlasID=i,this._init(e,t)}addRect(e,t,i,r){return!!this._get(t,i,r)&&(this._fill(r.x,r.y,t,i,e),this._texCount++,!0)}_release(){this._cells=null,this._rowInfo=null}_init(e,t){return this._width=e,this._height=t,this._release(),0!=this._width&&(this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=new Uint8Array(this._height),this._used=0,this._clear(),!0)}_get(e,t,i){if(e>this._width||t>this._height)return!1;for(var r=-1,s=-1,a=this._width,n=this._height,o=this._cells,h=0;h<n;h++)if(!(this._rowInfo[h]<e))for(var l=0;l<a;){var u=3*(h*a+l);if(0!=o[u]||o[u+1]<e||o[u+2]<t)l+=o[u+1];else{r=l,s=h;for(var d=0;d<e;d++)if(o[3*d+u+2]<t){r=-1;break}if(!(r<0))return i.x=r,i.y=s,!0;l+=o[u+1]}}return!1}_fill(e,t,i,r,s){var a=this._width,n=this._height;this._check(e+i<=a&&t+r<=n);for(var o=t;o<r+t;++o){this._check(this._rowInfo[o]>=i),this._rowInfo[o]-=i;for(var h=0;h<i;h++){var l=3*(e+o*a+h);this._check(0==this._cells[l]),this._cells[l]=s,this._cells[l+1]=i,this._cells[l+2]=r}}if(e>0)for(o=0;o<r;++o){var u=0;for(h=e-1;h>=0&&0==this._cells[3*((t+o)*a+h)];--h,++u);for(h=u;h>0;--h)this._cells[3*((t+o)*a+e-h)+1]=h,this._check(h>0)}if(t>0)for(h=e;h<e+i;++h){for(u=0,o=t-1;o>=0&&0==this._cells[3*(h+o*a)];--o,u++);for(o=u;o>0;--o)this._cells[3*(h+(t-o)*a)+2]=o,this._check(o>0)}this._used+=i*r/(this._width*this._height)}_check(e){0==e&&console.log("xtexMerger 错误啦")}_clear(){this._texCount=0;for(var e=0;e<this._height;e++)this._rowInfo[e]=this._width;for(var t=0;t<this._height;t++)for(var i=0;i<this._width;i++){var r=3*(t*this._width+i);this._cells[r]=0,this._cells[r+1]=this._width-i,this._cells[r+2]=this._width-t}}}var rr;e.WrapMode=void 0,(rr=e.WrapMode||(e.WrapMode={}))[rr.Repeat=0]="Repeat",rr[rr.Clamp=1]="Clamp",rr[rr.Mirrored=2]="Mirrored";class sr extends _e{constructor(t=cr.atlasWidth,i=cr.atlasWidth){super(t,i,e.TextureFormat.R8G8B8A8,!1,!1,!0,!0),this._discardTm=0,this.genID=0,this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=0,this.ri=null,this.setPixelsData(null,!0,!1),this.lock=!0,this.filterMode=e.FilterMode.Bilinear,this.wrapModeU=e.WrapMode.Clamp,this.wrapModeV=e.WrapMode.Clamp,cr.debugUV&&this.fillWhite()}addChar(e,t,i,r=null){if(cr.isWan1Wan)return this.addCharCanvas(e,t,i,r);var s,a,n,o,h=e.data;return e.data instanceof Uint8ClampedArray&&(h=new Uint8Array(h.buffer)),g.textureContext.setTextureSubPixelsData(this._texture,h,0,!1,t,i,e.width,e.height,!0,!1),s=t/this.width,a=i/this.height,n=(t+e.width)/this.width,o=(i+e.height)/this.height,(r=r||new Array(8))[0]=s,r[1]=a,r[2]=n,r[3]=a,r[4]=n,r[5]=o,r[6]=s,r[7]=o,r}addCharCanvas(e,t,i,r=null){var s,a,n,o;return g.textureContext.setTextureSubImageData(this._texture,e,t,i,!0,!1),p.isConch?(s=t/this.width,a=i/this.height,n=(t+e.width)/this.width,o=(i+e.height)/this.height):(s=(t+1)/this.width,a=(i+1)/this.height,n=(t+e.width-1)/this.width,o=(i+e.height-1)/this.height),(r=r||new Array(8))[0]=s,r[1]=a,r[2]=n,r[3]=a,r[4]=n,r[5]=o,r[6]=s,r[7]=o,r}fillWhite(){var e=new Uint8Array(this.width*this.height*4);e.fill(255),g.textureContext.setTextureImageData(this._getSource(),e,!0,!1)}discard(){h.stage.setGlobalRepaint(),this.destroy()}static getTextTexture(e,t){return new sr(e,t)}static clean(){var e=$i.loopStTm;if(0===sr.cleanTm&&(sr.cleanTm=e),e-sr.cleanTm>=cr.checkCleanTextureDt){for(let i=0;i<sr.poolLen;i++){var t=sr.pool[i];e-t._discardTm>=cr.destroyUnusedTextureDt&&(t.destroy(),sr.pool[i]=sr.pool[sr.poolLen-1],sr.poolLen--,i--)}sr.cleanTm=e}}touchTexture(){let e=$i.loopCount;this.lastTouchTm!=e&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=e)}touchRect(e,t){this.lastTouchTm!=t&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=t);var i=cr.atlasWidth*cr.atlasWidth,r=ar.atlasGridW*ar.atlasGridW;this.curUsedCovRate+=e.bmpWidth*e.bmpHeight/i,this.curUsedCovRateAtlas+=Math.ceil(e.bmpWidth/ar.atlasGridW)*Math.ceil(e.bmpHeight/ar.atlasGridW)/(i/r)}}sr.pool=new Array(10),sr.poolLen=0,sr.cleanTm=0,sr.EVENT_REUSE="texture_recycling";class ar{constructor(){this.texWidth=1024,this.texHeight=1024,this.texture=null,this.charMaps={},this.texHeight=this.texWidth=cr.atlasWidth,this.texture=sr.getTextTexture(this.texWidth,this.texHeight),this.texWidth/ar.atlasGridW>256&&(ar.atlasGridW=Math.ceil(this.texWidth/256)),this.atlasgrid=new ir(this.texWidth/ar.atlasGridW,this.texHeight/ar.atlasGridW,this.texture.id)}setProtecteDist(e){}getAEmpty(e,t,i){var r=this.atlasgrid.addRect(1,Math.ceil(e/ar.atlasGridW),Math.ceil(t/ar.atlasGridW),i);return r&&(i.x*=ar.atlasGridW,i.y*=ar.atlasGridW),r}get usedRate(){return this.atlasgrid._used}destroy(){for(var e in this.charMaps){this.charMaps[e].deleted=!0}this.texture.discard()}printDebugInfo(){}}ar.atlasGridW=16;class nr{static parse(e){if(e===hr)return or;let t=nr._cache[e];return t||(t=nr._cache[e]=new nr(e)),hr=e,or=t,t}constructor(e){this._family="Arial",this._size=14,this._italic=!1,this._bold=!1,this.setFont(e||"14px Arial")}setFont(e){this._font=e;var t=e.split(" "),i=t.length;if(i<2)1==i&&t[0].indexOf("px")>0&&(this._size=parseInt(t[0]));else{var r=-1;for(let s=0;s<i;s++)if(t[s].indexOf("px")>0||t[s].indexOf("pt")>0){r=s,this._size=parseInt(t[s]),this._size<=0&&(console.debug("font parse error:"+e),this._size=14);break}var s=r+1,a=t[s];for(s++;s<i;s++)a+=" "+t[s];this._family=a.split(",")[0],this._italic=t.indexOf("italic")>=0,this._bold=t.indexOf("bold")>=0}}}nr._cache={};var or,hr="";class lr{constructor(){this.pagecharsCtx=null,this.width=-1,this.pageChars=[],this.scalex=1,this.scaley=1}setText(e){this.text=e,this._nativeObj?this._nativeObj._text=e:this.width=-1,this.cleanCache()}toString(){return this.text}get length(){return this.text?this.text.length:0}cleanCache(){if(this._nativeObj)return void this._nativeObj.cleanCache();let e=this.pageChars;if(e.length>0){for(var t in e){let i=e[t];if(!i)continue;let r=i.tex;1==i.words.length&&r&&r.ri&&r.destroy()}this.pageChars=[]}this.scalex=1,this.scaley=1}get splitRender(){return this._splitRender}set splitRender(e){this._splitRender=e,this._nativeObj&&(this._nativeObj.splitRender=e)}}class ur{constructor(){this.fontsz=16}getWidth(e,t){return 0}scale(e,t){}get canvasWidth(){return 0}set canvasWidth(e){}getCharBmp(e,t,i,r,s,a,n,o,h,l,u=null){return null}}class dr extends ur{constructor(e,t,i=!0,r=!0,s=!1){super(),this.ctx=null,this.lastScaleX=1,this.lastScaleY=1,this.maxTexW=0,this.maxTexH=0,this.scaleFontSize=!0,this.showDbgInfo=!1,this.supportImageData=!0,this.maxTexW=e,this.maxTexH=t,this.scaleFontSize=i,this.supportImageData=r,this.showDbgInfo=s,dr.canvas||(dr.canvas=I.createElement("canvas"),dr.canvas.width=1024,dr.canvas.height=512,dr.canvas.style.left="-10000px",dr.canvas.style.position="absolute",window.document.body.appendChild(dr.canvas),this.ctx=dr.canvas.getContext("2d",{willReadFrequently:!0}))}get canvasWidth(){return dr.canvas.width}set canvasWidth(e){dr.canvas.width!=e&&(dr.canvas.width=e,e>2048&&console.warn("画文字设置的宽度太大，超过2048了"),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.lastScaleX,this.lastScaleY))}getWidth(e,t){return this.ctx?(this.ctx._lastFont!=e&&(this.ctx.font=e,this.ctx._lastFont=e),this.ctx.measureText(t).width):0}scale(e,t){if(!this.supportImageData)return this.lastScaleX=e,void(this.lastScaleY=t);this.lastScaleX==e&&this.lastScaleY==t||(this.ctx.setTransform(e,0,0,t,0,0),this.lastScaleX=e,this.lastScaleY=t)}getCharBmp(e,t,i,r,s,a,n,o,h,l,u=null){if(!this.supportImageData)return this.getCharCanvas(e,t,i,r,s,a,n,o,h,l);var d=this.ctx,c=this.fontsz;d.font!=t&&(d.font=t,d._lastFont=t),a.width=d.measureText(e).width;var _=a.width*this.lastScaleX,p=a.height*this.lastScaleY;_+=(n+h)*this.lastScaleX,p+=(o+l)*this.lastScaleY,_=Math.ceil(_),p=Math.ceil(p);var g=(_=Math.min(_,dr.canvas.width))+2*i+1,m=(p=Math.min(p,dr.canvas.height))+2*i+1;u&&(g=Math.max(g,u[0]+u[2]+1),m=Math.max(m,u[1]+u[3]+1)),d.clearRect(0,0,g/this.lastScaleX+1,m/this.lastScaleY+1),d.save(),d.textBaseline="middle",i>0&&(d.lineJoin="round",d.strokeStyle=s,d.lineWidth=i,d.strokeText(e,n,o+c/2)),r&&(d.fillStyle=r,d.fillText(e,n,o+c/2)),this.showDbgInfo&&(d.strokeStyle="#ff0000",d.strokeRect(1,1,_-2,p-2),d.strokeStyle="#00ff00",d.strokeRect(n,o,a.width,a.height)),u&&(u[2]<=0&&(u[2]=Math.ceil(-u[2]+(a.width+2*i)*this.lastScaleX)),u[2]<=0&&(u[2]=1));var f=u?d.getImageData(u[0],u[1],u[2],u[3]+1):d.getImageData(0,0,_,p+1);return d.restore(),a.bmpWidth=f.width,a.bmpHeight=f.height,f}getCharCanvas(e,t,i,r,s,a,n,o,h,l){var u=this.ctx;u.font!=t&&(u.font=t,u._lastFont=t),I.window.isIOSHighPerformanceModePlus&&(u.font=t),a.width=u.measureText(e).width;var d=a.width*this.lastScaleX,c=a.height*this.lastScaleY;d+=(n+h)*this.lastScaleX,c+=(o+l)*this.lastScaleY+1,d=Math.min(Math.ceil(d),this.maxTexW),c=Math.min(Math.ceil(c),this.maxTexH),dr.canvas.width=Math.min(d+1,this.maxTexW),dr.canvas.height=Math.min(c+1,this.maxTexH),u.font=t,u.clearRect(0,0,d+1+i,c+1+i),u.setTransform(1,0,0,1,0,0),u.save(),this.scaleFontSize&&u.scale(this.lastScaleX,this.lastScaleY),u.translate(n,o),u.textAlign="left";var _=this.fontsz;return u.textBaseline="middle",i>0?(u.lineJoin="round",u.strokeStyle=s,u.fillStyle=r,u.lineWidth=i,u.fillAndStrokeText?u.fillAndStrokeText(e,0,_/2):(u.strokeText(e,0,_/2),u.fillText(e,0,_/2))):r&&(u.fillStyle=r,u.fillText(e,0,_/2)),this.showDbgInfo&&(u.strokeStyle="#ff0000",u.strokeRect(0,0,d,c),u.strokeStyle="#00ff00",u.strokeRect(0,0,a.width,a.height)),u.restore(),a.bmpWidth=dr.canvas.width,a.bmpHeight=dr.canvas.height,dr.canvas}}dr.canvas=null;class cr extends D{constructor(){super(),this.fontSizeInfo={},this.mapFont={},this.fontID=0,this.fontScaleX=1,this.fontScaleY=1,this._curStrPos=0,this.textAtlases=[],this.isoTextures=[],this.lastFont=null,this.fontSizeW=0,this.fontSizeH=0,this.fontSizeOffX=0,this.fontSizeOffY=0,this.renderPerChar=!0,this._fontMeasure=null;var e=!1,t=h.Laya.MiniAdpter;t&&t.systemInfo&&t.systemInfo.system&&(e="ios 10.1.1"===t.systemInfo.system.toLowerCase()),(h.Browser.onMiniGame||h.Browser.onTTMiniGame||h.Browser.onBLMiniGame||h.Browser.onAlipayMiniGame||h.Browser.onTBMiniGame)&&!e&&(cr.isWan1Wan=!0),this.charRender=new dr(2048,2048,cr.scaleFontWithCtx,!cr.isWan1Wan,!1),cr.textRenderInst=this,h.Laya.textRender=this}set fontMeasure(e){this._fontMeasure=e}get fontMeasure(){return this._fontMeasure}_wan1wansz(e,t){let i="bold "+t+"px "+e;var r=1.5*this.charRender.getWidth(i,"有")<<8|1.5*t;return this.fontSizeInfo[e]=r,r}getFontSizeInfo(e){var t=this.fontSizeInfo[e];return t||(t=cr.isWan1Wan?this._wan1wansz(e,cr.standardFontSize):this._fontMeasure.getFontSizeInfo(e,cr.standardFontSize),this.fontSizeInfo[e]=t),t}setFont(e){if(this.lastFont!=e){this.lastFont=e;var t=this.getFontSizeInfo(e._family),i=t>>24,r=t>>16&255,s=t>>8&255,a=255&t,n=e._size/cr.standardFontSize;this.fontSizeOffX=Math.ceil(i*n),this.fontSizeOffY=Math.ceil(r*n),this.fontSizeW=Math.ceil(s*n),this.fontSizeH=Math.ceil(a*n),e._font.indexOf("italic")>=0?this.fontStr=e._font.replace("italic",""):this.fontStr=e._font}}getNextChar(e){var t=e.length,i=this._curStrPos;if(!e.substring)return null;if(i>=t)return null;for(var r=i,s=0;r<t;r++){var a=e.charCodeAt(r);if(a>>>11==27){if(1==s)break;s=1,r++}else if(65038===a||65039===a);else if(8205==a)s=2;else if(0==s)s=1;else if(1==s)break}return this._curStrPos=r,e.substring(i,r)}filltext(e,t,i,r,s,a,n,o,h){if(!(t.length<=0)){var l=nr.parse(s),u=0;switch(h){case"center":u=Ue.ENUM_TEXTALIGN_CENTER;break;case"right":u=Ue.ENUM_TEXTALIGN_RIGHT}this._fast_filltext(e,t,i,r,l,a,n,o,u)}}_fast_filltext(e,t,i,r,s,a,n,o,h){if(t&&!(t.length>=1))return;if(o<0&&(o=0),this.setFont(s),this.fontScaleX=this.fontScaleY=1,cr.scaleFontWithCtx){let t=e.getMatScaleX(),i=e.getMatScaleY();if(t<1e-4||i<.1)return;t>1&&(this.fontScaleX=Math.min(cr.maxFontScale,t)),i>1&&(this.fontScaleY=Math.min(cr.maxFontScale,i))}s._italic&&(e._italicDeg=13);let l=t,u=t instanceof lr,d=t&&t.toString(),c=u?l.pageChars:[],_=0;switch(u?(d=l.text,_=l.width,_<0&&(_=l.width=this.charRender.getWidth(this.fontStr,d))):_=d?this.charRender.getWidth(this.fontStr,d):0,h){case Ue.ENUM_TEXTALIGN_CENTER:i-=_/2;break;case Ue.ENUM_TEXTALIGN_RIGHT:i-=_}u&&(this.hasFreedText(c)||l.pagecharsCtx!=e)&&(c=l.pageChars=[]);let p=this.renderPerChar=!u||cr.forceSplitRender||u&&l.splitRender;if(!c||c.length<1){if(u&&(l.scalex=this.fontScaleX,l.scaley=this.fontScaleY),p){let e,t=0,i=0;for(this._curStrPos=0;e=this.getNextChar(d),e;){let r=this.getCharRenderInfo(e,s,a,n,o,!1);if(!r)break;if(r.isSpace);else{var g=c[r.texture.id];if(g)g=g.words;else{var m={texgen:r.texture.genID,tex:r.texture,words:new Array};c[r.texture.id]=m,g=m.words}g.push({ri:r,x:t,y:i,w:r.bmpWidth/this.fontScaleX,h:r.bmpHeight/this.fontScaleY}),t+=r.width}}}else{let e=s._size/3|0,t=cr.noAtlas||(_+e+e)*this.fontScaleX>cr.atlasWidth,i=this.getCharRenderInfo(d,s,a,n,o,t);c[0]={texgen:i.texture.genID,tex:i.texture,words:[{ri:i,x:0,y:0,w:i.bmpWidth/this.fontScaleX,h:i.bmpHeight/this.fontScaleY}]}}u&&(l.pagecharsCtx=e)}this._drawResortedWords(e,i,r,c),e._italicDeg=0}_drawResortedWords(e,t,i,r){var s=!!e._charSubmitCache&&e._charSubmitCache._enable,a=e._curMat;for(var n in r){var o=r[n];if(o){var h=o.words,l=h.length;if(!(l<=0))for(var u=r[n].tex,d=0;d<l;d++){var c=h[d],_=c.ri;_.isSpace||(e.touchRes(_),e.drawTexAlign=!0,e._inner_drawTexture(u,u.id,t+c.x-_.orix,i+c.y-_.oriy,c.w,c.h,a,_.uv,1,s,4294967295))}}}}hasFreedText(e){for(let r in e){var t=e[r];if(t){var i=t.tex;if(i.destroyed||i.genID!=t.texgen)return!0}}return!1}getCharRenderInfo(e,t,i,r,s,a=!1){var n=this.mapFont[t._family];null==n&&(this.mapFont[t._family]=n=this.fontID++);var o=e+"_"+n+"_"+t._size+"_"+i;s>0&&(o+="_"+r+s),t._bold&&(o+="P"),1==this.fontScaleX&&1==this.fontScaleY||(o+=(20*this.fontScaleX|0)+"_"+(20*this.fontScaleY|0));var h,l,u=0,d=this.textAtlases.length;if(!a)for(u=0;u<d;u++)if(h=(l=this.textAtlases[u]).charMaps[o])return h.touch(),h;h=new Zi,this.charRender.scale(this.fontScaleX,this.fontScaleY),h.char=e,h.height=t._size;var c=t._size/3|0,_=null;s||(s=0);var p=Math.ceil((this.charRender.getWidth(this.fontStr,e)+2*s)*this.fontScaleX);let g=Math.min(2048,p+2*c*this.fontScaleX);if(g>this.charRender.canvasWidth&&(this.charRender.canvasWidth=g),a){if(this.charRender.fontsz=t._size,_=this.charRender.getCharBmp(e,this.fontStr,s,i,r,h,c,c,c,c,null))(m=sr.getTextTexture(_.width,_.height)).addChar(_,0,0,h.uv),h.texture=m,h.orix=c,h.oriy=c,m.ri=h,this.isoTextures.push(m)}else{var m,f=e.length,T=1*s,y=Math.ceil((this.fontSizeW+2*T)*this.fontScaleX),x=Math.ceil((this.fontSizeH+2*T)*this.fontScaleY);if(cr.imgdtRect[0]=(c-this.fontSizeOffX-T)*this.fontScaleX|0,cr.imgdtRect[1]=(c-this.fontSizeOffY-T)*this.fontScaleY|0,this.renderPerChar||1==f?(cr.imgdtRect[2]=Math.max(p,y),cr.imgdtRect[3]=Math.max(p,x)):(cr.imgdtRect[2]=-this.fontSizeOffX*this.fontScaleX,cr.imgdtRect[3]=x),this.charRender.fontsz=t._size,_=this.charRender.getCharBmp(e,this.fontStr,s,i,r,h,c,c,c,c,cr.imgdtRect))if(_.width>cr.atlasWidth||_.height>cr.atlasWidth)(m=sr.getTextTexture(_.width,_.height)).addChar(_,0,0,h.uv),h.texture=m,h.orix=c,h.oriy=c,m.ri=h,this.isoTextures.push(m);else l=this.addBmpData(_,h),cr.isWan1Wan?(h.orix=c,h.oriy=c):(h.orix=this.fontSizeOffX+T,h.oriy=this.fontSizeOffY+T),l.charMaps[o]=h}return h}addBmpData(e,t){for(var i,r=e.width,s=e.height,a=this.textAtlases.length,n=!1,o=0;o<a&&!(n=(i=this.textAtlases[o]).getAEmpty(r,s,_r));o++);if(!n){if(i=new ar,this.textAtlases.push(i),!(n=i.getAEmpty(r,s,_r)))throw"err1";this.cleanAtlases()}return n&&(i.texture.addChar(e,_r.x,_r.y,t.uv),t.texture=i.texture),i}GC(){for(var e=0,t=this.textAtlases.length,i=cr.destroyAtlasDt,r=0,s=$i.loopCount,a=-1,n=0,o=null,h=null;e<t;e++){if(o=(h=this.textAtlases[e]).texture){r+=o.curUsedCovRateAtlas;var l=h.usedRate-o.curUsedCovRateAtlas;n<l&&(n=l,a=e)}s-h.texture.lastTouchTm>i&&(cr.showLog&&console.log(h.texture.id),h.destroy(),this.textAtlases[e]=this.textAtlases[t-1],t--,e--,a=-1)}for(this.textAtlases.length=t,t=this.isoTextures.length,e=0;e<t;e++)s-(o=this.isoTextures[e]).lastTouchTm>cr.destroyUnusedTextureDt&&(o.ri.deleted=!0,o.ri.texture=null,o.destroy(),this.isoTextures[e]=this.isoTextures[t-1],t--,e--);this.isoTextures.length=t;var u=this.textAtlases.length>1&&this.textAtlases.length-r>=2;(cr.atlasWidth*cr.atlasWidth*4*this.textAtlases.length>cr.cleanMem||u||cr.simClean)&&(cr.simClean=!1,cr.showLog&&console.log("清理使用率低的贴图。总使用率:",r,":",this.textAtlases.length,"最差贴图:"+a),a>=0&&((h=this.textAtlases[a]).destroy(),this.textAtlases[a]=this.textAtlases[this.textAtlases.length-1],this.textAtlases.length=this.textAtlases.length-1,this.event("GC")))}cleanAtlases(){}}cr.useOldCharBook=!1,cr.atlasWidth=1024,cr.noAtlas=!1,cr.forceSplitRender=!1,cr.forceWholeRender=!1,cr.scaleFontWithCtx=!0,cr.maxFontScale=4,cr.standardFontSize=32,cr.destroyAtlasDt=10,cr.checkCleanTextureDt=2e3,cr.destroyUnusedTextureDt=3e3,cr.cleanMem=104857600,cr.isWan1Wan=!1,cr.showLog=!1,cr.debugUV=!1,cr.imgdtRect=[0,0,0,0],cr.simClean=!1;const _r=new d;class pr extends ht{static __init__(){pr.VertexDeclarition=new nt(48,[new ot(0,st.Vector4,0),new ot(16,st.Vector4,1),new ot(32,st.Vector4,2)])}constructor(){super(pr.const_stride,4,4)}onVBRealloc(e){this._vbFloat32Array=new Float32Array(e)}onIBRealloc(e){this._ibU16Array=new Uint16Array(e)}addData(e,t,i,r,s,a=null){let n=e.length/2;this.expVBSize(n*pr.const_stride);var o=e.length>>1,h=this._vertNum*pr.const_stride>>2,l=this._vbFloat32Array,u=0,d=r.a,c=r.b,_=r.c,p=r.d,g=r.tx,m=r.ty,f=0;let T=0,y=0,x=1,v=1;a&&(T=a[0],y=a[1],x=a[2],v=a[3]);let S=(s>>>16&255)/255,D=(s>>>8&255)/255,E=(255&s)/255,w=(s>>>24)/255;for(f=0;f<o;f++){var R=e[u],C=e[u+1];l[h]=R*d+C*_+g,l[h+1]=R*c+C*p+m,l[h+2]=T+t[u]*x,l[h+3]=y+t[u+1]*v,l[h+4]=E,l[h+5]=D,l[h+6]=S,l[h+7]=w,l[h+8]=255,h+=12,u+=2}var A=this._vertNum,M=this._indexNum;this.expIBSize(i.byteLength);var b=this._ibU16Array;if(A>0)for(let e=M,t=0,r=M+i.length;e<r;e++,t++)b[e]=i[t]+A;else b.set(i);this._vertNum+=o,this._indexNum+=i.length}get vertexDeclarition(){return pr.VertexDeclarition}}pr.const_stride=48,pr.VertexDeclarition=null;class gr extends ht{static __init__(){gr.vertexDeclaration=new nt(24,[new ot(0,st.Vector2,0),new ot(8,st.Vector4,1)])}constructor(){super(gr.const_stride,4,4),this._vbFloat32Array=null}onVBRealloc(e){this._vbFloat32Array=new Float32Array(e)}onIBRealloc(e){}addVertAndIBToMesh(e,t,i){var r=this._vertNum*gr.const_stride;this.expVBSize(e.length/2*gr.const_stride);var s=r>>2,a=this._vbFloat32Array,n=0;let o=(t>>>16&255)/255,h=(t>>>8&255)/255,l=(255&t)/255,u=(t>>>24)/255;for(var d=e.length/2,c=0;c<d;c++)a[s++]=e[n],a[s++]=e[n+1],n+=2,a[s++]=l,a[s++]=h,a[s++]=o,a[s++]=u;this.expIBSize(2*i.length),new Uint16Array(this._IBBuff,2*this._indexNum,i.length).set(new Uint16Array(i)),this._vertNum+=d,this._indexNum+=i.length}get vertexDeclarition(){return gr.vertexDeclaration}}gr.const_stride=24,gr.vertexDeclaration=null;const mr=new V(Ue.MAX_CLIP_SIZE,0,0,Ue.MAX_CLIP_SIZE,0,0),fr=[0,0,0,0,0,0,0,0],Tr=new V;var yr=new Gt;class xr{static __init__(){if(xr.MAXCLIPRECT=new G(0,0,Ue.MAX_CLIP_SIZE,Ue.MAX_CLIP_SIZE),vr.DEFAULT=new vr,!xr._textRender){let e=xr._textRender=new cr;e.fontMeasure=new tr(e.charRender)}}constructor(){if(this._alpha=1,this._material=null,this._fillStyle=Mi.DEFAULT,this._strokeStyle=Mi.DEFAULT,this._drawTexToDrawTri_Vert=new Float32Array(8),this._drawTexToDrawTri_Index=new Uint16Array([0,1,2,0,2,3]),this._tempUV=new Float32Array(8),this._drawTriUseAbsMatrix=!1,this._other=null,this._path=null,this._drawCount=1,this._width=Ue.MAX_CLIP_SIZE,this._height=Ue.MAX_CLIP_SIZE,this._renderCount=0,this.stopMerge=!0,this._curSubmit=Ki.RENDERBASE,this._submitKey=new ji,this._meshQuatTex=new lt,this._meshVG=new gr,this._meshTex=new pr,this._transedPoints=new Array(8),this._temp4Points=new Array(8),this._clipRect=xr.MAXCLIPRECT,this._globalClipMatrix=mr.clone(),this._clipInfoID=0,this._clipID_Gen=0,this._matBuffer=new Float32Array(6),this._lastMatScaleX=1,this._lastMatScaleY=1,this._lastMat_a=1,this._lastMat_b=0,this._lastMat_c=0,this._lastMat_d=1,this._nBlendType=0,this._save=null,this._charSubmitCache=null,this._saveMark=null,this._shader2D=new Ui,this.sprite=null,this._italicDeg=0,this._lastTex=null,this._fillColor=0,this._flushCnt=0,this.defTexture=null,this._colorFiler=null,this.drawTexAlign=!1,this._incache=!1,this._isMain=!1,this._render2D=null,this._clearColor=new m(0,0,0,0),this._clear=!1,this._shaderValueNeedRelease=[],this.render2D=new mt,xr._contextcount++,!this.defTexture){var t=new _e(2,2,e.TextureFormat.R8G8B8A8,!0,!1,!1);t.setPixelsData(new Uint8Array(16),!1,!1),t.lock=!0,this.defTexture=new fe(t)}this._lastTex=this.defTexture,this._other=vr.DEFAULT,this._curMat=V.create(),this._charSubmitCache=new Qi(this),this._mesh=this._meshQuatTex,this._mesh.clearMesh(),this._save=[Pi.Create(this)],this._save.length=10,this.clear(),this._render2DManager=new xt}copyState(e){}set isMain(e){this._isMain=e}get isMain(){return this._isMain}set render2D(e){this._render2D=e}get render2D(){return this._render2D}get lineJoin(){return""}set lineJoin(e){}get lineCap(){return""}set lineCap(e){}get miterLimit(){return""}set miterLimit(e){}touchRes(e){e.touch()}transformByMatrix(e,t,i){this.transform(e.a,e.b,e.c,e.d,e.tx+t,e.ty+i)}drawRect(e,t,i,r,s,a,n){var o=this;null!=s&&(o.fillStyle=s,o.fillRect(e,t,i,r)),null!=a&&(o.strokeStyle=a,o.lineWidth=n,o.strokeRect(e,t,i,r))}alpha(e){this.globalAlpha*=e}_transform(e,t,i){this.translate(t,i),this.transform(e.a,e.b,e.c,e.d,e.tx,e.ty),this.translate(-t,-i)}_rotate(e,t,i){this.translate(t,i),this.rotate(e),this.translate(-t,-i)}_scale(e,t,i,r){this.translate(i,r),this.scale(e,t),this.translate(-i,-r)}_drawLine(e,t,i,r,s,a,n,o,h){this.beginPath(),this.strokeStyle=n,this.lineWidth=o,this.moveTo(e+i,t+r),this.lineTo(e+s,t+a),this.stroke()}_drawLines(e,t,i,r,s,a){this.beginPath(),this.strokeStyle=r,this.lineWidth=s,this.addPath(i.slice(),!1,!1,e,t),this.stroke()}drawCurves(e,t,i,r,s){this.beginPath(),this.strokeStyle=r,this.lineWidth=s,this.moveTo(e+i[0],t+i[1]);for(var a=2,n=i.length;a<n;)this.quadraticCurveTo(e+i[a++],t+i[a++],e+i[a++],t+i[a++]);this.stroke()}_fillAndStroke(e,t,i,r=!1){null!=e&&(this.fillStyle=e,this.fill()),null!=t&&i>0&&(this.strokeStyle=t,this.lineWidth=i,this.stroke())}_drawCircle(e,t,i,r,s,a,n){this.beginPath(!0),this.arc(e,t,i,i,0,2*Math.PI,!1,!0,40),this.closePath(),this._fillAndStroke(r,s,a)}_drawEllipse(e,t,i,r,s,a,n){this.beginPath(!0),this.arc(e,t,i,r,0,2*Math.PI,!1,!0,40),this.closePath(),this._fillAndStroke(s,a,n)}_drawRoundRect(e,t,i,r,s,a,n,o,h,l,u){if(i<=0)return;if(r<=0)return;this.beginPath(!0);var d=this._getPath();if(0>=s)d.addPoint(e,t);else{let o=Math.PI,h=1.5*Math.PI;if(i<s+a){let e=s*(s+a-i)/(s+a),t=Math.sqrt(s*s-e*e),r=Math.atan2(t,e);h-=.5*Math.PI-r}if(r<s+n){let e=s*(s+n-r)/(s+n),t=Math.sqrt(s*s-e*e);o+=Math.atan2(e,t)}o>h||this.arc(e+s,t+s,s,s,o,h,!1,!0,5)}let c=e+i-a;if(0>=a)d.addPoint(c,t);else{let e=1.5*Math.PI,n=2*Math.PI;if(i<s+a){let t=a*(s+a-i)/(s+a),r=Math.sqrt(s*s-t*t),n=Math.atan2(r,t);e+=.5*Math.PI-n}if(r<a+o){let e=a*(a+o-r)/(a+o),t=Math.sqrt(a*a-e*e);n-=Math.atan2(e,t)}e>n||this.arc(c,t+a,a,a,e,n,!1,!0,5)}c=e+i-o;let _=t+r-o;if(0>=o)d.addPoint(c,_);else{let e=0,t=.5*Math.PI;if(i<n+o){let e=o*(n+o-i)/(n+o),r=Math.sqrt(n*n-e*e),s=Math.atan2(r,e);t-=.5*Math.PI-s}if(r<a+o){let t=o*(a+o-r)/(a+o),i=Math.sqrt(o*o-t*t);e+=Math.atan2(t,i)}e>t||this.arc(c,_,o,o,e,t,!1,!0,5)}if(c=e+n,_=t+r-n,0>=n)d.addPoint(c,_);else{let e=.5*Math.PI,t=Math.PI;if(i<n+o){let t=o*(n+o-i)/(n+o),r=Math.sqrt(n*n-t*t),s=Math.atan2(r,t);e+=.5*Math.PI-s}if(r<s+n){let e=n*(s+n-r)/(s+n),i=Math.sqrt(n*n-e*e);t-=Math.atan2(e,i)}e>t||this.arc(c,_,n,n,e,t,!1,!0,5)}this.closePath(),this._fillAndStroke(h,l,u)}_drawPie(e,t,i,r,s,a,n,o,h){this.beginPath(),this.moveTo(e,t),this.arc(e,t,i,i,r,s),this.closePath(),this._fillAndStroke(a,n,o)}_drawPoly(e,t,i,r,s,a,n,o){this.beginPath(),this.addPath(i.slice(),!0,n,e,t),this.closePath(),this._fillAndStroke(r,s,a,n)}_drawPath(e,t,i,r,s){this.beginPath();for(var a=0,n=i.length;a<n;a++){var o=i[a];switch(o[0]){case"moveTo":this.moveTo(e+o[1],t+o[2]);break;case"lineTo":this.lineTo(e+o[1],t+o[2]);break;case"arcTo":this.arcTo(e+o[1],t+o[2],e+o[3],t+o[4],o[5]);break;case"closePath":this.closePath()}}null!=r&&(this.fillStyle=r.fillStyle,this.fill()),null!=s&&(this.strokeStyle=s.strokeStyle,this.lineWidth=s.lineWidth||1,this.lineJoin=s.lineJoin,this.lineCap=s.lineCap,this.miterLimit=s.miterLimit,this.stroke())}static set2DRenderConfig(){}clearBG(e,t,i,r){null==e||null==e?this._clear=!1:(this._clearColor.setValue(e,t,i,r),this._clear=!0)}_releaseMem(){this._curMat&&this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null,this._charSubmitCache.clear(),this._path=null,this._save=null,this.sprite=null}destroy(){--xr._contextcount,this.sprite=null,this._charSubmitCache&&this._charSubmitCache.destroy(),this.defTexture&&(this.defTexture.bitmap&&this.defTexture.bitmap.destroy(),this.defTexture.destroy());for(var e=0,t=this._shaderValueNeedRelease.length;e<t;e++)this._shaderValueNeedRelease[e]&&this._shaderValueNeedRelease[e].release()}clear(){this._submitKey.clear(),this._drawCount=1,this._other=vr.DEFAULT,this._alpha=1,this._nBlendType=0,this._clipRect=xr.MAXCLIPRECT,this._fillStyle=this._strokeStyle=Mi.DEFAULT,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1}size(e,t){this._width==e&&this._height==t||(this._width=e,this._height=t,this.isMain&&(_t.width=e,_t.height=t)),0===e&&0===t&&this._releaseMem()}get width(){return this._width}set width(e){this.size(e,this._height)}get height(){return this._height}set height(e){this.size(this._width,e)}getMatScaleX(){return this._lastMat_a==this._curMat.a&&this._lastMat_b==this._curMat.b||(this._lastMatScaleX=this._curMat.getScaleX(),this._lastMat_a=this._curMat.a,this._lastMat_b=this._curMat.b),this._lastMatScaleX}getMatScaleY(){return this._lastMat_c==this._curMat.c&&this._lastMat_d==this._curMat.d||(this._lastMatScaleY=this._curMat.getScaleY(),this._lastMat_c=this._curMat.c,this._lastMat_d=this._curMat.d),this._lastMatScaleY}getFillColor(){return this._fillColor}set fillStyle(e){this._fillStyle.equal(e)||(Bi.save(this,Bi.TYPE_FILESTYLE,this._shader2D,!1),this._fillStyle=Mi.create(e),this._submitKey.other=-this._fillStyle.toInt())}get fillStyle(){return this._fillStyle}set globalAlpha(e){(e=Math.floor(1e3*e)/1e3)!=this._alpha&&(Bi.save(this,Bi.TYPE_ALPHA,this._shader2D,!1),this._alpha=e)}get globalAlpha(){return this._alpha}set textAlign(e){this._other.textAlign===e||(this._other=this._other.make(),Bi.save(this,Bi.TYPE_TEXTALIGN,this._other,!1),this._other.textAlign=e)}get textAlign(){return this._other.textAlign}set textBaseline(e){this._other.textBaseline===e||(this._other=this._other.make(),Bi.save(this,Bi.TYPE_TEXTBASELINE,this._other,!1),this._other.textBaseline=e)}get textBaseline(){return this._other.textBaseline}set globalCompositeOperation(e){this._drawToRender2D(this._curSubmit);var t=Ri.TOINT[e];null==t||this._nBlendType===t||(Bi.save(this,Bi.TYPE_GLOBALCOMPOSITEOPERATION,this,!0),this._curSubmit=Ki.RENDERBASE,this._nBlendType=t)}get globalCompositeOperation(){return Ri.NAMES[this._nBlendType]}set strokeStyle(e){this._strokeStyle.equal(e)||(Bi.save(this,Bi.TYPE_STROKESTYLE,this._shader2D,!1),this._strokeStyle=Mi.create(e),this._submitKey.other=-this._strokeStyle.toInt())}get strokeStyle(){return this._strokeStyle}translate(e,t){0===e&&0===t||(Oi.save(this),this._curMat._bTransform?(Ni.save(this),this._curMat.tx+=e*this._curMat.a+t*this._curMat.c,this._curMat.ty+=e*this._curMat.b+t*this._curMat.d):(this._curMat.tx=e,this._curMat.ty=t))}set lineWidth(e){this._other.lineWidth===e||(this._other=this._other.make(),Bi.save(this,Bi.TYPE_LINEWIDTH,this._other,!1),this._other.lineWidth=e)}get lineWidth(){return this._other.lineWidth}save(){this._save[this._save._length++]=Pi.Create(this)}restore(){var e=this._save._length,t=this._nBlendType;if(!(e<1)){for(var i=e-1;i>=0;i--){var r=this._save[i];if(r.restore(this),r.isSaveMark())return void(this._save._length=i)}t!=this._nBlendType&&(this.stopMerge=!0)}}fillText(e,t,i,r,s,a,n=0,o=""){xr._textRender.filltext(this,e,t,i,r,s,o,n,a)}drawText(e,t,i,r,s,a){xr._textRender.filltext(this,e,t,i,r,s,null,0,a)}strokeWord(e,t,i,r,s,a,n){xr._textRender.filltext(this,e,t,i,r,null,s,a,n)}fillBorderText(e,t,i,r,s,a,n,o){xr._textRender.filltext(this,e,t,i,r,s,a,n,o)}_fast_filltext(e,t,i,r,s,a,n,o){xr._textRender._fast_filltext(this,e,t,i,r,s,a,n,o)}_fillRect(t,i,r,s,a){var n=this._curSubmit,o=this._mesh.vertexNum+4<xr._MAXVERTNUM&&n&&n._key.submitType===Ki.KEY_DRAWTEXTURE&&n._key.blendShader===this._nBlendType&&!this.isStopMerge(n)&&this._curSubmit.material==this._material;o||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex);let h=this._mesh;this.transformQuad(t,i,r,s,0,this._curMat,this._transedPoints),this.clipedOff(this._transedPoints)||(o||(n=this._curSubmit=Ki.create(this,h,Gi.create(e.RenderSpriteData.Texture2D)),this.fillShaderValue(n.shaderValue),this._copyClipInfo(n.shaderValue),n.clipInfoID=this._clipInfoID,!this._lastTex||this._lastTex.destroyed?n.shaderValue.textureHost=this.defTexture:n.shaderValue.textureHost=this._lastTex,n._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1),h.addQuad(this._transedPoints,fe.NO_UV,a,!1),this._curSubmit._numEle+=6)}fillRect(e,t,i,r,s){var a=s?Mi.create(s):this._fillStyle,n=this.mixRGBandAlpha(a.toInt());this._fillRect(e,t,i,r,n)}fillTexture(e,t,i,r,s,a,n,o){e._getSource()?this._fillTexture(e,e.width,e.height,e.uvrect,t,i,r,s,a,n.x,n.y,o):this.sprite&&h.systemTimer.callLater(this,this._repaintSprite)}_fillTexture(t,i,r,a,n,o,h,l,u,d,c,_){var p=this._curSubmit;this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex;var g=!0,m=!0;switch(u){case"repeat":break;case"repeat-x":m=!1;break;case"repeat-y":g=!1;break;case"no-repeat":g=m=!1}var f=this._temp4Points,T=0,y=0,x=0,v=0,S=0,D=0;if(d<0?(x=n,T=-d%i/i):x=n+d,c<0?(v=o,y=-c%r/r):v=o+c,S=n+h,D=o+l,!g&&(S=Math.min(S,n+d+i)),!m&&(D=Math.min(D,o+c+r)),!(S<n||D<o||x>S||v>D)){var E=(S-n-d)/i,w=(D-o-c)/r;if(this.transformQuad(x,v,S-x,D-v,0,this._curMat,this._transedPoints),f[0]=T,f[1]=y,f[2]=E,f[3]=y,f[4]=E,f[5]=w,f[6]=T,f[7]=w,!this.clipedOff(this._transedPoints)){var R=Gi.create(e.RenderSpriteData.Texture2D);R.shaderData.addDefine(ki.FILLTEXTURE);var C=a.concat();s.TEMP.setValue(C[0],C[1],C[2],C[3]),R.u_TexRange=s.TEMP,p=this._curSubmit=Ki.create(this,this._mesh,R),this.fillShaderValue(R),p.clipInfoID=this._clipInfoID,p.shaderValue.textureHost=t;var A=this._mixRGBandAlpha(_,this._alpha);this._mesh.addQuad(this._transedPoints,f,A,!0),this._curSubmit._numEle+=6}this.breakNextMerge()}}setColorFilter(e){Bi.save(this,Bi.TYPE_COLORFILTER,this,!0),this._colorFiler=e,this.stopMerge=!0}drawTexture(e,t,i,r,s,a=4294967295){this._drawTextureM(e,t,i,r,s,null,1,null,a)}drawTextures(e,t,i,r,s){if(e._getSource())for(var a=t.length/2,n=0,o=e.bitmap.id,l=0;l<a;l++){const a="number"==typeof s[l]?s[l]:4294967295;this._inner_drawTexture(e,o,t[n++]+i,t[n++]+r,0,0,null,null,1,!1,a)}else this.sprite&&h.systemTimer.callLater(this,this._repaintSprite)}_drawTextureM(e,t,i,r,s,a,n,o,h){var l=this.sprite;return!!e._getSource((function(){l&&l.repaint()}))&&this._inner_drawTexture(e,e.bitmap.id,t,i,r,s,a,o,n,!1,h)}_drawRenderTexture(e,t,i,r,s,a,n,o,h=4294967295){return this._inner_drawTexture(e,-1,t,i,r,s,a,o,n,!1,h)}_copyClipInfo(e){let t=this._globalClipMatrix;var i=e.clipMatDir;i.x=t.a,i.y=t.b,i.z=t.c,i.w=t.d,e.clipMatDir=i;var r=e.clipMatPos;r.x=t.tx,r.y=t.ty,e.clipMatPos=r}_copyClipInfoToShaderData(e){let t=this._globalClipMatrix;s.TEMP.setValue(t.a,t.b,t.c,t.d),e.setVector(ki.UNIFORM_CLIPMATDIR,s.TEMP),Gt.TEMP.setValue(t.tx,t.ty),e.setVector2(ki.UNIFORM_CLIPMATPOS,Gt.TEMP)}isStopMerge(e){return this.stopMerge||e.clipInfoID!==this._clipInfoID}drawCallOptimize(e){return this._charSubmitCache.enable(e,this),e}_drawToRender2D(e){let t=this._mesh;if(t.indexNum<=0)return;let i=e.shaderValue,r=i.shaderData;switch(e._key.blendShader){case 1:case 3:case 5:r.setInt(gi.BLEND_SRC,At.BLENDPARAM_ONE),r.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE);break;case 2:r.setInt(gi.BLEND_SRC,At.BLENDPARAM_DST_COLOR),r.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;case 6:r.setInt(gi.BLEND_SRC,At.BLENDPARAM_ZERO),r.setInt(gi.BLEND_DST,At.BLENDPARAM_SRC_ALPHA);break;case 7:r.setInt(gi.BLEND_SRC,At.BLENDPARAM_ZERO),r.setInt(gi.BLEND_DST,At.BLENDPARAM_ZERO);break;case 9:r.setInt(gi.BLEND_SRC,At.BLENDPARAM_SRC_ALPHA),r.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;default:r.setInt(gi.BLEND_SRC,At.BLENDPARAM_ONE),r.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}if(e._colorFiler){var a=e._colorFiler;i.setFilter(a),Zt.TEMP.cloneByArray(a._mat),r.setMatrix4x4(ki.UNIFORM_COLORMAT,Zt.TEMP),s.TEMP.setValue(a._alpha[0],a._alpha[1],a._alpha[2],a._alpha[3]),r.setVector(ki.UNIFORM_COLORALPHA,s.TEMP)}this._drawMesh(t,0,t.vertexNum,e._startIdx,t.indexNum,e.shaderValue,e.material),this.stopMerge=!1,this._drawCount++}_drawMesh(e,t,i,r,s,a,n){this._render2DManager._renderEnd||this._render2DManager.render(mt.rendercontext2D),e.indexNum&&this._render2D.draw(e,t,i*e.vertexDeclarition.vertexStride,r,2*s,a,n),e.clearMesh(),a._needRelease||(a._needRelease=!0,this._shaderValueNeedRelease.push(a))}_inner_drawTexture(t,i,r,s,a,n,o,h,l,u,d){if(a<=0||n<=0)return!1;var c=this._curSubmit._key;if(h=h||t._uv,c.submitType===Ki.KEY_TRIANGLES&&c.other===i){var _=this._drawTexToDrawTri_Vert;_[0]=r,_[1]=s,_[2]=r+a,_[3]=s,_[4]=r+a,_[5]=s+n,_[6]=r,_[7]=s+n,this._drawTriUseAbsMatrix=!0;var p=this._tempUV;return p[0]=h[0],p[1]=h[1],p[2]=h[2],p[3]=h[3],p[4]=h[4],p[5]=h[5],p[6]=h[6],p[7]=h[7],this.drawTriangles(t,0,0,_,p,this._drawTexToDrawTri_Index,o||this._curMat,l,null,4294967295),this._drawTriUseAbsMatrix=!1,!0}var g=this._curSubmit,m=u?this._charSubmitCache.getPos():this._transedPoints;if(this.transformQuad(r,s,a||t.width,n||t.height,this._italicDeg,o||this._curMat,m),this.drawTexAlign){var f=Math.round;m[0]=f(m[0]),m[1]=f(m[1]),m[2]=f(m[2]),m[3]=f(m[3]),m[4]=f(m[4]),m[5]=f(m[5]),m[6]=f(m[6]),m[7]=f(m[7]),this.drawTexAlign=!1}var T=this._mixRGBandAlpha(d,this._alpha*l);if(u)return this._charSubmitCache.add(this,t,i,m,h,T),!0;var y=i>=0&&c.submitType===Ki.KEY_DRAWTEXTURE&&c.other===i&&!this.isStopMerge(this._curSubmit)&&this._mesh.vertexNum+4<xr._MAXVERTNUM&&this._curSubmit.material==this._material;if(y||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex),this._lastTex=t,!y){let r=Gi.create(e.RenderSpriteData.Texture2D);this.fillShaderValue(r),r.textureHost=t,this._curSubmit=g=Ki.create(this,this._mesh,r),g._key.other=i,this._copyClipInfo(g.shaderValue),g.clipInfoID=this._clipInfoID}return this._mesh.addQuad(m,h,T,!0),g._numEle+=6,!0}fillShaderValue(e){e.size=new Gt(this._width,this._height),this._copyClipInfo(e)}clipedOff(e){return this._clipRect.width<=0||this._clipRect.height<=0}transformQuad(e,t,i,r,s,a,n){var o=0;0!=s&&(o=Math.tan(s*Math.PI/180)*r);var h=e+i,l=t+r,u=a.tx,d=a.ty,c=a.a,_=a.b,p=a.c,g=a.d,m=e+o,f=t,T=h+o,y=t,x=h,v=l,S=e,D=l;a._bTransform?(n[0]=m*c+f*p+u,n[1]=m*_+f*g+d,n[2]=T*c+y*p+u,n[3]=T*_+y*g+d,n[4]=x*c+v*p+u,n[5]=x*_+v*g+d,n[6]=S*c+D*p+u,n[7]=S*_+D*g+d):(n[0]=m+u,n[1]=f+d,n[2]=T+u,n[3]=y+d,n[4]=x+u,n[5]=v+d,n[6]=S+u,n[7]=D+d)}breakNextMerge(){this.stopMerge=!0}_repaintSprite(){this.sprite&&this.sprite.repaint()}drawTextureWithTransform(e,t,i,r,s,a,n,o,h,l,u,d=4294967295){var c,_=this._curMat;if(l&&(c=this.globalCompositeOperation,this.globalCompositeOperation=l),!a)return this._drawTextureM(e,t+n,i+o,r,s,_,h,u,d),void(l&&(this.globalCompositeOperation=c));Tr.a=a.a,Tr.b=a.b,Tr.c=a.c,Tr.d=a.d,Tr.tx=a.tx+n,Tr.ty=a.ty+o,Tr._bTransform=a._bTransform,a&&_._bTransform?(V.mul(Tr,_,Tr),(a=Tr)._bTransform=!0):(Tr.tx+=_.tx,Tr.ty+=_.ty,a=Tr),this._drawTextureM(e,t,i,r,s,a,h,u,d),l&&(this.globalCompositeOperation=c)}drawTriangles(t,i,r,s,a,n,o,l,u,d=4294967295){if(null==l&&(l=1),t._getSource()){var c=null;u&&(c=this.globalCompositeOperation,this.globalCompositeOperation=u);var _=t.bitmap,p=this._curSubmit._key,g=p.submitType===Ki.KEY_TRIANGLES&&p.other===_.id&&p.blendShader==this._nBlendType&&this._mesh.vertexNum+s.length/2<xr._MAXVERTNUM&&this._curSubmit.material==this._material;if(g||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshTex),!g){var m=this._curSubmit=Ki.create(this,this._mesh,Gi.create(e.RenderSpriteData.Texture2D));m.shaderValue.textureHost=t,this.fillShaderValue(m.shaderValue),m._key.submitType=Ki.KEY_TRIANGLES,m._key.other=_.id,this._copyClipInfo(m.shaderValue),m.clipInfoID=this._clipInfoID}var f=this._mixRGBandAlpha(d,this._alpha*l);this._drawTriUseAbsMatrix?this._mesh.addData(s,a,n,o,f,null):(o?(Tr.a=o.a,Tr.b=o.b,Tr.c=o.c,Tr.d=o.d,Tr.tx=o.tx+i,Tr.ty=o.ty+r):(Tr.a=1,Tr.b=0,Tr.c=0,Tr.d=1,Tr.tx=i,Tr.ty=r),V.mul(Tr,this._curMat,Tr),this._mesh.addData(s,a,n,Tr||this._curMat,f,null)),this._curSubmit._numEle+=n.length,u&&(this.globalCompositeOperation=c)}else this.sprite&&h.systemTimer.callLater(this,this._repaintSprite)}transform(e,t,i,r,s,a){Ni.save(this),V.mul(V.TEMP.setTo(e,t,i,r,s,a),this._curMat,this._curMat),this._curMat._checkTransform()}rotate(e){Ni.save(this),this._curMat.rotateEx(e)}scale(e,t){Ni.save(this),this._curMat.scaleEx(e,t)}clipRect(e,t,i,r,s){if(Li.save(this),this._clipRect==xr.MAXCLIPRECT?this._clipRect=new G(e,t,i,r):(this._clipRect.width=i,this._clipRect.height=r,this._clipRect.x=e,this._clipRect.y=t),this._clipID_Gen++,this._clipID_Gen%=1e4,this._clipInfoID=this._clipID_Gen,s)mr.copyTo(this._globalClipMatrix);else{var a=this._globalClipMatrix,n=a.tx,o=a.ty,h=n+a.a,l=o+a.d;if(this._clipRect.width>=Ue.MAX_CLIP_SIZE?(a.a=a.d=Ue.MAX_CLIP_SIZE,a.b=a.c=a.tx=a.ty=0):this._curMat._bTransform?(a.tx=this._clipRect.x*this._curMat.a+this._clipRect.y*this._curMat.c+this._curMat.tx,a.ty=this._clipRect.x*this._curMat.b+this._clipRect.y*this._curMat.d+this._curMat.ty,a.a=this._clipRect.width*this._curMat.a,a.b=this._clipRect.width*this._curMat.b,a.c=this._clipRect.height*this._curMat.c,a.d=this._clipRect.height*this._curMat.d):(a.tx=this._clipRect.x+this._curMat.tx,a.ty=this._clipRect.y+this._curMat.ty,a.a=this._clipRect.width,a.b=a.c=0,a.d=this._clipRect.height),a.a>0&&a.d>0){var u=a.tx+a.a,d=a.ty+a.d;u<=n||d<=o||a.tx>=h||a.ty>=l?(a.a=-.1,a.d=-.1):(a.tx<n&&(a.a-=n-a.tx,a.tx=n),u>h&&(a.a-=u-h),a.ty<o&&(a.d-=o-a.ty,a.ty=o),d>l&&(a.d-=d-l),a.a<=0&&(a.a=-.1),a.d<=0&&(a.d=-.1))}}}startRender(){for(let e of this._shaderValueNeedRelease)e.release(),e._needRelease=!1;this._shaderValueNeedRelease.length=0,this._render2D.renderStart(this._clear,this._clearColor),this.clear()}endRender(){this.flush(),this._render2DManager._renderEnd||this._render2DManager.render(mt.rendercontext2D),this._render2D.renderEnd(),this._curSubmit=Ki.RENDERBASE}drawLeftData(){this._render2DManager._renderEnd||this._render2DManager.render(mt.rendercontext2D),this._drawToRender2D(this._curSubmit)}flush(){this.drawLeftData(),this._clipID_Gen=0,this._path&&this._path.reset(),this._curSubmit=Ki.RENDERBASE,this._flushCnt++,this._flushCnt%60==0&&this.isMain&&cr.textRenderInst&&cr.textRenderInst.GC()}beginPath(e=!1){this._getPath().beginPath(e)}closePath(){this._path.closePath()}addPath(e,t,i,r,s){let a=e.length;for(let t=0;t<a-1;t+=2)e[t]+=r,e[t+1]+=s;t&&a>5&&(e[a-2]!=e[0]||e[a-1]!=e[1])&&e.push(e[0],e[1]),this._getPath().push(e,i)}fill(){var e=this._curMat,t=this._getPath(),i=this._curSubmit;i._key.submitType===Ki.KEY_VG&&i._key.blendShader===this._nBlendType&&!this.isStopMerge(i)&&this._curSubmit.material==this._material||(this._drawToRender2D(i),this._mesh=this._meshVG,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));for(var r,s=this.mixRGBandAlpha(this.fillStyle.toInt()),a=0,n=0,o=t.paths.length;n<o;n++){var h=t.paths[n],l=h.path.length/2;if(!(l<3||3==l&&!h.convex)){var u,d,c,_,p=h.path.concat(),g=0;if(e._bTransform)for(g=0;g<l;g++)d=(u=g<<1)+1,c=p[u],_=p[d],p[u]=e.a*c+e.c*_+e.tx,p[d]=e.b*c+e.d*_+e.ty;else for(g=0;g<l;g++)d=(u=g<<1)+1,c=p[u],_=p[d],p[u]=c+e.tx,p[d]=_+e.ty;this._mesh.vertexNum+l>xr._MAXVERTNUM&&(this._curSubmit._numEle+=a,a=0,this._mesh=new gr,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));var m=this._mesh.vertexNum;if(h.convex){var f=l-2;r=new Array(3*f);for(var T=0,y=0;y<f;y++)r[T++]=m,r[T++]=y+1+m,r[T++]=y+2+m}else if(r=qi.earcut(p,null,2),m>0)for(var x=0;x<r.length;x++)r[x]+=m;this._mesh.addVertAndIBToMesh(p,s,r),a+=r.length}}this._curSubmit._numEle+=a}addVGSubmit(t){var i=Ki.create(this,t,Gi.create(e.RenderSpriteData.Primitive));return this.fillShaderValue(i.shaderValue),i._key.submitType=Ki.KEY_VG,this._copyClipInfo(i.shaderValue),i.clipInfoID=this._clipInfoID,i}stroke(){if(!(this.lineWidth<=0)){var e=this.mixRGBandAlpha(this.strokeStyle._color.numColor),t=this._getPath(),i=this._curSubmit;i._key.submitType===Ki.KEY_VG&&i._key.blendShader===this._nBlendType&&!this.isStopMerge(i)&&this._curSubmit.material==this._material||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshVG,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));for(var r=0,s=0,a=t.paths.length;s<a;s++){var n=t.paths[s];if(!(n.path.length<=0)){var o=[],h=[],l=2*n.path.length;if(!(l<2)){this._mesh.vertexNum+l>xr._MAXVERTNUM&&(this._curSubmit._numEle+=r,r=0,this._drawToRender2D(this._curSubmit),this._mesh=new gr,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue)),Yi.createLine2(n.path,o,this.lineWidth,this._mesh.vertexNum,h,n.loop);var u,d,c,_,p=h.length/2,g=this._curMat,m=0;if(g._bTransform)for(m=0;m<p;m++)d=(u=m<<1)+1,c=h[u],_=h[d],h[u]=g.a*c+g.c*_+g.tx,h[d]=g.b*c+g.d*_+g.ty;else for(m=0;m<p;m++)d=(u=m<<1)+1,c=h[u],_=h[d],h[u]=c+g.tx,h[d]=_+g.ty;this._mesh.addVertAndIBToMesh(h,e,o),r+=o.length}}}this._curSubmit._numEle+=r}}moveTo(e,t){var i=this._getPath();i.newPath(),i._lastOriX=e,i._lastOriY=t,i.addPoint(e,t)}lineTo(e,t){var i=this._getPath();Math.abs(e-i._lastOriX)<.001&&Math.abs(t-i._lastOriY)<.001||(i._lastOriX=e,i._lastOriY=t,i.addPoint(e,t))}arcTo(e,t,i,r,s){var a=0,n=0,o=0,h=this._path._lastOriX-e,l=this._path._lastOriY-t,u=Math.sqrt(h*h+l*l);if(!(u<=1e-6)){var d=h/u,c=l/u,_=i-e,p=r-t,g=_*_+p*p,m=Math.sqrt(g);if(!(m<=1e-6)){var f=_/m,T=p/m,y=d+f,x=c+T,v=Math.sqrt(y*y+x*x);if(!(v<=1e-6)){var S=y/v,D=x/v,E=Math.acos(S*d+D*c),w=Math.PI/2-E,R=(u=s*Math.tan(w))*d+e,C=u*c+t,A=Math.sqrt(u*u+s*s),M=e+S*A,b=t+D*A,I=0,B=0;if(d*T-c*f>=0){var L=2*w/xr.SEGNUM;I=Math.sin(L),B=Math.cos(L)}else L=2*-w/xr.SEGNUM,I=Math.sin(L),B=Math.cos(L);var P=this._path._lastOriX,N=this._path._lastOriY,O=R,F=C;(Math.abs(O-this._path._lastOriX)>.1||Math.abs(F-this._path._lastOriY)>.1)&&(n=O,o=F,P=O,N=F,this._path._lastOriX=n,this._path._lastOriY=o,this._path.addPoint(n,o));var U=R-M,k=C-b;for(a=0;a<xr.SEGNUM;a++){var G=U*B+k*I,V=-U*I+k*B;n=G+M,o=V+b,(Math.abs(P-n)>.1||Math.abs(N-o)>.1)&&(this._path._lastOriX=n,this._path._lastOriY=o,this._path.addPoint(n,o),P=n,N=o),U=G,k=V}}}}}arc(e,t,i,r,s,a,n=!1,o=!0,h=20){s>a&&([s,a]=[a,s]);var l=this.getMatScaleX(),u=this.getMatScaleY(),d=i*(l>u?l:u),c=2*Math.PI*d;let _=0|Math.max(c/5,h),p=2*Math.PI/_;var g=this._getPath();let m=e+Math.cos(s)*i,f=t+Math.sin(s)*r;m==this._path._lastOriX&&f==this._path._lastOriY||g.addPoint(m,f);let T=Math.ceil(s/p)*p;for(;a-T>=p;)m=e+Math.cos(T)*i,f=t+Math.sin(T)*r,g.addPoint(m,f),T+=p;m=e+Math.cos(a)*i,f=t+Math.sin(a)*r,m==this._path._lastOriX&&f==this._path._lastOriY||g.addPoint(m,f)}quadraticCurveTo(e,t,i,r){for(var s=mi.getPoints([this._path._lastOriX,this._path._lastOriY,e,t,i,r],30,2),a=0,n=s.length/2;a<n;a++)this.lineTo(s[2*a],s[2*a+1]);this.lineTo(i,r)}mixRGBandAlpha(e){return this._mixRGBandAlpha(e,this._alpha)}_mixRGBandAlpha(e,t){if(t>=1)return e;var i=(4278190080&e)>>>24;return 0!=i?i*=t:i=255*t,16777215&e|i<<24}strokeRect(e,t,i,r,s){if(this.lineWidth>0){var a=this.mixRGBandAlpha(this.strokeStyle._color.numColor),n=this.lineWidth/2;this._fillRect(e-n,t-n,i+this.lineWidth,this.lineWidth,a),this._fillRect(e-n,t-n+r,i+this.lineWidth,this.lineWidth,a),this._fillRect(e-n,t+n,this.lineWidth,r-this.lineWidth,a),this._fillRect(e-n+i,t+n,this.lineWidth,r-this.lineWidth,a)}}drawParticle(e,t,i){}_getPath(){return this._path||(this._path=new bi)}get canvas(){return this._canvas}_fillTexture_h(e,t,i,r,s,a,n,o,h){if(!(r<=0)){for(var l=a,u=Math.floor(o/r),d=o%r,c=0;c<u;c++)this._inner_drawTexture(e,t,l,n,r,s,this._curMat,i,1,!1,h),l+=r;if(d>0){var _=i[2]-i[0],p=i[0]+_*(d/r),g=fr;g[0]=i[0],g[1]=i[1],g[2]=p,g[3]=i[3],g[4]=p,g[5]=i[5],g[6]=i[6],g[7]=i[7],this._inner_drawTexture(e,t,l,n,d,s,this._curMat,g,1,!1,h)}}}_fillTexture_v(e,t,i,r,s,a,n,o,h){if(!(s<=0)){for(var l=n,u=Math.floor(o/s),d=o%s,c=0;c<u;c++)this._inner_drawTexture(e,t,a,l,r,s,this._curMat,i,1,!1,h),l+=s;if(d>0){var _=i[7]-i[1],p=i[1]+_*(d/s),g=fr;g[0]=i[0],g[1]=i[1],g[2]=i[2],g[3]=i[3],g[4]=i[4],g[5]=p,g[6]=i[6],g[7]=p,this._inner_drawTexture(e,t,a,l,r,d,this._curMat,g,1,!1,h)}}}_gridCut(e,t,i,r){let s=(e+t)/2,a=(e+t-i)/2,n=e,o=e,h=e+t,l=s-a,u=s+a,d=Math.max(0,l),c=Math.min(n,u);c>d&&(e-=c-d),d=Math.max(o,l),c=Math.min(h,u),c>d&&(t-=c-d),r.x=e,r.y=t}drawTextureWithSizeGrid(e,t,i,r,s,a,n,o,h){if(!e._getSource())return;t+=n,i+=o;var l=e.uv,u=e.bitmap.width,d=e.bitmap.height,c=a[0],_=a[3],p=a[1],g=a[2],m=a[4];r==e.width&&(_=p=0),s==e.height&&(c=g=0);var f=e.bitmap.id,T=this._curMat,y=this._tempUV;let x=!0;_+p>r&&(x=!1,this._gridCut(_,p,r,yr),_=yr.x,p=yr.y);let v=!0;c+g>s&&(v=!1,this._gridCut(c,g,s,yr),c=yr.x,g=yr.y);var S=c/d,D=_/u,E=p/u,w=g/d,R=l[0],C=l[1],A=l[4],M=l[5],b=R,I=C,B=A,L=M;if(_&&c&&(B=R+D,L=C+S,y[0]=R,y[1]=C,y[2]=B,y[3]=C,y[4]=B,y[5]=L,y[6]=R,y[7]=L,this._inner_drawTexture(e,f,t,i,_,c,T,y,1,!1,h)),p&&c&&(b=A-E,I=C,B=A,L=C+S,y[0]=b,y[1]=I,y[2]=B,y[3]=I,y[4]=B,y[5]=L,y[6]=b,y[7]=L,this._inner_drawTexture(e,f,r-p+t,0+i,p,c,T,y,1,!1,h)),_&&g&&(b=R,I=M-w,B=R+D,L=M,y[0]=b,y[1]=I,y[2]=B,y[3]=I,y[4]=B,y[5]=L,y[6]=b,y[7]=L,this._inner_drawTexture(e,f,0+t,s-g+i,_,g,T,y,1,!1,h)),p&&g&&(b=A-E,I=M-w,B=A,L=M,y[0]=b,y[1]=I,y[2]=B,y[3]=I,y[4]=B,y[5]=L,y[6]=b,y[7]=L,this._inner_drawTexture(e,f,r-p+t,s-g+i,p,g,T,y,1,!1,h)),c&&x&&(b=R+D,I=C,B=A-E,L=C+S,y[0]=b,y[1]=I,y[2]=B,y[3]=I,y[4]=B,y[5]=L,y[6]=b,y[7]=L,m?this._fillTexture_h(e,f,y,e.width-_-p,c,_+t,i,r-_-p,h):this._inner_drawTexture(e,f,_+t,i,r-_-p,c,T,y,1,!1,h)),g&&x&&(b=R+D,I=M-w,B=A-E,L=M,y[0]=b,y[1]=I,y[2]=B,y[3]=I,y[4]=B,y[5]=L,y[6]=b,y[7]=L,m?this._fillTexture_h(e,f,y,e.width-_-p,g,_+t,s-g+i,r-_-p,h):this._inner_drawTexture(e,f,_+t,s-g+i,r-_-p,g,T,y,1,!1,h)),_&&v&&(b=R,I=C+S,B=R+D,L=M-w,y[0]=b,y[1]=I,y[2]=B,y[3]=I,y[4]=B,y[5]=L,y[6]=b,y[7]=L,m?this._fillTexture_v(e,f,y,_,e.height-c-g,t,c+i,s-c-g,h):this._inner_drawTexture(e,f,t,c+i,_,s-c-g,T,y,1,!1,h)),p&&v&&(b=A-E,I=C+S,B=A,L=M-w,y[0]=b,y[1]=I,y[2]=B,y[3]=I,y[4]=B,y[5]=L,y[6]=b,y[7]=L,m?this._fillTexture_v(e,f,y,p,e.height-c-g,r-p+t,c+i,s-c-g,h):this._inner_drawTexture(e,f,r-p+t,c+i,p,s-c-g,T,y,1,!1,h)),x&&v)if(b=R+D,I=C+S,B=A-E,L=M-w,y[0]=b,y[1]=I,y[2]=B,y[3]=I,y[4]=B,y[5]=L,y[6]=b,y[7]=L,m){var P=xr.tmpUVRect;P[0]=b,P[1]=I,P[2]=B-b,P[3]=L-I,this._fillTexture(e,e.width-_-p,e.height-c-g,P,_+t,c+i,r-_-p,s-c-g,"repeat",0,0,h)}else this._inner_drawTexture(e,f,_+t,c+i,r-_-p,s-c-g,T,y,1,!1,h)}}xr._MAXVERTNUM=65535,xr.MAXCLIPRECT=null,xr.SEGNUM=32,xr._contextcount=0,xr._textRender=null,xr.tmpUVRect=[0,0,0,0];class vr{constructor(){this.lineWidth=1}clear(){this.lineWidth=1,this.textAlign=this.textBaseline=null}make(){return this===vr.DEFAULT?new vr:this}}class Sr{static __init__(){Sr.map[je.ALPHA|je.TRANSFORM|je.GRAPHICS]=Sr.alpha_transform_drawLayaGL,Sr.map[je.ALPHA|je.GRAPHICS]=Sr.alpha_drawLayaGL,Sr.map[je.TRANSFORM|je.GRAPHICS]=Sr.transform_drawLayaGL,Sr.map[je.TRANSFORM|je.CHILDS]=Sr.transform_drawNodes,Sr.map[je.ALPHA|je.TRANSFORM|je.TEXTURE]=Sr.alpha_transform_drawTexture,Sr.map[je.ALPHA|je.TEXTURE]=Sr.alpha_drawTexture,Sr.map[je.TRANSFORM|je.TEXTURE]=Sr.transform_drawTexture,Sr.map[je.GRAPHICS|je.CHILDS]=Sr.drawLayaGL_drawNodes}static transform_drawTexture(e,t,i,r){var s=e.texture;t.save(),t.transformByMatrix(e.transform,i,r);var a=e._isWidthSet?e._width:s.sourceWidth,n=e._isHeightSet?e._height:s.sourceHeight,o=a/s.sourceWidth,h=n/s.sourceHeight;if(a=s.width*o,n=s.height*h,a<=0||n<=0)return null;var l=-e.pivotX+s.offsetX*o,u=-e.pivotY+s.offsetY*h;e._getBit(ke.HIDE_BY_EDITOR)||t.drawTexture(s,l,u,a,n),t.restore()}static alpha_drawTexture(e,t,i,r){var s=e.alpha,a=e.texture;if(s>.01||e._needRepaint()){var n=t.globalAlpha;t.globalAlpha*=s;var o=e._isWidthSet?e._width:a.sourceWidth,h=e._isHeightSet?e._height:a.sourceHeight,l=o/a.sourceWidth,u=h/a.sourceHeight;if(o=a.width*l,h=a.height*u,o<=0||h<=0)return null;var d=i-e.pivotX+a.offsetX*l,c=r-e.pivotY+a.offsetY*u;e._getBit(ke.HIDE_BY_EDITOR)||t.drawTexture(a,d,c,o,h),t.globalAlpha=n}}static alpha_transform_drawTexture(e,t,i,r){var s=e.alpha,a=e.texture;if(s>.01||e._needRepaint()){var n=t.globalAlpha;t.globalAlpha*=s,t.save(),t.transformByMatrix(e.transform,i,r);var o=e._isWidthSet?e._width:a.sourceWidth,h=e._isHeightSet?e._height:a.sourceHeight,l=o/a.sourceWidth,u=h/a.sourceHeight;if(o=a.width*l,h=a.height*u,o<=0||h<=0)return null;var d=-e.pivotX+a.offsetX*l,c=-e.pivotY+a.offsetY*u;e._getBit(ke.HIDE_BY_EDITOR)||t.drawTexture(a,d,c,o,h),t.restore(),t.globalAlpha=n}}static alpha_transform_drawLayaGL(e,t,i,r){var s=e.alpha;if(s>.01||e._needRepaint()){var a=t.globalAlpha;t.globalAlpha*=s,t.save(),t.transformByMatrix(e.transform,i,r),e._getBit(ke.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,-e.pivotX,-e.pivotY),t.restore(),t.globalAlpha=a}}static alpha_drawLayaGL(e,t,i,r){var s=e.alpha;if(s>.01||e._needRepaint()){var a=t.globalAlpha;t.globalAlpha*=s,e._getBit(ke.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,i-e.pivotX,r-e.pivotY),t.globalAlpha=a}}static transform_drawLayaGL(e,t,i,r){t.save(),t.transformByMatrix(e.transform,i,r),e._getBit(ke.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,-e.pivotX,-e.pivotY),t.restore()}static transform_drawNodes(e,t,i,r){var s=e._getBit(ke.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0);t.save(),t.transformByMatrix(e.transform,i,r),i=-e.pivotX,r=-e.pivotY;var a=e._children,n=a.length;let o,h,l,u,d,c,_;e.viewport&&(o=e.viewport,h=o.x,l=o.y,u=o.right,d=o.bottom);for(let e=0;e<n;++e){let s=a[e],n=s._getBit(ke.ACTUAL_VISIBLE);o&&((c=s._x)>=u||c+s.width<=h||(_=s._y)>=d||_+s.height<=l)&&(n=!1),n&&s.render(t,i,r)}t.restore(),s&&t.drawCallOptimize(!1)}static drawLayaGL_drawNodes(e,t,i,r){let s=e._getBit(ke.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0),a=t._drawingToTexture;i-=e.pivotX,r-=e.pivotY,e._getBit(ke.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,i,r);let n,o,h,l,u,d,c,_=e._children;e.viewport&&(n=e.viewport,o=n.x,h=n.y,l=n.right,u=n.bottom);for(let e=0,s=_.length;e<s;++e){let s=_[e],p=s._getBit(ke.ACTUAL_VISIBLE);a&&s._getBit(ke.ESCAPE_DRAWING_TO_TEXTURE)&&(p=!1),n&&((d=s._x)>=l||d+s.width<=o||(c=s._y)>=u||c+s.height<=h)&&(p=!1),p&&s.render(t,i,r)}s&&t.drawCallOptimize(!1)}}Sr.map=[];var Dr=0;class Er extends xr{constructor(){super(...arguments),this.cache=null,this.mustTouchRes=[],this.randomTouchRes=[],this.genID=Dr++}touchRes(e){e.isRandomTouch?this.randomTouchRes.push(e):this.mustTouchRes.push(e)}}class wr extends gt{constructor(){super(null),this.renderResult=[]}clone(e){return null}_createMesh(){}setVertexDecl(e){this._tex_vert_decl!=e&&(this._tex_vert_decl=e,this._createMesh())}renderStart(){}draw(e,t,i,r,s,a){this.setVertexDecl(e.vertexDeclarition);let n=new Rr(e,t,i,r,s,a),o=a.clipMatPos,h=a.clipMatDir,l=n.localClipMatrix;l.a=h.x,l.b=h.y,l.c=h.z,l.d=h.w,l.tx=o.x,l.ty=o.y,a.shaderData.addDefine(ki.WORLDMAT),n.toNativeMesh(),this.renderResult.push(n)}drawMesh(e,t){throw new z}drawElement(e){throw new z}renderEnd(){}}class Rr{constructor(e,t,i,r,s,a){this.localClipMatrix=new V,this.vertexDeclarition=e.vertexDeclarition,this.vbBuffer=new ArrayBuffer(i),this.ibBuffer=new ArrayBuffer(s),new Uint8Array(this.vbBuffer).set(new Uint8Array(e.vbBuffer,t,i)),new Uint8Array(this.ibBuffer).set(new Uint8Array(e.ibBuffer,r,s)),this.mtl=a,this.vboff=0,this.vblen=i,this.iboff=0,this.iblen=s}toNativeMesh(){let t=g.renderDeviceFactory,i=this.geo=t.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement),r=i.bufferState=t.createBufferState(),s=t.createVertexBuffer(e.BufferUsage.Dynamic);s.vertexDeclaration=this.vertexDeclarition;let a=t.createIndexBuffer(e.BufferUsage.Dynamic);r.applyState([s],a),i.indexFormat=e.IndexFormat.UInt16,s.setDataLength(this.vblen),s.setData(this.vbBuffer,this.vboff,0,this.vblen),a._setIndexDataLength(this.iblen),a._setIndexData(new Uint16Array(this.ibBuffer,this.iboff,this.iblen/2),0),i.clearRenderParams(),i.setDrawElemenParams(this.iblen/2,0),this.renderElement=g.render2DRenderPassFactory.createRenderElement2D(),this.renderElement.geometry=i,this.renderElement.value2DShaderData=this.mtl.shaderData,this.renderElement.subShader=this.mtl._defaultShader.getSubShaderAt(0),this.renderElement.materialShaderData=null,this.renderElement.nodeCommonMap=["Sprite2D"]}destroyGPUResource(){this.renderElement&&this.renderElement.destroy();let e=this.geo;e&&(e.bufferState._vertexBuffers[0].destroy(),e.bufferState._bindedIndexBuffer.destroy(),e.bufferState.destroy(),e.bufferState,e.destroy(),this.geo=null)}}class Cr{constructor(){this.page=null}reset(){this.page&&this.page.reset(),this.page=null}}function Ar(e,t,i){let r=e.tx+e.a,s=e.ty+e.d,a=t.tx+t.a,n=t.ty+t.d,o=i.tx=Math.max(e.tx,t.tx),h=i.ty=Math.max(e.ty,t.ty);if(i.b=i.c=0,i.tx=o,i.ty=h,r<=t.tx||s<=t.ty||a<=e.tx||n<=e.ty)i.a=-.1,i.d=-.1;else{let e=Math.min(r,a),t=Math.min(s,n);i.a=e-o,i.d=t-h}return i}class Mr{constructor(e,t,i){this.alpha=1,this.width=0,this.height=0,this.blend=0;let r=this.curMatrix=e._curMat.clone();r.tx+=r.a*t+r.c*i,r.ty+=r.b*t+r.d*i,this.alpha=e.globalAlpha,this.render2d=e.render2D,this.width=e.width,this.height=e.height,this.clipInfo=e._globalClipMatrix.clone(),this.blend=e._nBlendType}_copyClipInfo(e){let t=this.clipInfo;var i=e.clipMatDir;i.x=t.a,i.y=t.b,i.z=t.c,i.w=t.d,e.clipMatDir=i;var r=e.clipMatPos;r.x=t.tx,r.y=t.ty,e.clipMatPos=r}clipRect(e){let t=e.x,i=e.y,r=e.width,s=e.height;var a=this.clipInfo,n=a.tx,o=a.ty,h=n+a.a,l=o+a.d;if(r>=Ue.MAX_CLIP_SIZE)a.a=a.d=Ue.MAX_CLIP_SIZE,a.b=a.c=a.tx=a.ty=0;else{let e=this.curMatrix;e._bTransform?(a.tx=t*e.a+i*e.c+e.tx,a.ty=t*e.b+i*e.d+e.ty,a.a=r*e.a,a.b=r*e.b,a.c=s*e.c,a.d=s*e.d):(a.tx=t+e.tx,a.ty=i+e.ty,a.a=r,a.b=a.c=0,a.d=s)}if(a.a>0&&a.d>0){var u=a.tx+a.a,d=a.ty+a.d;u<=n||d<=o||a.tx>=h||a.ty>=l?(a.a=-.1,a.d=-.1):(a.tx<n&&(a.a-=n-a.tx,a.tx=n),u>h&&(a.a-=u-h),a.ty<o&&(a.d-=o-a.ty,a.ty=o),d>l&&(a.d-=d-l),a.a<=0&&(a.a=-.1),a.d<=0&&(a.d=-.1))}}setBlendMode(e){this.blend=Ri.TOINT[e]}_applyBlend(e){let t=e.shaderData;switch(this.blend){case 1:case 3:case 5:t.setInt(gi.BLEND_SRC,At.BLENDPARAM_ONE),t.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE);break;case 2:t.setInt(gi.BLEND_SRC,At.BLENDPARAM_DST_COLOR),t.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;case 6:t.setInt(gi.BLEND_SRC,At.BLENDPARAM_ZERO),t.setInt(gi.BLEND_DST,At.BLENDPARAM_SRC_ALPHA);break;case 7:t.setInt(gi.BLEND_SRC,At.BLENDPARAM_ZERO),t.setInt(gi.BLEND_DST,At.BLENDPARAM_ZERO);break;case 9:t.setInt(gi.BLEND_SRC,At.BLENDPARAM_SRC_ALPHA),t.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;default:t.setInt(gi.BLEND_SRC,At.BLENDPARAM_ONE),t.setInt(gi.BLEND_DST,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}}}class br{constructor(){this.sprite=null,this.meshes=null,this.defferTouchRes=null,this.defferTouchResRand=null,this.children=null}reset(){this.clearGPUObject()}clearGPUObject(){this.meshes&&this.meshes.forEach((e=>{e.destroyGPUResource()}))}render(e,t,i){let r=e.transform,s=t.curMatrix;if(i)s.copyTo(Lr);else{let i=e._x,a=e._y;r?(r.copyTo(Nr),Nr.tx=i,Nr.ty=a,V.mul(Nr,s,Lr)):(Lr.a=s.a,Lr.b=s.b,Lr.c=s.c,Lr.d=s.d,Lr.tx=s.a*i+s.c*a+s.tx,Lr.ty=s.b*i+s.d*a+s.ty),t.alpha*=e.alpha,e.blendMode&&t.setBlendMode(e.blendMode)}Ir.setValue(t.width,t.height);let a=Or,n=a.elements;n[0]=Lr.a,n[1]=Lr.b,n[4]=Lr.c,n[5]=Lr.d,n[12]=Lr.tx,n[13]=Lr.ty,this.meshes.forEach((e=>{let i=t.render2d,r=e.mtl;r.textureHost instanceof sr&&r.textureHost.touchTexture(),r.size=Ir;let s=e.localClipMatrix;s.a==Ue.MAX_CLIP_SIZE&&s.d==Ue.MAX_CLIP_SIZE?t.clipInfo.copyTo(Fr):(V.mul(s,Lr,Fr),Ar(t.clipInfo,Fr,Fr));let n=r.clipMatDir,o=r.clipMatPos;n.x=Fr.a,n.y=Fr.b,n.z=Fr.c,n.w=Fr.d,r.clipMatDir=n,o.x=Fr.tx,o.y=Fr.ty,r.clipMatPos=o,r.mmat=a,r.vertAlpha=t.alpha,t._applyBlend(r),i.drawElement(e.renderElement)})),this.defferTouchRes.forEach((e=>{e.touch()})),this.defferTouchResRand.forEach((e=>e.touch())),this.children&&this.children.forEach((e=>{let i=t.curMatrix.clone(),r=t.alpha,s=e._parent._cacheStyle.cacheInfo,a=s.mat;V.mul(a,i,t.curMatrix),t.alpha*=s.alpha;let n=t.blend;null!=s.blend&&t.setBlendMode(s.blend);let o=t.clipInfo.clone(),h=s.clipMatrix;V.mul(h,t.curMatrix,Fr),Ar(t.clipInfo,Fr,t.clipInfo),e._cacheStyle.cacheInfo.page.render(e,t,!1),t.curMatrix=i,t.alpha=r,t.blend=n,t.clipInfo=o}))}}var Ir=new Gt;class Br{static curMatSubSpriteMat(e,t,i){if(e._renderType&je.TRANSFORM)e.transform.copyTo(Pr),Pr.tx=e._x,Pr.ty=e._y,Pr.invert(),V.mul(Pr,t,i);else{t.copyTo(i);let r=-e._x,s=-e._y;i.tx+=i.a*r+i.c*s,i.ty+=i.b*r+i.d*s}return i}static renderCacheAsNormal(e,t,i,r,s){let a=!1;var n=t._getCacheStyle().cacheInfo.page;if(!n||t._needRepaint()||h.stage.isGlobalRepaint()){if(t.alpha<=1e-6&&(t.alpha=.001),a=!0,e instanceof Er){let i=e.cache;i.children?i.children.indexOf(t)<0&&i.children.push(t):i.children=[t];let a=t._parent,n=a._cacheStyle.cacheInfo;if(n.page=i,e.genID!=n.contextID){n.contextID=e.genID;let o=e._curMat.clone();0==r&&0==s||(o.tx+=r*o.a+s*o.c,o.ty+=r*o.b+s*o.d),n.mat=Br.curMatSubSpriteMat(t,o,o),n.alpha=e.globalAlpha/t.alpha;let h=i.sprite;if(a.blendMode)n.blend=a.blendMode;else{let e=a;for(;e!=h;)if(e=e._parent,e.blendMode){n.blend=e.blendMode;break}}n.clipMatrix=e._globalClipMatrix.clone()}}(n=t._cacheStyle.cacheInfo.page=new br).sprite=t,dt.canvasNormal++;let o=new Er;o.cache=n;let h=new wr;o.render2D=h,o.startRender(),i._fun(t,o,0,0),o.endRender(),n.meshes=h.renderResult,n.defferTouchRes=o.mustTouchRes,n.defferTouchResRand=o.randomTouchRes,t.once(c.REMOVED,(()=>{(n=t._cacheStyle.cacheInfo.page).reset()}))}if(!(e instanceof Er)){let i=new Mr(e,r,s);n.render(t,i,!0)}return a}}var Lr=new V,Pr=new V,Nr=new V,Or=new Zt,Fr=new V;class Ur{static __init__(){Sr.__init__();var e=new Ur(69905,null);let t=Ur.renders.length=2*je.CHILDS;for(let i=0;i<t;i++)Ur.renders[i]=e;Ur.renders[0]=new Ur(0,null)}static _initRenderFun(e,t,i,r){var s=e._renderType;(Ur.renders[s]=Ur._getTypeRender(s))._fun(e,t,i,r)}static _getTypeRender(e){if(Sr.map[e]&&p.isPlaying)return new Ur(e,null);for(var t=null,i=je.CHILDS;i>0;)i&e&&(t=new Ur(i,t)),i>>=1;return t}constructor(e,t){if(Sr.map[e]&&p.isPlaying)return this._fun=Sr.map[e],void(this._next=Ur.NORENDER);switch(this._next=t||Ur.NORENDER,e){case 0:return void(this._fun=this._no);case je.ALPHA:return void(this._fun=this._alpha);case je.TRANSFORM:return void(this._fun=this._transform);case je.BLEND:return void(this._fun=this._blend);case je.CANVAS:return void(this._fun=this._canvas);case je.MASK:return void(this._fun=this._mask);case je.CLIP:return void(this._fun=this._clip);case je.GRAPHICS:return void(this._fun=this._graphics);case je.CHILDS:return void(this._fun=this._children);case je.CUSTOM:return void(this._fun=this._custom);case je.TEXTURE:return void(this._fun=this._texture);case je.FILTERS:return void(this._fun=ut._filter);case je.HITAREA:return void(this._fun=this._hitarea);case je.RENDERNODE2D:this._fun=this._renderNode2D;break;case 69905:return void(this._fun=Ur._initRenderFun)}}_renderNode2D(e,t,i,r){e._renderNode.addCMDCall&&e._renderNode.addCMDCall(t,i,r),t.drawLeftData(),t._render2DManager._renderEnd?(t._render2DManager._renderEnd=!1,t._render2DManager.addRenderObject(e._renderNode)):t._render2DManager.addRenderObject(e._renderNode),this._next!=Ur.NORENDER&&this._next._fun(e,t,i,r)}_no(e,t,i,r){}_custom(e,t,i,r){e.customRender(t,i,r),this._next._fun(e,t,0,0)}_clip(e,t,i,r){let s=this._next;if(s==Ur.NORENDER)return;if(e._getBit(ke.DISABLE_INNER_CLIPPING)&&!t._drawingToTexture)return void s._fun(e,t,i,r);let a=e._scrollRect,n=a.width,o=a.height;0===n&&(n=.001),0===o&&(o=.001),t.save(),t.clipRect(i,r,n,o),s._fun(e,t,i-a.x,r-a.y),t.restore()}_texture(e,t,i,r){if(!e._getBit(ke.HIDE_BY_EDITOR)){var s=e.texture;if(s._getSource()){var a=e._isWidthSet?e._width:s.sourceWidth,n=e._isHeightSet?e._height:s.sourceHeight,o=a/s.sourceWidth,h=n/s.sourceHeight;if(a=s.width*o,n=s.height*h,a>0&&n>0){let l=i-e.pivotX+s.offsetX*o,u=r-e.pivotY+s.offsetY*h;t._material=e.graphics.material,t.drawTexture(s,l,u,a,n,4294967295),t._material=null}}}this._next!=Ur.NORENDER&&this._next._fun(e,t,i,r)}_graphics(e,t,i,r){if(!e._getBit(ke.HIDE_BY_EDITOR)){let s=e._graphics;s&&s._render(e,t,i-e._pivotX,r-e._pivotY)}this._next!=Ur.NORENDER&&this._next._fun(e,t,i,r)}_hitarea(e,t,i,r){if(!t._drawingToTexture&&e.hitArea){let s=e.hitArea._hit,a=t.globalAlpha;t.globalAlpha*=.5,s&&s._render(e,t,i-e._pivotX,r-e._pivotY),s=e.hitArea._unHit,s&&s._render(e,t,i-e._pivotX,r-e._pivotY),t.globalAlpha=a}this._next!=Ur.NORENDER&&this._next._fun(e,t,i,r)}_alpha(e,t,i,r){let s=e._alpha;if(s>.01||e._needRepaint()){var a=t.globalAlpha;t.globalAlpha*=s,this._next!=Ur.NORENDER&&this._next._fun(e,t,i,r),t.globalAlpha=a}}_transform(e,t,i,r){let s=e.transform,a=this._next;s&&a!=Ur.NORENDER?(t.save(),t.transform(s.a,s.b,s.c,s.d,s.tx+i,s.ty+r),a._fun(e,t,0,0),t.restore()):a!=Ur.NORENDER&&a._fun(e,t,i,r)}_children(e,t,i,r){let s=e._children,a=s.length;i-=e.pivotX,r-=e.pivotY;let n,o,h,l,u,d,c,_=e._getBit(ke.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0),p=t._drawingToTexture;e._viewport&&(n=e._viewport,o=n.x,h=n.y,l=n.right,u=n.bottom);for(let _=0;_<a;++_){let a=s[_],g=a._getBit(ke.ACTUAL_VISIBLE);p&&a._getBit(ke.ESCAPE_DRAWING_TO_TEXTURE)&&(g=!1),g&&(n&&((d=a._x)>=l||d+a.width<=o||(c=a._y)>=u||c+a.height<=h)?g=!1:e._cacheStyle.mask!=a||a._getBit(ke.FORCE_VISIBLE)&&!p||(g=!1)),g&&(a._getBit(ke.DISABLE_OUTER_CLIPPING)&&t.clipRect(0,0,1,1,!0),a.render(t,i,r))}_&&t.drawCallOptimize(!1)}_renderNextToCacheRT(t,i,r=0,s=0,a=0,n=0){let o=t._getCacheStyle();if(t._needRepaint()||!o.renderTexture||h.stage.isGlobalRepaint()){o.renderTexture&&o.renderTexture.destroy();let h=o._calculateCacheRect(t,"bitmap",0,0),l=o.cacheRect;if(l.width<=0||l.height<=0)return o.renderTexture=null,!1;dt.canvasBitmap++;let u=l.width*h.x+r+a,d=l.height*h.y+s+n,c=new pe(u,d,e.RenderTargetFormat.R8G8B8A8),_=new xr;return _.copyState(i),_.size(u,d),_.clearBG(0,0,0,0),_.render2D=new mt(c),_.startRender(),l.x-=r,l.y-=s,this._next._fun(t,_,-l.x,-l.y),_.endRender(),_.destroy(),o.renderTexture=c,!0}return!1}_canvas(e,t,i,r){let s=e._cacheStyle,a=this._next;if(e._getBit(ke.HIDE_BY_EDITOR))a._fun(e,t,i,r);else if("bitmap"===e.cacheAs){t.drawLeftData(),this._renderNextToCacheRT(e,t);let a=s.cacheRect;t._material=e.graphics.material;let n=s.renderTexture;n&&t._drawRenderTexture(n,i+a.x,r+a.y,n.width,n.height,null,1,[0,1,1,1,1,0,0,0]),t._material=null}else{if(!Ur.cacheNormalEnable)return void a._fun(e,t,i,r);t.drawLeftData(),Br.renderCacheAsNormal(t,e,this._next,i,r)}}static RenderToRenderTexture(t,i,r,s,a=null,n=!0){let o=t._getCacheStyle()._calculateCacheRect(t,"bitmap",0,0),h=t._cacheStyle.cacheRect,l=new xr;l._drawingToTexture=!0,i&&l.copyState(i);let u=a;if(u)l.size(u.width,u.height),l.clearBG(pe._clearColor.r,pe._clearColor.g,pe._clearColor.b,pe._clearColor.a);else{let t=h.width*o.x+(n?0:h.x),i=h.height*o.y+(n?0:h.y);u=new pe(t,i,e.RenderTargetFormat.R8G8B8A8),l.size(t,i),l.clearBG(0,0,0,0)}return l.render2D=l.render2D.clone(u),l.startRender(),n?t.render(l,r-t.x-h.x,s-t.y-h.y):t.render(l,r-t.x,s-t.y),l.endRender(),l._drawingToTexture=!1,l.destroy(),u}static RenderToCacheTexture(e,t,i,r,s=!0){let a=e._getCacheStyle();return!(!e._needRepaint()&&a.renderTexture&&!h.stage.isGlobalRepaint())&&(a.renderTexture&&a.renderTexture.destroy(),a.renderTexture=Ur.RenderToRenderTexture(e,t,i,r,null,s),!0)}_blend(e,t,i,r){t.save(),t.globalCompositeOperation=e._blendMode,this._next._fun(e,t,i,r),t.restore()}_mask(t,i,r,s){let a=t.mask;if(a._getBit(ke.FORCE_VISIBLE)&&!i._drawingToTexture)return void(this._next!=Ur.NORENDER&&this._next._fun(t,i,r,s));let n=t._getCacheStyle();if(t._needRepaint()||!n.renderTexture||n.renderTexture.destroyed||h.stage.isGlobalRepaint()){if(n.renderTexture&&n.renderTexture.destroy(),n._calculateCacheRect(t,"bitmap",0,0),kr.copyFrom(n.cacheRect),kr.width<=0||kr.height<=0)return;kr.x+=t.pivotX,kr.y+=t.pivotY;let r=a._getCacheStyle();r._calculateCacheRect(a,"bitmap",0,0),Gr.copyFrom(r.cacheRect),Gr.x+=a._x,Gr.y+=a._y;let s=Math.max(kr.x,Gr.x),o=Math.max(kr.y,Gr.y),h=Math.min(kr.x+kr.width,Gr.x+Gr.width)-s,l=Math.min(kr.y+kr.height,Gr.y+Gr.height)-o;if(h<=0||l<=0)return;Ur.RenderToCacheTexture(a,i,0,0);let u=new pe(h,l,e.RenderTargetFormat.R8G8B8A8);u._invertY=g.renderEngine._screenInvertY;let d=new xr;d.clearBG(0,0,0,0),d.size(h,l),d.render2D=new mt(u),d.startRender(),d._drawingToTexture=i._drawingToTexture,this._next._fun(t,d,t.pivotX-s,t.pivotY-o),d._drawingToTexture=!1;let c=r.renderTexture;d.globalCompositeOperation="mask",d._drawRenderTexture(c,Gr.x-s,Gr.y-o,Gr.width,Gr.height,null,1,[0,1,1,1,1,0,0,0]),d.endRender(),d.destroy(),n.renderTexture=u,n.cacheRect.x=s-t.pivotX,n.cacheRect.y=o-t.pivotY,n.cacheRect.width=u.width,n.cacheRect.height=u.height}let o=n.renderTexture,l=n.cacheRect;i._drawRenderTexture(o,r+l.x,s+l.y,o.width,o.height,null,1,[0,1,1,1,1,0,0,0])}}Ur.cacheNormalEnable=!0,Ur.renders=[],Ur.NORENDER=new Ur(0,null);const kr=new G,Gr=new G;class Vr extends A{get source(){return this._source}get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}_getSource(){return this._source}constructor(e=!1){super(),this._source=e?I.createElement("canvas"):this,this.lock=!0}clear(){this._ctx&&(this._ctx.clear?this._ctx.clear():this._ctx.clearRect(0,0,this._width,this._height)),this._texture&&(this._texture.destroy(),this._texture=null)}destroy(){super.destroy(),this._setCPUMemory(0),this._ctx&&this._ctx.destroy&&this._ctx.destroy(),this._ctx=null}release(){}get context(){return this._ctx||(this._source==this?this._ctx=new xr:this._ctx=this._source.getContext(p.isConch?"layagl":"2d"),this._ctx._canvas=this),this._ctx}_setContext(e){this._ctx=e}getContext(e,t=null){return this.context}getMemSize(){return 0}size(e,t){(this._width!=e||this._height!=t||this._source&&(this._source.width!=e||this._source.height!=t))&&(this._width=e,this._height=t,this._setCPUMemory(e*t*4),this._ctx&&this._ctx.size&&this._ctx.size(e,t),this._source&&(this._source.height=t,this._source.width=e),this._texture&&(this._texture.destroy(),this._texture=null))}getTexture(){if(!this._texture){var t=new _e(this.source.width,this.source.height,e.TextureFormat.R8G8B8A8,!0,!1,!1);t.setImageData(this.source,!1,!1),this._texture=new fe(t)}return this._texture}toBase64(e,t){return this._source?this._source.toDataURL(e,t):null}}class zr{constructor(){this.renderTexOffx=0,this.renderTexOffy=0,this.cacheInfo=new Cr,this.reset()}onInvisible(){}set renderTexture(e){this._renderTexture&&e!=this._renderTexture&&this._renderTexture.destroy(),this._renderTexture=e}get renderTexture(){return this._renderTexture}recover(){this!==zr.EMPTY&&l.recover("SpriteCache",this.reset())}reset(){return this.userSetCache="none",this.staticCache=!1,this.mask=null,this.maskParent=null,this.cacheRect=null,this.cacheInfo.reset(),this}static create(){return l.getItemByClass("SpriteCache",zr)}_calculateCacheRect(e,t,i,r){var s,a=e._getCacheStyle();if(a.cacheRect||(a.cacheRect=new G),"bitmap"===t?((s=e.getSelfBounds()).width=s.width,s.height=s.height,s.x=s.x-e.pivotX,s.y=s.y-e.pivotY,s.x=Math.floor(s.x+i)-i,s.y=Math.floor(s.y+r)-r,s.width=Math.floor(s.width),s.height=Math.floor(s.height),a.cacheRect.copyFrom(s)):a.cacheRect.setTo(-e.pivotX,-e.pivotY,1,1),s=a.cacheRect,e.scrollRect){var n=e.scrollRect;s.x-=n.x,s.y-=n.y}return zr._scaleInfo.setTo(1,1),zr._scaleInfo}}zr.EMPTY=new zr,zr._scaleInfo=new d,zr.CANVAS_EXTEND_EDGE=16;class Hr{static create(){return l.getItemByClass("RestoreCmd",Hr)}recover(){l.recover("RestoreCmd",this)}run(e){e.restore()}get cmdID(){return Hr.ID}}Hr.ID="Restore";class Wr{static create(){return l.getItemByClass("SaveCmd",Wr)}recover(){l.recover("SaveCmd",this)}run(e){e.save()}get cmdID(){return Wr.ID}}Wr.ID="Save";class Yr{constructor(){this._cacheType=!1}destroy(){this._cacheType=!1,this._affectBySize=!1,this._bounds=null,this._bound2=null,l.recover("GraphicsBounds",this)}static create(){return l.getItemByClass("GraphicsBounds",Yr)}reset(){this._bound2&&(this._bound2.length=0)}getBounds(e,t){return this._bounds&&this._bound2&&0!=this._bound2.length&&t==this._cacheType||(this._bounds=G._getWrapRec(this.getBoundPoints(e,t),this._bounds)),this._cacheType=t,this._bounds}getBoundPoints(e,t){return(!this._bound2||this._bound2.length<1||t!=this._cacheType)&&(this._bound2=this._getCmdPoints(e,t)),this._cacheType=t,this._bound2}_getCmdPoints(e,t){this._affectBySize=!1;let i=this._bound2||(this._bound2=[]);i.length=0;let r=e.cmds,s=e._sp;if(0==r.length)return i;Xr.allPoints=i,Xr.width=s._width,Xr.height=s._height,Xr.affectBySize=!1,Xr.matrix.identity();let a=jr;a.length=0;for(let e=0,t=r.length;e<t;e++){let t=r[e];switch(t.cmdID){case Wr.ID:a.push(Xr.matrix),Xr.matrix=Xr.matrix.clone();break;case Hr.ID:Xr.matrix=a.pop();break;default:Xr.points.length=0,t.getBounds?t.getBounds(Xr):Kr.setTo(s.x,s.y,s._width,s._height).getBoundPoints(Xr.points),Xr.points.length>0&&Xr.flushPoints()}}if(i.length>200){let e=G._getWrapRec(i,Kr);i.length=0,e.getBoundPoints(i)}else i.length>8&&Ve.scanPList(i);return this._affectBySize=Xr.affectBySize,i}}const Xr=new class{constructor(){this.points=[],this.matrix=new V}flushPoints(e,t,i){null==e&&(e=0),null==t&&(t=0),i?(this.matrix.copyTo(qr),qr.concat(i),i=qr):i=this.matrix;let r=this.points.length,s=d.TEMP;for(let a=0;a<r;a+=2)s.setTo(this.points[a]+e,this.points[a+1]+t),null==s.x&&(s.x=0),null==s.y&&(s.y=0),i.transformPoint(s),this.allPoints.push(s.x,s.y);this.points.length=0}concatMatrix(e){e.copyTo(qr),qr.concat(this.matrix),qr.copyTo(this.matrix)}},qr=new V,jr=[],Kr=new G;class $r{static create(e){var t=l.getItemByClass("AlphaCmd",$r);return t.alpha=e,t}recover(){l.recover("AlphaCmd",this)}run(e,t,i){e.alpha(this.alpha)}getBounds(e){}get cmdID(){return $r.ID}}$r.ID="Alpha";class Qr{static create(e,t,i,r){var s=l.getItemByClass("ClipRectCmd",Qr);return s.x=e,s.y=t,s.width=i,s.height=r,s}recover(){l.recover("ClipRectCmd",this)}run(e,t,i){e.clipRect(this.x+t,this.y+i,this.width,this.height)}get cmdID(){return Qr.ID}}Qr.ID="ClipRect";class Zr{constructor(){this.x=0,this.y=0,this.width=1,this.height=1,this.color=4294967295,this.percent=!0}static create(e,t,i,r,s,a,n,o){let h=l.getItemByClass("Draw9GridTextureCmd",Zr);return h.texture=e,e._addReference(),h.x=t,h.y=i,h.width=r,h.height=s,h.sizeGrid=a,h.percent=n,h.color=null!=o?Ai.create(o).numColor:4294967295,h}recover(){var e;null===(e=this.texture)||void 0===e||e._removeReference(),this.texture=null,l.recover("Draw9GridTextureCmd",this)}run(e,t,i){if(this.texture){let r=this.sizeGrid||this.texture._sizeGrid||Jr;if(this.percent&&e.sprite){let s=e.sprite.width,a=e.sprite.height;e.drawTextureWithSizeGrid(this.texture,this.x*s,this.y*a,this.width*s,this.height*a,r,t,i,this.color)}else e.drawTextureWithSizeGrid(this.texture,this.x,this.y,this.width,this.height,r,t,i,this.color)}}get cmdID(){return Zr.ID}getBounds(e){let t=G.TEMP.setTo(this.x,this.y,this.width,this.height);this.percent&&(t.scale(e.width,e.height),e.affectBySize=!0),t.getBoundPoints(e.points)}}Zr.ID="Draw9GridTexture";const Jr=[0,0,0,0,0];Oe.regClass("Draw9GridTextureCmd",Zr);class es{constructor(){this.lineWidth=0}static create(e,t,i,r,s,a){var n=l.getItemByClass("DrawCircleCmd",es);return n.x=e,n.y=t,n.radius=i,n.fillColor=r,n.lineColor=s,n.lineWidth=a,n}recover(){this.fillColor=null,this.lineColor=null,l.recover("DrawCircleCmd",this)}run(e,t,i){let r=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&e.sprite){let s=e.sprite.width,a=e.sprite.height;e._drawCircle(this.x*s+t,this.y*a+i,this.radius*Math.min(s,a)-r,this.fillColor,this.lineColor,this.lineWidth,0)}else e._drawCircle(this.x+t,this.y+i,this.radius-r,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return es.ID}getBounds(e){let t=G.TEMP.setTo(this.x-this.radius,this.y-this.radius,this.radius+this.radius,this.radius+this.radius);this.percent&&(t.scale(e.width,e.height),e.affectBySize=!0),t.getBoundPoints(e.points)}}es.ID="DrawCircle",Oe.regClass("DrawCircleCmd",es);class ts{static create(e,t,i,r,s){var a=l.getItemByClass("DrawCurvesCmd",ts);return a.x=e,a.y=t,a.points=i,a.lineColor=r,a.lineWidth=s,a}recover(){this.points=null,this.lineColor=null,l.recover("DrawCurvesCmd",this)}run(e,t,i){this.points&&e.drawCurves(this.x+t,this.y+i,this.points,this.lineColor,this.lineWidth)}get cmdID(){return ts.ID}getBounds(e){mi.getPoints(this.points,5,2,e.points),e.flushPoints(this.x,this.y)}}ts.ID="DrawCurves",Oe.regClass("DrawCurvesCmd",ts);class is{constructor(){this.color=4294967295}static create(e,t,i,r,s,a){let n=l.getItemByClass("DrawImageCmd",is);return n.texture=e,e&&e._addReference(),n.x=null!=t?t:0,n.y=null!=i?i:0,n.width=null!=r?r:e.sourceWidth,n.height=null!=s?s:e.sourceHeight,n.color=null!=a?Ai.create(a).numColor:4294967295,n}recover(){this.texture&&this.texture._removeReference(),this.texture=null,l.recover("DrawImageCmd",this)}run(e,t,i){let r=this.texture;if(!r)return;let s=this.x,a=this.y,n=this.width,o=this.height,h=n/r.sourceWidth,l=o/r.sourceHeight;n=r.width*h,o=r.height*l,s+=r.offsetX*h,a+=r.offsetY*l,e.drawTexture(this.texture,s+t,a+i,n,o,this.color)}getBounds(e){G.TEMP.setTo(this.x,this.y,this.width,this.height).getBoundPoints(e.points)}get cmdID(){return is.ID}}is.ID="DrawImage";class rs{constructor(){this.lineWidth=0}static create(e,t,i,r,s,a){var n=l.getItemByClass("DrawLineCmd",rs);return n.fromX=e,n.fromY=t,n.toX=i,n.toY=r,n.lineColor=s,n.lineWidth=a,n}recover(){l.recover("DrawLineCmd",this)}run(e,t,i){let r=this.lineWidth<1||this.lineWidth%2==0?0:.5;if(this.percent&&e.sprite){let s=e.sprite.width,a=e.sprite.height;e._drawLine(t,i,this.fromX*s+r,this.fromY*a+r,this.toX*s+r,this.toY*a+r,this.lineColor,this.lineWidth,0)}else e._drawLine(t,i,this.fromX+r,this.fromY+r,this.toX+r,this.toY+r,this.lineColor,this.lineWidth,0)}get cmdID(){return rs.ID}getBounds(e){let t;t=.5*this.lineWidth;let i=this.fromX,r=this.fromY,s=this.toX,a=this.toY;this.percent&&(i*=e.width,r*=e.height,s*=e.width,a*=e.height,e.affectBySize=!0),i==s?e.points.push(i+t,r,s+t,a,i-t,r,s-t,a):r==a?e.points.push(i,r+t,s,a+t,i,r-t,s,a-t):e.points.push(i,r,s,a)}}rs.ID="DrawLine",Oe.regClass("DrawLineCmd",rs);class ss{constructor(){this.lineWidth=0}static create(e,t,i,r,s){var a=l.getItemByClass("DrawLinesCmd",ss);return a.x=e,a.y=t,a.points=i,a.lineColor=r,a.lineWidth=s,a}recover(){this.points=null,this.lineColor=null,l.recover("DrawLinesCmd",this)}run(e,t,i){let r=this.lineWidth<1||this.lineWidth%2==0?0:.5;this.points&&e._drawLines(this.x+r+t,this.y+r+i,this.points,this.lineColor,this.lineWidth,0)}getBounds(e){e.points.push(...this.points),e.flushPoints(this.x,this.y)}get cmdID(){return ss.ID}}ss.ID="DrawLines",Oe.regClass("DrawLinesCmd",ss);class as{static create(e,t,i,r,s){var a=l.getItemByClass("DrawPathCmd",as);return a.x=e,a.y=t,a.paths=i,a.brush=r,a.pen=s,a}recover(){this.paths=null,this.brush=null,this.pen=null,l.recover("DrawPathCmd",this)}run(e,t,i){this.paths&&e._drawPath(this.x+t,this.y+i,this.paths,this.brush,this.pen)}get cmdID(){return as.ID}getBounds(e){let t=this.paths,i=t.length;for(let r=0;r<i;r++){let i=t[r];i.length>1&&(e.points.push(i[1],i[2]),i.length>3&&e.points.push(i[3],i[4]))}e.flushPoints(this.x,this.y)}}as.ID="DrawPath",Oe.regClass("DrawPathCmd",as);class ns{constructor(){this.radius=0,this.lineWidth=0}static create(e,t,i,r,s,a,n,o){var h=l.getItemByClass("DrawPieCmd",ns);return h.x=e,h.y=t,h.radius=i,h._startAngle=r,h._endAngle=s,h.fillColor=a,h.lineColor=n,h.lineWidth=o,h}recover(){this.fillColor=null,this.lineColor=null,l.recover("DrawPieCmd",this)}run(e,t,i){let r=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,s=this.lineColor?this.lineWidth:0;e._drawPie(this.x+r+t,this.y+r+i,this.radius-s,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return ns.ID}get startAngle(){return 180*this._startAngle/Math.PI}set startAngle(e){this._startAngle=e*Math.PI/180}get endAngle(){return 180*this._endAngle/Math.PI}set endAngle(e){this._endAngle=e*Math.PI/180}getBounds(e){let t=e.points,i=Math.PI/180,r=this.endAngle-this.startAngle,s=this.x,a=this.y,n=this.radius;if(r>=360||r<=-360)return t.push(s-n,a-n),t.push(s+n,a-n),t.push(s+n,a+n),void t.push(s-n,a+n);t.push(s,a);var o=r%360;o<0&&(o+=360);var h=this.startAngle+o,l=this.startAngle*i,u=h*i;t.push(s+n*Math.cos(l),a+n*Math.sin(l)),t.push(s+n*Math.cos(u),a+n*Math.sin(u));for(var d=90*Math.ceil(this.startAngle/90),c=90*Math.floor(h/90),_=d;_<=c;_+=90){var p=_*i;t.push(s+n*Math.cos(p),a+n*Math.sin(p))}}}ns.ID="DrawPie",Oe.regClass("DrawPieCmd",ns);class os{static create(e,t,i,r,s,a){var n=l.getItemByClass("DrawPolyCmd",os);return n.x=e,n.y=t,n.points=i,n.fillColor=r,n.lineColor=s,n.lineWidth=a,n}recover(){this.points=null,this.fillColor=null,this.lineColor=null,l.recover("DrawPolyCmd",this)}run(e,t,i){let r=this.points.length<=6,s=this.lineWidth>=1&&this.lineColor?this.lineWidth%2==0?0:.5:0;this.points&&e._drawPoly(this.x+s+t,this.y+s+i,this.points,this.fillColor,this.lineColor,this.lineWidth,r,0)}getBounds(e){e.points.push(...this.points),e.flushPoints(this.x,this.y)}get cmdID(){return os.ID}}os.ID="DrawPoly",Oe.regClass("DrawPolyCmd",os);class hs{constructor(){this.x=0,this.y=0,this.width=1,this.height=1,this.lineWidth=0,this.percent=!0}static create(e,t,i,r,s,a,n,o){var h=l.getItemByClass("DrawRectCmd",hs);return h.x=e,h.y=t,h.width=i,h.height=r,h.fillColor=s,h.lineColor=a,h.lineWidth=n,h.percent=o,h}recover(){this.fillColor=null,this.lineColor=null,l.recover("DrawRectCmd",this)}run(e,t,i){let r=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,s=this.lineColor?this.lineWidth:0;if(this.percent&&e.sprite){let a=e.sprite.width,n=e.sprite.height;e.drawRect(this.x*a+r+t,this.y*n+r+i,this.width*a-s,this.height*n-s,this.fillColor,this.lineColor,this.lineWidth)}else e.drawRect(this.x+r+t,this.y+r+i,this.width-s,this.height-s,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return hs.ID}getBounds(e){let t=G.TEMP.setTo(this.x,this.y,this.width,this.height);this.percent&&(t.scale(e.width,e.height),e.affectBySize=!0),t.getBoundPoints(e.points)}}hs.ID="DrawRect",Oe.regClass("DrawRectCmd",hs);class ls{constructor(){this.x=0,this.y=0,this.width=1,this.height=1,this.percent=!0,this.alpha=1,this.color=4294967295,this.uv=null}static create(e,t,i,r,s,a,n,o,h,u,d){let c=l.getItemByClass("DrawTextureCmd",ls);return c.texture=e,e&&e._addReference(),c.x=null!=t?t:0,c.y=null!=i?i:0,c.width=null!=r?r:e.sourceWidth,c.height=null!=s?s:e.sourceHeight,c.percent=d,c.matrix=a,c.alpha=null!=n?n:1,c.blendMode=h,c.uv=u||null,c.color=null!=o?Ai.create(o).numColor:4294967295,c}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.matrix=null,l.recover("DrawTextureCmd",this)}run(e,t,i){let r=this.texture;if(!r)return;let s=this.x,a=this.y,n=this.width,o=this.height;this.percent&&e.sprite&&(s*=e.sprite.width,a*=e.sprite.height,n*=e.sprite.width,o*=e.sprite.height);let h=n/r.sourceWidth,l=o/r.sourceHeight;n=r.width*h,o=r.height*l,s+=r.offsetX*h,a+=r.offsetY*l,e.drawTextureWithTransform(this.texture,s,a,n,o,this.matrix,t,i,this.alpha,this.blendMode,this.uv,this.color)}getBounds(e){let t=G.TEMP.setTo(this.x,this.y,this.width,this.height);this.percent&&(t.scale(e.width,e.height),e.affectBySize=!0),t.getBoundPoints(e.points)}get cmdID(){return ls.ID}}ls.ID="DrawTexture",Oe.regClass("DrawTextureCmd",ls);class us{static create(e,t,i){var r=l.getItemByClass("DrawTexturesCmd",us);return r.texture=e,e._addReference(),r.pos=t,r.colors=i||[],r}recover(){this.texture._removeReference(),this.texture=null,this.pos=null,l.recover("DrawTexturesCmd",this)}run(e,t,i){e.drawTextures(this.texture,this.pos,t,i,this.colors)}getBounds(e){if(this.texture){let t=this.texture.width,i=this.texture.height;for(let r=0,s=this.pos.length;r<s;r+=2){let s=this.pos[r],a=this.pos[r+1];G.TEMP.setTo(s,a,t,i).getBoundPoints(e.points)}}}get cmdID(){return us.ID}}us.ID="DrawTextures";class ds{static create(e,t,i,r,s,a,n,o,h,u){var d=l.getItemByClass("DrawTrianglesCmd",ds);return d.texture=e,e._addReference(),d.x=t,d.y=i,d.vertices=r,d.uvs=s,d.indices=a,d.matrix=n,d.alpha=o,d.color=null!=h?Ai.create(h).numColor:4294967295,d.blendMode=u,d}recover(){var e;null===(e=this.texture)||void 0===e||e._removeReference(),this.texture=null,this.vertices=null,this.uvs=null,this.indices=null,this.matrix=null,l.recover("DrawTrianglesCmd",this)}run(e,t,i){e.drawTriangles(this.texture,this.x+t,this.y+i,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.blendMode,this.color)}get cmdID(){return ds.ID}getBounds(e){let t=this.vertices;var i=t.length;if(!(i<2)){for(var r=t[0],s=t[1],a=r,n=s,o=2;o<i;){var h=t[o++],l=t[o++];r>h&&(r=h),s>l&&(s=l),a<h&&(a=h),n<l&&(n=l)}e.points.push(r,s,a,s,a,n,r,n)}}}ds.ID="DrawTriangles",Oe.regClass("DrawTrianglesCmd",ds);class cs{constructor(){this.x=0,this.y=0,this._strokeColor="#000000",this._loosyBound=null}get text(){return this._text}set text(e){this._text=e}get strokeColor(){return this._strokeColor}set strokeColor(e){this._strokeColor=e}get stroke(){return this._stroke}set stroke(e){this._stroke=e}get align(){return this._align}set align(e){this._align=e}static create(e,t,i,r,s,a,n,o){var h=l.getItemByClass("FillTextCmd",cs);switch(h._text=null,h._wordText=null,h.x=t,h.y=i,h.font=r,h.color=s,h._stroke=n,h._strokeColor=o,a){case"center":h._align=Ue.ENUM_TEXTALIGN_CENTER;break;case"right":h._align=Ue.ENUM_TEXTALIGN_RIGHT;break;default:h._align=Ue.ENUM_TEXTALIGN_DEFAULT}return e instanceof lr?(h._wordText=e,e.cleanCache()):h._text=e,h}recover(){l.recover("FillTextCmd",this)}run(e,t,i){h.stage.isGlobalRepaint()&&this._wordText&&this._wordText.cleanCache(),null==this._text&&(this._text=""),null==this._fontObj&&(this.font=null),null==this._color&&(this._color="#ffffff"),e._fast_filltext(this._wordText||this._text,this.x+t,this.y+i,this._fontObj,this._color,this._strokeColor,this._stroke,this._align)}get cmdID(){return cs.ID}get font(){return this._font}set font(e){this._font=e,e||(e=t.defaultFontSize+"px "+t.defaultFont),this._fontObj=nr.parse(e),this._wordText&&this._wordText.cleanCache()}get color(){return this._color}set color(e){this._color=e,this._wordText&&this._wordText.cleanCache()}getBounds(e){if(!this._loosyBound){let e=h.Browser.context;e.save(),e.font=this.font;let t=e.measureText(this.text).width;e.restore();let i=this.x,r=this.y;switch(this._align){case Ue.ENUM_TEXTALIGN_CENTER:i-=t/2;break;case Ue.ENUM_TEXTALIGN_RIGHT:i-=t}this._fontObj||(this.font=null),i-=4,r-=this._fontObj._size,this._loosyBound=new G(i,r,t+8,2*this._fontObj._size)}G.TEMP.setTo(this._loosyBound.x,this._loosyBound.y,this._loosyBound.width,this._loosyBound.height).getBoundPoints(e.points)}}cs.ID="FillText",Oe.regClass("FillTextCmd",cs);class _s{constructor(){this.x=0,this.y=0,this.width=1,this.height=1,this.type="repeat",this.percent=!0,this.color=4294967295}static create(e,t,i,r,s,a,n,o,h){null==r&&(r=e.width),null==s&&(s=e.height);var u=l.getItemByClass("FillTextureCmd",_s);return u.texture=e,e._addReference(),u.x=t,u.y=i,u.width=r,u.height=s,u.type=a,u.offset=n,u.color=null!=o?Ai.create(o).numColor:4294967295,u.percent=h,u}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.offset=null,l.recover("FillTextureCmd",this)}run(e,t,i){if(this.texture)if(this.percent&&e.sprite){let r=e.sprite.width,s=e.sprite.height;e.fillTexture(this.texture,this.x*r+t,this.y*s+i,this.width*r,this.height*s,this.type,this.offset||d.EMPTY,this.color)}else e.fillTexture(this.texture,this.x+t,this.y+i,this.width,this.height,this.type,this.offset||d.EMPTY,this.color)}getBounds(e){let t=G.TEMP.setTo(this.x,this.y,this.width,this.height);this.percent&&(t.scale(e.width,e.height),e.affectBySize=!0),t.getBoundPoints(e.points)}get cmdID(){return _s.ID}}_s.ID="FillTexture",Oe.regClass("FillTextureCmd",_s);class ps{static create(e,t,i){var r=l.getItemByClass("RotateCmd",ps);return r.angle=e,r.pivotX=t,r.pivotY=i,r}recover(){l.recover("RotateCmd",this)}run(e,t,i){e._rotate(this.angle,this.pivotX+t,this.pivotY+i)}getBounds(e){gs.identity(),gs.translate(-this.pivotX,-this.pivotY),gs.rotate(this.angle),gs.translate(this.pivotX,this.pivotY),e.concatMatrix(gs)}get cmdID(){return ps.ID}}ps.ID="Rotate";const gs=new V;class ms{static create(e,t,i,r){var s=l.getItemByClass("ScaleCmd",ms);return s.scaleX=e,s.scaleY=t,s.pivotX=i,s.pivotY=r,s}recover(){l.recover("ScaleCmd",this)}run(e,t,i){e._scale(this.scaleX,this.scaleY,this.pivotX+t,this.pivotY+i)}getBounds(e){fs.identity(),fs.translate(-this.pivotX,-this.pivotY),fs.scale(this.scaleX,this.scaleY),fs.translate(this.pivotX,this.pivotY),e.concatMatrix(fs)}get cmdID(){return ms.ID}}ms.ID="Scale";const fs=new V;class Ts{static create(e,t,i){var r=l.getItemByClass("TransformCmd",Ts);return r.matrix=e,r.pivotX=t,r.pivotY=i,r}recover(){this.matrix=null,l.recover("TransformCmd",this)}run(e,t,i){e._transform(this.matrix,this.pivotX+t,this.pivotY+i)}getBounds(e){ys.identity(),ys.translate(-this.pivotX,-this.pivotY),ys.concat(this.matrix),ys.translate(this.pivotX,this.pivotY),e.concatMatrix(ys)}get cmdID(){return Ts.ID}}Ts.ID="Transform";const ys=new V;class xs{static create(e,t){var i=l.getItemByClass("TranslateCmd",xs);return i.tx=e,i.ty=t,i}recover(){l.recover("TranslateCmd",this)}run(e){e.translate(this.tx,this.ty)}getBounds(e){vs.identity(),vs.translate(this.tx,this.ty),e.concatMatrix(vs)}get cmdID(){return xs.ID}}xs.ID="Translate";const vs=new V;class Ss{constructor(){this.lineWidth=0}static create(e,t,i,r,s,a,n,o){var h=l.getItemByClass("DrawEllipseCmd",Ss);return h.x=e,h.y=t,h.width=i,h.height=r,h.fillColor=s,h.lineColor=a,h.lineWidth=n,h.percent=o,h}recover(){this.fillColor=null,this.lineColor=null,l.recover("DrawEllipseCmd",this)}run(e,t,i){let r=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&e.sprite){let s=e.sprite.width,a=e.sprite.height;e._drawEllipse(this.x*s+t,this.y*a+i,this.width*s-r,this.height*a-r,this.fillColor,this.lineColor,this.lineWidth)}else e._drawEllipse(this.x+t,this.y+i,this.width-r,this.height-r,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return Ss.ID}getBounds(e){let t=G.TEMP.setTo(this.x-this.width,this.y-this.height,2*this.width,2*this.height);this.percent&&(t.scale(e.width,e.height),e.affectBySize=!0),t.getBoundPoints(e.points)}}Ss.ID="DrawEllipse",Oe.regClass("DrawEllipseCmd",Ss);class Ds{constructor(){this.x=0,this.y=0,this.width=1,this.height=1,this.lt=6,this.rt=6,this.lb=6,this.rb=6,this.lineWidth=0,this.percent=!0}static create(e,t,i,r,s,a,n,o,h,u,d,c){var _=l.getItemByClass("DrawRoundRectCmd",Ds);return _.x=e,_.y=t,_.width=i,_.height=r,_.lt=s,_.rt=a,_.lb=n,_.rb=o,_.fillColor=h,_.lineColor=u,_.lineWidth=d,_.percent=c,_}recover(){this.fillColor=null,this.lineColor=null,l.recover("DrawRoundRectCmd",this)}run(e,t,i){let r=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,s=this.lineColor?this.lineWidth:0;if(this.percent&&e.sprite){let a=e.sprite.width,n=e.sprite.height;e._drawRoundRect(this.x*a+r+t,this.y*n+r+i,this.width*a-s,this.height*n-s,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}else e._drawRoundRect(this.x+r+t,this.y+r+i,this.width-s,this.height-s,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return Ds.ID}getBounds(e){let t=G.TEMP.setTo(this.x,this.y,this.width,this.height);this&&(t.scale(e.width,e.height),e.affectBySize=!0),t.getBoundPoints(e.points)}}Ds.ID="DrawRoundRect",Oe.regClass("DrawRoundRectCmd",Ds);class Es{static add2DGlobalUniformData(e,t,i){g.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal").addShaderUniform(e,t,i)}constructor(){this._sp=null,this._render=this._renderEmpty,this._cmds=[],this._vectorgraphArray=null,this._graphicBounds=null,this._createData()}_createData(){}_clearData(){}_destroyData(){}destroy(){this.clear(!0),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0,this._sp=null),this._material&&(this._material._removeReference(),this._material=null),this._destroyData()}clear(e=!0){if(e)for(let e=0,t=this._cmds.length;e<t;e++)this._cmds[e].recover();this._cmds.length=0,this._render=this._renderEmpty,this._clearData(),this._sp&&(this._sp._renderType&=~je.GRAPHICS),this._repaint()}_clearBoundsCache(e){this._graphicBounds&&(e&&!this._graphicBounds._affectBySize||this._graphicBounds.reset())}_repaint(){this._clearBoundsCache(),this._sp&&this._sp.repaint()}_isOnlyOne(){return 1===this._cmds.length}get cmds(){return this._cmds}set cmds(e){this._cmds=e,this.onCmdsChanged()}addCmd(e,t){if(null!=e)return null==t||t>=this._cmds.length?this._cmds.push(e):this._cmds.splice(t,0,e),this.onCmdsChanged(),e;console.warn("null cmd")}removeCmd(e){let t=this.cmds.indexOf(e);-1!=t&&(this._cmds.splice(t,1),this.onCmdsChanged())}replaceCmd(e,t,i){let r=this._cmds.indexOf(e);return null!=t?-1!==r?(this._cmds[r]=t,this._repaint()):(this._cmds.push(t),this.onCmdsChanged()):-1!=r&&(this._cmds.splice(r,1),this.onCmdsChanged()),t}onCmdsChanged(){let e=this._cmds.length;this._sp&&e>0&&(this._sp._renderType|=je.GRAPHICS),this._render=0===e?this._renderEmpty:1===e?this._renderOne:this._renderAll,this._repaint()}getBounds(e){return this._graphicBounds||(this._graphicBounds=Yr.create()),this._graphicBounds.getBounds(this,e)}getBoundPoints(e){return this._graphicBounds||(this._graphicBounds=Yr.create()),this._graphicBounds.getBoundPoints(this,e)}get material(){return this._material}set material(e){this._material!=e&&(this._material&&this._material._removeReference(),this._material=e,null!=e&&e._addReference())}drawImage(e,t=0,i=0,r=null,s=null,a=null){return e&&e.bitmap?this.addCmd(is.create(e,t,i,r,s,a)):null}drawTexture(e,t=0,i=0,r=null,s=null,a=null,n=1,o=null,h=null,l){return!e||n<.01?null:e.bitmap?this.addCmd(ls.create(e,t,i,r,s,a,n,o,h,l)):null}drawTextures(e,t,i){return e?this.addCmd(us.create(e,t,i)):null}drawTriangles(e,t,i,r,s,a,n=null,o=1,h=null,l=null){return this.addCmd(ds.create(e,t,i,r,s,a,n,o,h,l))}fillTexture(e,t,i,r=0,s=0,a="repeat",n=null,o=null,h=!1){return e&&e.bitmap?this.addCmd(_s.create(e,t,i,r,s,a,n||d.EMPTY,o,h)):null}clipRect(e,t,i,r){return this.addCmd(Qr.create(e,t,i,r))}fillText(e,t,i,r,s,a){return this.addCmd(cs.create(e,t,i,r,s,a,0,""))}fillBorderText(e,t,i,r,s,a,n,o){return this.addCmd(cs.create(e,t,i,r,s,a,n,o))}strokeText(e,t,i,r,s,a,n){return this.addCmd(cs.create(e,t,i,r,null,n,a,s))}alpha(e){return this.addCmd($r.create(e))}transform(e,t=0,i=0){return this.addCmd(Ts.create(e,t,i))}rotate(e,t=0,i=0){return this.addCmd(ps.create(e,t,i))}scale(e,t,i=0,r=0){return this.addCmd(ms.create(e,t,i,r))}translate(e,t){return this.addCmd(xs.create(e,t))}save(){return this.addCmd(Wr.create())}restore(){return this.addCmd(Hr.create())}replaceTextColor(e){this._repaint();let t=this._cmds;for(let i=t.length-1;i>-1;i--){let r=t[i];switch(r.cmdID){case cs.ID:r.color=e;break;case is.ID:r.color=null!=e?Ai.create(e).numColor:4294967295}}}loadImage(e,t=0,i=0,r=null,s=null,a=null){let n=h.loader.getRes(e);n?(this.drawImage(n,t,i,r,s),a&&a.call(this._sp)):h.loader.load(e).then((e=>{this.drawImage(e,t,i,r,s),a&&a.call(this._sp)}))}_renderEmpty(e,t,i,r){}_renderAll(e,t,i,r){t.sprite=e,t._material=this._material;var s=this._cmds;for(let e=0,a=s.length;e<a;e++)s[e].run(t,i,r);t._material=null}_renderOne(e,t,i,r){t.sprite=e,t._material=this._material,this._cmds[0].run(t,i,r),t._material=null}drawLine(e,t,i,r,s,a=1){return this.addCmd(rs.create(e,t,i,r,s,a))}drawLines(e,t,i,r,s=1){return!i||i.length<4?null:this.addCmd(ss.create(e,t,i,r,s))}drawCurves(e,t,i,r,s=1){return this.addCmd(ts.create(e,t,i,r,s))}drawRect(e,t,i,r,s,a=null,n=1,o){return this.addCmd(hs.create(e,t,i,r,s,a,n,o))}drawRoundRect(e,t,i,r,s,a,n,o,h,l=null,u=1,d){return this.addCmd(Ds.create(e,t,i,r,s,a,n,o,h,l,u,d))}drawCircle(e,t,i,r,s=null,a=1){return this.addCmd(es.create(e,t,i,r,s,a))}drawEllipse(e,t,i,r,s,a,n,o){return this.addCmd(Ss.create(e,t,i,r,s,a,n,o))}drawPie(e,t,i,r,s,a,n=null,o=1){return this.addCmd(ns.create(e,t,i,O.toRadian(r),O.toRadian(s),a,n,o))}drawPoly(e,t,i,r,s=null,a=1){return this.addCmd(os.create(e,t,i,r,s,a))}drawPath(e,t,i,r=null,s=null){return this.addCmd(as.create(e,t,i,r,s))}draw9Grid(e,t=0,i=0,r=0,s=0,a,n){this.addCmd(Zr.create(e,t,i,r,s,a,!1,n))}}const ws=[],Rs=ke.ACTIVE|ke.ACTUAL_VISIBLE,Cs=ke.DISPLAY;class As extends D{get url(){return this._url}set url(e){this._url=e}get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}get is3D(){return 1===this._nodeType}get destroyed(){return this._destroyed}constructor(){super(),this._bits=0,this._reactiveBits=0,this._hideFlags=0,this._parent=null,this._destroyed=!1,this._nodeType=0,this.name="",this._bits=Rs,this._reactiveBits=Cs,this._children=[],this._$children=this._children,this._$container=this,this._initialize()}_initialize(){this._extra={}}_setBit(e,t){return 0==(this._bits&e)!=!t&&(t?this._bits|=e:this._bits&=~e,0!=(e&this._reactiveBits)&&this._onSetBit(e,t),!0)}_getBit(e){return 0!=(this._bits&e)}_onSetBit(e,t){if(0!=(e&ke.DISPLAY)){let e=this._parent,t=h.stage,i=!1;for(;e;){if(0!=(e._bits&ke.DISPLAY)){i=0!=(e._bits&ke.DISPLAYED_INSTAGE);break}if(e===t){i=!0;break}e=e._parent}this._setBit(ke.DISPLAYED_INSTAGE,i)}}_setBitUp(e){let t=this;for(t._setBit(e,!0),t=t._parent;t;){if(0!=(t._bits&e))return;t._setBit(e,!0),t=t._parent}}onStartListeningToType(e){e!==c.DISPLAY&&e!==c.UNDISPLAY||0!=(this._bits&ke.DISPLAY)||this._setBitUp(ke.DISPLAY)}bubbleEvent(e,t){let i=[];i.length=0;let r,s=this;for(;s;)s.activeInHierarchy&&i.push(s),s=s._parent;t instanceof c&&(r=t,r._stopped=!1);for(let s of i)if(r){if(r.setTo(e,s,this),s.event(e,t),r._stopped)break}else s.event(e,t)}hasHideFlag(e){return 0!=(this._hideFlags&e)}destroy(e=!0){if(!this._destroyed){this._destroyed=!0,this.destroyAllComponent(),this._parent&&this._parent._removeChild(this);for(let t=0,i=this._children.length;t<i;t++){let t=this._children[0];this._children.shift(),t._setParent(null),e&&t.destroy()}this.onDestroy(),this.offAll()}}onDestroy(){}destroyChildren(){for(let e=0,t=this._$children.length;e<t;e++)this._$children[0].destroy(!0)}get children(){return this._$children}addChild(e){return this.addChildAt(e,this._$children.length)}addChildren(...e){let t=0,i=e.length;for(;t<i;)this.addChildAt(e[t++],this._$children.length)}addChildAt(e,t){if(t>=0&&t<=this._$children.length)return e._$parent===this?this.setChildIndex(e,t):(e._parent&&e._parent.removeChild(e),this._$children.splice(t,0,e),e._$parent=this,e._setParent(this._$container)),e;throw new H(t)}getChildIndex(e){return this._$children.indexOf(e)}getChild(e,t){for(let t of this._$children)if(t.name===e)return t;return null}getChildByName(e,t){return this.getChild(e,t)}getChildAt(e,t){if(e>=0&&e<this.numChildren)return this._$children[e];throw new H(e)}getChildByPath(e,t){let i,r=e.split("."),s=r.length,a=this;for(let e=0;e<s&&(i=a.getChild(r[e],t),i);++e)a=i;return i}findChild(e,t){for(let i of this.children){if(i.name==e)return i;if(!i.url&&(i=i.findChild(e,t),i))return i}return null}setChildIndex(e,t){let i=this._$children.indexOf(e);if(i<0)throw new Error("not a child of this node");return this._setChildIndex(e,i,t),e}setChildIndexBefore(e,t){let i=this._$children.indexOf(e);if(-1==i)throw new Error("not a child of this node");return i<t?this._setChildIndex(e,i,t-1):this._setChildIndex(e,i,t)}_setChildIndex(e,t,i){let r=this._$children.length;return i>r&&(i=r),t==i?t:(this._$children.splice(t,1),i>=this._$children.length?this._$children.push(e):this._$children.splice(i,0,e),this._$container._childChanged(),i)}_childChanged(e){}removeChild(e,t){let i=this._$children.indexOf(e);if(-1==i)throw new Error("not a child of this node");return this._$children.splice(i,1),e._setParent(null),t&&e.destroy(),e}removeSelf(){return this._parent&&this._parent._removeChild(this),this}removeChildByName(e,t){let i=this.getChild(e);return i&&this.removeChild(i,t),i}removeChildAt(e,t){let i=this._$children[e];return this._$children.splice(e,1),i._setParent(null),t&&i.destroy(),i}removeChildren(e,t,i){e=e||0,null==t&&(t=-1),(t<0||t>=this._$children.length)&&(t=this._$children.length-1);for(let r=e;r<=t;++r)this.removeChildAt(e,i)}replaceChild(e,t){let i=this._$children.indexOf(t);if(-1==i)throw new Error("not a child of this node");return this.removeChildAt(i),this.addChildAt(e,i)}_setContainer(e){this._$container=e,this._$children=e._children}_addChild(e,t){let i=this._children;if(null==t&&(t=i.length),t>=0&&t<=i.length){if(e._parent===this){let r=i.indexOf(e);i.splice(r,1),t>=i.length?i.push(e):i.splice(t,0,e),this._childChanged(e)}else e._parent&&e._parent.removeChild(e),i.splice(t,0,e),e._$parent=this,e._setParent(this);return e}throw new H(t)}_removeChild(e){let t=this._children.indexOf(e);if(-1==t)throw new Error("not a child of this node");return this._children.splice(t,1),e._setParent(null),e}get numChildren(){return this._$children.length}get parent(){return this._$parent}isAncestorOf(e){if(!e)return!1;let t=e._parent;for(;t;){if(t==this)return!0;t=t._parent}return!1}_setParent(e){if(e)this._parent=e,this._onAdded(),this.event(c.ADDED),0!=(this._bits&ke.DISPLAY)&&(this._setBitUp(ke.DISPLAY),e.displayedInStage&&this._displayChild(this,!0)),e._childChanged(this);else{this._onRemoved(),this.event(c.REMOVED);let e=this._parent;0!=(this._bits&ke.DISPLAY)&&this._displayChild(this,!1),this._parent=null,this._$parent=null,e._destroyed||e._childChanged(this)}}get displayedInStage(){return 0==(this._bits&ke.DISPLAY)&&this._setBitUp(ke.DISPLAY),0!=(this._bits&ke.DISPLAYED_INSTAGE)}_setDisplay(e){0!=(this._bits&ke.DISPLAYED_INSTAGE)!==e&&(this._setBit(ke.DISPLAYED_INSTAGE,e),e?this.event(c.DISPLAY):this.event(c.UNDISPLAY))}_displayChild(e,t){for(let i of e._children)0!=(i._bits&ke.DISPLAY)&&(i._children.length>0?this._displayChild(i,t):i._setDisplay(t));e._setDisplay(t)}contains(e){if(e===this)return!0;for(;e;){if(e._parent===this)return!0;e=e._parent}return!1}timerLoop(e,t,i,r=null,s=!0,a=!1){this.timer.loop(e,t,i,r,s,a)}timerOnce(e,t,i,r=null,s=!0){this.timer._create(!1,!1,e,t,i,r,s)}frameLoop(e,t,i,r=null,s=!0){this.timer._create(!0,!0,e,t,i,r,s)}frameOnce(e,t,i,r=null,s=!0){this.timer._create(!0,!1,e,t,i,r,s)}clearTimer(e,t){this.timer.clear(e,t)}callLater(e,t=null){this.timer.callLater(this,e,t)}runCallLater(e){this.timer.runCallLater(this,e)}get scene(){return this._scene}get stage(){return h.stage}get active(){return 0!=(this._bits&ke.ACTIVE)}set active(e){var t;if(e=!!e,0!=(this._bits&ke.ACTIVE)!==e){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");this._setBit(ke.ACTIVE,e),(null===(t=this._parent)||void 0===t?void 0:t.activeInHierarchy)&&0==(this._bits&ke.NOT_IN_PAGE)&&this._processActive(e,!0)}}get activeInHierarchy(){return 0!=(this._bits&ke.ACTIVE_INHIERARCHY)}_onActive(){dt.spriteCount++}_onInActive(){dt.spriteCount--}_onActiveInScene(){}_onInActiveInScene(){}onAwake(){}onEnable(){}onDisable(){}_parse(e,t){}_setBelongScene(e){if(!this._scene||this.scene!=e){this._scene=e,this._onActiveInScene();for(let t of this._children)t._setBelongScene(e)}}_setUnBelongScene(){if(this._scene!==this){this._onInActiveInScene(),this._scene=null;for(let e of this._children)e._setUnBelongScene()}}_processActive(e,t){this._activeChangeScripts||(this._activeChangeScripts=[]);let i=this._activeChangeScripts;e?this._activeHierarchy(i,t):this._inActiveHierarchy(i,t);for(let t=0,r=i.length;t<r;t++){let r=i[t];r.owner&&r._setActive(e)}i.length=0}_activeHierarchy(e,t){if(this._setBit(ke.ACTIVE_INHIERARCHY,!0),this._components)for(let t=0,i=this._components.length;t<i;t++){let i=this._components[t];i._isScript()?i._enabled&&e.push(i):i._setActive(!0)}this._onActive();for(let i of this._children)0!=(i._bits&ke.ACTIVE)&&0==(i._bits&ke.NOT_IN_PAGE)&&i._activeHierarchy(e,t);0==(this._bits&ke.AWAKED)&&(this._setBit(ke.AWAKED,!0),this.onAwake()),this.onEnable()}_inActiveHierarchy(e,t){if(this._onInActive(),this._components)for(let t=0,i=this._components.length;t<i;t++){let i=this._components[t];i._isScript()?i._enabled&&e.push(i):i._setActive(!1)}this._setBit(ke.ACTIVE_INHIERARCHY,!1);for(let i of this._children)0!=(i._bits&ke.ACTIVE)&&i._inActiveHierarchy(e,t);this.onDisable()}_onAdded(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");{let e=this._parent.scene;e&&this._setBelongScene(e),this._parent.activeInHierarchy&&0!=(this._bits&ke.ACTIVE)&&0==(this._bits&ke.NOT_IN_PAGE)&&this._processActive(!0)}}_onRemoved(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");this._parent.activeInHierarchy&&0!=(this._bits&ke.ACTIVE)&&0==(this._bits&ke.NOT_IN_PAGE)&&this._processActive(!1),this._parent.scene&&this._setUnBelongScene()}_addComponentInstance(e){var t;e._singleton&&this.getComponent(e.constructor)&&console.warn("the component is singleton, can't add the second one.",e),this._components||(this._components=[]),this._components.push(e),e._setOwner(this),this.activeInHierarchy&&e._setActive(!0),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,0)}_destroyComponent(e){var t;if(!this._components)return;let i=this._components.indexOf(e);-1!=i&&(this._components.splice(i,1),e._destroy(),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,1))}destroyAllComponent(){var e;if(this._components){for(let e=0,t=this._components.length;e<t;e++){let t=this._components[e];t&&!t.destroyed&&t._destroy()}this._components.length=0,null===(e=this._componentsChanged)||void 0===e||e.call(this,null,2)}}_cloneTo(e,t,i){if(this._components)for(let t=0,i=this._components.length;t<i;t++){let i=e.addComponent(this._components[t].constructor);this._components[t]._cloneTo(i)}}addComponentInstance(e){if(e.owner)throw new Error("the component is belong to other node.");return this._addComponentInstance(e),e}addComponent(e){let t=l.createByClass(e);if(!t)throw new Error("missing "+e.toString());return this._addComponentInstance(t),t}getComponent(e){if(this._components)for(let t=0,i=this._components.length;t<i;t++){let i=this._components[t];if(i instanceof e)return i}return null}get components(){return this._components||ws}getComponents(e){let t=[];if(this._components)for(let i=0,r=this._components.length;i<r;i++){let r=this._components[i];r instanceof e&&(t=t||[],t.push(r))}return t}get timer(){return this._scene?this._scene.timer:h.timer}onAfterDeserialize(){}}var Ms={linear:Bs,linearNone:Bs,linearIn:function(e,t,i,r){return i*e/r+t},linearInOut:function(e,t,i,r){return i*e/r+t},linearOut:function(e,t,i,r){return i*e/r+t},bounceIn:function(e,t,i,r){return i-Ms.bounceOut(r-e,0,i,r)+t},bounceInOut:function(e,t,i,r){return e<.5*r?.5*Ms.bounceIn(2*e,0,i,r)+t:.5*Ms.bounceOut(2*e-r,0,i,r)+.5*i+t},bounceOut:function(e,t,i,r){return(e/=r)<1/2.75?i*(7.5625*e*e)+t:e<2/2.75?i*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?i*(7.5625*(e-=2.25/2.75)*e+.9375)+t:i*(7.5625*(e-=2.625/2.75)*e+.984375)+t},backIn:function(e,t,i,r,s=1.70158){return i*(e/=r)*e*((s+1)*e-s)+t},backInOut:function(e,t,i,r,s=1.70158){return(e/=.5*r)<1?.5*i*(e*e*((1+(s*=1.525))*e-s))+t:i/2*((e-=2)*e*((1+(s*=1.525))*e+s)+2)+t},backOut:function(e,t,i,r,s=1.70158){return i*((e=e/r-1)*e*((s+1)*e+s)+1)+t},elasticIn:function(e,t,i,r,s=0,a=0){var n;if(0==e)return t;if(1==(e/=r))return t+i;a||(a=.3*r);!s||i>0&&s<i||i<0&&s<-i?(s=i,n=a/4):n=a/Is*Math.asin(i/s);return-s*Math.pow(2,10*(e-=1))*Math.sin((e*r-n)*Is/a)+t},elasticInOut:function(e,t,i,r,s=0,a=0){var n;if(0==e)return t;if(2==(e/=.5*r))return t+i;a||(a=r*(.3*1.5));!s||i>0&&s<i||i<0&&s<-i?(s=i,n=a/4):n=a/Is*Math.asin(i/s);return e<1?s*Math.pow(2,10*(e-=1))*Math.sin((e*r-n)*Is/a)*-.5+t:s*Math.pow(2,-10*(e-=1))*Math.sin((e*r-n)*Is/a)*.5+i+t},elasticOut:function(e,t,i,r,s=0,a=0){var n;if(0==e)return t;if(1==(e/=r))return t+i;a||(a=.3*r);!s||i>0&&s<i||i<0&&s<-i?(s=i,n=a/4):n=a/Is*Math.asin(i/s);return s*Math.pow(2,-10*e)*Math.sin((e*r-n)*Is/a)+i+t},strongIn:function(e,t,i,r){return i*(e/=r)*e*e*e*e+t},strongInOut:function(e,t,i,r){return(e/=.5*r)<1?.5*i*e*e*e*e*e+t:.5*i*((e-=2)*e*e*e*e+2)+t},strongOut:function(e,t,i,r){return i*((e=e/r-1)*e*e*e*e+1)+t},sineInOut:function(e,t,i,r){return.5*-i*(Math.cos(Math.PI*e/r)-1)+t},sineIn:function(e,t,i,r){return-i*Math.cos(e/r*bs)+i+t},sineOut:function(e,t,i,r){return i*Math.sin(e/r*bs)+t},quintIn:function(e,t,i,r){return i*(e/=r)*e*e*e*e+t},quintInOut:function(e,t,i,r){return(e/=.5*r)<1?.5*i*e*e*e*e*e+t:.5*i*((e-=2)*e*e*e*e+2)+t},quintOut:function(e,t,i,r){return i*((e=e/r-1)*e*e*e*e+1)+t},quartIn:function(e,t,i,r){return i*(e/=r)*e*e*e+t},quartInOut:function(e,t,i,r){return(e/=.5*r)<1?.5*i*e*e*e*e+t:.5*-i*((e-=2)*e*e*e-2)+t},quartOut:function(e,t,i,r){return-i*((e=e/r-1)*e*e*e-1)+t},cubicIn:function(e,t,i,r){return i*(e/=r)*e*e+t},cubicInOut:function(e,t,i,r){return(e/=.5*r)<1?.5*i*e*e*e+t:.5*i*((e-=2)*e*e+2)+t},cubicOut:function(e,t,i,r){return i*((e=e/r-1)*e*e+1)+t},quadIn:function(e,t,i,r){return i*(e/=r)*e+t},quadInOut:function(e,t,i,r){return(e/=.5*r)<1?.5*i*e*e+t:.5*-i*(--e*(e-2)-1)+t},quadOut:function(e,t,i,r){return-i*(e/=r)*(e-2)+t},expoIn:function(e,t,i,r){return 0==e?t:i*Math.pow(2,10*(e/r-1))+t-.001*i},expoInOut:function(e,t,i,r){return 0==e?t:e==r?t+i:(e/=.5*r)<1?.5*i*Math.pow(2,10*(e-1))+t:.5*i*(2-Math.pow(2,-10*--e))+t},expoOut:function(e,t,i,r){return e==r?t+i:i*(1-Math.pow(2,-10*e/r))+t},circIn:function(e,t,i,r){return-i*(Math.sqrt(1-(e/=r)*e)-1)+t},circInOut:function(e,t,i,r){return(e/=.5*r)<1?.5*-i*(Math.sqrt(1-e*e)-1)+t:.5*i*(Math.sqrt(1-(e-=2)*e)+1)+t},circOut:function(e,t,i,r){return i*Math.sqrt(1-(e=e/r-1)*e)+t}};const bs=.5*Math.PI,Is=2*Math.PI;function Bs(e,t,i,r){return i*e/r+t}class Ls{constructor(e){this._props=e,this.nums=[]}get(e){let t=this._props.find((t=>t.name==e));if(!t)throw new Error(`Property '${e}' is not in tween.`);return this.read(t.type,t.offset)}set(e,t){let i=this._props.find((t=>t.name==e));if(!i)throw new Error(`Property '${e}' is not in tween.`);this.write(i.type,i.offset,t)}getAt(e){let t=this._props[e];if(!t)throw new H(e);return this.read(t.type,t.offset)}setAt(e,t){let i=this._props[e];if(!i)throw new H(e);this.write(i.type,i.offset,t)}get count(){return this._props.length}copy(e){return this.nums.length=0,this.nums.push(...e.nums),this}read(e,t){switch(e){case 0:return this.nums[t];case 1:return!!this.nums[t];case 2:return m.hexToString(this.nums[t]);default:return e.read(this.nums,t)}}write(e,t,i){switch(e){case 0:this.nums[t]=i;break;case 1:this.nums[t]=i?1:0;break;case 2:this.nums[t]=m.stringToHex(i);break;default:Ps.length=0,e.write(Ps,i),Ps.forEach(((e,i)=>this.nums[t+i]=e))}}}const Ps=[];function Ns(e,t){t.writeTo(e,e.length)}const Os=Symbol(),Fs=new Gt;Gt.prototype[Os]={write:Ns,read:(e,t)=>Fs.setValue(e[t],e[t+1])};const Us=new a;a.prototype[Os]={write:Ns,read:(e,t)=>Us.setValue(e[t],e[t+1],e[t+2])};const ks=new s;s.prototype[Os]={write:Ns,read:(e,t)=>ks.setValue(e[t],e[t+1],e[t+2],e[t+3])};const Gs=new m;m.prototype[Os]={write:Ns,read:(e,t)=>Gs.setValue(e[t],e[t+1],e[t+2],e[t+3])};const Vs=new d;d.prototype[Os]={write:(e,t)=>{e.push(t.x,t.y)},read:(e,t)=>Vs.setTo(e[t],e[t+1])};class zs{static create(e){let t=zs._pool.take();return Ys[Ws++]=t,t.owner=e,t}static getTween(e){return Xs.get(e)}static isTweening(e){if(null==e)return!1;for(let t=0;t<Ws;t++){let i=Ys[t];if(i&&i.target==e&&!i._killed)return!0}return!1}static getTweens(e,t){if(t=t||[],null==e)return t;let i=Ws;for(let r=0;r<i;r++){let i=Ys[r];i&&i.target==e&&!i._killed&&t.push(i.owner)}return t}static kill(e,t){let i=Xs.get(e);return!(!i||i._killed)&&(i.kill(t),!0)}static killAll(e,t){if(null==e)return!1;let i=!1,r=Ws;for(let s=0;s<r;s++){let r=Ys[s];r&&r.target==e&&!r._killed&&(r.kill(t),i=!0)}return i}constructor(){this.props=[],this.easeArgs=[],this.interpArgs=[],this.startValue=new Ls(this.props),this.endValue=new Ls(this.props),this.value=new Ls(this.props),this.deltaValue=new Ls(this.props)}go(e,t,i){let r=qs.take();this.props.push(r),r.name=e,r.offset=this.startValue.nums.length;const s=typeof t;let a;return"number"===s?(r.type=0,this.startValue.nums.push(t),this.endValue.nums.push(i)):"string"===s?(this.startValue.nums.push(m.stringToHex(t)),this.endValue.nums.push(m.stringToHex(i)),r.type=2):"object"==s&&null!=(a=t[Os])?(a.write(this.startValue.nums,t),a.write(this.endValue.nums,i),r.type=a):(this.startValue.nums.push(t?1:0),this.endValue.nums.push(i?1:0),r.type=1),this}get normalizedTime(){return this._normalizedTime}get breaking(){return 1==this._ended}activate(){this._active=!0,this._startFrame=h.timer.currFrame}seek(e){if(!this._killed){if(this._elapsedTime=e,this._elapsedTime<this.delay){if(!this._started)return;this._elapsedTime=this.delay}this.update2()}}kill(e){this._killed||(e&&(0==this._ended&&(this.breakpoint>=0?this._elapsedTime=this.delay+this.breakpoint:this.repeat>=0?this._elapsedTime=this.delay+this.duration*(this.repeat+1):this._elapsedTime=this.delay+2*this.duration,this.update2()),this.callCompleteCallback()),this._killed=!0)}init(){++Hs<1&&(Hs=1),this.id=Hs,Xs.set(this.id,this),this.name=null,this.delay=0,this.duration=0,this.breakpoint=-1,this.startValue.nums.length=0,this.endValue.nums.length=0,this.value.nums.length=0,this.ease=Ms.linear,this.easeArgs.length=0,this.timeScale=1,this.snapping=!1,this.repeat=0,this.yoyo=!1,this.interp=null,this.interpArgs.length=0,this._started=!1,this.paused=!1,this._killed=!1,this._startFrame=h.timer.currFrame,this._elapsedTime=0,this._normalizedTime=0,this._ended=0,this._active=!1}reset(){this.id=-1,this.owner=null,this.target=null,this.lifecycleOwner=null,this.userData=null,qs.recover(this.props),this.onStart=this.onUpdate=this.onComplete=null,this.onStartCaller=this.onUpdateCaller=this.onCompleteCaller=null}update(e){if(1!=this.timeScale&&(e*=this.timeScale),0!=e){if(0!=this._ended)return this.callCompleteCallback(),void(this._killed=!0);this._elapsedTime+=e,this.update2(),0!=this._ended&&(this._killed||(this.callCompleteCallback(),this._killed=!0))}}update2(){if(this._ended=0,!this._started){if(this._elapsedTime<this.delay)return;if(this._started=!0,this.value.copy(this.startValue),this.deltaValue.nums.length=this.startValue.nums.length,this.deltaValue.nums.fill(0),this.callStartCallback(),this._killed)return}let e=!1,t=this.duration,i=this._elapsedTime-this.delay;if(this.breakpoint>=0&&i>=this.breakpoint&&(i=this.breakpoint,this._ended=2),0!=this.repeat){let r=Math.floor(i/t);i-=t*r,this.yoyo&&(e=r%2==1),this.repeat>0&&this.repeat-r<0&&(this.yoyo&&(e=this.repeat%2==1),i=t,this._ended=1)}else i>=t&&(i=t,this._ended=1);let r=t>0?this.ease(e?t-i:i,0,1,t,...this.easeArgs):1;this._normalizedTime=r;let s=this.startValue.nums,a=this.endValue.nums,n=this.value.nums,o=this.deltaValue.nums;if(n.fill(0),o.fill(0),this.interp){this.interp(r,s,a,n,...this.interpArgs);for(let e=0,t=s.length;e<t;e++){let t=n[e];this.snapping&&(t=Math.round(t)),o[e]=t-n[e]}}else for(let e=0,t=s.length;e<t;e++){let t=s[e],i=t+(a[e]-t)*r;this.snapping&&(i=Math.round(i)),o[e]=i-n[e],n[e]=i}if(null!=this.target)for(let e=0,t=this.props.length;e<t;e++){let t=this.props[e];if(t.name){let e=1===t.type?1===this._ended?this.endValue.read(t.type,t.offset):this.startValue.read(t.type,t.offset):this.value.read(t.type,t.offset);if((0===t.type||1===t.type||2===t.type)&&this.target[t.name]===e)continue;this.target[t.name]=e}}this.callUpdateCallback()}callStartCallback(){if(this.onStart)try{this.onStart.call(this.onStartCaller,this)}catch(e){console.error("error in start callback > ",e)}}callUpdateCallback(){if(this.onUpdate)try{this.onUpdate.call(this.onUpdateCaller,this)}catch(e){console.error("error in update callback > ",e)}}callCompleteCallback(){if(this.onComplete)try{this.onComplete.call(this.onCompleteCaller,this)}catch(e){console.error("error in complete callback > ",e)}}static _runAll(){var e;let t=Ws;if(0==t)return;let i=h.timer.currFrame,r=h.timer.delta,s=h.timer.unscaledDelta,a=-1;for(let n=0;n<t;n++){let t=Ys[n];null==t?-1==a&&(a=n):t._killed?(Xs.delete(t.id),null===(e=t.owner)||void 0===e||e._check(),zs._pool.recover(t),Ys[n]=null,-1==a&&(a=n)):(t.target&&t.target.destroyed||t.lifecycleOwner&&t.lifecycleOwner.destroyed?t._killed=!0:!t.paused&&t._active&&t.update(t._startFrame==i?0:t.ignoreEngineTimeScale?s:r),-1!=a&&(Ys[a]=t,Ys[n]=null,a++))}if(a>=0){if(Ws!=t){let e=t;t=Ws-t;for(let i=0;i<t;i++)Ys[a++]=Ys[e],Ys[e]=null,e++}Ws=a}}static _getMap(){return Xs}}zs._pool=l.createPool(zs,(e=>e.init()),(e=>e.reset()));var Hs=0,Ws=0;const Ys=[],Xs=new Map,qs=l.createPool(Object);class js{static create(e,t){let i=js._pool.take();return i._target=e,i._lo=t,i}static isTweening(e){return zs.isTweening(e)}static getTween(e){return Ks.length=0,this.getTweens(e,Ks),Ks.length>0?Ks[0]:null}static getTweens(e,t){return zs.getTweens(e,t)}static kill(e){e&&e.kill()}static clear(e){e&&e.kill()}static killAll(e,t){return zs.killAll(e,t)}static clearAll(e){js.killAll(e)}static to(e,t,i,r,s,a,n){n&&js.killAll(e);let o=js.create(e);return js.tweenLegacy(o.cur(!0),t,i,r,s,a,!0),o}static from(e,t,i,r,s,a,n){n&&js.killAll(e);let o=js.create(e);return js.tweenLegacy(o.cur(!0),t,i,r,s,a,!1),o}static tweenLegacy(e,t,i,r,s,a,n){e.duration=i;for(let i in t){let r=t[i];i in e.target&&(n?e.go(i,e.target[i],r):e.go(i,r,e.target[i]))}t.ease&&(e.ease=t.ease,t.easeArgs&&e.easeArgs.push(...t.easeArgs)),t.update&&(e.onUpdate=t.update.runWith,e.onUpdateCaller=t.update),t.complete&&(e.onComplete=t.complete.runWith,e.onCompleteCaller=t.complete),null!=r&&(e.ease=r),null!=a&&(e.delay=a),s&&(e.onComplete=s.runWith,e.onCompleteCaller=s)}to(e,t){return this.cur(!0).go(e,this._target[e],t),this}from(e,t){return this.cur(!0).go(e,t,this._target[e]),this}go(e,t,i){return this.cur(!0).go(e,t,i),this}chain(e,t){return void 0!==e&&(this._target=e,this._lo=t),0==this._queue.length||(null!=this._par&&(this._queue.push(-2),this._par=null),this._cur=zs.create(this),this._cur.target=this._target,this._cur.lifecycleOwner=this._lo,this._queue.push(this._cur.id)),this}parallel(e,t){return 0==this._queue.length?(void 0!==e&&(this._target=e,this._lo=t),this):(null==this._par&&(this._queue.push(-1),this._par=this._cur),this._cur=zs.create(this),void 0!==e?(this._cur.target=e,this._cur.lifecycleOwner=t):(this._cur.target=this._par.target,this._cur.lifecycleOwner=this._par.lifecycleOwner),this._cur.duration=this._par.duration,this._par._active&&this._cur.activate(),this._queue.push(this._cur.id),this)}delay(e){return this.cur(!1).delay=e,this}duration(e){return this.cur(!1).duration=e,this}breakpoint(e){return this.cur(!1).breakpoint=e,this}ease(e,...t){let i=this.cur(!1);return i.ease="string"==typeof e?Ms[e]:e,i.easeArgs.length=0,t&&i.easeArgs.push(...t),this}interp(e,...t){let i=this.cur(!1);return i.interp=e,i.interpArgs.length=0,t&&i.interpArgs.push(...t),this}repeat(e,t){let i=this.cur(!1);return i.repeat=e,i.yoyo=t,this}timeScale(e){return this.cur(!1).timeScale=e,this}ignoreEngineTimeScale(e){return this.cur(!1).ignoreEngineTimeScale=e,this}snapping(e){return this.cur(!1).snapping=e,this}userData(e){return this.cur(!1).userData=e,this}name(e){return this.cur(!1).name=e,this}onUpdate(e,t){let i=this.cur(!1);return i.onUpdate=e,i.onUpdateCaller=t,this}onStart(e,t){let i=this.cur(!1);return i.onStart=e,i.onStartCaller=t,this}then(e,t){let i=this.cur(!1);return i.onComplete=e,i.onCompleteCaller=t,this}seek(e){return this.cur(!1).seek(e),this}pause(){return $s(this._queue,(e=>e.paused=!0)),this}resume(){return $s(this._queue,(e=>e.paused=!1)),this}findTweener(e){for(let t=0,i=this._queue.length;t<i;t++){if(t<0)continue;let i=zs.getTween(this._queue[t]);if(i&&i.name==e)return i}return null}kill(e){if(0==this._queue.length)return;let t=this._queue.concat();this._head=-1,this._cur=null,this._queue.length=0,$s(t,(t=>{t.kill(e),t.owner=null}))}get completed(){return this._head>=0&&0===this._queue.length}complete(){this.kill(!0)}clear(){this.kill(!1)}recover(){this.kill(!1),js._pool.recover(this)}constructor(){this._queue=[],this._head=-1}cur(e){if(!this._cur){if(-1!=this._head){if(!e)throw new Error("Tween has been started. clear first!");this.kill(!1)}this._cur=zs.create(this),this._cur.target=this._target,this._cur.lifecycleOwner=this._lo,this._cur.activate(),this._queue.push(this._cur.id)}return this._cur}_check(){this._cur&&(this._head=0,this._cur=null);let e=this._head,t=this._queue.length;for(;e<t;e++){let i=this._queue[e];if(i<0)continue;let r=zs.getTween(i);if(r&&!r._killed){if(r._active)break;if(r.activate(),-1==this._queue[e+1])for(let i=e+2;i<t;i++){let t=this._queue[i];if(t<0)break;let r=zs.getTween(t);r&&!r._killed?r.activate():this._queue[e]=-3}break}this._queue[e]=-3}this._head=e,e>=t&&(this._queue.length=0)}static shake(e,t,i,r,s){if(1==e)r.length=0,r.push(...t);else{let i=s*(1-e)*(Math.random()>.5?1:-1);for(let e=0;e<t.length;e++)r[e]=t[e]+i}}static seperateChannel(e,t,i,r,s){s=s||3;for(let a=0;a<t.length;a++)r[a]=Qs(e,t[a],i[a],s)}static useCurvePath(e,t,i,r,s){let a=s.getPointAt(e);r[0]=a.x,r.length>1&&(r[1]=a.y),r.length>2&&(r[2]=a.z)}}js._pool=l.createPool(js);const Ks=[];function $s(e,t){for(let i of e)if(i>0){let e=zs.getTween(i);e&&!e._killed&&t(e)}}function Qs(e,t,i,r){let s=0;for(let a=0;a<r;a++){let r=8*a,n=t>>r&255;s+=n+((i>>r&255)-n)*e<<r}return s}class Zs{constructor(e){this.ratio=.92,this.maxOffset=60,this.hasInertia=!1,this.elasticDistance=0,this.elasticBackTime=300,this.autoStart=!1,this._testing=!1,this._dragging=!1,this.target=e,this.area=new G,this._points=[],this.target.on(c.MOUSE_DOWN,this,this.onMouseDown),this.target.on(c.MOUSE_DRAG,this,this.onMouseDrag),this.target.on(c.MOUSE_DRAG_END,this,this.onMouseDragEnd)}get dragging(){return this._dragging}start(e){this.reset(),this._touchId=h.InputManager.lastTouchId,this._dragging=!0,this._testing=!1,this._elasticRateX=this._elasticRateY=1;let t=this.target._parent.getMousePoint();this._points.length=0,this._points.push(t.x,t.y,I.now()),this._data=e}reset(){this._dragging=!1,this._testing=!1,this._data=null,h.systemTimer.clear(this,this.tweenMove),null!=this._tween&&(this._tween.kill(),this._tween=null)}stop(){this._dragging?this._testing||(this._dragging=!1,this.moveTarget(0,0),this.clear()):this._testing=!1}onMouseDown(){!this.autoStart||this._dragging||this._testing||(this.start(),this._testing=!0)}onMouseDrag(e){if(!this._testing&&!this._dragging)return;if(this._touchId!=e.touchId)return;let t=this.target._parent.getMousePoint(),i=t.x,r=t.y,s=i-this._points[this._points.length-3],a=r-this._points[this._points.length-2];if(this._testing){if(Math.abs(s*h.stage._canvasTransform.getScaleX())<1&&Math.abs(a*h.stage._canvasTransform.getScaleY())<1)return;if(this._dragging=!0,this.target.event(c.DRAG_START,this._data),!this._dragging)return;this._testing=!1}let n=I.now();for(;this._points.length>0&&this._points[2]<n-100;)this._points.splice(0,3);this._points.push(i,r,n),this.moveTarget(s*this._elasticRateX,a*this._elasticRateY),this.target.event(c.DRAG_MOVE,this._data)}onMouseDragEnd(e){if(this._dragging){if(this._touchId==e.touchId)if(this.hasInertia){let e=Zs.computeVelocity(this._points,this.maxOffset);this._points[0]=e.x,this._points[1]=e.y,h.systemTimer.frameLoop(1,this,this.tweenMove)}else!this.area.isEmpty()&&this.elasticDistance>0?this.checkElastic():this.clear()}else this._testing=!1}moveTarget(e,t){let i=this.target._x+e,r=this.target._y+t;this.area.isEmpty()?this.target.pos(i,r):this.elasticDistance>0&&this._dragging?(this.target.pos(i,r),this.updateElasticRate()):this.target.pos(Math.min(Math.max(i,this.area.x),this.area.x+this.area.width),Math.min(Math.max(r,this.area.y),this.area.y+this.area.height))}updateElasticRate(){let e,t;e=this.target._x<this.area.x?this.area.x-this.target._x:this.target._x>this.area.x+this.area.width?this.target._x-this.area.x-this.area.width:0,t=this.target._y<this.area.y?this.area.y-this.target._y:this.target._y>this.area.y+this.area.height?this.target._y-this.area.y-this.area.height:0,this._elasticRateX=Math.max(0,1-e/this.elasticDistance),this._elasticRateY=Math.max(0,1-t/this.elasticDistance)}checkElastic(){let e,t;this.target._x<this.area.x?e=this.area.x:this.target._x>this.area.x+this.area.width&&(e=this.area.x+this.area.width),this.target._y<this.area.y?t=this.area.y:this.target._y>this.area.y+this.area.height&&(t=this.area.y+this.area.height),null!=e||null!=t?(this._tween=js.create(this.target).duration(this.elasticBackTime).ease(Ms.sineOut).then(this.clear,this),null!=e&&this._tween.to("x",e),null!=t&&this._tween.to("y",t)):this.clear()}tweenMove(){let e=Math.pow(this.ratio,h.timer.delta/16.6),t=this.ratio*(1-e)/(1-this.ratio),i=this._points[0]*t*this._elasticRateX,r=this._points[1]*t*this._elasticRateY;i=i<0?Math.ceil(i):Math.floor(i),r=r<0?Math.ceil(r):Math.floor(r),this._points[0]*=e*this._elasticRateX,this._points[1]*=e*this._elasticRateY,Math.abs(i)<1&&Math.abs(r)<1||this._elasticRateX<.5||this._elasticRateY<.5?(h.systemTimer.clear(this,this.tweenMove),!this.area.isEmpty()&&this.elasticDistance>0?this.checkElastic():this.clear()):(this.moveTarget(i,r),this.target.event(c.DRAG_MOVE,this._data))}clear(){let e=this._data;this.reset(),this.target.event(c.DRAG_END,e)}static computeVelocity(e,t){let i=I.now();for(;e.length>0&&e[2]<i-100;)e.splice(0,3);let r=e.length/3,s=0,a=0,n=0;for(let t=1;t<r;t++)s+=e[3*t]-e[3*t-3],a+=e[3*t+1]-e[3*t-2],n+=e[3*t+2]-e[3*t-1];return 0!=n?(n/=16.6,s/=n,a/=n):s=a=0,null!=t&&(Math.abs(s)>t&&(s=s>0?t:-t),Math.abs(a)>t&&(a=a>0?t:-t)),Js.setTo(s,a),Js}}const Js=new d;class ea{static getGlobalRecByPoints(e,t,i,r,s){var a,n;a=d.create().setTo(t,i),a=e.localToGlobal(a),n=d.create().setTo(r,s),n=e.localToGlobal(n);var o=G._getWrapRec([a.x,a.y,n.x,n.y]);return a.recover(),n.recover(),o}static getGlobalPosAndScale(e){return ea.getGlobalRecByPoints(e,0,0,1,1)}static getTransformRelativeToWindow(e,t,i){var r=h.stage,s=ea.getGlobalPosAndScale(e),a=r._canvasTransform.clone(),n=a.tx,o=a.ty;a.rotate(-Math.PI/180*r.canvasDegree),a.scale(r.clientScaleX,r.clientScaleY);var l,u,d,c,_=r.canvasDegree%180!=0;return _?(l=i+s.y,u=t+s.x,l*=a.d,u*=a.a,90==r.canvasDegree?(l=n-l,u+=o):(l+=n,u=o-u)):(l=t+s.x,u=i+s.y,l*=a.a,u*=a.d,l+=n,u+=o),u+=r._safariOffsetY,_?(d=a.d*s.height,c=a.a*s.width):(d=a.a*s.width,c=a.d*s.height),{x:l,y:u,scaleX:d,scaleY:c}}static fitDOMElementInArea(e,t,i,r,s,a){e._fitLayaAirInitialized||(e._fitLayaAirInitialized=!0,e.style.transformOrigin=e.style.webKittransformOrigin="left top",e.style.position="absolute");var n=ea.getTransformRelativeToWindow(t,i,r);e.style.transform=e.style.webkitTransform="scale("+n.scaleX+","+n.scaleY+") rotate("+h.stage.canvasDegree+"deg)",e.style.width=s+"px",e.style.height=a+"px",e.style.left=n.x+"px",e.style.top=n.y+"px"}static updateOrder(e){if(!e||e.length<2)return!1;let t,i,r,s=1,a=e.length;for(;s<a;){for(t=s,r=e[t],i=e[t]._zOrder;--t>-1&&e[t]._zOrder>i;)e[t+1]=e[t];e[t+1]=r,s++}return!0}static localToGlobalRect(e,t){let i=e.localToGlobal(d.TEMP.setTo(t.x,t.y)),r=i.x,s=i.y;return e.localToGlobal(i.setTo(t.right,t.bottom)),t.setTo(r,s,r+i.x,s+i.y)}static globalToLocalRect(e,t){let i=e.globalToLocal(d.TEMP.setTo(t.x,t.y)),r=i.x,s=i.y;return e.globalToLocal(i.setTo(t.right,t.bottom)),t.setTo(r,s,r+i.x,s+i.y)}static transformRect(e,t,i){let r=e.localToGlobal(d.TEMP.setTo(t.x,t.y),!1,i),s=r.x,a=r.y;return e.localToGlobal(r.setTo(t.right,t.bottom),!1,i),t.setTo(s,a,s+r.x,a+r.y)}}class ta{get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}constructor(){var e;this._hideFlags=0,this._status=0,this._enabled=!0,this._id=sa++,this._singleton=null===(e=Object.getPrototypeOf(this)._$singleton)||void 0===e||e,this._initialize()}_initialize(){this._extra={}}hasHideFlag(e){return 0!=(this._hideFlags&e)}get id(){return this._id}get enabled(){return this._enabled}set enabled(e){this._enabled!=e&&(this._enabled=e,this.owner&&this._setActive(e&&this.owner.activeInHierarchy))}get awaked(){return this._status>0}get destroyed(){return 4==this._status}_isScript(){return!1}_resetComp(){this._enabled=!0,this._status=0,this._enableState=!1,this.owner=null}_setOwner(e){if(0!=this._status)throw new Error("reuse a destroyed component");this.owner=e,this._isScript()&&e._setBit(ke.HAS_SCRIPT,!0),this._onAdded(),this.onAdded()}_onAdded(){}_onAwake(){}_onEnable(){this.onEnable()}_onDisable(){this.onDisable()}_onDestroy(){}_parse(e,t=null){}_parseInteractive(e=null,t=null){}_cloneTo(e){}_setActive(e){var t;e?(0==this._status&&(this._status=1,(p.isPlaying||this.runInEditor)&&(this._onAwake(),this.onAwake())),this._enabled&&!this._enableState&&(this._enableState=!0,(p.isPlaying||this.runInEditor)&&(this._driver=(null===(t=this.owner._scene)||void 0===t?void 0:t._componentDriver)||h.stage._componentDriver,this._driver.add(this),p.isPlaying&&this._isScript()&&this.setupScript(),this._onEnable()))):this._enableState&&(this._enableState=!1,(p.isPlaying||this.runInEditor)&&(this._driver&&this._driver.remove(this),h.stage.offAllCaller(this),this._onDisable()))}setupScript(){}destroy(){4!=this._status&&(this.owner?this.owner._destroyComponent(this):this.destroyed||this._destroy(!0))}_destroy(e){e?(p.isPlaying||this.runInEditor)&&(this._onDestroy(),this.onDestroy(),this.onReset&&(this.onReset(),this._resetComp(),l.recoverByClass(this))):(this._setActive(!1),this._status=4,(p.isPlaying||this.runInEditor)&&(this._driver||h.stage._componentDriver)._toDestroys.add(this),this._driver=null)}onAdded(){}onAwake(){}onEnable(){}onDisable(){}onDestroy(){}}var ia,ra,sa=0;e.BaseRender2DType=void 0,(ia=e.BaseRender2DType||(e.BaseRender2DType={}))[ia.baseRenderNode=0]="baseRenderNode",ia[ia.spine=1]="spine",ia[ia.particle=2]="particle",ia[ia.spineSimple=3]="spineSimple",e.Render2DOrderMode=void 0,(ra=e.Render2DOrderMode||(e.Render2DOrderMode={}))[ra.elementIndex=0]="elementIndex",ra[ra.ysort=1]="ysort";class aa extends ta{static initBaseRender2DCommandEncoder(){aa.NMATRIX_0=gi.propertyNameToID("u_NMatrix_0"),aa.NMATRIX_1=gi.propertyNameToID("u_NMatrix_1"),aa.BASERENDER2DCOLOR=gi.propertyNameToID("u_baseRenderColor"),aa.BASERENDER2DTEXTURE=gi.propertyNameToID("u_baseRender2DTexture"),aa.BASERENDERSIZE=gi.propertyNameToID("u_baseRenderSize2D"),aa.NORMAL2DTEXTURE=gi.propertyNameToID("u_normal2DTexture"),aa.NORMAL2DSTRENGTH=gi.propertyNameToID("u_normal2DStrength"),aa.SHADERDEFINE_BASERENDER2D=gi.getDefineByName("BASERENDER2D"),aa.SHADERDEFINE_LIGHT2D_ENABLE=gi.getDefineByName("LIGHT2D_ENABLE"),aa.SHADERDEFINE_LIGHT2D_EMPTY=gi.getDefineByName("LIGHT2D_EMPTY"),aa.SHADERDEFINE_LIGHT2D_ADDMODE=gi.getDefineByName("LIGHT2D_SCENEMODE_ADD"),aa.SHADERDEFINE_LIGHT2D_SUBMODE=gi.getDefineByName("LIGHT2D_SCENEMODE_SUB"),aa.SHADERDEFINE_LIGHT2D_NORMAL_PARAM=gi.getDefineByName("LIGHT2D_NORMAL_PARAM");const t=g.renderDeviceFactory.createGlobalUniformMap("BaseRender2D");t.addShaderUniform(aa.NMATRIX_0,"u_NMatrix_0",e.ShaderDataType.Vector3),t.addShaderUniform(aa.NMATRIX_1,"u_NMatrix_1",e.ShaderDataType.Vector3),t.addShaderUniform(aa.BASERENDER2DCOLOR,"u_baseRenderColor",e.ShaderDataType.Color),t.addShaderUniform(aa.BASERENDER2DTEXTURE,"u_baseRender2DTexture",e.ShaderDataType.Texture2D),t.addShaderUniform(aa.BASERENDERSIZE,"u_baseRenderSize2D",e.ShaderDataType.Vector2),t.addShaderUniform(aa.NORMAL2DTEXTURE,"u_normal2DTexture",e.ShaderDataType.Texture2D),t.addShaderUniform(aa.NORMAL2DSTRENGTH,"u_normal2DStrength",e.ShaderDataType.Float),t.addShaderUniform(ki.UNIFORM_CLIPMATDIR,"u_clipMatDir",e.ShaderDataType.Vector4),t.addShaderUniform(ki.UNIFORM_CLIPMATPOS,"u_clipMatPos",e.ShaderDataType.Vector2)}static _setRenderElement2DMaterial(e,t){e.subShader=t._shader.getSubShaderAt(0),e.materialShaderData=t._shaderValues}_getcommonUniformMap(){return["BaseRender2D"]}_getRect(){return null}_transformChange(){}_changeMaterialReference(e,t){e&&e._removeReference(),t&&t._addReference()}_setRenderSize(e,t){e==this._rtsize.x&&t==this._rtsize.y||(this._rtsize.setValue(e,t),this._spriteShaderData.setVector2(aa.BASERENDERSIZE,this._rtsize))}constructor(){super(),this._renderType=e.BaseRender2DType.baseRenderNode,this._renderUpdateMask=0,this._layer=0,this._rtsize=new Gt,this._lightReceive=!1,this._lightUpdateMark=0,this._lightRecord=!1,this._renderid=aa._uniqueIDCounter++,this._spriteShaderData=g.renderDeviceFactory.createShaderData(null),this._spriteShaderData.setVector(ki.UNIFORM_CLIPMATDIR,new s(Ue.MAX_CLIP_SIZE,0,0,Ue.MAX_CLIP_SIZE)),this._renderType=e.BaseRender2DType.baseRenderNode,this._ordingMode=e.Render2DOrderMode.elementIndex}_onEnable(){super._onEnable(),this.owner.renderNode2D=this,this._lightReceive&&this._addRenderToLightManager()}_onDisable(){this.owner.renderNode2D=null,this._lightReceive&&this._removeRenderFromLightManager(),super._onDisable()}_onDestroy(){for(var e=0,t=this._materials.length;e<t;e++){let t=this._materials[e];t&&!t.destroyed&&t._removeReference()}this._spriteShaderData.destroy()}get layer(){return this._layer}set layer(e){if(this._layer!==e){if(!(e>=0&&e<=30))throw new Error("Layer value must be 0-30.");this._removeRenderFromLightManager(),this._layer=e,this._addRenderToLightManager(),this._resetUpdateMark()}}set lightReceive(e){e!==this._lightReceive&&(this._lightReceive=e,e?(this._addRenderToLightManager(),this._spriteShaderData.addDefine(aa.SHADERDEFINE_LIGHT2D_ENABLE)):(this._removeRenderFromLightManager(),this._spriteShaderData.removeDefine(aa.SHADERDEFINE_LIGHT2D_ENABLE)),this._resetUpdateMark())}get lightReceive(){return this._lightReceive}_resetUpdateMark(){this._lightUpdateMark=0}_updateLight(){if(!this.lightReceive||!this.owner.scene||!this.owner.scene._light2DManager)return;const e=this.owner.scene._light2DManager,t=e._getLayerUpdateMark(this.layer);this._lightUpdateMark!==t&&(this._lightUpdateMark=t,e._updateShaderDataByLayer(this.layer,this._spriteShaderData))}_addRenderToLightManager(){if(this.owner.scene){let e=this.owner.scene._light2DManager;e&&!this._lightRecord&&(e.addRender(this),this._lightRecord=!0)}}_removeRenderFromLightManager(){if(this.owner.scene){const e=this.owner.scene._light2DManager;e&&this._lightRecord&&(e.removeRender(this),this._lightRecord=!1)}}get sharedMaterial(){return this._materials[0]}set sharedMaterial(e){const t=this._materials[0];t!==e&&(this._materials[0]=e,this._changeMaterialReference(t,e),this._renderElements[0]&&aa._setRenderElement2DMaterial(this._renderElements[0],e))}getRenderID(){return this._renderid}clear(){this._renderElements.length=0}}aa._uniqueIDCounter=0;class na{constructor(e){this._flags=0,this._x=0,this._y=0,this._rot=0,this._scaleX=1,this._scaleY=1,this._cache=!1,this._sp=e}get cache(){return this._cache}set cache(t){if(this._cache!=t)if(this._cache=t,t){this._setFlag(e.TransformKind.Matrix|e.TransformKind.TRS,!0);let t=this._sp._parent;null!=t&&t!=h.stage&&(t.globalTrans.cache=!0)}else for(let e of this._sp._children)e._globalTrans&&(e._globalTrans.cache=!1)}getMatrix(){if(null==this._matrix&&(this._matrix=new V),this._cache&&!this._getFlag(e.TransformKind.Matrix))return this._matrix;let t=this._sp;return this._matrix.setMatrix(t._x,t._y,t._scaleX,t._scaleY,t._rotation,t._skewX,t._skewY,t._pivotX,t._pivotY),t._parent&&(V.mul(this._matrix,t._parent.globalTrans.getMatrix(),this._matrix),this._setFlag(e.TransformKind.Matrix,!1),this._syncFlag(e.TransformKind.Matrix,!0)),this._matrix}getMatrixInv(e){return this.getMatrix().copyTo(e),e.invert(),e}get x(){return this.getPos(oa).x}get y(){return this.getPos(oa).y}getSceneMatrix(e){return this._sp.scene?(this._sp.scene.globalTrans.getMatrix().invert().copyTo(e),V.mul(this.getMatrix(),e,e),e):this.getMatrix()}getScenePos(e){return this._sp.scene?this._sp.scene.globalTrans.getMatrixInv(ha).transformPoint(this.getPos(e)):this.getPos(e)}getSceneScale(e){if(e.x=this.scaleX,e.y=this.scaleY,this._sp.scene){const t=this._sp.scene.globalTrans.getMatrix();e.x/=t.getScaleX(),e.y/=t.getScaleY()}return e}getSceneRotation(){let e=this.rotation;return this._sp.scene&&(e-=this._sp.scene.globalTrans.rotation),e}getPos(e){return this._cache?(this._cachePos(),e.x=this._x,e.y=this._y):this._sp.localToGlobal(e.setTo(0,0),!1,null),e}setPos(t,i){let r=this._sp;if(this._cache){if(this._cachePos(),t==this._x&&i==this._y)return;let s=r._parent.globalTrans.getMatrix().invertTransformPoint(oa.setTo(t,i));this._cache=!1,r.pos(s.x,s.y),this._cache=!0,this._x=t,this._y=i,this._setFlag(e.TransformKind.Pos,!1),this._setFlag(e.TransformKind.Matrix,!0),this._syncFlag(e.TransformKind.Pos|e.TransformKind.Matrix,!0)}else{oa.setTo(t,i);let e=r.globalToLocal(oa,!1,null);e=r.toParentPoint(e),r.pos(e.x,e.y)}}get rotation(){let t=this._sp;if(this._cache)return this._getFlag(e.TransformKind.Rotation)&&(this._setFlag(e.TransformKind.Rotation,!1),t._parent!=t._scene&&t._parent?this._rot=t._rotation+t._parent.globalTrans.rotation:this._rot=t._rotation),this._rot;{let e=0,i=t;for(;i&&i!==t._scene;)e+=i._rotation,i=i._parent;return e}}set rotation(t){if(t==this.rotation)return;let i=this._sp;i._parent!=i._scene&&i._parent?i.rotation=t-i._parent.globalTrans.rotation:i.rotation=t,this._cache&&(this._rot=t,this._setFlag(e.TransformKind.Rotation,!1),this._setFlag(e.TransformKind.Matrix,!0),this._syncFlag(e.TransformKind.Matrix,!0))}get scaleX(){if(this._cache)return this._cacheScale(),this._scaleX;{let e=1,t=this._sp;for(;t&&t!==h.stage;)e*=t._scaleX,t=t._parent;return e}}get scaleY(){if(this._cache)return this._cacheScale(),this._scaleY;{let e=1,t=this._sp;for(;t&&t!==h.stage;)e*=t._scaleY,t=t._parent;return e}}_cachePos(){if(this._getFlag(e.TransformKind.Matrix|e.TransformKind.Pos)){this._setFlag(e.TransformKind.Pos,!1);let t=this.getMatrix().transformPoint(oa.setTo(this._sp.pivotX,this._sp.pivotY));this._x=t.x,this._y=t.y}}_cacheScale(){if(this._getFlag(e.TransformKind.Matrix|e.TransformKind.Scale)){this._setFlag(e.TransformKind.Scale,!1);let t=this.getMatrix();this._scaleX=t.getScaleX(),this._scaleY=t.getScaleY()}}_getFlag(e){return 0!=(this._flags&e)}_setFlag(e,t){t?this._flags|=e:this._flags&=~e,t&&this._sp.event(na.CHANGED,e)}_syncFlag(e,t){if(this._cache)for(let i of this._sp._children)i._globalTrans&&(i._globalTrans._setFlag(e,t),i._globalTrans._syncFlag(e,t))}_spTransChanged(t){this._cache&&this._setFlag(t|e.TransformKind.Matrix,!0),this._syncFlag(t|e.TransformKind.Matrix,!0)}localToGlobal(e,t){return this._cache?this.getMatrix().transformPoint(oa.setTo(this._sp.pivotX+e,this._sp.pivotY+t)):this._sp.localToGlobal(oa.setTo(e,t))}globalToLocal(e,t){if(this._cache){let i=this.getMatrix().invertTransformPoint(oa.setTo(e,t));return i.x-=this._sp.pivotX,i.y-=this._sp.pivotY,i}return this._sp.globalToLocal(oa.setTo(e,t))}}na.CHANGED="globalTransChanged";const oa=new d,ha=new V,la=ke.FORCE_HIDDEN|ke.NOT_IN_PAGE;class ua extends As{constructor(){super(),this._x=0,this._y=0,this._width=0,this._height=0,this._scaleX=1,this._scaleY=1,this._skewX=0,this._skewY=0,this._pivotX=0,this._pivotY=0,this._anchorX=0,this._anchorY=0,this._rotation=0,this._alpha=1,this._visible=!0,this._mouseState=0,this._zOrder=0,this._renderType=0,this._cacheStyle=zr.EMPTY,this.mouseThrough=!1,this.hitTestPrior=!1,this._autosize=!1,this._repaint=0,this._sizeFlag=0}destroy(e=!0){super.destroy(e),this._cacheStyle&&this._cacheStyle.recover(),this._cacheStyle=null,this._texture&&this._texture._removeReference(),this._texture=null,this._graphics&&this._ownGraphics&&this._graphics.destroy(),this._graphics=null}get parent(){return this._$parent}get scene(){return this._scene}get x(){return this._x}set x(e){this.pos(e,this._y)}get y(){return this._y}set y(e){this.pos(this._x,e)}get width(){return this._autosize?this.getSelfBounds(da).width:0==(1&this._sizeFlag)?this.measureWidth():this._width}set width(e){this.size(e,0==(2&this._sizeFlag)?null:this._height)}get height(){return this._autosize?this.getSelfBounds(da).height:0==(2&this._sizeFlag)?this.measureHeight():this._height}set height(e){this.size(0==(1&this._sizeFlag)?null:this._width,e)}get _isWidthSet(){return 0!=(1&this._sizeFlag)}get _isHeightSet(){return 0!=(2&this._sizeFlag)}measureWidth(){return this._texture?this._texture.width:0}measureHeight(){return this._texture?this._texture.height:0}get displayWidth(){return this.width*this.scaleX}get displayHeight(){return this.height*this.scaleY}get scaleX(){return this._scaleX}set scaleX(e){this.scale(e,this._scaleY)}get scaleY(){return this._scaleY}set scaleY(e){this.scale(this._scaleX,e)}get rotation(){return this._rotation}set rotation(t){this._rotation!==t&&(this._rotation=t,this._transChanged(e.TransformKind.Rotation))}get skewX(){return this._skewX}set skewX(e){this.skew(e,this._skewX)}get skewY(){return this._skewY}set skewY(e){this.skew(this._skewX,e)}get transform(){if(!this._tfChanged)return this._transform;this._tfChanged=!1;let e=this._transform||(this._transform=new V),t=this._scaleX,i=this._scaleY,r=this._skewX,s=this._skewY,a=this._rotation;if(a||1!==t||1!==i||0!==r||0!==s){e._bTransform=!0;let n=.0174532922222222*(a-r),o=.0174532922222222*(a+s),h=Math.cos(o),l=Math.sin(o),u=Math.sin(n),d=Math.cos(n);e.a=t*h,e.b=t*l,e.c=-i*u,e.d=i*d,e.tx=e.ty=0}else e.identity(),this._renderType&=~je.TRANSFORM;return e}set transform(e){this._tfChanged=!1;let t=this._transform||(this._transform=new V);e!==t&&e.copyTo(t),e&&(this._x=t.tx,this._y=t.ty,t.tx=t.ty=0),this._renderType|=je.TRANSFORM,this.parentRepaint()}get globalTrans(){return this._globalTrans||(this._globalTrans=new na(this))}get pivotX(){return this._pivotX}set pivotX(e){this.pivot(e,this._pivotY)}get pivotY(){return this._pivotY}set pivotY(e){this.pivot(this._pivotX,e)}get anchorX(){return this._anchorX}set anchorX(e){this.anchor(e,this._anchorY)}get anchorY(){return this._anchorY}set anchorY(e){this.anchor(this._anchorX,e)}get alpha(){return this._alpha}set alpha(e){e=e<0?0:e>1?1:e,this._alpha!==e&&(this._alpha=e,1!==e?this._renderType|=je.ALPHA:this._renderType&=~je.ALPHA,this.parentRepaint())}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._processVisible())}get blendMode(){return this._blendMode}set blendMode(e){this._blendMode!=e&&(this._blendMode=e,e&&"source-over"!=e?this._renderType|=je.BLEND:this._renderType&=~je.BLEND,this.parentRepaint())}get graphics(){return this._graphics||(this.graphics=new Es,this._ownGraphics=!0),this._graphics}set graphics(e){this.setGraphics(e,!1)}setGraphics(e,t){this._graphics&&(this._graphics._sp=null,this._ownGraphics&&this._graphics.destroy()),this._ownGraphics=t,this._graphics=e,e?(this._renderType|=je.GRAPHICS,e._sp=this):this._renderType&=~je.GRAPHICS,this.repaint()}get filters(){return this._filterArr}set filters(e){if(e&&0===e.length&&(e=null),this._filterArr)for(let e of this._filterArr)e&&e.off(c.CHANGED,this,this.repaint);if(this._filterArr=e?e.slice():null,e)for(let t of e)t&&t.on(c.CHANGED,this,this.repaint);e?this._renderType|=je.FILTERS:this._renderType&=~je.FILTERS,e&&e.length>0&&(this._getBit(ke.DISPLAY)||this._setBitUp(ke.DISPLAY)),this.repaint()}get cacheAs(){return this._getCacheStyle().userSetCache}set cacheAs(e){e!==this._cacheStyle.userSetCache&&(this._getCacheStyle().userSetCache=e,this.mask&&"normal"===e||("bitmap"==e||"normal"==e?this._renderType|=je.CANVAS:this._renderType&=~je.CANVAS,this.repaint()))}get staticCache(){return this._getCacheStyle().staticCache}set staticCache(e){this._getCacheStyle().staticCache=e,e||this.reCache()}get mask(){return this._cacheStyle.mask}set mask(e){e==this||e&&this.mask==e&&e._cacheStyle.maskParent==this||(this.mask&&(this.mask._getCacheStyle().maskParent=null),this._getCacheStyle().mask=e,e?(e._getCacheStyle().maskParent=this,this._renderType|=je.MASK):this._renderType&=~je.MASK,this.repaint())}get scrollRect(){return this._scrollRect}set scrollRect(e){null==this._scrollRect&&null==e||(this._scrollRect=e,e?this._renderType|=je.CLIP:this._renderType&=~je.CLIP,this.repaint())}get viewport(){return this._viewport}set viewport(e){if("string"==typeof e){let t=e.split(",");t.length>3&&(e=new G(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])))}this._viewport=e}set drawCallOptimize(e){this._setBit(ke.DRAWCALL_OPTIMIZE,e)}get drawCallOptimize(){return this._getBit(ke.DRAWCALL_OPTIMIZE)}get hitArea(){return this._hitArea}set hitArea(e){this._hitArea=e}get mouseEnabled(){return 2===this._mouseState}set mouseEnabled(e){let t=e?2:1;this._mouseState!==t&&(this._mouseState=t,2===t&&this.setMouseEnabledUp())}setMouseEnabledUp(){let e=this._parent;for(;e&&e!==h.stage&&0===e._mouseState&&e._setBit(ke.CHECK_INPUT,!0);)e=e._parent}getMousePoint(){return this.globalToLocal(_a.setTo(h.stage.mouseX,h.stage.mouseY))}get mouseX(){return this.getMousePoint().x}get mouseY(){return this.getMousePoint().y}get globalScaleX(){return this.globalTrans.scaleX}get globalScaleY(){return this.globalTrans.scaleY}get zOrder(){return this._zOrder}set zOrder(e){this._zOrder!=e&&(this._zOrder=e,this._parent&&(e&&this._parent._setBit(ke.HAS_ZORDER,!0),h.systemTimer.callLater(this._parent,this.updateZOrder)))}updateZOrder(){ea.updateOrder(this._children)&&this.repaint()}get texture(){return this._texture}set texture(e){this._texture!=e&&(this._texture&&this._texture._removeReference(),this._texture=e,e?(e._addReference(),this._renderType|=je.TEXTURE):this._renderType&=~je.TEXTURE,this.repaint())}get material(){var e;return null===(e=this._graphics)||void 0===e?void 0:e.material}set material(e){null==this._graphics&&null==e||(this.graphics.material=e)}get renderNode2D(){return this._renderNode}set renderNode2D(e){this._renderNode=e,e?this._renderType|=je.RENDERNODE2D:this._renderType&=~je.RENDERNODE2D}set customRenderEnable(e){e&&(this._renderType|=je.CUSTOM)}get autoSize(){return this._autosize}set autoSize(e){this._autosize=e}pos(t,i){return this._x==t&&this._y==i||(this._x=t,this._y=i,this._transChanged(e.TransformKind.Pos)),this}pivot(t,i){if(this._pivotX!=t||this._pivotY!=i){this._pivotX=t,this._pivotY=i;let r=this.width;0!=r&&(this._anchorX=t/r),r=this.height,0!=r&&(this._anchorY=i/r),this._transChanged(e.TransformKind.Anchor)}return this}anchor(t,i){return this._anchorX==t&&this._anchorY==i||(this._anchorX=t,this._anchorY=i,this._pivotX=t*this.width,this._pivotY=i*this.height,this._transChanged(e.TransformKind.Anchor)),this}size(t,i){let r,s;return null==t?(r=0!=(1&this._sizeFlag),this._sizeFlag&=-2):(r=this._width!=t||0==(1&this._sizeFlag),this._width=t,this._pivotX=this._anchorX*t,this._sizeFlag|=1),null==i?(s=0!=(2&this._sizeFlag),this._sizeFlag&=-3):(s=this._height!=i||0==(2&this._sizeFlag),this._height=i,this._pivotY=this._anchorY*i,this._sizeFlag|=2),(r||s)&&this._transChanged((r?e.TransformKind.Width:0)|(s?e.TransformKind.Height:0)),this}scale(t,i){return this._scaleX===t&&this._scaleY===i||(this._scaleX=t,this._scaleY=i,this._transChanged(e.TransformKind.Scale)),this}skew(t,i){return this._skewX===t&&this._skewY===i||(this._skewX=t,this._skewY=i,this._transChanged(e.TransformKind.Skew)),this}_transChanged(t){var i;if(!this._destroyed){if(this.parentRepaint(je.REPAINT_CACHE),t!=e.TransformKind.Pos&&t!=e.TransformKind.Anchor)this._tfChanged=!0,this._renderType|=je.TRANSFORM,0!=(t&e.TransformKind.Size)&&(null===(i=this._graphics)||void 0===i||i._clearBoundsCache(!0));else{let e=this._cacheStyle.maskParent;e&&e.repaint(je.REPAINT_CACHE)}0!=(t&e.TransformKind.TRS)&&(this._globalTrans&&this._globalTrans._spTransChanged(t),this._getBit(ke.DEMAND_TRANS_EVENT)&&ga(this))}}render(e,t,i){Ur.renders[this._renderType]._fun(this,e,t+this._x,i+this._y),this._repaint=0}customRender(e,t,i){this._repaint=je.REPAINT_ALL}drawToCanvas(e,t,i,r){return ua.drawToCanvas(this,e,t,i,r)}static drawToCanvas(e,t,i,r,s,a=!0){let n=ua.drawToRenderTexture2D(e,t,i,r,s,null);for(var o=n.getData(0,0,t,i),h=new ImageData(t,i),l=4*t,u=h.data,d=i-1,c=d*l,_=0;d>=0;d--)u.set(o.subarray(_,_+l),c),c-=l,_+=l;var p=new Vr(!0);return p.size(t,i),p.getContext("2d").putImageData(h,0,0),n.destroy(),p}drawToTexture(e,t,i,r,s=null,a=!0){return ua.drawToTexture(this,e,t,i,r,s,a)}static drawToTexture(t,i,r,s,a,n=null,o=!0){let h=n||new pe(i,r,e.RenderTargetFormat.R8G8B8A8),l=new xr;n?l.size(n.width,n.height):l.size(i,r),l.render2D=l.render2D.clone(null);let u=Ur.RenderToRenderTexture(t,l,s,a,h,o);if(l._drawingToTexture=!1,l.destroy(),!n){return new fe(u,fe.INV_UV)}return u}drawToRenderTexture2D(e,t,i,r,s=null,a=!0,n=!1){return ua.drawToRenderTexture2D(this,e,t,i,r,s,a,n)}static drawToRenderTexture2D(t,i,r,s,a,n=null,o=!0,h=!1){let l=n||new pe(i,r,e.RenderTargetFormat.R8G8B8A8),u=new xr;n?u.size(n.width,n.height):u.size(i,r),u.render2D=u.render2D.clone(l),u._drawingToTexture=!0,h&&(l._invertY=!0);let d=Ur.RenderToRenderTexture(t,u,s,a,l,o);return u._drawingToTexture=!1,u.destroy(),d}hitTestPoint(e,t){let i=this.globalToLocal(_a.setTo(e,t));return e=i.x,t=i.y,(this._hitArea?this._hitArea:this._isWidthSet&&this._isHeightSet?da.setTo(0,0,this._width,this._height):this.getSelfBounds(da)).contains(e,t,this)}setSelfBounds(e){this._userBounds=e}getBounds(e){return G._getWrapRec(this._boundPointsToParent(),e)}getSelfBounds(e){return e=e||new G,this._userBounds?e.copyFrom(this._userBounds):this._graphics||0!==this._children.length||this._texture?(pa.length=0,G._getWrapRec(this._getBoundPointsM(!1,pa),e)):e.setTo(0,0,this._width,this._height)}getChildrenBounds(e,t,i,r){(r=r||new G).setTo(0,0,0,0);let s=e?this._children:this._$children;for(let a of s){if(t&&!a._getBit(ke.ACTUAL_VISIBLE))continue;let s=a.width,n=a.height;if(i||(s*=Math.abs(a._scaleX),n*=Math.abs(a._scaleY)),r.union(ca.setTo(a._x-s*a._anchorX,a._y-n*a._anchorY,s,n),r),e&&a._children.length>0){let s=a.getChildrenBounds(e,t,i);s.x+=a._x,s.y+=a._y,r.union(s,r)}}return r}_boundPointsToParent(e){let t=this._pivotX,i=this._pivotY;e=e||0!==this._rotation,null!=this._scrollRect&&(t+=this._scrollRect.x,i+=this._scrollRect.y);let r=this._tmpBounds||(this._tmpBounds=[]);if(r.length=0,this._getBoundPointsM(e,r),0==r.length)return r;if(8!=r.length&&(e?Ve.scanPList(r):(G._getWrapRec(r,ca),r.length=0,ca.getBoundPoints(r))),this.transform){let e=this._x-t,s=this._y-i,a=r.length;for(let t=0;t<a;t+=2)r[t]+=e,r[t+1]+=s}else{let e=r.length;for(let t=0;t<e;t+=2)_a.x=r[t],_a.y=r[t+1],this.toParentPoint(_a),r[t]=_a.x,r[t+1]=_a.y}return r}_getBoundPointsM(e,t){var i,r;if(t=t||[],null!=this._userBounds)return this._userBounds.getBoundPoints(t);if(null!=this._scrollRect)return this._scrollRect.getBoundPoints(t);null!=this._graphics&&t.push(...this._graphics.getBoundPoints()),null==this._renderNode&&null==this._texture||ca.setTo(0,0,this._width||(null===(i=this._texture)||void 0===i?void 0:i.width),this._height||(null===(r=this._texture)||void 0===r?void 0:r.height)).getBoundPoints(t);let s=this._children;for(let i=0,r=s.length;i<r;i++){let r=s[i];r._getBit(ke.ACTUAL_VISIBLE)&&r._cacheStyle.maskParent!=this&&t.push(...r._boundPointsToParent(e))}return t}getGraphicBounds(e,t){return t=t||new G,this._graphics?t.copyFrom(this._graphics.getBounds(e)):t.setTo(0,0,0,0)}localToGlobal(e,t,i){t&&(e=new d(e.x,e.y));var r=this;for(i=i||h.stage;r&&!r._destroyed&&r!=i;)e=r.toParentPoint(e),r=r._parent;return e}globalToLocal(e,t,i){t&&(e=new d(e.x,e.y));var r=this,s=[];for(i=i||h.stage;r&&!r._destroyed&&r!=i;)s.push(r),r=r._parent;for(var a=s.length-1;a>=0;)e=(r=s[a]).fromParentPoint(e),a--;return e}toParentPoint(e){if(!e)return e;e.x-=this.pivotX,e.y-=this.pivotY,this.transform&&this._transform.transformPoint(e),e.x+=this._x,e.y+=this._y;var t=this._scrollRect;return t&&(e.x-=t.x,e.y-=t.y),e}fromParentPoint(e){if(!e)return e;e.x-=this._x,e.y-=this._y;var t=this._scrollRect;return t&&(e.x+=t.x,e.y+=t.y),this.transform&&this._transform.invertTransformPoint(e),e.x+=this.pivotX,e.y+=this.pivotY,e}loadImage(e,t){if(e){let i=h.loader.getRes(e);i?(this.texture=i,this.repaint(je.REPAINT_ALL),t&&t.run()):(this._skinBaseUrl&&(e=k.formatURL(e,this._skinBaseUrl)),h.loader.load(e).then((e=>{this.texture=e,this.repaint(je.REPAINT_ALL),t&&t.run()})))}else this.texture=null,this.repaint(je.REPAINT_ALL),t&&t.run();return this}static fromImage(e){return(new ua).loadImage(e)}_getCacheStyle(){return this._cacheStyle===zr.EMPTY&&(this._cacheStyle=zr.create()),this._cacheStyle}reCache(){this._repaint|=je.REPAINT_CACHE}getRepaint(){return this._repaint}repaint(e=je.REPAINT_CACHE){this._repaint&e||(this._repaint|=e,this.parentRepaint(e)),this._cacheStyle&&(this._cacheStyle.renderTexture=null,this._cacheStyle.maskParent&&this._cacheStyle.maskParent.repaint(e))}_needRepaint(){return!!(this._repaint&je.REPAINT_CACHE)}parentRepaint(e=je.REPAINT_CACHE){var t=this._parent;!t||t._repaint&e||(t._repaint|=e,t.parentRepaint(e))}get dragSupport(){return this._dragSupport||(this._dragSupport=new Zs(this))}startDrag(e,t,i,r,s,a){let n=this.dragSupport;null!=e&&n.area.copyFrom(e),null!=t&&(n.hasInertia=t),null!=i&&(n.elasticDistance=i),null!=r&&(n.elasticBackTime=r),null!=a&&(n.ratio=a),n.start(s)}stopDrag(){this._dragSupport&&this._dragSupport.stop()}onAfterDeserialize(){super.onAfterDeserialize(),p.isPlaying&&(this._gcmds&&(this.graphics.cmds=this._gcmds,delete this._gcmds),this._filters&&(this.filters=this._filters,delete this._filters))}onStartListeningToType(e){super.onStartListeningToType(e),c.isMouseEvent(e)?0===this._mouseState&&(this._setBit(ke.CHECK_INPUT,!0),this.setMouseEnabledUp()):e===c.TRANSFORM_CHANGED&&(this._setBit(ke.DEMAND_TRANS_EVENT,!0),this.setDemandTransEventUp())}setDemandTransEventUp(){let e=this._parent;for(;e&&e!==h.stage&&e._setBit(ke.DEMAND_TRANS_EVENT,!0);)e=e._parent}_setDisplay(e){!e&&this._cacheStyle&&this._cacheStyle.onInvisible(),super._setDisplay(e)}_processVisible(){return!!this._setBit(ke.ACTUAL_VISIBLE,this._visible&&!this._getBit(la)||this._getBit(ke.FORCE_VISIBLE))&&(this.parentRepaint(je.REPAINT_ALL),!0)}_setParent(e){super._setParent(e),e&&(2===this._mouseState||0===this._mouseState&&this._getBit(ke.CHECK_INPUT))&&!e._getBit(ke.CHECK_INPUT)&&this.setMouseEnabledUp(),e&&this._getBit(ke.DEMAND_TRANS_EVENT)&&!e._getBit(ke.DEMAND_TRANS_EVENT)&&this.setDemandTransEventUp()}_childChanged(e){super._childChanged(e),this._children.length?this._renderType|=je.CHILDS:this._renderType&=~je.CHILDS,e&&e._zOrder&&this._setBit(ke.HAS_ZORDER,!0),this._getBit(ke.HAS_ZORDER)&&h.systemTimer.callLater(this,this.updateZOrder),this.repaint(je.REPAINT_ALL)}_addComponentInstance(e){var t;e instanceof aa&&(null===(t=this._components)||void 0===t?void 0:t.some((e=>e instanceof aa)))?console.warn(`${this.name} add RenderNode2D invalid, one sprite can only add one RenderNode`):super._addComponentInstance(e)}}const da=new G,ca=new G,_a=new d,pa=[];function ga(e){e.event(c.TRANSFORM_CHANGED);for(let t of e._children)t._getBit(ke.DEMAND_TRANS_EVENT)&&ga(t)}class ma extends A{static loadFont(e,t){h.loader.load(e,Be.FONT).then((e=>{t&&t.runWith(e)}))}constructor(){super(!1),this.dict={},this.fontSize=12,this.autoScaleSize=!1,this.tint=!0,this.maxWidth=0,this.lineHeight=12,this.letterSpacing=0}parseFont(e,t){var i;if(null==e||null==t)return;this.texture=t,t._addReference();let r=e.getNode("info");this.fontSize=r.getAttrInt("size",12),this.autoScaleSize=r.getAttrBool("autoScaleSize"),this.lineHeight=r.getAttrInt("lineHeight",this.fontSize),0==this.lineHeight&&(this.lineHeight=this.fontSize);let s=r.getAttrString("padding","").split(",");this.padding=[parseInt(s[0]),parseInt(s[1]),parseInt(s[2]),parseInt(s[3])];let a=(null===(i=e.getNode("chars"))||void 0===i?void 0:i.elements("char"))||[],n=0,o=this.dict;for(let e=0,i=a.length;e<i;e++){let i=a[e],r=i.getAttrInt("id"),s=i.getAttrInt("xoffset")/1,h=i.getAttrInt("yoffset")/1,l=i.getAttrInt("xadvance")/1,u=i.getAttrInt("x"),d=i.getAttrInt("y"),c=i.getAttrInt("width"),_=i.getAttrInt("height"),p=fe.create(t,u,d,c,_,s,h);0==l&&(l=c),l+=this.letterSpacing,n=Math.max(n,l),o[r]={x:0,y:0,width:c,height:_,advance:l,texture:p}}this.maxWidth=n>0?n:this.fontSize,o[32]||(o[32]={x:0,y:0,advance:Math.floor(.5*this.fontSize)+this.letterSpacing})}_disposeResource(){var e;if(this.texture){for(let t in this.dict)null===(e=this.dict[t].texture)||void 0===e||e.destroy();this.texture._removeReference(),this.dict=null,this.texture=null,this.padding=null}}getTextWidth(e,t){let i=0;for(let r=0,s=e.length;r<s;r++){let s=this.dict[e.charCodeAt(r)];if(s){let e=this.autoScaleSize?t/this.fontSize:1;i+=Math.round(s.advance*e)}}return i}getMaxWidth(e){return null!=e&&this.autoScaleSize?Math.round(this.maxWidth*(e/this.fontSize)):this.maxWidth}getMaxHeight(e){return null!=e&&this.autoScaleSize?Math.round(this.lineHeight*(e/this.fontSize)):this.lineHeight}}class fa{constructor(){this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.strikethrough=!1,this.strikethroughColor=null,this.align="left",this.valign="top",this.leading=2,this.stroke=0,this.strokeColor="#000000",this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.align="left",this.valign="top",this.alignItems="middle",this.leading=2,this.stroke=0,this.strokeColor="#000000"}}var Ta;e.HtmlElementType=void 0,(Ta=e.HtmlElementType||(e.HtmlElementType={}))[Ta.Text=0]="Text",Ta[Ta.Link=1]="Link",Ta[Ta.Image=2]="Image",Ta[Ta.Input=3]="Input",Ta[Ta.Select=4]="Select",Ta[Ta.Object=5]="Object",Ta[Ta.LinkEnd=6]="LinkEnd";class ya{constructor(){this.style=new fa}getAttr(e){return null==this._attrs?null:this._attrs[e]}setAttr(e,t){null==this._attrs&&(this._attrs={}),this._attrs[e]=t}getAttrString(e,t){return Ee.getString(this._attrs,e,t)}getAttrInt(e,t){return Ee.getInt(this._attrs,e,t)}getAttrFloat(e,t){return Ee.getFloat(this._attrs,e,t)}getAttrBool(e,t){return Ee.getBool(this._attrs,e,t)}fetchAttributes(){this._attrs=Object.assign({},Re.attributes)}reset(){this.name=null,this.text=null,this.obj&&(this.obj.release(),l.recoverByClass(this.obj),this.obj=null),this._attrs=null}static getFromPool(t){let i;return i=this.pool.length>0?this.pool.pop():new ya,i.type=t,i.type==e.HtmlElementType.Text||i._attrs||(i._attrs={}),i}static returnToPool(e){if(Array.isArray(e)){for(let t of e)t.reset();this.pool.push(...e),e.length=0}else e.reset(),this.pool.push(e)}}ya.pool=[];class xa{constructor(){this._v=0,this.obj=new ua}get element(){return this._element}get width(){return this.obj.width}get height(){return this.obj.height}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this.obj);let i=this._element.getAttrString("src");i&&this.loadTexture(i)}loadTexture(e){let t=this._element.getAttrInt("width",-1),i=this._element.getAttrInt("height",-1);-1!=t&&(this.obj.width=t),-1!=i&&(this.obj.height=i);let r=Be.getRes(e);if(r)this.obj.texture=r,-1==t&&(this.obj.width=r.sourceWidth),-1==i&&(this.obj.height=r.sourceHeight);else{let r=this._v;h.loader.load(e,{silent:!0}).then((e=>{if(this.obj.destroyed||r!=this._v)return;let s=this.obj.width,a=this.obj.height;this.obj.texture=e,-1==t&&(this.obj.width=e?e.sourceWidth:0),-1==i&&(this.obj.height=e?e.sourceHeight:0),!this._owner||s==this.obj.width&&a==this.obj.height||this._owner.refreshLayout()}))}}pos(e,t){this.obj.pos(e,t)}release(){this.obj.removeSelf(),this.obj.offAll(),this.obj.texture=null,this._owner=null,this._element=null,this._v++}destroy(){this.obj.destroy()}}class va{constructor(){this._shape=new ua,this._shape.hitArea=this,this._shape.on(c.CLICK,(()=>{this._owner.bubbleEvent(c.LINK,this._element.getAttrString("href"))})),this._rects=[],this._rectCnt=0}get element(){return this._element}get width(){return 0}get height(){return 0}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this._shape)}resetArea(){this._rectCnt=0}addRect(e,t,i,r){let s=this._rects[this._rectCnt];s||(s=this._rects[this._rectCnt]=new G),this._rectCnt++,s.setTo(e,t,i,r)}contains(e,t){for(let i=0;i<this._rectCnt;i++)if(this._rects[i].contains(e,t))return!0;return!1}pos(e,t){}release(){this._shape.removeSelf(),this._owner=null,this._element=null}destroy(){this._shape.destroy()}}class Sa{constructor(){this.linkUnderline=Sa.defaultLinkUnderline,this.linkColor=Sa.defaultLinkColor}}Sa.defaultLinkUnderline=!0,Sa.defaultLinkColor=null,Oe.regClass("HtmlParseOptions",Sa);const Da=new Array,Ea=new Array;class wa{constructor(){this._styleStack=new Array,this._style=new fa,this._options=new Sa}parse(t,i,r,s){null==s&&(s=this._options),this._elements=r,this._styleStackTop=0,Object.assign(this._style,i),this._style.colorChanged=!1;let a,n=0,o=s.ignoreWhiteSpace,h=!1;for(Re.begin(t,!0);Re.nextTag();)switch(0==n&&(a=Re.getText(o),a.length>0&&(h&&"\n"==a[0]&&(a=a.substring(1)),this.appendText(a))),h=!1,Re.tagName){case"b":Re.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.bold=!0):this.popStyle();break;case"i":Re.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.italic=!0):this.popStyle();break;case"u":Re.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.underline=!0):this.popStyle();break;case"strike":Re.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.strikethrough=!0):this.popStyle();break;case"font":if(Re.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.fontSize=Ee.getInt(Re.attributes,"size",this._style.fontSize);let e=Re.getAttribute("color");null!=e&&(this._style.color=e,this._style.colorChanged=!0)}else Re.tagType==e.XMLTagType.End&&this.popStyle();break;case"br":this.appendText("\n");break;case"img":if(Re.tagType==e.XMLTagType.Start||Re.tagType==e.XMLTagType.Void){let t=ya.getFromPool(e.HtmlElementType.Image);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,t.style.underline=this._style.underline,t.style.underlineColor=this._style.underlineColor,this._elements.push(t)}break;case"a":if(Re.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.underline=this._style.underline||s.linkUnderline,this._style.colorChanged||null==s.linkColor||(this._style.color=s.linkColor);let t=ya.getFromPool(e.HtmlElementType.Link);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,this._elements.push(t)}else if(Re.tagType==e.XMLTagType.End){this.popStyle();let t=ya.getFromPool(e.HtmlElementType.LinkEnd);this._elements.push(t)}break;case"input":{let t=ya.getFromPool(e.HtmlElementType.Input);t.fetchAttributes(),t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"select":if(Re.tagType==e.XMLTagType.Start||Re.tagType==e.XMLTagType.Void){let t=ya.getFromPool(e.HtmlElementType.Select);if(t.fetchAttributes(),Re.tagType==e.XMLTagType.Start){for(Da.length=0,Ea.length=0;Re.nextTag()&&"select"!=Re.tagName;)"option"==Re.tagName&&(Re.tagType==e.XMLTagType.Start||Re.tagType==e.XMLTagType.Void?Ea.push(Ee.getString(Re.attributes,"value","")):Da.push(Re.getText()));t.setAttr("items",Da.slice()),t.setAttr("values",Ea.slice())}t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"p":Re.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.align=Re.getAttribute("align"),this.isNewLine()||this.appendText("\n")):Re.tagType==e.XMLTagType.End&&(this.appendText("\n"),h=!0,this.popStyle());break;case"ui":case"div":case"li":Re.tagType==e.XMLTagType.Start?this.isNewLine()||this.appendText("\n"):(this.appendText("\n"),h=!0);break;case"html":case"body":o=!0;break;case"head":case"style":case"script":case"form":Re.tagType==e.XMLTagType.Start?n++:Re.tagType==e.XMLTagType.End&&n--}0==n&&(a=Re.getText(o),a.length>0&&(h&&"\n"==a[0]&&(a=a.substring(1)),this.appendText(a))),this._elements=null}pushStyle(){let e;this._styleStack.length<=this._styleStackTop?(e=new fa,this._styleStack.push(e)):e=this._styleStack[this._styleStackTop],Object.assign(e,this._style),this._styleStackTop++}popStyle(){if(this._styleStackTop>0){let e=this._styleStack[this._styleStackTop-1];Object.assign(this._style,e),this._styleStackTop--}}isNewLine(){if(this._elements.length>0){let t=this._elements[this._elements.length-1];return!(!t||t.type!=e.HtmlElementType.Text)&&t.text.endsWith("\n")}return!0}appendText(t){let i;this._elements.length>0&&(i=this._elements[this._elements.length-1],i.type==e.HtmlElementType.Text&&function(e,t){for(let i in e)if(!i.startsWith("_")&&e[i]!=t[i])return!1;return!0}(i.style,this._style))?i.text+=t:(i=ya.getFromPool(e.HtmlElementType.Text),i.text=t,Object.assign(i.style,this._style),this._elements.push(i))}}wa.defaultParser=new wa,wa.classMap={[e.HtmlElementType.Image]:xa,[e.HtmlElementType.Link]:va};class Ra{constructor(){this._readPos=0,this.defaultImgWidth=0,this.defaultImgHeight=0,this._handlers={},this._handlers.url=this.onTag_URL,this._handlers.img=this.onTag_IMG,this._handlers.b=this.onTag_B,this._handlers.i=this.onTag_I,this._handlers.u=this.onTag_U,this._handlers.sup=this.onTag_Simple,this._handlers.sub=this.onTag_Simple,this._handlers.color=this.onTag_COLOR,this._handlers.font=this.onTag_FONT,this._handlers.size=this.onTag_SIZE}onTag_URL(e,t,i){return t?"</a>":null!=i?'<a href="'+i+'">':'<a href="'+this.getTagText()+'">'}onTag_IMG(e,t,i){if(t)return null;var r=this.getTagText(!0);return r?this.defaultImgWidth?'<img src="'+r+'" width="'+this.defaultImgWidth+'" height="'+this.defaultImgHeight+'"/>':'<img src="'+r+'"/>':null}onTag_B(e,t,i){return t?"</b>":"<b>"}onTag_I(e,t,i){return t?"</i>":"<i>"}onTag_U(e,t,i){return t?"</u>":"<u>"}onTag_Simple(e,t,i){return t?"</"+e+">":"<"+e+">"}onTag_COLOR(e,t,i){return t?"</font>":(this.lastColor=i,'<font color="'+i+'">')}onTag_FONT(e,t,i){return t?"</font>":'<font face="'+i+'">'}onTag_SIZE(e,t,i){return t?"</font>":(this.lastSize=i,'<font size="'+i+'">')}getTagText(e){for(var t,i=this._readPos,r="";-1!=(t=this._text.indexOf("[",i));){if(92!=this._text.charCodeAt(t-1)){r+=this._text.substring(i,t);break}r+=this._text.substring(i,t-1),r+="[",i=t+1}return-1==t?null:(e&&(this._readPos=t),r)}parse(e,t){this._text=e,this.lastColor=null,this.lastSize=null;for(var i,r,s,a,n,o,h,l=0,u="";-1!=(i=e.indexOf("[",l));)if(i>0&&92==e.charCodeAt(i-1))u+=e.substring(l,i-1),u+="[",l=i+1;else{if(u+=e.substring(l,i),l=i,-1==(i=e.indexOf("]",l)))break;s="/"==e.charAt(l+1),a=e.substring(s?l+2:l+1,i),this._readPos=i+1,n=null,o=null,-1!=(r=a.indexOf("="))&&(n=a.substring(r+1),a=a.substring(0,r)),a=a.toLowerCase(),null!=(h=this._handlers[a])?t||null!=(o=h.call(this,a,s,n))&&(u+=o):u+=e.substring(l,this._readPos),l=this._readPos}return l<e.length&&(u+=e.substring(l)),this._text=null,u}}Ra.defaultParser=new Ra;class Ca extends ua{constructor(){super(),this._overflow=Ca.VISIBLE,this._singleCharRender=!1,this._prompt="",this._textWidth=0,this._textHeight=0,this._textStyle=new fa,this._textStyle.fontSize=t.defaultFontSize,this._text="",this.font="",this._elements=[],this._lines=[],this._padding=[0,0,0,0],this._fontSizeScale=1}static registerBitmapFont(e,t){t._addReference(),Ca._bitmapFonts[e]=t}static unregisterBitmapFont(e,t=!0){let i=Ca._bitmapFonts[e];i&&(i._removeReference(),t&&i.destroy(),delete Ca._bitmapFonts[e])}destroy(e=!0){ba(this._lines),ya.returnToPool(this._elements),super.destroy(e)}_getBoundPointsM(e,t){return G.TEMP.setTo(0,0,this.width,this.height).getBoundPoints(t)}getGraphicBounds(e,t){return(t||new G).setTo(0,0,this.width,this.height)}measureWidth(){return this.typeset(),this._textWidth}measureHeight(){return this.typeset(),this._textHeight}_transChanged(t){super._transChanged(t),0!=(t&e.TransformKind.Size)&&(this._updatingLayout?this.drawBg():this.markChanged())}get textWidth(){return this.typeset(),this._textWidth}get textHeight(){return this.typeset(),this._textHeight}get text(){return this._text}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),!this.ignoreLang&&Ca.langPacks&&(e=Ca.langPacks[e]||e),this._text!=e&&(this._text=e,this.markChanged(),this.event(c.CHANGE))}changeText(e){this.text=e}get font(){return this._textStyle.font}set font(e){if(this._textStyle.font=e,e||(e=t.defaultFont)||(e="Arial"),this._realFont=e,this._bitmapFont=Ca._bitmapFonts[e],this._bitmapFont)this._text&&this.markChanged();else if(e&&(O.getFileExtension(e)||e.startsWith("res://"))){let t=e,i=h.loader.getRes(e);!i||i.obsolute?h.loader.load(e).then((e=>{e&&this._realFont==t&&(e instanceof ma?this._bitmapFont=e:this._realFont=e.family,this._text&&this.markChanged())})):(i instanceof ma?this._bitmapFont=i:this._realFont=i.family,this._text&&this.markChanged())}else this._realFont=I.onIPhone&&t.fontFamilyMap[e]||e,this._text&&this.markChanged()}get fontSize(){return this._textStyle.fontSize}set fontSize(e){this._textStyle.fontSize!=e&&(this._textStyle.fontSize=e,this.markChanged())}get color(){return this._textStyle.color}set color(e){this._textStyle.color!=e&&(this._textStyle.color=e,!this._isChanged&&this._graphics&&0==this._elements.length?this._graphics.replaceTextColor(this._textStyle.color):this.markChanged())}get bold(){return this._textStyle.bold}set bold(e){this._textStyle.bold!=e&&(this._textStyle.bold=e,this.markChanged())}get italic(){return this._textStyle.italic}set italic(e){this._textStyle.italic!=e&&(this._textStyle.italic=e,this.markChanged())}get align(){return this._textStyle.align}set align(e){this._textStyle.align!=e&&(this._textStyle.align=e,this.markChanged())}get valign(){return this._textStyle.valign}set valign(e){this._textStyle.valign!=e&&(this._textStyle.valign=e,this.markChanged())}get alignItems(){return this._textStyle.alignItems}set alignItems(e){this._textStyle.alignItems!=e&&(this._textStyle.alignItems=e,this.markChanged())}get wordWrap(){return this._wordWrap}set wordWrap(e){this._wordWrap!=e&&(this._wordWrap=e,this.markChanged())}get leading(){return this._textStyle.leading}set leading(e){this._textStyle.leading!=e&&(this._textStyle.leading=e,this.markChanged())}get padding(){return this._padding}set padding(e){if("string"==typeof e){let t=e.split(",");this._padding.length=0;for(let e=0;e<4;e++){let i=parseFloat(t[e]);isNaN(i)&&(i=0),this._padding.push(i)}}else this._padding=e;this.markChanged()}get bgColor(){return this._bgColor}set bgColor(e){this._bgColor=e,this.drawBg()}get borderColor(){return this._borderColor}set borderColor(e){this._borderColor=e,this.drawBg()}get stroke(){return this._textStyle.stroke}set stroke(e){this._textStyle.stroke!=e&&(this._textStyle.stroke=e,this.markChanged())}get strokeColor(){return this._textStyle.strokeColor}set strokeColor(e){this._textStyle.strokeColor!=e&&(this._textStyle.strokeColor=e,this.markChanged())}get overflow(){return this._overflow}set overflow(e){this._overflow!=e&&(this._overflow=e,this.markChanged())}get underline(){return this._textStyle.underline}set underline(e){this._textStyle.underline!=e&&(this._textStyle.underline=e,this.markChanged())}get underlineColor(){return this._textStyle.underlineColor}set underlineColor(e){this._textStyle.underlineColor!=e&&(this._textStyle.underlineColor=e,this.markChanged())}get strikethrough(){return this._textStyle.strikethrough}set strikethrough(e){this._textStyle.strikethrough!=e&&(this._textStyle.strikethrough=e,this.markChanged())}get strikethroughColor(){return this._textStyle.strikethroughColor}set strikethroughColor(e){this._textStyle.strikethroughColor!=e&&(this._textStyle.strikethroughColor=e,this.markChanged())}get singleCharRender(){return this._singleCharRender}set singleCharRender(e){this._singleCharRender=e}get html(){return this._html}set html(e){this._html!=e&&(this._html=e,this.markChanged())}get ubb(){return this._ubb}set ubb(e){this._ubb!=e&&(this._ubb=e,this.markChanged())}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth!=e&&(this._maxWidth=e,this.markChanged())}get htmlParseOptions(){return this._htmlParseOptions}set htmlParseOptions(e){this._htmlParseOptions=e}get templateVars(){return this._templateVars}set templateVars(e){(this._templateVars||e)&&(this._templateVars=!0===e?{}:!1===e?null:e,this.markChanged())}setVar(e,t){return this._templateVars||(this._templateVars={}),this._templateVars[e]=t,this.markChanged(),this}get scrollX(){return this._scrollPos?this._scrollPos.x:0}set scrollX(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollX;e=(e=e<0?0:e)>t?t:e,this._scrollPos.x=e,this.renderText()}get scrollY(){return this._scrollPos?this._scrollPos.y:0}set scrollY(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollY;e=(e=e<0?0:e)>t?t:e,this._scrollPos.y=e,this.renderText()}get maxScrollX(){let e=this.textWidth-this._width;return e<0?0:e}get maxScrollY(){let e=this.textHeight-this._height;return e<0?0:e}get lines(){return this.typeset(),this._lines}markChanged(){this._isChanged||(this._isChanged=!0,h.systemTimer.callLater(this,this._typeset))}typeset(){this._isChanged&&h.systemTimer.runCallLater(this,this._typeset)}refreshLayout(){h.systemTimer.callLater(this,this.doLayout)}get objContainer(){return this._objContainer||(this._objContainer=new ua,this._objContainer.hideFlags|=Ge.HideAndDontSave,this.addChild(this._objContainer)),this._objContainer}_typeset(){if(this._isChanged=!1,this._hideText||this._destroyed)return;ya.returnToPool(this._elements),this._objContainer&&this._objContainer.removeChildren();let t,i=this._text;if(this._onTranslate&&(i=this._onTranslate(i,this._templateVars)),!i&&this._prompt&&(i=this._prompt,t=!0),!i)return this.graphics.clear(!0),this.drawBg(),this._textWidth=this._textHeight=0,this._scrollPos=null,void(this._onPostLayout&&(this._updatingLayout=!0,this._onPostLayout(),this._updatingLayout=!1));let r,s=this._html;if(i=i.replace(Na,"\n"),this._parseEscapeChars&&(i=i.replace(Oa,Ga)),!t&&this._templateVars&&(i=O.parseTemplate(i,this._templateVars)),this._ubb&&(i=Ra.defaultParser.parse(i),s=!0),!t&&this._asPassword&&(i=Ca._passwordChar.repeat(i.length)),t&&(r=this._textStyle.color,this._textStyle.color=this._promptColor),s)wa.defaultParser.parse(i,this._textStyle,this._elements,this._htmlParseOptions);else{let t=ya.getFromPool(e.HtmlElementType.Text);Object.assign(t.style,this._textStyle),t.text=i,this._elements.push(t)}t&&(this._textStyle.color=r),this.doLayout()}doLayout(){if(this._destroyed)return;this._updatingLayout=!0,this._fontSizeScale=1;let t,i=this._wordWrap||this._overflow==Ca.ELLIPSIS,r=this._padding;if(t=this._isWidthSet?this._width-r[3]-r[1]:Number.MAX_VALUE,this._maxWidth>0){let e=this._maxWidth-r[3]-r[1];(!i||e<t)&&(t=e),i=!0}let s,a,n,o,h,u,c,_,p=this._isHeightSet?this._height-r[0]-r[2]:Number.MAX_VALUE,g=this._bitmapFont,m="middle"==this._textStyle.alignItems?1:"bottom"==this._textStyle.alignItems?2:0,f=e=>{if(g)return g.getTextWidth(e,c);{let t=I.context.measureText(e);return t?t.width:100}},T=(e,t,i)=>{if(g)return g.getTextWidth(e,i);{let i=I.context.font;I.context.font=t;let r=I.context.measureText(e);return I.context.font=i,r?r.width:100}},y=(e,t)=>{if(c=Math.floor(t.fontSize*this._fontSizeScale),0==c&&(c=1),g)h=g.getMaxWidth(c),u=g.getMaxHeight(c);else{I.context.font=_=(t.italic?"italic ":"")+(t.bold?"bold ":"")+c+"px "+this._realFont;let e=I.context.measureText(Ca._testWord);e?(h=e.width,u=Math.ceil(e.height||c)):(h=100,u=c)}let r=e.split("\n");if(i)for(let e=0,i=r.length;e<i;e++){let s=r[e];s.length>0&&E(s,t),e!=i-1&&D()}else for(let e=0,i=r.length;e<i;e++){let s=r[e];s.length>0&&x(s,t,null),e!=i-1&&D()}},x=(e,t,i)=>{let r=Aa.length>0?Aa.pop():{};r.x=s,r.y=a,"string"==typeof e?(i||(i=f(e)),r.wt||(r.wt=new lr),r.wt.setText(e),r.wt.width=i,r.wt.splitRender=this._singleCharRender,r.ctxFont=_,r.fontSize=c,r.width=i,r.height=u):(r.obj=e,r.width=e.width,r.height=e.height,e.width>0&&(r.x++,r.width+=2)),r.style=t,r.linkEnd=!1,r.next=null,r.prev=o,s+=Math.round(r.width),o?o.next=r:n.cmd=r,o=r},v=e=>{for(;e.linkEnd;)e=e.next;if(e)for(e.prev.next=null;e;){let t=e.next;e.x=s,e.y=a,e.next=null,e.prev=o,s+=Math.round(e.width),o?o.next=e:n.cmd=e,o=e,e=t}},S=(e,t)=>{if(za(e.wt.text.charCodeAt(t))&&t--,0==t)return!1;let i=e.wt.text.substring(t);e.wt.setText(e.wt.text.substring(0,t)),e.width=e.wt.width=T(e.wt.text,e.ctxFont,e.fontSize);let r=Aa.length>0?Aa.pop():{};return r.wt||(r.wt=new lr),r.wt.setText(i),r.style=e.style,r.ctxFont=e.ctxFont,r.fontSize=e.fontSize,r.width=r.wt.width=T(i,e.ctxFont,e.fontSize),r.height=e.height,r.next=e.next,r.prev=e,e.next=r,!0},D=e=>{if(s=0,n){let e=0,t=0,i=n.cmd;for(;i;)i.height>e&&(e=i.height),t+=i.width,i=i.next;for(i=n.cmd;i;)i.y=1==m?Math.floor(.5*(e-i.height)):2==m?Math.floor(e-i.height):0,i=i.next;0==e&&(e=u),e++,n.height=e,n.width=Math.round(t),a+=n.height+Math.floor(this._textStyle.leading*this._fontSizeScale)}return e?null:(n=Ma.length>0?Ma.pop():{},n.x=0,n.y=a,this._lines.push(n),o=null,n)},E=(e,i)=>{let r=Math.max(0,t-s),a=f(e);if(a<=r)return void x(e,i,a);let n,l,u=0,d=0,c=0,_=Ba.test(e);g||_||(u=Math.floor(r/h),0!=u&&(d=f(e.substring(0,u))));let p=e.length;for(let h=u;h<p;h++){let g=e.charAt(h),m=g.charCodeAt(0);if(_&&Va(m)&&h+1<p&&(g+=e.charAt(h+1)),a=f(g),d+=a,d<r||h===c&&0===s){g.length>1&&h++;continue}let T=e.substring(c,h);if(d-=a,m>=65&&m<=90||m>=97&&m<=122||m>=48&&m<=57||(n=Pa.includes(m))){let i=T.length>0?(l=La.exec(T))?l.index:null:0;if(i>0)i>T.length-ka&&(h=c+i,T=e.substring(c,h),d=null,a=null);else if(null!=i&&null!=o){let e=o,i=T.length,h=!1;for(;e;){if(e.width>0){if(null!=e.obj)break;l=La.exec(e.wt.text);let t=e.wt.text.length;if(null==l){D(),n&&0==i?S(e,t-1)?v(e.next):e.x>0&&v(e):null!=e.next&&v(e.next),h=!0;break}if(l.index>0){l.index>t-(ka-i)&&(D(),S(e,l.index),v(e.next),h=!0);break}if(i+=t,i>=ka)break}e=e.prev}if(h&&(r=t-s,d+a<r)){d+=a;continue}}else if(n){let t=_&&h>=1&&za(e.charCodeAt(h-1))?2:1;(h-t>c||s>0)&&(h-=t,T=e.substring(c,h),d=null,a=null)}}T.length>0&&x(T,i,d),D(),c=h,r=t,d=null,u>1?h+=u-1:null!=a?(d=a,g.length>1&&h++):_&&Va(e.charCodeAt(h))&&h++,null==d&&h<p-1&&(d=f(e.substring(c,h+1)))}x(e.substring(c,p),i)},w=()=>{let e=0,t=0;for(let t of this._lines)t.width>e&&(e=t.width);e>0&&(e+=r[1]+r[3]),this._textWidth=e;let i=this._lines[this._lines.length-1];i&&(t=i.y+i.height),t>0&&(t+=r[0]+r[2]),this._textHeight=t},R=()=>{s=a=h=u=0,n=null,o=null,ba(this._lines),D();let r=this._elements;for(let a=0,n=r.length;a<n;a++){let n=r[a];if(n.type==e.HtmlElementType.Text)y(n.text,n.style);else if(n.type==e.HtmlElementType.LinkEnd)o&&(o.linkEnd=!0);else{let e=n.obj;if(!e){let t=wa.classMap[n.type];t&&(e=l.createByClass(t),e.create(this,n),n.obj=e)}if(e){if(i){let i=t-s;e.width>0&&i<e.width+1&&s>0&&D()}x(e,n.style)}}}D(!0),w()};if(R(),this._overflow==Ca.SHRINK){if(this._lines.length>1&&this._textHeight>p){let e=0,i=this._textStyle.fontSize;this._fontSizeScale=Math.sqrt(p/this._textHeight);let r=Math.floor(this._fontSizeScale*this._textStyle.fontSize);for(;R(),this._textWidth>t||this._textHeight>p?i=r:e=r,i-e>1||i!=e&&r==i;)r=e+(i-e)/2,this._fontSizeScale=r/this._textStyle.fontSize}else if(this._textWidth>t&&(this._fontSizeScale=t/this._textWidth,R(),this._textWidth>t)){let e=Math.floor(this._textStyle.fontSize*this._fontSizeScale);e--,this._fontSizeScale=e/this._textStyle.fontSize,R()}}else if(this._overflow==Ca.ELLIPSIS&&(this._textWidth>t||this._textHeight>p||!this._wordWrap&&this._lines.length>1)){let e;!this._wordWrap&&this._lines.length>1?e=1:(e=this._lines.findIndex((e=>e.y+e.height>p)),0==e&&(e=1));let i=!1;-1!=e&&this._lines.length>e&&(ba(this._lines.splice(e,this._lines.length-e),!0),i=!0),n=this._lines[this._lines.length-1];let r,s,a=n.cmd,o=!1;for(;a;){if(r=a.next,a.obj||(s=a),o)Ia(a,!0),Aa.push(a);else if(!r&&i||a.x+a.width>t){if(a.obj)Ia(a,!0),a.wt=new lr,a.wt.setText(Ua),s?(a.ctxFont=s.ctxFont,a.fontSize=s.fontSize,a.height=s.height,a.style=s.style):(a.ctxFont=_,a.fontSize=c,a.height=u,a.style=this._textStyle),a.wt.splitRender=this._singleCharRender;else{let e=a.wt.text.length-2;e>0&&za(a.wt.text.charCodeAt(e))&&e--,a.wt.setText(a.wt.text.substring(0,Math.max(0,e))+Ua)}a.width=a.wt.width=T(a.wt.text,a.ctxFont,a.fontSize),a.next=null,o=!0,D(!0)}a=r}(o||i)&&w()}this._onPostLayout&&this._onPostLayout();let C="center"==this._textStyle.align?1:"right"==this._textStyle.align?2:0;if(0!=C&&this._isWidthSet){let e=this._width-r[3]-r[1];for(let t of this._lines){let i=0;1==C?i=Math.floor(.5*(e-t.width)):2==C&&(i=e-t.width),i>0&&(t.x=i)}}if(this._isHeightSet&&this._textHeight<this._height){let e=0;if("middle"===this._textStyle.valign?e=Math.floor(.5*(this._height-this._textHeight)):"bottom"===this._textStyle.valign&&(e=this._height-this._textHeight),e>0)for(let t of this._lines)t.y+=e}if(this._overflow==Ca.SCROLL&&(this._isWidthSet&&this._textWidth>this._width||this._isHeightSet&&this._textHeight>this._height))if(this._scrollPos){let e=this.maxScrollX,t=this.maxScrollY;this._scrollPos.x>e&&(this._scrollPos.x=e),this._scrollPos.y>t&&(this._scrollPos.y=t)}else this._scrollPos=new d(0,0);else this._scrollPos=null;this._objContainer&&(this._objContainer.size(this._width,this._height),this._scrollPos||this._overflow==Ca.HIDDEN&&this._objContainer.numChildren>0?(this._objContainer.scrollRect||(this._objContainer.scrollRect=new G),this._objContainer.scrollRect.setTo(0,0,this._width,this._height)):this._objContainer.scrollRect=null),this._updatingLayout=!1,this.renderText()}renderText(){let t=this.graphics;t.clear(!0),this.drawBg();let i=this._padding,r=i[3],s=i[0],a=this._bitmapFont,n=this._scrollPos,o=this._isWidthSet?this._width:this._textWidth,h=this._isHeightSet?this._height:this._textHeight,l=h-i[2],u=this._overflow==Ca.HIDDEN||this._overflow==Ca.SCROLL;u&&(t.save(),t.clipRect(0,0,o,h),this.repaint()),o-=i[3]+i[1],h-=i[0]+i[2];let d,c,_=0,p=0,g=this._lines,m=g.length;for(let i=0;i<m;i++){let h=g[i];_=r+h.x,p=s+h.y,n&&(_-=n.x,p-=n.y);let m=u&&(p+h.height<=s||p>=l),f=h.cmd;for(;f;){if(f.linkEnd&&d&&(d.addRect(c,p,_+f.x+f.width-c,h.height),d=null),f.obj)f.obj.pos(_+f.x,p+f.y),f.obj.element.type==e.HtmlElementType.Link&&(d=f.obj,d.resetArea(),c=_+f.x);else if(!m)if(a){let e=0,i=f.wt.text,r=a.tint?f.style.color:"#FFFFFF",s=Math.floor((a.autoScaleSize?f.style.fontSize:a.fontSize)*this._fontSizeScale)/a.fontSize;for(let n=0,o=i.length;n<o;n++){let o=i.charCodeAt(n),h=a.dict[o];h&&(h.texture&&t.drawImage(h.texture,_+f.x+e+h.x*s,p+f.y+h.y*s,h.width*s,h.height*s,r),e+=Math.round(h.advance*s))}}else f.style.stroke?t.fillBorderText(f.wt,_+f.x,p+f.y,f.ctxFont,f.style.color,null,f.style.stroke,f.style.strokeColor):t.fillText(f.wt,_+f.x,p+f.y,f.ctxFont,f.style.color,null);if(!m&&f.width>0){if(f.style.underline){let e=Math.max(1,f.fontSize/16);t.drawLine(_+f.x,p+h.height-e,_+f.x+f.width,p+h.height-e,f.style.underlineColor||f.style.color,e)}if(f.style.strikethrough){let e=Math.max(1,f.fontSize/16),i=_+f.x,r=p+h.height/2-e|0,s=4;t.drawLine(i-s,r,i+f.width+s,r,f.style.strikethroughColor||f.style.color,e)}}f=f.next}d&&(d.addRect(c,p,o-c+r,h.height),c=r)}u&&t.restore()}drawBg(){let e=this._bgDrawCmd;if(this._bgColor||this._borderColor){e||(e=new hs,e.x=e.y=0,e.width=e.height=1,e.percent=!0,this._bgDrawCmd=e),e.fillColor=this._bgColor,e.lineColor=this._borderColor,e.lineWidth=this._borderColor?1:0;let t=this.graphics.cmds,i=t.indexOf(e);0!=i&&(-1!=i&&t.splice(i,1),t.unshift(e),this.graphics.cmds=t)}else e&&this.graphics.removeCmd(e)}}Ca.VISIBLE="visible",Ca.SCROLL="scroll",Ca.HIDDEN="hidden",Ca.SHRINK="shrink",Ca.ELLIPSIS="ellipsis",Ca.RightToLeft=!1,Ca._testWord="游",Ca._passwordChar="●",Ca._bitmapFonts={};const Aa=[],Ma=[];function ba(e,t){for(let i of e){let e=i.cmd;for(;e;)Ia(e,t),Aa.push(e),e=e.next;i.cmd=null}Ma.push(...e),e.length=0}function Ia(e,t){e.obj?(t&&(e.obj.element.obj=null,e.obj.release(),l.recoverByClass(e.obj)),e.obj=null):e.wt&&e.wt.cleanCache()}const Ba=/[\uD800-\uDBFF][\uDC00-\uDFFF]/,La=/[a-zA-Z0-9\!-\+\/_]+$/,Pa=Array.from(".,，。、!！；;”’)）]】}》").map((e=>e.charCodeAt(0))),Na=/\r\n/g,Oa=/\\(\w)/g,Fa={"\\n":"\n","\\t":"\t"},Ua="…",ka=20;function Ga(e){return Fa[e]}function Va(e){return e>=55296&&e<=56319}function za(e){return e>=56320&&e<=57343}class Ha extends Ca{constructor(){super(),this._multiline=!1,this._editable=!0,this._maxChars=0,this._type="text",Ha.IOS_IFRAME=h.Browser.onIOS&&h.Browser.window.top!=h.Browser.window.self,this._width=100,this._height=20,this.overflow=Ca.SCROLL,this.valign="middle",this._promptColor="#a9a9a9",this.on(c.MOUSE_DOWN,this,this._onMouseDown),this.on(c.UNDISPLAY,this,this._onUnDisplay)}static __init__(e){if(Ha._createInputElement(),h.Browser.onMobile){var t=!1;(h.Browser.onMiniGame||h.Browser.onBDMiniGame||h.Browser.onQGMiniGame||h.Browser.onKGMiniGame||h.Browser.onVVMiniGame||h.Browser.onAlipayMiniGame||h.Browser.onQQMiniGame||h.Browser.onBLMiniGame||h.Browser.onTTMiniGame||h.Browser.onHWMiniGame||h.Browser.onTBMiniGame)&&(t=!0),e.addEventListener(Ha.IOS_IFRAME?t?"touchend":"click":"touchend",Ha._popupInputMethod)}}static _popupInputMethod(e){Ha.isInputting&&Ha.inputElement.focus()}static _createInputElement(){Ha._initInput(Ha.area=h.Browser.createElement("textarea")),Ha._initInput(Ha.input=h.Browser.createElement("input")),Ha.inputContainer=h.Browser.createElement("div"),Ha.inputContainer.style.position="absolute",Ha.inputContainer.style.zIndex="1E5",h.Browser.container.appendChild(Ha.inputContainer),Ha.inputContainer.setPos=function(e,t){Ha.inputContainer.style.left=e+"px",Ha.inputContainer.style.top=t+"px"}}static _initInput(e){var t=e.style;t.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",t.resize="none",t.backgroundColor="transparent",t.border="none",t.outline="none",t.zIndex="1",e.addEventListener("input",Ha._processInputting),e.addEventListener("mousemove",Ha._stopEvent,{passive:!1}),e.addEventListener("mousedown",Ha._stopEvent,{passive:!1}),e.addEventListener("touchmove",Ha._stopEvent,{passive:!1}),e.setFontFace=function(t){e.style.fontFamily=t},p.isConch&&!Ha.isAppUseNewInput||(e.setColor=function(t){e.style.color=t},e.setFontSize=function(t){e.style.fontSize=t+"px"})}static _processInputting(e){var t=Ha.inputElement.target;if(t){var i=Ha.inputElement.value;t._restrictPattern&&(i=i.replace(/\u2006|\x27/g,""),t._restrictPattern.test(i)&&(i=i.replace(t._restrictPattern,""),Ha.inputElement.value=i)),null==i&&(i=""),t._text=i,t.event(c.INPUT)}}static _stopEvent(e){"touchmove"==e.type&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()}setSelection(e,t){this.focus=!0,Ha.inputElement.selectionStart=e,Ha.inputElement.selectionEnd=t}get multiline(){return this._multiline}set multiline(e){this._multiline!=e&&(this._multiline=e,this.valign=e?"top":"middle")}get nativeInput(){return this._multiline?Ha.area:Ha.input}_onUnDisplay(e=null){this.focus=!1}_onMouseDown(e){this.focus=!0}_syncInputTransform(){var e=this.nativeInput,t=ea.getTransformRelativeToWindow(this,this._padding[3],this._padding[0]),i=this._width-this._padding[1]-this._padding[3],r=this._height-this._padding[0]-this._padding[2];p.isConch&&!Ha.isAppUseNewInput?(e.setScale(t.scaleX,t.scaleY),e.setSize(i,r),e.setPos(t.x,t.y)):(Ha.inputContainer.style.transform=Ha.inputContainer.style.webkitTransform="scale("+t.scaleX+","+t.scaleY+") rotate("+h.stage.canvasDegree+"deg)",e.style.width=i+"px",e.style.height=r+"px",Ha.inputContainer.style.left=t.x+"px",Ha.inputContainer.style.top=t.y+"px")}select(){this.nativeInput.select()}get focus(){return this._focus}set focus(e){var t=this.nativeInput;this._focus!==e&&(e?(t.target?t.target._focusOut():this._setInputMethod(),(t=this.nativeInput).target=this,this._focusIn()):(t.target=null,this._focusOut(),h.Browser.document.body.scrollTop=0,t.blur(),p.isConch&&!Ha.isAppUseNewInput?t.setPos(-1e4,-1e4):Ha.inputContainer.contains(t)&&Ha.inputContainer.removeChild(t)))}_setInputMethod(){Ha.input.parentElement&&Ha.inputContainer.removeChild(Ha.input),Ha.area.parentElement&&Ha.inputContainer.removeChild(Ha.area),h.Browser.onAndroid&&(Ha.input=Ha.inputElement=h.Browser.createElement("input"),Ha._initInput(Ha.input)),Ha.inputElement=this._multiline?Ha.area:Ha.input,Ha.inputContainer.appendChild(Ha.inputElement),Ca.RightToLeft&&(Ha.inputElement.style.direction="rtl")}_focusIn(){Ha.isInputting=!0;var e=this.nativeInput;Ha.input&&(Ha.input.type=this._type),this._focus=!0;var t=e.style;t.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),e.readOnly=!this._editable,p.isConch&&!Ha.isAppUseNewInput&&(e.setType(this._type),e.setForbidEdit(!this._editable)),e.maxLength=this._maxChars<=0?1e5:this._maxChars,e.value=this._text,e.placeholder=this._prompt,h.stage.off(c.KEY_DOWN,this,this._onKeyDown),h.stage.on(c.KEY_DOWN,this,this._onKeyDown),h.stage.focus=this,this.event(c.FOCUS),h.Browser.onPC&&e.focus(),p.isConch&&Ha.isAppUseNewInput||h.Browser.onMiniGame||h.Browser.onBDMiniGame||h.Browser.onQGMiniGame||h.Browser.onKGMiniGame||h.Browser.onVVMiniGame||h.Browser.onAlipayMiniGame||h.Browser.onQQMiniGame||h.Browser.onBLMiniGame||h.Browser.onTTMiniGame||h.Browser.onHWMiniGame||h.Browser.onTBMiniGame||(this.graphics.clear(!0),this.drawBg(),this._hideText=!0),e.setColor(this.color),e.setFontSize(this.fontSize),e.setFontFace(this._realFont),p.isConch&&!Ha.isAppUseNewInput&&e.setMultiAble&&e.setMultiAble(this._multiline),t.lineHeight=this.leading+this.fontSize+"px",t.fontStyle=this.italic?"italic":"normal",t.fontWeight=this.bold?"bold":"normal",t.textAlign=this.align,t.padding="0 0",this._syncInputTransform(),!p.isConch&&h.Browser.onPC&&h.systemTimer.frameLoop(1,this,this._syncInputTransform)}_setPromptColor(){Ha.promptStyleDOM=h.Browser.getElementById("promptStyle"),Ha.promptStyleDOM||(Ha.promptStyleDOM=h.Browser.createElement("style"),Ha.promptStyleDOM.setAttribute("id","promptStyle"),h.Browser.document.head.appendChild(Ha.promptStyleDOM)),Ha.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"}_focusOut(){Ha.isInputting&&(Ha.isiOSWKwebView||(Ha.isInputting=!1),this._focus=!1,this._hideText=!1,this.text=this.nativeInput.value,this.markChanged(),this.typeset(),h.stage.off(c.KEY_DOWN,this,this._onKeyDown),h.stage.focus=null,this.event(c.BLUR),this.event(c.CHANGE),p.isConch&&!Ha.isAppUseNewInput&&this.nativeInput.blur(),h.Browser.onPC&&h.systemTimer.clear(this,this._syncInputTransform))}_onKeyDown(e){13===e.keyCode&&(h.Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event(c.ENTER))}miniGameTxt(e){e+="",this._multiline||(e=e.replace(/\r?\n/g,"")),this.text=e}get text(){return this._focus?this.nativeInput.value:super.text}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),this._focus?(this.nativeInput.value=e,this.event(c.CHANGE)):(this._multiline||(e=e.replace(/\r?\n/g,"")),super.text=e)}get color(){return this._textStyle.color}set color(e){this._focus&&this.nativeInput.setColor(e),super.color=e}get bgColor(){return super.bgColor}set bgColor(e){super.bgColor=e,p.isConch&&!Ha.isAppUseNewInput&&this.nativeInput.setBgColor(e)}get restrict(){return this._restrict}set restrict(e){this._restrict=e,e?((e="[^"+e+"]").indexOf("^^")>-1&&(e=e.replace("^^","")),this._restrictPattern=new RegExp(e,"g")):this._restrictPattern=null}get editable(){return this._editable}set editable(e){this._editable=e,p.isConch&&!Ha.isAppUseNewInput&&Ha.input.setForbidEdit(!e)}get maxChars(){return this._maxChars}set maxChars(e){this._maxChars=e}get prompt(){return this._prompt}set prompt(e){var t;e=(null===(t=Ca.langPacks)||void 0===t?void 0:t[e])||e,this._prompt!=e&&(this._prompt=e,this.markChanged())}get promptColor(){return this._promptColor}set promptColor(e){this._promptColor!=e&&(this._promptColor=e,this.markChanged())}get type(){return this._type}set type(e){this._asPassword="password"===e,this._type=e,this.markChanged()}}Ha.TYPE_TEXT="text",Ha.TYPE_PASSWORD="password",Ha.TYPE_EMAIL="email",Ha.TYPE_URL="url",Ha.TYPE_NUMBER="number",Ha.TYPE_RANGE="range",Ha.TYPE_DATE="date",Ha.TYPE_MONTH="month",Ha.TYPE_WEEK="week",Ha.TYPE_TIME="time",Ha.TYPE_DATE_TIME="datetime",Ha.TYPE_DATE_TIME_LOCAL="datetime-local",Ha.TYPE_SEARCH="search",Ha.isInputting=!1,Ha.isiOSWKwebView=!1,Ha.IOS_IFRAME=!1,Ha.isAppUseNewInput=!1;var Wa=!0;const Ya=new d,Xa=new G,qa=[],ja=[];var Ka;class $a{constructor(){this._touches=[],this._touchPool=[],this._mouseTouch=new Za(this._touches),this._pressKeys=new Set,this._keyEvent=new c,this._keyEvent._touches=this._touches}static get inst(){return Ka}static getTouchPos(e){var t;return null==e&&(e=$a.lastTouchId),(null===(t=Ka.getTouch(e))||void 0===t?void 0:t.pos)||Ka._mouseTouch.pos}static get touchTarget(){return Ka._touchTarget}static get touches(){return Ka._touches}static get touchCount(){return Ka._touches.length}static cancelClick(e){null==e&&(e=$a.lastTouchId);let t=Ka.getTouch(e);t&&(t.clickCancelled=!0)}static hasKeyDown(e){return Ka._pressKeys.has(e)}static __init__(e,t){let i=Ka=new $a;i._stage=e,t.oncontextmenu=()=>!1,t.addEventListener("mousedown",(e=>{I.onIE||e.cancelable&&e.preventDefault(),i.handleMouse(e,0)}),{passive:!1}),t.addEventListener("mouseup",(e=>{e.cancelable&&e.preventDefault(),i.handleMouse(e,1)}),{passive:!1}),t.addEventListener("mousemove",(e=>{e.cancelable&&e.preventDefault(),i.handleMouse(e,2)}),{passive:!1}),t.addEventListener("mouseout",(e=>{i.handleMouse(e,3)}),{passive:!1}),t.addEventListener("touchstart",(e=>{Wa||Ha.isInputting||e.cancelable&&e.preventDefault(),i.handleTouch(e,0)}),{passive:!1}),t.addEventListener("touchend",(e=>{Wa||Ha.isInputting||e.cancelable&&e.preventDefault(),Wa=!1,i.handleTouch(e,1)}),{passive:!1}),t.addEventListener("touchmove",(e=>{e.cancelable&&e.preventDefault(),i.handleTouch(e,2)}),{passive:!1}),t.addEventListener("touchcancel",(e=>{e.cancelable&&e.preventDefault(),i.handleTouch(e,3)}),{passive:!1}),t.addEventListener("wheel",(e=>{i.handleMouse(e,4)}),{passive:!1}),t.addEventListener("pointerdown",(e=>{t.setPointerCapture(e.pointerId)})),t.addEventListener("pointerup",(e=>{t.releasePointerCapture(e.pointerId)}),!0);let r=I.document;r.addEventListener("keydown",(e=>{i.handleKeys(e)}),!0),r.addEventListener("keypress",(e=>{i.handleKeys(e)}),!0),r.addEventListener("keyup",(e=>{i.handleKeys(e)}),!0)}handleMouse(e,t){this._eventType=t,this._nativeEvent=e,$a.lastTouchId=0;let i=I.now();if(null!=this._lastTouchTime&&i-this._lastTouchTime<100)return;let r=this._mouseTouch;Ya.setTo(e.pageX||e.clientX,e.pageY||e.clientY),this._stage._canvasTransform.invertTransformPoint(Ya),$a.mouseX=Ya.x,$a.mouseY=Ya.y;let s=Ya.x/this._stage.clientScaleX,a=Ya.y/this._stage.clientScaleY;if(r.event.nativeEvent=e,3!=t&&$a.mouseEventsEnabled){r.target=this._touchTarget=this.getNodeUnderPoint(s,a);let e=Math.round(s),t=Math.round(a);if((e!=r.pos.x||t!=r.pos.y)&&($a.lastMouseTime=i,r.pos.setTo(e,t),r.move(),$a.mouseEventsEnabled)){r.bubble(c.MOUSE_MOVE);for(let e of r.downTargets)if(r.event._stopped=!1,e.event(c.MOUSE_DRAG,r.event),r.event._stopped)break}}else r.target=this._touchTarget=null;if(r.lastRollOver!=r.target&&this.handleRollOver(r),0==t)r.began||(r.begin(),this._touches[0]=r,r.event.button=e.button,r.downButton=e.button,this.handleFocus(),$a.onMouseDownCapture.invoke(r.touchId),$a.mouseEventsEnabled&&(0==e.button?r.bubble(c.MOUSE_DOWN):r.bubble(c.RIGHT_MOUSE_DOWN)));else if(1==t){if(r.began&&e.button==r.downButton){if(r.end(),this._touches.length=0,r.event.button=e.button,$a.mouseEventsEnabled){if(0==e.button?r.bubble(c.MOUSE_UP):r.bubble(c.RIGHT_MOUSE_UP),r.moved)for(let e of r.downTargets)e.event(c.MOUSE_DRAG_END,r.event);let t=r.clickTest();t&&(0==e.button?(r.event.isDblClick=2==r.clickCount,r.bubble(c.CLICK,t),2==r.clickCount&&r.bubble(c.DOUBLE_CLICK,t),r.event.isDblClick=!1):(r.event.isDblClick=2==r.clickCount,r.bubble(c.RIGHT_CLICK,t),r.event.isDblClick=!1))}r.event.button=0}}else 4==t&&$a.mouseEventsEnabled&&(r.event.delta=.025*e.deltaY,r.bubble(c.MOUSE_WHEEL),r.event.delta=0)}handleTouch(e,t){this._eventType=t,this._nativeEvent=e,this._lastTouchTime=I.now();let i=e.changedTouches;for(let r=0;r<i.length;++r){let s=i[r];if(!$a.multiTouchEnabled&&this._touches.length>0&&this._touches[0].touchId!=s.identifier)continue;Ya.setTo(s.pageX,s.pageY),this._stage._canvasTransform.invertTransformPoint(Ya),$a.mouseX=Ya.x,$a.mouseY=Ya.y;let a=Ya.x/this._stage.clientScaleX,n=Ya.y/this._stage.clientScaleY,o=this.getTouch(s.identifier,0==t);if(o){if(o.event.nativeEvent=e,o.event.touchId=o.touchId,$a.lastTouchId=o.touchId,3!=t&&$a.mouseEventsEnabled){o.target=this._touchTarget=this.getNodeUnderPoint(a,n),$a.lastMouseTime=this._lastTouchTime;let e=Math.round(a),i=Math.round(n);if((Math.abs(e-o.pos.x)>1.5||Math.abs(i-o.pos.y)>1.5)&&(o.pos.setTo(e,i),2==t&&(o.move(),$a.mouseEventsEnabled))){o.bubble(c.MOUSE_MOVE);for(let e of o.downTargets)if(o.event._stopped=!1,e.event(c.MOUSE_DRAG,o.event),o.event._stopped)break}}else o.target=this._touchTarget=null;if(o.lastRollOver!=o.target&&this.handleRollOver(o),0==t)o.began||(o.begin(),this.handleFocus(),$a.onMouseDownCapture.invoke(o.touchId),$a.mouseEventsEnabled&&o.bubble(c.MOUSE_DOWN));else if(1==t||3==t){if(o.began){if(o.end(),$a.mouseEventsEnabled){if(o.bubble(c.MOUSE_UP),o.moved)for(let e of o.downTargets)e.event(c.MOUSE_DRAG_END,o.event);if(3!=t){let e=o.clickTest();null!=e&&(o.event.isDblClick=2==o.clickCount,o.bubble(c.CLICK,e),2==o.clickCount&&o.bubble(c.DOUBLE_CLICK,e),o.event.isDblClick=!1)}}o.target=null,this.handleRollOver(o)}o.reset(),this._touches.splice(this._touches.indexOf(o),1),this._touchPool.push(o)}}}}getTouch(e,t){let i=this._touches.find((t=>t.touchId==e));return i||!t||(i=this._touchPool.length>0?this._touchPool.pop():new Za(this._touches),i.touchId=e,this._touches.push(i)),i}handleFocus(){if(!Ha.isInputting)return;let e,t,i=this._stage.focus;i&&!i.contains(this._touchTarget)&&(e=i instanceof Ha?i:i.children.find((e=>e instanceof Ha)),e&&e.focus&&(t=this._touchTarget instanceof Ha?this._touchTarget:this._touchTarget.children.find((e=>e instanceof Ha)),t&&t.nativeInput&&t.multiline==e.multiline?e._focusOut():e.focus=!1))}handleKeys(e){let t=e.type,i=e.keyCode;if("keydown"===t?(0!=i&&this._pressKeys.add(i),this._pressKeys.add(e.key)):"keyup"===t&&(0!=i&&this._pressKeys.delete(i),this._pressKeys.delete(e.key)),this._keyEvent.nativeEvent=e,this._keyEvent._defaultPrevented=!1,$a.keyEventsEnabled){let e=this._stage.focus&&this._stage.focus.displayedInStage?this._stage.focus:this._stage,i=e;for(;i;)i.event(t,this._keyEvent.setTo(t,i,e)),i=i._parent}this._keyEvent._defaultPrevented&&e.preventDefault(),this._keyEvent.nativeEvent=null}getNodeUnderPoint(e,t){let i=this.getSpriteUnderPoint(this._stage,e,t);return i||(i=this.getSprite3DUnderPoint(e,t)),i||this._stage}getSpriteUnderPoint(e,t,i){e._getBit(ke.AREA_2D)&&(e.transformPoint(t,i,d.TEMP),t=d.TEMP.x,i=d.TEMP.y);let r=e._scrollRect;if(r&&!e._getBit(ke.DISABLE_INNER_CLIPPING)&&(Xa.setTo(r.x,r.y,r.width,r.height),!Xa.contains(t,i)))return null;let s=e._getBit(ke.EDITING_NODE);if(!s&&e.hitTestPrior&&!e.mouseThrough&&e!=this._stage&&!this.hitTest(e,t,i))return null;for(let r=e._children.length-1;r>-1;r--){let a=e._children[r],n=s||a._getBit(ke.EDITING_NODE);if(!a._destroyed&&1!==a._nodeType&&(n?(!a.hasHideFlag(Ge.HideInHierarchy)||a.mouseThrough)&&!a._getBit(ke.HIDE_BY_EDITOR):2===a._mouseState||0===a._mouseState&&a._getBit(ke.CHECK_INPUT))&&a._getBit(ke.ACTUAL_VISIBLE)){Ya.setTo(t,i),a.fromParentPoint(Ya);let e=this.getSpriteUnderPoint(a,Ya.x,Ya.y);if(e)return e}}if(s){if(!e._getBit(ke.LOCK_BY_EDITOR)&&!e.hasHideFlag(Ge.HideInHierarchy)&&this.hitTest(e,t,i,s))return e}else if(e!=this._stage&&(e.hitTestPrior&&!e.mouseThrough||this.hitTest(e,t,i)))return e;return null}getSprite3DUnderPoint(e,t){return null}hitTest(e,t,i,r){let s=!1;e._scrollRect&&(t-=e._scrollRect.x,i-=e._scrollRect.y);let a=e._hitArea,n=e.mouseThrough;return r&&(a=null,n=!1),a?a.contains(t,i,e):((e.width>0&&e.height>0||n||a)&&(s=n?e.getGraphicBounds(!1,G.TEMP).contains(t,i):(a||Xa.setTo(0,0,e.width,e.height)).contains(t,i,e)),s)}handleRollOver(e){if(!$a.mouseEventsEnabled)return void(e.lastRollOver=e.target);qa.length=0,ja.length=0;let t=e.lastRollOver;for(;t;)ja.push(t),t=t._parent;for(e.lastRollOver=e.target,t=e.target;t;){let e=ja.indexOf(t);if(-1!=e){ja.splice(e,ja.length-e);break}qa.push(t),t=t._parent}let i=ja.length;if(i>0){for(let r=0;r<i;r++)t=ja[r],t._destroyed||t.event(c.MOUSE_OUT,e.event.setTo(c.MOUSE_OUT,t,t));ja.length=0}if(i=qa.length,i>0){for(let r=0;r<i;r++)t=qa[r],t.activeInHierarchy&&t.event(c.MOUSE_OVER,e.event.setTo(c.MOUSE_OVER,t,t));qa.length=0}}}$a.multiTouchEnabled=!0,$a.mouseEventsEnabled=!0,$a.keyEventsEnabled=!0,$a.clickTestThreshold=10,$a.mouseX=0,$a.mouseY=0,$a.lastMouseTime=0,$a.lastTouchId=0,$a.onMouseDownCapture=new v;const Qa={};class Za{constructor(e){this.downPos=new d,this.downTargets=[],this.bubbleChain=[],this.event=new c,this.event._touches=e,this.pos=this.event.touchPos,this.touchId=0,this.reset()}begin(){if(this.began=!0,this.clickCancelled=!1,this.moved=!1,this.downPos.copy(this.pos),this.downTargets.length=0,this.target){let e=this.target;for(;e;)this.downTargets.push(e),e=e._parent}}move(){this.moved=!0;let e=Math.abs(this.pos.x-this.downPos.x)*h.stage._canvasTransform.getScaleX(),t=Math.abs(this.pos.y-this.downPos.y)*h.stage._canvasTransform.getScaleY();(e>$a.clickTestThreshold||t>$a.clickTestThreshold)&&(this.clickCancelled=!0)}end(){this.began=!1;let e=performance.now(),t=Qa[this.touchId];t||(t={pos:new d,time:0,button:0},Qa[this.touchId]=t),0==this.downTargets.length||this.clickCancelled||Math.abs(this.pos.x-this.downPos.x)>$a.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>$a.clickTestThreshold?(this.clickCancelled=!0,t.time=0,this.clickCount=1):(e-t.time<350&&Math.abs(this.pos.x-t.pos.x)<$a.clickTestThreshold&&Math.abs(this.pos.y-t.pos.y)<$a.clickTestThreshold&&t.button==this.event.button?this.clickCount=2:this.clickCount=1,t.time=e,t.pos.copy(this.pos),t.button=this.event.button)}clickTest(){if(this.clickCancelled)return this.downTargets.length=0,null;let e=this.downTargets[0];if(e.activeInHierarchy)return this.downTargets.length=0,e;for(e=this.target;e;){if(-1!=this.downTargets.indexOf(e)&&e.activeInHierarchy)break;e=e._parent}return this.downTargets.length=0,e}reset(){this.pos.setTo(0,0),this.touchId=0,this.clickCount=0,this.began=!1,this.moved=!1,this.target=null,this.downTargets.length=0,this.lastRollOver=null,this.clickCancelled=!1,this.downButton=0}bubble(e,t){let i=this.bubbleChain;i.length=0;let r=t=t||this.target||h.stage;for(;r;)r.activeInHierarchy&&i.push(r),r=r._parent;let s=this.event;s._stopped=!1;for(let r of i)if(s.setTo(e,r,t),r.event(e,s),s._stopped){if(e===c.MOUSE_DOWN||e===c.RIGHT_MOUSE_DOWN){let e=this.downTargets.indexOf(r);-1!=e&&this.downTargets.splice(e+1,this.downTargets.length-e-1)}break}if(e===c.MOUSE_UP||e===c.RIGHT_MOUSE_UP)for(let r of this.downTargets)if(r&&-1==i.indexOf(r)&&(s.setTo(e,r,t),r.event(e,s),s&&s._stopped))break}}class Ja extends ua{constructor(){super(),this._setBit(ke.AREA_2D,!0)}get mainCamera(){return this._mainCamera}_setMainCamera(e){e!=this._mainCamera&&(this._mainCamera&&(this._mainCamera._isMain=!1),this._mainCamera=e,this._mainCamera&&(this._mainCamera._isMain=!0))}_preRenderUpdate(e){let t=this._scene.sceneShaderData;this._mainCamera&&(e.drawLeftData(),t&&(t.addDefine(sn.SHADERDEFINE_CAMERA2D),t.setMatrix3x3(sn.VIEW2D,this._mainCamera._getCameraTransform())))}render(e,t,i){if(this._preRenderUpdate(e),this._scene._curCamera=this.mainCamera,super.render(e,t,i),this._mainCamera){let t=this._scene.sceneShaderData;e.drawLeftData(),t&&t.removeDefine(sn.SHADERDEFINE_CAMERA2D)}this._scene._curCamera=null}_setBelongScene(e){super._setBelongScene(e),this._scene._area2Ds.push(this)}_setUnBelongScene(){let e=this._scene._area2Ds,t=e.indexOf(this);-1!=t&&e.splice(t,1),super._setUnBelongScene()}transformPoint(e,t,i){return(i=i||new d).setTo(e,t),this._mainCamera?(this.localToGlobal(i),this.mainCamera.localToGlobal(i),i.x-=.5*_t.width,i.y-=.5*_t.height,this.globalToLocal(i),i):i}}class en extends ta{constructor(){super(),this._top=null,this._bottom=null,this._left=null,this._right=null,this._centerX=null,this._centerY=null,this.runInEditor=!0,this.hideFlags|=Ge.HideAndDontSave}onReset(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=null}_onEnable(){this.owner.parent?this._onAdded():this.owner.once(c.ADDED,this,this._onAdded)}_onDisable(){this.owner.off(c.ADDED,this,this._onAdded),this.owner.parent&&this.owner.parent.off(c.RESIZE,this,this._onParentResize)}_onAdded(){this.owner.parent&&this.owner.parent.on(c.RESIZE,this,this._onParentResize),this.resetLayoutX(),this.resetLayoutY()}_onParentResize(){var e=this.resetLayoutX(),t=this.resetLayoutY();(e||t)&&this.owner.event(c.RESIZE)}resetLayoutX(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerX)e.x=Math.round(.5*(t.width-e.displayWidth)+this._centerX+e.pivotX*e.scaleX);else if(null!=this._left){if(e.x=Math.round(this._left+e.pivotX*e.scaleX),null!=this._right){if(!t._width)return!1;var i=(t._width-this._left-this._right)/(e.scaleX||.01);if(i!=e._width)return e.width=i,!0}}else null!=this._right&&(e.x=Math.round(t.width-e.displayWidth-this._right+e.pivotX*e.scaleX));return!1}resetLayoutY(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerY)e.y=Math.round(.5*(t.height-e.displayHeight)+this._centerY+e.pivotY*e.scaleY);else if(null!=this._top){if(e.y=Math.round(this._top+e.pivotY*e.scaleY),null!=this._bottom){if(!t._height)return!1;var i=(t._height-this._top-this._bottom)/(e.scaleY||.01);if(i!=e._height)return e.height=i,!0}}else null!=this._bottom&&(e.y=Math.round(t.height-e.displayHeight-this._bottom+e.pivotY*e.scaleY));return!1}resetLayout(){this.owner&&(this.resetLayoutX(),this.resetLayoutY())}get top(){return this._top}set top(e){isNaN(e)&&(e=null),this._top!=e&&(this._top=e,this.resetLayoutY())}get bottom(){return this._bottom}set bottom(e){isNaN(e)&&(e=null),this._bottom!=e&&(this._bottom=e,this.resetLayoutY())}get left(){return this._left}set left(e){isNaN(e)&&(e=null),this._left!=e&&(this._left=e,this.resetLayoutX())}get right(){return this._right}set right(e){isNaN(e)&&(e=null),this._right!=e&&(this._right=e,this.resetLayoutX())}get centerX(){return this._centerX}set centerX(e){isNaN(e)&&(e=null),this._centerX!=e&&(this._centerX=e,this.resetLayoutX())}get centerY(){return this._centerY}set centerY(e){isNaN(e)&&(e=null),this._centerY!=e&&(this._centerY=e,this.resetLayoutY())}}en.EMPTY=null,en.EMPTY=new en;class tn{constructor(){this.componentElementMap=new Map,this._shaderData=g.renderDeviceFactory.createShaderData(null)}}class rn extends ua{static regManager(e,t){rn.componentManagerMap.set(e,t)}constructor(){super(),this.autoDestroyAtClosed=!1,this._area2Ds=[],this._componentElementDatasMap={},this._specialManager=new tn,this._timer=h.timer,this._widget=en.EMPTY,this._scene=this,rn.componentManagerMap.forEach(((e,t)=>{this._specialManager.componentElementMap.set(t,new e(this))}))}set componentElementDatasMap(e){this._componentElementDatasMap=e,this._specialManager.componentElementMap.forEach(((e,t)=>{e.Init(this._componentElementDatasMap[t])}))}get componentElementDatasMap(){return this._componentElementDatasMap}_update(){var e=.001*h.timer.delta;this._specialManager.componentElementMap.forEach((t=>{t.update(e)}))}getComponentElementManager(e){return this._specialManager.componentElementMap.get(e)}getNodeByID(e){return this._idMap?this._idMap[e]:null}open(e=!0,t=null){e&&rn.closeAll(),rn.root.addChild(this),this._scene3D&&h.stage.addChildAt(this._scene3D,0),this.onOpened(t)}onOpened(e){}close(e=null){this.onClosed(e),this.autoDestroyAtClosed?(this.destroy(),this._scene3D&&this._scene3D.destroy()):(this.removeSelf(),this._scene3D&&this._scene3D.removeSelf())}onClosed(e=null){}destroy(e=!0){super.destroy(e),this._scene3D&&(this._scene3D.destroy(),this._scene3D=null),this._idMap=null,rn.unDestroyedScenes.delete(this)}get timer(){return this._timer}set timer(e){this._timer=e}get scene3D(){return this._scene3D}get top(){return this._widget.top}set top(e){e!=this._widget.top&&(this._getWidget().top=e)}get bottom(){return this._widget.bottom}set bottom(e){e!=this._widget.bottom&&(this._getWidget().bottom=e)}get left(){return this._widget.left}set left(e){e!=this._widget.left&&(this._getWidget().left=e)}get right(){return this._widget.right}set right(e){e!=this._widget.right&&(this._getWidget().right=e)}get centerX(){return this._widget.centerX}set centerX(e){e!=this._widget.centerX&&(this._getWidget().centerX=e)}get centerY(){return this._widget.centerY}set centerY(e){e!=this._widget.centerY&&(this._getWidget().centerY=e)}render(e,t,i){this._preRenderUpdate(e,t,i),super.render(e,t,i),this._recoverRenderSceneState(e)}get sceneShaderData(){return this._specialManager._shaderData}_preRenderUpdate(e,t,i){mt.rendercontext2D.sceneData=this._specialManager._shaderData,this._light2DManager&&this._light2DManager.preRenderUpdate(e)}_recoverRenderSceneState(e){e.drawLeftData(),mt.rendercontext2D.sceneData=null}_transChanged(t){super._transChanged(t),0!=(t&e.TransformKind.Layout)&&this.callLater(this._sizeChanged)}_sizeChanged(){this.event(c.RESIZE),this._widget!==en.EMPTY&&this._widget.resetLayout()}_onAdded(){super._onAdded(),p.isPlaying&&h.stage._scene2Ds.push(this)}_onRemoved(){if(super._onRemoved(),p.isPlaying){let e=h.stage._scene2Ds.indexOf(this);h.stage._scene2Ds.splice(e,1)}}freshLayout(){this._widget!=en.EMPTY&&this._widget.resetLayout()}_getWidget(){return this._widget===en.EMPTY&&(this._widget=this.addComponent(en)),this._widget}static get root(){let e=rn._root;return e||(e=rn._root=h.stage.addChild(new ua),e.name="root",e.mouseThrough=!0,h.stage.on("resize",null,(()=>{e.size(h.stage.width,h.stage.height),e.event(c.RESIZE)})),e.size(h.stage.width,h.stage.height),e.event(c.RESIZE)),e}static load(e,t=null,i=null){return h.loader.load(e,null,(e=>{rn._loadPage&&rn._loadPage.event("progress",e),i&&i.runWith(e)})).then((i=>{if(!i)throw"Can not find scene:"+e;let r,s=[],a=i.create(null,s);if(s.length>0&&console.warn(`Error loading ${e}: \n${s.join("\n")}`),a instanceof rn)r=a;else{if(1!==a._nodeType)throw"Not a scene:"+e;r=new rn,r.left=r.right=r.top=r.bottom=0,r._scene3D=a}return r._scene3D&&(r._scene3D._scene2D=r),rn.unDestroyedScenes.add(r),rn.hideLoadingPage(),t&&t.runWith(r),r}))}static open(e,t=!0,i=null,r=null,s=null){if(i instanceof Se){var a=r;r=i,i=a}return rn.showLoadingPage(),rn.load(e,Se.create(null,this._onSceneLoaded,[t,r,i]),s)}static _onSceneLoaded(e,t,i,r){r.open(e,i),t&&t.runWith(r)}static close(e,t){let i=!1;for(let r of rn.unDestroyedScenes)if(r&&r.parent&&r.url===e&&(null==t||r.name==t)){r.close(),i=!0;break}return i}static closeAll(){let e=rn.root;for(let i=0,r=e.numChildren;i<r;i++){var t=e.getChildAt(0);t instanceof rn?t.close():t.removeSelf()}}static destroy(e,t){let i=!1;for(let r of rn.unDestroyedScenes)if(r.url===e&&(null==t||r.name==t)&&!r._destroyed){r.destroy(),i=!0;break}return i}static gc(){A.destroyUnusedResources()}static setLoadingPage(e){rn._loadPage=e}static showLoadingPage(e=null,t=500){rn._loadPage&&(h.systemTimer.clear(null,rn._showLoading),h.systemTimer.clear(null,rn._hideLoading),h.systemTimer.once(t,null,rn._showLoading,[e],!1))}static _showLoading(e){h.stage.addChild(rn._loadPage),rn._loadPage instanceof rn&&rn._loadPage.onOpened(e)}static _hideLoading(){rn._loadPage instanceof rn?rn._loadPage.close():rn._loadPage.removeSelf()}static hideLoadingPage(e=500){rn._loadPage&&(h.systemTimer.clear(null,rn._showLoading),h.systemTimer.clear(null,rn._hideLoading),h.systemTimer.once(e,null,rn._hideLoading))}}rn.unDestroyedScenes=new Set,rn.componentManagerMap=new Map;class sn extends ua{static shaderValueInit(){rn.scene2DUniformMap||(rn.scene2DUniformMap=g.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal"));let t=rn.scene2DUniformMap;sn.VIEW2D=gi.propertyNameToID("u_view2D"),t.addShaderUniform(sn.VIEW2D,"u_view2D",e.ShaderDataType.Matrix3x3),sn.SHADERDEFINE_CAMERA2D=gi.getDefineByName("CAMERA2D")}get ignoreRotation(){return this._ignoreRotation}set ignoreRotation(e){this._ignoreRotation=e}get isMain(){return this._isMain}set isMain(e){this._ownerArea&&(e?(this._ownerArea._setMainCamera(this),this._isMain=!0):this._ownerArea.mainCamera==this&&(this._ownerArea._setMainCamera(null),this._isMain=!1)),this._isMain=e}_setUnBelongScene(){null!=this._ownerArea&&(this._ownerArea.mainCamera==this&&this._ownerArea._setMainCamera(null),this._ownerArea=null),super._setUnBelongScene()}_setBelongScene(e){super._setBelongScene(e),this._findOwnerArea()}_findOwnerArea(){let e=this;for(;e&&e!==this._scene&&e!==h.stage;){if(e instanceof Ja){this._ownerArea=e,this._isMain&&!this._ownerArea.mainCamera&&this._ownerArea._setMainCamera(this);break}e=e._parent}null==this._ownerArea&&console.warn("Camera2D must be a descendant of Area2D")}get limit_Left(){return this._limit_Left}set limit_Left(e){this._limit_Left=e}get limit_Right(){return this._limit_Right}set limit_Right(e){this._limit_Right=e}get limit_Bottom(){return this._limit_Bottom}set limit_Bottom(e){this._limit_Bottom=e}get limit_Top(){return this._limit_Top}set limit_Top(e){this._limit_Top=e}get positionSmooth(){return this._positionSmooth}set positionSmooth(e){this._positionSmooth=e}get positionSpeed(){return this._positionSpeed}set positionSpeed(e){this._positionSpeed=e}get dragHorizontalEnable(){return this._dragHorizontalEnable}set dragHorizontalEnable(e){this._dragHorizontalEnable=e}get dragVerticalEnable(){return this._dragVerticalEnable}set dragVerticalEnable(e){this._dragVerticalEnable=e}get drag_Left(){return this._drag_Left}set drag_Left(e){this._drag_Left=e}get drag_Right(){return this._drag_Right}set drag_Right(e){this._drag_Right=e}get drag_Top(){return this._drag_Top}set drag_Top(e){this._drag_Top=e}get drag_Bottom(){return this._drag_Bottom}set drag_Bottom(e){this._drag_Bottom=e}getCameraPos(){return this._cameraPos}constructor(){super(),this._cameraPos=new Gt,this._cameraSmoothPos=new Gt,this._firstUpdate=!0,this._cameraMatrix=new zt,this._cameraInvertMatrix=new zt,this._ignoreRotation=!0,this._viewRect=new Gt,this.limit_Left=-1e7,this.limit_Right=1e7,this.limit_Top=-1e7,this.limit_Bottom=1e7,this.drag_Left=.2,this.drag_Right=.2,this.drag_Top=.2,this.drag_Bottom=.2,this.positionSmooth=!1,this._rect=new s}_getScreenSize(){return this._viewRect.setValue(_t.width,_t.height),this._viewRect}_getCameraTransform(){let e=this._getScreenSize(),t=d.TEMP;this.globalTrans.getScenePos(t);let i=.5*e.x,r=.5*e.y;if(this._firstUpdate)this._cameraSmoothPos.x=this._cameraPos.x=t.x,this._cameraSmoothPos.y=this._cameraPos.y=t.y,this._firstUpdate=!1;else{this.dragHorizontalEnable?(this._cameraPos.x=Math.min(this._cameraPos.x,t.x+i*this.drag_Left),this._cameraPos.x=Math.max(this._cameraPos.x,t.x-i*this.drag_Right)):this._cameraPos.x=t.x,this.dragVerticalEnable?(this._cameraPos.y=Math.min(this._cameraPos.y,t.y+r*this.drag_Top),this._cameraPos.y=Math.max(this._cameraPos.y,t.y-r*this.drag_Bottom)):this._cameraPos.y=t.y;let s=this._cameraPos.x-i,a=s+e.x,n=this._cameraPos.y-r,o=n+e.y;if(s<this.limit_Left&&(this._cameraPos.x-=s-this.limit_Left),a>this.limit_Right&&(this._cameraPos.x-=a-this.limit_Right),o>this.limit_Bottom&&(this._cameraPos.y-=o-this.limit_Bottom),n<this.limit_Top&&(this._cameraPos.y-=n-this.limit_Top),this.positionSmooth){let e=Math.min(1,.16*this.positionSpeed),t=Math.floor((this._cameraPos.x-this._cameraSmoothPos.x)*e),i=Math.floor((this._cameraPos.y-this._cameraSmoothPos.y)*e);this._cameraSmoothPos.x+=t,this._cameraSmoothPos.y+=i}else this._cameraSmoothPos.x=this._cameraPos.x,this._cameraSmoothPos.y=this._cameraPos.y}return this.ignoreRotation?this._cameraRotation=0:this.rotationSmooth||(this._cameraRotation=this.globalTrans.rotation),this._rect.setValue(this._cameraSmoothPos.x-i,this._cameraSmoothPos.x+i,this._cameraSmoothPos.y-r,this._cameraSmoothPos.y+r),zt.createMatrixFromValue(this._cameraSmoothPos,this._cameraRotation*Math.PI/180,Gt.ONE,this._cameraMatrix),this._cameraMatrix.invert(this._cameraInvertMatrix),this._cameraInvertMatrix}}class an extends M{static get defaultTexture(){return this._defaultTexture}static __init__(){g.renderEngine.getCapable(e.RenderCapable.Texture3D)&&(this._defaultTexture=new an(1,1,1,e.TextureFormat.R8G8B8A8,!1,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255]),!1,!1))}constructor(t,i,r,s,a=!0,n,o=!1){super(t,i,s),this._dimension=e.TextureDimension.Texture2DArray,this._gammaSpace=o,this.depth=r;let h=g.textureContext;this._texture=h.createTexture3DInternal(this._dimension,t,i,r,s,a,o,!1)}setImageData(e,t,i){let r=this._texture;g.textureContext.setTexture3DImageData(r,e,this.depth,t,i)}setPixelsData(e,t,i){let r=this._texture;g.textureContext.setTexture3DPixelsData(r,e,this.depth,t,i)}setSubPixelsData(e,t,i,r,s,a,n,o,h,l,u){let d=this._texture;g.textureContext.setTexture3DSubPixelsData(d,n,o,h,e,t,i,r,s,a,l,u)}}var nn;e.TextureCubeFace=void 0,(nn=e.TextureCubeFace||(e.TextureCubeFace={}))[nn.PositiveX=0]="PositiveX",nn[nn.NegativeX=1]="NegativeX",nn[nn.PositiveY=2]="PositiveY",nn[nn.NegativeY=3]="NegativeY",nn[nn.PositiveZ=4]="PositiveZ",nn[nn.NegativeZ=5]="NegativeZ";const on=new Uint8Array(4);class hn extends M{static get blackTexture(){return hn._blackTexture}static get grayTexture(){return hn._grayTexture}static get whiteTexture(){return hn._whiteTexture}static get errorTexture(){return hn._errorTexture}static __init__(){var t=new hn(1,e.TextureFormat.R8G8B8A8,!1),i=new hn(1,e.TextureFormat.R8G8B8A8,!1),r=new hn(1,e.TextureFormat.R8G8B8A8,!1),s=on;s[0]=0,s[1]=0,s[2]=0,s[3]=255,t.setPixelsData([s,s,s,s,s,s],!1,!1),t.lock=!0,s[0]=128,s[1]=128,s[2]=128,s[3]=255,i.setPixelsData([s,s,s,s,s,s],!1,!1),i.lock=!0,s[0]=255,s[1]=255,s[2]=255,s[3]=255,r.setPixelsData([s,s,s,s,s,s],!1,!1),r.lock=!0,hn._grayTexture=i,hn._blackTexture=t,hn._whiteTexture=r,hn._errorTexture=r}constructor(t,i,r=!0,s=!1,a=!1){super(t,t,i),this._dimension=e.TextureDimension.Cube,this._texture=g.textureContext.createTextureInternal(this._dimension,t,t,i,r,s,a)}setImageData(e,t,i){let r=!1,s=e.findIndex((e=>null!=e));if(-1!=s){let t=e[s];e.every((e=>null!=e&&e.width==t.width&&e.height==t.height))||(r=!0)}else r=!0;let a=this._texture;if(r){let e=on;g.textureContext.setCubePixelsData(a,[e,e,e,e,e,e],t,i)}else g.textureContext.setCubeImageData(a,e,t,i)}setPixelsData(e,t,i){let r=this._texture;g.textureContext.setCubePixelsData(r,e,t,i)}updateSubPixelsData(e,t,i,r,s,a,n,o,h){let l=this._texture;g.textureContext.setCubeSubPixelData(l,e,a,n,t,i,r,s,o,h)}setDDSData(e){let t=this._texture;g.textureContext.setCubeDDSData(t,e)}setKTXData(e){let t=this._texture;g.textureContext.setCubeKTXData(t,e)}get defaultTexture(){return hn.grayTexture}}class ln{static customRequestAnimationFrame(e,t){ln._customRequestAnimationFrame=e,ln._loopFunction=t}static set customRenderEngine(e){ln._customEngine=e}static get customRenderEngine(){return ln._customEngine}static gc(){p.isConch&&window.gc({type:"major",execution:"async"})}constructor(e,i,r){this._first=!0,this._startTm=0,this._timeId=0,ln._Render=this,ln._mainCanvas=r;let s=ln._mainCanvas.source;s.id="layaCanvas",s.width=e,s.height=i,p.isConch&&(document.body.appendChild(s),ln._mainCanvas.getContext("2d")),this.initRender(ln._mainCanvas,e,i),t._enableWindowRAFFunction?window.requestAnimationFrame(l):requestAnimationFrame(l);let a=this;performance.now();let n=t.FPS,o=ln.ifps=1e3/n;function l(e){performance.now(),a._first&&(a._startTm=Math.floor(e/o)*o,a._first=!1),e-=a._startTm;let i=Math.floor(e/o);(i-ln.lastFrm>0||!t.fixedFrames)&&(ln.lastFrm=i,h.stage._loop()),ln._customRequestAnimationFrame&&ln._loopFunction?ln._customRequestAnimationFrame(ln._loopFunction):t._enableWindowRAFFunction?window.requestAnimationFrame(l):requestAnimationFrame(l)}h.stage.on("visibilitychange",this,this._onVisibilitychange),p.isConch&&h.timer.frameOnce(2,null,ln.gc)}_onVisibilitychange(){h.stage.isVisibility?0!=this._timeId&&window.clearInterval(this._timeId):this._timeId=window.setInterval(un,1e3)}static vsyncTime(){return ln.lastFrm*ln.ifps}initRender(e,t,i){e.size(t,i),ki.__init__(),xr.__init__();var r=new xr;return r.isMain=!0,ln._context=r,e._setContext(r),Ui.__init__(),Ri._init_(),_e.__init__(),hn.__init__(),an.__init__(),X.__init__(),sn.shaderValueInit(),aa.initBaseRender2DCommandEncoder(),!0}static get context(){return ln._context}static get canvas(){return ln._mainCanvas.source}}function un(){h.stage._loop()}ln.lastFrm=0,ln.ifps=1e3/60;class dn{constructor(){this._onUpdates=new Set,this._onLateUpdates=new Set,this._onPreRenders=new Set,this._onPostRenders=new Set,this._toStarts=new Set,this._toDestroys=new Set}callStart(){for(let e of this._toStarts)if(2==e._status){e._status=3;try{e.onStart()}catch(e){this.onError(e)}}this._toStarts.clear()}callUpdate(){for(let e of this._onUpdates)if(3==e._status)try{e.onUpdate()}catch(e){this.onError(e)}}callLateUpdate(){for(let e of this._onLateUpdates)if(3==e._status)try{e.onLateUpdate()}catch(e){this.onError(e)}}callPreRender(){for(let e of this._onPreRenders)if(3==e._status)try{e.onPreRender()}catch(e){this.onError(e)}}callPostRender(){for(let e of this._onPostRenders)if(3==e._status)try{e.onPostRender()}catch(e){this.onError(e)}}callDestroy(){for(let e of this._toDestroys)try{e._destroy(!0)}catch(e){this.onError(e)}this._toDestroys.clear()}add(e){1==e._status&&(e.onStart?(e._status=2,this._toStarts.add(e)):e._status=3),e.onUpdate&&this._onUpdates.add(e),e.onLateUpdate&&this._onLateUpdates.add(e),e.onPreRender&&this._onPreRenders.add(e),e.onPostRender&&this._onPostRenders.add(e)}remove(e){2==e._status&&(e._status=1),e.onUpdate&&this._onUpdates.delete(e),e.onLateUpdate&&this._onLateUpdates.delete(e),e.onPreRender&&this._onPreRenders.delete(e),e.onPostRender&&this._onPostRenders.delete(e)}destroy(){}onError(e){console.error(e)}}class cn{constructor(e=!0){this.scale=1,this.currFrame=0,this.delta=0,this.unscaledDelta=0,this._map={},this._handlers=[],this._temp=[],this._count=0,e&&cn.gSysTimer&&cn.gSysTimer.frameLoop(1,this,this._update),this.currTimer=Date.now(),this._lastTimer=Date.now()}get totalTime(){return this._lastTimer}_update(){if(this.scale<=0)return this._lastTimer=Date.now(),void(this.delta=0);let e=this.currFrame=this.currFrame+this.scale,t=Date.now();this.unscaledDelta=t-this._lastTimer;let i=this.unscaledDelta>3e4;this.delta=this.unscaledDelta*this.scale;let r=this.currTimer=this.currTimer+this.delta;this._lastTimer=t;let s=this._handlers;this._count=0;for(let t=0,a=s.length;t<a;t++){let a=s[t];if(!a.method){this._count++;continue}let n=a.userFrame?e:r;if(n>=a.exeTime)if(a.repeat)if(!a.jumpFrame||i)a.exeTime+=a.delay,a.run(!1),n>a.exeTime&&(a.exeTime+=Math.ceil((n-a.exeTime)/a.delay)*a.delay);else for(;n>=a.exeTime;)a.exeTime+=a.delay,a.run(!1);else a.run(!0)}(this._count>30||e%200==0)&&this._clearHandlers()}_clearHandlers(){let e=this._handlers;for(let t=0,i=e.length;t<i;t++){let i=e[t];null!==i.method?this._temp.push(i):(this._map[i.key]==i&&delete this._map[i.key],i.clear(),cn._pool.push(i))}this._handlers=this._temp,e.length=0,this._temp=e}_create(e,t,i,r,s,a,n){let o=O.getGID(r,s);if(null==n||n){let n=this._map[o];if(n)return n.repeat=t,n.userFrame=e,n.delay=i,n.caller=r,n.method=s,n.args=a,n.exeTime=i+(e?this.currFrame:this.currTimer+Date.now()-this._lastTimer),n}let h=cn._pool.length>0?cn._pool.pop():new _n;return h.key=o,h.repeat=t,h.userFrame=e,h.delay=i,h.caller=r,h.method=s,h.args=a,h.exeTime=i+(e?this.currFrame:this.currTimer+Date.now()-this._lastTimer),this._map[o]=h,this._handlers.push(h),h}once(e,t,i,r,s){this._create(!1,!1,e,t,i,r,s)}loop(e,t,i,r,s,a){let n=this._create(!1,!0,e,t,i,r,s);n&&(n.jumpFrame=a)}frameOnce(e,t,i,r,s){this._create(!0,!1,e,t,i,r,s)}frameLoop(e,t,i,r,s){this._create(!0,!0,e,t,i,r,s)}toString(){return" handlers:"+this._handlers.length+" pool:"+cn._pool.length}clear(e,t){let i=this._map[O.getGID(e,t)];i&&i.clear()}clearAll(e){if(e)for(let t=0,i=this._handlers.length;t<i;t++){let i=this._handlers[t];i.caller===e&&i.clear()}}callLater(e,t,i){cn.callLaters.once(0,e,t,i)}runCallLater(e,t,i){!cn.callLaters.runTimer(e,t)&&i&&t.apply(e)}clearCallLater(e,t){cn.callLaters.clear(e,t)}runTimer(e,t){let i=this._map[O.getGID(e,t)];return!(!i||null==i.method)&&(this._map[i.key]=null,i.run(!0),!0)}pause(){this.scale=0}resume(){this.scale=1}destroy(){for(let e=0,t=this._handlers.length;e<t;e++){this._handlers[e].clear()}this._handlers.length=0,this._map={},this._temp.length=0}}cn.gSysTimer=null,cn.callLaters=new cn(!1),cn._pool=[];class _n{clear(){this.caller=null,this.method=null,this.args=null}run(e){let t=this.caller;if(t&&t.destroyed)return this.clear();let i=this.method,r=this.args;e&&this.clear(),null!=i&&(r?i.apply(t,r):i.call(t))}}class pn extends ua{constructor(){super(),this.offset=new d,this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._canvasTransform=new V,this.useRetinalCanvas=!1,this._scene3Ds=[],this._scene2Ds=[],this._frameRate="fast",this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="gray",this._renderCount=0,this._safariOffsetY=0,this._frameStartTime=0,this._globalRepaintSet=!1,this._globalRepaintGet=!1,this._wgColor=new m(0,0,0,0),this._needUpdateCanvasSize=!1,this.mouseEnabled=!0,this.hitTestPrior=!0,this._setBit(ke.DISPLAYED_INSTAGE,!0),this._setBit(ke.ACTIVE_INHIERARCHY,!0),this._isFocused=!0,this._isVisibility=!0,this._transform=new V,this.useRetinalCanvas=!!p.isConch||t.useRetinalCanvas,this._previousOrientation=I.window.orientation;let e=I.window;e.addEventListener("focus",(()=>{this._isFocused=!0,this.event(c.FOCUS),this.event(c.FOCUS_CHANGE)})),e.addEventListener("blur",(()=>{this._isFocused=!1,this.event(c.BLUR),this.event(c.FOCUS_CHANGE),this._isInputting()&&(Ha.inputElement.target.focus=!1)}));var i="visibilityState",r="visibilitychange",s=e.document;void 0!==s.hidden?(r="visibilitychange",i="visibilityState"):void 0!==s.mozHidden?(r="mozvisibilitychange",i="mozVisibilityState"):void 0!==s.msHidden?(r="msvisibilitychange",i="msVisibilityState"):void 0!==s.webkitHidden&&(r="webkitvisibilitychange",i="webkitVisibilityState"),e.document.addEventListener(r,(()=>{"hidden"==I.document[i]?(this._isVisibility=!1,this._isInputting()&&(Ha.inputElement.target.focus=!1)):this._isVisibility=!0,this.renderingEnabled=this._isVisibility,this.event(c.VISIBILITY_CHANGE)})),e.addEventListener("resize",(()=>{var e=I.window.orientation;null!=e&&e!=this._previousOrientation&&this._isInputting()&&(Ha.inputElement.target.focus=!1),this._previousOrientation=e,this._isInputting()||(I.onSafari&&(this._safariOffsetY=I.getSafariToolbarOffset()),this.screenAdaptationEnabled&&(this.event(c.WILL_RESIZE),this.updateCanvasSize(!0)))})),e.addEventListener("orientationchange",(e=>{this.screenAdaptationEnabled&&(this.event(c.WILL_RESIZE),this.updateCanvasSize(!0))})),this._componentDriver=new dn}_isInputting(){return I.onMobile&&Ha.isInputting}_transChanged(t){super._transChanged(t),0!=(t&e.TransformKind.Size)&&(this.designWidth=this._width,this.designHeight=this._height,this.updateCanvasSize(!0))}measureWidth(){return this.needUpdateCanvasSize(),this._width}measureHeight(){return this.needUpdateCanvasSize(),this._height}get isFocused(){return this._isFocused}get isVisibility(){return this._isVisibility}updateCanvasSize(e){e?this._needUpdateCanvasSize||(this._needUpdateCanvasSize=!0,h.systemTimer.callLater(this,this.updateCanvasSize)):this.setScreenSize(I.clientWidth*I.pixelRatio,I.clientHeight*I.pixelRatio)}needUpdateCanvasSize(){this._needUpdateCanvasSize&&this.updateCanvasSize()}setScreenSize(e,t){var i;this._needUpdateCanvasSize=!1;var r=!1;if(this._screenMode!==pn.SCREEN_NONE&&(r=(e/t<1?pn.SCREEN_VERTICAL:pn.SCREEN_HORIZONTAL)!==this._screenMode)){var s=t;t=e,e=s}this.canvasRotation=r;var a=ln._mainCanvas,n=this._canvasTransform.identity(),o=this._scaleMode,h=e/this.designWidth,l=t/this.designHeight,u=this.useRetinalCanvas?e:this.designWidth,d=this.useRetinalCanvas?t:this.designHeight,_=e,p=t,m=I.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,o){case pn.SCALE_NOSCALE:h=l=1,_=this.designWidth,p=this.designHeight;break;case pn.SCALE_SHOWALL:h=l=Math.min(h,l),u=_=Math.round(this.designWidth*h),d=p=Math.round(this.designHeight*l);break;case pn.SCALE_NOBORDER:h=l=Math.max(h,l),_=Math.round(this.designWidth*h),p=Math.round(this.designHeight*l);break;case pn.SCALE_FULL:h=l=m,u=e,d=t,this._width=e/m,this._height=t/m;break;case pn.SCALE_FIXED_WIDTH:l=h,this._height=d=Math.round(t/h);break;case pn.SCALE_FIXED_HEIGHT:h=l,this._width=u=Math.round(e/l);break;case pn.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(l=h,this._height=d=Math.round(t/h)):(h=l,this._width=u=Math.round(e/l))}this.useRetinalCanvas&&(_=u=e,p=d=t),h*=this.scaleX,l*=this.scaleY,1===h&&1===l?this.transform.identity():(this.transform.a=this._formatData(h/(_/u)),this.transform.d=this._formatData(l/(p/d))),a.size(u,d),n.scale(_/u/m,p/d/m),this._alignH===pn.ALIGN_LEFT?this.offset.x=0:this._alignH===pn.ALIGN_RIGHT?this.offset.x=e-_:this.offset.x=.5*(e-_)/m,this._alignV===pn.ALIGN_TOP?this.offset.y=0:this._alignV===pn.ALIGN_BOTTOM?this.offset.y=t-p:this.offset.y=.5*(t-p)/m,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),n.translate(this.offset.x,this.offset.y),this._safariOffsetY&&n.translate(0,this._safariOffsetY),this.canvasDegree=0,r&&(this._screenMode===pn.SCREEN_HORIZONTAL?(n.rotate(Math.PI/2),n.translate(t/m,0),this.canvasDegree=90):(n.rotate(-Math.PI/2),n.translate(0,e/m),this.canvasDegree=-90)),n.a=this._formatData(n.a),n.d=this._formatData(n.d),n.tx=this._formatData(n.tx),n.ty=this._formatData(n.ty),this.transform=this.transform,pn._setStageStyle(a,u,d,n),this._safariOffsetY&&n.translate(0,-this._safariOffsetY),_t.width=u,_t.height=d,null===(i=window.Laya3D)||void 0===i||i._changeWebGLSize(u,d),g.renderEngine.resizeOffScreen(u,d),this.visible=!0,this.repaint(),this.event(c.RESIZE)}static _setStageStyle(e,t,i,r){var s=e.source.style;s.transformOrigin=s.webkitTransformOrigin=s.msTransformOrigin=s.mozTransformOrigin=s.oTransformOrigin="0px 0px 0px",s.transform=s.webkitTransform=s.msTransform=s.mozTransform=s.oTransform="matrix("+r.toString()+")",s.width=t,s.height=i,r.translate(parseInt(s.left)||0,parseInt(s.top)||0)}setScreenSizeForScene(e,t,i){var r=!1;if(i!==pn.SCREEN_NONE&&(r=(e/t<1?pn.SCREEN_VERTICAL:pn.SCREEN_HORIZONTAL)!==i)){var s=t;t=e,e=s}this.canvasRotation=r;var a=this._scaleMode,n=e/this.designWidth,o=t/this.designHeight,h=this.useRetinalCanvas?e:this.designWidth,l=this.useRetinalCanvas?t:this.designHeight,u=e,d=t;let c=this.designWidth,_=this.designHeight;switch(a){case pn.SCALE_NOSCALE:n=o=1,u=this.designWidth,d=this.designHeight;break;case pn.SCALE_SHOWALL:n=o=Math.min(n,o),h=u=Math.round(this.designWidth*n),l=d=Math.round(this.designHeight*o);break;case pn.SCALE_NOBORDER:n=o=Math.max(n,o),u=Math.round(this.designWidth*n),d=Math.round(this.designHeight*o);break;case pn.SCALE_FULL:n=o=1,c=h=e,_=l=t;break;case pn.SCALE_FIXED_WIDTH:o=n,_=l=Math.round(t/n);break;case pn.SCALE_FIXED_HEIGHT:n=o,c=h=Math.round(e/o);break;case pn.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(o=n,_=l=Math.round(t/n)):(n=o,c=h=Math.round(e/o))}return this.useRetinalCanvas&&(u=h=e,d=l=t),{stageWidth:c,stageHeight:_,canvasWidth:h,canvasHeight:l,scaleX:n/(u/h),scaleY:o/(d/l)}}_formatData(e){return Math.abs(e)<1e-6?0:Math.abs(1-e)<.001?e>0?1:-1:e}get scaleMode(){return this._scaleMode}set scaleMode(e){this._scaleMode=e,this.updateCanvasSize(!0)}get alignH(){return this.needUpdateCanvasSize(),this._alignH}set alignH(e){this._alignH=e,this.updateCanvasSize(!0)}get alignV(){return this.needUpdateCanvasSize(),this._alignV}set alignV(e){this._alignV=e,this.updateCanvasSize(!0)}get bgColor(){return this._bgColor}set bgColor(e){if(this._bgColor=e,e){let t=Ai.create(e).arrColor;this._wgColor.setValue(t[0],t[1],t[2],t[3])}else this._wgColor=null;pn._setStyleBgColor(e)}static _setStyleBgColor(e){ln.canvas.style.background=e||"none"}get mouseX(){return Math.round($a.mouseX/this.clientScaleX)}get mouseY(){return Math.round($a.mouseY/this.clientScaleY)}getMousePoint(){return d.TEMP.setTo(this.mouseX,this.mouseY)}get clientScaleX(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleX():1}get clientScaleY(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleY():1}get screenMode(){return this._screenMode}set screenMode(e){this._screenMode=e}_loop(){return this._globalRepaintGet=this._globalRepaintSet,this._globalRepaintSet=!1,this.render(ln._context,0,0),!0}getFrameTm(){return this._frameStartTime}getTimeFromFrameStart(){return I.now()-this._frameStartTime}get visible(){return super.visible}set visible(e){super.visible=e,pn._setVisibleStyle(e)}static _setVisibleStyle(e){ln._mainCanvas.source.style.visibility=e?"visible":"hidden"}render(e,i,r){if(this._frameRate===pn.FRAME_SLEEP){var s=I.now();if(s-this._frameStartTime<1e3)return;this._frameStartTime=s}else{if(!this._visible)return this._renderCount++,void(this._renderCount%5==0&&(cn.callLaters._update(),dt.loopCount++,$i.loopCount=dt.loopCount,this._runComponents(),this._updateTimers()));this._frameStartTime=I.now(),$i.loopStTm=this._frameStartTime}this._renderCount++;let a=(this._frameRate===pn.FRAME_MOUSE?this._frameStartTime-$a.lastMouseTime<2e3?pn.FRAME_FAST:pn.FRAME_SLOW:this._frameRate)!==pn.FRAME_SLOW,n=this._renderCount%2==0;if(dt.renderSlow=!a,a||n){if(cn.callLaters._update(),dt.loopCount++,$i.loopCount=dt.loopCount,g.renderEngine.startFrame(),this.renderingEnabled){for(let e=0,t=this._scene2Ds.length;e<t;e++)this._scene2Ds[e]._update();for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e]._update();this._runComponents(),this._componentDriver.callPreRender(),e.render2D.renderStart(!t.preserveDrawingBuffer,this._wgColor);for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e].renderSubmit();this._render2d(e,i,r),this._componentDriver.callPostRender()}else this._runComponents();this._updateTimers(),g.renderEngine.endFrame()}}_render2d(e,t,i){dt.draw2D=0,e.startRender(),super.render(e,t,i),dt.render(e,t,i),e.endRender()}_runComponents(){this._componentDriver.callStart(),this._componentDriver.callUpdate(),this._componentDriver.callLateUpdate(),this._componentDriver.callDestroy()}_updateTimers(){h.systemTimer._update(),h.physicsTimer._update(),h.timer._update(),zs._runAll()}set fullScreenEnabled(e){var t=I.document,i=ln.canvas;e?(i.addEventListener("mousedown",gn),i.addEventListener("touchstart",gn),t.addEventListener("fullscreenchange",mn),t.addEventListener("mozfullscreenchange",mn),t.addEventListener("webkitfullscreenchange",mn),t.addEventListener("msfullscreenchange",mn)):(i.removeEventListener("mousedown",gn),i.removeEventListener("touchstart",gn),t.removeEventListener("fullscreenchange",mn),t.removeEventListener("mozfullscreenchange",mn),t.removeEventListener("webkitfullscreenchange",mn),t.removeEventListener("msfullscreenchange",mn))}exitFullscreen(){var e=I.document;e.exitFullscreen?e.exitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitExitFullscreen&&e.webkitExitFullscreen()}get frameRate(){return this._frameRate}set frameRate(e){this._frameRate=e}isGlobalRepaint(){return this._globalRepaintGet}setGlobalRepaint(){this._globalRepaintSet=!0}}function gn(){var e=I.document.documentElement;e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen();var t=ln.canvas;t.removeEventListener("mousedown",gn),t.removeEventListener("touchstart",gn)}function mn(){h.stage.event(c.FULL_SCREEN_CHANGE)}pn.SCALE_NOSCALE="noscale",pn.SCALE_SHOWALL="showall",pn.SCALE_NOBORDER="noborder",pn.SCALE_FULL="full",pn.SCALE_FIXED_WIDTH="fixedwidth",pn.SCALE_FIXED_HEIGHT="fixedheight",pn.SCALE_FIXED_AUTO="fixedauto",pn.ALIGN_LEFT="left",pn.ALIGN_RIGHT="right",pn.ALIGN_CENTER="center",pn.ALIGN_TOP="top",pn.ALIGN_MIDDLE="middle",pn.ALIGN_BOTTOM="bottom",pn.SCREEN_NONE="none",pn.SCREEN_HORIZONTAL="horizontal",pn.SCREEN_VERTICAL="vertical",pn.FRAME_FAST="fast",pn.FRAME_SLOW="slow",pn.FRAME_MOUSE="mouse",pn.FRAME_SLEEP="sleep";class fn extends D{constructor(){super(...arguments),this.isStopped=!1}get volume(){return 1}set volume(e){}get position(){return 0}get duration(){return 0}play(){}stop(){this.completeHandler&&this.completeHandler.runWith(!1)}pause(){}resume(){}__runComplete(e){e&&e.runWith(!0)}}class Tn extends fn{constructor(e){super(),this._audio=null,this._onEnd=this.__onEnd.bind(this),this._resumePlay=this.__resumePlay.bind(this),e.addEventListener("ended",this._onEnd),this._audio=e,this._src=e.src}__onEnd(e){if(1==this.loops)return this.completeHandler&&(h.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(c.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}__resumePlay(){if(this._audio&&this._audio.removeEventListener("canplay",this._resumePlay),!this.isStopped)try{this._audio.currentTime=this.startTime,I.container.appendChild(this._audio),this._audio.play()}catch(e){this.event(c.ERROR)}}play(){this.isStopped=!1;try{this._audio.playbackRate=Sn.playbackRate,this._audio.currentTime=this.startTime}catch(e){return void this._audio.addEventListener("canplay",this._resumePlay)}if(Sn.addChannel(this),I.container.appendChild(this._audio),"play"in this._audio){let e=this._audio.play();e&&e.catch((e=>{}))}}get position(){return this._audio?this._audio.currentTime:0}get duration(){return this._audio?this._audio.duration:0}stop(){super.stop(),this.isStopped=!0,Sn.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&p.isConch&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),h.Browser.onIE||this._audio!=yn._musicAudio&&l.recover("audio:"+this.url,this._audio),I.removeElement(this._audio),this._audio=null,Sn.autoReleaseSound&&Sn.disposeSoundLater(this.url))}pause(){this.isStopped=!0,Sn.removeChannel(this),this._audio&&("pause"in this._audio&&this._audio.pause(),Sn.autoReleaseSound&&Sn.disposeSoundLater(this.url))}resume(){var e=this._audio;e&&(this.isStopped=!1,0==e.readyState&&(e.src=this._src,e.addEventListener("canplay",this._resumePlay),e.load()),Sn.addChannel(this),"play"in e&&e.play())}get volume(){return this._audio?this._audio.volume:1}set volume(e){this._audio&&(this._audio.volume=e)}}class yn extends D{constructor(){super(...arguments),this.loaded=!1}dispose(){var e=yn._audioCache[this.url];l.clearBySign("audio:"+this.url),e&&(p.isConch||(e.src=""),delete yn._audioCache[this.url])}static _initMusicAudio(){yn._musicAudio||(yn._musicAudio||(yn._musicAudio=I.createElement("audio")),p.isConch||I.document.addEventListener("mousedown",yn._makeMusicOK))}static _makeMusicOK(){I.document.removeEventListener("mousedown",yn._makeMusicOK),yn._musicAudio.src?yn._musicAudio.play():(yn._musicAudio.src="",yn._musicAudio.load())}load(e){var t;if(this.url=e,e==Sn._bgMusic?(yn._initMusicAudio(),(t=yn._musicAudio).originalUrl!=e&&(delete yn._audioCache[t.originalUrl],t=null)):t=yn._audioCache[e],t&&t.readyState>=2)this.event(c.COMPLETE);else{t||(e==Sn._bgMusic?(yn._initMusicAudio(),t=yn._musicAudio):t=I.createElement("audio"),yn._audioCache[e]=t,U.inst.resolveURL(e,(e=>{t.src=k.postFormatURL(k.formatURL(e))}))),t.originalUrl=e,t.addEventListener("canplaythrough",r),t.addEventListener("error",s);var i=this;this.audio=t,t.load?t.load():s()}function r(){a(),i.loaded=!0,i.event(c.COMPLETE)}function s(){t.load=null,a(),i.event(c.ERROR)}function a(){t.removeEventListener("canplaythrough",r),t.removeEventListener("error",s)}}play(e=0,t=0){if(!this.url)return null;var i,r;if(this.url==Sn._bgMusic?""!=(i=yn._musicAudio).src&&i.originalUrl!=this.url&&(delete yn._audioCache[i.originalUrl],yn._audioCache[this.url]=i):i=yn._audioCache[this.url],!i)return null;r=l.getItem("audio:"+this.url),p.isConch?r||(r=I.createElement("audio"),U.inst.resolveURL(this.url,(e=>{r.src=k.postFormatURL(k.formatURL(e))}))):this.url==Sn._bgMusic?(yn._initMusicAudio(),r=yn._musicAudio,U.inst.resolveURL(this.url,(e=>{r.src=k.postFormatURL(k.formatURL(e))}))):r=r||i.cloneNode(!0),r.originalUrl=this.url;var s=new Tn(r);return s.url=this.url,s.loops=t,s.startTime=e,s.play(),Sn.addChannel(s),s}get duration(){var e;return(e=yn._audioCache[this.url])?e.duration:0}}yn._audioCache={};class xn extends fn{constructor(){super(),this.bufferSource=null,this._currentTime=0,this._volume=1,this._startTime=0,this._pauseTime=0,this.context=vn.ctx,this._onPlayEnd=this.__onPlayEnd.bind(this),this.context.createGain?this.gain=this.context.createGain():this.gain=this.context.createGainNode()}play(){if(Sn.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){if(this.startTime>=this.duration)return this.stop();var e=this.context,t=this.gain,i=e.createBufferSource();this.bufferSource=i,i.buffer=this.audioBuffer,i.connect(t),t&&t.disconnect(),t.connect(e.destination),i.onended=this._onPlayEnd,this._startTime=I.now(),this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(this._volume,this.context.currentTime,xn.SetTargetDelay):this.gain.gain.value=this._volume,0==this.loops&&(i.loop=!0),i.playbackRate.setTargetAtTime?i.playbackRate.setTargetAtTime(Sn.playbackRate,this.context.currentTime,xn.SetTargetDelay):i.playbackRate.value=Sn.playbackRate,i.start(0,this.startTime),this._currentTime=0}}__onPlayEnd(){if(1==this.loops)return this.completeHandler&&(h.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(c.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}get position(){return this.bufferSource?(I.now()-this._startTime)/1e3+this.startTime:0}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}_clearBufferSource(){if(this.bufferSource){var e=this.bufferSource;e.stop?e.stop(0):e.noteOff(0),e.disconnect(0),e.onended=null,xn._tryCleanFailed||this._tryClearBuffer(e),this.bufferSource=null}}_tryClearBuffer(e){try{e.buffer=null}catch(e){xn._tryCleanFailed=!0}}stop(){super.stop(),this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,Sn.removeChannel(this),this.completeHandler=null,Sn.autoReleaseSound&&Sn.disposeSoundLater(this.url)}pause(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,Sn.removeChannel(this),Sn.autoReleaseSound&&Sn.disposeSoundLater(this.url)}resume(){this.startTime=this._pauseTime,this.play()}get volume(){return this._volume}set volume(e){this._volume=e,this.isStopped||(this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(e,this.context.currentTime,xn.SetTargetDelay):this.gain.gain.value=e)}}xn._tryCleanFailed=!1,xn.SetTargetDelay=.001;class vn extends D{constructor(){super(...arguments),this.loaded=!1,this._disposed=!1}static _playEmptySound(){if(null!=vn.ctx){var e=vn.ctx.createBufferSource();e.buffer=vn._miniBuffer,e.connect(vn.ctx.destination),e.start(0,0,0)}}static _unlock(){vn._unlocked||(vn._playEmptySound(),"running"==vn.ctx.state&&(window.document.removeEventListener("mousedown",vn._unlock,!0),window.document.removeEventListener("touchend",vn._unlock,!0),window.document.removeEventListener("touchstart",vn._unlock,!0),vn._unlocked=!0))}static initWebAudio(){vn.ctx=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),"running"!=vn.ctx.state&&(vn._unlock(),window.document.addEventListener("mousedown",vn._unlock,!0),window.document.addEventListener("touchend",vn._unlock,!0),window.document.addEventListener("touchstart",vn._unlock,!0))}load(e){this.url=e,this.audioBuffer=h.loader.getRes(e),this.audioBuffer?this._loaded(this.audioBuffer):h.loader.load(e,Be.SOUND).then((e=>this._loaded(e)))}_loaded(e){this._disposed||(this.audioBuffer=e,this.loaded=!0,this.event(c.COMPLETE))}__playAfterLoaded(){if(this.__toPlays){var e,t,i,r;for(t=(i=this.__toPlays).length,e=0;e<t;e++)(r=i[e])[2]&&!r[2].isStopped&&this.play(r[0],r[1],r[2]);this.__toPlays.length=0}}play(e=0,t=0,i=null){return i=i||new xn,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([e,t,i]),this.once(c.COMPLETE,this,this.__playAfterLoaded),this.load(this.url)),i.url=this.url,i.loops=t,i.audioBuffer=this.audioBuffer,i.startTime=e,i.play(),Sn.addChannel(i),i}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}dispose(){this._disposed=!0,this.audioBuffer&&(h.loader.clearRes(this.url,this.audioBuffer),this.audioBuffer=null),this.__toPlays=[]}}vn._miniBuffer=vn.ctx?vn.ctx.createBuffer(1,1,22050):void 0,vn._unlocked=!1;class Sn{static __init__(){var e=h.Browser.window,t=!!(e.AudioContext||e.webkitAudioContext||e.mozAudioContext);return t&&vn.initWebAudio(),Sn._soundClass=t?vn:yn,I.onTBMiniGame||yn._initMusicAudio(),Sn._musicClass=yn,t}static addChannel(e){Sn._channels.indexOf(e)>=0||Sn._channels.push(e)}static removeChannel(e){for(let t=Sn._channels.length-1;t>=0;t--)Sn._channels[t]==e&&Sn._channels.splice(t,1)}static disposeSoundLater(e){Sn._lastSoundUsedTimeDic[e]=h.Browser.now(),Sn._isCheckingDispose||(Sn._isCheckingDispose=!0,h.timer.loop(5e3,null,Sn._checkDisposeSound))}static _checkDisposeSound(){let e=h.Browser.now(),t=!1;for(let i in Sn._lastSoundUsedTimeDic)e-Sn._lastSoundUsedTimeDic[i]>3e4?(delete Sn._lastSoundUsedTimeDic[i],Sn.disposeSoundIfNotUsed(i)):t=!0;t||(Sn._isCheckingDispose=!1,h.timer.clear(null,Sn._checkDisposeSound))}static disposeSoundIfNotUsed(e){for(let t=Sn._channels.length-1;t>=0;t--)if(Sn._channels[t].url==e)return;Sn.destroySound(e)}static get autoStopMusic(){return Sn._autoStopMusic}static set autoStopMusic(e){h.stage.off(c.BLUR,null,Sn._stageOnBlur),h.stage.off(c.FOCUS,null,Sn._stageOnFocus),h.stage.off(c.VISIBILITY_CHANGE,null,Sn._visibilityChange),Sn._autoStopMusic=e,e&&(h.stage.on(c.BLUR,null,Sn._stageOnBlur),h.stage.on(c.FOCUS,null,Sn._stageOnFocus),h.stage.on(c.VISIBILITY_CHANGE,null,Sn._visibilityChange))}static _visibilityChange(){h.stage.isVisibility?Sn._stageOnFocus():Sn._stageOnBlur()}static _stageOnBlur(){Sn._isActive=!1,Sn._musicChannel&&(Sn._musicChannel.isStopped||(Sn._blurPaused=!0,Sn._musicChannel.pause())),Sn.stopAllSound(),h.stage.once(c.MOUSE_DOWN,null,Sn._stageOnFocus)}static _recoverWebAudio(){vn.ctx&&"running"!=vn.ctx.state&&vn.ctx.resume&&vn.ctx.resume()}static _stageOnFocus(){Sn._isActive=!0,Sn._recoverWebAudio(),h.stage.off(c.MOUSE_DOWN,null,Sn._stageOnFocus),Sn._blurPaused&&Sn._musicChannel&&Sn._musicChannel.isStopped&&(Sn._blurPaused=!1,Sn._musicChannel.resume())}static get muted(){return Sn._muted}static set muted(e){e!=Sn._muted&&(e&&Sn.stopAllSound(),Sn.musicMuted=e,Sn._muted=e)}static get soundMuted(){return Sn._soundMuted}static set soundMuted(e){Sn._soundMuted=e}static get musicMuted(){return Sn._musicMuted}static set musicMuted(e){e!=Sn._musicMuted&&(e?(Sn._bgMusic&&Sn._musicChannel&&!Sn._musicChannel.isStopped?p.isConch?Sn._musicChannel._audio&&(Sn._musicChannel._audio.muted=!0):Sn._musicChannel.pause():Sn._musicChannel=null,Sn._musicMuted=e):(Sn._musicMuted=e,Sn._bgMusic&&Sn._musicChannel&&(p.isConch?Sn._musicChannel._audio&&(Sn._musicChannel._audio.muted=!1):Sn._musicChannel.resume())))}static get useAudioMusic(){return Sn._useAudioMusic}static set useAudioMusic(e){Sn._useAudioMusic=e,Sn._musicClass=e?yn:null}static playSound(e,t=1,i=null,r=null,s=0,a){if(!Sn._isActive||!e)return null;if(Sn._muted)return null;if(Sn._recoverWebAudio(),e==Sn._bgMusic){if(Sn._musicMuted)return null}else if(Sn._soundMuted)return null;let n;I._isMiniGame||(n=Sn._soundCache[e]),r||(r=Sn._soundClass),n||(n=new r,n.load(e),I._isMiniGame||(Sn._soundCache[e]=n));let o=n.play(s,t);return o?(o.url=e,o.volume=null!=a?a:e==Sn._bgMusic?Sn.musicVolume:Sn.soundVolume,o.completeHandler=i,o):null}static destroySound(e){let t=Sn._soundCache[e];t&&(delete Sn._soundCache[e],t.dispose())}static playMusic(e,t=0,i=null,r=0){return Sn._bgMusic=e,Sn._musicChannel&&Sn._musicChannel.stop(),Sn._musicChannel=Sn.playSound(e,t,i,Sn._musicClass,r)}static stopSound(e){for(let t=Sn._channels.length-1;t>=0;t--){let i=Sn._channels[t];i.url==e&&i.stop()}}static stopAll(){var e;for(Sn._bgMusic=null,e=Sn._channels.length-1;e>=0;e--)Sn._channels[e].stop()}static stopAllSound(){for(let e=Sn._channels.length-1;e>=0;e--){let t=Sn._channels[e];t.url!=Sn._bgMusic&&t.stop()}}static stopMusic(){Sn._musicChannel&&Sn._musicChannel.stop(),Sn._bgMusic=null}static setSoundVolume(e,t=null){if(t)Sn._setVolume(t,e);else{Sn.soundVolume=e;for(let t=Sn._channels.length-1;t>=0;t--){let i=Sn._channels[t];i.url!=Sn._bgMusic&&(i.volume=e)}}}static setMusicVolume(e){Sn.musicVolume=e,Sn._setVolume(Sn._bgMusic,e)}static _setVolume(e,t){for(let i=Sn._channels.length-1;i>=0;i--){let r=Sn._channels[i];r.url==e&&(r.volume=t)}}}Sn.musicVolume=1,Sn.soundVolume=1,Sn.playbackRate=1,Sn._useAudioMusic=!0,Sn._muted=!1,Sn._soundMuted=!1,Sn._musicMuted=!1,Sn._bgMusic=null,Sn._musicChannel=null,Sn._channels=[],Sn._blurPaused=!1,Sn._isActive=!0,Sn._lastSoundUsedTimeDic={},Sn._isCheckingDispose=!1,Sn._soundCache={},Sn.autoReleaseSound=!0;class Dn{static __init__(){return Dn._baseClass||(Dn._baseClass=En,En.init()),Dn.items=Dn._baseClass.items,Dn.support=Dn._baseClass.support,Dn.support}static setItem(e,t){Dn._baseClass.setItem(e,t)}static getItem(e){return Dn._baseClass.getItem(e)}static setJSON(e,t){Dn._baseClass.setJSON(e,t)}static getJSON(e){return Dn._baseClass.getJSON(e)}static removeItem(e){Dn._baseClass.removeItem(e)}static clear(){Dn._baseClass.clear()}}Dn.support=!1;class En{static init(){try{En.support=!0,En.items=window.localStorage,En.setItem("laya","1"),En.removeItem("laya")}catch(e){En.support=!1}En.support||console.log("LocalStorage is not supprot or browser is private mode.")}static setItem(e,t){try{En.support&&En.items.setItem(e,t)}catch(e){console.warn("set localStorage failed",e)}}static getItem(e){return En.support?En.items.getItem(e):null}static setJSON(e,t){try{En.support&&En.items.setItem(e,JSON.stringify(t))}catch(e){console.warn("set localStorage failed",e)}}static getJSON(e){try{return JSON.parse(En.support?En.items.getItem(e):null)}catch(t){return En.items.getItem(e)}}static removeItem(e){En.support&&En.items.removeItem(e)}static clear(){En.support&&En.items.clear()}}En.support=!1;class wn extends Gi{constructor(){super(e.RenderSpriteData.Primitive),wn.prototype.initialize.call(this)}initialize(){this._defaultShader=gi.find("Sprite2DPrimitive")}reinit(){super.initialize(),this.initialize()}}class Rn extends Gi{constructor(){super(e.RenderSpriteData.Texture2D),Rn.prototype.initialize.call(this)}initialize(){this._blurInfo=new Gt,this._u_blurInfo1=new s,this._u_blurInfo2=new s,this._u_TexRange=new s,this._colorMat=new Zt,this._colorAlpha=new s,this._strength_sig2_2sig2_gauss1=new s,this._defaultShader=gi.find("Sprite2DTexture"),this.blurInfo=this._blurInfo,this.u_blurInfo1=this._u_blurInfo1,this.u_blurInfo2=this._u_blurInfo2,this.u_TexRange=this._u_TexRange,this.colorMat=this._colorMat,this.colorAlpha=this._colorAlpha,this.strength_sig2_2sig2_gauss1=this._strength_sig2_2sig2_gauss1}reinit(){super.initialize(),this.initialize()}get blurInfo(){return this.shaderData.getVector2(ki.UNIFORM_BLURINFO)}set blurInfo(e){this.shaderData.setVector2(ki.UNIFORM_BLURINFO,e)}get u_blurInfo1(){return this.shaderData.getVector(ki.UNIFORM_BLURINFO1)}set u_blurInfo1(e){this.shaderData.setVector(ki.UNIFORM_BLURINFO1,e)}get u_blurInfo2(){return this.shaderData.getVector(ki.UNIFORM_BLURINFO2)}set u_blurInfo2(e){this.shaderData.setVector(ki.UNIFORM_BLURINFO2,e)}get u_TexRange(){return this.shaderData.getVector(ki.UNIFORM_TEXRANGE)}set u_TexRange(e){this.shaderData.setVector(ki.UNIFORM_TEXRANGE,e)}get colorMat(){return this.shaderData.getMatrix4x4(ki.UNIFORM_COLORMAT)}set colorMat(e){this.shaderData.setMatrix4x4(ki.UNIFORM_COLORMAT,e)}get colorAlpha(){return this.shaderData.getVector(ki.UNIFORM_COLORALPHA)}set colorAlpha(e){this.shaderData.setVector(ki.UNIFORM_COLORALPHA,e)}get strength_sig2_2sig2_gauss1(){return this.shaderData.getVector(ki.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1)}set strength_sig2_2sig2_gauss1(e){this.shaderData.setVector(ki.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,e)}}class Cn{static set cursor(e){Cn._style.cursor=e}static get cursor(){return Cn._style.cursor}static __init__(){Cn._style=I.document.body.style}static hide(){"none"!=Cn.cursor&&(Cn._preCursor=Cn.cursor,Cn.cursor="none")}static show(){"none"==Cn.cursor&&(Cn._preCursor?Cn.cursor=Cn._preCursor:Cn.cursor="auto")}}class An{static __init__(){An.I=new An,h.systemTimer.loop(An.delInterval,null,An.clearCache)}static clearCache(){for(var e=0,t=An._maps.length;e<t;e++){An._maps[e]._obj={}}}constructor(){this._obj={},An._maps.push(this)}set(e,t){null!=e&&("string"==typeof e||"number"==typeof e?this._obj[e]=t:this._obj[O.getGID(e)]=t)}get(e){return null==e?null:"string"==typeof e||"number"==typeof e?this._obj[e]:this._obj[O.getGID(e)]}del(e){null!=e&&("string"==typeof e||"number"==typeof e?delete this._obj[e]:delete this._obj[O.getGID(e)])}has(e){return null!=e&&("string"==typeof e||"number"==typeof e?null!=this._obj[e]:null!=this._obj[O.getGID(e)])}}var Mn;An.delInterval=6e5,An._maps=[],e.MaterialRenderMode=void 0,(Mn=e.MaterialRenderMode||(e.MaterialRenderMode={}))[Mn.RENDERMODE_OPAQUE=0]="RENDERMODE_OPAQUE",Mn[Mn.RENDERMODE_CUTOUT=1]="RENDERMODE_CUTOUT",Mn[Mn.RENDERMODE_TRANSPARENT=2]="RENDERMODE_TRANSPARENT",Mn[Mn.RENDERMODE_ADDTIVE=3]="RENDERMODE_ADDTIVE",Mn[Mn.RENDERMODE_ALPHABLENDED=4]="RENDERMODE_ALPHABLENDED",Mn[Mn.RENDERMODE_CUSTOME=5]="RENDERMODE_CUSTOME";class bn extends A{static load(e,t){h.loader.load(e,t,null,Be.MATERIAL)}static __initDefine__(){bn.SHADERDEFINE_ALPHATEST=gi.getDefineByName("ALPHATEST"),bn.SHADERDEFINE_MAINTEXTURE=gi.getDefineByName("MAINTEXTURE"),bn.SHADERDEFINE_ADDTIVEFOG=gi.getDefineByName("ADDTIVEFOG"),bn.ALPHATESTVALUE=gi.propertyNameToID("u_AlphaTestValue"),gi.CULL=gi.propertyNameToID("s_Cull"),gi.BLEND=gi.propertyNameToID("s_Blend"),gi.BLEND_SRC=gi.propertyNameToID("s_BlendSrc"),gi.BLEND_DST=gi.propertyNameToID("s_BlendDst"),gi.BLEND_SRC_RGB=gi.propertyNameToID("s_BlendSrcRGB"),gi.BLEND_DST_RGB=gi.propertyNameToID("s_BlendDstRGB"),gi.BLEND_SRC_ALPHA=gi.propertyNameToID("s_BlendSrcAlpha"),gi.BLEND_DST_ALPHA=gi.propertyNameToID("s_BlendDstAlpha"),gi.BLEND_EQUATION=gi.propertyNameToID("s_BlendEquation"),gi.BLEND_EQUATION_RGB=gi.propertyNameToID("s_BlendEquationRGB"),gi.BLEND_EQUATION_ALPHA=gi.propertyNameToID("s_BlendEquationAlpha"),gi.DEPTH_TEST=gi.propertyNameToID("s_DepthTest"),gi.DEPTH_WRITE=gi.propertyNameToID("s_DepthWrite"),gi.STENCIL_Ref=gi.propertyNameToID("s_StencilRef"),gi.STENCIL_TEST=gi.propertyNameToID("s_StencilTest"),gi.STENCIL_WRITE=gi.propertyNameToID("s_StencilWrite"),gi.STENCIL_Op=gi.propertyNameToID("s_StencilOp")}get renderQueue(){return this._renderQueue}set renderQueue(e){this._renderQueue=e,this._notifyOwnerElements()}_setOwnerElement(e){this.ownerElements.add(e),e.materialShaderData=this.shaderData,e.materialRenderQueue=this.renderQueue,e.subShader=this._shader.getSubShaderAt(0),e.materialId=this.id}_removeOwnerElement(e){this.ownerElements.delete(e)}_notifyOwnerElements(){this.ownerElements.forEach((e=>{this._setOwnerElement(e)}))}get shaderData(){return this._shaderValues}get alphaTestValue(){return this._shaderValues.getNumber(bn.ALPHATESTVALUE)}set alphaTestValue(e){this._shaderValues.setNumber(bn.ALPHATESTVALUE,e)}get alphaTest(){return this.shaderData.hasDefine(bn.SHADERDEFINE_ALPHATEST)}set alphaTest(e){e?this._shaderValues.addDefine(bn.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(bn.SHADERDEFINE_ALPHATEST)}addDefine(e){this._shaderValues.addDefine(e)}removeDefine(e){this._shaderValues.removeDefine(e)}setDefine(e,t){t?this._shaderValues.addDefine(e):this._shaderValues.removeDefine(e)}hasDefine(e){return this._shaderValues.hasDefine(e)}get depthWrite(){return this._shaderValues.getBool(gi.DEPTH_WRITE)}set depthWrite(e){this._shaderValues.setBool(gi.DEPTH_WRITE,e)}get cull(){return this._shaderValues.getInt(gi.CULL)}set cull(e){this._shaderValues.setInt(gi.CULL,e)}get blend(){return this._shaderValues.getInt(gi.BLEND)}set blend(e){this._shaderValues.setInt(gi.BLEND,e)}get blendSrc(){return this._shaderValues.getInt(gi.BLEND_SRC)}set blendSrc(e){this._shaderValues.setInt(gi.BLEND_SRC,e)}get blendDst(){return this._shaderValues.getInt(gi.BLEND_DST)}set blendDst(e){this._shaderValues.setInt(gi.BLEND_DST,e)}get blendSrcAlpha(){return this._shaderValues.getInt(gi.BLEND_SRC_ALPHA)}set blendSrcAlpha(e){this._shaderValues.setInt(gi.BLEND_SRC_ALPHA,e)}get blendSrcRGB(){return this._shaderValues.getInt(gi.BLEND_SRC_RGB)}set blendSrcRGB(e){this._shaderValues.setInt(gi.BLEND_SRC_RGB,e)}get blendDstRGB(){return this._shaderValues.getInt(gi.BLEND_DST_RGB)}set blendDstRGB(e){this._shaderValues.setInt(gi.BLEND_DST_RGB,e)}get blendDstAlpha(){return this._shaderValues.getInt(gi.BLEND_DST_ALPHA)}set blendDstAlpha(e){this._shaderValues.setInt(gi.BLEND_DST_ALPHA,e)}get blendEquation(){return this._shaderValues.getInt(gi.BLEND_EQUATION)}set blendEquation(e){this._shaderValues.setInt(gi.BLEND_EQUATION,e)}get blendEquationRGB(){return this._shaderValues.getInt(gi.BLEND_EQUATION_RGB)}set blendEquationRGB(e){this._shaderValues.setInt(gi.BLEND_EQUATION_RGB,e)}get blendEquationAlpha(){return this._shaderValues.getInt(gi.BLEND_EQUATION_ALPHA)}set blendEquationAlpha(e){this._shaderValues.setInt(gi.BLEND_EQUATION_ALPHA,e)}get depthTest(){return this._shaderValues.getInt(gi.DEPTH_TEST)}set depthTest(e){this._shaderValues.setInt(gi.DEPTH_TEST,e)}get stencilTest(){return this._shaderValues.getInt(gi.STENCIL_TEST)}set stencilTest(e){this._shaderValues.setInt(gi.STENCIL_TEST,e)}get stencilWrite(){return this._shaderValues.getBool(gi.STENCIL_WRITE)}set stencilWrite(e){this._shaderValues.setBool(gi.STENCIL_WRITE,e)}get stencilRef(){return this._shaderValues.getInt(gi.STENCIL_Ref)}set stencilRef(e){this._shaderValues.setInt(gi.STENCIL_Ref,e)}get stencilOp(){return this._shaderValues.getVector3(gi.STENCIL_Op)}set stencilOp(e){this._shaderValues.setVector3(gi.STENCIL_Op,e)}get MaterialProperty(){let e={};var t=this._shaderValues.getData();for(let i in t)e[g.renderEngine.propertyIDToName(parseInt(i))]=t[i];return e}get MaterialDefine(){let e=new Array,t=this._shaderValues.getDefineData();return gi._getNamesByDefineData(t,e),e}get materialRenderMode(){return this._matRenderNode}set materialRenderMode(t){switch(this._matRenderNode=t,t){case e.MaterialRenderMode.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=bn.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.blend=At.BLEND_DISABLE,this.depthTest=At.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_CUTOUT:this.renderQueue=bn.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.blend=At.BLEND_DISABLE,this.depthTest=At.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_TRANSPARENT:this.renderQueue=bn.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=At.BLEND_ENABLE_ALL,this.blendSrc=At.BLENDPARAM_SRC_ALPHA,this.blendDst=At.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=At.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_ADDTIVE:this.renderQueue=bn.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=At.BLEND_ENABLE_ALL,this.blendSrc=At.BLENDPARAM_SRC_ALPHA,this.blendDst=At.BLENDPARAM_ONE,this.depthTest=At.DEPTHTEST_LESS,this._shaderValues.addDefine(bn.SHADERDEFINE_ADDTIVEFOG);break;case e.MaterialRenderMode.RENDERMODE_ALPHABLENDED:this.renderQueue=bn.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=At.BLEND_ENABLE_ALL,this.blendSrc=At.BLENDPARAM_SRC_ALPHA,this.blendDst=At.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=At.DEPTHTEST_LESS,this._shaderValues.removeDefine(bn.SHADERDEFINE_ADDTIVEFOG);break;case e.MaterialRenderMode.RENDERMODE_CUSTOME:break;default:console.warn(`Material : renderMode value error - (${t}).`)}}constructor(){super(),this.ownerElements=new Set,this._shaderValues=g.renderDeviceFactory.createShaderData(this),this.renderQueue=bn.RENDERQUEUE_OPAQUE,this._matRenderNode=0,this.alphaTest=!1,this.cull=At.CULL_BACK,this.blend=At.BLEND_DISABLE,this.blendSrc=At.BLENDPARAM_ONE,this.blendDst=At.BLENDPARAM_ZERO,this.blendSrcRGB=At.BLENDPARAM_ONE,this.blendDstRGB=At.BLENDPARAM_ZERO,this.blendSrcAlpha=At.BLENDPARAM_ONE,this.blendDstAlpha=At.BLENDPARAM_ZERO,this.blendEquation=At.BLENDEQUATION_ADD,this.blendEquationRGB=At.BLENDEQUATION_ADD,this.blendEquationAlpha=At.BLENDEQUATION_ADD,this.depthTest=At.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=At.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new a(At.STENCILOP_KEEP,At.STENCILOP_KEEP,At.STENCILOP_REPLACE),this.destroyedImmediately=t.destroyResourceImmediatelyDefault}_disposeResource(){this._shaderValues.destroy(),this._shaderValues=null,this.ownerElements.clear()}get shader(){return this._shader}effectiveProperty(){return this._shader.getSubShaderAt(0)._uniformMap}setShaderName(e){this._shader=gi.find(e),this._shader||(console.warn(`Material: unknown shader name '${e}'`),this._shader=gi.find("BLINNPHONG")),this.shaderData.clearDefine(),this.shaderData.clearData();let t=this._shader.getSubShaderAt(0),i=t._uniformDefaultValue,r=t._uniformMap;this.applyUniformDefaultValue(r,i),this._notifyOwnerElements()}applyUniformDefaultValue(e,t){e.forEach(((e,i)=>{if(e.arrayLength<=0){let i=e.uniformtype,r=e.propertyName;if(t&&null!=t[r]){let e=t[r];this.setShaderData(r,i,e)}else{let e=ni(i);e&&this.setShaderData(r,i,e)}}}))}getBoolByIndex(e){return this.shaderData.getBool(e)}setBoolByIndex(e,t){this.shaderData.setBool(e,t)}getBool(e){let t=gi.propertyNameToID(e);return this.getBoolByIndex(t)}setBool(e,t){let i=gi.propertyNameToID(e);this.setBoolByIndex(i,t)}getFloatByIndex(e){return this.shaderData.getNumber(e)}setFloatByIndex(e,t){this.shaderData.setNumber(e,t)}getFloat(e){let t=gi.propertyNameToID(e);return this.getFloatByIndex(t)}setFloat(e,t){let i=gi.propertyNameToID(e);this.setFloatByIndex(i,t)}getIntByIndex(e){return this.shaderData.getInt(e)}setIntByIndex(e,t){this.shaderData.setInt(e,t)}getInt(e){let t=gi.propertyNameToID(e);return this.getIntByIndex(t)}setInt(e,t){let i=gi.propertyNameToID(e);this.setIntByIndex(i,t)}getVector2ByIndex(e){return this.shaderData.getVector2(e)}setVector2ByIndex(e,t){this.shaderData.setVector2(e,t)}getVector2(e){let t=gi.propertyNameToID(e);return this.getVector2ByIndex(t)}setVector2(e,t){let i=gi.propertyNameToID(e);this.setVector2ByIndex(i,t)}getVector3ByIndex(e){return this.shaderData.getVector3(e)}setVector3ByIndex(e,t){this.shaderData.setVector3(e,t)}getVector3(e){let t=gi.propertyNameToID(e);return this.getVector3ByIndex(t)}setVector3(e,t){let i=gi.propertyNameToID(e);this.setVector3ByIndex(i,t)}setVector4ByIndex(e,t){this.shaderData.setVector(e,t)}getVector4ByIndex(e){return this.shaderData.getVector(e)}setVector4(e,t){let i=gi.propertyNameToID(e);this.setVector4ByIndex(i,t)}getVector4(e){let t=gi.propertyNameToID(e);return this.getVector4ByIndex(t)}getColorByIndex(e){return this.shaderData.getColor(e)}setColorByIndex(e,t){this.shaderData.setColor(e,t)}getColor(e){let t=gi.propertyNameToID(e);return this.shaderData.getColor(t)}setColor(e,t){let i=gi.propertyNameToID(e);this.setColorByIndex(i,t)}getMatrix4x4ByIndex(e){return this.shaderData.getMatrix4x4(e)}setMatrix4x4ByIndex(e,t){this.shaderData.setMatrix4x4(e,t)}getMatrix4x4(e){let t=gi.propertyNameToID(e);return this.getMatrix4x4ByIndex(t)}setMatrix4x4(e,t){let i=gi.propertyNameToID(e);this.setMatrix4x4ByIndex(i,t)}getMatrix3x3ByIndex(e){return this.shaderData.getMatrix3x3(e)}setMatrix3x3ByIndex(e,t){this.shaderData.setMatrix3x3(e,t)}getMatrix3x3(e){let t=gi.propertyNameToID(e);return this.getMatrix3x3ByIndex(t)}setMatrix3x3(e,t){let i=gi.propertyNameToID(e);this.setMatrix3x3ByIndex(i,t)}setTextureByIndex(e,t){this.shaderData.setTexture(e,t),t&&!t._texture&&t.once(c.READY,this,this.reSetTexture,[e,t])}reSetTexture(e,t){this.setTextureByIndex(e,t)}getTextureByIndex(e){return this.shaderData.getTexture(e)}setTexture(e,t){let i=gi.propertyNameToID(e);this.setTextureByIndex(i,t)}getTexture(e){let t=gi.propertyNameToID(e);return this.getTextureByIndex(t)}getBufferByIndex(e){return this.shaderData.getBuffer(e)}setBufferByIndex(e,t){this.shaderData.setBuffer(e,t)}getBuffer(e){let t=gi.propertyNameToID(e);return this.getBufferByIndex(t)}setBuffer(e,t){let i=gi.propertyNameToID(e);this.setBufferByIndex(i,t)}setShaderDataByIndex(e,t,i){this.shaderData.setShaderData(e,t,i)}setShaderData(e,t,i){let r=gi.propertyNameToID(e);this.setShaderDataByIndex(r,t,i)}getShaderData(e,t){let i=gi.propertyNameToID(e);return this.getShaderDataByIndex(i,t)}getShaderDataByIndex(e,t){return this._shaderValues.getShaderData(e,t)}cloneTo(e){e.name=this.name,e.renderQueue=this.renderQueue,e.setShaderName(this._shader._name),this._shaderValues.cloneTo(e._shaderValues)}clone(){var e=new bn;return this.cloneTo(e),e}get _defineDatas(){return this._shaderValues.getDefineData()}oldparseEndEvent(){}}bn.RENDERQUEUE_OPAQUE=2e3,bn.RENDERQUEUE_ALPHATEST=2450,bn.RENDERQUEUE_TRANSPARENT=3e3;class In{static init(...t){if(In._inited)return Promise.resolve();let i;In._inited=!0,dt.renderPassStatArray.length=e.RenderPassStatisticsInfo.RenderPassStatisticCount,i="number"==typeof t[0]?{designWidth:t[0],designHeight:t[1]}:t[0],I.__init__(),k.__init__();let r=I.mainCanvas=new Vr(!0);In._setStyleInfo(r),I.onKGMiniGame||I.onAlipayMiniGame||I.onTBMiniGame||I.container.appendChild(r.source),I.canvas=new Vr(!0),I.context=I.canvas.getContext("2d"),I.supportWebAudio=Sn.__init__(),I.supportLocalStorage=Dn.__init__(),e.systemTimer=new cn(!1),e.physicsTimer=new cn(!1),e.timer=new cn(!1),e.loader=new Be,In.systemTimer=cn.gSysTimer=e.systemTimer,In.timer=e.timer,In.physicsTimer=e.physicsTimer,In.loader=e.loader,h.systemTimer=e.systemTimer,h.physicsTimer=e.physicsTimer,h.timer=e.timer,h.loader=e.loader,An.__init__(),Cn.__init__();let s=[];p.beforeInit&&s.push((()=>p.beforeInit(i))),In._beforeInitCallbacks.forEach((e=>s.push((()=>e(i))))),s.push((()=>g.renderOBJCreate.createEngine(null,I.mainCanvas))),s.push((()=>In.initRender2D(i)));let a=window.Laya3D;a&&s.push((()=>a.__init__())),s.push((()=>Promise.all(In._initCallbacks.map((e=>e()))))),s.push((()=>{let e=Promise.resolve();for(let t of In._afterInitCallbacks)e=e.then(t);return e})),p.afterInit&&s.push((()=>p.afterInit()));let n=Promise.resolve();for(let e of s)n=n.then(e);return n}static _setStyleInfo(e){let t=e.source.style;t.position="absolute",t.top=t.left="0px",t.background="#000000"}static initRender2D(i){e.stage=window.stage=h.stage=In.stage=new pn,st.__init__(),ci.__init__(),gi.init(),lt.__int__(),gr.__init__(),pr.__init__(),In.render=In.createRender(),e.render=In.render,e.stage.size(i.designWidth,i.designHeight),i.scaleMode&&(e.stage.scaleMode=i.scaleMode),i.screenMode&&(e.stage.screenMode=i.screenMode),i.alignV&&(e.stage.alignV=i.alignV),i.alignH&&(e.stage.alignH=i.alignH),t.isAlpha?e.stage.bgColor="#00000000":i.backgroundColor&&(e.stage.bgColor=i.backgroundColor),p.isConch&&window.conch.setGlobalRepaint&&window.conch.setGlobalRepaint(e.stage.setGlobalRepaint.bind(e.stage)),wi.__init__(),Ur.__init__(),bn.__initDefine__(),Mi._Defaultinit(),$a.__init__(e.stage,ln.canvas),window.conch&&"conchUseWXAdapter"in I.window&&(Ha.isAppUseNewInput=!0),Ha.__init__(ln.canvas),Sn.autoStopMusic=!0,Gi._initone(e.RenderSpriteData.Texture2D,Rn),Gi._initone(e.RenderSpriteData.Primitive,wn)}static createRender(){return new ln(0,0,I.mainCanvas)}static alertGlobalError(e){var t=0;I.window.onerror=e?function(e,i,r,s,a){t++<5&&a&&this.alert("出错啦，请把此信息截图给研发商\n"+e+"\n"+a.stack)}:null}static _runScript(e){return I.window[In._evcode](e)}static addInitCallback(e){In._initCallbacks.push(e)}static addBeforeInitCallback(e){In._beforeInitCallbacks.push(e)}static addAfterInitCallback(e){In._afterInitCallbacks.push(e)}static addReadyCallback(e){In._readyCallbacks.push(e)}static _invokeReadyCallbacks(){return Promise.all(In._readyCallbacks.map((e=>e()))).then((()=>{}))}static importNative(e){if(!p.isConch)return null;let t=window.$DLL_PATHS[e],i=window.importNative(t||e);if(!i)throw new Error(`failed to load ${e}`);return i}}In.stage=null,In.systemTimer=null,In.physicsTimer=null,In.timer=null,In.loader=null,In._inited=!1,In._initCallbacks=[],In._beforeInitCallbacks=[],In._afterInitCallbacks=[],In._readyCallbacks=[],In._evcode="eval",h.Laya=In,h.Loader=Be,h.Context=xr,h.Browser=I,h.InputManager=$a;var Bn=In.init;e.stage=void 0,e.systemTimer=void 0,e.physicsTimer=void 0,e.timer=void 0,e.loader=void 0,e.render=void 0;var Ln,Pn,Nn=In.alertGlobalError,On=In.addInitCallback,Fn=In.addBeforeInitCallback,Un=In.addAfterInitCallback,kn=In.addReadyCallback,Gn=In.importNative;e.AnimationWrapMode=void 0,(Ln=e.AnimationWrapMode||(e.AnimationWrapMode={}))[Ln.Positive=0]="Positive",Ln[Ln.Reverse=1]="Reverse",Ln[Ln.PingPong=2]="PingPong",e.AnimationStretchMode=void 0,(Pn=e.AnimationStretchMode||(e.AnimationStretchMode={}))[Pn.None=0]="None",Pn[Pn.Fill=1]="Fill",Pn[Pn.ResizeToFit=2]="ResizeToFit";class Vn extends ta{constructor(){super(),this.repeatDelay=0,this.timeScale=1,this._wrapMode=0,this._loop=!0,this._frame=0,this._autoPlay=!0,this._stretchMode=0,this._playing=!1,this._count=0,this._index=0,this._elapsed=0,this._loadId=0,this.interval=t.animationInterval,this._frames=[],this._drawCmds=[],this._delays=[],this._offset=new d,this._singleton=!1,this.runInEditor=!0}get index(){return p.isPlaying?this._frame:this._index}set index(e){this._index=this._frame=e,this.drawFrame()}get frames(){return this._frames}set frames(t){this._drawCmd&&(this.owner.graphics.removeCmd(this._drawCmd),this._drawCmd=null);for(let e of this._drawCmds)e.recover();if(this._drawCmds.length=0,this._frames.length=0,null!=t&&t.length>0){this._frames.push(...t);let i=this._stretchMode==e.AnimationStretchMode.Fill;for(let e of t){let t=i?ls.create(e,0,0,1,1,null,1,null,null,null,!0):ls.create(e,0,0);this._drawCmds.push(t)}this._count=this._frames.length,this._elapsed=0,this._wrapMode===e.AnimationWrapMode.Reverse?this._frame=this._count-1:(this._reversed=!1,this._frame=0),this._stretchMode==e.AnimationStretchMode.ResizeToFit&&this.owner.size(this._frames[0].sourceWidth,this._frames[0].sourceHeight),this.drawFrame()}else this._count=0}get frameDelays(){return this._delays}get isPlaying(){return this._playing}get autoPlay(){return this._autoPlay}set autoPlay(e){this._autoPlay=e,this.enabled&&(e?this.play():this.stop())}get wrapMode(){return this._wrapMode}set wrapMode(t){this._wrapMode!=t&&(this._wrapMode=t,this._playing&&(t===e.AnimationWrapMode.Reverse?this._reversed=!0:t===e.AnimationWrapMode.Positive&&(this._reversed=!1)))}get loop(){return this._loop}set loop(e){this._loop!=e&&(this._loop=e,e&&!this._playing&&this._autoPlay&&this.play())}get stretchMode(){return this._stretchMode}set stretchMode(t){this._stretchMode!=t&&(this._stretchMode=t,this._count>0&&(this._stretchMode==e.AnimationStretchMode.ResizeToFit&&this.owner.size(this._frames[0].sourceWidth,this._frames[0].sourceHeight),this.applyStretchMode(),this.drawFrame()))}get offset(){return this._offset}set offset(e){this._offset.copy(e),this.applyStretchMode(),this.drawFrame()}applyStretchMode(){if(this._stretchMode==e.AnimationStretchMode.Fill)for(let e of this._drawCmds)e.x=e.y=0,e.width=e.height=1,e.percent=!0;else{let t=0,i=0;this._stretchMode==e.AnimationStretchMode.None&&(t=this._offset.x,i=this._offset.y);for(let e of this._drawCmds)e.x=t,e.y=i,e.texture&&(e.width=e.texture.sourceWidth,e.height=e.texture.sourceHeight),e.percent=!1}}play(){this._playing||(this._playing=!0,this._elapsed=0,this._reversed=this._wrapMode===e.AnimationWrapMode.Reverse)}stop(){this._playing=!1,p.isPlaying||(this._frame=this._index,this.drawFrame())}_onEnable(){this._autoPlay&&this.play()}_onDestroy(){super._onDestroy(),this.frames=null}onUpdate(){if(!this._playing||0==this._count)return;let t=h.timer.delta;t>100&&(t=100),1!=this.timeScale&&(t*=this.timeScale);let i=this._frame;this._elapsed+=t;let r=this.interval;this._reversed?r+=i>0?this._delays[i-1]||0:this.repeatDelay:(r+=this._delays[i]||0,i===this._count-1&&(r+=this.repeatDelay)),this._elapsed<r||(this._elapsed-=r,this._elapsed>this.interval&&(this._elapsed=this.interval),this._reversed?(i--,i<0&&(this._loop?this._wrapMode==e.AnimationWrapMode.PingPong?(this._reversed=!1,i=1):i=this._count-1:(i=0,this._playing=!1))):(i++,i>this._count-1&&(this._loop?this._wrapMode==e.AnimationWrapMode.PingPong?(this._reversed=!0,i=Math.max(0,this._count-2)):i=0:(i=this._count-1,this._playing=!1))),this._frame=i,this._playing&&this.drawFrame())}drawFrame(){let e=this._drawCmds[this._frame];e!=this._drawCmd&&(this._drawCmd=this.owner.graphics.replaceCmd(this._drawCmd,e))}get source(){return this._source}set source(e){this._source=e,this.load()}get images(){return this._images}set images(e){this._images=e,this.load()}load(){this._source?this.loadAtlas(this._source):this._images&&this._images.length>0?this.loadImages(this._images):this._loadId++}loadImages(e){let t=++this._loadId,i=e.map((e=>Be.getRes(e)));return-1===i.indexOf(null)?this.frames=i:h.loader.load(e).then((e=>{this.destroyed||t==this._loadId&&(this.frames=e)})),this}loadAtlas(e){let t=++this._loadId,i=Be.getAtlas(e);return i?this.onAtlasLoaded(i,t):h.loader.load(e,Be.ATLAS).then((e=>this.onAtlasLoaded(e,t))),this}onAtlasLoaded(e,t){this.destroyed||t==this._loadId&&(this.frames=null==e?void 0:e.frames)}}class zn extends ua{constructor(){super(),this._comp=this.addComponent(Vn),this._comp.hideFlags|=Ge.HideAndDontSave,this._comp.autoPlay=!1}get loop(){return this._comp.loop}set loop(e){this._comp.loop=e}get wrapMode(){return this._comp.wrapMode}set wrapMode(e){this._comp.wrapMode=e}get interval(){return this._comp.interval}set interval(e){this._comp.interval=e}get index(){return this._comp.index}set index(e){this._comp.index=e}get count(){return this._comp.frames.length}get source(){return this._comp.source}set source(e){this._comp.source=e}get images(){return this._comp.images}set images(e){this._comp.images=e}get isPlaying(){return this._comp.isPlaying}set autoPlay(e){this._comp.autoPlay=e}get autoPlay(){return this._comp.autoPlay}play(e,t,i=""){i&&this._setFramesFromCache(i,!0),null!=e&&(this._comp.index="string"==typeof e?this.getFrameByLabel(e):e),null!=t&&(this._comp.loop=t),this._comp.play()}clear(){return this._comp.stop(),this._comp.frames=null,this._labels=null,this}stop(){this._comp.stop()}gotoAndStop(e){this.index="string"==typeof e?this.getFrameByLabel(e):e,this.stop()}addLabel(e,t){this._labels||(this._labels=[]),this._labels[t]=e}removeLabel(e){if(this._labels)for(let t=0,i=this._labels.length;t<i;t++)this._labels[t]==e&&delete this._labels[t]}loadImages(e){return this._comp.images=e,this}loadAtlas(e){return this._comp.source=e,this}getFrameByLabel(e){if(!this._labels)return 0;let t=this._labels.indexOf(e);return-1!=t?t:0}static createFrames(e,t){zn.framesMap[t]=e,h.loader.load(e)}static clearCache(e){delete zn.framesMap[e]}_setFramesFromCache(e,t=!1){let i=zn.framesMap[e];return i?(this.images=i,!0):(t&&console.log("ani not found:",e),!1)}}zn.framesMap={};var Hn={};class Wn extends ut{constructor(e=4){super(),this.shaderData=new Rn,this._shaderV1=new s,this.strength=e}get strength(){return this._strength}set strength(e){this._strength=Math.max(Math.abs(e),2);var t=this._strength/3,i=t*t;let r=this._shaderV1=new s(this.strength,i,2*i,1/(2*Math.PI*i)),a=0,n=Math.floor(10*this.strength);if(null!=Hn[n])a=Hn[n];else{for(let e=-4;e<=4;++e)for(let t=-4;t<=4;++t)a+=r.w*Math.exp(-(t*t+e*e)/r.z);Hn[n]=a}r.w/=a,this.onChange()}render(t,i,r){let s=50;this.left=-50,this.top=-50;let a=i+100,n=r+100;this.width=a,this.height=n,this.texture&&!this.texture.destroyed&&this.texture.width==a&&this.texture.height==n||(this.texture&&this.texture.destroy(),this.texture=new pe(a,n,e.RenderTargetFormat.R8G8B8A8));let o=this._render2D.clone(this.texture);o.renderStart(!0,new m(0,0,0,0));let h=this._rectMeshVB,l=this._rectMesh.vertexDeclarition.vertexStride/4;h[0]=50,h[1]=s,h[l]=50+i,h[l+1]=s,h[2*l]=50+i,h[2*l+1]=s+r,h[3*l]=s,h[3*l+1]=s+r;let u=this.shaderData;u.shaderData.addDefine(ki.FILTERBLUR),u.size=new Gt(a,n),u.textureHost=t,u.blurInfo=new Gt(a,n),u.strength_sig2_2sig2_gauss1=this._shaderV1,o.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,u,null),o.renderEnd()}}const Yn=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],Xn=[.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0],qn=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];class jn extends ut{constructor(e=null){super(),e||(e=this._copyMatrix(qn)),this._mat=new Float32Array(16),this._alpha=new Float32Array(4),this.setByMatrix(e)}render(t,i,r){let a=i,n=r;this.width=a,this.height=n,this.texture&&!this.texture.destroyed&&this.texture.width==a&&this.texture.height==n||(this.texture&&this.texture.destroy(),this.texture=new pe(a,n,e.RenderTargetFormat.R8G8B8A8));let o=this._render2D.clone(this.texture);o.renderStart(!0,new m(0,0,0,0));let h=this._rectMeshVB,l=this._rectMesh.vertexDeclarition.vertexStride/4;h[0]=0,h[1]=0,h[l]=i,h[l+1]=0,h[2*l]=i,h[2*l+1]=r,h[3*l]=0,h[3*l+1]=r;let u=new Rn;u.setFilter(this),Zt.TEMP.cloneByArray(this._mat),u.shaderData.setMatrix4x4(ki.UNIFORM_COLORMAT,Zt.TEMP),s.TEMP.setValue(this._alpha[0],this._alpha[1],this._alpha[2],this._alpha[3]),u.shaderData.setVector(ki.UNIFORM_COLORALPHA,s.TEMP),u.size=new Gt(a,n),u.textureHost=t,o.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,u,null),o.renderEnd()}gray(){return this.setByMatrix(Xn)}color(e=0,t=0,i=0,r=1){return this.setByMatrix([e,0,0,0,1,0,t,0,0,1,0,0,i,0,1,0,0,0,r,0])}setColor(e){var t=Ai.create(e).arrColor,i=[0,0,0,0,256*t[0],0,0,0,0,256*t[1],0,0,0,0,256*t[2],0,0,0,1,0];return this.setByMatrix(i)}setByMatrix(e){this._matrix!=e&&this._copyMatrix(e);for(var t=0,i=0,r=0;r<20;r++)r%5!=4?this._mat[t++]=e[r]:this._alpha[i++]=e[r];return this.onChange(),this}get type(){return ut.COLOR}get typeDefine(){return ki.FILTERCOLOR}adjustColor(e,t,i,r){return this.adjustHue(r),this.adjustContrast(t),this.adjustBrightness(e),this.adjustSaturation(i),this}adjustBrightness(e){return 0==(e=this._clampValue(e,100))||isNaN(e)?this:this._multiplyMatrix([1,0,0,0,e,0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])}adjustContrast(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t,i=(t=e<0?127+e/100*127:127*(t=0==(t=e%1)?Yn[e]:Yn[e<<0]*(1-t)+Yn[1+(e<<0)]*t)+127)/127,r=.5*(127-t);return this._multiplyMatrix([i,0,0,0,r,0,i,0,0,r,0,0,i,0,r,0,0,0,1,0,0,0,0,0,1])}adjustSaturation(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t=1+(e>0?3*e/100:e/100),i=1-t,r=.3086*i,s=.6094*i,a=.082*i;return this._multiplyMatrix([r+t,s,a,0,0,r,s+t,a,0,0,r,s,a+t,0,0,0,0,0,1,0,0,0,0,0,1])}adjustHue(e){if(0==(e=this._clampValue(e,180)/180*Math.PI)||isNaN(e))return this;var t=Math.cos(e),i=Math.sin(e),r=.213,s=.715,a=.072;return this._multiplyMatrix([r+t*(1-r)+i*-r,s+t*-s+i*-s,a+t*-a+i*(1-a),0,0,r+t*-r+.143*i,s+t*(1-s)+.14*i,a+t*-a+-.283*i,0,0,r+t*-r+-.787*i,s+t*-s+i*s,a+t*(1-a)+i*a,0,0,0,0,0,1,0,0,0,0,0,1])}reset(){return this.setByMatrix(this._copyMatrix(qn))}_multiplyMatrix(e){var t=[];this._matrix=this._fixMatrix(this._matrix);for(var i=0;i<5;i++){for(var r=0;r<5;r++)t[r]=this._matrix[r+5*i];for(r=0;r<5;r++){for(var s=0,a=0;a<5;a++)s+=e[r+5*a]*t[a];this._matrix[r+5*i]=s}}return this.setByMatrix(this._matrix)}_clampValue(e,t){return Math.min(t,Math.max(-t,e))}_fixMatrix(e=null){return null==e?qn:(e.length<25?e=e.slice(0,e.length).concat(qn.slice(e.length,25)):e.length>25&&(e=e.slice(0,25)),e)}_copyMatrix(e){this._matrix||(this._matrix=[]);for(var t=0;t<25;t++)this._matrix[t]=e[t];return this._matrix}onAfterDeserialize(){let e=Ai.create(this._color||"#FFFFFF").arrColor;this.color(e[0],e[1],e[2],e[3]),this.adjustColor(this._brightness||0,this._contrast||0,this._saturation||0,this._hue||0)}}class Kn extends ut{constructor(e,t=4,i=6,r=6){super(),this._sv_blurInfo1=new Array(4),this._sv_blurInfo2=[0,0,1,0],this._flipY=!1,this._color=new Ai(e||"#000"),this.blur=Math.min(t,20),this.offX=i,this.offY=r,this._sv_blurInfo1[1]=this.blur,this.shaderDataBlur=new Rn,this.shaderDataBlur.u_blurInfo1=new s,this.shaderDataBlur.u_blurInfo2=new s,this.shaderDataBlur.color=new s,this.shaderDataBlur.size=new Gt,this.shaderDataBlur.blurInfo=new Gt,this.shaderDataCopy=new Rn,this.shaderDataCopy.size=new Gt,this.shaderDataCopy1=new Rn}_fillQuad(e,t,i,r,s=!1){let a;a=s?[0,1,1,0]:[0,0,1,1];let n=this._rectMeshVB,o=this._rectMesh.vertexDeclarition.vertexStride/4;n[0]=e,n[1]=t,n[2]=a[0],n[3]=a[1],n[o]=e+i,n[o+1]=t,n[o+2]=a[2],n[o+3]=a[1],n[2*o]=e+i,n[2*o+1]=t+r,n[2*o+2]=a[2],n[2*o+3]=a[3],n[3*o]=t,n[3*o+1]=t+r,n[3*o+2]=a[0],n[3*o+3]=a[3]}useFlipY(e){super.useFlipY(e),this._flipY=e}render(t,i,r){this.left=-50,this.top=-50;let s=i+100,a=r+100;this.width=s,this.height=a,this.textureExtend&&!this.textureExtend.destroyed&&this.textureExtend.width==s&&this.textureExtend.height==a||(this.textureExtend&&this.textureExtend.destroy(),this.textureExtend=new pe(s,a,e.RenderTargetFormat.R8G8B8A8),this.textureExtend._invertY=g.renderEngine._screenInvertY);let n=this._render2D.clone(this.textureExtend);n.renderStart(!0,new m(0,0,0,0)),this.shaderDataCopy1.size=new Gt(s,a),this.shaderDataCopy1.textureHost=t,this._fillQuad(50,50,t.width,t.height,this._flipY),n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,this.shaderDataCopy1,null),n.renderEnd(),this.texture&&!this.texture.destroyed&&this.texture.width==s&&this.texture.height==a||(this.texture&&this.texture.destroy(),this.texture=new pe(s,a,e.RenderTargetFormat.R8G8B8A8)),n=n.clone(this.texture),n.renderStart(!0,new m(0,0,0,0)),this._fillQuad(0,0,s,a,!0);let o=this.shaderDataBlur;o.shaderData.addDefine(ki.FILTERGLOW);let h=o.size;h.setValue(s,a),o.size=h,o.textureHost=this.textureExtend;let l=o.blurInfo;l.setValue(s,a),o.blurInfo=l;let u=o.u_blurInfo1;u.setValue(this._sv_blurInfo1[0],this._sv_blurInfo1[1],this._sv_blurInfo1[2],this._sv_blurInfo1[3]),o.u_blurInfo1=u;let d=o.u_blurInfo2;d.setValue(t.width,t.height,this._sv_blurInfo2[2],this._sv_blurInfo2[3]),o.u_blurInfo2=d;let c=this.getColor(),_=o.color;_.setValue(c[0],c[1],c[2],c[3]),o.color=_,n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,o,null);let p=this.shaderDataCopy;h=p.size,h.setValue(s,a),p.size=h,p.textureHost=t,this._fillQuad(50,50,t.width,t.height,this._flipY),n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,p,null),n.renderEnd()}get typeDefine(){return ki.FILTERGLOW}get offY(){return this._sv_blurInfo1[3]}set offY(e){this._sv_blurInfo1[3]=e,this.onChange()}get offX(){return this._sv_blurInfo1[2]}set offX(e){this._sv_blurInfo1[2]=e,this.onChange()}get color(){return this._color.strColor}set color(e){this._color=new Ai(e),this.onChange()}getColor(){return this._color.arrColor}get blur(){return this._sv_blurInfo1[1]}set blur(e){this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=e,this.onChange()}}class $n extends ua{constructor(){super(),this._loop=1,this.on(c.ADDED,this,this._onParentChange),this.on(c.REMOVED,this,this._onParentChange)}get source(){return this._source}set source(e){this._source=e,e?this._autoPlay&&(!this._channel||this._channel.isStopped)&&p.isPlaying&&this.play():this.stop()}get isMusic(){return this._isMusic}set isMusic(e){this._isMusic=e}get loop(){return this._loop}set loop(e){this._loop=e}get autoPlay(){return this._autoPlay}set autoPlay(e){this._autoPlay=e,e&&this._source&&(!this._channel||this._channel.isStopped)&&p.isPlaying&&this.play()}_onParentChange(){this.target=this.parent}play(e,t){this._source&&((null==e||isNaN(e))&&(e=this._loop),this.stop(),this._isMusic?this._channel=Sn.playMusic(this._source,e,t):this._channel=Sn.playSound(this._source,e,t))}stop(){this._channel&&!this._channel.isStopped&&this._channel.stop(),this._channel=null}_setPlayAction(e,t,i,r=!0){this[i]&&e&&(r?e.on(t,this,this[i]):e.off(t,this,this[i]))}_setPlayActions(e,t,i,r=!0){if(!e)return;if(!t)return;let s=t.split(","),a=s.length;for(let t=0;t<a;t++)this._setPlayAction(e,s[t],i,r)}set playEvent(e){this._playEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"play")}set target(e){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=e,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}set stopEvent(e){this._stopEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"stop")}}class Qn extends M{set updateFrame(e){this._frameDelty=1/e*1e3,this._updateFrame=e}get updateFrame(){return this._updateFrame}set useFrame(e){this._useFrame=e}get useFrame(){return this._useFrame}constructor(){let t=h.Browser.createElement("video");super(t.videoWidth,t.videoHeight,e.RenderTargetFormat.R8G8B8),this._requestVideoFrame=!1,this._lastTimer=0,this._frameRender=!0,this._isLoaded=!1,this._needUpdate=!1,this.immediatelyPlay=!1,this.element=t,this.useFrame=!1,this.updateFrame=30,this._listeningEvents={},this._dimension=e.TextureDimension.Tex2D;var i=this.element.style;if(i.position="absolute",i.top="0px",i.left="0px",t.setAttribute("crossorigin","anonymous"),h.Browser.onMobile&&(t["x5-playsInline"]=!0,t["x5-playsinline"]=!0,t.x5PlaysInline=!0,t.playsInline=!0,t["webkit-playsInline"]=!0,t["webkit-playsinline"]=!0,t.webkitPlaysInline=!0,t.playsinline=!0,t.style.playsInline=!0,t.crossOrigin="anonymous",t.setAttribute("playsinline","true"),t.setAttribute("x5-playsinline","true"),t.setAttribute("webkit-playsinline","true"),t.autoplay=!0),t.addEventListener("loadedmetadata",(()=>{this.loadedmetadata()})),"requestVideoFrameCallback"in HTMLVideoElement.prototype){const r=this;function s(){r._needUpdate=!0,t.requestVideoFrameCallback(s)}t.requestVideoFrameCallback(s),this._requestVideoFrame=!0}else this._needUpdate=!0}isNeedUpdate(){if(this.useFrame){let e=I.now();return e-this._lastTimer>this._frameDelty&&(this._lastTimer=e,!0)}return!this._requestVideoFrame||this._needUpdate}loadedmetadata(){this._isLoaded||(this._width=this.element.videoWidth,this._height=this.element.videoHeight,I.onLayaRuntime?this._texture=g.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,e.TextureFormat.R8G8B8A8,!1,!1,!1):this._texture=g.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,e.TextureFormat.R8G8B8,!1,!1,!1),this.wrapModeU=e.WrapMode.Clamp,this.wrapModeV=e.WrapMode.Clamp,this.filterMode=e.FilterMode.Bilinear,g.textureContext.initVideoTextureData(this._texture),this._texture.gammaCorrection=2.2,this.immediatelyPlay&&this.play(),this._isLoaded=!0,this.event(c.READY,this))}get gammaCorrection(){return 2.2}get source(){return this._source}set source(e){this._source=e,e&&U.inst.resolveURL(e,(e=>{for(;this.element.childElementCount;)this.element.firstChild.remove();e.startsWith("blob:")?this.element.src=e:this.appendSource(e)}))}appendSource(e){var t=h.Browser.createElement("source");t.src=k.postFormatURL(k.formatURL(e));let i=O.getFileExtension(e);t.type="m3u8"==i?"application/vnd.apple.mpegurl":"video/"+i,this.element.appendChild(t)}render(){0!=this.element.readyState&&(this.isNeedUpdate()||I.onLayaRuntime)&&(g.textureContext.updateVideoTexture(this._texture,this.element,!1,!1),this._needUpdate=!1,this.event(Qn.videoEvent_update))}get frameRender(){return this._frameRender}set frameRender(e){this._frameRender&&!e&&h.timer.clear(this,this.render),!this._frameRender&&e&&h.timer.frameLoop(1,this,this.render),this._frameRender=e}play(){this._texture?(this.element.play().catch((()=>{this.event("NotAllowedError")})),this._frameRender&&h.timer.frameLoop(1,this,this.render)):this.immediatelyPlay=!0}_getSource(){return this._texture?this._texture.resource:null}get defaultTexture(){return _e.whiteTexture}pause(){this.element.pause(),this._frameRender&&h.timer.clear(this,this.render)}load(){this.element.load()}canPlayType(e){return e="m3u8"==e?"application/vnd.apple.mpegurl":"video/"+e,this.element.canPlayType(e)}get buffered(){return this.element.buffered}get currentSrc(){return this.element.currentSrc}get currentTime(){return this.element.currentTime}set currentTime(e){this.element&&(this.element.currentTime=e,this.render())}get volume(){return this.element.volume}set volume(e){this.element&&(this.element.volume=e)}get readyState(){return this.element.readyState}get videoWidth(){return this.element.videoWidth}get videoHeight(){return this.element.videoHeight}get duration(){return this.element.duration}get ended(){return this.element.ended}get error(){return this.element.error}get loop(){return this.element.loop}set loop(e){this.element&&(this.element.loop=e)}get playbackRate(){return this.element.playbackRate}set playbackRate(e){this.element&&(this.element.playbackRate=e)}get muted(){return this.element.muted}set muted(e){this.element&&(this.element.muted=e)}get paused(){return this.element.paused}get preload(){return this.element.preload}set preload(e){this.element&&(this.element.preload=e)}get seekable(){return this.element.seekable}get seeking(){return this.element.seeking}onStartListeningToType(e){if(Zn.has(e)){let t=this._listeningEvents[e];t||(t=this._listeningEvents[e]=()=>{this.event(e)}),this.element.addEventListener(e,t)}}destroy(){if(this.element)if(p.isConch)this.element._destroy();else for(this.element.pause(),this.element.src="";this.element.childElementCount;)this.element.firstChild.remove();h.timer.clear(this,this.render),super.destroy()}}Qn.videoEvent_update="videoUpdate";const Zn=new Set(["abort","canplay","canplaythrough","durationchange","emptied","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting","ended"]);class Jn extends ua{constructor(){if(super(),this.texture=this._internalTex=new fe,p.isPlaying&&h.Browser.onMobile){let e=()=>{h.Browser.document.removeEventListener("touchend",e),this._videoTexture&&(I.onIOS?this._videoTexture.load():(this._videoTexture.play(),this._videoTexture.pause()))};h.Browser.document.addEventListener("touchend",e)}}get videoTexture(){return this._videoTexture}set videoTexture(e){this._videoTexture&&(this._videoTexture._removeReference(),this._videoTexture.off(c.READY,this,this.onVideoMetaLoaded),this._videoTexture.off(Qn.videoEvent_update,this,this._repaintCachAs)),this._videoTexture=e,e?(this._videoTexture._addReference(),this._videoTexture.on(c.READY,this,this.onVideoMetaLoaded),this._videoTexture._isLoaded&&this._internalTex.setTo(this._videoTexture)):this._internalTex.setTo(null),this._checkCachAs()}get source(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.source}set source(e){e?(this._videoTexture||(this.videoTexture=new Qn),this._videoTexture.source=e):this._videoTexture&&(this._videoTexture.source=e),this._checkCachAs()}_checkCachAs(){null!=this.videoTexture&&this.videoTexture.on(Qn.videoEvent_update,this,this._repaintCachAs)}_repaintCachAs(){("none"!=this.cacheAs||this._getCacheStyle().mask)&&this.repaint()}load(e){this.source=e}play(){this._videoTexture&&this._videoTexture.play()}pause(){this._videoTexture&&this._videoTexture.pause()}reload(){this._videoTexture&&this._videoTexture.load()}canPlayType(e){return this._videoTexture||(this.videoTexture=new Qn),this._videoTexture.canPlayType(e)}onVideoMetaLoaded(){this._internalTex.setTo(this._videoTexture)}get buffered(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.buffered}get currentSrc(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.currentSrc}get currentTime(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.currentTime}set currentTime(e){this._videoTexture&&(this._videoTexture.currentTime=e)}get volume(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.volume}set volume(e){this._videoTexture&&(this._videoTexture.volume=e)}get readyState(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.readyState}get videoWidth(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.videoWidth}get videoHeight(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.videoHeight}get duration(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.duration}get ended(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.ended}get error(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.error}get loop(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.loop}set loop(e){this._videoTexture&&(this._videoTexture.loop=e)}get playbackRate(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.playbackRate}set playbackRate(e){this._videoTexture&&(this._videoTexture.playbackRate=e)}get muted(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.muted}set muted(e){this._videoTexture&&(this._videoTexture.muted=e)}get paused(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.paused}get preload(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.preload}set preload(e){this._videoTexture&&(this._videoTexture.preload=e)}get seekable(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.seekable}get seeking(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.seeking}_transChanged(t){if(super._transChanged(t),this._videoTexture)if(p.isConch){if(0!=(t&e.TransformKind.Pos)){let e=ea.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.left=e.x,this._videoTexture.element.style.top=e.y}else if(0!=(t&e.TransformKind.Size)){let e=ea.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.width=this._width*e.scaleX,this._videoTexture.element.height=this._height*e.scaleY}}else this._videoTexture.element.width=this._width/h.Browser.pixelRatio,this._videoTexture.element.height=this._height/h.Browser.pixelRatio}destroy(e=!0){this.videoTexture=null,super.destroy(e)}}class eo{get duration(){return this._duration}get animatorState(){return this._currentState}constructor(){this._currentState=null,this._frontPlay=!0}_resetPlayState(e,t){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._lastIsFront=!0,this._parentPlayTime=null,this._playNum=0,this._playAllTime=0;var i=this._elapsedTime/t%1;this._normalizedPlayTime=i<0?i+1:i,this._frontPlay=!0}_cloneTo(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._playNum=this._playNum,e._parentPlayTime=this._parentPlayTime,e._normalizedPlayTime=this._normalizedPlayTime,e._lastIsFront=this._lastIsFront,e._frontPlay=this._frontPlay,e._playAllTime=this._playAllTime}}class to{constructor(e){this._referenceCount=0,this._playStateInfo=new eo,this._crossPlayStateInfo=new eo,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.playOnWake=!0,this.defaultWeight=1,this.blendingMode=to.BLENDINGMODE_OVERRIDE,this.enable=!0,this._states=[],this._playType=-1,this.name=e}get states(){return this._states}set states(e){if(this._states!==e){for(let e=this.states.length-1;e>=0;e--)this.removeState(this.states[e]);for(let t=e.length-1;t>=0;t--)this.addState(e[t])}}get defaultStateName(){return this._defaultState?this._defaultState.name:null}set defaultStateName(e){if(this._defaultState=this.getStateByName(e),null==this._defaultState)if(0==this._states.length)this._defaultStateNameCatch=e;else for(var t=this._states.length-1;t>=0;t--)if(this._states[t].name==e){this._defaultState=this._states[t];break}}get defaultState(){return this._defaultState}set defaultState(e){this._defaultState=e}_removeClip(e,t,i){e.splice(t,1)}_getReferenceCount(){return this._referenceCount}_addReference(e){for(var t=0,i=this._states.length;t<i;t++)this._states[t]._addReference(e);this._referenceCount+=e}_removeReference(e=1){for(var t=0,i=this._states.length;t<i;t++)this._states[t]._removeReference(e);this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getStateByName(e){for(let t=this._states.length-1;t>=0;t--)if(this._states[t].name==e)return this._states[t];return null}addState(e){var t=e.name;if(this.getStateByName(t))throw new Error("AnimatorControllerLayer:this stat's name has exist.");this._states.push(e),t==this._defaultStateNameCatch&&(this._defaultState=e,this._defaultStateNameCatch=null)}removeState(e){for(var t=this._states,i=-1,r=0,s=t.length;r<s;r++)if(t[r]===e){i=r;break}-1!=i&&this._removeClip(t,i,e)}clone(){var e=new to(this.name);return this.cloneTo(e),e}cloneTo(e){e.name=this.name}destroy(){this._removeReference();for(var e=0,t=this._states.length;e<t;e++)this._states[e].destroy();this._states.length=0}}var io,ro,so,ao;to.BLENDINGMODE_OVERRIDE=0,to.BLENDINGMODE_ADDTIVE=1,e.AniParmType=void 0,(io=e.AniParmType||(e.AniParmType={}))[io.Float=0]="Float",io[io.Bool=1]="Bool",io[io.Trigger=2]="Trigger",e.AniStateConditionType=void 0,(ro=e.AniStateConditionType||(e.AniStateConditionType={}))[ro.Number=0]="Number",ro[ro.Bool=1]="Bool",ro[ro.Trigger=2]="Trigger",e.AniStateConditionNumberCompressType=void 0,(so=e.AniStateConditionNumberCompressType||(e.AniStateConditionNumberCompressType={}))[so.Less=0]="Less",so[so.Greater=1]="Greater";class no{static parse(e){let t=e,i=t.controllerLayers;null==i&&(i=[]);let r=[];for(let e=i.length-1;e>=0;e--){let s=i[e],a=s.states;a||(a=[],s.states=a),s.defaultStateName=null;let n=this.checkStates(a,r,t);n?s.defaultStateName=n.enterName:i.splice(e,1)}return{ret:t,clipsID:r}}static checkStates(e,t,i){let r=null,s=null;for(let a=e.length-1;a>=0;a--){let n=e[a];n.states?null==this.checkStates(n.states,t,i)?e.splice(a,1):(null==r&&(r=[]),r.push(n)):"-1"==n.id?s=n:"-2"==n.id||"-3"==n.id||(null==n.clip||null==n.clip._$uuid||""==n.clip._$uuid?e.splice(a,1):(0>t.indexOf(n.clip._$uuid)&&t.push(n.clip._$uuid),this.checkNext(n,e,i),null==r&&(r=[]),r.push(n)))}let a=null;if(r&&s){let e=this.checkDefault(s,r);null!=e&&(a={states:r,enterName:e})}return a}static checkNext(e,t,i){let r=e.soloTransitions;if(r)for(let e=r.length-1;e>=0;e--){let s=r[e],a=this.getStateByID(t,s.id);!a||null==a.clip&&"-3"!=a.id&&null==a.states?r.splice(e,1):(s.name=a.name,s.conditions=this.checkConditions(s.conditions,i))}}static checkConditions(t,i){if(!t||0==t.length||null==i.animatorParams||0==i.animatorParams.length)return[];let r=i.animatorParams;for(let i=t.length-1;i>=0;i--){let s=t[i],a=null;for(let e=r.length-1;e>=0;e--)if(r[e].id==s.id){a=r[e];break}if(null==a)t.splice(i,1);else if(s.name=a.name,a.type==e.AniParmType.Float){let e=Number(s.checkValue);isNaN(e)&&(s.checkValue=0),e=Number(s.type),isNaN(e)&&(s.type=0)}}return t}static checkDefault(e,t){let i=e.soloTransitions,r=null;i&&0<i.length&&(r=i[0].id);let s=null;if(null!=r&&(s=this.getStateByID(t,r)),null!=s&&(null!=s.clip||null!=s.states))return s.name;for(let e=t.length-1;e>=0;e--)if(t[e].clip)return t[e].name;return null}static getStateByID(e,t){if(e)for(let i=e.length-1;i>=0;i--)if(e[i].id==t)return e[i];return null}}e.AnimatorUpdateMode=void 0,(ao=e.AnimatorUpdateMode||(e.AnimatorUpdateMode={}))[ao.Normal=0]="Normal",ao[ao.LowFrame=1]="LowFrame",ao[ao.UnScaleTime=2]="UnScaleTime";class oo extends ta{constructor(){super(),this._speed=1,this._updateMode=e.AnimatorUpdateMode.Normal,this._lowUpdateDelty=20,this._isPlaying=!0,this._controllerLayers=[],this._parameters={}}get controller(){return this._controller}set controller(e){this._controller&&this._controller._removeReference(),this._controller=e,e&&(e._addReference(),e.updateTo(this))}get parameters(){return this._parameters}set parameters(e){this._parameters=e}get speed(){return this._speed}set speed(e){this._speed=e}get isPlaying(){return this._isPlaying}_updateStateFinish(e,t){t._finish&&e._eventExit()}_setClipDatasToNode(e,t,i,r=null){for(var s=e._realtimeDatas,a=e._clip._nodes,n=0,o=a.count;n<o;n++)if(null!=s[n]){var h=a.getNodeByIndex(n),l=this.getOwner(h);l&&this._applyFloat(l,t,i,s[n])}}_applyFloat(e,t,i,r){var s=e.pro;s&&s.ower&&(s.ower[s.key]=t&&"number"==typeof r?s.defVal+i*r:"number"==typeof r?i*r:r)}getOwner(e){var t;if(this._ownerMap&&(t=this._ownerMap.get(e)))return t;for(var i=this.owner,r=0,s=e.ownerPathCount;r<s;r++){var a=e.getOwnerPathByIndex(r);if(""!=a&&!(i=i.getChild(a)))break}if(t={ower:i},i){var n=i,o=e.propertyCount;if(1==o){var h=e.getPropertyByIndex(0);t.pro={ower:i,key:h,defVal:i[h]}}else for(var l=0;l<o;l++){h=e.getPropertyByIndex(l);if(l==o-1||null==n){t.pro={ower:n,key:h,defVal:n?n[h]:null};break}if("_gcmds"===h&&null==n[h]&&n.graphics&&(n=n.graphics,h="cmds"),null==n[h]&&i==n){n=null;var u=Oe.getClass(h);u&&(n=i.getComponent(u))}else n=n[h]}}return null==this._ownerMap&&(this._ownerMap=new Map),this._ownerMap.set(e,t),t}_updateClipDatas(e,t,i){var r=e._clip,s=r._duration,a=e.clipStart*s+i._normalizedPlayTime*i._duration,n=e._currentFrameIndices;r._evaluateClipDatasRealTime(a,n,t,!0,e._realtimeDatas)}_updatePlayer(e,t,i,r,s){let a=!1;var n=e._clip._duration*(e.clipEnd-e.clipStart),o=t._elapsedTime;let h=t._playAllTime;t._playAllTime+=Math.abs(i),i=o+i,t._lastElapsedTime=o,t._elapsedTime=i;var l=i/n;let u=1;e.yoyo&&(u=2);let d=t._playAllTime/(n*u);Math.floor(h/(n*u))<Math.floor(d)&&(a=!0);var c=l%1;let _=c<0?c+1:c;if(t._normalizedPlayTime=_,t._duration=n,1!=u&&(_=(c=(l=t._playAllTime/(n*u))%1)<0?c+1:c,e.yoyo&&(.5>_?t._frontPlay||(0>e.speed?(t._elapsedTime=e.clipEnd*h,t._normalizedPlayTime=e.clipEnd):(t._elapsedTime=e.clipStart*h,t._normalizedPlayTime=e.clipStart),t._frontPlay=!0):t._frontPlay&&(t._frontPlay=!1,0>e.speed?(t._elapsedTime=e.clipStart*h,t._normalizedPlayTime=e.clipStart):(t._elapsedTime=e.clipEnd*h,t._normalizedPlayTime=e.clipEnd)))),e._eventStateUpdate(_),!this._applyTransition(s,e._eventtransition(_,this.parameters,a))&&a){let i=t._playAllTime/(n*u);if(0<r&&r<=i)return t._finish=!0,void(0>e.speed?e.yoyo?(t._elapsedTime=e.clipEnd*h,t._normalizedPlayTime=e.clipEnd):(t._elapsedTime=e.clipStart*h,t._normalizedPlayTime=e.clipStart):e.yoyo?(t._elapsedTime=e.clipStart*h,t._normalizedPlayTime=e.clipStart):(t._elapsedTime=e.clipEnd*h,t._normalizedPlayTime=e.clipEnd));e._eventLoop()}}_updateEventScript(e,t){let i=e._clip,r=i._animationEvents;if(!r||0==r.length)return;let s=i._duration,a=t._normalizedPlayTime*s,n=t._frontPlay;0>t._currentState.speed&&(n=!n);let o=t._parentPlayTime,h=t._parentPlayTime;null==h&&(h=n?s*t.animatorState.clipStart:s*t.animatorState.clipEnd),n?a<h&&(this._eventScript(r,h,a,!0),h=s*t.animatorState.clipStart):a>h&&(this._eventScript(r,h,a,!1),h=s*t.animatorState.clipEnd),this._eventScript(r,h,a,n),o==t._parentPlayTime&&(t._parentPlayTime=a)}_eventScript(e,t,i,r){let s=this.owner.components;if(r)for(let r=0,a=e.length;r<a;r++){let a=e[r];if(a.time>t&&a.time<=i)for(let e=0,t=s.length;e<t;e++){let t=s[e];if(t._isScript()){let e=t[a.eventName];e&&e.apply(t,a.params)}}else if(a.time>i)break}else for(let r=e.length-1;r>=0;r--){let a=e[r];if(a.time<t&&a.time>=i)for(let e=0,t=s.length;e<t;e++){let t=s[e];if(t._isScript()){let e=t[a.eventName];e&&e.apply(t,a.params)}}else if(a.time<i)break}}_applyTransition(e,t){return!!t&&this.crossFade(t.destState.name,e,t.transstartoffset,t.transduration)}_applyUpdateMode(t){let i;switch(this._updateMode){case e.AnimatorUpdateMode.Normal:i=t;break;case e.AnimatorUpdateMode.LowFrame:i=dt.loopCount%this._lowUpdateDelty==0?t*this._lowUpdateDelty:0;break;case e.AnimatorUpdateMode.UnScaleTime:i=0}return i}gotoAndStopByFrame(e,t,i){var r=this._controllerLayers[t];if(r){var s=r.getStateByName(e);if(!s||!s._clip)return;let a=i/(s._clip._duration*s._clip._frameRate);1<a&&(a=1),this.gotoAndStop(e,t,a)}}getControllerLayer(e=0){return this._controllerLayers[e]}gotoAndStop(e,t,i){var r=this._controllerLayers[t];if(r){var s=r.getStateByName(e);if(!s||!s._clip)return;var a=r._playStateInfo,n=a._currentState,o=s._clip._duration,h=s._clip._duration*(s.clipEnd-s.clipStart);a._resetPlayState(o*i,h),a._normalizedPlayTime=i,r._playType=0,n!==s&&(a._currentState=s),s._eventStart(this,t);let l=r.blendingMode!=to.BLENDINGMODE_OVERRIDE;this._updateClipDatas(s,l,a),this._setClipDatasToNode(s,l,r.defaultWeight,r),this.stop()}}play(e,t=0,i=Number.NEGATIVE_INFINITY){if(this._checkEnterIndex){let e=this._checkEnterIndex.indexOf(t);0<=e&&this._checkEnterIndex.splice(e,1)}this._isPlaying=!0;var r=this._controllerLayers[t];if(r){var s=r.defaultState;if(!e&&!s)throw new Error("Animator:must have default clip value,please set clip property.");var a=r._playStateInfo,n=a._currentState,o=e?r.getStateByName(e):s;if(!o._clip)return;var h=o._clip._duration,l=o._clip._duration*(o.clipEnd-o.clipStart);n!==o?(i!==Number.NEGATIVE_INFINITY?a._resetPlayState(h*i,l):a._resetPlayState(0,l),r._playType=0,a._currentState=o):i!==Number.NEGATIVE_INFINITY&&(a._resetPlayState(h*i,l),r._playType=0),o._eventStart(this,t)}}stop(){this._isPlaying=!1}onUpdate(){if(this._isPlaying){if(this._checkEnterIndex)for(let t=this._checkEnterIndex.length-1;t>=0;t--){let i=this._checkEnterIndex[t];if(this._controllerLayers[i]._enterTransition.check(0,this.parameters,!0)){var e=this.getDefaultState(i);this.play(null,i,e.cycleOffset)}}var t=this.owner.timer.delta/1e3;if(t=this._applyUpdateMode(t),0!=this.speed&&0!=t)for(var i=0,r=this._controllerLayers.length;i<r;i++){var s=this._controllerLayers[i];if(s.enable){var a=s._playStateInfo,n=s.blendingMode!=to.BLENDINGMODE_OVERRIDE;if(0===s._playType){var o=a._currentState,h=this._speed*o.speed,l=a._finish,u=o.loop;-1>=u&&(u=o._clip.islooping?0:1);let e=1;a._frontPlay||(e=-1),l||this._updatePlayer(o,a,t*h*e,u,i),o=(a=s._playStateInfo)._currentState,this._updateClipDatas(o,n,a),l||(this._setClipDatasToNode(o,n,s.defaultWeight,s),this._updateEventScript(o,a)),l||this._updateStateFinish(o,a)}}}}}addControllerLayer(e){this._controllerLayers.push(e)}crossFade(e,t=0,i=Number.NEGATIVE_INFINITY,r){var s=this._controllerLayers[t];if(s){if(s.getStateByName(e))return this.play(e,t,i),!0;console.warn("Invalid layerIndex "+t+".")}return!1}onAfterDeserialize(){let e=this.controllerLayers;if(e&&null==this.controller){delete this.controllerLayers,this._controllerLayers.length=0;for(let t of e)this.addControllerLayer(t)}}onEnable(){if(this._checkEnterIndex?this._checkEnterIndex.length=0:this._checkEnterIndex=[],this._isPlaying)for(var e=0,t=this._controllerLayers.length;e<t;e++)if(this._controllerLayers[e].playOnWake){var i=this.getDefaultState(e);if(i){let t=this._controllerLayers[e]._enterTransition;t?(this._isPlaying=!0,t.check(0,this.parameters,!0)?this.play(null,e,i.cycleOffset):this._checkEnterIndex.push(e)):this.play(null,e,i.cycleOffset)}}}getDefaultState(e=0){return this._controllerLayers[e].defaultState}setParamsTrigger(t){this._parameters[t]={name:t,type:e.AniParmType.Trigger,value:!0}}setParamsNumber(t,i){this._parameters[t]={name:t,type:e.AniParmType.Float,value:i}}setParamsBool(t,i){this._parameters[t]={name:t,type:e.AniParmType.Float,value:i}}getParamsvalue(e){let t=this._parameters[e];return t?t.value:null}onDestroy(){this._controller&&(this._controller._removeReference(),this._controller=null);for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e].destroy();this._controllerLayers.length=0,this._isPlaying=!1,this._parameters=null}}class ho extends D{constructor(){super(...arguments),this._referenceCount=0,this._clip=null,this._currentFrameIndices=null,this.cycleOffset=0,this.speed=1,this.clipStart=0,this.clipEnd=1,this.loop=-1,this.yoyo=!1,this.transitions=[],this.soloTransitions=[],this._scripts=null,this._realtimeDatas=[]}get clip(){return this._clip}set clip(e){if(this._clip!=e){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e){var t=e._nodes.count;this._currentFrameIndices=new Int16Array(t),this._resetFrameIndices(),this._referenceCount>0&&e._addReference(this._referenceCount),this._realtimeDatas.length=t}this._clip=e}}_eventStateUpdate(e){if(this.event(ho.EVENT_OnStateUpdate,e),this._scripts)for(var t=0,i=this._scripts.length;t<i;t++)this._scripts[t].onStateUpdate(e)}_eventStart(e,t){if(this.event(ho.EVENT_OnStateEnter),this._scripts)for(var i=0,r=this._scripts.length;i<r;i++)this._scripts[i].setPlayScriptInfo(e,t,this),this._scripts[i].onStateEnter()}_eventExit(){if(this.event(ho.EVENT_OnStateExit),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateExit()}_eventLoop(){if(this.event(ho.EVENT_OnStateLoop),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateLoop&&this._scripts[e].onStateLoop()}_eventtransition(e,t,i){let r=this.soloTransitions.length;if(r>0){for(var s=0;s<r;s++)if(this.soloTransitions[s].check(e,t,i))return this.soloTransitions[s];return null}let a=this.transitions.length;for(s=0;s<a;s++)if(this.transitions[s].check(e,t,i))return this.transitions[s];return null}_resetFrameIndices(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}_getReferenceCount(){return this._referenceCount}_addReference(e){this._clip&&this._clip._addReference(e),this._referenceCount+=e}_removeReference(e){this._clip&&this._clip._removeReference(e),this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}addScript(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}getScript(e){if(this._scripts)for(var t=0,i=this._scripts.length;t<i;t++){var r=this._scripts[t];if(r instanceof e)return r}return null}getScripts(e){var t=null;if(this._scripts)for(var i=0,r=this._scripts.length;i<r;i++){var s=this._scripts[i];s instanceof e&&(t=t||[]).push(s)}return t}clone(){var e=new ho;return this.cloneTo(e),e}cloneTo(e){e.name=this.name,e.speed=this.speed,e.clip=this._clip}destroy(){this._clip=null,this._currentFrameIndices=null,this._scripts=null,this._realtimeDatas.length=0}}ho.EVENT_OnStateEnter="OnStartEnter",ho.EVENT_OnStateUpdate="OnStateUpdate",ho.EVENT_OnStateExit="OnStateExit",ho.EVENT_OnStateLoop="OnStateLoop";class lo{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(e){this._ownerPath.length=e}_setOwnerPathByIndex(e,t){this._ownerPath[e]=t}_setPropertyCount(e){this._propertys.length=e}_setPropertyByIndex(e,t){this._propertys[e]=t}_setKeyframeCount(e){this._keyFrames.length=e}_joinOwnerPath(e){return this._ownerPath.join(e)}_joinProperty(e){return this._propertys.join(e)}getKeyframeByIndex(e){return this._keyFrames[e]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}getOwnerPathByIndex(e){return this._ownerPath[e]}getPropertyByIndex(e){return this._propertys[e]}}class uo{clone(){var e=new uo;return this.cloneTo(e),e}cloneTo(e){e.time=this.time}}uo.defaultWeight=.33333;class co{constructor(){}}class _o{static READ_DATA(){this._DATA.offset=this._reader.getUint32(),this._DATA.size=this._reader.getUint32()}static READ_BLOCK(){for(var e=this._BLOCK.count=this._reader.getUint16(),t=this._BLOCK.blockStarts=[],i=this._BLOCK.blockLengths=[],r=0;r<e;r++)t.push(this._reader.getUint32()),i.push(this._reader.getUint32())}static READ_STRINGS(){var e=this._reader.getUint32(),t=this._reader.getUint16(),i=this._reader.pos;this._reader.pos=e+this._DATA.offset;for(var r=0;r<t;r++)this._strings[r]=this._reader.readUTFString();this._reader.pos=i}static parse(e,t,i){this._clip=e,this._reader=t,this._version=i,this.READ_DATA(),this.READ_BLOCK(),this.READ_STRINGS();for(var r=0,s=this._BLOCK.count;r<s;r++){var a=t.getUint16(),n=this._strings[a],o=this["READ_"+n];if(!o)throw new Error("model file err,no this function:"+a+" "+n);o.call(this)}this._version=null,this._reader=null,this._clip=null,this._strings.length=0}static timeToFrame(e,t){return Math.round(e*t)}static READ_ANIMATIONS2D(){var e,t,i,r=this._reader,s=this._clip,a=[],n=r.getUint16();for(a.length=n,e=0;e<n;e++)a[e]=r.getFloat32();s._duration=a[r.getInt16()],s.islooping=!!r.getByte(),s._frameRate=r.getInt16();var o=r.getInt16(),h=s._nodes;h.count=o;var l=s._nodesMap={},u=s._nodesDic={};for(e=0;e<o;e++){i=new lo,h.setNodeByIndex(e,i),i._indexInList=e;var d=r.getUint16();for(i._setOwnerPathCount(d),t=0;t<d;t++)i._setOwnerPathByIndex(t,this._strings[r.getUint16()]);var c=i._joinOwnerPath("/"),_=l[c];_||(l[c]=_=[]),_.push(i);var p=r.getUint16();for(i._setPropertyCount(p),t=0;t<p;t++)i._setPropertyByIndex(t,this._strings[r.getUint16()]);var g=c+"."+i._joinProperty(".");u[g]=i,i.fullPath=g,i.nodePath=c;var m=r.getUint16();for(t=0;t<m;t++){var f=new uo;f.time=a[r.getUint16()],f.data={f:this.timeToFrame(f.time,s._frameRate),val:0},1==r.getByte()&&(f.data.tweenType=this._strings[r.getUint16()]),1==r.getByte()&&(f.data.tweenInfo={},f.data.tweenInfo.inTangent=a[r.getUint16()],f.data.tweenInfo.outTangent=a[r.getUint16()],1==r.getByte()&&(f.data.tweenInfo.inWeight=a[r.getUint16()]),1==r.getByte()&&(f.data.tweenInfo.outWeight=a[r.getUint16()]));var T=r.getByte();if(0==T?f.data.val=a[r.getUint16()]:1==T?f.data.val=this._strings[r.getUint16()]:2==T&&(f.data.val=!!r.getByte()),1==r.getByte())try{f.data.extend=JSON.parse(this._strings[r.getUint16()])}catch(e){}i._keyFrames.push(f)}}var y=r.getUint16();for(e=0;e<y;e++){var x=new co;x.time=a[r.getUint16()],x.eventName=this._strings[r.getUint16()];var v=[],S=r.getUint16();for(S>0&&(x.params=v=[]),t=0;t<S;t++){switch(r.getByte()){case 0:v.push(!!r.getByte());break;case 1:v.push(r.getInt32());break;case 2:v.push(a[r.getUint16()]);break;case 3:v.push(this._strings[r.getUint16()]);break;default:throw new Error("unknown type.")}}s.addEvent(x)}}}_o._strings=[],_o._DATA={offset:0,size:0},_o._BLOCK={count:0};class po{constructor(){this._nodes=[]}get count(){return this._nodes.length}set count(e){this._nodes.length=e}getNodeByIndex(e){return this._nodes[e]}setNodeByIndex(e,t){this._nodes[e]=t}}class go extends A{static _parse(e){var t=new go,i=new Y(e),r=i.readUTFString();if("LAYAANIMATION2D:01"!==r)throw"unknown animationClip version.";return _o.parse(t,i,r),t}constructor(){super(),this._nodes=new po,this._animationEvents=[]}duration(){return this._duration}_evaluateClipDatasRealTime(e,t,i,r,s){for(var a=this._nodes,n=0,o=a.count;n<o;n++){var h,l=a.getNodeByIndex(n)._keyFrames,u=l.length;if(0!=u){var d=t[n];if(r)for(-1!=d&&e<l[d].time&&(d=-1,t[n]=d),h=d+1;h<u&&!(l[h].time>e);)d++,h++,t[n]=d;else for((h=d+1)!=u&&e>l[h].time&&(d=u-1,t[n]=d),h=d+1;d>-1&&!(l[d].time<e);)d--,h--,t[n]=d;var c=h==u;if(-1!=d){var _=l[d];if(c)s[n]=_.data.val;else{var p,g=l[h],m=g.time-_.time;p=0!==m?(e-_.time)/m:0,s[n]=this._getTweenVal(_,g,p,m)}}else s[n]=l[0].data.val;i&&"number"==typeof l[0].data.val&&(s[n]=s[n]-l[0].data.val)}}}_getTweenVal(e,t,i,r){var s=e.data,a=t.data;if("number"!=typeof s.val||"number"!=typeof a.val)return s.val;var n=function(e){if(!e)return null;let t=mo[e];t||(e=(e=e.replace("_Ease","")).charAt(0).toLowerCase()+e.substring(1),t=Ms[e],null!=t&&(mo[e]=t));return t}(s.tweenType),o=s.val,h=a.val;if(null!=n)return n(i,o,h-o,1);var l,u=0,d=0,c=NaN,_=NaN;return null!=s.tweenInfo&&(u=s.tweenInfo.outTangent,c=s.tweenInfo.outWeight),null!=a.tweenInfo&&(d=a.tweenInfo.inTangent,_=a.tweenInfo.inWeight),(isNaN(c)||0>=c)&&(c=uo.defaultWeight),(isNaN(_)||0>=_)&&(_=uo.defaultWeight),isNaN(u)&&(u=0),isNaN(d)&&(d=0),Math.abs(u)==Number.MAX_VALUE&&(u=0>u?-1/0:1/0),Math.abs(d)==Number.MAX_VALUE&&(d=0>d?-1/0:1/0),l=!s.tweenInfo&&!a.tweenInfo||uo.defaultWeight==_&&uo.defaultWeight==c?function(e,t,i,r,s,a){if(Math.abs(e)==1/0||Math.abs(t)==1/0)return i;var n=s*s,o=n*s,h=o-2*n+s,l=o-n;return(2*o-3*n+1)*i+h*e*a+l*t*a+(-2*o+3*n)*r}(u,d,o,h,i,r):this.hermiteCurveSplineWeight(o,e.time,c,u,h,t.time,_,d,i),l}_binarySearchEventIndex(e){for(var t,i=0,r=this._animationEvents.length-1;i<=r;){t=i+r>>1;var s=this._animationEvents[t].time;if(s==e)return t;s>e?r=t-1:i=t+1}return i}hermiteCurveSplineWeight(e,t,i,r,s,a,n,o,h){let l=222e-18,u=h,d=e,c=i,_=n,p=a-t,g=s-d;g=Math.max(Math.abs(g),l)*(g<0?-1:1);let m=r,f=o;if(!Number.isFinite(m)||!Number.isFinite(f))return e;m=m*p/g,f=f*p/g;let T=1-_,y=.5,x=0;if(Math.abs(c-.33333334)<1e-4&&Math.abs(_-.33333334)<1e-4)y=u,x=1-y;else for(;;){x=1-y;let e=3*x*x*y*c+3*x*y*y*T+y*y*y-u;if(Math.abs(e)<=2.5*l)break;let t=3*x*x*c+6*x*y*(T-c)+3*y*y*(1-T),i=6*x*(T-2*c)+6*y*(1-2*T+c);y-=(6*e*t*t-3*e*e*i)/(6*t*t*t-6*e*t*i+e*e*(18*c-18*T+6))}return(3*x*x*y*c*m+3*x*y*y*(1-_*f)+y*y*y)*g+d}addEvent(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}}const mo={};class fo{}var To;e.AniConditionType=void 0,(To=e.AniConditionType||(e.AniConditionType={}))[To.Greater=0]="Greater",To[To.Less=1]="Less",To[To.Equals=2]="Equals",To[To.NotEqual=3]="NotEqual";class yo{}class xo extends A{constructor(){super(!1),this._traceDeps=!0}onLoad(){return A._idResourcesMap[this._id]=this,this}create(e,t){return null}}var vo,So=xo;class Do{static conditionNameToID(e){if(null!=Do._conditionNameMap[e])return Do._conditionNameMap[e];var t=this._propertyNameCounter++;return this._conditionNameMap[e]=t,this._conditionNameMap[t]=e,t}static conditionIDToName(e){return this._conditionNameMap[e]}constructor(e=null){e&&(this._id=Do.conditionNameToID(e),this._name=e)}get id(){return this._id}get name(){return this._name}set name(e){this._id=Do.conditionNameToID(e),this._name=e}get type(){return this._type}checkState(e){return!1}}Do._conditionNameMap={},Do._propertyNameCounter=0;class Eo extends Do{constructor(t){super(t),this._numberValue=0,this._numberCompareFlag=e.AniStateConditionNumberCompressType.Greater,this._type=e.AniStateConditionType.Number}get numberValue(){return this._numberValue}set numberValue(e){this._numberValue=e}get compareFlag(){return this._numberCompareFlag}set compareFlag(e){this._numberCompareFlag=e}checkState(t){return e.AniStateConditionNumberCompressType.Greater==this._numberCompareFlag?t>this._numberValue:t<this._numberValue}}class wo extends Do{constructor(t){super(t),this._compareFlag=!0,this._type=e.AniStateConditionType.Bool}get compareFlag(){return this._compareFlag}set compareFlag(e){this._compareFlag=e}checkState(e){return this._compareFlag==e}}class Ro extends Do{constructor(t){super(t),this._type=e.AniStateConditionType.Trigger}checkState(e){return e}}class Co{constructor(){this.conditions=[],this.exitByTime=!0,this.exitTime=1,this.transduration=0,this.transstartoffset=0,this.mute=!1}addCondition(e){-1==this.conditions.indexOf(e)&&this.conditions.push(e)}removeCondition(e){let t=this.conditions.indexOf(e);-1!=t&&this.conditions.splice(t,0)}check(t,i,r){if(this.mute)return!1;if(this.exitByTime&&t<this.exitTime&&!r)return!1;if(null==this.conditions||0==this.conditions.length)return!0;if(this.isAndOperEnabled){let t;for(var s=0;s<this.conditions.length;s++){let r=this.conditions[s];if(!r.checkState(i[r.name].value))return!1;r.type==e.AniStateConditionType.Trigger&&t.push(r.name)}return!0}for(s=0;s<this.conditions.length;s++){let t=this.conditions[s];if(t.checkState(i[t.name].value))return t.type==e.AniStateConditionType.Trigger&&(i[t.name].value=!1),!0}return!1}}class Ao extends A{constructor(e){super();let t=no.parse(e);this.data=t.ret,this.clipsID=t.clipsID}getLayers(){let e=this.data.controllerLayers,t=[];for(let i=e.length-1;i>=0;i--){let r=e[i],s=new to(r.name);t.unshift(s);for(let e in r)if("name"!=e&&"states"!=e&&null!=r[e])try{s[e]=r[e]}catch(e){console.error(e)}this.getState(r.states,s,this.data)}return t}createState(e,t,i){if(!e)return null;let r={},s=null;for(let a=e.length-1;a>=0;a--){let n=e[a],o=n.states;if(o){let e=this.createState(o,t,i);e&&(t[n.id]=e.states[e.id]);continue}if(0>Number(n.id)){if("-1"==n.id){let e=n.soloTransitions;e&&0<e.length&&(s=e[0].id)}continue}let h=new ho;t[n.id]=h,r[n.id]=h;for(let e in n)try{if("scripts"==e){let t=n[e];if(t&&Array.isArray(t))for(let e=t.length-1;e>=0;e--){let i=t[e];i&&0==i.indexOf("res://")&&(i=i.substring(6));let r=Oe.getClass(i);r&&h.addScript(r)}continue}if("soloTransitions"==e)continue;null!=n[e]&&(h[e]=n[e])}catch(e){}i.addState(h)}return{id:s,states:r}}getState(e,t,i){if(e){let r={};this.createState(e,r,t),this.setTransitions(e,r,t,i)}}setExitTransition(e,t,i,r,s){for(let a in e){let n=i[a];if(n){let o=n.transitions,h=n.soloTransitions,l=e[a];for(let e=t.length-1;e>=0;e--){let n=t[e];if("-3"!=n.id)for(let e=l.length-1;e>=0;e--){let t=l[e],s=new Co;s.destState=i[n.id],n.conditions&&this.addConditions(n.conditions,s,r),t.conditions&&this.addConditions(t.conditions,s,r);for(let e in n)"solo"!=e&&"id"!=e&&"conditions"!=e&&(s[e]=n[e]);n.solo?h.unshift(s):o.unshift(s)}else null==s[a]&&(s[a]=[]),s[a].push(n)}}}}_getAnimatorTransition2D(e,t,i){let r=new Co;t[e.id]&&(r.destState=t[e.id]),e.conditions&&this.addConditions(e.conditions,r,i);for(let t in e)"solo"!=t&&"id"!=t&&"conditions"!=t&&(r[t]=e[t]);return r}setTransitions(e,t,i,r,s){if(!e)return null;let a={};for(let s=e.length-1;s>=0;s--){let n=e[s];if(n.states){let e=this.setTransitions(n.states,t,i,r,n);if(e){let i=n.soloTransitions;i&&this.setExitTransition(e,i,t,r,a)}}}for(let n=e.length-1;n>=0;n--){let o=e[n];if(o.states)continue;if("-1"==o.id){if(o.soloTransitions&&0<o.soloTransitions.length){null==s?(i.defaultState=t[o.soloTransitions[0].id],i._enterTransition=this._getAnimatorTransition2D(o.soloTransitions[0],t,r)):t[s.id]=t[o.soloTransitions[0].id];continue}}else{if("-2"==o.id){let e=o.soloTransitions;if(e)for(let i=e.length-1;i>=0;i--){let s=e[i];if(t[s.id])for(let e in t){let i=t[e],a=this._getAnimatorTransition2D(s,t,r);s.solo?i.soloTransitions.unshift(a):i.transitions.unshift(a)}}continue}if("-3"==o.id)continue}let h=o.soloTransitions;if(h&&t[o.id]){let e=t[o.id].transitions,i=t[o.id].soloTransitions;for(let s=h.length-1;s>=0;s--){let n=h[s];if("-3"==n.id){null==a[o.id]&&(a[o.id]=[]),a[o.id].push(n);continue}let l=this._getAnimatorTransition2D(n,t,r);n.solo?i.unshift(l):e.unshift(l)}}}return a}addConditions(t,i,r){let s=r.animatorParams;if(null!=s&&0!=s.length)for(let r=0,a=t.length;r<a;r++){let a,n=t[r],o=null;for(let e=s.length-1;e>=0;e--)if(s[e].id==n.id){o=s[e];break}if(null==o)return;if(o.type==e.AniParmType.Bool){let e=new wo(o.name);e.compareFlag=Boolean(n.checkValue),a=e}else if(o.type==e.AniParmType.Float){let e=new Eo(o.name);e.numberValue=Number(n.checkValue),e.compareFlag=n.type,a=e}else if(o.type==e.AniParmType.Trigger){a=new Ro(o.name)}i.addCondition(a)}}updateTo(e){let t=e._controllerLayers;for(let e=0,i=t.length;e<i;e++)t[e].destroy();t.length=0;let i=this.getLayers();for(let t=0,r=i.length;t<r;t++)e.addControllerLayer(i[t]);let r=this.data.animatorParams;if(r){let t={};for(let e=r.length-1;e>=0;e--){let i=r[e],s=new fo;s.name=i.name,s.type=i.type,s.value=i.val,t[i.name]=s}e.parameters=t}}}class Mo extends ta{_isScript(){return!0}setupScript(){let e,t=this.owner;(e=this.onTriggerEnter)&&t.on(c.TRIGGER_ENTER,this,e),(e=this.onTriggerStay)&&t.on(c.TRIGGER_STAY,this,e),(e=this.onTriggerExit)&&t.on(c.TRIGGER_EXIT,this,e),(e=this.onCollisionEnter)&&t.on(c.COLLISION_ENTER,this,e),(e=this.onCollisionStay)&&t.on(c.COLLISION_STAY,this,e),(e=this.onCollisionExit)&&t.on(c.COLLISION_EXIT,this,e),(e=this.onJointBreak)&&t.on(c.JOINT_BREAK,this,e),(e=this.onMouseDown)&&t.on(c.MOUSE_DOWN,this,e),(e=this.onMouseUp)&&t.on(c.MOUSE_UP,this,e),(e=this.onRightMouseDown)&&t.on(c.RIGHT_MOUSE_DOWN,this,e),(e=this.onRightMouseUp)&&t.on(c.RIGHT_MOUSE_UP,this,e),(e=this.onMouseMove)&&t.on(c.MOUSE_MOVE,this,e),(e=this.onMouseDrag)&&t.on(c.MOUSE_DRAG,this,e),(e=this.onMouseDragEnd)&&t.on(c.MOUSE_DRAG_END,this,e),(e=this.onMouseOver)&&t.on(c.MOUSE_OVER,this,e),(e=this.onMouseOut)&&t.on(c.MOUSE_OUT,this,e),(e=this.onMouseClick)&&t.on(c.CLICK,this,e),(e=this.onMouseDoubleClick)&&t.on(c.DOUBLE_CLICK,this,e),(e=this.onMouseRightClick)&&t.on(c.RIGHT_CLICK,this,e),(e=this.onKeyDown)&&h.stage.on(c.KEY_DOWN,this,e),(e=this.onKeyPress)&&h.stage.on(c.KEY_PRESS,this,e),(e=this.onKeyUp)&&h.stage.on(c.KEY_UP,this,e)}}class bo{static getVertexDeclaration(e,t=!0){let i=[];for(let o=0,h=e.length;o<h;o++){let h=e[o],l=bo._vertexDeclarationMap[h+(t?"_0":"_1")];if(!l){var r=h.split(","),s=0,a=[];for(let e=0,i=r.length;e<i;e++){var n;switch(r[e]){case"POSITION":n=new ot(s,st.Vector3,ci.MESH_POSITION0),s+=12;break;case"COLOR":n=new ot(s,st.Vector4,ci.MESH_COLOR0),s+=16;break;case"UV":n=new ot(s,st.Vector2,ci.MESH_TEXTURECOORDINATE0),s+=8;break;case"BLENDWEIGHT":n=new ot(s,st.Vector4,ci.MESH_BLENDWEIGHT0),s+=16;break;case"BLENDINDICES":t?(n=new ot(s,st.Vector4,ci.MESH_BLENDINDICES0),s+=16):(n=new ot(s,st.Byte4,ci.MESH_BLENDINDICES0),s+=4);break;default:throw"VertexMesh: unknown vertex flag."}a.push(n)}l=new nt(s,a),bo._vertexDeclarationMap[h+(t?"_0":"_1")]=l}i.push(l)}return i}static getMeshDefine(e,t){t.length=0;let i=e._vertexBuffers;for(var r=0,s=i.length;r<s;r++){let e=i[r].vertexDeclaration._vertexElements;for(const i of e)switch(i.elementUsage){case ci.MESH_COLOR0:t.push(gi.getDefineByName("COLOR"));break;case ci.MESH_TEXTURECOORDINATE0:t.push(gi.getDefineByName("UV"))}}}}bo._vertexDeclarationMap={};class Io extends A{static createMesh2DByPrimitive(t,i,r,s,a,n=!1){let o=new Io;o.canRead=n;let h=[],l=[];for(var u=0,d=t.length;u<d;u++){let r=t[u],s=g.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Dynamic);s.vertexDeclaration=i[u],s.setDataLength(r.buffer.byteLength),s.setData(r.buffer,0,0,r.buffer.byteLength),h.push(s),l[u]=r.buffer}let c=g.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Dynamic);c._setIndexDataLength(r.buffer.byteLength),c._setIndexData(r,0),o._setBuffers(h,c);let _=[];for(u=0;u<a.length;u++){let t=g.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement);t.bufferState=o._bufferState,t.setDrawElemenParams(a[u].length,a[u].start),t.indexFormat=s,_.push(t)}return o._setSubMeshes(_),n&&(o._vertices=l,o._indices=r),o}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get vertexCount(){return this._vertexCount}get indexCount(){return this._indexBuffer.indexCount}get subMeshCount(){return this._subMeshes.length}get indexFormat(){return this._indexFormat}constructor(){super(),this._instanceBufferStateType=0,this._vertexBuffers=null,this._indexBuffer=null,this._vertexCount=0,this._indexFormat=e.IndexFormat.UInt16,this.canRead=!1,this._vertices=null,this._indices=null,this._bufferState=g.renderDeviceFactory.createBufferState(),this._subMeshes=[],this.destroyedImmediately=t.destroyResourceImmediatelyDefault}_disposeResource(){for(let e=0,t=this._subMeshes.length;e<t;e++)this._subMeshes[e].destroy();for(let e=0,t=this._vertexBuffers.length;e<t;e++)this._vertexBuffers[e].destroy();this._indexBuffer&&this._indexBuffer.destroy(),this._bufferState.destroy(),this._instanceBufferState&&this._instanceBufferState.destroy(),this._instanceWorldVertexBuffer&&this._instanceWorldVertexBuffer.destroy(),this._instanceSimpleAniVertexBuffer&&this._instanceSimpleAniVertexBuffer.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffers=null,this._indexBuffer=null,this._subMeshes=null,this._indexBuffer=null}_setSubMeshes(e){this._subMeshes=e}_setBuffers(e,t){var i=this._bufferState;this._vertexBuffers=e,this._indexBuffer=t,i.applyState(e,t)}getSubMesh(e){return this._subMeshes[e]}setVertices(e){for(let t=0,i=e.length;t<i;t++)e[t]&&this._vertexBuffers[t]&&this._vertexBuffers[t].setData(e[t],0,0,e[t].byteLength);this.canRead&&(this._vertices=e)}getVertices(){if(this.canRead&&this._vertices)return this._vertices;throw new Error("Can't getVertices without the canRead flag, or if the canRead flag is false before setVertices!")}setVertexByIndex(e,t,i=0){this._vertexBuffers[t].setData(e,i,0,e.byteLength)}setIndices(t){var i;t instanceof Uint32Array?i=e.IndexFormat.UInt32:t instanceof Uint16Array?i=e.IndexFormat.UInt16:t instanceof Uint8Array&&(i=e.IndexFormat.UInt8);let r=this._indexBuffer;r.indexCount<t.length&&console.error("Mesh2D:set indices buffer large than ori indices");var s=!1;(this._indexFormat!==i||r.indexCount<t.length)&&(r.destroy(),s=!0,this._indexBuffer=r=g.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Static),this._indexBuffer._setIndexDataLength(t.byteLength),r.indexCount=r.indexCount,r.indexType=i),r._setIndexData(t,0),s&&this._bufferState.applyState(this._bufferState._vertexBuffers,r),this.canRead&&(this._indices=t)}getIndices(){if(this.canRead&&this._indices)return this._indices;throw new Error("Can't getIndices without the canRead flag, or if the canRead flag is false before setIndices!")}}class Bo{static parse(e,t,i,r){Bo._mesh=i,Bo._subMeshes=r,Bo._version=t,Bo._readData=e,Bo.READ_DATA(),Bo.READ_BLOCK(),Bo.READ_STRINGS();for(var s=0,a=Bo._BLOCK.count;s<a;s++){Bo._readData.pos=Bo._BLOCK.blockStarts[s];var n=Bo._readData.getUint16(),o=Bo._strings[n],h=Bo["READ_"+o];null==h?console.warn("model file err,no this function:"+n+" "+o):h.call(null)}Bo._strings.length=0,Bo._readData=null,Bo._version=null,Bo._mesh=null,Bo._subMeshes=null}static _readString(){return Bo._strings[Bo._readData.getUint16()]}static READ_DATA(){Bo._DATA.offset=Bo._readData.getUint32(),Bo._DATA.size=Bo._readData.getUint32()}static READ_BLOCK(){for(var e=Bo._BLOCK.count=Bo._readData.getUint16(),t=Bo._BLOCK.blockStarts=[],i=Bo._BLOCK.blockLengths=[],r=0;r<e;r++)t.push(Bo._readData.getUint32()),i.push(Bo._readData.getUint32())}static READ_STRINGS(){var e=Bo._readData.getUint32(),t=Bo._readData.getUint16(),i=Bo._readData.pos;Bo._readData.pos=e+Bo._DATA.offset;for(var r=0;r<t;r++)Bo._strings[r]=Bo._readData.readUTFString();Bo._readData.pos=i}static READ_MESH(){var t,i=0,r=Bo._readString(),s=Bo._readData,a=s.__getBuffer(),n=s.getInt16(),o=Bo._DATA.offset,h=Bo._mesh;let l=[];var u=0;for(t=0;t<n;t++){var d=o+s.getUint32(),c=s.getUint32(),_=Bo._readString(),p=ci.getVertexDeclaration(_,!1),m=a.slice(d,d+c),f=g.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Static);f.vertexDeclaration=p,f.setDataLength(c),f.setData(m,0,0,c),u=c/p.vertexStride,i+=c,l[t]=f}h._indexFormat=u>65535?e.IndexFormat.UInt32:e.IndexFormat.UInt16;var T,y,x=o+s.getUint32(),v=s.getUint32();h.indexFormat==e.IndexFormat.UInt32?(T=new Uint32Array(a.slice(x,x+v)),y=4):(T=new Uint16Array(a.slice(x,x+v)),y=2);var S=g.renderDeviceFactory.createIndexBuffer(e.BufferUsage.Static);return S.indexType=h.indexFormat,S.indexCount=v/y,S._setIndexDataLength(v),S._setIndexData(T,0),h._setBuffers(l,S),i+=T.byteLength,h._setCPUMemory(i),h._setGPUMemory(i),h.name=r,!0}static READ_SUBMESH(){var t=Bo._readData,i=g.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.Triangles,e.DrawType.DrawElement);t.getInt16();let r=Bo._mesh;i.bufferState=r._bufferState,i.indexFormat=r.indexFormat;for(var s=t.getUint16(),a=0;a<s;a++){let e=t.readUint32(),r=t.readUint32();i.setDrawElemenParams(r,e)}return Bo._subMeshes.push(i),!0}}Bo._BLOCK={count:0},Bo._DATA={offset:0,size:0},Bo._strings=[];class Lo{load(e){let t=U.inst.getSubAssetURL(e.url,e.uuid,null,"lm");return e.loader.fetch(t,"arraybuffer",e.progress.createCallback(),e.options).then((t=>t?this._parse(e,t):null))}_parse(e,t){var i=new Y(t);i.pos=0;var r=i.readUTFString();if(!r||!r.startsWith("LAYAMODEL"))return console.warn(`Unknow version:${r} ! Model : ${e.url}`),null;return r.startsWith("LAYAMODEL2D")?Lo.v2d.parse(i,r):Lo.v3d?Lo.v3d.parse(i,r):(console.warn(`Loading ${e.url} , you need load the laya.d3 lib!`),null)}}class Po{static parse(e,t){var i=new Io;let r=i._subMeshes;if("LAYAMODEL2D:01"!==t)throw new Error("unknown mesh version: "+t);return Bo.parse(e,t,i,r),i._setSubMeshes(r),i}}Lo.v2d=Po,Be.registerLoader(["lm"],Lo,Be.MESH),e.TextResourceFormat=void 0,(vo=e.TextResourceFormat||(e.TextResourceFormat={}))[vo.Buffer=0]="Buffer",vo[vo.Plain=1]="Plain",vo[vo.JSON=2]="JSON",vo[vo.XML=3]="XML";class No extends A{constructor(e,t){super(),this.data=e,this.format=t}}Be.registerLoader(["txt","csv"],class{load(t){return t.loader.fetch(t.url,"text",t.progress.createCallback(),t.options).then((t=>t?new No(t,e.TextResourceFormat.Plain):null))}},Be.TEXT),Be.registerLoader(["bin","bytes","fui"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?new No(t,e.TextResourceFormat.Buffer):null))}},Be.BUFFER),Be.registerLoader(["json"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(),t.options).then((t=>t?new No(t,e.TextResourceFormat.JSON):null))}},Be.JSON),Be.registerLoader(["xml"],class{load(t){return t.loader.fetch(t.url,"xml",t.progress.createCallback(),t.options).then((t=>t?new No(t,e.TextResourceFormat.XML):null))}},Be.XML);Be.registerLoader(["atlas"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{if(!t)return null;let i=[];if(t.meta&&t.meta.image){let r="",s=e.url.lastIndexOf("/");-1!=s&&(r=e.url.substring(0,s+1));let a="";s=e.url.lastIndexOf("?"),-1!=s&&(a=e.url.substring(s));let n=t.meta.image.split(",");for(let t of n)i.push(e.loader.load(r+t+a,null,e.progress.createCallback()))}else i.push(e.loader.load(O.replaceFileExtension(e.url,"png"),null,e.progress.createCallback()));return Promise.all(i).then((i=>{i=i.filter((e=>null!=e));let r=e.options.baseUrl||"",s=t.frames,a=t.meta&&null!=t.meta.prefix?t.meta.prefix:e.url.substring(0,e.url.lastIndexOf("."))+"/",n=[],o=1;t.meta&&t.meta.scale&&1!=t.meta.scale&&(o=parseFloat(t.meta.scale));for(let e of i)e.scaleRate=o;for(let t in s){let o=s[t],h=i[o.frame.idx?o.frame.idx:0];if(!h)continue;let l=r+a+(o.filename||t),u=fe.create(h,o.frame.x,o.frame.y,o.frame.w,o.frame.h,o.spriteSourceSize.x,o.spriteSourceSize.y,o.sourceSize.w,o.sourceSize.h);u._sizeGrid=o.sizeGrid,u._stateNum=o.stateNum,e.loader.cacheRes(l,u),u.url=l,n.push(u)}return new xe(a,i,n)}))}))}},Be.ATLAS);const Oo={Int8Array:Int8Array,Uint8Array:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};class Fo{static hasProp(...e){for(let t of e)if(void 0!==Fo._data[t])return!0;return!1}static decodeObj(e,t){return Go.decodeObj(e,t)}static getLoadTypeByEngineType(e){switch(e){case"Texture2D":case"RenderTexture":return Be.TEXTURE2D;case"TextureCube":return Be.TEXTURECUBE;case"Prefab":return Be.HIERARCHY;case"Material":return Be.MATERIAL;case"Mesh":return Be.MESH;default:return null}}static bakeOverrideData(e){let t=null;for(let i=e.length,r=i-1;r>=0;r--){let s=e[r];if(s&&s.length>0)for(let e of s){let s,a=e._$override||e._$parent;if(Array.isArray(a)?s=a[i-r-1]:r==i-1&&(s=a),null!=s){t||(t={});let a=t[s];a||(t[s]=a=[]),a.push(i-r,e)}}}return t}static applyOverrideData(e,t){return function e(i){if(t[i._$id])return!0;let r=i._$child;return!(!r||!r.find((t=>e(t))))}(e)&&(e=function e(t){let i=Object.assign({},t),r=i._$child;r&&(i._$child=r.map((t=>e(t))));let s=i._$comp;return s&&(i._$comp=s.map((e=>Object.assign({},e)))),i}(e),function e(i){let r=i._$child;if(r)for(let t of r)t._$id&&e(t);let s=t[i._$id];if(s)for(let e=0;e<s.length;e+=2){let t,a=s[e],n=s[e+1];if(t=n._$override){let e;if(Array.isArray(t))if(a==t.length-1){let s=t[a];r?e=r.find((e=>e._$override==s)):i._$child=r=[],e||(e={_$override:s},r.push(e))}else if(a<t.length-1){let s=t.slice(a);r?e=r.find((e=>{let t=e._$override;return Array.isArray(t)&&ko(t,s)})):i._$child=r=[],e||(e={_$override:s},r.push(e))}else e=i;else e=i;if(Uo(e,n),n._$comp){let t=e._$comp;t||(e._$comp=t=[]);for(let e of n._$comp){let i=e._$type||e._$override,r=t.find((e=>e._$override==i||e._$type==i||e._$id==i));r||(r={},e._$type?r._$type=i:r._$override=i,t.push(r)),Uo(r,e)}}}else if(t=n._$parent){let e;if(r||(i._$child=r=[]),a<t.length){e=a==t.length-1?t[a]:t.slice(a);let i=Object.assign({},n);i._$parent=e,r.push(i)}else{let e=Object.assign({},n);delete e._$parent,i._$prefab?r.push(e):(delete e._$index,n._$index<r.length?r.splice(n._$index,0,e):r.push(e))}}}}(e)),e}}function Uo(e,t){for(let i in t){if(i.startsWith("_$"))continue;let r=t[i];if(null==r||"object"!=typeof r||Array.isArray(r)||(r._$type||r._$uuid||r._$ref))e[i]=r;else{let t=e[i];null!=t&&"object"==typeof t?(e[i]=t=Object.assign({},t),Uo(t,r)):e[i]=r}}}function ko(e,t){if(e.length===t.length){for(var i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}return!1}Fo.isDeserializing=!1;class Go{constructor(){this.getNodeByRef=Vo,this.getNodeData=Vo}static decodeObj(e,t){return Ho.errors=null,Ho.getNodeByRef=Vo,Ho.getNodeData=Vo,Ho.decodeObj(e,t)}decodeObj(e,t,i){Fo.isDeserializing=!0;try{return this._decode(e,t,i)}finally{Fo.isDeserializing=!1}}decodeObjBounds(e,t){Fo.isDeserializing=!0;try{let i=e.x,r=e.y;void 0!==i&&void 0!==r?t.pos(i,r):void 0!==i?t.x=i:void 0!==r&&(t.y=r),i=e.width,r=e.height,void 0!==i&&void 0!==r?t.size(i,r):void 0!==i?t.width=i:void 0!==r&&(t.height=r),i=e.controllers,void 0!==i&&(t.controllers=this._decode(i))}finally{Fo.isDeserializing=!1}}_decode(e,t,i){if(null==e)return null;if(Array.isArray(e)){let t=[];for(let i=0;i<e.length;i++){let r=e[i];if(null!=r)try{t[i]=this._decode(r)}catch(e){this.errors?this.errors.push(e):console.error(e),t[i]=null}else t[i]=null}return t}if("object"==typeof e){if(null!=e._$uuid){let t=k.getResURLByUUID(e._$uuid);return h.loader.getRes(t,Fo.getLoadTypeByEngineType(e._$type))}if(null!=e._$ref){let t=this.getNodeByRef(e._$ref);if(!t)return null;if(e._$type){let i=Oe.getClass(e._$type);return i?t.getComponent(i):null}if(void 0!==e._$ctrl){let i=zo||(zo=Oe.getClass("ControllerRef"));return i?new i(t,e._$ctrl):null}return t}let r=e._$type;if("any"===r)return e._$type?e.value:e;let s=Oo[r];if(null!=s)return e._$type?new s(e.value):new s(e);if(!t){let e=Oe.getClass(r);if(!e)return null;t=new e}for(let r in e){if(r.startsWith("_$")||i&&i.has(r))continue;let s=e[r];if(null==s||"object"!=typeof s||Array.isArray(s)||s._$type||s._$uuid||s._$ref)try{let e=this._decode(s);t[r]=e,null!=e&&null!=s&&s._$tmpl&&(t[s._$tmpl]=new Xo(null,this.getNodeData(e)))}catch(e){this.errors?this.errors.push(e):console.error(e)}else{let e=t[r];if(e)try{this._decode(s,e)}catch(e){this.errors?this.errors.push(e):console.error(e)}}}if(t.onAfterDeserialize)try{Fo._data=e,t.onAfterDeserialize()}catch(e){this.errors?this.errors.push(e):console.error(e)}return t}return e}}function Vo(...e){return null}var zo;const Ho=new Go,Wo=new Set(["x","y","width","height","controllers","relations","gears"]);class Yo{static parse(e,t,i){let r=null==i;i=i||[];let s,a,n,o,h,l,u,d,c={},_=[],p=[],g=[];function m(e,t){for(let i of e._$child)if(i._$child){let e=f(i,t);m(i,i._$prefab?e:t),_.push(i),p.push(e)}else{let e=f(i,t);_.push(i),p.push(e)}}function f(e,t){let r,s;if(s=e._$override){if(t&&n)if(Array.isArray(s)){r=t;for(let e=0,t=s.length;e<t;e++){let t=n.get(r);if(r=null==t?void 0:t[s[e]],!r)break}}else{let i=n.get(t);i&&(r=i[e._$override])}}else{if(s=e._$prefab){let t=Be.getRes(k.getResURLByUUID(s),Be.HIERARCHY);if(t){n||(n=new Map);let s=[],a=e._$id;if(h)for(let e=0,t=h.length;e<t;e++){let i=h[e];i&&i.length>0?s[e]=i.filter((i=>{let r=i._$override||i._$parent;return Array.isArray(r)&&r.length>t-e&&r[t-e-1]==a})):s[e]=i}s.push(e._$child),r=t.create({inPrefab:!0,prefabNodeDict:n,overrideData:s},i)}}else if(s=e._$type){let t=Oe.getClass(s);if(t)try{r=new t}catch(e){i.push(e)}else i.push(new Error(`missing node type '${s}' (in ${e.name||"noname"})`))}r&&(c[e._$id]=r,2===r._nodeType&&(u=!0))}return r}function T(e,t,i=0){if(!t)return e;let r=null==n?void 0:n.get(e);if(!r)return null;if(Array.isArray(t)){let e;for(let s=i,a=t.length;s<a;s++){if(!r)return null;if(e=r[t[s]],!e)break;r=n.get(e)}return e}return r[t]}if(t&&(a=t.inPrefab,a&&(n=t.prefabNodeDict),o=t.skinBaseUrl,h=t.overrideData),e._$type||e._$prefab){let r,a=e._$runtime;a&&(l=!0,a.startsWith("res://")&&(a=a.substring(6)),a=Oe.getClass(a),a||i.push(new Error(`missing runtime class '${e._$runtime}'`))),t&&t.runtime&&(a=t.runtime),a?(r=new a,r instanceof As||(i.push(new Error(`runtime class invalid - '${a}', must derive from Node`)),r=null),c[e._$id]=r):r=f(e,null),r&&(e._$child&&m(e,e._$prefab?r:null),_.push(e),p.push(r),r instanceof rn&&(s=r))}else e._$child&&m(e,null);let y=_.length,x=0,v=[];for(let e=0;e<y;e++){let t=_[e],i=p[e],r=t._$child;if(r){let e=r.length;if(i)if(t._$prefab)for(let t=0;t<e;t++){let r=x-e+t,s=g[r];if(s&&!s.parent){let e=v[r],t=T(i,e._$parent);if(t){let i=e._$index;null!=i&&i<t.numChildren?t.addChildAt(s,i):t.addChild(s)}else i.addChildAt(s,0)}}else for(let t=0;t<e;t++){let r=g[x-e+t];r&&(i===s&&r.is3D?s._scene3D=r:i.addChild(r))}x-=e}g[x]=i,v[x]=t,x++}g.length=x,g=g.filter((e=>null!=e));let S=g[0],D=[];for(let e=0;e<y;e++){let t=_[e]._$comp;if(!t)continue;let r=p[e];if(r)for(let e of t){let t,s=e._$override;if(e._$override){let e=Oe.getClass(s);t=e?r.getComponent(e):r.components.find((e=>e._extra.storeId==s))}else{let s=Oe.getClass(e._$type);if(s){if(e._$id||(t=r.getComponent(s)),!t)try{t=r.addComponent(s),t._extra.storeId=e._$id}catch(e){i.push(e)}}else i.push(new Error(`missing component type '${e._$type}' (in ${r.name||"noname"})`))}t&&D.push(e,t)}}const E=new Go;E.errors=i,E.getNodeByRef=function(e){if(Array.isArray(e)){let t=c[e[0]];return t&&e.length>1?T(t,e,1):t}return c[e]},E.getNodeData=function(e){let t=p.indexOf(e),i=_[t];return e.destroy(),p[t]=null,h?(void 0===d&&(d=Fo.bakeOverrideData(h)),d?Fo.applyOverrideData(i,d):i):i};for(let e=0;e<y;e++){let t=_[e],i=p[e];!i||2!==i._nodeType&&i!==s||E.decodeObjBounds(t,i)}if(u){2===S._nodeType&&(S.sourceWidth=S.width,S.sourceHeight=S.height);for(let e=0;e<y;e++){let t=_[e],i=p[e];if(i&&2===i._nodeType){let e=t.relations;null!=e&&(null!=t._$prefab?i._addRelations(E.decodeObj(e)):i.relations=E.decodeObj(e))}}}for(let e=0;e<y;e++){let t=_[e],r=p[e];if(r&&(null!=o&&0===r._nodeType&&(r._skinBaseUrl=o),E.decodeObj(t,r,2===r._nodeType||r===s?Wo:null),l&&t._$var&&r.name))try{S[r.name]=r}catch(e){i.push(e)}}let w=D.length;for(let e=0;e<w;e+=2){let t=D[e],i=D[e+1];E.decodeObj(t,i)}if(u){for(let e=0;e<y;e++){let t=_[e],i=p[e];if(i&&2===i._nodeType){let e=t.gears;null!=e&&(null!=t._$prefab?i._addGears(E.decodeObj(e)):i.gears=E.decodeObj(e))}}if(!(2!==S._nodeType||n&&n.has(S)))try{S._onConstruct(a)}catch(e){i.push(e)}}return a&&n&&S&&n.set(S,c),r&&i.length>0&&i.forEach((e=>console.error(e))),g}static collectResourceLinks(e,t){let i,r={},s=[];function a(e,i){if(!e)return"";let a=r[e];if(void 0===a){let n;n=O.isUUID(e)?"res://"+e:k.join(t,e),s.push({url:n,type:i}),r[e]=a=[n,i]}else-1==a.indexOf(i,1)&&(a.push(i),s.push({url:a[0],type:i}));return a[0]}function n(e){if(null==e._$uuid){if(null!=e._$prefab)e._$prefab=a(e._$prefab,Be.HIERARCHY);else if(null!=(i=e._$type))if(i.endsWith(".bp"))a(i,null);else if(p.isPreview&&O.isUUID(i)){let e=Oe.getClass(i);(null==e||e._$loadable)&&a("res://"+i,null)}o(e)}else e._$uuid=a(e._$uuid,Fo.getLoadTypeByEngineType(e._$type))}function o(e){for(let t in e){let i=e[t];if(null!=i)if(Array.isArray(i)){for(let e of i)if(null!=e)if("object"==typeof e)n(e);else if("string"==typeof e&&e.startsWith("i18n:")){let t=e.indexOf(":",5);-1!=t&&a(U.inst.getI18nSettingsURL(e.substring(5,t)),null)}}else if("object"==typeof i)n(i);else if("string"==typeof i&&i.startsWith("i18n:")){let e=i.indexOf(":",5);-1!=e&&a(U.inst.getI18nSettingsURL(i.substring(5,e)),null)}}}if(o(e),e._$preloads)for(let t of e._$preloads)s.push(t);return s}}class Xo extends xo{constructor(e,t){super(),this.api=e||Xo.v3,this.data=t}create(e,t){let i=Oe.getRuntime(this.url);i&&(e?e.runtime||(e=Object.assign({runtime:i},e)):e={runtime:i});let r=this.api.parse(this.data,e,t);return Array.isArray(r)?(1==r.length&&(r[0].url=this.url),r[0]):(r.url=this.url,r)}}Xo.v3=Yo,Xo.v2=null;class qo{load(e){let t=e.url;return("gltf"==e.ext||"fbx"==e.ext||"glb"==e.ext||"obj"==e.ext)&&(t=U.inst.getSubAssetURL(t,e.uuid,"0","lh")),e.loader.fetch(t,"json",e.progress.createCallback(.2),e.options).then((t=>t?null!=t._$ver?this._load(Xo.v3,e,t,3):"ls"==e.ext||"lh"==e.ext?this._load(Xo.v2,e,t,2):"scene"==e.ext||"prefab"==e.ext?this._load(Xo.legacySceneOrPrefab,e,t,2):null:null))}_load(e,t,i,r){let s=k.getPath(t.url),a=e.collectResourceLinks(i,s),n=Object.assign({},t.options);return n.initiator=t,delete n.cache,delete n.ignoreCache,t.loader.load(a,n,t.progress.createCallback()).then((t=>{let r=new Xo(e,i);return r.onLoad(),r.addDeps(t),r}))}}Be.registerLoader(["lh","ls","scene","prefab"],qo,Be.HIERARCHY);class jo{static _parseHDRTexture(e,t=null,i=null){let r=jo.getHDRInfo(e),s=new _e(r.width,r.height,r.format,!1,!1,!1);return s.setHDRData(r),t&&(null!=t.wrapModeU&&(s.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(s.wrapModeV=t.wrapModeV),null!=t.filterMode&&(s.filterMode=t.filterMode),null!=t.anisoLevel&&(s.anisoLevel=t.anisoLevel)),s}static getHDRInfo(t){let i=new Uint8Array(t),r=0;const s=()=>{let e=jo.getLineString(i,r);return r+=e.length+1,e};if("#?RADIANCE"!=s())throw"HDR image: identifier wrong.";let a=new Map,n="";do{if(n=s(),"#"!=n[0]){let e=n.split("=");a.set(e[0],e[1])}}while(""!=n);if("32-bit_rle_rgbe"!=a.get("FORMAT"))throw"HDR image: unsupported format.";let o=s().split(" "),h="-Y"==o[0],l="-X"==o[2],u=parseInt(o[1]),d=parseInt(o[3]);return new jo(t,r,l,h,d,u,e.TextureFormat.R32G32B32A32)}static getLineString(e,t){let i=e.length,r=t,s="",a="";for(;r<i&&"\n"!=a;)s=`${s}${a}`,a=String.fromCharCode(e[r]),r++;return s}constructor(e,t,i,r,s,a,n){this.source=e,this.byteOffset=t,this.decreaseX=i,this.decreaseY=r,this.width=s,this.height=a,this.format=n}get_32_bit_rle_rgbe(){let e=this.width,t=this.height;this.decreaseX,this.decreaseY;let i=new Uint8Array(this.source,this.byteOffset),r=0,s=new ArrayBuffer(4*e),a=new Uint8Array(s),n=new ArrayBuffer(e*t*4*3),o=new Float32Array(n);for(let s=t;s>0;s--){i[r++],i[r++];let n=i[r++]<<8|i[r++];if(n!=e)throw"HDR info: scanlineLength wrong.";let h=0;for(let e=0;e<4;e++){let t=(e+1)*n;for(;h<t;){let e=i[r++],s=i[r++];if(e>128){let i=e-128;if(i>t-h)throw"HDR info: ??";for(;i-- >0;)a[h++]=s}else{let n=e;if(0==n||n>t-h)throw"HDR info: ??";if(a[h++]=s,--n>0)for(let e=0;e<n;e++)a[h++]=i[r++]}}}for(let e=0;e<n;e++){let i=a[e],r=a[e+n],h=a[e+2*n],l=a[e+3*n],u=(t-s)*n*3+3*e;const d=(e,t)=>t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t);if(l>0){let e=d(1,l-136);o[u]=i*e,o[u+1]=r*e,o[u+2]=h*e}else o[u]=0,o[u+1]=0,o[u+2]=0}}return o}readScanLine(){let t=this.width,i=this.height,r=this.decreaseX,s=this.decreaseY,a=3;this.format==e.TextureFormat.R32G32B32A32&&(a=4);let n=new Float32Array(t*i*a),o=new Uint8Array(4*t),h=new Uint8Array(this.source,this.byteOffset),l=h.length,u=0;const d=()=>{if(u>=l)throw"HDR info: data wrong.";return h[u++]},c=()=>{throw"HDR info: data wrong."};for(let e=i-1;e>=0;e--){this.readcolors(o,d,c);for(let h=0;h<t;h++){let l=4*h,u=o[l],d=o[l+1],c=o[l+2],_=o[l+3],p=e,g=h;s&&(p=i-1-e),r&&(g=t-1-h);let m=p*t*a+g*a;if(0==_)n[m]=0,n[m+1]=0,n[m+2]=0,4==a&&(n[m+3]=1);else{let e=Ko(1,_-136);n[m]=(u+.5)*e,n[m+1]=(d+.5)*e,n[m+2]=(c+.5)*e,4==a&&(n[m+3]=1)}}}return n}readcolors(e,t,i){const r=(t,i,r)=>{e[4*t+i]=r};let s=this.width,a=t(),n=t(),o=t(),h=t();if(s<8||s>32767)this.olddreadcolors(e,t,a,n,o,h);else if(2!=a||2!=n||128&o)this.olddreadcolors(e,t,a,n,o,h);else{(o<<8|h)!=s&&i();for(let e=0;e<4;e++)for(let a=0;a<s;){let n=t();if(n>128){n&=127;let o=t();for(a+n>s&&i();n--;)r(a++,e,o)}else for(a+n>s&&i();n--;){r(a++,e,t())}}}}olddreadcolors(e,t,i,r,s,a){let n=0,o=this.width;e[0]=i,e[1]=r,e[2]=s,e[3]=a;for(let i=1;i<o;i++){let r=t(),s=t(),a=t(),o=t(),h=4*i;if(e[h]=r,e[h+1]=s,e[h+2]=a,e[h+3]=o,1==r&&1==s&&1==a){let t=h-4;for(let i=o<<n;i>0;i--)e[h]=e[t],e[h+1]=e[t+1],e[h+2]=e[t+2],e[h+3]=e[t+3];n+=8}else n=0}}color_color(e,t){let i=0;0==t.w?e.x=e.y=e.z=0:(i=Ko(1,t.w-136),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i)}}function Ko(e,t){return e*Math.pow(2,t)}var $o;jo.HDRTEXTURE="HDRTEXTURE";class Qo{constructor(){$o||($o={"WhiteTexture.png":_e.whiteTexture,"BlackTexture.png":_e.blackTexture,"GrayTexture.png":_e.grayTexture,"NormalTexture.png":_e.normalTexture})}load(e){if(-1!=e.url.indexOf("internal/")){let t=$o[O.getBaseName(e.url)];if(t)return Promise.resolve(t)}let t;return e.url.startsWith("data:")||(t=U.inst.metaMap[e.url],t||!p.isPreview)?this.load2(e,t):U.inst.getMeta(e.url,e.uuid).then((t=>this.load2(e,t)))}load2(t,i){var r,s,a;let n,o,h=t.ext,l=t.url;if(i){let e=I.platform,u=(null===(r=i.platforms)||void 0===r?void 0:r[e])||0,d=(null===(s=i.files)||void 0===s?void 0:s[u])||{};d.file&&(l=U.inst.getSubAssetURL(l,t.uuid,d.file,d.ext),h=d.ext),n=[0,0,null!==(a=d.format)&&void 0!==a?a:1,i.mipmap,i.readWrite,i.sRGB],o={wrapModeU:i.wrapMode,wrapModeV:i.wrapMode,filterMode:i.filterMode,anisoLevel:i.anisoLevel,premultiplyAlpha:!!i.pma,hdrEncodeFormat:i.hdrEncodeFormat}}else n=t.options.constructParams,o=t.options.propertyParams;let u=-1!=rh.indexOf(h)?h:null;if(null!=u)return t.loader.fetch(l,"arraybuffer",t.progress.createCallback(),t.options).then((r=>{if(!r)return null;let s;switch(u){case"dds":let t=he.getDDSTextureInfo(r);if(t.isCube){let e=Oe.getClass("TextureCube");if(!e)return null;{let i=!!n&&!!n[5],r=new e(t.width,t.format,t.mipmapCount>1,i);r.setDDSData(t),s=r}}else s=_e._parseDDS(r,o,n);break;case"ktx":let i=ce.getKTXTextureInfo(r);if(i.dimension==e.TextureDimension.Cube){let e=Oe.getClass("TextureCube");if(!e)return null;{let t=new e(i.width,i.format,i.mipmapCount>1,i.sRGB);t.setKTXData(i),s=t}}else i.dimension==e.TextureDimension.Tex2D&&(s=_e._parseKTX(r,o,n));break;case"pvr":s=_e._parsePVR(r,o,n);break;case"hdr":s=jo._parseHDRTexture(r,o,n);break;case"lanit.ls":s=_e._SimpleAnimatorTextureParse(r,o,n)}let a=t.obsoluteInst;return a&&Object.getPrototypeOf(a)==Object.getPrototypeOf(s)&&(s=this.move(a,s)),o&&o.hdrEncodeFormat&&(s.hdrEncodeFormat=o.hdrEncodeFormat),i&&(s._sizeGrid=i.sizeGrid,s._stateNum=i.stateNum),s}));{let e=t.options,r=o&&o.premultiplyAlpha?"premultiply":"none";return e.useWorkerLoader&&"none"===r&&(e=Object.assign({workerLoaderOptions:{premultiplyAlpha:r}},e)),t.loader.fetch(l,"image",t.progress.createCallback(),e).then((t=>g.textureContext.needBitmap?t instanceof ImageBitmap?t:createImageBitmap(t,e.workerLoaderOptions||{premultiplyAlpha:r}):t)).then((e=>{if(!e)return null;let r=_e._parseImage(e,o,n),s=t.obsoluteInst;return s&&Object.getPrototypeOf(s)==Object.getPrototypeOf(r)&&(r=this.move(s,r)),i&&(r._sizeGrid=i.sizeGrid,r._stateNum=i.stateNum),r}))}}move(e,t){return e._texture=t._texture,e._format=t.format,e.width=t.width,e.height=t.height,e.obsolute=!1,delete A._idResourcesMap[t.id],e}}class Zo{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((t=>{if(!t)return null;let i=e.obsoluteInst;return i?i.recreate(t.width,t.height,t.colorFormat,t.depthFormat,t.generateMipmap,t.multiSamples,t.generateDepthTexture,t.sRGB):i=new b(t.width,t.height,t.colorFormat,t.depthFormat,t.generateMipmap,t.multiSamples,t.generateDepthTexture,t.sRGB),null!=t.anisoLevel&&(i.anisoLevel=t.anisoLevel),null!=t.filterMode&&(i.filterMode=t.filterMode),null!=t.wrapModeU&&(i.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(i.wrapModeV=t.wrapModeV),i}))}}class Jo{load(e){let t=e.obsoluteInst||new Qn;return t.source=e.url,Promise.resolve(t)}}const eh={premultiplyAlpha:!0},th=[null,null,e.TextureFormat.R8G8B8A8,!1,!1,!0];class ih{wrapTex2D(e,t){if(!t)return null;let i=e.obsoluteInst;return i?(i.setTo(t),i.obsolute=!1,i._sizeGrid=t._sizeGrid,i._stateNum=t._stateNum,i.event("reload"),i._clipCache&&i._clipCache.forEach((e=>{e.event("reload"),e._sizeGrid=i._sizeGrid,e._stateNum=i._stateNum}))):(i=new fe(t),i._sizeGrid=t._sizeGrid,i._stateNum=t._stateNum),i}load(e){let t=e.loader.getRes(e.url,Be.TEXTURE2D);if(!t||t.obsolute){let t={url:e.url,type:Be.TEXTURE2D};return e.options.propertyParams?null==e.options.propertyParams.premultiplyAlpha&&(t.propertyParams=Object.assign({},eh,e.options.propertyParams)):t.propertyParams=eh,e.options.constructParams?null==e.options.constructParams[5]&&(t.constructParams=Object.assign([],th,e.options.constructParams)):t.constructParams=th,e.loader.load(t,e.options,e.progress.createCallback()).then((t=>this.wrapTex2D(e,t)))}return Promise.resolve(this.wrapTex2D(e,t))}}const rh=["ktx","pvr","dds","hdr","exr","lanit.ls"],sh=["mp4","webm"];Be.registerLoader(["tga","tif","tiff","png","jpg","jpeg","webp","rendertexture",...sh,...rh],ih,Be.IMAGE,!0),Be.registerLoader([],Qo,Be.TEXTURE2D,!0),Be.registerLoader(["rendertexture"],Zo,Be.TEXTURE2D,!0),Be.registerLoader(sh,Jo,Be.TEXTURE2D);Be.registerLoader(["mc"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?go._parse(e):null))}});Be.registerLoader(["mcc"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{let i=new Ao(t);if(i.data&&i.data.controllerLayers){let t=i.data.controllerLayers,r=[];for(let i=t.length-1;i>=0;i--){let s=t[i].states;this.loadStates(s,r,e)}return Promise.all(r).then((e=>(i.addDeps(e),i)))}return i}))}loadStates(e,t,i){let r=k.getPath(i.url);for(let s=e.length-1;s>=0;s--){if(e[s].clip&&e[s].clip._$uuid){let a=k.getResURLByUUID(e[s].clip._$uuid);a.startsWith("res://")||(a=k.join(r,a)),t.push(i.loader.load(a).then((t=>(e[s].clip=t,t))))}e[s].states&&this.loadStates(e[s].states,t,i)}}});class ah{load(e){return Promise.resolve(null)}}Be.registerLoader(["lighting"],ah);Be.registerLoader(["fnt"],class{load(e){let t=O.replaceFileExtension(e.url,"png");return Promise.all([e.loader.fetch(e.url,"xml",e.progress.createCallback(.2),e.options),e.loader.load(t,e.options,e.progress.createCallback(.8))]).then((([e,t])=>{if(!e||!t)return null;let i=new ma;return i.parseFont(e,t),i}))}},Be.FONT);const nh="LayaTTFFont";Be.registerLoader(["ttf","woff","woff2","otf"],class{load(e){let t=O.replaceFileExtension(O.getBaseName(e.url),"");if(p.isConch)return e.loader.fetch(e.url,"arraybuffer").then((e=>(e&&window.conch.registerFont(t,e),{family:t})));if(window.FontFace){let i=new window.FontFace(t,"url('"+k.postFormatURL(k.formatURL(e.url))+"')");return document.fonts.add(i),i.load().then((()=>i))}{let i="40px "+t,r=I.measureText(nh,i).width,s=I.createElement("style");return s.type="text/css",document.body.appendChild(s),s.textContent="@font-face { font-family:'"+t+"'; src:url('"+k.postFormatURL(k.formatURL(e.url))+"');}",new Promise((e=>{let s=()=>{I.measureText(nh,i).width!=r&&a()},a=()=>{h.systemTimer.clear(this,s),h.systemTimer.clear(this,a),e({family:t})};h.systemTimer.once(1e4,this,a),h.systemTimer.loop(20,this,s)}))}}},Be.TTF);class oh{static parse(e){let t=e.props;switch(e.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":case"LAYAMATERIAL:03":let t=oh.parseLegacy(e);return t.oldparseEndEvent(),t;case"LAYAMATERIAL:04":break;default:throw new Error(`unkonwn material version: ${e.version}`)}let i,r=new bn;r.setShaderName(t.type);for(let e in t)switch(e){case"type":case"name":break;case"defines":let o=t[e];for(let e=0,t=o.length;e<t;e++){let t=gi.getDefineByName(o[e]);r._shaderValues.addDefine(t)}break;case"textures":let h=t[e];for(let e=0,t=h.length;e<t;e++){let t=h[e],i=t.path;i&&r._shaderValues.setTexture(gi.propertyNameToID(t.name),Be.getBaseTexture(i))}break;case"renderQueue":i=t[e];break;case"alphaTest":r.alphaTest=t[e];break;case"materialRenderMode":r.materialRenderMode=t[e];break;default:let l=t[e],u=gi.propertyNameToID(e);switch(u){case gi.CULL:r.cull=l;break;case gi.BLEND:r.blend=l;break;case gi.BLEND_SRC:r.blendSrc=l;break;case gi.BLEND_DST:r.blendDst=l;break;case gi.BLEND_DST_ALPHA:r.blendDstAlpha=l;break;case gi.BLEND_SRC_ALPHA:r.blendSrcAlpha=l;break;case gi.BLEND_SRC_RGB:r.blendSrcRGB=l;break;case gi.BLEND_SRC_RGB:r.blendDstRGB=l;break;case gi.DEPTH_TEST:r.depthTest=l;break;case gi.DEPTH_WRITE:r.depthWrite=!!t[e];break;case gi.STENCIL_TEST:r.stencilTest=l;break;case gi.STENCIL_Op:r.stencilOp=l;break;case gi.STENCIL_Ref:r.stencilRef=l;break;case gi.STENCIL_WRITE:r.stencilWrite=l;break;default:if(l.length){var n=l;switch(n.length){case 2:r._shaderValues.setVector2(u,new Gt(n[0],n[1]));break;case 3:r._shaderValues.setVector3(u,new a(n[0],n[1],n[2]));break;case 4:r._shaderValues.getColor(u)?r._shaderValues.setColor(u,new m(n[0],n[1],n[2],n[3])):r._shaderValues.setVector(u,new s(n[0],n[1],n[2],n[3]));break;case 9:let e=new zt;e.elements=new Float32Array(n),r._shaderValues.setMatrix3x3(u,e);break;case 16:let t=new Zt;t.elements=new Float32Array(n),r._shaderValues.setMatrix4x4(u,t);break;default:r._shaderValues.setBuffer(u,n)}}else"boolean"==typeof l?r._shaderValues.setBool(u,t[e]):r._shaderValues.setNumber(u,t[e])}}return null!=i&&(r.renderQueue=i),r}static collectLinks(e,t){var i;let r=[],s=null===(i=e.props)||void 0===i?void 0:i.textures;if(s)for(let e=0,i=s.length;e<i;e++){let i=s[e],a=i.path;a&&(i.path=k.join(t,a),r.push({url:i.path,type:Be.TEXTURE2D,constructParams:i.constructParams,propertyParams:i.propertyParams}))}return r}static parseLegacy(e){let t,i=e,r=i.props,n=r.type,o=Oe.getClass(n);switch(!o&&n&&n.startsWith("Laya.")&&(o=Oe.getClass(n.substring(5))),o?t=new o:(t=new bn,t.setShaderName(n)),i.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":for(let e in r)switch(e){case"type":break;case"vectors":let i=r[e];for(let e=0,r=i.length;e<r;e++){let r=i[e],n=r.value;switch(n.length){case 2:t[r.name]=new Gt(n[0],n[1]);break;case 3:t[r.name]instanceof m?t[r.name]=new m(n[0],n[1],n[2],1):t[r.name]=new a(n[0],n[1],n[2]);break;case 4:t[r.name]instanceof m?t[r.name]=new m(n[0],n[1],n[2],n[3]):t[r.name]=new s(n[0],n[1],n[2],n[3]);break;default:throw new Error("unknown material color length: "+n.length)}}break;case"colors":let n=r[e];for(let e=0,i=n.length;e<i;e++){let i=n[e],r=i.value;t[i.name]=new m(r[0],r[1],r[2],r[3])}break;case"textures":let o=r[e];for(let e=0,i=o.length;e<i;e++){let i=o[e],r=i.path;r&&(t[i.name]=Be.getBaseTexture(r))}break;case"defines":let h=r[e];for(let e=0,i=h.length;e<i;e++){let i=gi.getDefineByName(h[e]);t._shaderValues.addDefine(i)}break;case"renderStates":let l=r[e][0];t.blend=l.blend,t.cull=this._getRenderStateParams(l.cull),t.depthTest=this._getRenderStateParams(l.depthTest),t.depthWrite=l.depthWrite,t.blendSrc=this._getRenderStateParams(l.srcBlend),t.blendDst=this._getRenderStateParams(l.dstBlend);break;case"cull":t.cull=this._getRenderStateParams(r[e]);break;case"blend":t.blend=this._getRenderStateParams(r[e]);break;case"depthWrite":t.depthWrite=!!r[e];break;case"srcBlend":case"blendSrc":t.blendSrc=this._getRenderStateParams(r[e]);break;case"dstBlend":case"blendDst":t.blendDst=this._getRenderStateParams(r[e]);break;case"depthTest":t.depthTest=this._getRenderStateParams(r[e]);break;default:t[e]=r[e]}break;case"LAYAMATERIAL:03":for(let e in r)switch(e){case"type":case"name":break;case"defines":let i=r[e];for(let e=0,r=i.length;e<r;e++){let r=gi.getDefineByName(i[e]);t._shaderValues.addDefine(r)}break;case"textures":let n=r[e];for(let e=0,i=n.length;e<i;e++){let i=n[e],r=i.path;r&&t._shaderValues.setTexture(gi.propertyNameToID(i.name),Be.getBaseTexture(r))}break;case"renderQueue":t.renderQueue=r[e];break;default:let o=r[e],l=gi.propertyNameToID(e);switch(l){case gi.CULL:t.cull=this._getRenderStateParams(o);break;case gi.BLEND:t.blend=this._getRenderStateParams(o);break;case gi.BLEND_SRC:t.blendSrc=this._getRenderStateParams(o);break;case gi.BLEND_DST:t.blendDst=this._getRenderStateParams(o);break;case gi.DEPTH_TEST:t.depthTest=this._getRenderStateParams(o);break;case gi.DEPTH_WRITE:t.depthWrite=!!r[e];break;default:if(o.length){var h=o;switch(h.length){case 2:t._shaderValues.setVector2(l,new Gt(h[0],h[1]));break;case 3:t._shaderValues.setVector3(l,new a(h[0],h[1],h[2]));break;case 4:t._shaderValues.getColor(l)?t._shaderValues.setColor(l,new m(h[0],h[1],h[2],h[3])):t._shaderValues.setVector(l,new s(h[0],h[1],h[2],h[3]));break;default:throw new Error("unknown material color length: "+h.length)}}else"boolean"==typeof o?t._shaderValues.setBool(l,r[e]):t._shaderValues.setNumber(l,r[e])}}break;default:throw new Error("unknown material version: "+i.version)}return t}static _getRenderStateParams(t){switch(t){case 768:return e.BlendFactor.SourceColor;case 769:return e.BlendFactor.OneMinusSourceColor;case 774:return e.BlendFactor.DestinationColor;case 775:return e.BlendFactor.OneMinusDestinationColor;case 770:return e.BlendFactor.SourceAlpha;case 771:return e.BlendFactor.OneMinusSourceAlpha;case 772:return e.BlendFactor.DestinationAlpha;case 773:return e.BlendFactor.OneMinusDestinationAlpha;case 776:return e.BlendFactor.SourceAlphaSaturate;case 32774:return e.BlendEquationSeparate.ADD;case 32778:return e.BlendEquationSeparate.SUBTRACT;case 32779:return e.BlendEquationSeparate.REVERSE_SUBTRACT;case 512:return e.CompareFunction.Never;case 513:return e.CompareFunction.Less;case 514:return e.CompareFunction.Equal;case 515:return e.CompareFunction.LessEqual;case 516:return e.CompareFunction.Greater;case 517:return e.CompareFunction.NotEqual;case 518:return e.CompareFunction.GreaterEqual;case 519:return e.CompareFunction.Always;default:return t}}}class hh{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.3),e.options).then((t=>{if(!t)return null;let i=k.getPath(e.url),r=oh.collectLinks(t,i);if("LAYAMATERIAL:04"===t.version){let s=t.props.type;if(!gi.find(s)){let a=U.inst.shaderName_to_URL(s);if(!a)return U.inst.shaderName_to_URL_async(s).then((a=>(a?r.push(a):t.props.shaderPath?r.push(k.join(i,t.props.shaderPath)):Be.warn(`unknown shaderName: ${s}`),this.load2(e,t,r))));r.push(a)}}return this.load2(e,t,r)}))}load2(e,t,i){if(0==i.length){let i=oh.parse(t),r=e.obsoluteInst;return r&&(i=this.move(r,i)),Promise.resolve(i)}let r=Object.assign({},e.options);return r.initiator=e,delete r.cache,delete r.ignoreCache,e.loader.load(i,r,e.progress.createCallback()).then((()=>{let i=oh.parse(t),r=e.obsoluteInst;return e.obsoluteInst&&(i=this.move(r,i)),i}))}move(e,t){return e._shaderValues.clearData(),e.setShaderName(t._shader.name),t._shaderValues.cloneTo(e._shaderValues),e.materialRenderMode=t.materialRenderMode,e.renderQueue=t.renderQueue,e.obsolute=!1,t.destroy(),e}}Be.registerLoader(["lmat"],hh,Be.MATERIAL,!0);class lh{static parse(e){return this.parseStart(e)}static findIndex(e,t,i,r){var s=e.indexOf(i,t+1);return 0>s&&(s=r),{str:e.substring(t+1,s),i:s}}static finCurrObj(){if(this.type=1,null==this.cobj)return null;if(0==this.currArr.length)return this.cobj.k&&(this.ret[this.cobj.k]=this.cobj.val),null;var e=this.currArr.pop();if(this.cobj.k)if(Array.isArray(e.val)){if(null!=this.cobj.k){var t={};t[this.cobj.k]=this.cobj.val,e.val.push(t)}}else e.val[this.cobj.k]=this.cobj.val;else Array.isArray(this.cobj.val)&&(Array.isArray(e.val)?e.val.push(this.cobj.val):e.val=this.cobj.val);return e}static formatVal(e){if(null==e)return null;var t=Number(e);return isNaN(t)?"false"!=e.toLowerCase()&&("true"==e.toLowerCase()||("null"==e?null:e)):t}static finCurrStr(){null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&(null!=this.cobj&&(Array.isArray(this.cobj.val)?this.cobj.val.push(this.formatVal(this.currStr)):(this.cobj.val=this.formatVal(this.currStr),this.cobj=this.finCurrObj())),this.currStr=""))}static parseStart(e){this.len=e.length;var t=0;for(this.ret={},this.currStr=null,this.currArr=[],this.cobj=null,this.type=0;t<this.len;){var i=e.charAt(t);if("/"==i){if(t+1<this.len){t+=1;var r=e.charAt(t),s=null;if("/"==r?s="\n":"*"==r&&(s="*/"),null!=s){this.finCurrStr();var a=e.indexOf(s,t);0>a?(console.log("没有找到注释结尾，应该是一直注释到最后了"),t=this.len):t=a+s.length-1}}}else if("}"==i)null!=this.cobj&&(this.finCurrStr(),null!=this.cobj&&(this.cobj=this.finCurrObj())),this.currStr="",this.type=1;else if("{"==i)this.currStr="",this.type=1;else if("'"==i||'"'==i||"‘"==i||"“"==i){"‘"==i?i="’":"“"==i&&(i="”");var n=this.findIndex(e,t,i,this.len);2==this.type&&null!=this.cobj&&Array.isArray(this.cobj.val)?(null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),this.cobj.val.push(n.str),this.currStr=""):null!=this.currStr&&(this.currStr+=n.str),t=n.i}else if(";"==i||","==i||"\n"==i)this.finCurrStr();else if("]"==i)null!=this.currStr&&null!=this.cobj&&Array.isArray(this.cobj.val)&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),null!=this.cobj&&(this.cobj=this.finCurrObj(),this.cobj=this.finCurrObj()),this.currStr="";else if("["==i)2!=this.type?console.warn("没有key值，忽略掉一个数组"):(null!=this.cobj&&this.currArr.push(this.cobj),this.cobj={val:[]});else if(":"==i){if(null!=this.currStr&&1==this.type){if(this.type=2,null!=this.cobj&&this.currArr.push(this.cobj),null!=this.cobj&&Array.isArray(this.cobj.val)){var o=this.cobj;this.cobj={val:{}},o.val.push(this.cobj.val),this.currArr.push(this.cobj)}this.cobj={k:this.currStr.trim(),val:{}},this.currStr=""}}else null!=this.currStr&&(this.currStr+=i);t++}return this.ret}}const uh=["GLSL Start","GLSL End"],dh=["#defineGLSL","#endGLSL"],ch=["Shader3D Start","Shader3D End"],_h={Color:e.ShaderDataType.Color,Int:e.ShaderDataType.Int,Bool:e.ShaderDataType.Bool,Float:e.ShaderDataType.Float,Vector2:e.ShaderDataType.Vector2,Vector3:e.ShaderDataType.Vector3,Vector4:e.ShaderDataType.Vector4,Matrix4x4:e.ShaderDataType.Matrix4x4,Matrix3x3:e.ShaderDataType.Matrix3x3,Texture2D:e.ShaderDataType.Texture2D,TextureCube:e.ShaderDataType.TextureCube,Texture2DArray:e.ShaderDataType.Texture2DArray,Texture3D:e.ShaderDataType.Texture3D};class ph{static parse(e,t){let i=ph.getShaderBlock(e),r=ph.getCGBlock(e);return ph.bindCG(i,r),gi.parse(i,t)}static compileToTree(e,t,i){if(i==e.length)return[t];let r=e[i],s=t.split(r);if(1==s.length)return s;let a=[];for(let t=0,n=s.length;t<n;t++)a=a.concat(ph.compileToTree(e,s[t],i+1)),t!=n-1&&a.push(r);return a}static getMapKey(e){let t=e.indexOf("\n");return e=(e=(e=e.slice(0,t).replace("\r","")).slice(0,t).replace(" ","")).trim()}static getShaderBlock(e){let t=null;try{let i=e.indexOf(ch[0]);if(-1==i)throw new Error(`no '${ch[0]}' tag`);let r=e.indexOf(ch[1]);if(-1==r)throw new Error(`no '${ch[1]}' tag`);let s=e.substring(i+ch[0].length,r);t=lh.parse(s)}catch(t){console.error("Shader parse error: "+t+"\n"+e.substring(0,100)+"...")}return t}static getCGBlock(e){let t={};try{let i=e.indexOf(uh[0]);if(-1==i)throw new Error(`no '${ch[0]}' tag`);let r=e.indexOf(uh[1]);if(-1==r)throw new Error(`no '${ch[1]}' tag`);let s=e.substring(i,r),a=ph.compileToTree(dh,s,0);for(let e=0,i=a.length;e<i;e++){if(a[e]==dh[0]){e+=1;let i=a[e];t[ph.getMapKey(i)]=i.slice(i.indexOf("\n"),i.length-1)}}}catch(t){console.error("Shader parse error: "+t+"\n"+e.substring(0,100)+"...")}return t}static bindCG(e,t){let i=e.shaderPass;i&&i.forEach((e=>{e.VS&&(e.VS=t[e.VS]),e.FS&&(e.FS=t[e.FS])}));let r=e.attributeMap;if(r){let t=0;for(let i in r)if(r[i]instanceof Array){let t=r[i],s=ph.getShaderDataType(t[0]);if(null==s){console.warn(`${e.name}: unkown attribute type '${t[0]}'`);continue}r[i]=[t[1],s]}else{let s=ph.getShaderDataType(r[i]);if(null==s){console.warn(`${e.name}: unkown attribute type '${r[i]}'`);continue}r[i]=[t,s],t++}}let s=e.uniformMap;if(s){let t={};e.defaultValue=t;let i={};e.uniformMap=i;for(let r in s){let a=s[r];if(!1===a.serializable)continue;let n=ph.getShaderDataType(a.type);if(null!=n)if(null!=a.default&&(t[r]=ph.getDefaultData(n,a.default)),a.block){let e=i[a.block];e||(i[a.block]=e={}),e[r]=n}else i[r]=n;else console.warn(`${e.name}: unkown uniform type '${a.type}'`)}}}static getShaderDataType(e){return _h[e]}static getDefaultData(t,i){switch(t){case e.ShaderDataType.Int:case e.ShaderDataType.Float:case e.ShaderDataType.Bool:return i;case e.ShaderDataType.Vector2:return new Gt(i[0],i[1]);case e.ShaderDataType.Vector3:return new a(i[0],i[1],i[2]);case e.ShaderDataType.Vector4:return new s(i[0],i[1],i[2],i[3]);case e.ShaderDataType.Color:return new m(i[0],i[1],i[2],i[3]);case e.ShaderDataType.Matrix4x4:let t=new Zt;return t.cloneByArray(i),t;case e.ShaderDataType.Matrix3x3:let r=new zt;return r.cloneByArray(i),r;case e.ShaderDataType.Texture2D:let n=null;return"white"==i?n=_e.whiteTexture:"black"==i?n=_e.blackTexture:"gray"==i?n=_e.grayTexture:"normal"==i&&(n=_e.normalTexture),n;case e.ShaderDataType.TextureCube:let o=hn.grayTexture;return"white"==i?o=hn.whiteTexture:"black"==i?o=hn.blackTexture:"gray"==i&&(o=hn.grayTexture),o}}}Be.registerLoader(["shader","bps"],class{load(e){let t=e.url;return"bps"===e.ext&&(t=U.inst.getSubAssetURL(t,e.uuid,"0","shader")),e.loader.fetch(t,"text",e.progress.createCallback(),e.options).then((t=>{if(!t)return null;let i=ph.getShaderBlock(t),r=ph.getCGBlock(t);if(ph.bindCG(i,r),!i.name||!i.uniformMap)return null;let s=k.getPath(e.url),a=i.shaderPass;return Promise.all(a.map((e=>kt.compileAsync(e.VS,e.FS,s)))).then((t=>{var r;if(-1!=t.findIndex((e=>null==e)))return Be.warn("some pass null "+e.url),null;let s=gi.add(i.name,i.enableInstancing,i.supportReflectionProbe);s._surportVolumetricGI=i.surportVolumetricGI;let n=new _i(i.attributeMap?i.attributeMap:_i.DefaultAttributeMap,i.uniformMap,i.defaultValue);s.addSubShader(n);for(let e in a){let i=n._addShaderPass(t[e],a[e].pipeline);i.statefirst=null!==(r=a[e].statefirst)&&void 0!==r&&r,kt.getRenderState(a[e].renderState,i.renderState)}return s}))}))}});Be.registerLoader(["mp3","wav","ogg"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?vn.ctx.decodeAudioData(e):null))}},Be.SOUND);class gh extends aa{set sharedMesh(e){if(this._sharedMesh==e)return;let t=new Array;if(this._sharedMesh){bo.getMeshDefine(this._sharedMesh,t);for(var i=0,r=t.length;i<r;i++)this._spriteShaderData.removeDefine(t[i]);this._sharedMesh._removeReference()}if(t.length=0,e)if(e._vertexBuffers){bo.getMeshDefine(e,t);for(i=0,r=t.length;i<r;i++)this._spriteShaderData.addDefine(t[i]);e._addReference()}else e=null,console.warn("not a 2D mesh");this._sharedMesh=e,this._changeMesh()}get sharedMesh(){return this._sharedMesh}set color(e){e!=this._color&&this._color.equal(e)||((e=e||m.BLACK).cloneTo(this._color),this._spriteShaderData.setColor(aa.BASERENDER2DCOLOR,this._color))}get color(){return this._color}set texture(e){e||(e=_e.whiteTexture),e!=this._baseRender2DTexture&&(this._baseRender2DTexture&&this._baseRender2DTexture._removeReference(1),e._addReference(),this._baseRender2DTexture=e,this._spriteShaderData.setTexture(aa.BASERENDER2DTEXTURE,e),1!=e.gammaCorrection?this._spriteShaderData.addDefine(ki.GAMMATEXTURE):this._spriteShaderData.removeDefine(ki.GAMMATEXTURE))}get texture(){return this._baseRender2DTexture}set normalTexture(e){e!==this._normal2DTexture&&(this._normal2DTexture&&this._normal2DTexture._removeReference(1),e&&e._addReference(),this._normal2DTexture=e,this._spriteShaderData.setTexture(aa.NORMAL2DTEXTURE,e),this._normal2DStrength>0&&this._normal2DTexture?this._spriteShaderData.addDefine(aa.SHADERDEFINE_LIGHT2D_NORMAL_PARAM):this._spriteShaderData.removeDefine(aa.SHADERDEFINE_LIGHT2D_NORMAL_PARAM))}get normalTexture(){return this._normal2DTexture}set normalStrength(e){e=Math.max(0,Math.min(1,e)),this._normal2DStrength!==e&&(this._normal2DStrength=e,this._spriteShaderData.setNumber(aa.NORMAL2DSTRENGTH,e),e>0&&this._normal2DTexture?this._spriteShaderData.addDefine(aa.SHADERDEFINE_LIGHT2D_NORMAL_PARAM):this._spriteShaderData.removeDefine(aa.SHADERDEFINE_LIGHT2D_NORMAL_PARAM))}get normalStrength(){return this._normal2DStrength}set sharedMaterial(e){super.sharedMaterial=e,this._changeMesh()}get sharedMaterial(){return this._materials[0]}_changeMesh(){let e=this._sharedMesh?this._sharedMesh.subMeshCount:0;if(e>this._renderElements.length){for(var t=this._renderElements.length,i=e;i<t;t--){this._renderElements[t].destroy()}this._renderElements.length=e}for(t=0,i=e;t<i;t++){let e=this._renderElements[t];e||(e=this._renderElements[t]=g.render2DRenderPassFactory.createRenderElement2D()),e.geometry=this._sharedMesh.getSubMesh(t),e.value2DShaderData=this._spriteShaderData,aa._setRenderElement2DMaterial(e,this._materials[t]?this._materials[t]:gh.mesh2DDefaultMaterial),e.renderStateIsBySprite=!1,e.nodeCommonMap=this._getcommonUniformMap()}}addCMDCall(e,t,i){let r=e._curMat,s=a.TEMP;s.x=r.a,s.y=r.c,s.z=t*r.a+i*r.c+r.tx,this._spriteShaderData.setVector3(aa.NMATRIX_0,s),s.x=r.b,s.y=r.d,s.z=t*r.b+i*r.d+r.ty,this._spriteShaderData.setVector3(aa.NMATRIX_1,s),this._setRenderSize(e.width,e.height),e._copyClipInfoToShaderData(this._spriteShaderData),this._lightReceive&&this._updateLight()}constructor(){super(),this._color=new m,this._normal2DStrength=0,gh.mesh2DDefaultMaterial||(gh.mesh2DDefaultMaterial=new bn,gh.mesh2DDefaultMaterial.setShaderName("baseRender2D"),gh.mesh2DDefaultMaterial.setBoolByIndex(gi.DEPTH_WRITE,!1),gh.mesh2DDefaultMaterial.setIntByIndex(gi.DEPTH_TEST,At.DEPTHTEST_OFF),gh.mesh2DDefaultMaterial.setIntByIndex(gi.BLEND,At.BLEND_ENABLE_ALL),gh.mesh2DDefaultMaterial.setIntByIndex(gi.BLEND_EQUATION,At.BLENDEQUATION_ADD),gh.mesh2DDefaultMaterial.setIntByIndex(gi.BLEND_SRC,At.BLENDPARAM_ONE),gh.mesh2DDefaultMaterial.setIntByIndex(gi.BLEND_DST,At.BLENDPARAM_ONE_MINUS_SRC_ALPHA),gh.mesh2DDefaultMaterial.setFloatByIndex(ki.UNIFORM_VERTALPHA,1),gh.mesh2DDefaultMaterial.setIntByIndex(gi.CULL,At.CULL_NONE)),this._renderElements=[],this._materials=[],this._spriteShaderData.addDefine(aa.SHADERDEFINE_BASERENDER2D),this._spriteShaderData.setColor(aa.BASERENDER2DCOLOR,this._color)}}class mh{}mh.Blend=0,mh.Fixed=1;class fh{get maxColorRGBKeysCount(){return this._maxColorRGBKeysCount}get colorRGBKeysCount(){return this._colorRGBKeysCount}get _rgbElements(){return this._rgbElementDatas}set _rgbElements(e){this._rgbElementDatas=e,this._maxColorRGBKeysCount=e?e.length/4:0}get maxColorAlphaKeysCount(){return this._maxColorAlphaKeysCount}get colorAlphaKeysCount(){return this._colorAlphaKeysCount}get _alphaElements(){return this._alphaElementDatas}set _alphaElements(e){this._alphaElementDatas=e,this._maxColorAlphaKeysCount=e?e.length/2:0}get maxColorKeysCount(){return Math.max(this._maxColorAlphaKeysCount,this._maxColorRGBKeysCount)}get mode(){return this._mode}set mode(e){this._mode=e}constructor(){this._mode=0,this._maxColorRGBKeysCount=0,this._colorRGBKeysCount=0,this._maxColorAlphaKeysCount=0,this._colorAlphaKeysCount=0,this._keyRanges=new s(1,0,1,0)}addColorRGB(e,t){if(this._colorRGBKeysCount>=this._maxColorRGBKeysCount){let e=new Float32Array(4*(this._maxColorRGBKeysCount+4));this._rgbElementDatas&&e.set(this._rgbElementDatas),this._rgbElements=e}let i=4*this._colorRGBKeysCount;this._rgbElementDatas[i]=e,this._rgbElementDatas[i+1]=t.r,this._rgbElementDatas[i+2]=t.g,this._rgbElementDatas[i+3]=t.b,this._colorRGBKeysCount++}addColorAlpha(e,t){if(this._colorAlphaKeysCount>=this._maxColorAlphaKeysCount){let e=new Float32Array(2*(this._maxColorAlphaKeysCount+4));this._alphaElementDatas&&e.set(this._alphaElementDatas),this._alphaElements=e}let i=2*this._colorAlphaKeysCount;this._alphaElementDatas[i]=e,this._alphaElementDatas[i+1]=t,this._colorAlphaKeysCount++}updateColorRGB(e,t,i){if(e<this._colorRGBKeysCount){var r=4*e;this._rgbElements[r]=t,this._rgbElements[r+1]=i.r,this._rgbElements[r+2]=i.g,this._rgbElements[r+3]=i.b,this._gpuRGBData4&&e<4&&(this._gpuRGBData4[r]=t,this._gpuRGBData4[r+1]=i.r,this._gpuRGBData4[r+2]=i.g,this._gpuRGBData4[r+3]=i.b),this._gpuRGBData8&&e<8&&(this._gpuRGBData8[r]=t,this._gpuRGBData8[r+1]=i.r,this._gpuRGBData8[r+2]=i.g,this._gpuRGBData8[r+3]=i.b)}else console.warn("Gradient:warning:index must lessEqual than colorRGBKeysCount:"+this._colorRGBKeysCount)}updateColorAlpha(e,t,i){if(e<this._colorAlphaKeysCount){var r=2*e;this._alphaElements[r]=t,this._alphaElements[r+1]=i,this._gpuAlphaData4&&e<4&&(this._gpuAlphaData4[r]=t,this._gpuAlphaData4[r+1]=i),this._gpuAlphaData8&&e<8&&(this._gpuAlphaData8[r]=t,this._gpuAlphaData8[r+1]=i)}else console.warn("Gradient:warning:index must lessEqual than colorAlphaKeysCount:"+this._colorAlphaKeysCount)}evaluateColorRGB(e,t,i=0,r=!1){e=Math.min(Math.max(e,0),1);var s=this._rgbElements,a=i;if(r)for(var n=a;n>=0;n--){var o=4*n;if(e===(_=s[o]))return t.r=s[o+1],t.g=s[o+2],t.b=s[o+3],a;var h=s[o+4];switch(this._mode){case mh.Blend:if(e>_&&h){if(e>h)continue;var l=h-_,u=h-e,d=e-_;return t.r=(u*s[o+1]+d*s[o+5])/l,t.g=(u*s[o+2]+d*s[o+6])/l,t.b=(u*s[o+3]+d*s[o+7])/l,a}a--;continue;case mh.Fixed:if(e>_){if(e>s[o+4])throw"Gradient:wrong startSearchIndex.";return t.r=s[o+5],t.g=s[o+6],t.b=s[o+7],a}a--;continue;default:throw"Gradient:unknown mode."}}else{n=0;for(var c=this._rgbElements.length;n<c;n++){if(e===(h=s[o=4*n]))return t.r=s[o+1],t.g=s[o+2],t.b=s[o+3],a;switch(this._mode){case mh.Blend:if(e<h){var _;if(e<(_=s[o-4]))throw"Gradient:wrong startSearchIndex.";l=h-_,u=h-e,d=e-_;return t.r=(u*s[o-3]+d*s[o+1])/l,t.g=(u*s[o-2]+d*s[o+2])/l,t.b=(u*s[o-1]+d*s[o+3])/l,a}a++;continue;case mh.Fixed:if(e<h){if(e<s[o-4])throw"Gradient:wrong startSearchIndex.";return t.r=s[o+1],t.g=s[o+2],t.b=s[o+3],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}evaluateColorAlpha(e,t,i=0,r=!1){e=Math.min(Math.max(e,0),1);var s=this._alphaElements,a=i;if(r)for(var n=a;n>=0;n--){if(e===(_=s[c=2*n]))return t.a=s[c+1],a;var o=s[c+2];switch(this._mode){case mh.Blend:if(e>_&&o){if(e>o)continue;var h=o-_,l=o-e,u=e-_;return t.a=(l*s[c+1]+u*s[c+3])/h,a}a--;continue;case mh.Fixed:if(e>_){if(e>s[c+2])throw"Gradient:wrong startSearchIndex.";return t.a=s[c+3],a}a--;continue;default:throw"Gradient:unknown mode."}}else{n=a;for(var d=this._alphaElements.length;n<d;n++){var c;if(e===(o=s[c=2*n]))return t.a=s[c+1],a;switch(this._mode){case mh.Blend:if(e<o){var _;if(e<(_=s[c-2]))throw"Gradient:wrong startSearchIndex.";h=o-_,l=o-e,u=e-_;return t.a=(l*s[c-1]+u*s[c+1])/h,a}a++;continue;case mh.Fixed:if(e<o){if(e<s[c-2])throw"Gradient:wrong startSearchIndex.";return t.a=s[c+1],a}a++;continue;default:throw"Gradient:unknown mode."}}}return a}_updateGpuData(e,t){let i=Math.min(e.length,t.length);for(let r=0;r<i;r++)e[r]=t[r]}_fixGPUAlphaData(e){if(1==this.colorAlphaKeysCount){let t=this._alphaElements[1];e[0]=0,e[1]=t,e[2]=1,e[3]=t}else 2==this.colorAlphaKeysCount?(e[0]=0,e[1]=this._alphaElements[1],e[2]=1,e[3]=this._alphaElements[3]):this._updateGpuData(e,this._alphaElements)}_fixGPURGBData(e){if(1==this.colorRGBKeysCount){let t=this._rgbElements[1],i=this._rgbElements[2],r=this._rgbElements[3];e[0]=0,e[1]=t,e[2]=i,e[3]=r,e[4]=1,e[5]=t,e[6]=i,e[7]=r}else 2==this.colorRGBKeysCount?(e[0]=0,e[1]=this._rgbElements[1],e[2]=this._rgbElements[2],e[3]=this._rgbElements[3],e[4]=1,e[5]=this._rgbElements[5],e[6]=this._rgbElements[6],e[7]=this._rgbElements[7]):this._updateGpuData(e,this._rgbElements)}_getGPURGBData4(){return this._gpuRGBData4||(this._gpuRGBData4=new Float32Array(16)),this._fixGPURGBData(this._gpuRGBData4),this._gpuRGBData4}_getGPURGBData8(){return this._gpuRGBData8||(this._gpuRGBData8=new Float32Array(32)),this._fixGPURGBData(this._gpuRGBData8),this._gpuRGBData8}_getGPUAlphaData4(){return this._gpuAlphaData4||(this._gpuAlphaData4=new Float32Array(8)),this._fixGPUAlphaData(this._gpuAlphaData4),this._gpuAlphaData4}_getGPUAlphaData8(){return this._gpuAlphaData8||(this._gpuAlphaData8=new Float32Array(16)),this._fixGPUAlphaData(this._gpuAlphaData8),this._gpuAlphaData8}cloneTo(e){e._colorAlphaKeysCount=this._colorAlphaKeysCount;let t=e._alphaElements=new Float32Array(this._alphaElements.length);for(let e=0,i=this._alphaElements.length;e<i;e++)t[e]=this._alphaElements[e];e._colorRGBKeysCount=this._colorRGBKeysCount;var i=e._rgbElements=new Float32Array(this._rgbElements.length);for(let e=0,t=this._rgbElements.length;e<t;e++)i[e]=this._rgbElements[e]}clone(){var e=new fh;return this.cloneTo(e),e}}var Th;e.WeightedMode=void 0,(Th=e.WeightedMode||(e.WeightedMode={}))[Th.None=0]="None",Th[Th.In=1]="In",Th[Th.Out=2]="Out",Th[Th.Both=3]="Both";class yh{constructor(){}cloneTo(e){e.time=this.time}clone(){var e=new yh;return this.cloneTo(e),e}}yh.defaultWeight=.33333;class xh extends yh{constructor(){super(),this.inWeight=yh.defaultWeight,this.outWeight=yh.defaultWeight,this.weightedMode=e.WeightedMode.None}cloneTo(e){super.cloneTo(e),e.inTangent=this.inTangent,e.outTangent=this.outTangent,e.value=this.value,e.inTangent=this.inTangent,e.outTangent=this.outTangent,e.value=this.value,e.inWeight=this.inWeight,e.outWeight=this.outWeight,e.weightedMode=this.weightedMode}clone(){let e=new xh;return this.cloneTo(e),e}}class vh extends ua{constructor(){super(),this._fps=30,this._width=this._height=200,this._widget=en.EMPTY;let t=new fe(new _e(this._width,this._height,e.TextureFormat.R8G8B8A8,!1,!1,!0));t.bitmap.lock=!0,this.texture=t}get fps(){return this._fps}set fps(e){this._fps!=e&&(this._fps=e,p.isPlaying&&this.activeInHierarchy&&window.wx&&window.sharedCanvas&&(h.timer.clear(this,this._onLoop),h.timer.loop(1e3/e,this,this._onLoop)))}_onActive(){p.isPlaying&&window.wx&&window.sharedCanvas&&h.timer.loop(1e3/this._fps,this,this._onLoop)}_onInActive(){p.isPlaying&&(this.postMsg({type:"close"}),h.timer.clear(this,this._onLoop))}get top(){return this._widget.top}set top(e){e!=this._widget.top&&(this._getWidget().top=e)}get bottom(){return this._widget.bottom}set bottom(e){e!=this._widget.bottom&&(this._getWidget().bottom=e)}get left(){return this._widget.left}set left(e){e!=this._widget.left&&(this._getWidget().left=e)}get right(){return this._widget.right}set right(e){e!=this._widget.right&&(this._getWidget().right=e)}get centerX(){return this._widget.centerX}set centerX(e){e!=this._widget.centerX&&(this._getWidget().centerX=e)}get centerY(){return this._widget.centerY}set centerY(e){e!=this._widget.centerY&&(this._getWidget().centerY=e)}_getWidget(){return this._widget===en.EMPTY&&(this._widget=this.addComponent(en)),this._widget}_onLoop(){let t=this.texture,i=window.sharedCanvas;t.width==i.width&&t.height==i.height||(t.bitmap.destroy(),t.bitmap=new _e(i.width,i.height,e.TextureFormat.R8G8B8A8,!1,!1,!0,!0),t.bitmap.lock=!0),I.onMiniGame?i.toTempFilePath&&t.bitmap.setImageData(i,!0,!1):t.bitmap.setImageData(i,!0,!1)}_transChanged(t){super._transChanged(t),0!=(t&e.TransformKind.Size)&&(window.sharedCanvas&&(window.sharedCanvas.width=this._width,window.sharedCanvas.height=this._height),this._widget!==en.EMPTY&&this._widget.resetLayout(),this.callLater(this.updateViewPort)),0!=(t&e.TransformKind.Pos)&&this.callLater(this.updateViewPort)}updateViewPort(){let e=h.stage,t=e._canvasTransform.getScaleX()*this.globalScaleX*e.transform.getScaleX(),i=e._canvasTransform.getScaleY()*this.globalScaleY*e.transform.getScaleY();this.postMsg({type:"updateViewPort",box:{x:this.x*t,y:this.y*i,width:this.width*t,height:this.height*i}})}postMsg(e){window.wx&&window.wx.getOpenDataContext&&window.wx.getOpenDataContext().postMessage(e)}}let Sh=Oe.regClass;Sh("Record",Object),Sh("Node",As),Sh("Sprite",ua),Sh("Widget",en),Sh("Text",Ca),Sh("Input",Ha),Sh("Animation",zn),Sh("SoundNode",$n),Sh("VideoNode",Jn),Sh("Area2D",Ja),Sh("OpenDataContextView",vh),Sh("Scene",rn),Sh("Stage",pn),Sh("Component",ta),Sh("Script",Mo),Sh("BitmapFont",ma),Sh("BlurFilter",Wn),Sh("ColorFilter",jn),Sh("GlowFilter",Kn),Sh("Point",d),Sh("Rectangle",G),Sh("Texture",fe),Sh("Texture2D",_e),Sh("Prefab",xo),Sh("Animator2D",oo),Sh("AnimatorControllerLayer2D",to),Sh("AnimatorState2D",ho),Sh("AnimationClip2D",go),Sh("AnimatorController2D",Ao),Sh("Animation2DParm",fo),Sh("Animation2DCondition",yo),Sh("FrameAnimation",Vn),Sh("Vector2",Gt),Sh("Vector3",a),Sh("Vector4",s),Sh("Quaternion",Xt),Sh("Color",m),Sh("Matrix",V),Sh("Matrix3x3",zt),Sh("Matrix4x4",Zt),Sh("Camera2D",sn),Sh("Mesh2DRender",gh),Sh("BaseRenderNode2D",aa),Sh("Mesh2D",Io),Sh("Gradient",fh),Sh("FloatKeyframe",xh);var Dh,Eh,wh,Rh,Ch,Ah,Mh;e.RenderCMDType=void 0,(Dh=e.RenderCMDType||(e.RenderCMDType={}))[Dh.DrawNode=0]="DrawNode",Dh[Dh.DrawElement=1]="DrawElement",Dh[Dh.Blit=2]="Blit",Dh[Dh.ChangeData=3]="ChangeData",Dh[Dh.ChangeShaderDefine=4]="ChangeShaderDefine",Dh[Dh.ChangeViewPort=5]="ChangeViewPort",Dh[Dh.ChangeRenderTarget=6]="ChangeRenderTarget";class bh{constructor(e,t,i,r,s){this._destroyed=!1,this._id=bh._idCounter++,this.cluster=e,this.index=t,this.size=i,this._alignedSize=r,this.offset=r*t,this.user=s,this.uploadNum=0,this.moved=!1}needUpload(){this.cluster._addUploadBlock(this.index),!this.moved&&this.uploadNum++>this.cluster.manager.uploadThreshold&&this.cluster.manager._addOptimizeBufferPos(this.cluster)}destroy(){return this._destroyed?(console.warn("UniformBufferBlock: object alreay destroyed!"),!1):(this._destroyed=!0,this.cluster=null,this.user=null,!0)}}bh._idCounter=0;class Ih{constructor(e,t,i){this._inManagerUpdateArray=!1,this._sn=0,this._id=0,this._destroyed=!1,this._blocks=[],this._holeNum=0,this._expand=16,this._id=Ih._idCounter++,this.manager=i,this._blockSize=e,this._blockNum=t,this._totalSize=e*t,this._needUpload=new Array(t).fill(!1),this.data=new ArrayBuffer(this._totalSize),this._move=new Uint8Array(this._blockSize),this.buffer=this.manager.createGPUBuffer(this._totalSize),this.manager.statisGPUMemory(this._totalSize)}get usedNum(){return this._blocks.length}_expandBuffer(){let e=this._blockNum;if(this._blockNum+=this._expand,this._blockNum>this.manager.clusterMaxBlock&&(this._blockNum=this.manager.clusterMaxBlock),e=this._blockNum-e,e<1)return!1;this._totalSize=this._blockSize*this._blockNum;const t=this._blockSize*this._expand;this._needUpload=this._needUpload.concat(new Array(e).fill(!1));const i=new ArrayBuffer(this._totalSize);return new Uint8Array(i).set(new Uint8Array(this.data)),this.data=i,this.buffer=this.manager.createGPUBuffer(this._totalSize),this.manager.statisGPUMemory(t),this._blocks.forEach((e=>e&&e.user.notifyGPUBufferChange("expand"))),!0}_moveBlock(e){const t=this._blocks.length;if(e>=t)return!1;const i=new Uint8Array(this.data),r=this._blockSize;for(let s=e+1;s<t;s++){const e=s*r,t=e+r,a=e-r;i.copyWithin(a,e,t),this._needUpload[s-1]=this._needUpload[s],this._blocks[s-1]=this._blocks[s],this._blocks[s-1]&&(this._blocks[s-1].index--,this._blocks[s-1].offset-=r,this._blocks[s-1].user.notifyGPUBufferChange("moveBlock"))}return this._blocks.length--,!0}_createBufferBlock(e,t,i,r){return new bh(this,e,t,i,r)}getBlock(e,t){const i=Bh(e,this.manager.byteAlign);if(i!==this._blockSize)return console.warn("WebGPUBufferCluster: 获取内存块时, 长度错误!"),null;const r=this._getBlockWithExpand(),s=this._createBufferBlock(r,e,i,t);return this._blocks[r]=s,s}freeBlock(e){const t=this._blocks.indexOf(e);return-1!==t&&(t===this._blocks.length-1?this._blocks.length--:(this._blocks[t]=null,this._holeNum++),e.destroy(),this._holeNum>this.manager.removeHoleThreshold&&(this.manager._addRemoveHoleCluster(this),this._holeNum=0),!0)}upload(){var e;let t=0,i=0,r=!1,s=-1,a=-1,n=0,o=0;for(let h=0,l=this._blocks.length;h<l;h++)this._needUpload[h]?(-1===s&&(s=h),a=h,r=!0,this._needUpload[h]=!1,null===(e=this._blocks[h])||void 0===e||e.user.updateOver()):r&&(n=s*this._blockSize,o=(a-s+1)*this._blockSize,this.manager.writeBuffer(this.buffer,this.data,n,o),t++,i+=o,s=-1,a=-1,r=!1);r&&(n=s*this._blockSize,o=(a-s+1)*this._blockSize,this.manager.writeBuffer(this.buffer,this.data,n,o),t++,i+=o),this.manager.statisUpload(t,i)}_addUploadBlock(e){this._needUpload[e]=!0,this._inManagerUpdateArray||this.manager._addUpdateArray(this)}optimize(){let e=!1;for(let t=0,i=this._blocks.length;t<i;t++){const i=this._blocks[t];if(i&&!i.moved&&i.uploadNum>this.manager.uploadThreshold&&t>0){const r=this._blockSize,s=new Uint8Array(this.data);this._move.set(new Uint8Array(this.data,r*t,r));for(let e=t-1;e>=0;e--){const t=e*r,i=t+r,a=t+r;s.copyWithin(a,t,i),this._needUpload[e+1]=this._needUpload[e],this._blocks[e+1]=this._blocks[e],this._blocks[e+1]&&(this._blocks[e+1].index++,this._blocks[e+1].offset+=r,this._blocks[e+1].user.notifyGPUBufferChange("optimize"))}s.set(this._move),i.index=0,i.offset=0,i.moved=!0,this._blocks[0]=i,this._blocks[0].user.notifyGPUBufferChange("optimize"),e=!0,this.manager._enableStat&&this.manager._stat.moveNum++}}return e}removeHole(){let e=!1;for(let t=this._blocks.length-1;t>-1;t--)this._blocks[t]||this._moveBlock(t)&&(e=!0,this.manager._enableStat&&this.manager._stat.moveNum++);return this._holeNum=0,e}clear(e){this._blocks.forEach((e=>e&&e.destroy())),this._blocks.length=0,null!=e&&e>0&&e!==this._blockNum?(this._blockNum=e,this._totalSize=this._blockSize*this._blockNum,this.buffer=this.manager.createGPUBuffer(this._totalSize),this.data=new ArrayBuffer(this._totalSize)):(this._blockNum=0,this._totalSize=0,this.buffer=null,this.data=null),this._needUpload.length=this._blockNum,this._needUpload.fill(!1)}_getBlockWithExpand(){for(let e=this._blocks.length-1;e>-1;e--)if(!this._blocks[e])return this._holeNum--,e;return this._blocks.length<this._blockNum||this._expandBuffer(),this._blocks.length}destroy(){var e;return this._destroyed?(console.warn("UniformBufferCluster: object alreay destroyed!"),!1):(this.clear(),null!==(e=this.buffer.destroy)&&void 0!==e||this.buffer.destroy(),this.manager.statisGPUMemory(-this._totalSize),this._destroyed=!0,!0)}}function Bh(e,t){return((e+t-1)/t|0)*t}Ih._idCounter=0;class Lh{constructor(){this.moveNum=0,this.uploadNum=0,this.uploadByte=0,this.timeCostAvg=0,this.timeCostSum=0,this.timeCostCount=0}}class Ph{constructor(e,t,i){this._destroyed=!1,this.uploadNum=0,this.data=new ArrayBuffer(e),this.buffer=t.getBufferAlone(e),this._manager=t,this._size=e,this._alignedSize=Bh(e,t.byteAlign),this.user=i,t.aloneBuffers.push(this)}upload(){let e;this._manager._enableStat&&(e=performance.now()),this.uploadNum++,this._manager.writeBuffer(this.buffer,this.data,0,this._size),this._manager._enableStat&&(this._manager.statisUpload(1,this._size),this._manager.statisTimeCostAvg(performance.now()-e))}destroy(){return this._destroyed?(console.warn("UniformBufferAlone: object alreay destroyed!"),!1):(this.data=null,this.buffer.destroy&&this.buffer.destroy(),this._manager.statisGPUMemory(-this._size),this._manager.aloneBuffers.splice(this._manager.aloneBuffers.indexOf(this),1),this._destroyed=!0,!0)}}class Nh{constructor(e,t,i,r){this.destroyed=!1,this.name=e,this._strId="",this._items=new Map,this._itemNum=0,this.data=r,this._size=t,this.manager=i,this.needUpload=!1,i._useBigBuffer?(this.bufferBlock=i.getBlock(t,this),this.offset=this.bufferBlock.offset):this.bufferAlone=this._createBufferAlone(t,i)}_createBufferAlone(e,t){return new Ph(e,t,this)}updateOver(){this.needUpload=!1}notifyGPUBufferChange(){const e=this.bufferBlock.offset-this.offset;this.offset=this.bufferBlock.offset,this._items.forEach((t=>{const i=Nh._typeArray(t.type);t.view=new i(this.bufferBlock.cluster.data,t.view.byteOffset+e,t.size/i.BYTES_PER_ELEMENT)})),this.clearGPUBufferBind(),this.needUpload=!0}clearGPUBufferBind(){}addUniform(e,t,i,r,s,a,n,o){this._items.has(e)||(this._items.set(e,this._getUniformItem(t,Nh._typeArray(i),i,r,s,a,n,o)),this._strId.length>0&&(this._strId+="|"),this._strId+=e,this._itemNum++)}setUniformData(e,t){const i=this._items.get(e);if(i)if(this.needUpload=!0,1==i.count)switch(i.type){case"int":case"float":i.view[0]=t;break;case"vec2":i.view[0]=t.x,i.view[1]=t.y;break;case"vec3":i.view[0]=t.x,i.view[1]=t.y,i.view[2]=t.z;break;case"vec4":i.view[0]=t.x,i.view[1]=t.y,i.view[2]=t.z,i.view[3]=t.w;break;case"mat3":for(let e=0;e<3;e++)i.view[4*e+0]=t.elements[3*e+0],i.view[4*e+1]=t.elements[3*e+1],i.view[4*e+2]=t.elements[3*e+2];break;case"mat4":i.view.set(t.elements)}else{const e=i.count*i.elements,r=i.size/i.count/i.view.BYTES_PER_ELEMENT;for(let s=0,a=0;s<e;s+=i.elements,a+=r)i.view.set(t.subarray(s,s+i.elements),a)}}setBool(e,t){const i=this._items.get(e);i&&(i.view[0]=t?1:0,this.needUpload=!0)}setBoolArray(e,t){const i=this._items.get(e);if(i){for(let e=0,r=Math.min(i.count,t.length);e<r;e++)i.view[e]=t[e]?1:0;this.needUpload=!0}}setInt(e,t){const i=this._items.get(e);i&&(i.view[0]=t,this.needUpload=!0)}setIntArray(e,t){const i=this._items.get(e);if(i){for(let e=0,r=Math.min(i.count,t.length);e<r;e++)i.view[e]=t[e];this.needUpload=!0}}setFloat(e,t){const i=this._items.get(e);i&&(i.view[0]=t,this.needUpload=!0)}setFloatArray(e,t){const i=this._items.get(e);if(i){for(let e=0,r=Math.min(i.count,t.length);e<r;e++)i.view[e]=t[e];this.needUpload=!0}}setVector2(e,t){const i=this._items.get(e);i&&(i.view[0]=t.x,i.view[1]=t.y,this.needUpload=!0)}setVector2Array(e,t){const i=this._items.get(e);if(i){for(let e=0,r=Math.min(i.count,t.length);e<r;e++)i.view[2*e+0]=t[e].x,i.view[2*e+1]=t[e].y;this.needUpload=!0}}setVector3(e,t){const i=this._items.get(e);i&&(i.view[0]=t.x,i.view[1]=t.y,i.view[2]=t.z,this.needUpload=!0)}setVector3Array(e,t){const i=this._items.get(e);if(i){for(let e=0,r=Math.min(i.count,t.length);e<r;e++)i.view[4*e+0]=t[e].x,i.view[4*e+1]=t[e].y,i.view[4*e+2]=t[e].z;this.needUpload=!0}}setVector4(e,t){const i=this._items.get(e);i&&(i.view[0]=t.x,i.view[1]=t.y,i.view[2]=t.z,i.view[3]=t.w,this.needUpload=!0)}setVector4Array(e,t){const i=this._items.get(e);if(i){for(let e=0,r=Math.min(i.count,t.length);e<r;e++)i.view[4*e+0]=t[e].x,i.view[4*e+1]=t[e].y,i.view[4*e+2]=t[e].z,i.view[4*e+3]=t[e].w;this.needUpload=!0}}setMatrix3x3(e,t){const i=this._items.get(e);if(i){for(let e=0;e<3;e++)i.view[4*e+0]=t.elements[3*e+0],i.view[4*e+1]=t.elements[3*e+1],i.view[4*e+2]=t.elements[3*e+2];this.needUpload=!0}}setMatrix3x3Array(e,t){const i=this._items.get(e);if(i){for(let e=0,r=Math.min(i.count,t.length);e<r;e++)for(let r=0;r<3;r++)i.view[16*e+4*r+0]=t[e].elements[3*r+0],i.view[16*e+4*r+1]=t[e].elements[3*r+1],i.view[16*e+4*r+2]=t[e].elements[3*r+2];this.needUpload=!0}}setMatrix4x4(e,t){const i=this._items.get(e);i&&(i.view.set(t.elements),this.needUpload=!0)}setMatrix4x4Array(e,t){const i=this._items.get(e);if(i){for(let e=0,r=Math.min(i.count,t.length);e<r;e++)i.view.set(t[e].elements,16*e);this.needUpload=!0}}setBuffer(e,t){this.setUniformData(e,t)}getUniform(e){return this._items.get(e)}hasUniform(e){return this._items.has(e)}isMe(e){return this._strId===e}upload(){this.needUpload&&(this.manager._useBigBuffer?this.bufferBlock.needUpload():this.bufferAlone.upload(),this.needUpload=!1)}clear(){this.manager._useBigBuffer?new Uint8Array(this.bufferBlock.cluster.data).fill(0,this.bufferBlock.offset,this.bufferBlock.offset+this.bufferBlock.size):new Uint8Array(this.bufferAlone.data).fill(0),this._strId="",this._items.clear(),this._itemNum=0,this.needUpload=!1}destroy(){return this.destroyed?(console.warn("UniformBufferUser: object alreay destroyed!"),!1):(this.manager._useBigBuffer?this.manager.freeBlock(this.bufferBlock):this.bufferAlone.destroy(),this.destroyed=!0,!0)}_getUniformItem(e,t,i,r,s,a,n,o){let h;return h=this.manager._useBigBuffer?new t(this.bufferBlock.cluster.data,this.bufferBlock.offset+r,a/t.BYTES_PER_ELEMENT):new t(this.bufferAlone.data,r,a/t.BYTES_PER_ELEMENT),{name:e,view:h,type:i,align:s,size:a,elements:n,count:o}}static _typeArray(e){return"int"===e?Int32Array:Float32Array}}class Oh{static create(e,t,i){}constructor(e){this.blendType=0}}Oh._blend_All_pool={},Oh._blend_seperate_pool={};class Fh{static getHash(e,t,i){return e+(t<<3)+(i<<7)}static getBlendComponent(e,t,i){let r=Fh.getHash(e,t,i);return Fh._pool[r]||(Fh._pool[r]=new Fh(e,t,i,r)),Fh._pool[r]}constructor(e,t,i,r){this._hashIndex=0,this._hashIndex=r,this._blendOperationGLData=e,this._sourceBlendFactor=t,this._destinationFactor=i}}Fh._pool={};class Uh{get bufferUsage(){return this._bufferUsage}constructor(e,t){this._byteLength=0,this._bufferType=e,this._bufferUsage=t}destroy(){}}e.RenderClearFlag=void 0,(Eh=e.RenderClearFlag||(e.RenderClearFlag={}))[Eh.Nothing=0]="Nothing",Eh[Eh.Color=1]="Color",Eh[Eh.Depth=2]="Depth",Eh[Eh.Stencil=4]="Stencil",e.RenderDrawMode=void 0,(wh=e.RenderDrawMode||(e.RenderDrawMode={}))[wh.TRIANGLES=0]="TRIANGLES",wh[wh.POINTS=1]="POINTS",wh[wh.LINES=2]="LINES",e.RenderIndexMode=void 0,(Rh=e.RenderIndexMode||(e.RenderIndexMode={}))[Rh.UNSIGNED_BYTE=0]="UNSIGNED_BYTE",Rh[Rh.UNSIGNED_SHORT=1]="UNSIGNED_SHORT",Rh[Rh.UNSIGNED_INT=2]="UNSIGNED_INT",e.RenderStateType=void 0,(Ch=e.RenderStateType||(e.RenderStateType={}))[Ch.DepthTest=0]="DepthTest",Ch[Ch.DepthMask=1]="DepthMask",Ch[Ch.DepthFunc=2]="DepthFunc",Ch[Ch.StencilTest=3]="StencilTest",Ch[Ch.StencilMask=4]="StencilMask",Ch[Ch.StencilFunc=5]="StencilFunc",Ch[Ch.StencilOp=6]="StencilOp",Ch[Ch.BlendType=7]="BlendType",Ch[Ch.BlendEquation=8]="BlendEquation",Ch[Ch.BlendEquationSeparate=9]="BlendEquationSeparate",Ch[Ch.BlendFunc=10]="BlendFunc",Ch[Ch.BlendFuncSeperate=11]="BlendFuncSeperate",Ch[Ch.CullFace=12]="CullFace",Ch[Ch.FrontFace=13]="FrontFace",e.TextureCompareMode=void 0,(Ah=e.TextureCompareMode||(e.TextureCompareMode={}))[Ah.None=0]="None",Ah[Ah.LEQUAL=1]="LEQUAL",Ah[Ah.GEQUAL=2]="GEQUAL",Ah[Ah.LESS=3]="LESS",Ah[Ah.GREATER=4]="GREATER",Ah[Ah.EQUAL=5]="EQUAL",Ah[Ah.NOTEQUAL=6]="NOTEQUAL",Ah[Ah.ALWAYS=7]="ALWAYS",Ah[Ah.NEVER=8]="NEVER",e.TextureDecodeFormat=void 0,(Mh=e.TextureDecodeFormat||(e.TextureDecodeFormat={}))[Mh.Normal=0]="Normal",Mh[Mh.RGBM=1]="RGBM";class kh{static glslAttributeString(e){let t="";for(const i in e){let r=Gh(e[i][1]);""!=r&&(t=`${t}attribute ${r} ${i};\n`)}return t}static glslUniformString(t,i,r){if(0==t.size)return"";if(i){let i="",s="uniform Material"+r+"{\n",a=0;return t.forEach(((t,r)=>{let n=t.uniformtype,o=t.propertyName;t.arrayLength;let h=Gh(n);""!=h&&(!function(t){switch(t){case e.ShaderDataType.Int:case e.ShaderDataType.Bool:case e.ShaderDataType.Float:case e.ShaderDataType.Vector2:case e.ShaderDataType.Vector3:case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:case e.ShaderDataType.Matrix4x4:case e.ShaderDataType.Matrix3x3:return!0;default:return!1}}(n)?i+=`uniform ${h} ${o};\n`:(s+=`${h} ${o};\n`,a++))})),s+="};\n",a>0?s+i:i}{let e="";return t.forEach(((t,i)=>{let r=t.uniformtype,s=t.propertyName;t.arrayLength;let a=Gh(r);""!=a&&(e+=`uniform ${a} ${s};\n`)})),e}}static GLShaderLanguageProcess3D(i,r,s,a,n,h){var l,u,d=o.lightClusterCount,c={},_="";let p=t.matUseUBO,m=kh.glslAttributeString(r),f=kh.glslUniformString(s,p,h);g.renderEngine.getParams(e.RenderParams.SHADER_CAPAILITY_LEVEL)>30?(i.push("GRAPHICS_API_GLES3"),l=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n    precision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n    precision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define attribute in\n#define varying out\n#define textureCube texture\n#define texture2D texture\n${m}\n${f}\n`,u=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n\tprecision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n\tprecision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define gl_FragDepthEXT gl_FragDepth\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n${f}`):(l=`#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n${m}\n${f}`,u=`#ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\n#ifdef GL_OES_standard_derivatives\n\t#extension GL_OES_standard_derivatives : enable \n#endif\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n\n#if !defined(GL_EXT_shader_texture_lod)\n    #define texture1DLodEXT texture1D\n    #define texture2DLodEXT texture2D\n    #define texture2DProjLodEXT texture2DProj\n    #define texture3DLodEXT texture3D\n    #define textureCubeLodEXT textureCube\n#endif\n${f}`),_+="#define MAX_LIGHT_COUNT "+o.maxLightCount+"\n",_+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+o._maxAreaLightCountPerClusterAverage+"\n",_+="#define CLUSTER_X_COUNT "+d.x+"\n",_+="#define CLUSTER_Y_COUNT "+d.y+"\n",_+="#define CLUSTER_Z_COUNT "+d.z+"\n",_+="#define MORPH_MAX_COUNT "+o.maxMorphTargetCount+"\n",_+="#define SHADER_CAPAILITY_LEVEL "+g.renderEngine.getParams(e.RenderParams.SHADER_CAPAILITY_LEVEL)+"\n";for(var T=0,y=i.length;T<y;T++){var x=i[T];_+="#define "+x+"\n",c[x]=!0}var v=a.toscript(c,[]),S="";0==v[0].indexOf("#version")&&(S=v[0]+"\n",v.shift());var D=n.toscript(c,[]),E="";return 0==D[0].indexOf("#version")&&(E=D[0]+"\n",D.shift()),{vs:S+l+_+v.join("\n"),fs:E+u+_+D.join("\n")}}}function Gh(t){switch(t){case e.ShaderDataType.Int:return"int";case e.ShaderDataType.Bool:return"bool";case e.ShaderDataType.Float:return"float";case e.ShaderDataType.Vector2:return"vec2";case e.ShaderDataType.Vector3:return"vec3";case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:return"vec4";case e.ShaderDataType.Matrix4x4:return"mat4";case e.ShaderDataType.Matrix3x3:return"mat3";case e.ShaderDataType.Texture2D:return"sampler2D";case e.ShaderDataType.TextureCube:return"samplerCube";case e.ShaderDataType.Texture2DArray:return g.renderEngine.getCapable(e.RenderCapable.Texture3D)?"sampler2DArray":"";case e.ShaderDataType.Texture3D:return g.renderEngine.getCapable(e.RenderCapable.Texture3D)?"sampler3D":"";default:return""}}class Vh{constructor(){this.onID=Vh.pointID++,this.textureID=-1}}Vh.pointID=0;class zh{static getVertexLayoutByPool(e){let t=zh._pool;for(var i in t){let r=t[i];if(r.deepthEqaul(e))return r}return new zh(e)}constructor(e){this.VAElements=new Array,this.attributeByteSize=new Array,this.instanceMode=new Array;for(let t=0;t<e.length;t++){let i=[],r=e[t].vertexDeclaration.vertexStride,s=e[t].vertexDeclaration._VAElements;for(let e=0;e<s.length;e++)i.push({format:s[e].format,stride:s[e].stride,shaderLocation:s[e].shaderLocation});this.attributeByteSize.push(r),this.VAElements.push(i),this.instanceMode.push(e[t].instanceBuffer)}this.id=zh.IPoint,zh._pool[zh.IPoint++]=this}deepthEqaul(e){if(e.length!=this.VAElements.length)return!1;for(var t=0;t<e.length;t++){let s=e[t]._vertexDeclaration._VAElements,a=this.VAElements[t];if(s.length!=a.length)return!1;for(var i=0,r=s.length;i<r;i++){let e=s[i],t=a[i];if(e.format!=t.format||e.stride!=t.stride||e.shaderLocation!=t.shaderLocation)return!1}}return!0}}zh.IPoint=0,zh._pool={};class Hh{constructor(){this._commandBuffer=null}recover(){this._commandBuffer=null,this._context=null}destroy(){this._commandBuffer=null,this._context=null}}class Wh extends Hh{static __initBlitShader__(){let t={a_PositionTexcoord:[0,e.ShaderDataType.Vector4]},i={u_OffsetScale:e.ShaderDataType.Vector4,u_MainTex:e.ShaderDataType.Texture2D,u_MainTex_TexelSize:e.ShaderDataType.Vector4},r=gi.add("Blit2DCMD");r.shaderType=e.ShaderFeatureType.PostProcess;let s=new _i(t,i);r.addSubShader(s);let a=s.addShaderPass("\n        #define SHADER_NAME Blit2DVS\n\n        varying vec2 v_Texcoord0;\n\n        void main()\n        {\n            gl_Position = vec4(u_OffsetScale.x * 2.0 - 1.0 + (a_PositionTexcoord.x + 1.0) * u_OffsetScale.z, (1.0 - ((u_OffsetScale.y * 2.0 - 1.0 + (-a_PositionTexcoord.y + 1.0) * u_OffsetScale.w) + 1.0) / 2.0) * 2.0 - 1.0, 0.0, 1.0);\n\n            v_Texcoord0 = a_PositionTexcoord.zw;\n\n            #ifdef INVERTY\n            gl_Position.y = -gl_Position.y;\n            #endif\n        }\n        ",'\n        #define SHADER_NAME Blit2DFS\n\n        #include "Color.glsl";\n\n        varying vec2 v_Texcoord0;\n\n        void main()\n        {\n            vec4 mainColor = texture2D(u_MainTex, v_Texcoord0);\n            #ifdef Gamma_u_MainTex\n            mainColor = gammaToLinear(mainColor);\n            #endif // Gamma_u_AlbedoTexture\n            gl_FragColor = mainColor;\n            gl_FragColor = outputTransform(gl_FragColor);\n        }\n        ');a.statefirst=!0,a.renderState.depthWrite=!1,a.renderState.depthTest=At.DEPTHTEST_OFF,a.renderState.blend=At.BLEND_ENABLE_ALL,a.renderState.blendEquation=At.BLENDEQUATION_ADD,a.renderState.srcBlend=At.BLENDPARAM_ONE,a.renderState.dstBlend=At.BLENDPARAM_ONE_MINUS_SRC_ALPHA,a.renderState.cull=At.CULL_NONE}static __initGeometryElement__(){let t=new Float32Array([1,1,1,1,1,-1,1,0,-1,1,0,1,-1,-1,0,0]),i=new nt(16,[new ot(0,st.Vector4,0)]),r=g.renderDeviceFactory.createVertexBuffer(e.BufferUsage.Dynamic);r.vertexDeclaration=i,r.setDataLength(t.buffer.byteLength),r.setData(t.buffer,0,0,t.buffer.byteLength);let s=g.renderDeviceFactory.createBufferState();s.applyState([r],null);let a=Wh.QuadGeometry=g.renderDeviceFactory.createRenderGeometryElement(e.MeshTopology.TriangleStrip,e.DrawType.DrawArray);a.setDrawArrayParams(0,4),a.bufferState=s}static __init__(){Wh.__initBlitShader__(),Wh.__initGeometryElement__(),Wh._blitShaderData=g.renderDeviceFactory.createShaderData(),Wh._defaultShader=gi.find("Blit2DCMD")}static create(e,t,i=null,r=null,s=null){var a;return Wh._blitShaderData||Wh.__init__(),(a=Wh._pool.length>0?Wh._pool.pop():new Wh).source=e,a.dest=t,a.offsetScale=i,a.setshader(r,s),a}constructor(){super(),this._source=null,this._dest=null,this._offsetScale=new s,this._shader=null,this._shaderData=null,this._renderElement=g.render2DRenderPassFactory.createRenderElement2D(),this._blitQuadCMDData=g.render2DRenderPassFactory.createBlit2DQuadCMDData(),this._blitQuadCMDData.element=this._renderElement,this._renderElement.geometry=Wh.QuadGeometry,this._renderElement.nodeCommonMap=null,this._renderElement.renderStateIsBySprite=!1}get offsetScale(){return this._offsetScale}set offsetScale(e){e?e.cloneTo(this._offsetScale):Wh._defaultOffsetScale.cloneTo(this._offsetScale),this._blitQuadCMDData.offsetScale=this._offsetScale}get source(){return this._source}set source(e){this._source=e,this._blitQuadCMDData.source=e?e._texture:_e.blackTexture._texture}get dest(){return this._dest}set dest(e){this._dest=e,this._blitQuadCMDData.dest=e?e._renderTarget:null}set shaderData(e){this._shaderData=e||Wh._blitShaderData,this._renderElement.materialShaderData=this._shaderData}getRenderCMD(){return this._blitQuadCMDData}setshader(e,t){this._shader=e||Wh._defaultShader,this.shaderData=t,this._renderElement.subShader=this._shader.getSubShaderAt(0)}destroy(){this._commandBuffer=null,this._context=null}}Wh._defaultOffsetScale=new s(0,0,1,1),Wh._pool=[];class Yh extends Hh{static create(e,t,i,r,s){var a=Yh._pool.length>0?Yh._pool.pop():new Yh;return a.mesh=e,a.material=s,a.texture=i,a.color=r,a._setMatrix(t),a}constructor(){super(),this._drawElementData=g.render2DRenderPassFactory.createDraw2DElementCMDData(),this._mesh2DRender=new gh,this._needUpdateElement=!0,this._matrix=new V}_setMatrix(e){e?e.copyTo(this._matrix):V.EMPTY.copyTo(this._matrix);let t=this._matrix,i=a.TEMP;i.x=t.a,i.y=t.c,i.z=t.tx,this._mesh2DRender._spriteShaderData.setVector3(aa.NMATRIX_0,i),i.x=t.b,i.y=t.d,i.z=t.ty,this._mesh2DRender._spriteShaderData.setVector3(aa.NMATRIX_1,i)}set material(e){e!=this.material&&(e||(e=gh.mesh2DDefaultMaterial),this._mesh2DRender.sharedMaterial=e,this._needUpdateElement=!0)}get material(){return this._mesh2DRender.sharedMaterial}set mesh(e){e!=this.mesh&&(this._mesh2DRender.sharedMesh=e,this._needUpdateElement=!0)}get mesh(){return this._mesh2DRender.sharedMesh}set texture(e){this._mesh2DRender.texture=e}get texture(){return this._mesh2DRender.texture}set color(e){this._mesh2DRender.color=e}get color(){return this._mesh2DRender.color}getRenderCMD(){return this._drawElementData}run(){this._needUpdateElement&&(this._drawElementData.setRenderelements(this._mesh2DRender._renderElements),this._needUpdateElement=!1),this._mesh2DRender._setRenderSize(this._commandBuffer._renderSize.x,this._commandBuffer._renderSize.y)}recover(){Yh._pool.push(this),super.recover(),this.material=null,this.texture=null,this.mesh=null}destroy(){super.destroy(),this.material=null}}Yh._pool=[];class Xh extends Hh{static create(e,t=null){var i=Xh._pool.length>0?Xh._pool.pop():new Xh;return i.renderElement=e,i._setMatrix(t),i}get renderElement(){return this._renderElement}set renderElement(e){this._renderElement=e,this._drawElementCMDData.setRenderelements([this._renderElement])}constructor(){super(),this._drawElementCMDData=g.render2DRenderPassFactory.createDraw2DElementCMDData(),this._renderSize=new Gt}_setMatrix(e){if(this._matreix=e?e.clone():null,this._matreix&&-1!=this.renderElement.nodeCommonMap.indexOf("BaseRender2D")){let e=a.TEMP;e.x=this._matreix.a,e.y=this._matreix.c,e.z=this._matreix.tx,this._renderElement.value2DShaderData.setVector3(aa.NMATRIX_0,e),e.x=this._matreix.b,e.y=this._matreix.d,e.z=this._matreix.ty,this._renderElement.value2DShaderData.setVector3(aa.NMATRIX_1,e)}}run(){Gt.equals(this._renderSize,this._commandBuffer._renderSize)||(this._renderSize.setValue(this._commandBuffer._renderSize.x,this._commandBuffer._renderSize.y),this._renderElement.value2DShaderData.setVector2(aa.BASERENDERSIZE,this._renderSize))}recover(){super.recover(),Xh._pool.push(this)}getRenderCMD(){return this._drawElementCMDData}destroy(){this._renderElement=null,this._drawElementCMDData=null}}Xh._pool=[];class qh extends Hh{static create(e,t,i,r=!0){var s;return(s=qh._pool.length>0?qh._pool.pop():new qh).renderTexture=e,s._setRenderTargetCMD.clearColor=t,s._setRenderTargetCMD.clearColorValue=i,s._setRenderTargetCMD.invertY=r,s}get renderTexture(){return this._renderTexture}set renderTexture(e){this._renderTexture=e,this._setRenderTargetCMD.rt=e?e._renderTarget:null}constructor(){super(),this._renderTexture=null,this._setRenderTargetCMD=g.render2DRenderPassFactory.createSetRendertarget2DCMD()}run(){this._renderTexture?this._commandBuffer._renderSize.setValue(this._renderTexture._renderTarget._textures[0].width,this._renderTexture._renderTarget._textures[0].height):this._commandBuffer._renderSize.setValue(_t.width,_t.height)}getRenderCMD(){return this._setRenderTargetCMD}recover(){qh._pool.push(this),this._renderTexture=null}}qh._pool=[];class jh extends Hh{static create(e,t,i,r){var s;return(s=jh._pool.length>0?jh._pool.pop():new jh).setDest(e),s._setRenderDataCMD.propertyID=t,s._setRenderDataCMD.dataType=r,s._setRenderDataCMD.value=i,s}constructor(){super(),this._globalMode=!1,this._setRenderDataCMD=g.render2DRenderPassFactory.createSetRenderDataCMD()}getRenderCMD(){return this._setRenderDataCMD}setDest(e){this._setRenderDataCMD.dest=e}recover(){jh._pool.push(this),this._globalMode=!1}}jh._pool=[];class Kh extends Hh{static create(e,t,i){var r;return(r=Kh._pool.length>0?Kh._pool.pop():new Kh).setDest(e),r._setRenderDefineCMD.add=i,r._setRenderDefineCMD.define=t,r}constructor(){super(),this._globalMode=!1,this._setRenderDefineCMD=g.render2DRenderPassFactory.createSetShaderDefineCMD()}setDest(e){this._setRenderDefineCMD.dest=e}getRenderCMD(){return this._setRenderDefineCMD}recover(){Kh._pool.push(this),this._globalMode=!1}}Kh._pool=[];class $h extends ta{constructor(){super(...arguments),this.duration=1e3,this.delay=0,this.repeat=0,this.autoDestroyAtComplete=!0}_onAwake(){this.target=this.target||this.owner,this.autoDestroyAtComplete&&(this._comlete=Se.create(this.target,this.target.destroy,null,!1)),this.eventName?this.owner.on(this.eventName,this,this._exeTween):this._exeTween()}_exeTween(){this._tween=this._doTween(),this._tween.repeat(this.repeat)}_doTween(){return null}onReset(){this.duration=1e3,this.delay=0,this.repeat=0,this.ease=null,this.target=null,this.eventName&&(this.owner.off(this.eventName,this,this._exeTween),this.eventName=null),this._comlete&&(this._comlete.recover(),this._comlete=null),this._tween&&(this._tween.clear(),this._tween=null)}}class Qh{}Qh.STANDARD=0,Qh.LEFT=1,Qh.RIGHT=2,Qh.NUM_PAD=3;class Zh{}Zh.NUMBER_0=48,Zh.NUMBER_1=49,Zh.NUMBER_2=50,Zh.NUMBER_3=51,Zh.NUMBER_4=52,Zh.NUMBER_5=53,Zh.NUMBER_6=54,Zh.NUMBER_7=55,Zh.NUMBER_8=56,Zh.NUMBER_9=57,Zh.A=65,Zh.B=66,Zh.C=67,Zh.D=68,Zh.E=69,Zh.F=70,Zh.G=71,Zh.H=72,Zh.I=73,Zh.J=74,Zh.K=75,Zh.L=76,Zh.M=77,Zh.N=78,Zh.O=79,Zh.P=80,Zh.Q=81,Zh.R=82,Zh.S=83,Zh.T=84,Zh.U=85,Zh.V=86,Zh.W=87,Zh.X=88,Zh.Y=89,Zh.Z=90,Zh.F1=112,Zh.F2=113,Zh.F3=114,Zh.F4=115,Zh.F5=116,Zh.F6=117,Zh.F7=118,Zh.F8=119,Zh.F9=120,Zh.F10=121,Zh.F11=122,Zh.F12=123,Zh.F13=124,Zh.F14=125,Zh.F15=126,Zh.NUMPAD=21,Zh.NUMPAD_0=96,Zh.NUMPAD_1=97,Zh.NUMPAD_2=98,Zh.NUMPAD_3=99,Zh.NUMPAD_4=100,Zh.NUMPAD_5=101,Zh.NUMPAD_6=102,Zh.NUMPAD_7=103,Zh.NUMPAD_8=104,Zh.NUMPAD_9=105,Zh.NUMPAD_ADD=107,Zh.NUMPAD_DECIMAL=110,Zh.NUMPAD_DIVIDE=111,Zh.NUMPAD_ENTER=108,Zh.NUMPAD_MULTIPLY=106,Zh.NUMPAD_SUBTRACT=109,Zh.SEMICOLON=186,Zh.EQUAL=187,Zh.COMMA=188,Zh.MINUS=189,Zh.PERIOD=190,Zh.SLASH=191,Zh.BACKQUOTE=192,Zh.LEFTBRACKET=219,Zh.BACKSLASH=220,Zh.RIGHTBRACKET=221,Zh.QUOTE=222,Zh.ALTERNATE=18,Zh.BACKSPACE=8,Zh.CAPS_LOCK=20,Zh.COMMAND=15,Zh.CONTROL=17,Zh.DELETE=46,Zh.ENTER=13,Zh.ESCAPE=27,Zh.PAGE_UP=33,Zh.PAGE_DOWN=34,Zh.END=35,Zh.HOME=36,Zh.LEFT=37,Zh.UP=38,Zh.RIGHT=39,Zh.DOWN=40,Zh.SHIFT=16,Zh.SPACE=32,Zh.TAB=9,Zh.INSERT=45;class Jh{static getMCDName(e){return Jh._typeToNameDic[e]}static showRenderTypeInfo(e,t=!1){if(t||!Jh.showedDic[e]){if(Jh.showedDic[e]=!0,!Jh._rendertypeToStrDic[e]){var i,r=[];for(i=1;i<=e;)i&e&&r.push(Jh.getMCDName(i&e)),i<<=1;Jh._rendertypeToStrDic[e]=r.join(",")}console.log("cmd:",Jh._rendertypeToStrDic[e])}}static __init__(){Jh._typeToNameDic[je.ALPHA]="ALPHA",Jh._typeToNameDic[je.TRANSFORM]="TRANSFORM",Jh._typeToNameDic[je.TEXTURE]="TEXTURE",Jh._typeToNameDic[je.GRAPHICS]="GRAPHICS",Jh._typeToNameDic[je.CHILDS]="CHILDS",Jh._typeToNameDic[je.TRANSFORM|je.ALPHA]="TRANSFORM|ALPHA",Jh._typeToNameDic[je.CANVAS]="CANVAS",Jh._typeToNameDic[je.BLEND]="BLEND",Jh._typeToNameDic[je.FILTERS]="FILTERS",Jh._typeToNameDic[je.MASK]="MASK",Jh._typeToNameDic[je.CLIP]="CLIP"}constructor(){}render(e,t,i){Jh._addType(this._renderType),Jh.showRenderTypeInfo(this._renderType),Ur.renders[this._renderType]._fun(this,e,t+this._x,i+this._y),this._repaint=0}_stageRender(e,t,i){Jh._countStart(),Jh._PreStageRender.call(h.stage,e,t,i),Jh._countEnd()}static _countStart(){var e;for(e in Jh._countDic)Jh._countDic[e]=0}static _countEnd(){Jh._i++,Jh._i>60&&(Jh.showCountInfo(),Jh._i=0)}static _addType(e){Jh._countDic[e]?Jh._countDic[e]+=1:Jh._countDic[e]=1}static showCountInfo(){var e;for(e in console.log("==================="),Jh._countDic)console.log("count:"+Jh._countDic[e]),Jh.showRenderTypeInfo(e,!0)}static enableQuickTest(){Jh.__init__(),ua.prototype.render=Jh.prototype.render,Jh._PreStageRender=pn.prototype.render,pn.prototype.render=Jh.prototype._stageRender}}Jh.showedDic={},Jh._rendertypeToStrDic={},Jh._typeToNameDic={},Jh._countDic={},Jh._i=0;class el extends yh{cloneTo(e){super.cloneTo(e),e.value=this.value}clone(){let e=new el;return this.cloneTo(e),e}}class tl{static lerp(e,t,i){return e*(1-i)+t*i}static repeat(e,t){return e-Math.floor(e/t)*t}static distance(e,t,i,r){return Math.sqrt(Math.pow(e-i,2)+Math.pow(t-r,2))}static clamp(e,t,i){return e<t?e=t:e>i&&(e=i),e}static clamp01(e){return isNaN(e)?e=0:e>1?e=1:e<0&&(e=0),e}static slerpQuaternionArray(e,t,i,r,s,a,n){var o,h,l,u,d,c=e[t+0],_=e[t+1],p=e[t+2],g=e[t+3],m=i[r+0],f=i[r+1],T=i[r+2],y=i[r+3];return(h=c*m+_*f+p*T+g*y)<0&&(h=-h,m=-m,f=-f,T=-T,y=-y),1-h>1e-6?(o=Math.acos(h),l=Math.sin(o),u=Math.sin((1-s)*o)/l,d=Math.sin(s*o)/l):(u=1-s,d=s),a[n+0]=u*c+d*m,a[n+1]=u*_+d*f,a[n+2]=u*p+d*T,a[n+3]=u*g+d*y,a}static getRotation(e,t,i,r){return Math.atan2(r-t,i-e)/Math.PI*180}static sortBigFirst(e,t){return e==t?0:t>e?1:-1}static sortSmallFirst(e,t){return e==t?0:t>e?-1:1}static sortNumBigFirst(e,t){return parseFloat(t)-parseFloat(e)}static sortNumSmallFirst(e,t){return parseFloat(e)-parseFloat(t)}static sortByKey(e,t=!1,i=!0){var r;return r=t?i?tl.sortNumBigFirst:tl.sortBigFirst:i?tl.sortNumSmallFirst:tl.sortSmallFirst,function(t,i){return r(t[e],i[e])}}}class il{constructor(e,t,i,r){this.minDepth=0,this.maxDepth=1,this.x=null!=e?e:0,this.y=null!=t?t:0,this.width=null!=i?i:0,this.height=null!=r?r:0}project(e,t,i){a.transformV3ToV4(e,t,i);var r=i.x,s=i.y,n=i.z,o=i.w;1!==o&&(r/=o,s/=o,n/=o),i.x=.5*(r+1)*this.width+this.x,i.y=.5*(1-s)*this.height+this.y,i.z=n*(this.maxDepth-this.minDepth)+this.minDepth}unprojectFromMat(e,t,i){var r=t.elements;i.x=(e.x-this.x)/this.width*2-1,i.y=-((e.y-this.y)/this.height*2-1),i.z=(e.z-this.minDepth)/(this.maxDepth-this.minDepth);var s=i.x*r[3]+i.y*r[7]+i.z*r[11]+r[15];a.transformV3ToV3(i,t,i),1!==s&&(i.x=i.x/s,i.y=i.y/s,i.z=i.z/s)}unprojectFromWVP(e,t,i,r,s){Zt.multiply(t,i,rl),r&&Zt.multiply(rl,r,rl),rl.invert(rl),this.unprojectFromMat(e,rl,s)}set(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}cloneTo(e){e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e.minDepth=this.minDepth,e.maxDepth=this.maxDepth}}il.TEMP=new il(0,0,0,0);const rl=new Zt;class sl extends D{get input(){return this._input}get output(){return this._output}get connected(){return this._connected}get endian(){return this._endian}set endian(e){this._endian=e,null!=this._input&&(this._input.endian=e),null!=this._output&&(this._output.endian=e)}constructor(e=null,t=0,i=null,r=null,s=!1){super(),this.disableInput=!1,this.protocols=[],this._byteClass=i||Y,this.protocols=r,this.endian=sl.BIG_ENDIAN,e&&t>0&&t<65535&&this.connect(e,t,s)}connect(e,t,i=!1){this.connectByUrl(`${i?"wss":"ws"}://${e}:${t}`)}connectByUrl(e){null!=this._socket&&this.close(),this._socket&&this.cleanSocket(),this.protocols&&0!=this.protocols.length?this._socket=new I.window.WebSocket(e,this.protocols):this._socket=new I.window.WebSocket(e),this._socket.binaryType="arraybuffer",this._output=new this._byteClass,this._output.endian=this.endian,this._input=new this._byteClass,this._input.endian=this.endian,this._addInputPosition=0,this._socket.onopen=e=>{this._onOpen(e)},this._socket.onmessage=e=>{this._onMessage(e)},this._socket.onclose=e=>{this._onClose(e)},this._socket.onerror=e=>{this._onError(e)}}cleanSocket(){this.close(),this._connected=!1,this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=null}close(){if(null!=this._socket)try{this._socket.close()}catch(e){}}_onOpen(e){this._connected=!0,this.event(c.OPEN,e)}_onMessage(e){if(e&&e.data){var t=e.data;if(this.disableInput&&t)this.event(c.MESSAGE,t);else{this._input.length>0&&this._input.bytesAvailable<1&&(this._input.clear(),this._addInputPosition=0);var i=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0),this._input.pos=this._addInputPosition,t&&("string"==typeof t?this._input.writeUTFBytes(t):this._input.writeArrayBuffer(t),this._addInputPosition=this._input.pos,this._input.pos=i),this.event(c.MESSAGE,t)}}}_onClose(e){this._connected=!1,this.event(c.CLOSE,e)}_onError(e){this.event(c.ERROR,e)}send(e){this._socket.send(e)}flush(){if(this._output&&this._output.length>0){var e;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length))}catch(t){e=t}this._output.endian=this.endian,this._output.clear(),e&&this.event(c.ERROR,e)}}}sl.LITTLE_ENDIAN="littleEndian",sl.BIG_ENDIAN="bigEndian";class al{static getHash(e,t,i,r=9191891){var s,a=0;for(s=0;s<i;s++)a=(2*a+e[t+s])%r;return a}static isSame(e,t,i,r,s,a){if(i!=a)return!1;var n,o;for(o=i,n=0;n<o;n++)if(e[t+n]!=r[s+n])return!1;return!0}}class nl{static get instance(){return nl._instance||(nl._instance=new nl)}static IsJsonbin(e){if(e.byteLength<5)return!1;const t=new Uint32Array(e,0,4)[0];return t==nl.ISJSONBIN||t==nl.ISJSONBIN2||t==nl.ISJSONBIN3}static parse(e){var t=new Int32Array(e,0,4);if(t[0]!==nl.ISJSONBIN&&t[0]!==nl.ISJSONBIN2){var i=new Y;i.writeArrayBuffer(e),i.pos=0;var r=i.readUTFBytes();return JSON.parse(r)}return(new nl).read(e)}static parsePack(e){var t=(new nl).read(e);for(var i in t)Be.cacheRes(i,t[i]);return t}constructor(){}_readArray(e,t,i,r,s){var a,n=[];n.length=i,t>=0&&(a=e.pos,e.pos=t);for(var o=0;o<i;o++)n[o]=this._readOne({},e,null,e.readUint8(),s);return t>=0&&(e.pos=a),n}_getLen(e){let t=e.readUint8();return 0==(128&t)?t:e.readUint8()|(-129&t)<<8}static _toLargeNumber(e,t){let i=t.toString(16);if(i.length<7)for(let e=i.length;e<7;e++)i="0"+i;return parseInt(e.toString(16)+""+i,16)}static readInt8Array(e,t,i){var r=t+i;r=r>e._length?e._length:r;var s=new Int8Array(e._d_.buffer.slice(t,r));return e._pos_=r,s}_readOne(e,t,i,r,s){let a,n;switch(r){case nl.NULL:n=null;break;case nl.NUM8:n=t.readByte();break;case nl.NUM16:n=t.readInt16();break;case nl.NUM32:n=t.readInt32();break;case nl.NUM64:n=nl._toLargeNumber(t.readInt32(),t.readInt32());break;case nl.BOOLEAN:n=!!t.readByte();break;case nl.DOUBLE:n=t.readFloat32();break;case nl.NUM16_1000:n=t.readInt16()/1e3;break;case nl.NUM32_1000:n=t.readInt32()/1e3;break;case nl.STRING:n=s.keyArray[t.readUint16()][0];break;case nl.WORDTEXT:a=t.readUint16(),n=s.keyArray[a][3],n||(n=s.keyArray[a][3]=new lr,n.setText(s.keyArray[a][0]));break;case nl.ARRAYEMPTY:t.readUint8(),n=[];break;case nl.ARRAYNUM8:n=[],n.length=a=t.readUint8();for(let e=0;e<a;e++)n[e]=t.readByte();break;case nl.ARRAYNUM16:n=[],n.length=a=t.readUint8();for(let e=0;e<a;e++)n[e]=t.readInt16();break;case nl.ARRAYNUM32:n=[],n.length=a=t.readUint8();for(let e=0;e<a;e++)n[e]=t.readInt32();break;case nl.ARRAYDOUBLE:n=[],n.length=a=t.readUint8();for(let e=0;e<a;e++)n[e]=t.readFloat32();break;case nl.ARRAYBUFFER:n=t.readArrayBuffer(t.readUint16());break;case nl.ARRAYBUFFER32:n=t.readArrayBuffer(t.readUint32());break;case nl.INT8ARRAY:a=this._getLen(t),n=nl.readInt8Array(t,t.pos,a);break;case nl.UINT8ARRAY:a=this._getLen(t),n=t.readUint8Array(t.pos,a);break;case nl.INT16ARRAY:a=this._getLen(t),n=t.readInt16Array(t.pos,a);break;case nl.FLOAT32ARRAY:a=this._getLen(t),n=t.readFloat32Array(t.pos,a);break;default:return this._readOne_other(e,t,i,r,s)}return e&&i&&(e[i]=n),n}_readOne_other(e,t,i,r,s){let a,n,o,h,l=e;switch(r){case nl.ARRAY8:case nl.ARRAY16:case nl.ARRAY32:switch(r){case nl.ARRAY8:n=t.readUint8();break;case nl.ARRAY16:n=t.readInt16();break;case nl.ARRAY32:n=t.readUint32()}var u=a=[];for(u.length=n,o=0;o<n;o++)r=t.readUint8(),u[o]=this._readOne(null,t,null,r,s);break;case nl.ARRAYREFSOURCE8:case nl.ARRAYREFSOURCE16:n=r===nl.ARRAYREFSOURCE8?t.readUint8():t.readInt16(),h=t.pos-this._dataStartOfs,a=this._readArray(t,-1,n,r,s),this._objectRef[h]={array:a,pos:h};break;case nl.ARRAYREF:case nl.ARRAYREF32:o=t.readByte(),h=r==nl.ARRAYREF?t.readUint16():t.readUint32();let d=this._objectRef[h];if(!d)throw"load ref err";a=o==nl.COMPRESS_NEW?this._readArray(t,h+this._dataStartOfs,d.array.length,r,s):d.array;break;case nl.OBJECT:case nl.OBJECTTHISCLASS:if(null!=i||!e){if(r==nl.OBJECT)l={};else if(n=t.readUint16(),l=this._createObjWithClass(s.keyArray[n][0]),!l)throw"jsonbin read err,no this class:"+s.keyArray[n][0];i&&e&&(e[i]=l)}let c;for(;n=t.readUint16(),n!=nl.OBJECTEND;)c=s.keyArray[n],this._readOne(l,t,c[0],c[1],s);a=l,l=e}return null!=i&&(l[i]=a),a}read(e,t=null){this._createObjWithClass=t;let i,r,s=I.now(),a=new Y;switch(a.writeArrayBuffer(e),a.pos=0,this._objectRef={},r=a.readInt32(),r){case nl.ISJSONBIN:i=a.readUTFString();break;case nl.ISJSONBIN2:case nl.ISJSONBIN3:i=a.readUTFString32();break;default:return a.pos=0,null}var n=new ol;n.strs=i.split(nl.SPLITCHAR),n.keyArray.length=n.strs.length/2;for(var o=0,h=n.strs.length;o<h;o+=2)n.keyArray[o/2]=[n.strs[o],parseInt(n.strs[o+1])];let l=I.now();this._dataStartOfs=a.pos;var u={};return this._readOne(u,a,null,nl.OBJECT,n),I.now()-s>10&&console.debug("jsonbinread delay:",I.now()-s+"/"+(l-s),e.byteLength),r==nl.ISJSONBIN3?u.top:u}}nl.ISJSONBIN=16777215,nl.ISJSONBIN2=16777214,nl.ISJSONBIN3=16777213,nl.SPLITCHAR=String.fromCharCode(3),nl.COMPRESS_NEW=1,nl.COMPRESS_REF=2,nl.COMPRESS_REFMODIFY=3,nl.NUM8=0,nl.NUM16=1,nl.NUM32=2,nl.BOOLEAN=3,nl.DOUBLE=4,nl.STRING=5,nl.ARRAY8=6,nl.ARRAY16=7,nl.ARRAYEMPTY=8,nl.ARRAYNUM8=9,nl.ARRAYNUM16=10,nl.ARRAYNUM32=11,nl.ARRAYDOUBLE=12,nl.ARRAYSTRING=13,nl.NULL=14,nl.OBJECT=15,nl.NUM16_1000=16,nl.NUM32_1000=17,nl.WORDTEXT=18,nl.ARRAYBUFFER=19,nl.ARRAYREF=20,nl.ARRAYREFSOURCE8=21,nl.ARRAYREFSOURCE16=22,nl.ARRAYBUFFER32=23,nl.ARRAYREF32=24,nl.ARRAY32=25,nl.OBJECTTHISCLASS=26,nl.NUM64=27,nl.INT8ARRAY=28,nl.UINT8ARRAY=29,nl.INT16ARRAY=30,nl.FLOAT32ARRAY=31,nl.OBJECTEND=32767;class ol{constructor(){this.keys={},this.strs=["BEGIN",0],this.keyArray=[],this.keyIndex=1}}class hl{static get instance(){return hl._instance||(hl._instance=new hl)}constructor(){this.objectRef={},this.deep=0}_saveKey(e,t,i,r){this.deep++;var s=e+"/&&__*?/"+t,a=i.keys[s];a||(a=i.keys[s]=i.keyIndex,i.strs.push(e,t),i.keyIndex++),r.writeUint16(a),this.deep--}_getValueArrayType(e){switch(typeof e){case"number":if(Math.floor(e)!==e)return nl.ARRAYDOUBLE;var t=Math.abs(e);return t<128?nl.ARRAYNUM8:t<32767?nl.ARRAYNUM16:nl.ARRAYNUM32;case"string":return nl.OBJECT;case"boolean":return nl.BOOLEAN}return nl.OBJECT}_writeStrOrWordText(e,t,i,r,s){var a=s?nl.WORDTEXT:nl.STRING;null!=t?this._saveKey(t,a,e,r):r.writeUint8(a);var n=e.keys[i];n||(n=e.keys[i]=e.keyIndex,e.strs.push(i,0),e.keyIndex++),r.writeUint16(n)}_writeString(e,t,i){var r=e.keys[t];r||(r=e.keys[t]=e.keyIndex,e.strs.push(t,0),e.keyIndex++),i.writeUint16(r)}_getObjectTypeof(e){return e instanceof ArrayBuffer?"ArrayBuffer":e instanceof Uint8Array?"Uint8Array":e instanceof Int8Array?"Int8Array":e instanceof Int16Array?"Int16Array":e instanceof Float32Array?"Float32Array":e instanceof WordText||hl.isWordText(e)?"WordText":"object"}static isWordText(e){return e&&e._text&&(e._$_$ISWORDTYEXT||null!=e.lastGCCnt)}_writeLen(e,t){if(t<128)e.writeUint8(t);else{if(!(t<32768))throw"jsonbin save len must<0x8000 "+t;e.writeUint8(t>>8|128),e.writeUint8(255&t)}}_writeBigNumber(e,t){let i=t.toString(16),r=parseInt(i.substring(0,i.length-7),16),s=parseInt(i.substring(i.length-7),16);if(e.writeInt32(r),e.writeInt32(s),nl._toLargeNumber(r,s)!=t)throw"save big number err:"+t}_writeOne(e,t,i,r,s){if(null==r)return!1;let a=typeof r;if("object"==a&&r){if(r.$__$disbaleJsonBinSv)return r.$__$disbaleJsonBinSv,hl.NOSAVETHISOBJ_DELETE,!1;a=this._getObjectTypeof(r)}switch(a){case"number":if(Math.floor(r)!==r){var n=1e3*r;if((0|n)===n){if(Math.abs(r)<32)return null!=i?this._saveKey(i,nl.NUM16_1000,t,e):e.writeUint8(nl.NUM16_1000),e.writeInt16(n),!0;if(Math.abs(r)<2147483)return null!=i?this._saveKey(i,nl.NUM32_1000,t,e):e.writeUint8(nl.NUM32_1000),e.writeInt32(n),!0}return null!=i?this._saveKey(i,nl.DOUBLE,t,e):e.writeUint8(nl.DOUBLE),e.writeFloat32(r),!0}var o=Math.abs(r);return o<128?(null!=i?this._saveKey(i,nl.NUM8,t,e):e.writeUint8(nl.NUM8),e.writeByte(r),!0):o<32767?(null!=i?this._saveKey(i,nl.NUM16,t,e):e.writeUint8(nl.NUM16),e.writeInt16(r),!0):o<2147483647?(null!=i?this._saveKey(i,nl.NUM32,t,e):e.writeUint8(nl.NUM32),e.writeInt32(r),!0):(null!=i?this._saveKey(i,nl.NUM64,t,e):e.writeUint8(nl.NUM64),this._writeBigNumber(e,r),!0);case"string":return this._writeStrOrWordText(t,i,r,e,!1),!0;case"boolean":return null!=i?this._saveKey(i,nl.BOOLEAN,t,e):e.writeUint8(nl.BOOLEAN),e.writeByte(r?1:0),!0;case"ArrayBuffer":return null!=i?this._saveKey(i,nl.ARRAYBUFFER32,t,e):e.writeUint8(nl.ARRAYBUFFER32),e.writeUint32(r.byteLength),e.writeArrayBuffer(r),!0;case"Uint8Array":return null!=i?this._saveKey(i,nl.UINT8ARRAY,t,e):e.writeUint8(nl.UINT8ARRAY),this._writeLen(e,r.byteLength),e.writeArrayBuffer(r.buffer),!0;case"Int8Array":return null!=i?this._saveKey(i,nl.INT8ARRAY,t,e):e.writeUint8(nl.INT8ARRAY),this._writeLen(e,r.byteLength),e.writeArrayBuffer(r.buffer),!0;case"Int16Array":return null!=i?this._saveKey(i,nl.INT16ARRAY,t,e):e.writeUint8(nl.INT16ARRAY),this._writeLen(e,r.byteLength),e.writeArrayBuffer(r.buffer),!0;case"Float32Array":return null!=i?this._saveKey(i,nl.FLOAT32ARRAY,t,e):e.writeUint8(nl.FLOAT32ARRAY),this._writeLen(e,r.byteLength),e.writeArrayBuffer(r.buffer),!0;case"WordText":return this._writeStrOrWordText(t,i,r._text,e,!0),!0;case"object":break;default:throw"jsonbin no this type:"+a}return r?r instanceof Array?this._saveArray(s,e,t,i,r):(this._classEnable_&&r.__CLASS__?null!=i?this._saveKey(i,nl.OBJECTTHISCLASS,t,e):e.writeUint8(nl.OBJECTTHISCLASS):null!=i?this._saveKey(i,nl.OBJECT,t,e):e.writeUint8(nl.OBJECT),this._writeObject(e,t,r),e.writeUint16(nl.OBJECTEND),!0):(null!=i?this._saveKey(i,nl.NULL,t,e):e.writeUint8(nl.NULL),!0)}_saveArray(e,t,i,r,s){var a,n,o,h=s.length;if(0===h)return null!=r?this._saveKey(r,nl.ARRAYEMPTY,i,t):t.writeUint8(nl.ARRAYEMPTY),t.writeByte(0),!0;if(h>1&&h<250&&(n=this._getValueArrayType(s[0]))!=nl.OBJECT){for(a=1;a<h;a++)if(n!==this._getValueArrayType(s[a])){n=nl.OBJECT;break}if(n!=nl.OBJECT&&n!=nl.BOOLEAN){switch(null!=r?this._saveKey(r,n,i,t):t.writeUint8(n),t.writeUint8(s.length),n){case nl.ARRAYNUM8:for(a=0;a<h;a++)t.writeByte(s[a]);break;case nl.ARRAYNUM16:for(a=0;a<h;a++)t.writeInt16(s[a]);break;case nl.ARRAYNUM32:for(a=0;a<h;a++)t.writeInt32(s[a]);break;case nl.ARRAYDOUBLE:for(a=0;a<h;a++)t.writeFloat32(s[a])}return!0}}o=h<250?nl.ARRAY8:h<32700?nl.ARRAY16:nl.ARRAY32;var l=t.pos;null!=r?this._saveKey(r,o,i,t):t.writeUint8(o);var u=t.pos,d=0;switch(o){case nl.ARRAY8:t.writeUint8(h);break;case nl.ARRAY16:t.writeInt16(h);break;case nl.ARRAY32:t.writeUint32(h)}var c,_=t.pos;for(a=0;a<h;a++)this._writeOne(t,i,null,s[a],e)&&d++;if(d!=h){var p=t.pos;t.pos=u,o==nl.ARRAY8?t.writeUint8(d):t.writeInt16(d),t.pos=p}return r&&e&&(c=e[hl.COMPRESS+r])&&this._useCompress(t,i,r,s,l,_,c,o),!0}_useCompress(e,t,i,r,s,a,n,o){var h,l,u,d,c=e.pos-a,_=al.getHash(e._u8d_,a,c);if(this.objectRef[_]){var p=this.objectRef[_];for(d=p.length,u=0;u<d;u++)if((l=p[u]).value==r){h=l;break}if(!h)for(u=0;u<d;u++)if(l=p[u],al.isSame(e._u8d_,l.pos,l.len,e._u8d_,a,c)){h=l;break}}else this.objectRef[_]=[];h?(e.pos=s,this._saveKey(i,nl.ARRAYREF32,t,e),e.writeByte(n),e.writeUint32(h.pos)):(this.objectRef[_].push({hashCode:_,pos:a,len:c,value:r}),e.pos=s,this._saveKey(i,o==nl.ARRAY8?nl.ARRAYREFSOURCE8:nl.ARRAYREFSOURCE16,t,e),e.pos=a+c)}_writeObject(e,t,i){for(var r in this._classEnable_&&i.__CLASS__&&this._writeString(t,i.__CLASS__,e),i)r&&r.length>hl.NOSAVE_KEY_LEN&&r.substr(0,hl.NOSAVE_KEY_LEN)==hl.NOSAVEKEY||this._classEnable_&&"__CLASS__"==r||this._writeOne(e,t,r,i[r],i)}write(e,t=!1){this.deep=0,this._classEnable_=t;var i=new ll;this.objectRef={};var r=new Y;this._writeObject(r,i,{top:e}),r.writeUint16(nl.OBJECTEND);var s=new Y;return s.writeInt32(nl.ISJSONBIN3),s.writeUTFString32(i.strs.join(nl.SPLITCHAR)),s.writeArrayBuffer(r.buffer),s.buffer}}hl.COMPRESS="_$TeMpkEy$_CoMpReSs",hl.NOSAVEKEY="_$TeMpkEyNoSv$_",hl.NOSAVETHISOBJ="$__$disbaleJsonBinSv",hl.NOSAVE_KEY_LEN=15,hl.NOSAVETHISOBJ_DELETE=2,hl.NOSAVETHISOBJ_TRUE=1;class ll{constructor(){this.keys={},this.strs=["BEGIN",0],this.keyArray=[],this.keyIndex=1}}var ul,dl;e.PhysicsShape=void 0,(ul=e.PhysicsShape||(e.PhysicsShape={}))[ul.BoxShape=0]="BoxShape",ul[ul.CircleShape=1]="CircleShape",ul[ul.PolygonShape=2]="PolygonShape",ul[ul.ChainShape=3]="ChainShape",ul[ul.EdgeShape=4]="EdgeShape";class cl extends M{static get defaultTexture(){return this._defaultTexture}static __init__(){g.renderEngine.getCapable(e.RenderCapable.Texture3D)&&(this._defaultTexture=new cl(1,1,1,e.TextureFormat.R8G8B8A8,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255])))}constructor(t,i,r,s,a=!0,n=!1){super(t,i,s),this._dimension=e.TextureDimension.Tex3D,this.depth=r,this._gammaSpace=n;let o=g.textureContext;this._texture=o.createTexture3DInternal(this._dimension,t,i,r,s,a,n,!1)}setPixelsData(e){let t=this._texture;g.textureContext.setTexture3DPixelsData(t,e,this.depth,!1,!1)}setSubPixelsData(e,t,i,r,s,a,n,o,h){let l=this._texture;g.textureContext.setTexture3DSubPixelsData(l,n,o,h,e,t,i,r,s,a,!1,!1)}}class _l{static getRT(t,i){return i|=0,(t|=0)>=1e4&&console.error("getRT error! w too big"),new pe(t,i,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None)}static releaseRT(e){e.destroy()}}_l.dict={};class pl{static begin(e){}static end(e){}}class gl{}function ml(e){pl.begin(e)}function fl(e){pl.end(e)}function Tl(){}window.PerformanceDefine=gl,window.PERF_BEGIN=ml,window.PERF_BEGIN=fl,window.PERF_FRAMECLEAR=Tl,e.CurveType=void 0,(dl=e.CurveType||(e.CurveType={}))[dl.CRSpline=0]="CRSpline",dl[dl.Bezier=1]="Bezier",dl[dl.CubicBezier=2]="CubicBezier",dl[dl.Straight=3]="Straight";class yl{constructor(){this.pos=new a,this.c1=new a,this.c2=new a,this.curve=0}static create(e,t,i,r){let s=xl.take();return s.pos.set(e,t,i),s.curve=r||0,s}recover(){xl.recover(this)}clone(){let e=xl.take();return this.pos.cloneTo(e.pos),this.c1.cloneTo(e.c1),this.c2.cloneTo(e.c2),e.curve=this.curve,e}_reset(){this.pos.set(0,0,0),this.c1.set(0,0,0),this.c2.set(0,0,0),this.curve=0}}const xl=l.createPool(yl,null,(e=>e._reset()));const vl=new a,Sl=new a,Dl=l.createPool(a,null,(e=>e.set(0,0,0)));class El extends D{constructor(){super(...arguments),this._tweenDic=[],this._tweenDataList=[],this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._firstTweenDic={},this._startTimeSort=!1,this._endTimeSort=!1,this._loopKey=!1,this.scale=1,this._frameRate=60,this._frameIndex=0,this._total=0}static to(e,t,i,r=null,s=0){return(new El).to(e,t,i,r,s)}static from(e,t,i,r=null,s=0){return(new El).from(e,t,i,r,s)}to(e,t,i,r=null,s=0){return this._create(e,t,i,r,s,!0)}from(e,t,i,r=null,s=0){return this._create(e,t,i,r,s,!1)}_create(e,t,i,r,s,a){var n=l.getItemByClass("tweenData",wl);return n.isTo=a,n.type=0,n.target=e,n.duration=i,n.data=t,n.startTime=this._startTime+s,n.endTime=n.startTime+n.duration,n.ease=r,this._startTime=Math.max(n.endTime,this._startTime),this._tweenDataList.push(n),this._startTimeSort=!0,this._endTimeSort=!0,this}addLabel(e,t){var i=l.getItemByClass("tweenData",wl);return i.type=1,i.data=e,i.endTime=i.startTime=this._startTime+t,this._labelDic||(this._labelDic={}),this._labelDic[e]=i,this._tweenDataList.push(i),this}removeLabel(e){if(this._labelDic&&this._labelDic[e]){var t=this._labelDic[e];if(t){var i=this._tweenDataList.indexOf(t);i>-1&&this._tweenDataList.splice(i,1)}delete this._labelDic[e]}}gotoTime(e){if(null!=this._tweenDataList&&0!=this._tweenDataList.length){for(let o in this._firstTweenDic){let h=this._firstTweenDic[o];if(h)for(let l in h)l in h.diyTarget&&(h.diyTarget[l]=h[l])}for(let u of this._tweenDic)js.kill(u);var t,i;if(this._tweenDic.length=0,this._index=0,this._currTime=e,this._lastTime=I.now(),null==this._endTweenDataList||this._endTimeSort){function d(e,t){return e.endTime>t.endTime?1:e.endTime<t.endTime?-1:0}this._endTimeSort=!1,this._endTweenDataList=t=this._tweenDataList.concat(),t.sort(d)}else t=this._endTweenDataList;for(var r=0,s=t.length;r<s;r++)if(0==(i=t[r]).type){if(!(e>=i.endTime))break;this._index=Math.max(this._index,r+1);var a=i.data;if(i.isTo)for(var n in a)i.target[n]=a[n]}for(r=0,s=this._tweenDataList.length;r<s;r++)if(0==(i=this._tweenDataList[r]).type&&e>=i.startTime&&e<i.endTime){let c;this._index=Math.max(this._index,r+1),c=i.isTo?js.to(i.target,i.data,i.duration,i.ease,Se.create(this,this._animComplete)):js.from(i.target,i.data,i.duration,i.ease,Se.create(this,this._animComplete)),this._tweenDic.push(c)}}}gotoLabel(e){if(null!=this._labelDic){var t=this._labelDic[e];t&&this.gotoTime(t.startTime)}}pause(){h.timer.clear(this,this._update)}resume(){this.play(this._currTime,this._loopKey)}play(e=0,t=!1){if(this._tweenDataList){if(this._startTimeSort){function u(e,t){return e.startTime>t.startTime?1:e.startTime<t.startTime?-1:0}this._startTimeSort=!1,this._tweenDataList.sort(u);for(var i=0,r=this._tweenDataList.length;i<r;i++){var s=this._tweenDataList[i];if(null!=s&&0==s.type){var a=s.target,n=O.getGID(a),o=null;for(var l in null==this._firstTweenDic[n]?((o={}).diyTarget=a,this._firstTweenDic[n]=o):o=this._firstTweenDic[n],s.data)null==o[l]&&(o[l]=a[l])}}}"string"==typeof e?this.gotoLabel(e):this.gotoTime(e),this._loopKey=t,this._lastTime=I.now(),h.timer.frameLoop(1,this,this._update)}}_update(){if(this._currTime>=this._startTime){if(!this._loopKey){for(let e of this._tweenDic)e.complete();return this.pause(),void this._complete()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var e=I.now(),t=e-this._lastTime,i=this._currTime+=t*this.scale;if(this._lastTime=e,0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var r=this._tweenDataList[this._index];if(i>=r.startTime)if(this._index++,0==r.type){let e;e=r.isTo?js.to(r.target,r.data,r.duration,r.ease,Se.create(this,this._animComplete)):js.from(r.target,r.data,r.duration,r.ease,Se.create(this,this._animComplete)),this._tweenDic.push(e)}else this.event(c.LABEL,r.data)}}_animComplete(e){let t=this._tweenDic.indexOf(e.owner);t>-1&&this._tweenDic.splice(t,1)}_complete(){this.event(c.COMPLETE)}get index(){return this._frameIndex}set index(e){this._frameIndex=e,this.gotoTime(this._frameIndex/this._frameRate*1e3)}get total(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}reset(){var e,t,i;if(this._labelDic)for(e in this._labelDic)delete this._labelDic[e];for(let e of this._tweenDic)js.kill(e);for(e in this._tweenDic.length=0,this._firstTweenDic)delete this._firstTweenDic[e];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length)for(i=this._tweenDataList.length,t=0;t<i;t++)this._tweenDataList[t]&&this._tweenDataList[t].destroy();this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this.scale=1,h.timer.clear(this,this._update)}destroy(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null}}class wl{constructor(){this.type=0,this.isTo=!0}destroy(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,l.recover("tweenData",this)}}class Rl{static init(){if(!Rl.lookup){Rl.lookup=new Uint8Array(256);for(var e=0;e<Rl.chars.length;e++)Rl.lookup[Rl.chars.charCodeAt(e)]=e}}static isBase64String(e){return Rl.reg.test(e)}static encode(e){var t,i=new Uint8Array(e),r=i.length,s="";for(t=0;t<r;t+=3)s+=Rl.chars[i[t]>>2],s+=Rl.chars[(3&i[t])<<4|i[t+1]>>4],s+=Rl.chars[(15&i[t+1])<<2|i[t+2]>>6],s+=Rl.chars[63&i[t+2]];return r%3==2?s=s.substring(0,s.length-1)+"=":r%3==1&&(s=s.substring(0,s.length-2)+"=="),s}static decode(e){Rl.init();var t,i,r,s,a,n=.75*e.length,o=e.length,h=0;"="===e[e.length-1]&&(n--,"="===e[e.length-2]&&n--);var l=new ArrayBuffer(n),u=new Uint8Array(l);for(t=0;t<o;t+=4)i=Rl.lookup[e.charCodeAt(t)],r=Rl.lookup[e.charCodeAt(t+1)],s=Rl.lookup[e.charCodeAt(t+2)],a=Rl.lookup[e.charCodeAt(t+3)],h+1>n||(u[h++]=i<<2|r>>4,h+1>n||(u[h++]=(15&r)<<4|s>>2,h+1>n||(u[h++]=(3&s)<<6|63&a)));return l}}Rl.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Rl.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,Rl.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,Rl.lookup=null;const Cl=new G,Al=new d;class Ml{contains(e,t,i){return!!Ml._isHitGraphic(e,t,i,this._hit)&&!Ml._isHitGraphic(e,t,i,this._unHit)}static _isHitGraphic(e,t,i,r){if(!r)return!1;let s=r.cmds;if(0==s.length)return!1;let a=s.length;for(let r=0;r<a;r++){let a=s[r];if(a){if(a.cmdID===xs.ID)e-=a.tx,t-=a.ty;if(Ml._isHitCmd(e,t,i,a))return!0}}return!1}static _isHitCmd(e,t,i,r){if(!r)return!1;var s=!1;switch(r.cmdID){case"DrawRect":r.percent?Cl.setTo(r.x*i.width,r.y*i.height,r.width*i.width,r.height*i.height):Cl.setTo(r.x,r.y,r.width,r.height),s=Cl.contains(e,t);break;case"DrawCircle":let a=r.radius;r.percent?(e-=r.x*i.width,t-=r.y*i.height,a*=i.width):(e-=r.x,t-=r.y),s=e*e+t*t<a*a;break;case"DrawPoly":e-=r.x,t-=r.y,s=Ml._ptInPolygon(e,t,r.points)}return s}static _ptInPolygon(e,t,i){var r=Al;r.setTo(e,t);var s,a,n,o,h,l=0;h=i.length;for(var u=0;u<h;u+=2){if(s=i[u],a=i[u+1],n=i[(u+2)%h],a!=(o=i[(u+3)%h]))if(!(r.y<Math.min(a,o)))if(!(r.y>=Math.max(a,o)))(r.y-a)*(n-s)/(o-a)+s>r.x&&l++}return l%2==1}get hit(){return this._hit||(this._hit=new Es),this._hit}set hit(e){this._hit=e}get unHit(){return this._unHit||(this._unHit=new Es),this._unHit}set unHit(e){this._unHit=e}onAfterDeserialize(){p.isPlaying&&(this._hitCmds&&(this.hit.cmds=this._hitCmds,delete this._hitCmds),this._unHitCmds&&(this.unHit.cmds=this._unHitCmds,delete this._unHitCmds))}}Oe.regClass("HitArea",Ml);class bl{constructor(){this._show=!1}createUI(){let e=this._sp=new ua;e.scale(Math.max(In.stage.clientScaleX,1),Math.max(In.stage.clientScaleY,1)),In.stage.on(c.RESIZE,this,(()=>{this._sp.scale(Math.max(In.stage.clientScaleX,1),Math.max(In.stage.clientScaleY,1))}));let t=new Ca;t.singleCharRender=!0,t.pos(5,5),t.color="#ffffff",t.fontSize=Il,e.addChild(t),Bl.length=0;for(let e of this._view)Bl.push(e.title);t.text=Bl.join("\n"),this._txt=new Ca,this._txt.singleCharRender=!0,this._txt.pos(t.textWidth+10,5),this._txt.color="#ffffff",this._txt.fontSize=Il,e.addChild(this._txt),e.size(t.textWidth+100,t.textHeight+10),e.graphics.clear(),e.graphics.alpha(.5),e.graphics.drawRect(0,0,e.width,e.height,"#999999"),e.graphics.alpha(2)}show(e,t,i){e=e||0,t=t||0,i=i||dt.AllShow,this._view=i,this._show=!0,this._sp||this.createUI(),this._sp.pos(e,t)}hide(){this._show=!1}update(){if(this._show){Bl.length=0;for(let e=0;e<this._view.length;e++){let t=this._view[e],i="average"==t.mode,r=dt[t.value];"M"==t.units&&(r=Math.floor(r/1048576*100)/100),"K"==t.units&&(r=Math.floor(r/1024*100)/100),i&&(r/=dt._count,r=Math.floor(r)),"M"==t.units&&(r+="M"),"K"==t.units&&(r+="K"),Bl.push(r)}this._txt.text=Bl.join("\n")}}render(e,t,i){this._show&&this._sp&&this._sp.render(e,0,0)}}const Il=16,Bl=[];dt._statUIClass=bl;class Ll{static create(e,t){var i;let r;return"undefined"!=typeof document&&(r=null===(i=document.currentScript)||void 0===i?void 0:i.src,r&&(r=r.substring(0,r.replace(/[?#].*/,"").lastIndexOf("/")+1))),()=>{let i={};return null!=Ll.instantiateWasm&&(i.instantiateWasm=function(e,i){return Ll.instantiateWasm(t,e).then((e=>(i(e.instance),e)))}),i.locateFile=function(e,i){return t=null!=Ll.locateFile?Ll.locateFile(e,i,r):i+e},e(i)}}}Ll.Memory="undefined"!=typeof WebAssembly?WebAssembly.Memory:null;class Pl{constructor(e,t){this.submitStartPos=0,this.submitEndPos=0,this.touches=[],this.submits=[],this.sprite=null,this.meshlist=[],this.cachedClipInfo=new V,this.oldTx=0,this.oldTy=0,this.invMat=new V,this.context=e,this.sprite=t,e._globalClipMatrix.copyTo(this.cachedClipInfo)}startRec(){}endRec(){}isTextNeedRestore(){var e=!1,t=this.touches;if(t)for(var i=0;i<t.length;i++)if(t[i].deleted){e=!0;break}return e}flushsubmit(){Ki.RENDERBASE,this.submits.forEach((e=>{Ki.RENDERBASE}))}releaseMem(){}}Pl.matI=new V;const Nl=[[1569,65152,null,null,null],[1570,65153,null,null,65154],[1571,65155,null,null,65156],[1572,65157,null,null,65158],[1573,65159,null,null,65160],[1574,65161,65163,65164,65162],[1575,65165,null,null,65166],[1576,65167,65169,65170,65168],[1577,65171,null,null,65172],[1578,65173,65175,65176,65174],[1579,65177,65179,65180,65178],[1580,65181,65183,65184,65182],[1581,65185,65187,65188,65186],[1582,65189,65191,65192,65190],[1583,65193,null,null,65194],[1584,65195,null,null,65196],[1585,65197,null,null,65198],[1586,65199,null,null,65200],[1587,65201,65203,65204,65202],[1588,65205,65207,65208,65206],[1589,65209,65211,65212,65210],[1590,65213,65215,65216,65214],[1591,65217,65219,65220,65218],[1592,65221,65223,65224,65222],[1593,65225,65227,65228,65226],[1594,65229,65231,65232,65230],[1600,1600,1600,1600,1600],[1601,65233,65235,65236,65234],[1602,65237,65239,65240,65238],[1603,65241,65243,65244,65242],[1604,65245,65247,65248,65246],[1605,65249,65251,65252,65250],[1606,65253,65255,65256,65254],[1607,65257,65259,65260,65258],[1608,65261,null,null,65262],[1609,65263,null,null,65264],[1610,65265,65267,65268,65266],[1662,64342,64344,64345,64343],[1740,64508,64510,64511,64509],[1670,64378,64380,64381,64379],[1705,64398,64400,64401,64399],[1711,64402,64404,64405,64403],[1688,64394,null,null,64395]],Ol=[[[1604,1570],65269,null,null,65270],[[1604,1571],65271,null,null,65272],[[1604,1573],65273,null,null,65274],[[1604,1575],65275,null,null,65276]],Fl=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773];class Ul{constructor(){this._deviceBufferState=g.renderDeviceFactory.createBufferState()}applyState(e,t){this._vertexBuffers=e,this._bindedIndexBuffer=t,this._deviceBufferState&&(1==e.length?(Ul.vertexBufferArray.length=1,Ul.vertexBufferArray[0]=e[0]._deviceBuffer):(Ul.vertexBufferArray.length=0,e.forEach((e=>{Ul.vertexBufferArray.push(e._deviceBuffer)}))),this._deviceBufferState.applyState(Ul.vertexBufferArray,t?t._deviceBuffer:null))}destroy(){this._deviceBufferState&&(this._deviceBufferState.destroy(),this._deviceBufferState=null)}}Ul.vertexBufferArray=[];class kl{static ArrayMul(e,t,i){if(e)if(t)for(var r,s,a,n,o=0;o<4;o++)r=e[o],s=e[o+4],a=e[o+8],n=e[o+12],i[o]=r*t[0]+s*t[1]+a*t[2]+n*t[3],i[o+4]=r*t[4]+s*t[5]+a*t[6]+n*t[7],i[o+8]=r*t[8]+s*t[9]+a*t[10]+n*t[11],i[o+12]=r*t[12]+s*t[13]+a*t[14]+n*t[15];else kl.copyArray(e,i);else kl.copyArray(t,i)}static copyArray(e,t){if(e&&t)for(var i=0;i<e.length;i++)t[i]=e[i]}}return e.AlphaCmd=$r,e.Animation=zn,e.Animation2DCondition=yo,e.Animation2DEvent=co,e.Animation2DParm=fo,e.AnimationClip2D=go,e.AnimationClip2DParse01=_o,e.Animator2D=oo,e.AnimatorController2D=Ao,e.AnimatorControllerLayer2D=to,e.AnimatorControllerParse=no,e.AnimatorPlayState2D=eo,e.AnimatorState2D=ho,e.AnimatorState2DScript=class{setPlayScriptInfo(e,t,i){this.playStateInfo.animator=e,this.playStateInfo.layerindex=t,this.playStateInfo.playState=i}constructor(){this.playStateInfo={animator:null,layerindex:-1,playState:null}}onStateEnter(){}onStateUpdate(e){}onStateExit(){}onStateLoop(){}},e.AnimatorStateBoolCondition=wo,e.AnimatorStateCondition=Do,e.AnimatorStateNumberCondition=Eo,e.AnimatorStateTriggerCondition=Ro,e.AnimatorTransition2D=Co,e.ArabicReshaper=class{characterMapContains(e){for(var t=0;t<Nl.length;++t)if(Nl[t][0]===e)return!0;return!1}getCharRep(e){for(var t=0;t<Nl.length;++t)if(Nl[t][0]===e)return Nl[t];return!1}getCombCharRep(e,t){for(var i=0;i<Ol.length;++i)if(Ol[i][0][0]===e&&Ol[i][0][1]===t)return Ol[i];return!1}isTransparent(e){for(var t=0;t<Fl.length;++t)if(Fl[t]===e)return!0;return!1}getOriginalCharsFromCode(e){var t;for(t=0;t<Nl.length;++t)if(Nl[t].indexOf(e)>-1)return String.fromCharCode(Nl[t][0]);for(t=0;t<Ol.length;++t)if(Ol[t].indexOf(e)>-1)return String.fromCharCode(Ol[t][0][0])+String.fromCharCode(Ol[t][0][1]);return String.fromCharCode(e)}convertArabic(e){for(var t,i,r="",s=0;s<e.length;++s){var a=e.charCodeAt(s);if(this.characterMapContains(a)){for(var n=null,o=null,h=s-1,l=s+1;h>=0&&this.isTransparent(e.charCodeAt(h));--h);for((!(t=!!(n=h>=0?e.charCodeAt(h):null)&&this.getCharRep(n))||null==t[2]&&null==t[3])&&(n=null);l<e.length&&this.isTransparent(e.charCodeAt(l));++l);if((!(t=!!(o=l<e.length?e.charCodeAt(l):null)&&this.getCharRep(o))||null==t[3]&&null==t[4])&&(o=null),1604===a&&null!=o&&(1570===o||1571===o||1573===o||1575===o)){i=this.getCombCharRep(a,o),r+=null!=n?String.fromCharCode(i[4]):String.fromCharCode(i[1]),++s;continue}if(t=this.getCharRep(a),null!=n&&null!=o&&null!=t[3]){r+=String.fromCharCode(t[3]);continue}if(null!=n&&null!=t[4]){r+=String.fromCharCode(t[4]);continue}if(null!=o&&null!=t[2]){r+=String.fromCharCode(t[2]);continue}r+=String.fromCharCode(t[1])}else r+=String.fromCharCode(a)}return r}convertArabicBack(e){var t,i,r="";for(i=0;i<e.length;++i)t=e.charCodeAt(i),r+=this.getOriginalCharsFromCode(t);return r}},e.Area2D=Ja,e.AssetDb=U,e.AtlasGrid=ir,e.AtlasInfoManager=Te,e.AtlasResource=xe,e.AudioSound=yn,e.AudioSoundChannel=Tn,e.Base64Tool=Rl,e.BasePoly=Yi,e.BaseRenderNode2D=aa,e.BaseTexture=M,e.Batch2DInfo=yt,e.BatchProgress=ve,e.Bezier=mi,e.BinHashUtils=al,e.BitmapFont=ma,e.BlendComponent=Fh,e.BlendMode=Ri,e.BlendState=Oh,e.Blit2DCMD=Wh,e.Blit2DQuadCMD=class{get element(){return this._element}set element(e){this._element=e}get dest(){return this._dest}set dest(e){this._dest=e}get source(){return this._source}set source(e){this._source=e}get offsetScale(){return this._offsetScale}set offsetScale(e){this._offsetScale=e}apply(e){throw new z}},e.BlurFilter=Wn,e.BooleanKeyframe=el,e.Browser=I,e.Buffer=Uh,e.BufferState=Ul,e.ButtonEffect=class{constructor(){this._curState=0,this.effectScale=1.5,this.tweenTime=300}set target(e){this._tar=e,e.on(c.MOUSE_DOWN,this,this.toChangedState),e.on(c.MOUSE_UP,this,this.toInitState),e.on(c.MOUSE_OUT,this,this.toInitState)}toChangedState(){this._curState=1,this._curTween&&js.clear(this._curTween),this._curTween=js.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,Ms[this.effectEase],Se.create(this,this.tweenComplete))}toInitState(){2!=this._curState&&(this._curTween&&js.clear(this._curTween),this._curState=2,this._curTween=js.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,Ms[this.backEase],Se.create(this,this.tweenComplete)))}tweenComplete(){this._curState=0,this._curTween=null}},e.Byte=Y,e.CachePage=br,e.CacheStyle=zr,e.Cache_Info=Cr,e.Camera2D=sn,e.CharRenderInfo=Zi,e.CharRender_Canvas=dr,e.CharSubmitCache=Qi,e.ClassUtils=Oe,e.ClipRectCmd=Qr,e.Color=m,e.ColorFilter=jn,e.ColorUtils=Ai,e.Command2D=Hh,e.CommandBuffer2D=class{constructor(e){this._scene=null,this._renderCMDs=[],this._renderSize=new Gt,this.cacheData={},this._name=e,this._context=mt.rendercontext2D,this._commands=[]}getName(){return this._name}_cacheContextState(){this.cacheData.rt=this._context.getRenderTarget(),this.cacheData.pipeline=this._context.pipelineMode,this.cacheData.invertY=this._context.invertY}_recoverContextState(){this._context.setRenderTarget(this.cacheData.rt,!1,m.BLACK),this._context.pipelineMode=this.cacheData.pipeline,this._context.invertY=this.cacheData.invertY}apply(e=!0,t=!0){t&&this._cacheContextState();for(var i=0,r=this._commands.length;i<r;i++){let e=this._commands[i];e.run&&e.run()}e&&this._context.runCMDList(this._renderCMDs),dt.cmdDrawCall+=this._renderCMDs.length,t&&this._recoverContextState()}applyOne(e=!0){if(e&&this._cacheContextState(),this._commands.length){var t=this._commands.shift();t.run&&t.run(),t.getRenderCMD&&this._context.runOneCMD(this._renderCMDs.shift()),t.recover()}return e&&this._recoverContextState(),this._commands.length>0}clear(e=!0){if(e)for(var t=0,i=this._commands.length;t<i;t++)this._commands[t].recover();this._commands.length=0,this._renderCMDs.length=0}getCommandsSize(){return this._commands.length}setShaderDataValue(e,t,i,r){if(!ai(r,i))return;let s=jh.create(e,t,r,i);s._globalMode=!1,this._commands.push(s),s._commandBuffer=this,s.getRenderCMD&&this._renderCMDs.push(s.getRenderCMD())}setGlobalShaderDataValue(e,t,i){if(!ai(i,t))return;if(!this._scene||!this._scene._specialManager)return;let r=jh.create(this._scene._specialManager._shaderData,e,i,t);r._globalMode=!0,this._commands.push(r),r._commandBuffer=this,r.getRenderCMD&&this._renderCMDs.push(r.getRenderCMD())}setShaderDefine(e,t,i){let r=Kh.create(e,t,i);r._globalMode=!1,this._commands.push(r),r._commandBuffer=this,r.getRenderCMD&&this._renderCMDs.push(r.getRenderCMD())}blitTextureQuad(e,t,i,r,s){let a=Wh.create(e,t,i,r,s);this._commands.push(a),a._commandBuffer=this,a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}blitTextureBlur(e,t,i){}setRenderTarget(e,t,i=m.BLACK,r=!0){let s=qh.create(e,t,i,r);this._commands.push(s),s._commandBuffer=this,s.getRenderCMD&&this._renderCMDs.push(s.getRenderCMD())}drawRenderElement(e,t){let i=Xh.create(e,t);this._commands.push(i),i._commandBuffer=this,i.getRenderCMD&&this._renderCMDs.push(i.getRenderCMD())}drawMesh(e,t,i,r,s){let a=Yh.create(e,t,i||_e.whiteTexture,r||m.WHITE,s||gh.mesh2DDefaultMaterial);this._commands.push(a),a._commandBuffer=this,a.getRenderCMD&&this._renderCMDs.push(a.getRenderCMD())}drawQuad(){}drawLine(){}addCacheCommand(e){e instanceof jh&&e._commandBuffer&&e.setDest(this._scene._specialManager._shaderData),e instanceof Kh&&e._commandBuffer&&e.setDest(this._scene._specialManager._shaderData),this._commands.push(e),e._commandBuffer=this,e.getRenderCMD&&this._renderCMDs.push(e.getRenderCMD())}},e.CommandEncoder=class{constructor(){this._idata=[]}getArrayData(){return this._idata}getCount(){return this._idata.length}addShaderUniform(e){this._idata.push(e)}},e.CommandUniformMap=class{constructor(e){}addShaderUniform(e,t,i){throw"need override it"}addShaderUniformArray(e,t,i,r){throw"need override it"}},e.Component=ta,e.ComponentDriver=dn,e.Config=t,e.Config3D=o,e.Const=Ue,e.Context=xr,e.CurvePath=class{constructor(){this._segments=[],this._points=[],this._curPt=new a}get length(){return this._fullLength}create(...t){this._segments.length=0;let i=this._points;Dl.recover(this._points),this._fullLength=0,this._cacheT=null;let r=t.length;if(0==r)return;let s=[],n=t[0];n.curve==e.CurveType.CRSpline&&s.push(n.pos.cloneTo(Dl.take()));for(let o=1;o<r;o++){let r=t[o];if(n.curve!=e.CurveType.CRSpline){let t={};t.type=n.curve,t.ptStart=i.length,n.curve==e.CurveType.Straight?(t.ptCount=2,i.push(n.pos.cloneTo(Dl.take())),i.push(r.pos.cloneTo(Dl.take()))):n.curve==e.CurveType.Bezier?(t.ptCount=3,i.push(n.pos.cloneTo(Dl.take())),i.push(r.pos.cloneTo(Dl.take())),i.push(n.c1.cloneTo(Dl.take()))):n.curve==e.CurveType.CubicBezier&&(t.ptCount=4,i.push(n.pos.cloneTo(Dl.take())),i.push(r.pos.cloneTo(Dl.take())),i.push(n.c1.cloneTo(Dl.take())),i.push(n.c2.cloneTo(Dl.take()))),t.length=a.distance(n.pos,r.pos),this._fullLength+=t.length,this._segments.push(t)}r.curve!=e.CurveType.CRSpline?s.length>0&&(s.push(r.pos.cloneTo(Dl.take())),this.createSplineSegment(s)):s.push(r.pos.cloneTo(Dl.take())),n=r}s.length>1&&this.createSplineSegment(s)}createSplineSegment(t){let i=t.length;t.splice(0,0,t[0]),t.push(t[i]),t.push(t[i]),i+=3;let r={};r.type=e.CurveType.CRSpline,r.ptStart=this._points.length,r.ptCount=i,this._points=this._points.concat(t),r.length=0;for(let e=1;e<i;e++)r.length+=a.distance(t[e-1],t[e]);this._fullLength+=r.length,this._segments.push(r),t.length=0}clear(){this._segments.length=0,this._points.length=0}getPointAt(t){let i=this._curPt;if((t=tl.clamp01(t))===this._cacheT)return i;i.set(0,0,0),this._cacheT=t;let r=this._segments.length;if(0==r)return i;let s=this._points;if(1==t){let n=this._segments[r-1];return n.type==e.CurveType.Straight?a.lerp(s[n.ptStart],s[n.ptStart+1],t,i):n.type==e.CurveType.Bezier||n.type==e.CurveType.CubicBezier?this.onBezierCurve(n.ptStart,n.ptCount,t,i):this.onCRSplineCurve(n.ptStart,n.ptCount,t,i),i}for(let n=0,o=t*this._fullLength;n<r;n++){let r=this._segments[n];if(o-=r.length,o<0){t=1+o/r.length,r.type==e.CurveType.Straight?a.lerp(s[r.ptStart],s[r.ptStart+1],t,i):r.type==e.CurveType.Bezier||r.type==e.CurveType.CubicBezier?this.onBezierCurve(r.ptStart,r.ptCount,t,i):this.onCRSplineCurve(r.ptStart,r.ptCount,t,i);break}}return i}get segmentCount(){return this._segments.length}getAnchorsInSegment(e,t){null==t&&(t=[]);let i=this._points,r=this._segments[e];for(let e=0;e<r.ptCount;e++)t.push(i[r.ptStart+e]);return t}getPointsInSegment(t,i,r,s,n,o){null==s&&(s=[]),o&&!isNaN(o)||(o=.1);let h=this._points;n&&n.push(i);let l=this._segments[t];if(l.type==e.CurveType.Straight){let e=new a;a.lerp(h[l.ptStart],h[l.ptStart+1],i,e),s.push(e),e=new a,a.lerp(h[l.ptStart],h[l.ptStart+1],r,e),s.push(e)}else{let t;t=l.type==e.CurveType.Bezier||l.type==e.CurveType.CubicBezier?this.onBezierCurve:this.onCRSplineCurve,s.push(t.call(this,l.ptStart,l.ptCount,i,new a));let h=Math.min(l.length*o,50);for(let e=0;e<=h;e++){let o=e/h;o>i&&o<r&&(s.push(t.call(this,l.ptStart,l.ptCount,o,new a)),n&&n.push(o))}s.push(t.call(this,l.ptStart,l.ptCount,r,new a))}return n&&n.push(r),s}getAllPoints(e,t,i){null==e&&(e=[]),i&&!isNaN(i)||(i=.1);for(let r=0,s=this._segments.length;r<s;r++)this.getPointsInSegment(r,0,1,e,t,i);return e}onCRSplineCurve(e,t,i,r){let s=Math.floor(i*(t-4))+e,a=this._points,n=a[s],o=a[s+1],h=a[s+2],l=a[s+3],u=1==i?1:tl.repeat(i*(t-4),1),d=((2-u)*u-1)*u*.5,c=.5*((3*u-5)*u*u+2),_=((-3*u+4)*u+1)*u*.5,p=(u-1)*u*u*.5;return r.x=n.x*d+o.x*c+h.x*_+l.x*p,r.y=n.y*d+o.y*c+h.y*_+l.y*p,r.z=n.z*d+o.z*c+h.z*_+l.z*p,r}onBezierCurve(e,t,i,r){let s=1-i,n=this._points,o=n[e],h=n[e+1],l=n[e+2];if(4==t){let t=n[e+3];a.add(o.scale(s*s*s,vl),l.scale(3*s*s*i,Sl),vl),a.add(t.scale(3*s*i*i,vl),h.scale(i*i*i,Sl),Sl),a.add(vl,Sl,r)}else a.add(o.scale(s*s,vl),l.scale(2*s*i,Sl),vl),a.add(vl,h.scale(i*i,Sl),r);return r}},e.DDSTextureInfo=he,e.DefferTouchResContext=Er,e.Delegate=v,e.DepthState=class{},e.Downloader=Me,e.DragSupport=Zs,e.Draw2DElementCMD=class{setRenderelements(e){throw new z}apply(e){throw new z}},e.Draw9GridTextureCmd=Zr,e.DrawCircleCmd=es,e.DrawCurvesCmd=ts,e.DrawEllipseCmd=Ss,e.DrawImageCmd=is,e.DrawLineCmd=rs,e.DrawLinesCmd=ss,e.DrawMesh2DCMD=Yh,e.DrawPathCmd=as,e.DrawPieCmd=ns,e.DrawPolyCmd=os,e.DrawRectCmd=hs,e.DrawRenderElement2DCMD=Xh,e.DrawRoundRectCmd=Ds,e.DrawStyle=Mi,e.DrawTextureCmd=ls,e.DrawTexturesCmd=us,e.DrawTrianglesCmd=ds,e.Earcut=qi,e.EarcutNode=Xi,e.Ease=Ms,e.EffectBase=$h,e.Event=c,e.EventDispatcher=D,e.FadeIn=class extends $h{_doTween(){return this.target.alpha=0,js.to(this.target,{alpha:1},this.duration,Ms[this.ease],this._comlete,this.delay)}},e.FadeOut=class extends $h{_doTween(){return this.target.alpha=1,js.to(this.target,{alpha:0},this.duration,Ms[this.ease],this._comlete,this.delay)}},e.FastSinglelist=Tt,e.FillTextCmd=cs,e.FillTextureCmd=_s,e.Filter=ut,e.FixtureBox2DDef=class{},e.FloatKeyframe=xh,e.FontInfo=nr,e.FrameAnimation=Vn,e.GLSLCodeGenerator=kh,e.GlowFilter=Kn,e.Gradient=fh,e.GradientMode=mh,e.GrahamScan=Ve,e.Graphics=Es,e.GraphicsBounds=Yr,e.HDRTextureInfo=jo,e.HTMLCanvas=Vr,e.HalfFloatUtils=X,e.Handler=Se,e.HideFlags=Ge,e.HierarchyLoader=qo,e.HierarchyParser=Yo,e.HierarchyResource=So,e.HitArea=Ml,e.HtmlElement=ya,e.HtmlImage=xa,e.HtmlLink=va,e.HtmlParseOptions=Sa,e.HtmlParser=wa,e.HttpRequest=Ae,e.ICharRender=ur,e.ILaya=h,e.ImgUtils=De,e.IncludeFile=Mt,e.IndexBuffer=class extends Uh{constructor(t,i){super(t,i),this._indexType=e.IndexFormat.UInt16}},e.Input=Ha,e.InputManager=$a,e.JsonBinRead=nl,e.JsonBinWrite=hl,e.KTXTextureInfo=ce,e.KeyLocation=Qh,e.Keyboard=Zh,e.Keyframe=yh,e.Keyframe2D=uo,e.KeyframeNode2D=lo,e.KeyframeNodeList2D=po,e.Laya=In,e.LayaEnv=p,e.LayaGL=g,e.LayaGLQuickRunner=Sr,e.LoadModel2DV01=Bo,e.Loader=Be,e.LocalStorage=Dn,e.Material=bn,e.MaterialLoader=hh,e.MaterialParser=oh,e.MathUtil=tl,e.MathUtils3D=r,e.MatirxArray=kl,e.Matrix=V,e.Matrix3x3=zt,e.Matrix4x4=Zt,e.MeasureFont=tr,e.Mesh2D=Io,e.Mesh2DReader=Po,e.Mesh2DRender=gh,e.MeshLoader=Lo,e.MeshQuadTexture=lt,e.MeshTexture=pr,e.MeshVG=gr,e.Mouse=Cn,e.Node=As,e.NodeFlags=ke,e.NotImplementedError=z,e.NotReadableError=W,e.NullLoader=ah,e.ObjDecoder=Go,e.OpenDataContextView=vh,e.OutOfRangeError=H,e.PERF_BEGIN=ml,e.PERF_END=fl,e.PERF_FRAMECLEAR=Tl,e.ParseJSON=lh,e.Path=bi,e.PathPoint=yl,e.PerfTools=pl,e.PerformanceDefine=gl,e.PlayerConfig=i,e.Point=d,e.Pool=l,e.Prefab=xo,e.PrefabImpl=Xo,e.PrimitiveSV=wn,e.Quaternion=Xt,e.QuaternionKeyframe=class extends yh{constructor(e=!1){super(),this.inTangent=new s,this.outTangent=new s,this.value=new Xt,e&&(this.inWeight=new s,this.outWeight=new s,this.weightedMode=new s)}cloneTo(e){super.cloneTo(e);var t=e;this.inTangent.cloneTo(t.inTangent),this.outTangent.cloneTo(t.outTangent),this.value.cloneTo(t.value),this.weightedMode&&(this.inWeight.cloneTo(t.inWeight),this.outWeight.cloneTo(t.outWeight),this.weightedMode.cloneTo(t.weightedMode))}},e.QuickTestTool=Jh,e.Rectangle=G,e.Render=ln,e.Render2D=gt,e.Render2DSimple=mt,e.RenderInfo=$i,e.RenderManager2D=xt,e.RenderObject2D=Rr,e.RenderSprite=Ur,e.RenderState=At,e.RenderState2D=_t,e.RenderStateContext=wi,e.RenderTexture=b,e.RenderTexture2D=pe,e.RenderTextureCube=class extends b{constructor(e,t,i,r,s){super(e,e,t,i,r,s),this.faceIndex=0}_createRenderTarget(){this._dimension=e.TextureDimension.Cube,this._renderTarget=g.textureContext.createRenderTargetCubeInternal(this.width,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._texture=this._renderTarget._textures[0]}},e.RenderTextureLoader=Zo,e.RenderToCache=wr,e.Resource=A,e.RestoreCmd=Hr,e.RigidBody2DInfo=class{constructor(){this.position=new Gt,this.linearVelocity=new Gt}},e.RotateCmd=ps,e.SaveBase=Bi,e.SaveClipRect=Li,e.SaveCmd=Wr,e.SaveMark=Pi,e.SaveTransform=Ni,e.SaveTranslate=Oi,e.ScaleCmd=ms,e.Scene=rn,e.Scene2DSpecialManager=tn,e.Script=Mo,e.SerializeUtil=Fo,e.Set2DDefineCMD=Kh,e.Set2DRTCMD=qh,e.Set2DShaderDataCMD=jh,e.SetRenderDataCMD=class{get value(){return this._value}set value(e){this._value=e}get dataType(){return this._dataType}set dataType(e){this._dataType=e}get propertyID(){return this._propertyID}set propertyID(e){this._propertyID=e}get dest(){return this._dest}set dest(e){this._dest=e}apply(e){throw new z}},e.SetRendertarget2DCMD=class{get invertY(){return this._invertY}set invertY(e){this._invertY=e}get clearColorValue(){return this._clearColorValue}set clearColorValue(e){this._clearColorValue=e}get rt(){return this._rt}set rt(e){this._rt=e}get clearColor(){return this._clearColor}set clearColor(e){this._clearColor=e}apply(e){throw new z}},e.SetShaderDefineCMD=class{get define(){return this._define}set define(e){this._define=e}get dest(){return this._dest}set dest(e){this._dest=e}get add(){return this._add}set add(e){this._add=e}apply(e){throw new z}},e.Shader2D=Ui,e.Shader3D=gi,e.ShaderCompile=kt,e.ShaderCompileDefineBase=oi,e.ShaderData=class{constructor(e=null){this._ownerResource=e}createUniformBuffer(e,t){}updateUBOBuffer(e){}getDefineData(){throw new z}getData(){throw new z}addDefine(e){throw new z}addDefines(e){throw new z}removeDefine(e){throw new z}hasDefine(e){throw new z}clearDefine(){throw new z}clearData(){throw new z}getBool(e){throw new z}setBool(e,t){throw new z}getInt(e){throw new z}setInt(e,t){throw new z}getNumber(e){throw new z}setNumber(e,t){throw new z}getVector2(e){throw new z}setVector2(e,t){throw new z}getVector3(e){throw new z}setVector3(e,t){throw new z}getVector(e){throw new z}setVector(e,t){throw new z}getColor(e){throw new z}setColor(e,t){throw new z}getMatrix4x4(e){throw new z}setMatrix4x4(e,t){throw new z}getMatrix3x3(e){throw new z}setMatrix3x3(e,t){throw new z}getBuffer(e){throw new z}setBuffer(e,t){throw new z}setTexture(e,t){throw new z}getTexture(e){throw new z}setShaderData(t,i,r){switch(i){case e.ShaderDataType.Int:this.setInt(t,r);break;case e.ShaderDataType.Bool:this.setBool(t,r);break;case e.ShaderDataType.Float:this.setNumber(t,r);break;case e.ShaderDataType.Vector2:this.setVector2(t,r);break;case e.ShaderDataType.Vector3:this.setVector3(t,r);break;case e.ShaderDataType.Vector4:this.setVector(t,r);break;case e.ShaderDataType.Color:this.setColor(t,r);break;case e.ShaderDataType.Matrix4x4:this.setMatrix4x4(t,r);break;case e.ShaderDataType.Matrix3x3:this.setMatrix3x3(t,r);break;case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:this.setTexture(t,r);break;case e.ShaderDataType.Buffer:this.setBuffer(t,r);break;default:throw new Error(`unknown shader data type: ${i}`)}}getShaderData(t,i){switch(i){case e.ShaderDataType.Int:return this.getInt(t);case e.ShaderDataType.Bool:return this.getBool(t);case e.ShaderDataType.Float:return this.getNumber(t);case e.ShaderDataType.Vector2:return this.getVector2(t);case e.ShaderDataType.Vector3:return this.getVector3(t);case e.ShaderDataType.Vector4:return this.getVector(t);case e.ShaderDataType.Color:return this.getColor(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:return this.getTexture(t);case e.ShaderDataType.Buffer:return this.getBuffer(t);case e.ShaderDataType.Matrix3x3:return this.getMatrix3x3(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);default:throw"unknown shader data type."}}_setInternalTexture(e,t){throw new z}cloneTo(e){throw new z}clone(){throw new z}destroy(){throw new z}},e.ShaderDataDefaultValue=ni,e.ShaderDefine=class{constructor(e,t){this._index=e,this._value=t}},e.ShaderDefines2D=ki,e.ShaderNode=bt,e.ShaderParser=ph,e.ShaderPass=ui,e.ShaderVariable=Vh,e.ShaderVariant=hi,e.ShaderVariantCollection=li,e.SingletonList=ft,e.Socket=sl,e.Sound=class extends D{load(e){}play(e=0,t=0){return null}get duration(){return 0}dispose(){}},e.SoundChannel=fn,e.SoundManager=Sn,e.SoundNode=$n,e.Sprite=ua,e.Sprite2DGeometry=ht,e.SpriteCache=Br,e.SpriteConst=je,e.SpriteGlobalTransform=na,e.SpriteUtils=ea,e.Stage=pn,e.Stat=dt,e.StatUI=bl,e.StencilState=class{},e.SubShader=_i,e.SubmitBase=Ki,e.SubmitKey=ji,e.Text=Ca,e.TextAtlas=ar,e.TextDebug=class{static showTextAtlas(e,t,i,r,s,a,n){var o=new ua,l={width:cr.atlasWidth,height:cr.atlasWidth,sourceWidth:cr.atlasWidth,sourceHeight:cr.atlasWidth,offsetX:0,offsetY:0,getIsReady:function(){return!0},_addReference:function(){},_removeReference:function(){},_getSource:function(){return e._getSource()},bitmap:{id:e.id},_uv:fe.DEF_UV};return o.graphics.drawRect(0,0,1,1,i,null,null,!0),o.graphics.fillTexture(l,0,0,1,1,"no-repeat",null,null,!0),o.pos(r,s),h.stage.addChild(o),o}static printRenderInfo(e){for(var t in console.log("图集个数:"+e.textAtlases.length+",每个图集大小:"+cr.atlasWidth+"x"+cr.atlasWidth," 用canvas:",cr.isWan1Wan),console.log("图集占用空间:"+cr.atlasWidth*cr.atlasWidth*4/1024/1024*e.textAtlases.length+"M"),console.log("缓存用到的字体:"),e.mapFont){var i=e.getFontSizeInfo(t),r=i>>24,s=i>>16&255,a=i>>8&255,n=255&i;console.log("    "+t," off:",r,s," size:",a,n)}var o=0;console.log("缓存数据:");var h=0,l=0;e.textAtlases.forEach((function(e){var t=e.texture.id,i=$i.loopCount-e.texture.lastTouchTm,r=i>0?i+"帧以前":"当前帧";for(var s in h+=e.texture.curUsedCovRate,l+=e.texture.curUsedCovRateAtlas,console.log("--图集(id:"+t+",当前使用率:"+(1e3*e.texture.curUsedCovRate|0)+"‰","当前图集使用率:",(100*e.texture.curUsedCovRateAtlas|0)+"%","图集使用率:",100*e.usedRate|0,"%, 使用于:"+r+")--:"),e.charMaps){var a=e.charMaps[s];console.log("     off:",a.orix,a.oriy," bmp宽高:",a.bmpWidth,a.bmpHeight,"无效:",a.deleted,"touchdt:",$i.loopCount-a.touchTick,"位置:",a.uv[0]*cr.atlasWidth|0,a.uv[1]*cr.atlasWidth|0,"字符:",a.char,"key:",s),o++}})),console.log("独立贴图文字("+e.isoTextures.length+"个):"),e.isoTextures.forEach((function(e){console.log("    size:",e.width,e.height,"touch间隔:",$i.loopCount-e.lastTouchTm,"char:",e.ri.char)})),console.log("总缓存:",o,"总使用率:",h,"总当前图集使用率:",l)}},e.TextRender=cr,e.TextResource=No,e.TextStyle=fa,e.TextTexture=sr,e.Texture=fe,e.Texture2D=_e,e.Texture2DArray=an,e.Texture2DLoader=Qo,e.Texture3D=cl,e.TextureCube=hn,e.TextureLoader=ih,e.TextureSV=Rn,e.TimeLine=El,e.Timer=cn,e.TransformCmd=Ts,e.TranslateCmd=xs,e.Tween=js,e.TweenValue=Ls,e.TweenValueAdapterKey=Os,e.Tweener=zs,e.TypedArrayClasses=Oo,e.UBBParser=Ra,e.UBOStat=Lh,e.URL=k,e.UniformBufferAlone=Ph,e.UniformBufferBlock=bh,e.UniformBufferCluster=Ih,e.UniformBufferManager=class{constructor(e){this._destroyed=!1,this._needUpdateClusters=[],this._removeHoleArray=[],this._optimizeBufferPosArray=[],this._useBigBuffer=!0,this.byteAlign=256,this.clusterMaxBlock=256,this.uploadThreshold=200,this.removeHoleThreshold=10,this._enableStat=!0,this.aloneBuffers=[],this._useBigBuffer=e,this._clustersAll=new Map,this._clustersCur=new Map,this._stat=new Lh}_createBufferCluster(e,t){return new Ih(e,t,this)}_addCluster(e,t=16){const i=Bh(e,this.byteAlign),r=this._createBufferCluster(i,t),s=this._clustersAll.get(i);return s?(s.push(r),r._sn=s.length-1):this._clustersAll.set(i,[r]),this._clustersCur.set(i,r),r}startFrame(){}endFrame(){if(this._enableStat&&(this._stat.moveNum=0,this._stat.uploadNum=0,this._stat.uploadByte=0,this._stat.timeCostCount++),this._useBigBuffer){if(this._removeHoleArray.length>0){for(let e=this._removeHoleArray.length-1;e>-1;e--)this._removeHoleArray[e].removeHole();this._removeHoleArray.length=0}if(this._optimizeBufferPosArray.length>0){for(let e=this._optimizeBufferPosArray.length-1;e>-1;e--)this._optimizeBufferPosArray[e].optimize();this._optimizeBufferPosArray.length=0}}}getBufferAlone(e,t){const i=Bh(e,this.byteAlign);return this.statisGPUMemory(i),this.createGPUBuffer(i,t)}removeCluster(e,t){var i;const r=Bh(e,this.byteAlign);if(t<0)return this._clustersAll.delete(r),void this._clustersCur.delete(r);const s=null===(i=this._clustersCur.get(r))||void 0===i?void 0:i._sn,a=this._clustersAll.get(r);if(a.length>t){if(a.splice(t,1),0===a.length)return this._clustersAll.delete(r),void this._clustersCur.delete(r);for(let e=t;e<a.length;e++)a[e]._sn--;if(void 0!==s&&s===t){let e=-1,t=-1,i=-1;for(let r=a.length-1;r>-1;r--)t=a[r].usedNum,t>e&&t<this.clusterMaxBlock&&(i=r,e=t);i>=0?this._clustersCur.set(r,a[i]):this._clustersCur.delete(r)}}}getBlock(e,t){const i=Bh(e,this.byteAlign);let r=this._clustersCur.get(i);if(!r)return this._addCluster(i).getBlock(e,t);if(r.usedNum<this.clusterMaxBlock)return r.getBlock(e,t);r=null;const s=this._clustersAll.get(i);let a=-1,n=-1,o=-1;for(let e=s.length-1;e>0;e--)n=s[e].usedNum,n>a&&n<this.clusterMaxBlock&&(o=e,a=n);return o>=0?(r=s[o],this._clustersCur.set(i,r)):this._clustersCur.delete(i),r?r.getBlock(e,t):this._addCluster(i).getBlock(e,t)}freeBlock(e){const t=e.cluster;return!!t&&(!!t.freeBlock(e)&&(0===t.usedNum&&this.removeCluster(t._blockSize,t._sn),!0))}upload(){if(this._useBigBuffer){let e,t;this._enableStat&&(e=performance.now());for(let e=this._needUpdateClusters.length-1;e>-1;e--)t=this._needUpdateClusters[e],t.upload(),t._inManagerUpdateArray=!1;this._needUpdateClusters.length=0,this._enableStat&&this.statisTimeCostAvg(performance.now()-e)}}_addUpdateArray(e){e._inManagerUpdateArray||(this._needUpdateClusters.push(e),e._inManagerUpdateArray=!0)}_addRemoveHoleCluster(e){-1===this._removeHoleArray.indexOf(e)&&this._removeHoleArray.push(e)}_addOptimizeBufferPos(e){-1===this._optimizeBufferPosArray.indexOf(e)&&this._optimizeBufferPosArray.push(e)}clear(){this._clustersAll.forEach((e=>{for(let t=e.length-1;t>-1;t--)e[t].clear()}))}destroy(){return this._destroyed?(console.warn("UniformBufferManager: object alreay destroyed!"),!1):(this.clear(),this._clustersAll.clear(),this._clustersCur.clear(),this._destroyed=!0,!0)}createGPUBuffer(e,t){}writeBuffer(e,t,i,r){}statisGPUMemory(e){}statisTimeCostAvg(e){this._stat.timeCostSum+=e,this._stat.timeCostCount>100&&(this._stat.timeCostAvg=(this._stat.timeCostSum/this._stat.timeCostCount*1e4|0)/10,this._stat.timeCostSum=0,this._stat.timeCostCount=0)}statisUpload(e,t){this._stat.uploadNum+=e,this._stat.uploadByte+=t}},e.UniformBufferUser=Nh,e.Utils=O,e.Value2D=Gi,e.Value2DManager=class{},e.Vector2=Gt,e.Vector2Keyframe=class extends yh{constructor(t=!1){super(),this.inTangent=new Gt,this.outTangent=new Gt,this.value=new Gt,t&&(this.inWeight=new Gt(yh.defaultWeight,yh.defaultWeight),this.outWeight=new Gt(yh.defaultWeight,yh.defaultWeight),this.weightedMode=new Gt(e.WeightedMode.None,e.WeightedMode.None))}cloneTo(e){super.cloneTo(e),this.inTangent.cloneTo(e.inTangent),this.outTangent.cloneTo(e.outTangent),this.value.cloneTo(e.value),this.weightedMode&&(this.inWeight.cloneTo(e.inWeight),this.outWeight.cloneTo(e.outWeight),this.weightedMode.cloneTo(e.weightedMode))}},e.Vector3=a,e.Vector3Keyframe=class extends yh{constructor(t=!1){super(),this.inTangent=new a,this.outTangent=new a,this.value=new a,t&&(this.inWeight=new a(yh.defaultWeight,yh.defaultWeight,yh.defaultWeight),this.outWeight=new a(yh.defaultWeight,yh.defaultWeight,yh.defaultWeight),this.weightedMode=new a(e.WeightedMode.None,e.WeightedMode.None,e.WeightedMode.None))}cloneTo(e){super.cloneTo(e),this.inTangent.cloneTo(e.inTangent),this.outTangent.cloneTo(e.outTangent),this.value.cloneTo(e.value),this.weightedMode&&(this.inWeight.cloneTo(e.inWeight),this.outWeight.cloneTo(e.outWeight),this.weightedMode.cloneTo(e.weightedMode))}},e.Vector4=s,e.Vector4Keyframe=class extends yh{constructor(t=!1){super(),this.inTangent=new s,this.outTangent=new s,this.value=new s,t&&(this.inWeight=new s(yh.defaultWeight,yh.defaultWeight,yh.defaultWeight,yh.defaultWeight),this.outWeight=new s(yh.defaultWeight,yh.defaultWeight,yh.defaultWeight,yh.defaultWeight),this.weightedMode=new s(e.WeightedMode.None,e.WeightedMode.None,e.WeightedMode.None,e.WeightedMode.None))}cloneTo(e){super.cloneTo(e),this.inTangent.cloneTo(e.inTangent),this.outTangent.cloneTo(e.outTangent),this.value.cloneTo(e.value),this.weightedMode&&(this.inWeight.cloneTo(e.inWeight),this.outWeight.cloneTo(e.outWeight),this.weightedMode.cloneTo(e.weightedMode))}},e.VertexAttributeLayout=zh,e.VertexBuffer=class extends Uh{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e}get instanceBuffer(){return this._instanceBuffer}set instanceBuffer(e){this._instanceBuffer=e}constructor(e,t){super(e,t),this._instanceBuffer=!1,this._vertexDeclaration=null}},e.VertexDeclaration=nt,e.VertexElement=ot,e.VertexElementFormat=st,e.VertexMesh=ci,e.VertexMesh2D=bo,e.VertexStateContext=at,e.VideoNode=Jn,e.VideoTexture=Qn,e.VideoTextureLoader=Jo,e.Viewport=il,e.WasmAdapter=Ll,e.WeakObject=An,e.WebAudioSound=vn,e.WebAudioSoundChannel=xn,e.WebGLCacheAsNormalCanvas=Pl,e.WebGLRTMgr=_l,e.Widget=en,e.WordText=lr,e.WorkerLoader=ye,e.XML=Ce,e.XMLIterator=Re,e.XMLUtils=Ee,e.addAfterInitCallback=Un,e.addBeforeInitCallback=Fn,e.addInitCallback=On,e.addReadyCallback=kn,e.alertGlobalError=Nn,e.allowMultiple=function(e){e.prototype._$singleton=!1},e.checkShaderDataValueLegal=ai,e.classInfo=function(e){return Fe},e.importNative=Gn,e.init=Bn,e.physics2D_DistancJointDef=class{constructor(){this.localAnchorA=new Gt,this.localAnchorB=new Gt}},e.physics2D_GearJointDef=class{},e.physics2D_MotorJointDef=class{constructor(){this.linearOffset=new Gt}},e.physics2D_MouseJointJointDef=class{constructor(){this.target=new Gt}},e.physics2D_PrismaticJointDef=class{constructor(){this.anchor=new Gt,this.axis=new Gt}},e.physics2D_PulleyJointDef=class{constructor(){this.groundAnchorA=new Gt,this.groundAnchorB=new Gt,this.localAnchorA=new Gt,this.localAnchorB=new Gt}},e.physics2D_RevoluteJointDef=class{constructor(){this.anchor=new Gt}},e.physics2D_WeldJointDef=class{constructor(){this.anchor=new Gt}},e.physics2D_WheelJointDef=class{constructor(){this.anchor=new Gt,this.axis=new Gt}},e.property=function(e){return Fe},e.regClass=function(e){return function(t){Oe.regClass(e,t)}},e.regLoader=function(e,t,i){return function(r){Be.registerLoader(e,r,t,i)}},e.roundDown=function(e,t){const i=((e+t-1)/t|0)*t;return i>e?i-t:i},e.roundUp=Bh,e.runInEditor=function(e){},e}({});