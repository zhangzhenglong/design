!function(e,t){"use strict";class r{constructor(){this._mask=[],this._length=0}_intersectionDefineDatas(e){for(var t=e._mask,r=this._mask,a=this._length-1;a>=0;a--){var i=r[a]&t[a];0==i&&a==this._length-1?this._length--:r[a]=i}}add(e){var t=e._index,r=t+1,a=this._mask,i=this._length;if(i<r){for(a.length<r&&(a.length=r);i<t;i++)a[i]=0;a[t]=e._value,this._length=r}else a[t]|=e._value}remove(e){var t=e._index,r=this._mask,a=this._length-1;if(!(t>a)){var i=r[t]&~e._value;t==a&&0===i?this._length--:r[t]=i}}addDefineDatas(e){var t=e._mask,r=e._length,a=this._mask,i=this._length;if(i<r){a.length=r;for(var s=0;s<i;s++)a[s]|=t[s];for(;s<r;s++)a[s]=t[s];this._length=r}else for(s=0;s<r;s++)a[s]|=t[s]}removeDefineDatas(e){for(var t=e._mask,r=this._mask,a=this._length-1,i=Math.min(e._length,a);i>=0;i--){var s=r[i]&~t[i];i==a&&0===s?(a--,this._length--):r[i]=s}}has(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)}clear(){this._length=0}cloneTo(e){var t=e._mask,r=this._mask,a=this._length;t.length=a;for(var i=0;i<a;i++)t[i]=r[i];e._length=a}clone(){var e=new r;return this.cloneTo(e),e}destroy(){delete this._mask}}var a,i;e.WebGLExtension=void 0,(a=e.WebGLExtension||(e.WebGLExtension={}))[a.OES_vertex_array_object=0]="OES_vertex_array_object",a[a.ANGLE_instanced_arrays=1]="ANGLE_instanced_arrays",a[a.OES_texture_half_float=2]="OES_texture_half_float",a[a.OES_texture_half_float_linear=3]="OES_texture_half_float_linear",a[a.OES_texture_float=4]="OES_texture_float",a[a.OES_element_index_uint=5]="OES_element_index_uint",a[a.OES_texture_float_linear=6]="OES_texture_float_linear",a[a.EXT_color_buffer_half_float=7]="EXT_color_buffer_half_float",a[a.EXT_shader_texture_lod=8]="EXT_shader_texture_lod",a[a.WEBGL_depth_texture=9]="WEBGL_depth_texture",a[a.EXT_sRGB=10]="EXT_sRGB",a[a.EXT_color_buffer_float=11]="EXT_color_buffer_float",a[a.EXT_texture_filter_anisotropic=12]="EXT_texture_filter_anisotropic",a[a.WEBGL_compressed_texture_s3tc=13]="WEBGL_compressed_texture_s3tc",a[a.WEBGL_compressed_texture_s3tc_srgb=14]="WEBGL_compressed_texture_s3tc_srgb",a[a.WEBGL_compressed_texture_pvrtc=15]="WEBGL_compressed_texture_pvrtc",a[a.WEBGL_compressed_texture_etc1=16]="WEBGL_compressed_texture_etc1",a[a.WEBGL_compressed_texture_etc=17]="WEBGL_compressed_texture_etc",a[a.WEBGL_compressed_texture_astc=18]="WEBGL_compressed_texture_astc",a[a.OES_standard_derivatives=19]="OES_standard_derivatives";class s{constructor(e){this._destroyed=!1,this._engine=e,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}destroy(){this._destroyed||(this._destroyed=!0)}}class n extends s{get gpuMemory(){return this._gpuMemory}set gpuMemory(e){this._changeTexMemory(e),this._gpuMemory=e}_changeTexMemory(e){this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory,-this._gpuMemory+e),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_ALLRenderTexture,-this._gpuMemory+e)}constructor(e,r,a,i,s,n){super(e),this._gpuMemory=0,this.colorFormat=r,this.depthStencilFormat=a,this._isCube=i,this._generateMipmap=s,this._samples=n,this._textures=[],this._depthTexture=null,this._framebuffer=this._gl.createFramebuffer(),n>1&&(this._msaaFramebuffer=this._gl.createFramebuffer()),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_ALLRenderTexture,1)}dispose(){this._textures.forEach((e=>{e&&e.dispose()})),this._textures=null,this._depthTexture&&this._depthTexture.dispose(),this._depthTexture=null,this._framebuffer&&this._gl.deleteFramebuffer(this._framebuffer),this._framebuffer=null,this._depthbuffer&&this._gl.deleteRenderbuffer(this._depthbuffer),this._depthbuffer=null,this._msaaFramebuffer&&this._gl.deleteFramebuffer(this._msaaFramebuffer),this._msaaFramebuffer=null,this._msaaRenderbuffer&&this._gl.deleteRenderbuffer(this._msaaRenderbuffer),this._msaaRenderbuffer=null,this._changeTexMemory(0),this._gpuMemory=0,this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_ALLRenderTexture,-1)}}class _ extends s{get mipmap(){return this._mipmap}get mipmapCount(){return this._mipmapCount}_getSource(){return this.resource}get gpuMemory(){return this._gpuMemory}set gpuMemory(e){this._changeTexMemory(e),this._gpuMemory=e}constructor(e,r,a,i,s,n,_,o,l){super(e),this._gpuMemory=0,this._baseMipmapLevel=0,this._maxMipmapLevel=0,this.resource=this._gl.createTexture(),this.width=a,this.height=i,this.depth=s;const h=e=>0==(e&e-1);switch(this.isPotSize=h(a)&&h(i),n==t.TextureDimension.Tex3D&&(this.isPotSize=this.isPotSize&&h(this.depth)),n){case t.TextureDimension.Tex2D:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_Texture2D,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_Texture2D;break;case t.TextureDimension.Tex3D:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_Texture3D,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_Texture3D;break;case t.TextureDimension.Cube:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_TextureCube,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_TextureCube;break;case t.TextureDimension.Texture2DArray:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_Texture2DArray,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_Texture2DArray}this._mipmap=_&&this.isPotSize,this._mipmapCount=this._mipmap?Math.max(Math.ceil(Math.log2(a))+1,Math.ceil(Math.log2(i))+1):1,this._maxMipmapLevel=this._mipmapCount-1,this._baseMipmapLevel=0,this.useSRGBLoad=o,this.gammaCorrection=l,this.target=r,this.filterMode=t.FilterMode.Bilinear,this.wrapU=t.WrapMode.Repeat,this.wrapV=t.WrapMode.Repeat,this.wrapW=t.WrapMode.Repeat,this.anisoLevel=4,this.compareMode=t.TextureCompareMode.None,g.instance._addStatisticsInfo(this._statistics_RC_Texture,1),g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_ALLTexture,1)}get filterMode(){return this._filterMode}set filterMode(e){if(this._filterMode!=e&&this.resource){let t=this._gl,r=this.mipmap,a=this.getFilteMinrParam(e,r);this._setTexParameteri(t.TEXTURE_MIN_FILTER,a);let i=this.getFilterMagParam(e);this._setTexParameteri(t.TEXTURE_MAG_FILTER,i),this._filterMode=e}}get wrapU(){return this._warpU}set wrapU(e){if(this._warpU!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_S,r),this._warpU=e}}get wrapV(){return this._warpV}set wrapV(e){if(this._warpV!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_T,r),this._warpV=e}}get wrapW(){return this._warpW}set wrapW(e){if(this._warpW!=e&&this.resource){if(this._engine.getCapable(t.RenderCapable.Texture3D)){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_R,r)}this._warpW=e}}get anisoLevel(){return this._anisoLevel}set anisoLevel(r){let a=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);if(a){this._gl;let e=this._engine.getParams(t.RenderParams.Max_AnisoLevel_Count),i=Math.max(1,Math.min(e,r));this._setTexParametexf(a.TEXTURE_MAX_ANISOTROPY_EXT,i),this._anisoLevel=i}else this._anisoLevel=1}set baseMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_BASE_LEVEL,e),this._baseMipmapLevel=e}get baseMipmapLevel(){return this._baseMipmapLevel}set maxMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_MAX_LEVEL,e),this._maxMipmapLevel=e}get maxMipmapLevel(){return this._maxMipmapLevel}get compareMode(){return this._compareMode}set compareMode(e){this._compareMode=e}_setTexParameteri(e,t){let r=this._gl,a=this.target;this._engine._bindTexture(a,this.resource),r.texParameteri(a,e,t),this._engine._bindTexture(a,null)}_setTexParametexf(e,t){let r=this._gl,a=this.target;this._engine._bindTexture(a,this.resource),r.texParameterf(a,e,t),this._engine._bindTexture(a,null)}getFilteMinrParam(e,r){let a=this._gl;switch(e){case t.FilterMode.Point:return r?a.NEAREST_MIPMAP_NEAREST:a.NEAREST;case t.FilterMode.Bilinear:return r?a.LINEAR_MIPMAP_NEAREST:a.LINEAR;case t.FilterMode.Trilinear:return r?a.LINEAR_MIPMAP_LINEAR:a.LINEAR;default:return r?a.LINEAR_MIPMAP_NEAREST:a.LINEAR}}getFilterMagParam(e){let r=this._gl;switch(e){case t.FilterMode.Point:return r.NEAREST;case t.FilterMode.Bilinear:case t.FilterMode.Trilinear:default:return r.LINEAR}}getWrapParam(e){let r=this._gl;switch(e){case t.WrapMode.Repeat:return r.REPEAT;case t.WrapMode.Clamp:return r.CLAMP_TO_EDGE;case t.WrapMode.Mirrored:return r.MIRRORED_REPEAT;default:return r.REPEAT}}_setWrapMode(e,t){let r=this._gl;this.isPotSize||(t=r.CLAMP_TO_EDGE),this._setTexParameteri(e,t)}_changeTexMemory(e){this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory,-this._gpuMemory+e),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_ALLTexture,-this._gpuMemory+e),this._engine._addStatisticsInfo(this._statistics_M_Texture,-this._gpuMemory+e)}dispose(){this._gl.deleteTexture(this.resource),this._changeTexMemory(0),this._gpuMemory=0,g.instance._addStatisticsInfo(this._statistics_RC_Texture,-1),g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_ALLTexture,-1)}}class o extends s{constructor(t){super(t),this._glParam={internalFormat:0,format:0,type:0},this.needBitmap=!1,this._sRGB=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_sRGB),this._oesTextureHalfFloat=this._engine._supportCapatable.getExtension(e.WebGLExtension.OES_texture_half_float),this._compressdTextureS3tc_srgb=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._compressedTextureEtc1=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._compressedTextureS3tc=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._compressedTextureETC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._compressedTextureASTC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._webgl_depth_texture=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_depth_texture)}createTexture3DInternal(e,t,r,a,i,s,n,_){return null}setTexture3DImageData(e,t,r,a,i){return null}setTexture3DPixelsData(e,t,r,a,i){return null}setTexture3DSubPixelsData(e,t,r,a,i,s,n,_,o,l,h,u){return null}glTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.TextureFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_ALPHA_EXT:a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R5G6B5:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_SHORT_5_6_5;break;case t.TextureFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R32G32B32:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.TextureFormat.R16G16B16:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=a.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_SHORT;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=a.DEPTH_STENCIL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL;break;case t.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=a.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.STENCIL_8:default:throw"render texture format wrong."}return this._glParam}glRenderBufferParam(e,r){let a=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return{internalFormat:a.DEPTH_COMPONENT16,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:return{internalFormat:a.DEPTH_STENCIL,attachment:a.DEPTH_STENCIL_ATTACHMENT};case t.RenderTargetFormat.STENCIL_8:return{internalFormat:a.STENCIL_INDEX8,attachment:a.STENCIL_ATTACHMENT};default:return null}}glRenderTargetAttachment(e){let r=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return r.DEPTH_ATTACHMENT;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return r.DEPTH_STENCIL_ATTACHMENT;case t.RenderTargetFormat.DEPTH_32:return r.DEPTH_ATTACHMENT;case t.RenderTargetFormat.STENCIL_8:return r.STENCIL_ATTACHMENT;case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:case t.RenderTargetFormat.R16G16B16:case t.RenderTargetFormat.R16G16B16A16:case t.RenderTargetFormat.R32G32B32:case t.RenderTargetFormat.R32G32B32A32:return r.COLOR_ATTACHMENT0;default:throw"render format."}}getTarget(e){let r=this._gl;switch(e){case t.TextureDimension.Tex2D:return r.TEXTURE_2D;case t.TextureDimension.Cube:return r.TEXTURE_CUBE_MAP;default:throw"texture dimension wrong in WebGL1."}}getFormatPixelsParams(e){let r={channels:0,bytesPerPixel:0,dataTypedCons:Uint8Array,typedSize:1};switch(e){case t.TextureFormat.R8G8B8A8:return r.channels=4,r.bytesPerPixel=4,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case t.TextureFormat.R8G8B8:return r.channels=3,r.bytesPerPixel=3,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case t.TextureFormat.R5G6B5:return r.channels=3,r.bytesPerPixel=2,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R16G16B16:return r.channels=3,r.bytesPerPixel=6,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R16G16B16A16:return r.channels=4,r.bytesPerPixel=8,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R32G32B32:return r.channels=3,r.bytesPerPixel=12,r.dataTypedCons=Float32Array,r.typedSize=4,r;case t.TextureFormat.R32G32B32A32:return r.channels=4,r.bytesPerPixel=16,r.dataTypedCons=Float32Array,r.typedSize=4,r;default:return r}}getGLtexMemory(e,t=1){let r=this._gl,a=0,i=0,s=0,n=this._sRGB?this._sRGB.SRGB_EXT:r.RGB,_=this._sRGB?this._sRGB.SRGB_ALPHA_EXT:r.RGBA;switch(e.internalFormat){case n:case r.RGB:a=3;break;case _:case r.RGBA:a=4;break;default:a=0}switch(e.type){case r.UNSIGNED_BYTE:i=1;break;case r.UNSIGNED_SHORT_5_6_5:i=2/3;break;case r.FLOAT:i=4;break;case this._oesTextureHalfFloat.HALF_FLOAT_OES:i=2;break;default:i=0}return s=a*i*e.width*e.height,e.mipmap&&(s*=1.333),e.target==r.TEXTURE_CUBE_MAP?s*=6:e.target==r.TEXTURE_2D&&(s*=1),s}getGLRTTexMemory(e,r,a,i,s,n,_){let o=e=>{let r=0;switch(e){case t.RenderTargetFormat.R8G8B8:r=3;break;case t.RenderTargetFormat.R8G8B8A8:r=4;break;case t.RenderTargetFormat.R16G16B16A16:r=8;break;case t.RenderTargetFormat.R32G32B32:r=12;break;case t.RenderTargetFormat.R32G32B32A32:r=16;break;case t.RenderTargetFormat.R16G16B16:r=6;break;case t.RenderTargetFormat.DEPTH_16:r=2;break;case t.RenderTargetFormat.STENCIL_8:r=1;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:r=4}return r},l=o(a);return n>1&&(l*=2),_&&(l*=6),s&&(l*=1.333),l*e*r+o(i)*e*r}supportSRGB(e,r){switch(e){case t.TextureFormat.R8G8B8:case t.TextureFormat.R8G8B8A8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB)&&!r;case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:return this._engine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}supportGenerateMipmap(e){switch(e){case t.RenderTargetFormat.DEPTH_16:case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:case t.RenderTargetFormat.STENCIL_8:return!1;default:return!0}}isSRGBFormat(e){switch(e){case t.TextureFormat.ETC2SRGB:case t.TextureFormat.ETC2SRGB_Alpha8:case t.TextureFormat.ETC2SRGB_Alpha1:case t.TextureFormat.ASTC4x4SRGB:case t.TextureFormat.ASTC6x6SRGB:case t.TextureFormat.ASTC8x8SRGB:case t.TextureFormat.ASTC10x10SRGB:case t.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}createTextureInternal(e,t,r,a,i,s,n){let o=this.isSRGBFormat(a)||s&&this.supportSRGB(a,i);n&&(o=!1);let l=1;!o&&s&&(l=2.2);let h=this.getTarget(e),u=new _(this._engine,h,t,r,1,e,i,o,l),d=this.glTextureParam(a,o);return u.internalFormat=d.internalFormat,u.format=d.format,u.type=d.type,u}setTextureImageData(e,t,r,a){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let i=e.target,s=e.internalFormat,n=e.format,_=e.type;e.width,e.height;let o=e._gl;r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),o.texImage2D(i,0,s,n,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&o.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,a,i,s){let n=e.target;e.internalFormat;let _=e.format,o=e.type;t.width,t.height;let l=e._gl;i&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),l.texSubImage2D(n,0,r,a,_,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&l.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1)}initVideoTextureData(e){let t=e.target;e.internalFormat;let r=e.format,a=e.type,i=e.width,s=e.height,n=e._gl;this._engine._bindTexture(e.target,e.resource),n.texImage2D(t,0,e.internalFormat,i,s,0,r,a,null),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&n.generateMipmap(e.target),this._engine._bindTexture(e.target,null)}setTexturePixelsData(e,t,r,a){let i=e.target,s=e.internalFormat,n=e.format,_=e.type,o=e.width,l=e.height,h=o%4==0&&l%4==0,u=e._gl;r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),h||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u.texImage2D(i,0,s,o,l,0,n,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&u.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),h||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setTextureSubPixelsData(e,t,r,a,i,s,n,_,o,l){a=a&&0==r;let h=e.target;e.internalFormat;let u=e.format,d=e.type,m=n%4==0&&_%4==0,c=e._gl;o&&c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),l&&c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),m||c.pixelStorei(c.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),c.texSubImage2D(h,r,i,s,n,_,u,d,t),e.mipmap&&a&&c.generateMipmap(e.target),this._engine._bindTexture(e.target,null),o&&c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),l&&c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),m||c.pixelStorei(c.UNPACK_ALIGNMENT,4)}setTextureDDSData(e,t){let r=e.target,a=e.internalFormat,i=e.format,s=e.type,n=e.width,_=e.height,o=t.source,l=t.dataOffset,h=t.bpp,u=t.blockBytes,d=t.mipmapCount,m=t.compressed;e.maxMipmapLevel=d-1;let c=n%4==0&&_%4==0,f=e._gl;c||f.pixelStorei(f.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let E=this.getFormatPixelsParams(t.format),T=E.bytesPerPixel/E.channels,g=E.dataTypedCons,p=n,x=_,R=0;for(let e=0;e<d;e++){if(m){let t=Math.max(4,p)/4*Math.max(4,x)/4*u,i=new Uint8Array(o,l,t);f.compressedTexImage2D(r,e,a,p,x,0,i),R+=i.length,l+=h?p*x*(h/8):t}else{let t=p*x*E.channels,n=new g(o,l,t);R+=n.length,f.texImage2D(r,e,a,p,x,0,i,s,n),l+=t*T}p*=.5,x*=.5,p=Math.max(1,p),x=Math.max(1,x)}e.gpuMemory=R,this._engine._bindTexture(e.target,null),c||f.pixelStorei(f.UNPACK_ALIGNMENT,4)}setTextureKTXData(e,t){let r=t.source,a=t.compress,i=e.target,s=e.internalFormat,n=e.format,_=e.type,o=e.mipmapCount,l=e.width,h=e.height;e.maxMipmapLevel=o-1;let u=l%4==0&&h%4==0,d=e._gl;u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let m=l,c=h,f=t.headerOffset+t.bytesOfKeyValueData,E=0;for(let e=0;e<t.mipmapCount;e++){let o=new Int32Array(r,f,1)[0];if(f+=4,a){let t=new Uint8Array(r,f,o);d.compressedTexImage2D(i,e,s,m,c,0,t),E+=t.length}else{let a=this.getFormatPixelsParams(t.format),l=o/a.typedSize,h=new a.dataTypedCons(r,f,l);d.texImage2D(i,e,s,m,c,0,n,_,h),E+=h.byteLength}f+=o,f+=3-(o+3)%4,m=Math.max(1,.5*m),c=Math.max(1,.5*c)}for(let r=t.mipmapCount;r<e.mipmapCount;r++)a||d.texImage2D(i,r,s,m,c,0,n,_,null),m=Math.max(1,.5*m),c=Math.max(1,.5*c);e.gpuMemory=E,this._engine._bindTexture(e.target,null),u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setCubeImageData(e,t,r,a){let i=e._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.internalFormat,_=e.format,o=e.type;e.width,e.height,r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<s.length;e++){let r=s[e];i.texImage2D(r,0,n,_,o,t[e])}e.mipmap&&i.generateMipmap(e.target),this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,a){let i=e._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target;let n=e.internalFormat,_=e.format,o=e.type,l=e.width,h=e.height,u=l%4==0;if(r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),u||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),t){for(let e=0;e<s.length;e++){let r=s[e];i.texImage2D(r,0,n,l,h,0,_,o,t[e])}e.mipmap&&i.generateMipmap(e.target)}else{for(let e=0;e<s.length;e++){let t=s[e];i.texImage2D(t,0,n,l,h,0,_,o,null)}e.mipmap&&i.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),u||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setCubeSubPixelData(e,t,r,a,i,s,n,_,o,l){a=a&&0==r;let h=e._gl;const u=[h.TEXTURE_CUBE_MAP_POSITIVE_Z,h.TEXTURE_CUBE_MAP_NEGATIVE_Z,h.TEXTURE_CUBE_MAP_POSITIVE_X,h.TEXTURE_CUBE_MAP_NEGATIVE_X,h.TEXTURE_CUBE_MAP_POSITIVE_Y,h.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target,e.internalFormat;let d=e.format,m=e.type,c=n%4==0;o&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),l&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),c||h.pixelStorei(h.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<u.length;e++){let a=u[e];h.texSubImage2D(a,r,i,s,n,_,d,m,t[e])}e.mipmap&&a&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),o&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),l&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1),c||h.pixelStorei(h.UNPACK_ALIGNMENT,4)}setCubeDDSData(e,t){let r=e.internalFormat,a=e.format,i=e.type,s=e.width,n=e.height,_=t.source,o=t.dataOffset,l=t.bpp,h=t.blockBytes,u=t.mipmapCount;e.maxMipmapLevel=u-1;let d=s%4==0&&n%4==0;d=!0;let m=e._gl;this._engine._bindTexture(e.target,e.resource);const c=[m.TEXTURE_CUBE_MAP_POSITIVE_X,m.TEXTURE_CUBE_MAP_NEGATIVE_X,m.TEXTURE_CUBE_MAP_POSITIVE_Y,m.TEXTURE_CUBE_MAP_NEGATIVE_Y,m.TEXTURE_CUBE_MAP_POSITIVE_Z,m.TEXTURE_CUBE_MAP_NEGATIVE_Z];let f=this.getFormatPixelsParams(t.format),E=f.bytesPerPixel/f.channels,T=f.dataTypedCons,g=0;if(t.compressed)for(let t=0;t<6;t++){let a=c[t],i=s,d=n;for(let t=0;t<u;t++){let s=Math.max(4,i)/4*Math.max(4,d)/4*h,n=new Uint8Array(_,o,s);(e.mipmap||0==t)&&m.compressedTexImage2D(a,t,r,i,d,0,n),g+=n.byteLength,o+=l?i*d*(l/8):s,i*=.5,d*=.5,i=Math.max(1,i),d=Math.max(1,d)}}else for(let e=0;e<6;e++){let t=c[e],l=s,h=n;for(let e=0;e<u;e++){let s=l*h*f.channels,n=new T(_,o,s);m.texImage2D(t,e,r,l,h,0,a,i,n),g+=n.byteLength,o+=s*E,l*=.5,h*=.5,l=Math.max(1,l),h=Math.max(1,h)}}e.gpuMemory=g,this._engine._bindTexture(e.target,null)}setCubeKTXData(e,t){let r=t.source,a=t.compress,i=e.internalFormat,s=e.format,n=e.type,_=t.mipmapCount,o=e.width,l=e.height;e.maxMipmapLevel=_-1;let h=o%4==0&&l%4==0,u=e._gl;const d=[u.TEXTURE_CUBE_MAP_POSITIVE_X,u.TEXTURE_CUBE_MAP_NEGATIVE_X,u.TEXTURE_CUBE_MAP_POSITIVE_Y,u.TEXTURE_CUBE_MAP_NEGATIVE_Y,u.TEXTURE_CUBE_MAP_POSITIVE_Z,u.TEXTURE_CUBE_MAP_NEGATIVE_Z];h||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let m=o,c=l,f=t.headerOffset+t.bytesOfKeyValueData,E=0;for(let e=0;e<t.mipmapCount;e++){let _=new Int32Array(r,f,1)[0];f+=4;for(let o=0;o<6;o++){let l=d[o];if(a){let t=new Uint8Array(r,f,_);u.compressedTexImage2D(l,e,i,m,c,0,t),E+=t.byteLength}else{let a=this.getFormatPixelsParams(t.format),o=_/a.typedSize,h=new a.dataTypedCons(r,f,o);u.texImage2D(l,e,i,m,c,0,s,n,h),E+=h.byteLength}f+=_,f+=3-(_+3)%4}m=Math.max(1,.5*m),c=Math.max(1,.5*c)}for(let r=t.mipmapCount;r<e.mipmapCount;r++){for(let e=0;e<6;e++){let t=d[e];a||u.texImage2D(t,r,i,m,c,0,s,n,null)}m=Math.max(1,.5*m),c=Math.max(1,.5*c)}this._engine._bindTexture(e.target,null),e.gpuMemory=E,h||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setTextureCompareMode(e,r){return t.TextureCompareMode.None}bindRenderTarget(e,t=0){this.currentActiveRT&&this.unbindRenderTarget(this.currentActiveRT);let r=this._gl,a=e._framebuffer;if(r.bindFramebuffer(r.FRAMEBUFFER,a),e._isCube){let a=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,a.resource,0)}this.currentActiveRT=e}bindoutScreenTarget(){this.currentActiveRT!=g._lastFrameBuffer&&this.unbindRenderTarget(this.currentActiveRT)}unbindRenderTarget(e){let t=e._gl;e&&e._generateMipmap&&e._textures.forEach((e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)})),t.bindFramebuffer(t.FRAMEBUFFER,g._lastFrameBuffer_WebGLOBJ),this.currentActiveRT=g._lastFrameBuffer}createRenderTextureCubeInternal(e,r,a,i,s){i=i&&this.supportGenerateMipmap(a);let n=this.getTarget(e),o=new _(this._engine,n,r,r,1,e,i,false,1),l=this.glRenderTextureParam(a,false);o.internalFormat=l.internalFormat,o.format=l.format,o.type=l.type;let h=o.internalFormat,u=o.format,d=o.type,m=o._gl;const c=[m.TEXTURE_CUBE_MAP_POSITIVE_Z,m.TEXTURE_CUBE_MAP_NEGATIVE_Z,m.TEXTURE_CUBE_MAP_POSITIVE_X,m.TEXTURE_CUBE_MAP_NEGATIVE_X,m.TEXTURE_CUBE_MAP_POSITIVE_Y,m.TEXTURE_CUBE_MAP_NEGATIVE_Y];this._engine._bindTexture(o.target,o.resource);for(let e=0;e<c.length;e++){let t=c[e];m.texImage2D(t,0,h,r,r,0,u,d,null)}return this._engine._bindTexture(o.target,null),a!=t.RenderTargetFormat.DEPTH_16&&a!=t.RenderTargetFormat.DEPTH_32&&a!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(o.filterMode=t.FilterMode.Point),o}createRenderTargetInternal(e,r,a,i,s,_,o){let l=this.createRenderTextureInternal(t.TextureDimension.Tex2D,e,r,a,s,_),h=new n(this._engine,a,i,!1,l.mipmap,1);h.gpuMemory=this.getGLRTTexMemory(e,r,a,i,s,1,!1),h.colorFormat=a,h.depthStencilFormat=i,h._textures.push(l);let u=h._framebuffer,d=h._gl;d.bindFramebuffer(d.FRAMEBUFFER,u);let m=this.glRenderTargetAttachment(a);d.framebufferTexture2D(d.FRAMEBUFFER,m,d.TEXTURE_2D,l.resource,0);let c=this.glRenderBufferParam(i,!1);if(c){let t=this.createRenderbuffer(e,r,c.internalFormat,h._samples);h._depthbuffer=t,d.framebufferRenderbuffer(d.FRAMEBUFFER,c.attachment,d.RENDERBUFFER,t)}return d.bindFramebuffer(d.FRAMEBUFFER,g._lastFrameBuffer_WebGLOBJ),h}createRenderTargetCubeInternal(e,r,a,i,s,_){let o=this.createRenderTextureCubeInternal(t.TextureDimension.Cube,e,r,i,s),l=new n(this._engine,r,a,!0,o.mipmap,1);l.gpuMemory=this.getGLRTTexMemory(e,e,r,a,i,1,!0),l._textures.push(o);let h=l._framebuffer,u=l._gl;u.bindFramebuffer(u.FRAMEBUFFER,h);let d=this.glRenderBufferParam(a,!1);if(d){let t=this.createRenderbuffer(e,e,d.internalFormat,l._samples);l._depthbuffer=t,u.framebufferRenderbuffer(u.FRAMEBUFFER,d.attachment,u.RENDERBUFFER,t)}return u.bindFramebuffer(u.FRAMEBUFFER,g._lastFrameBuffer_WebGLOBJ),l}createRenderbuffer(e,t,r,a){let i=this._gl,s=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,s),i.renderbufferStorage(i.RENDERBUFFER,r,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null),s}createRenderTextureInternal(e,r,a,i,s,n){s=s&&this.supportGenerateMipmap(i);let o=this.getTarget(e),l=new _(this._engine,o,r,a,1,e,s,false,1),h=this.glRenderTextureParam(i,false);l.internalFormat=h.internalFormat,l.format=h.format,l.type=h.type;let u=l.internalFormat,d=l.format,m=l.type,c=l._gl;return this._engine._bindTexture(l.target,l.resource),c.texImage2D(o,0,u,r,a,0,d,m,null),this._engine._bindTexture(l.target,null),i!=t.RenderTargetFormat.DEPTH_16&&i!=t.RenderTargetFormat.DEPTH_32&&i!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(l.filterMode=t.FilterMode.Point),l}createRenderTargetDepthTexture(e,r,a,i){let s=e._gl;if(e.depthStencilFormat==t.RenderTargetFormat.None)return null;let n=e._depthbuffer;n&&s.deleteRenderbuffer(n),e._depthbuffer=null;let _=e.depthStencilFormat,o=e._generateMipmap,l=e.isSRGB;e._depthTexture&&s.deleteTexture(e._depthTexture);let h=this.createRenderTextureInternal(r,a,i,_,o,l);e._depthTexture=h;let u=this.glRenderTargetAttachment(e.depthStencilFormat),d=e._framebuffer;return s.bindFramebuffer(s.FRAMEBUFFER,d),s.framebufferTexture2D(s.FRAMEBUFFER,u,s.TEXTURE_2D,h.resource,0),s.bindFramebuffer(s.FRAMEBUFFER,g._lastFrameBuffer_WebGLOBJ),h}readRenderTargetPixelData(e,r,a,i,s,n){let _=e._gl;if(this.bindRenderTarget(e),!(_.checkFramebufferStatus(_.FRAMEBUFFER)==_.FRAMEBUFFER_COMPLETE))return this.unbindRenderTarget(e),null;switch(e.colorFormat){case t.RenderTargetFormat.R8G8B8:_.readPixels(r,a,i,s,_.RGB,_.UNSIGNED_BYTE,n);break;case t.RenderTargetFormat.R8G8B8A8:_.readPixels(r,a,i,s,_.RGBA,_.UNSIGNED_BYTE,n);break;case t.RenderTargetFormat.R16G16B16:_.readPixels(r,a,i,s,_.RGB,_.FLOAT,n);break;case t.RenderTargetFormat.R16G16B16A16:_.readPixels(r,a,i,s,_.RGBA,_.FLOAT,n);break;case t.RenderTargetFormat.R32G32B32:_.readPixels(r,a,i,s,_.RGB,_.FLOAT,n);break;case t.RenderTargetFormat.R32G32B32A32:_.readPixels(r,a,i,s,_.RGBA,_.FLOAT,n)}return this.unbindRenderTarget(e),n}readRenderTargetPixelDataAsync(e,t,r,a,i,s){return Promise.resolve(this.readRenderTargetPixelData(e,t,r,a,i,s))}updateVideoTexture(e,t,r,a){let i=e._gl,s=e.target,n=e.internalFormat,_=e.format,o=e.type;e.width,e.height,r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),i.texImage2D(s,0,n,_,o,t),this._engine._bindTexture(e.target,null),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.pixelStorei(i.UNPACK_ALIGNMENT,4)}}class l extends o{constructor(e){super(e)}getTarget(e){let r=-1;switch(e){case t.TextureDimension.Cube:r=this._gl.TEXTURE_CUBE_MAP;break;case t.TextureDimension.Tex2D:r=this._gl.TEXTURE_2D;break;case t.TextureDimension.Texture2DArray:r=this._gl.TEXTURE_2D_ARRAY;break;case t.TextureDimension.Tex3D:r=this._gl.TEXTURE_3D;break;default:throw"Unknow Texture Target"}return r}glTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.TextureFormat.R8G8B8:this._glParam.internalFormat=r?a.SRGB8:a.RGB8,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?a.SRGB8_ALPHA8:a.RGBA8,this._glParam.format=a.RGBA,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R5G6B5:this._glParam.internalFormat=a.RGB565,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_SHORT_5_6_5;break;case t.TextureFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA32F,this._glParam.format=a.RGBA,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R32G32B32:this._glParam.internalFormat=a.RGB32F,this._glParam.format=a.RGB,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R16G16B16:this._glParam.internalFormat=a.RGB16F,this._glParam.format=a.RGB,this._glParam.type=a.HALF_FLOAT;break;case t.TextureFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA16F,this._glParam.format=a.RGBA,this._glParam.type=a.HALF_FLOAT;break;case t.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case t.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case t.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case t.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL;break;case t.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case t.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2;break;case t.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case t.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case t.TextureFormat.ETC2RGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;break;case t.TextureFormat.ETC2SRGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;break;case t.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case t.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR;break;case t.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR;break;case t.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR;break;case t.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR;break;case t.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case t.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;break;case t.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;break;case t.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;break;case t.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderBufferParam(e,r){let a=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return{internalFormat:a.DEPTH_COMPONENT16,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:a.DEPTH24_STENCIL8,attachment:a.DEPTH_STENCIL_ATTACHMENT};case t.RenderTargetFormat.DEPTH_32:return{internalFormat:a.DEPTH_COMPONENT32F,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.STENCIL_8:return{internalFormat:a.STENCIL_INDEX8,attachment:a.STENCIL_ATTACHMENT};case t.RenderTargetFormat.R8G8B8:return{internalFormat:r?a.SRGB8:a.RGB8,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R8G8B8A8:return{internalFormat:r?a.SRGB8_ALPHA8:a.RGBA8,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R16G16B16:return{internalFormat:a.RGB16F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R16G16B16A16:return{internalFormat:a.RGBA16F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R32G32B32:return{internalFormat:a.RGB32F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R32G32B32A32:return{internalFormat:a.RGBA32F,attachment:a.COLOR_ATTACHMENT0};default:return null}}glRenderTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?a.SRGB8:a.RGB8,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?a.SRGB8_ALPHA8:a.RGBA8,this._glParam.format=a.RGBA,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=a.RGB16F,this._glParam.format=a.RGB,this._glParam.type=a.HALF_FLOAT;break;case t.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA16F,this._glParam.format=a.RGBA,this._glParam.type=a.HALF_FLOAT;break;case t.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=a.RGB32F,this._glParam.format=a.RGB,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA32F,this._glParam.format=a.RGBA,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=a.DEPTH_COMPONENT16,this._glParam.format=a.DEPTH_COMPONENT,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=a.DEPTH24_STENCIL8,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT_24_8;break;case t.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=a.DEPTH_COMPONENT32F,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.STENCIL_8:break;default:throw"depth texture format wrong."}return this._glParam}getGLtexMemory(e,t=1){let r=this._gl,a=0,i=0,s=0;switch(e.internalFormat){case r.SRGB8:case r.RGB8:case r.RGB565:case r.RGB32F:case r.RGB16F:a=3;break;case r.SRGB8_ALPHA8:case r.RGBA8:case r.RGBA32F:case r.RGBA16F:a=4;break;default:a=0}switch(e.type){case r.UNSIGNED_BYTE:i=1;break;case r.UNSIGNED_SHORT_5_6_5:i=2/3;break;case r.FLOAT:i=4;break;case r.HALF_FLOAT:i=2;break;default:i=0}return s=a*i*e.width*e.height,e.mipmap&&(s*=1.333),e.target==r.TEXTURE_CUBE_MAP?s*=6:e.target==r.TEXTURE_2D?s*=1:e.target==r.TEXTURE_2D_ARRAY&&(s*=t),s}supportSRGB(e,r){switch(e){case t.TextureFormat.R8G8B8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB)&&!r;case t.TextureFormat.R8G8B8A8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB);case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:return this._engine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}setTextureImageData(e,t,r,a){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let i=e.target,s=e.internalFormat,n=e.format,_=e.type,o=e.width,l=e.height,h=e.mipmapCount,u=this._gl;r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),u.texStorage2D(i,h,s,o,l),u.texSubImage2D(i,0,0,0,o,l,n,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&u.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,a,i,s){let n=e.target;e.internalFormat;let _=e.format,o=e.type;e.width,e.height,e.mipmapCount;let l=this._gl;i&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),l.texSubImage2D(n,0,r,a,t.width,t.height,_,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&l.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1)}setTexturePixelsData(e,t,r,a){let i=e.target,s=e.internalFormat,n=e.format,_=e.type,o=e.width,l=e.height,h=e.mipmapCount,u=o%4==0&&l%4==0,d=this._gl;r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d.texStorage2D(i,h,s,o,l),e.gpuMemory=this.getGLtexMemory(e),t&&(d.texSubImage2D(i,0,0,0,o,l,n,_,t),e.mipmap&&d.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1),u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}createTexture3DInternal(e,t,r,a,i,s,n,o){let l=this.isSRGBFormat(i)||n&&this.supportSRGB(i,s);o&&(l=!1);let h=1;!l&&n&&(h=2.2);let u=this.getTarget(e),d=new _(this._engine,u,t,r,a,e,s,l,h),m=this.glTextureParam(i,l);return d.internalFormat=m.internalFormat,d.format=m.format,d.type=m.type,d}setTexture3DImageData(e,t,r,a,i){let s=e.target,n=e.internalFormat,_=e.format,o=e.type,l=e.width,h=e.height,u=e.mipmapCount,d=this._gl;a&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),d.texStorage3D(s,u,n,l,h,r),e.gpuMemory=this.getGLtexMemory(e,r);for(let e=0;e<r;e++)d.texSubImage3D(s,0,0,0,e,l,h,1,_,o,t[e]);e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&d.generateMipmap(e.target),this._engine._bindTexture(e.target,null),a&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1)}setTexture3DPixelsData(e,t,r,a,i){let s=e.target,n=e.internalFormat,_=e.format,o=e.type,l=e.width,h=e.height,u=e.mipmapCount,d=l%4==0&&h%4==0,m=this._gl;a&&m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!0),d||m.pixelStorei(m.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),m.texStorage3D(s,u,n,l,h,r),e.gpuMemory=this.getGLtexMemory(e,r),t&&(m.texSubImage3D(s,0,0,0,0,l,h,r,_,o,t),e.mipmap&&m.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),a&&m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!1),d||m.pixelStorei(m.UNPACK_ALIGNMENT,4)}setTexture3DSubPixelsData(e,t,r,a,i,s,n,_,o,l,h,u){a=a&&0==r;let d=e.target;e.internalFormat;let m=e.format,c=e.type,f=_%4==0&&o%4==0,E=this._gl;h&&E.pixelStorei(E.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),u&&E.pixelStorei(E.UNPACK_FLIP_Y_WEBGL,!0),f||E.pixelStorei(E.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),E.texSubImage3D(d,r,i,s,n,_,o,l,m,c,t),e.mipmap&&a&&E.generateMipmap(e.target),this._engine._bindTexture(e.target,null),h&&E.pixelStorei(E.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),u&&E.pixelStorei(E.UNPACK_FLIP_Y_WEBGL,!1),f||E.pixelStorei(E.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setTextureKTXData(e,t){let r=e.target,a=e.internalFormat,i=e.format,s=e.type,n=e.mipmapCount,_=e.width,o=e.height;e.maxMipmapLevel=n-1;let l=t.source,h=t.compress,u=_%4==0&&o%4==0,d=this._gl;u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),h||d.texStorage2D(r,t.mipmapCount,a,_,o);let m=_,c=o,f=t.headerOffset+t.bytesOfKeyValueData,E=0;for(let e=0;e<t.mipmapCount;e++){let n=new Int32Array(l,f,1)[0];if(f+=4,h){let t=new Uint8Array(l,f,n);d.compressedTexImage2D(r,e,a,m,c,0,t),E+=t.length}else{let a=this.getFormatPixelsParams(t.format),_=n/a.typedSize,o=new a.dataTypedCons(l,f,_);d.texSubImage2D(r,e,0,0,m,c,i,s,o),E+=o.length}f+=n,f+=3-(n+3)%4,m=Math.max(1,.5*m),c=Math.max(1,.5*c)}this._engine._bindTexture(e.target,null),e.gpuMemory=E,u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setCubeImageData(e,t,r,a){let i=this._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,_=e.internalFormat,o=e.format,l=e.type,h=e.width,u=e.height,d=e.mipmapCount;r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),i.texStorage2D(n,d,_,h,u),e.gpuMemory=this.getGLtexMemory(e);for(let e=0;e<s.length;e++){let r=s[e];i.texSubImage2D(r,0,0,0,o,l,t[e])}e.mipmap&&i.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,a){let i=this._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,_=e.internalFormat,o=e.format,l=e.type,h=e.width,u=e.height,d=e.mipmapCount,m=h%4==0;if(r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),m||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),i.texStorage2D(n,d,_,h,u),t){for(let e=0;e<s.length;e++){let r=s[e];i.texSubImage2D(r,0,0,0,h,u,o,l,t[e])}e.mipmap&&i.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),m||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setCubeKTXData(e,t){let r=this._gl;const a=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let i=e.target,s=e.internalFormat,n=e.format,_=e.type;e.mipmapCount;let o=e.width,l=e.height;e.maxMipmapLevel=t.mipmapCount-1;let h=t.source,u=t.compress,d=o,m=l,c=t.headerOffset+t.bytesOfKeyValueData,f=o%4==0&&l%4==0;f||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u||r.texStorage2D(i,t.mipmapCount,s,o,l);let E=0;for(let e=0;e<t.mipmapCount;e++){let i=new Int32Array(h,c,1)[0];c+=4;for(let o=0;o<6;o++){let l=a[o];if(u){let t=new Uint8Array(h,c,i);r.compressedTexImage2D(l,e,s,d,m,0,t),E+=t.byteLength}else{let a=this.getFormatPixelsParams(t.format),s=i/a.typedSize,o=new a.dataTypedCons(h,c,s);r.texSubImage2D(l,e,0,0,d,m,n,_,o),E+=o.byteLength}c+=i,c+=3-(i+3)%4}d=Math.max(1,.5*d),m=Math.max(1,.5*m)}e.gpuMemory=E,this._engine._bindTexture(e.target,null),f||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}getCubeKTXRGBMData(e,t){let r=this._gl;const a=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let i=e.target,s=e.internalFormat,n=e.format,_=e.type,o=e.mipmapCount,l=e.width,h=e.height;e.maxMipmapLevel=o-1;let u=t.source,d=t.compress,m=l,c=h,f=t.headerOffset+t.bytesOfKeyValueData,E=l%4==0&&h%4==0;E||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d||r.texStorage2D(i,t.mipmapCount,s,l,h);let T=0;for(let e=0;e<t.mipmapCount;e++){let i=new Int32Array(u,f,1)[0];f+=4;for(let s=0;s<6;s++){let o=a[s],l=this.getFormatPixelsParams(t.format),h=i/l.typedSize,d=new l.dataTypedCons(u,f,h);r.texSubImage2D(o,e,0,0,m,c,n,_,d),T+=d.byteLength}f+=i,f+=3-(i+3)%4}m=Math.max(1,.5*m),c=Math.max(1,.5*c),e.gpuMemory=T,this._engine._bindTexture(e.target,null),E||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}setTextureCompareMode(e,r){let a=this._gl;switch(r){case t.TextureCompareMode.LEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.GEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.GEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.LESS:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LESS),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.GREATER:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.GREATER),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.EQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.EQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.NOTEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.NOTEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.ALWAYS:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.ALWAYS),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.NEVER:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.NEVER),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.None:default:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.NONE)}return r}createRenderbuffer(e,t,r,a){let i=this._gl,s=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,s),a>1?i.renderbufferStorageMultisample(i.RENDERBUFFER,a,r,e,t):i.renderbufferStorage(i.RENDERBUFFER,r,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null),s}createRenderTextureInternal(e,r,a,i,s,n){s=s&&this.supportGenerateMipmap(i);let o=this.isSRGBFormat(i)||n&&this.supportSRGB(i,s),l=this.getTarget(e),h=new _(this._engine,l,r,a,1,e,s,o,1),u=this.glRenderTextureParam(i,o);h.internalFormat=u.internalFormat,h.format=u.format,h.type=u.type;let d=h.internalFormat;h.format,h.type;let m=this._gl;return this._engine._bindTexture(h.target,h.resource),m.texStorage2D(l,h.mipmapCount,d,r,a),this._engine._bindTexture(h.target,null),i!=t.RenderTargetFormat.DEPTH_16&&i!=t.RenderTargetFormat.DEPTH_32&&i!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(h.filterMode=t.FilterMode.Point),h}createRenderTargetInternal(e,r,a,i,s,_,o){let l=this.createRenderTextureInternal(t.TextureDimension.Tex2D,e,r,a,s,_),h=new n(this._engine,a,i,!1,l.mipmap,o);h.gpuMemory=this.getGLRTTexMemory(e,r,a,i,s,o,!1),h._textures.push(l);let u=h._gl;if(h._samples>1){let t=h._msaaFramebuffer,s=this.glRenderBufferParam(a,_),n=h._msaaRenderbuffer=this.createRenderbuffer(e,r,s.internalFormat,h._samples);u.bindFramebuffer(u.FRAMEBUFFER,t),u.framebufferRenderbuffer(u.FRAMEBUFFER,s.attachment,u.RENDERBUFFER,n);let o=this.glRenderBufferParam(i,!1);if(o){let t=this.createRenderbuffer(e,r,o.internalFormat,h._samples);h._depthbuffer=t,u.framebufferRenderbuffer(u.FRAMEBUFFER,o.attachment,u.RENDERBUFFER,t)}u.bindFramebuffer(u.FRAMEBUFFER,g._lastFrameBuffer_WebGLOBJ);let d=h._framebuffer;u.bindFramebuffer(u.FRAMEBUFFER,d);let m=this.glRenderTargetAttachment(a);u.framebufferTexture2D(u.FRAMEBUFFER,m,u.TEXTURE_2D,l.resource,0),u.bindFramebuffer(u.FRAMEBUFFER,g._lastFrameBuffer_WebGLOBJ)}else{let t=h._framebuffer;u.bindFramebuffer(u.FRAMEBUFFER,t);let s=this.glRenderTargetAttachment(a);u.framebufferTexture2D(u.FRAMEBUFFER,s,u.TEXTURE_2D,l.resource,0);let n=this.glRenderBufferParam(i,!1);if(n){let t=this.createRenderbuffer(e,r,n.internalFormat,h._samples);h._depthbuffer=t,u.framebufferRenderbuffer(u.FRAMEBUFFER,n.attachment,u.RENDERBUFFER,t)}u.bindFramebuffer(u.FRAMEBUFFER,g._lastFrameBuffer_WebGLOBJ)}return h}createRenderTargetCubeInternal(e,r,a,i,s,_){let o=this.createRenderTextureCubeInternal(t.TextureDimension.Cube,e,r,i,s),l=new n(this._engine,r,a,!0,o.mipmap,_);l.gpuMemory=this.getGLRTTexMemory(e,e,r,a,i,_,!0),l.colorFormat=r,l.depthStencilFormat=a,l._textures.push(o),l.isSRGB=s;let h=l._gl;if(l._samples>1){let t=l._msaaFramebuffer,i=this.glRenderBufferParam(r,!1),s=l._msaaRenderbuffer=this.createRenderbuffer(e,e,i.internalFormat,l._samples);h.bindFramebuffer(h.FRAMEBUFFER,t),h.framebufferRenderbuffer(h.FRAMEBUFFER,i.attachment,h.RENDERBUFFER,s);let n=this.glRenderBufferParam(a,!1);if(n){let t=this.createRenderbuffer(e,e,n.internalFormat,l._samples);l._depthbuffer=t,h.framebufferRenderbuffer(h.FRAMEBUFFER,n.attachment,h.RENDERBUFFER,t)}h.bindFramebuffer(h.FRAMEBUFFER,g._lastFrameBuffer_WebGLOBJ)}else{let t=l._framebuffer;h.bindFramebuffer(h.FRAMEBUFFER,t);let r=this.glRenderBufferParam(a,!1);if(r){let t=this.createRenderbuffer(e,e,r.internalFormat,l._samples);l._depthbuffer=t,h.framebufferRenderbuffer(h.FRAMEBUFFER,r.attachment,h.RENDERBUFFER,t)}h.bindFramebuffer(h.FRAMEBUFFER,g._lastFrameBuffer_WebGLOBJ)}return l}createRenderTextureCubeInternal(e,t,r,a,i){a=a&&this.supportGenerateMipmap(r);let s=this.isSRGBFormat(r)||i&&this.supportSRGB(r,a),n=this.getTarget(e),o=new _(this._engine,n,t,t,1,e,a,s,1),l=this.glRenderTextureParam(r,s);o.internalFormat=l.internalFormat,o.format=l.format,o.type=l.type;let h=o.internalFormat;o.format,o.type;let u=this._gl;return this._engine._bindTexture(o.target,o.resource),u.texStorage2D(n,o.mipmapCount,h,t,t),this._engine._bindTexture(o.target,null),o}bindRenderTarget(e,t=0){this.currentActiveRT&&this.unbindRenderTarget(this.currentActiveRT);let r=this._gl;if(e._isCube){let a=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,a);let i=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.resource,0)}if(e._samples>1)r.bindFramebuffer(r.FRAMEBUFFER,e._msaaFramebuffer);else{let t=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,t)}this.currentActiveRT=e}unbindRenderTarget(e){let t=this._gl;if(e&&e._samples>1){t.bindFramebuffer(t.READ_FRAMEBUFFER,e._msaaFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer);let r=e._textures[0],a=t.COLOR_BUFFER_BIT;e._depthTexture&&(a|=t.DEPTH_BUFFER_BIT),t.blitFramebuffer(0,0,r.width,r.height,0,0,r.width,r.height,a,t.NEAREST)}e&&e._generateMipmap&&e._textures.forEach((e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)})),t.bindFramebuffer(t.FRAMEBUFFER,g._lastFrameBuffer_WebGLOBJ),this.currentActiveRT=g._lastFrameBuffer}}class h extends s{constructor(e,r,a){super(e),this._byteLength=0,this._glTargetType=r,this._glBufferUsageType=a,this._getGLTarget(this._glTargetType),this._getGLUsage(this._glBufferUsageType),this._glBuffer=this._gl.createBuffer(),g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_GPUBuffer,1)}_getGLUsage(e){switch(e){case t.BufferUsage.Static:this._glUsage=this._gl.STATIC_DRAW;break;case t.BufferUsage.Dynamic:this._glUsage=this._gl.DYNAMIC_DRAW;break;case t.BufferUsage.Stream:this._glUsage=this._gl.STREAM_DRAW;break;default:console.error("usage is not standard")}}_getGLTarget(e){switch(e){case t.BufferTargetType.ARRAY_BUFFER:this._glTarget=this._gl.ARRAY_BUFFER;break;case t.BufferTargetType.UNIFORM_BUFFER:this._glTarget=this._gl.UNIFORM_BUFFER;break;case t.BufferTargetType.ELEMENT_ARRAY_BUFFER:this._glTarget=this._gl.ELEMENT_ARRAY_BUFFER}}_memorychange(e){this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUBuffer,-this._byteLength+e),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory,-this._byteLength+e)}bindBuffer(){return this._engine._getbindBuffer(this._glTargetType)!=this&&(this._gl.bindBuffer(this._glTarget,this._glBuffer),this._engine._setbindBuffer(this._glTargetType,this),!0)}unbindBuffer(){this._engine._getbindBuffer(this._glTargetType)==this&&(this._gl.bindBuffer(this._glTarget,null),this._engine._setbindBuffer(this._glTargetType,null))}orphanStorage(){this.bindBuffer(),this.setDataLength(this._byteLength)}setDataLength(e){let t=this._gl;this.bindBuffer(),this._memorychange(e),this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage),this.unbindBuffer()}setData(e,r){let a=this._gl;this.bindBuffer(),a.bufferSubData(this._glTarget,r,e),g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_GeometryBufferUploadCount,1),this.unbindBuffer()}setDataEx(e,r,a){let i=this._gl;this.bindBuffer(),i.bufferSubData(this._glTarget,r,e,0,a),g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_GeometryBufferUploadCount,1),this.unbindBuffer()}bindBufferBase(e){const t=this._gl;let r=this._engine._uboBindingMap[e];r&&r.buffer!=this._glBuffer&&(this._engine._getbindBuffer(this._glTargetType)!=this&&this._engine._setbindBuffer(this._glTargetType,this),t.bindBufferBase(this._glTarget,e,this._glBuffer),r.buffer=this._glBuffer,r.offset=0,r.size=this._byteLength)}bindBufferRange(e,t,r){const a=this._gl;let i=this._engine._uboBindingMap[e];i&&(i.buffer==this._glBuffer&&i.offset==t&&i.size==r||(this._engine._getbindBuffer(this._glTargetType)!=this&&this._engine._setbindBuffer(this._glTargetType,this),a.bindBufferRange(this._glTarget,e,this._glBuffer,t,r),i.buffer=this._glBuffer,i.offset=t,i.size=r))}resizeBuffer(e){this.bindBuffer();const t=this._gl;this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage)}destroy(){super.destroy();const e=this._gl;g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_GPUBuffer,-1),e.deleteBuffer(this._glBuffer),this._memorychange(0),this._byteLength=0,this._engine=null,this._glBuffer=null,this._glTarget=null,this._glUsage=null,this._gl=null}}e.WebGLMode=void 0,(i=e.WebGLMode||(e.WebGLMode={}))[i.Auto=0]="Auto",i[i.WebGL2=1]="WebGL2",i[i.WebGL1=2]="WebGL1";class u{constructor(e){this._engine=e,this._gl=this._engine.gl,this._initParams()}_initParams(){const r=this._gl;this._glParamsData=new Map,this._glParamsData.set(t.RenderParams.Max_Active_Texture_Count,r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS));const a=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),i=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS);if(this._glParamsData.set(t.RenderParams.Max_Uniform_Count,Math.min(a,i)),this._glParamsData.set(t.RenderParams.MAX_Texture_Size,r.getParameter(r.MAX_TEXTURE_SIZE)),this._glParamsData.set(t.RenderParams.MAX_Texture_Image_Uint,r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS)),this._engine.getCapable(t.RenderCapable.Texture_anisotropic)){const a=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);this._glParamsData.set(t.RenderParams.Max_AnisoLevel_Count,r.getParameter(a.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}this._engine.isWebGL2?this._glParamsData.set(t.RenderParams.SHADER_CAPAILITY_LEVEL,35):this._glParamsData.set(t.RenderParams.SHADER_CAPAILITY_LEVEL,30),this._glParamsData.set(t.RenderParams.FLOAT,r.FLOAT),this._glParamsData.set(t.RenderParams.UNSIGNED_BYTE,r.UNSIGNED_BYTE),this._glParamsData.set(t.RenderParams.UNSIGNED_SHORT,r.UNSIGNED_SHORT),this._glParamsData.set(t.RenderParams.BYTE,r.BYTE)}getParams(e){return this._glParamsData.get(e)}}class d extends s{constructor(t){super(t),this._engine.isWebGL2||(this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays))}getMeshTopology(e){switch(e){case t.MeshTopology.Points:return this._gl.POINTS;case t.MeshTopology.Lines:return this._gl.LINES;case t.MeshTopology.LineLoop:return this._gl.LINE_LOOP;case t.MeshTopology.LineStrip:return this._gl.LINE_STRIP;case t.MeshTopology.Triangles:return this._gl.TRIANGLES;case t.MeshTopology.TriangleStrip:return this._gl.TRIANGLE_STRIP;case t.MeshTopology.TriangleFan:return this._gl.TRIANGLE_FAN}}getIndexType(e){switch(e){case t.IndexFormat.UInt8:return this._gl.UNSIGNED_BYTE;case t.IndexFormat.UInt16:return this._gl.UNSIGNED_SHORT;case t.IndexFormat.UInt32:return this._gl.UNSIGNED_INT}}drawElementsInstanced(e,r,a,i,s){this._engine.isWebGL2?this._gl.drawElementsInstanced(e,r,a,i,s):this._angleInstancedArrays.drawElementsInstancedANGLE(e,r,a,i,s),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_Instancing_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,r/3*s)}drawArraysInstanced(e,r,a,i){this._engine.isWebGL2?this._gl.drawArraysInstanced(e,r,a,i):this._angleInstancedArrays.drawArraysInstancedANGLE(e,r,a,i),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_Instancing_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,(a-2)*i)}drawArrays(e,r,a){this._gl.drawArrays(e,r,a),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,a-2)}drawElements(e,r,a,i){this._gl.drawElements(e,r,a,i),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,r/3)}drawElements2DTemp(e,r,a,i){e=this.getMeshTopology(e),a=this.getIndexType(a),this._gl.drawElements(e,r,a,i),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,r/3)}drawGeometryElement(e){e.bufferState.bind();let r=e.drawParams.elements,a=e.drawParams.length;switch(e.drawType){case t.DrawType.DrawArray:for(let t=0;t<a;t+=2)this.drawArrays(e._glmode,r[t],r[t+1]);break;case t.DrawType.DrawElement:for(let t=0;t<a;t+=2)this.drawElements(e._glmode,r[t+1],e._glindexFormat,r[t]);break;case t.DrawType.DrawArrayInstance:for(let t=0;t<a;t+=2)this.drawArraysInstanced(e._glmode,r[t],r[t+1],e.instanceCount);break;case t.DrawType.DrawElementInstance:for(let t=0;t<a;t+=2)this.drawElementsInstanced(e._glmode,r[t+1],e._glindexFormat,r[t],e.instanceCount)}}}class m{constructor(e){this._engine=e,this._gl=this._engine.gl}_initState(){this.setDepthFunc(t.CompareFunction.Less),this.setBlendEquationSeparate(t.BlendEquationSeparate.ADD,t.BlendEquationSeparate.ADD),this._blendEquation=t.BlendEquationSeparate.ADD,this._sFactor=t.BlendFactor.One,this._dFactor=t.BlendFactor.Zero,this._sFactorAlpha=t.BlendFactor.One,this._dFactorAlpha=t.BlendFactor.One}_getBlendFactor(e){const r=this._gl;switch(e){case t.BlendFactor.Zero:return r.ZERO;case t.BlendFactor.One:return r.ONE;case t.BlendFactor.SourceColor:return r.SRC_COLOR;case t.BlendFactor.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case t.BlendFactor.DestinationColor:return r.DST_COLOR;case t.BlendFactor.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case t.BlendFactor.SourceAlpha:return r.SRC_ALPHA;case t.BlendFactor.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case t.BlendFactor.DestinationAlpha:return r.DST_ALPHA;case t.BlendFactor.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case t.BlendFactor.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case t.BlendFactor.BlendColor:return r.CONSTANT_COLOR;case t.BlendFactor.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}}_getBlendOperation(e){const r=this._gl;switch(e){case t.BlendEquationSeparate.ADD:return r.FUNC_ADD;case t.BlendEquationSeparate.SUBTRACT:return r.FUNC_SUBTRACT;case t.BlendEquationSeparate.REVERSE_SUBTRACT:return r.FUNC_REVERSE_SUBTRACT;default:throw"Unknow type"}}_getGLCompareFunction(e){const r=this._gl;switch(e){case t.CompareFunction.Never:return r.NEVER;case t.CompareFunction.Less:return r.LESS;case t.CompareFunction.Equal:return r.EQUAL;case t.CompareFunction.LessEqual:return r.LEQUAL;case t.CompareFunction.Greater:return r.GREATER;case t.CompareFunction.NotEqual:return r.NOTEQUAL;case t.CompareFunction.GreaterEqual:return r.GEQUAL;case t.CompareFunction.Always:return r.ALWAYS;default:return r.LEQUAL}}_getGLStencilOperation(e){const r=this._gl;switch(e){case t.StencilOperation.Keep:return r.KEEP;case t.StencilOperation.Zero:return r.ZERO;case t.StencilOperation.Replace:return r.REPLACE;case t.StencilOperation.IncrementSaturate:return r.INCR;case t.StencilOperation.DecrementSaturate:return r.DECR;case t.StencilOperation.Invert:return r.INVERT;case t.StencilOperation.IncrementWrap:return r.INCR_WRAP;case t.StencilOperation.DecrementWrap:return r.DECR_WRAP}}_getGLFrontfaceFactor(e){return e==t.CullMode.Front?this._gl.CCW:this._gl.CW}setDepthTest(e){e!==this._depthTest&&(this._depthTest=e,e?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST))}setDepthMask(e){e!==this._depthMask&&(this._depthMask=e,this._gl.depthMask(e))}setDepthFunc(e){e!==this._depthFunc&&(this._depthFunc=e,this._gl.depthFunc(this._getGLCompareFunction(e)))}setStencilTest(e){e!==this._stencilTest&&(this._stencilTest=e,e?this._gl.enable(this._gl.STENCIL_TEST):this._gl.disable(this._gl.STENCIL_TEST))}setStencilMask(e){e!==this._stencilMask&&(this._stencilMask=e,e?this._gl.stencilMask(255):this._gl.stencilMask(0))}setStencilFunc(e,t){e==this._stencilFunc&&t==this._stencilRef||(this._stencilFunc=e,this._stencilRef=t,this._gl.stencilFunc(this._getGLCompareFunction(e),t,255))}setstencilOp(e,t,r){this._stencilOp_fail==e&&this._stencilOp_zfail==t&&this._stencilOp_zpass==r||(this._stencilOp_fail=e,this._stencilOp_zfail=t,this._stencilOp_zpass=r,this._gl.stencilOp(this._getGLStencilOperation(e),this._getGLStencilOperation(t),this._getGLStencilOperation(r)))}setBlend(e){e!==this._blend&&(this._blend=e,e?this._gl.enable(this._gl.BLEND):this._gl.disable(this._gl.BLEND))}setBlendEquation(e){e!==this._blendEquation&&(this._blendEquation=e,this._blendEquationRGB=this._blendEquationAlpha=null,this._gl.blendEquation(this._getBlendOperation(e)))}setBlendEquationSeparate(e,t){e===this._blendEquationRGB&&t===this._blendEquationAlpha||(this._blendEquationRGB=e,this._blendEquationAlpha=t,this._blendEquation=null,this._gl.blendEquationSeparate(this._getBlendOperation(e),this._getBlendOperation(t)))}setBlendFunc(e,t,r=!1){(r||e!==this._sFactor||t!==this._dFactor)&&(this._sFactor=e,this._dFactor=t,this._sFactorRGB=null,this._dFactorRGB=null,this._sFactorAlpha=null,this._dFactorAlpha=null,this._gl.blendFunc(this._getBlendFactor(e),this._getBlendFactor(t)))}setBlendFuncSeperate(e,t,r,a){e===this._sFactorRGB&&t===this._dFactorRGB&&r===this._sFactorAlpha&&a===this._dFactorAlpha||(this._sFactorRGB=e,this._dFactorRGB=t,this._sFactorAlpha=r,this._dFactorAlpha=a,this._sFactor=null,this._dFactor=null,this._gl.blendFuncSeparate(this._getBlendFactor(e),this._getBlendFactor(t),this._getBlendFactor(r),this._getBlendFactor(a)))}setCullFace(e){e!==this._cullFace&&(this._cullFace=e,e?this._gl.enable(this._gl.CULL_FACE):this._gl.disable(this._gl.CULL_FACE))}setFrontFace(e){e!==this._frontFace&&(this._frontFace=e,this._gl.frontFace(this._getGLFrontfaceFactor(e)))}}class c extends s{constructor(e,t,r,a){super(e),this._vs=t,this._ps=r,this._attributeMap=a,this._uniformMap=[],this._create()}_create(){g._lastShaderError=null,g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_ShaderCompile,1);let e=performance.now();const r=this._gl;if(g.instance.lost)return;let a,i=this._program=r.createProgram();if(this._vshader=this._createShader(r,this._vs,r.VERTEX_SHADER),r.getShaderParameter(this._vshader,r.COMPILE_STATUS)||(a=r.getShaderInfoLog(this._vshader)),this._pshader=this._createShader(r,this._ps,r.FRAGMENT_SHADER),r.getShaderParameter(this._pshader,r.COMPILE_STATUS)||(a&&(a+="\n"),a+=r.getShaderInfoLog(this._pshader)),r.attachShader(i,this._vshader),r.attachShader(i,this._pshader),a)return void(g._lastShaderError=a);for(var s in this._attributeMap)r.bindAttribLocation(i,this._attributeMap[s][0],s);if(r.linkProgram(i),!r.getProgramParameter(i,r.LINK_STATUS))return void(g._lastShaderError=r.getProgramInfoLog(i));const n=r.getProgramParameter(i,r.ACTIVE_UNIFORMS);let _,o;for(this.useProgram(),this._curActTexIndex=0,o=0;o<n;o++){var l=r.getActiveUniform(i,o),h=l.name;let e=r.getUniformLocation(i,h);(e||0==e)&&(_=new t.ShaderVariable,_.location=e,h.indexOf("[0]")>0?(_.name=h=h.substr(0,h.length-3),_.isArray=!0):(_.name=h,_.isArray=!1),_.type=l.type,this._addShaderUnifiormFun(_),this._uniformMap.push(_),_.dataOffset=this._engine.propertyNameToID(h))}if(this._engine.isWebGL2){const e=r;this._uniformObjectMap={};var u=r.getProgramParameter(i,r.ACTIVE_UNIFORM_BLOCKS);for(o=0;o<u;o++){var d=e.getActiveUniformBlockName(this._program,o);_=new t.ShaderVariable,_.name=d,_.isArray=!1,_.type=r.UNIFORM_BUFFER,_.dataOffset=this._engine.propertyNameToID(d);let a=_.location=e.getUniformBlockIndex(i,d),s=o;e.uniformBlockBinding(this._program,a,s),this._uniformObjectMap[_.name]=_,this._uniformMap.push(_),this._addShaderUnifiormFun(_)}}g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.T_ShaderCompile,performance.now()-e|0),this._complete=!0}_createShader(e,t,r){let a=e.createShader(r);return e.shaderSource(a,t),e.compileShader(a),a}_addShaderUnifiormFun(e){var t=this._gl;e.caller=this;var r=e.isArray;switch(e.type){case t.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case t.INT:e.fun=r?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case t.FLOAT:e.fun=r?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case t.FLOAT_VEC2:e.fun=r?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case t.FLOAT_VEC3:e.fun=r?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case t.FLOAT_VEC4:e.fun=r?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case t.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case t.FLOAT_MAT3:e.fun=r?this._uniformMatrix3fv:this._uniformMatrix3f;break;case t.FLOAT_MAT4:e.fun=r?this._uniformMatrix4fv:this._uniformMatrix4f;break;case t.SAMPLER_2D:case t.SAMPLER_2D_SHADOW:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case t.SAMPLER_2D_ARRAY:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2DArray;break;case 35679:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case t.SAMPLER_CUBE:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;case t.UNIFORM_BUFFER:e.fun=this._uniform_UniformBuffer;break;default:g._lastShaderError=`unknown uniform type (${e.type})`}}getUniformMap(){return this._uniformMap}bind(){return this.useProgram()}useProgram(){return this._engine._glUseProgram!==this&&(this._gl.useProgram(this._program),this._engine._glUseProgram=this,g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_SetRenderPassCount,1),!0)}_uniform1f(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1f(e.location,r[0]=t),1):0}_uniform1fv(e,t){if(t.length<4){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform1fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform1fv(e.location,t),1}_uniform_vec2(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y?(this._gl.uniform2f(e.location,r[0]=t.x,r[1]=t.y),1):0}_uniform_vec2v(e,t){if(t.length<2){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform2fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform2fv(e.location,t),1}_uniform_vec3(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z?(this._gl.uniform3f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z),1):0}_uniform_vec3v(e,t){return this._gl.uniform3fv(e.location,t),1}_uniform_vec4(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z||r[3]!==t.w?(this._gl.uniform4f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w),1):0}_uniform_vec4v(e,t){return this._gl.uniform4fv(e.location,t),1}_uniformMatrix2fv(e,t){return this._gl.uniformMatrix2fv(e.location,!1,t),1}_uniformMatrix3f(e,t){return this._gl.uniformMatrix3fv(e.location,!1,t.elements),1}_uniformMatrix3fv(e,t){return this._gl.uniformMatrix3fv(e.location,!1,t),1}_uniformMatrix4f(e,t){var r=t.elements;return this._gl.uniformMatrix4fv(e.location,!1,r),1}_uniformMatrix4fv(e,t){return this._gl.uniformMatrix4fv(e.location,!1,t),1}_uniform1i(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1i(e.location,r[0]=t),1):0}_uniform1iv(e,t){return this._gl.uniform1iv(e.location,t),1}_uniform_ivec2(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]?(this._gl.uniform2i(e.location,r[0]=t[0],r[1]=t[1]),1):0}_uniform_ivec2v(e,t){return this._gl.uniform2iv(e.location,t),1}_uniform_vec3i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]?(this._gl.uniform3i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2]),1):0}_uniform_vec3vi(e,t){return this._gl.uniform3iv(e.location,t),1}_uniform_vec4i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform4i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]),1):0}_uniform_vec4vi(e,t){return this._gl.uniform4iv(e.location,t),1}_uniform_sampler2D(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D,a),0}_uniform_sampler2DArray(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D_ARRAY,a),0}_uniform_sampler3D(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_3D,a),0}_uniform_samplerCube(e,r){var a=r?r._getSource():t.TextureCube.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_CUBE_MAP,a),0}_uniform_UniformBuffer(e,t){t.bind(e.location)}_bindTexture(e,t,r){const a=this._gl;this._engine._activedTextureID!==e&&(a.activeTexture(e),this._engine._activedTextureID=e);const i=this._engine._activedTextureID-this._gl.TEXTURE0;this._engine._activeTextures[i]!==r&&(a.bindTexture(t,r),this._engine._activeTextures[i]=r)}destroy(){super.destroy();const e=this._gl;e.deleteShader(this._vshader),e.deleteShader(this._pshader),e.deleteProgram(this._program),this._vshader=null,this._pshader=null,this._program=null,this._attributeMap=null,this._uniformMap=null,this._uniformObjectMap=null,this._gl=null,this._engine=null}}class f extends s{constructor(t){super(t),this._vertexDeclaration=[],t.isWebGL2||(this._vaoExt=t._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object)),this._vao=this.createVertexArray(),this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays)}createVertexArray(){return this._engine.isWebGL2?this._gl.createVertexArray():this._vaoExt.createVertexArrayOES()}deleteVertexArray(){this._engine.isWebGL2?this._gl.deleteVertexArray(this._vao):this._vaoExt.deleteVertexArrayOES(this._vao)}bindVertexArray(){this._engine._GLBindVertexArray!=this&&(this._engine.isWebGL2?this._gl.bindVertexArray(this._vao):this._vaoExt.bindVertexArrayOES(this._vao),this._engine._GLBindVertexArray=this)}unbindVertexArray(){this._engine.isWebGL2?this._gl.bindVertexArray(null):this._vaoExt.bindVertexArrayOES(null),this._engine._GLBindVertexArray=null}isVertexArray(){this._engine.isWebGL2?this._gl.isVertexArray(this._vao):this._vaoExt.isVertexArrayOES(this._vao)}applyVertexBuffer(e){if(this.clearVAO(),this._vertexBuffers=e,this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._vertexDeclaration.length=e.length;var t=0;e.forEach((e=>{var r=e._shaderValues;for(var a in this._vertexDeclaration[t++]=e._shaderValues,e.bind(),r){var i=parseInt(a),s=r[a];this._gl.enableVertexAttribArray(i),this._gl.vertexAttribPointer(i,s.elementCount,s.elementType,!!s.normalized,s.vertexStride,s.elementOffset),e.instanceBuffer&&this.vertexAttribDivisor(i,1)}}))}clearVAO(){for(let a=0,i=this._vertexDeclaration.length;a<i;a++){var e=this._vertexDeclaration[a];for(var t in e){var r=parseInt(t);this._gl.disableVertexAttribArray(r)}}}applyIndexBuffer(e){if(null!=e){if(this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e._glBuffer.bindBuffer(),this._bindedIndexBuffer=e)}}vertexAttribDivisor(e,t){this._engine.isWebGL2?this._gl.vertexAttribDivisor(e,t):this._angleInstancedArrays.vertexAttribDivisorANGLE(e,t)}destroy(){super.destroy(),this._gl,this.deleteVertexArray(),this._gl=null,this._engine=null}}!function(){var e={};function t(t,r){var a;e[t]=!0,void 0!==r&&(a=r,window.console&&window.console.error&&window.console.error(a))}var r=function e(t){var r=t.gl;this.ext=t,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(t.maxVertexAttribs);for(var a=0;a<this.attribs.length;a++){var i=new e.VertexAttrib(r);this.attribs[a]=i}this.maxAttrib=0};(r.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var a=function(t){var r=this;this.gl=t,function(t){var r=t.getError;t.getError=function(){var a;do{(a=r.apply(t))!=t.NO_ERROR&&(e[a]=!0)}while(a!=t.NO_ERROR);for(var i in e)if(e[i])return delete e[i],parseInt(i);return t.NO_ERROR}}(t);var a=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(e){return e==r.VERTEX_ARRAY_BINDING_OES?r.currentVertexArrayObject==r.defaultVertexArrayObject?null:r.currentVertexArrayObject:a.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!0,a.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!1,a.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(e,i){switch(e){case t.ARRAY_BUFFER:r.currentArrayBuffer=i;break;case t.ELEMENT_ARRAY_BUFFER:r.currentVertexArrayObject.elementArrayBuffer=i}return a.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(e,i){var s=r.currentVertexArrayObject.attribs[e];switch(i){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return s.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return s.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return s.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return s.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return s.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return s.normalized;default:return a.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(e,t,i,s,n,_){var o=r.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,e);var l=o.attribs[e];return l.buffer=r.currentArrayBuffer,l.size=t,l.type=i,l.normalized=s,l.stride=n,l.offset=_,l.recache(),a.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",(function(){var e;e="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(e),r.reset_()}),!0),this.reset_()};a.prototype.VERTEX_ARRAY_BINDING_OES=34229,a.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var t=this.gl;this.maxVertexAttribs=t.getParameter(t.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new r(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},a.prototype.createVertexArrayOES=function(){var e=new r(this);return this.vertexArrayObjects.push(e),e},a.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},a.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof r&&e.hasBeenBound&&e.ext==this)},a.prototype.bindVertexArrayOES=function(e){var r=this.gl;if(!e||e.isAlive){var a=this.original,i=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var s=this.currentVertexArrayObject;if(i!=s){i&&s.elementArrayBuffer==i.elementArrayBuffer||a.bindBuffer.call(r,r.ELEMENT_ARRAY_BUFFER,s.elementArrayBuffer);for(var n=this.currentArrayBuffer,_=Math.max(i?i.maxAttrib:0,s.maxAttrib),o=0;o<=_;o++){var l=s.attribs[o],h=i?i.attribs[o]:null;if(i&&l.enabled==h.enabled||(l.enabled?a.enableVertexAttribArray.call(r,o):a.disableVertexAttribArray.call(r,o)),l.enabled){var u=!1;i&&l.buffer==h.buffer||(n!=l.buffer&&(a.bindBuffer.call(r,r.ARRAY_BUFFER,l.buffer),n=l.buffer),u=!0),(u||l.cached!=h.cached)&&a.vertexAttribPointer.call(r,o,l.size,l.type,l.normalized,l.stride,l.offset)}}this.currentArrayBuffer!=n&&a.bindBuffer.call(r,r.ARRAY_BUFFER,this.currentArrayBuffer)}}else t(r.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},window._setupVertexArrayObject=function(e){var t=e.getSupportedExtensions;e.getSupportedExtensions=function(){var e=t.call(this)||[];return e.indexOf("OES_vertex_array_object")<0&&e.push("OES_vertex_array_object"),e};var r=e.getExtension;e.getExtension=function(e){var t=r.call(this,e);return t||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new a(this)),this.__OESVertexArrayObject))}}}();class E{constructor(e){this._extentionVendorPrefixes=["","WEBKIT_","MOZ_"],this._gl=e.gl,this.initExtension(e.isWebGL2),this.initCapable(e.isWebGL2)}initCapable(r){this._capabilityMap=new Map;let a=r||!!this.getExtension(e.WebGLExtension.OES_element_index_uint);this._capabilityMap.set(t.RenderCapable.Element_Index_Uint32,a),this._capabilityMap.set(t.RenderCapable.Element_Index_Uint8,!0),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_float),this._capabilityMap.set(t.RenderCapable.TextureFormat_R32G32B32A32,a),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_half_float),this._capabilityMap.set(t.RenderCapable.TextureFormat_R16G16B16A16,a),a=!!this.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic),this._capabilityMap.set(t.RenderCapable.Texture_anisotropic,a),a=r?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)||!!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float):!(!this.getExtension(e.WebGLExtension.OES_texture_half_float)&&!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float)||!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear)),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_R16G16B16A16,a),a=r?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear):!!this.getExtension(e.WebGLExtension.OES_texture_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_R32G32B32A32,a),a=r||!!this.getExtension(e.WebGLExtension.WEBGL_depth_texture),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_Depth,a),a=r,this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_ShadowMap,a),a=r||!!this.getExtension(e.WebGLExtension.OES_vertex_array_object),this._capabilityMap.set(t.RenderCapable.Vertex_VAO,a),a=r||!!this.getExtension(e.WebGLExtension.ANGLE_instanced_arrays),this._capabilityMap.set(t.RenderCapable.DrawElement_Instance,a),a=r||!!this.getExtension(e.WebGLExtension.EXT_shader_texture_lod),this._capabilityMap.set(t.RenderCapable.Shader_TextureLod,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_S3TC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_pvrtc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_PVRTC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ETC1,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ETC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ASTC,a),a=r||!!this.getExtension(e.WebGLExtension.EXT_sRGB),this._capabilityMap.set(t.RenderCapable.Texture_SRGB,a),a=!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(t.RenderCapable.Texture_FloatLinearFiltering,a),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear),this._capabilityMap.set(t.RenderCapable.Texture_HalfFloatLinearFiltering,a),a=r,this._capabilityMap.set(t.RenderCapable.MSAA,a),this._capabilityMap.set(t.RenderCapable.UnifromBufferObject,a),this._capabilityMap.set(t.RenderCapable.Texture3D,a)}initExtension(t){this._extensionMap=new Map;const r=(e,t,r)=>{t&&r.set(e,t)},a=this._getExtension("EXT_texture_filter_anisotropic");r(e.WebGLExtension.EXT_texture_filter_anisotropic,a,this._extensionMap);const i=this._getExtension("WEBGL_compressed_texture_s3tc");r(e.WebGLExtension.WEBGL_compressed_texture_s3tc,i,this._extensionMap);const s=this._getExtension("WEBGL_compressed_texture_s3tc_srgb");r(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb,s,this._extensionMap);const n=this._getExtension("WEBGL_compressed_texture_pvrtc");r(e.WebGLExtension.WEBGL_compressed_texture_pvrtc,n,this._extensionMap);const _=this._getExtension("WEBGL_compressed_texture_etc1");r(e.WebGLExtension.WEBGL_compressed_texture_etc1,_,this._extensionMap);const o=this._getExtension("WEBGL_compressed_texture_etc");r(e.WebGLExtension.WEBGL_compressed_texture_etc,o,this._extensionMap);const l=this._getExtension("WEBGL_compressed_texture_astc");r(e.WebGLExtension.WEBGL_compressed_texture_astc,l,this._extensionMap);const h=this._getExtension("OES_texture_float_linear");r(e.WebGLExtension.OES_texture_float_linear,h,this._extensionMap);const u=this._getExtension("EXT_color_buffer_half_float");if(r(e.WebGLExtension.EXT_color_buffer_half_float,u,this._extensionMap),t){const t=this._getExtension("EXT_color_buffer_float");r(e.WebGLExtension.EXT_color_buffer_float,t,this._extensionMap)}else{window._setupVertexArrayObject&&window._setupVertexArrayObject(this._gl);const t=this._getExtension("OES_vertex_array_object");r(e.WebGLExtension.OES_vertex_array_object,t,this._extensionMap);const a=this._getExtension("ANGLE_instanced_arrays");r(e.WebGLExtension.ANGLE_instanced_arrays,a,this._extensionMap);const i=this._getExtension("OES_texture_half_float");r(e.WebGLExtension.OES_texture_half_float,i,this._extensionMap);const s=this._getExtension("OES_texture_half_float_linear");r(e.WebGLExtension.OES_texture_half_float_linear,s,this._extensionMap);const n=this._getExtension("OES_texture_float");r(e.WebGLExtension.OES_texture_float,n,this._extensionMap);const _=this._getExtension("OES_element_index_uint");r(e.WebGLExtension.OES_element_index_uint,_,this._extensionMap);const o=this._getExtension("EXT_shader_texture_lod");r(e.WebGLExtension.EXT_shader_texture_lod,o,this._extensionMap);const l=this._getExtension("WEBGL_depth_texture");r(e.WebGLExtension.WEBGL_depth_texture,l,this._extensionMap);const h=this._getExtension("EXT_sRGB");r(e.WebGLExtension.EXT_sRGB,h,this._extensionMap);const u=this._getExtension("OES_standard_derivatives");r(e.WebGLExtension.OES_standard_derivatives,u,this._extensionMap)}}getCapable(e){return this._capabilityMap.get(e)}getExtension(e){return this._extensionMap.has(e)?this._extensionMap.get(e):null}_getExtension(e){const t=this._extentionVendorPrefixes;for(const a in t){var r=this._gl.getExtension(t[a]+e);if(r)return r}return null}}class T extends t.UniformBufferManager{constructor(e,t){super(!0),this.engine=e,this.byteAlign=t,e.on("endFrame",this,this.endFrame),e.on("startFrame",this,this.startFrame)}createGPUBuffer(e,r){let a=this.engine.createBuffer(t.BufferTargetType.UNIFORM_BUFFER,t.BufferUsage.Dynamic);return a.bindBuffer(),a.setDataLength(e),a}writeBuffer(e,t,r,a){e.bindBuffer(),this.engine.gl.bufferSubData(e._glTarget,r,new Float32Array(t,r,a/4))}statisGPUMemory(e){this.engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory,e),this.engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUBuffer,e)}statisUpload(e,r){this.engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_UniformBufferUploadCount,e)}}class g extends t.EventDispatcher{get lost(){return this._lost}constructor(r,a=e.WebGLMode.Auto){super(),this._lost=!1,this._propertyNameMap={},this._propertyNameCounter=0,this._IDCounter=0,this._isShaderDebugMode=!0,this._enableStatistics=!1,this._lastClearColor=new t.Color,this._lastClearDepth=-1,this._remapZ=!0,this._screenInvertY=!1,this._lodTextureSample=!0,this._breakTextureSample=!0,this._GLStatisticsInfo=new Map,this._config=r,this._isWebGL2=!1,this._lastViewport=new t.Vector4(0,0,0,0),this._lastClearColor=new t.Color(0,0,0,0),this._lastScissor=new t.Vector4(0,0,0,0),this._webglMode=a,this._initStatisticsInfo(),g.instance=this}startFrame(){this.event("startFrame",null)}endFrame(){this.event("endFrame",null)}getInnerWidth(){return t.LayaEnv.isConch?window.getInnerWidth():this._globalWidth}getInnerHeight(){return t.LayaEnv.isConch?window.getInnerHeight():this._globalHeight}resizeOffScreen(e,r){this._globalWidth=e,this._globalHeight=r,t.LayaEnv.isConch&&(g._lastFrameBuffer&&(g._lastFrameBuffer.dispose(),g._lastFrameBuffer_WebGLOBJ=null),g._lastFrameBuffer=this.getTextureContext().createRenderTargetInternal(e,r,t.RenderTargetFormat.R8G8B8A8,t.RenderTargetFormat.None,!1,!1,1),g._lastFrameBuffer_WebGLOBJ=g._lastFrameBuffer._framebuffer)}addTexGammaDefine(e,t){g._texGammaDefine[e]=t}get gl(){return this._context}get isWebGL2(){return this._isWebGL2}get webglConfig(){return this._config}_initStatisticsInfo(){for(var e=0;e<t.GPUEngineStatisticsInfo.Count;e++)this._GLStatisticsInfo.set(e,0)}_addStatisticsInfo(e,t){this._enableStatistics&&this._GLStatisticsInfo.set(e,this._GLStatisticsInfo.get(e)+t)}clearStatisticsInfo(){if(this._enableStatistics)for(var e=0;e<t.GPUEngineStatisticsInfo.FrameClearCount;e++)this._GLStatisticsInfo.set(e,0)}getStatisticsInfo(e){return this._GLStatisticsInfo.get(e)}initRenderEngine(r){let a,i;switch(this._webglMode){case e.WebGLMode.Auto:a=["webgl2","experimental-webgl2","webgl","experimental-webgl"];break;case e.WebGLMode.WebGL1:a=["webgl","experimental-webgl"];break;case e.WebGLMode.WebGL2:a=["webgl2","experimental-webgl2"]}for(var s=0;s<a.length;s++){try{i=r.getContext(a[s],this._config)}catch(e){}if(i){"webgl2"!==a[s]&&"experimental-webgl2"!==a[s]||(this._isWebGL2=!0);break}}this._context=i,this.scissorTest(!0),this._initBindBufferMap(),this._supportCapatable=new E(this),this._GLParams=new u(this),this._GLRenderState=new m(this),this._glTextureIDParams=[i.TEXTURE0,i.TEXTURE1,i.TEXTURE2,i.TEXTURE3,i.TEXTURE4,i.TEXTURE5,i.TEXTURE6,i.TEXTURE7,i.TEXTURE8,i.TEXTURE9,i.TEXTURE10,i.TEXTURE11,i.TEXTURE12,i.TEXTURE13,i.TEXTURE14,i.TEXTURE15,i.TEXTURE16,i.TEXTURE17,i.TEXTURE18,i.TEXTURE19,i.TEXTURE20,i.TEXTURE21,i.TEXTURE22,i.TEXTURE23,i.TEXTURE24,i.TEXTURE25,i.TEXTURE26,i.TEXTURE27,i.TEXTURE28,i.TEXTURE29,i.TEXTURE30,i.TEXTURE31],this._activedTextureID=i.TEXTURE0,this._activeTextures=[],this._GLTextureContext=this.isWebGL2?new l(this):new o(this),this._GLRenderDrawContext=new d(this),r.addEventListener("webglcontextlost",this.webglContextLost),t.Config._uniformBlock=t.Config.enableUniformBufferObject&&this.getCapable(t.RenderCapable.UnifromBufferObject),t.Config.matUseUBO=t.Config.matUseUBO&&this.getCapable(t.RenderCapable.UnifromBufferObject),this._initBufferBlock()}_initBufferBlock(){if(t.Config._uniformBlock||t.Config.matUseUBO){const e=this._context;let t=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT);this.bufferMgr=new T(this,t);let r=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);this._uboBindingMap=new Array(r);for(let e=0;e<r;e++)this._uboBindingMap[e]={buffer:null,offset:0,size:0}}}webglContextLost(e){console.log("lost webgl context"),t.Laya.stage.event("GraphicContextLost",e),this._lost=!0}_initBindBufferMap(){this._GLBufferBindMap={},this._GLBufferBindMap[t.BufferTargetType.ARRAY_BUFFER]=null,this._GLBufferBindMap[t.BufferTargetType.ELEMENT_ARRAY_BUFFER]=null,this._GLBufferBindMap[t.BufferTargetType.UNIFORM_BUFFER]=null}_getbindBuffer(e){return this._GLBufferBindMap[e]}_setbindBuffer(e,t){this._GLBufferBindMap[e]=t}_bindTexture(e,t){const r=this._activedTextureID-this._context.TEXTURE0;this._activeTextures[r]!==t&&(this._context.bindTexture(e,t),this._activeTextures[r]=t)}getCapable(e){return this._supportCapatable.getCapable(e)}viewport(e,r,a,i){const s=this._context,n=this._lastViewport;t.LayaEnv.isConch?s.viewport(e,r,a,i):e===n.x&&r===n.y&&a===n.z&&i===n.w||(s.viewport(e,r,a,i),n.setValue(e,r,a,i))}scissor(e,r,a,i){const s=this._context,n=this._lastScissor;t.LayaEnv.isConch?s.scissor(e,r,a,i):e===n.x&&r===n.y&&a===n.z&&i===n.w||(s.scissor(e,r,a,i),n.setValue(e,r,a,i))}scissorTest(e){this._scissorState!=e&&(this._scissorState=e,e?this._context.enable(this._context.SCISSOR_TEST):this._context.disable(this._context.SCISSOR_TEST))}clearRenderTexture(e,r=null,a=1,i=0){var s;e&t.RenderClearFlag.Color&&(r&&!this._lastClearColor.equal(r)&&(this._context.clearColor(r.r,r.g,r.b,r.a),r.cloneTo(this._lastClearColor)),s|=this.gl.COLOR_BUFFER_BIT),e&t.RenderClearFlag.Depth&&(this._lastClearDepth!=a&&(this._context.clearDepth(a),this._lastClearDepth=a),this._GLRenderState.setDepthMask(!0),s|=this._context.DEPTH_BUFFER_BIT),e&t.RenderClearFlag.Stencil&&(this._context.clearStencil(i),this._GLRenderState.setStencilMask(!0),s|=this._context.STENCIL_BUFFER_BIT),s&&this._context.clear(s)}copySubFrameBuffertoTex(e,t,r,a,i,s,n,_){this._bindTexture(e.target,e.resource),this._context.copyTexSubImage2D(e.target,t,r,a,i,s,n,_)}colorMask(e,t,r,a){this._context.colorMask(e,t,r,a)}getParams(e){return this._GLParams.getParams(e)}createBuffer(e,t){return new h(this,e,t)}createShaderInstance(e,t,r){return new c(this,e,t,r)}createVertexState(){return new f(this)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}getCreateRenderOBJContext(){return this._renderOBJCreateContext}propertyNameToID(e){if(null!=this._propertyNameMap[e])return this._propertyNameMap[e];var t=this._propertyNameCounter++;return this._propertyNameMap[e]=t,this._propertyNameMap[t]=e,t}propertyIDToName(e){return this._propertyNameMap[e]}getNamesByDefineData(e,t){var r=g._maskMap,a=e._mask;t.length=0;for(var i=0,s=e._length;i<s;i++)for(var n=r[i],_=a[i],o=0;o<32;o++){var l=1<<o;if(_>0&&l>_)break;_&l&&t.push(n[l])}}getDefineByName(e){var r=g._defineMap[e];if(!r){var a=g._maskMap,i=g._defineCounter,s=Math.floor(i/32),n=1<<i%32;r=new t.ShaderDefine(s,n),g._defineMap[e]=r,s==a.length&&(a.length++,a[s]={}),a[s][n]=e,g._defineCounter++}return r}uploadUniforms(e,t,r,a){for(var i=r._data,s=t.getArrayData(),n=0,_=0,o=s.length;_<o;_++){var l=s[_];if(a||-1!==l.textureID){var h=i[l.dataOffset];null!=h&&(n+=l.fun.call(l.caller,l,h))}}return n}uploadCustomUniforms(e,t,r,a){e.bind();var i=0,s=t[r];return s&&null!=a&&(i+=s.fun.call(s.caller,s,a)),i}unbindVertexState(){this.isWebGL2?this._context.bindVertexArray(null):this._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object).bindVertexArrayOES(null),this._GLBindVertexArray=null}}g._texGammaDefine={},g._lastFrameBuffer=null,g._lastFrameBuffer_WebGLOBJ=null,g._defineMap={},g._defineCounter=0,g._maskMap=[];class p{setInt(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t,this.needUpload=!0)}setFloat(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t,this.needUpload=!0)}setVector2(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,this.needUpload=!0)}setVector3(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,r.view[2]=t.z,this.needUpload=!0)}setVector4(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,r.view[2]=t.z,r.view[3]=t.w,this.needUpload=!0)}setMatrix3x3(e,t){let r=this.descriptor.uniforms.get(e);if(r){let e=t.elements;for(let t=0;t<3;t++)for(let a=0;a<3;a++)r.view[4*t+a]=e[3*t+a];this.needUpload=!0}}setMatrix4x4(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view.set(t.elements),this.needUpload=!0)}setBuffer(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view.set(t),this.needUpload=!0)}setArrayBuffer(e,t){let r=this.descriptor.uniforms.get(e);if(r){let e=r.arrayLength,a=r.size,i=r.alignStride;for(let s=0;s<e;s++)r.view.set(t.subarray(s*a,(s+1)*a),s*i);this.needUpload=!0}}setMatrix3x3Array(e,t){let r=this.descriptor.uniforms.get(e);if(r){let e=r.arrayLength;r.size;let a=r.alignStride;for(let i=0;i<e;i++)for(let e=0;e<3;e++)for(let s=0;s<3;s++)r.view[i*a+4*e+s]=t[9*i+3*e+s];this.needUpload=!0}}setUniformData(e,r,a){let i=this.descriptor.uniforms.get(e);if(i)switch(r){case t.ShaderDataType.Bool:console.warn("ShaderDataType.Bool not support");break;case t.ShaderDataType.Int:i.arrayLength>0?this.setArrayBuffer(e,a):this.setInt(e,a);break;case t.ShaderDataType.Float:i.arrayLength>0?this.setArrayBuffer(e,a):this.setFloat(e,a);break;case t.ShaderDataType.Vector2:i.arrayLength>0?this.setArrayBuffer(e,a):this.setVector2(e,a);break;case t.ShaderDataType.Vector3:i.arrayLength>0?this.setArrayBuffer(e,a):this.setVector3(e,a);break;case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:i.arrayLength>0?this.setArrayBuffer(e,a):this.setVector4(e,a);break;case t.ShaderDataType.Matrix3x3:i.arrayLength>0?this.setMatrix3x3Array(e,a):this.setMatrix3x3(e,a);break;case t.ShaderDataType.Matrix4x4:i.arrayLength>0?this.setArrayBuffer(e,a):this.setMatrix4x4(e,a);case t.ShaderDataType.Buffer:case t.ShaderDataType.None:case t.ShaderDataType.Texture2D:case t.ShaderDataType.Texture3D:case t.ShaderDataType.TextureCube:case t.ShaderDataType.Texture2DArray:}}}class x{get byteLength(){return this._byteLength}constructor(e){this._currentLength=0,this._byteLength=0,this._maxAlignment=4,this.name=e,this.uniforms=new Map}alignmentPadding(e){let t=this._currentLength%e;0!=t&&(t=e-t,this._currentLength+=t,this._byteLength+=4*t),this._maxAlignment=Math.max(this._maxAlignment,e)}addUniformItem(e,t,r,a,i){if(a>0){this.alignmentPadding(4);let s,n=a*r,_={index:e,view:s,size:t,alignStride:r,offset:4*this._currentLength,dataView:i,viewByteLength:i.BYTES_PER_ELEMENT*n,arrayLength:a};this.uniforms.set(e,_),this._currentLength+=n,this._byteLength+=_.viewByteLength}else{let a;this.alignmentPadding(t<=2?t:4);let s={index:e,view:a,size:t,alignStride:r,offset:4*this._currentLength,dataView:i,viewByteLength:i.BYTES_PER_ELEMENT*r,arrayLength:0};this.uniforms.set(e,s),this._currentLength+=t,this._byteLength+=t*i.BYTES_PER_ELEMENT}}addUniform(e,r,a=0){let i=0;switch(r){case t.ShaderDataType.Int:case t.ShaderDataType.Bool:i=4,this.addUniformItem(e,1,i,a,Int32Array);break;case t.ShaderDataType.Float:i=4,this.addUniformItem(e,1,i,a,Float32Array);break;case t.ShaderDataType.Vector2:i=4,this.addUniformItem(e,2,i,a,Float32Array);break;case t.ShaderDataType.Vector3:i=4,this.addUniformItem(e,3,i,a,Float32Array);break;case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:i=4,this.addUniformItem(e,4,i,a,Float32Array);break;case t.ShaderDataType.Matrix3x3:i=12,this.addUniformItem(e,12,i,a,Float32Array);break;case t.ShaderDataType.Matrix4x4:i=16,this.addUniformItem(e,16,i,a,Float32Array);break;case t.ShaderDataType.Buffer:console.log("ShaderDataType.Buffer not support");case t.ShaderDataType.Texture2D:case t.ShaderDataType.Texture3D:case t.ShaderDataType.TextureCube:case t.ShaderDataType.Texture2DArray:case t.ShaderDataType.None:}}finish(e=0){e=e>this._maxAlignment?e:this._maxAlignment,this._maxAlignment=e,this.alignmentPadding(e)}clone(){let e=new x(this.name);return this.cloneTo(e),e}cloneTo(e){this.uniforms.forEach((t=>{e.addUniformItem(t.index,t.size,t.alignStride,t.arrayLength,t.dataView)})),e.finish(this._maxAlignment)}destroy(){this.uniforms.clear()}}class R extends p{constructor(e){super(),this.name=e,this.descriptor=new x(e)}create(){let e=this.descriptor;e.finish();const r=new Uint8Array(e.byteLength).buffer;this._data=new Float32Array(r),e.uniforms.forEach((e=>{e.view=new e.dataView(r,e.offset,e.viewByteLength/e.dataView.BYTES_PER_ELEMENT)})),this._buffer=t.LayaGL.renderEngine.createBuffer(t.BufferTargetType.UNIFORM_BUFFER,t.BufferUsage.Dynamic),this._buffer.bindBuffer(),this._buffer.setDataLength(e.byteLength),this.needUpload=!0}addUniform(e,t,r=0){this.descriptor.addUniform(e,t,r)}upload(){this.needUpload&&(this._buffer.setData(this._data,0),this.needUpload=!1)}bind(e){this._buffer.bindBufferBase(e)}clone(){let e=new R(this.name);return this.cloneTo(e),e}cloneTo(e){this.descriptor.cloneTo(e.descriptor),e.create(),e._data.set(this._data)}destroy(){this._data=null,this._buffer.destroy(),this.descriptor.destroy(),this.descriptor=null}}class S extends p{upload(){}bind(e){this.bufferBlock.cluster.buffer.bindBufferRange(e,this.bufferBlock.offset,this.bufferBlock.size)}constructor(e,t,r,a){super(),this.name=e,this.manager=r,this.data=a,this.uniformMap=t;let i=new x(e);t.forEach((e=>{i.addUniform(e.id,e.uniformtype,e.arrayLength)})),i.finish(this.manager.byteAlign/4);let s=i.byteLength;this.descriptor=i,this.size=s,this.bufferBlock=r.getBlock(s,this),this.needUpload=!0}updateOver(){this.needUpload=!1}clearGPUBufferBind(){}notifyGPUBufferChange(){this.offset=this.bufferBlock.offset,this.needUpload=!0,this.descriptor.uniforms.forEach((e=>{let t=e.viewByteLength/e.dataView.BYTES_PER_ELEMENT,r=e.offset+this.bufferBlock.offset;e.view=new e.dataView(this.bufferBlock.cluster.data,r,t)})),this.needUpload=!0}destroy(){this.name=null,this.data=null,this.uniformMap=null,this.descriptor.destroy(),this.descriptor=null,this.manager.freeBlock(this.bufferBlock)}}class A extends t.ShaderData{constructor(e=null){super(e),this._data=null,this._defineDatas=new r,this._needCacheData=!1,this._updateCacheArray=null,this._initData()}_initData(){this._data={},this._updateCacheArray={},this._gammaColorMap=new Map,this._uniformBuffers=new Map,this._subUniformBuffers=new Map,this._uniformBuffersPropertyMap=new Map}createUniformBuffer(e,r){if(!t.Config._uniformBlock||this._uniformBuffers.has(e))return;this._needCacheData=!0;let a=new R(e),i=r._idata;i.forEach((e=>{a.addUniform(e.id,e.uniformtype,e.arrayLength)})),a.create(),this._uniformBuffers.set(e,a);let s=t.Shader3D.propertyNameToID(e);this._data[s]=a,i.forEach((e=>{let t=e.id,r=this._data[t];null!=r&&a.setUniformData(t,e.uniformtype,r),this._uniformBuffersPropertyMap.set(t,a)}))}updateUBOBuffer(e){if(!t.Config._uniformBlock)return;let r=this._uniformBuffers.get(e);for(var a in this._updateCacheArray){let e=parseInt(a),t=this._uniformBuffersPropertyMap.get(e);t&&this._updateCacheArray[a].call(t,e,this._data[e])}this._updateCacheArray={},r.needUpload&&r.upload()}createSubUniformBuffer(e,r){let a=this._subUniformBuffers.get(e);if(a){if(this._subUboBufferNumber<2){for(var i in this._updateCacheArray){let e=parseInt(i),t=this._uniformBuffersPropertyMap.get(e);t&&this._updateCacheArray[i].call(t,e,this._data[e])}this._updateCacheArray={}}else for(var i in r){let e=parseInt(i);this._data[e]&&(this._updateCacheArray[e]&&this._updateCacheArray[e].call(a,e,this._data[e]))}return a}let s=g.instance.bufferMgr,n=new S(e,r,s,this);this._subUboBufferNumber++,this._needCacheData=!0,n.notifyGPUBufferChange(),this._subUniformBuffers.set(e,n);let _=t.Shader3D.propertyNameToID(e);return this._data[_]=n,r.forEach((e=>{let t=e.id,r=this._data[t];null!=r&&n.setUniformData(t,e.uniformtype,r),this._uniformBuffersPropertyMap.set(t,n)})),n}getData(){return this._data}addDefine(e){this._defineDatas.add(e)}addDefines(e){this._defineDatas.addDefineDatas(e)}removeDefine(e){this._defineDatas.remove(e)}hasDefine(e){return this._defineDatas.has(e)}clearDefine(){this._defineDatas.clear()}clearData(){for(const e in this._data)this._data[e]instanceof t.Resource&&this._data[e]._removeReference();this._uniformBuffersPropertyMap.clear(),this._uniformBuffers.forEach((e=>{e.destroy()})),this._uniformBuffers.clear(),this._subUniformBuffers.forEach((e=>{e.destroy()})),this._subUniformBuffers.clear(),this._data={},this._gammaColorMap.clear(),this.clearDefine(),this._needCacheData=!1,this._subUboBufferNumber=0}getBool(e){return this._data[e]}setBool(e,t){this._data[e]=t,this._needCacheData}getInt(e){return this._data[e]}setInt(e,t){this._data[e]=t,this._needCacheData&&(this._updateCacheArray[e]=p.prototype.setInt)}getNumber(e){return this._data[e]}setNumber(e,t){this._data[e]=t,this._needCacheData&&(this._updateCacheArray[e]=p.prototype.setFloat)}getVector2(e){return this._data[e]}setVector2(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=p.prototype.setVector2)}getVector3(e){return this._data[e]}setVector3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=p.prototype.setVector3)}getVector(e){return this._data[e]}setVector(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=p.prototype.setVector4)}getColor(e){return this._gammaColorMap.get(e)}setColor(e,r){if(r){if(this._data[e]){let a=this._gammaColorMap.get(e);r.cloneTo(a);let i=this._data[e];i.x=t.Color.gammaToLinearSpace(r.r),i.y=t.Color.gammaToLinearSpace(r.g),i.z=t.Color.gammaToLinearSpace(r.b),i.w=r.a}else{let a=new t.Vector4;a.x=t.Color.gammaToLinearSpace(r.r),a.y=t.Color.gammaToLinearSpace(r.g),a.z=t.Color.gammaToLinearSpace(r.b),a.w=r.a,this._data[e]=a,this._gammaColorMap.set(e,r.clone())}this._needCacheData&&(this._updateCacheArray[e]=p.prototype.setVector4)}}getLinearColor(e){return this._data[e]}getMatrix4x4(e){return this._data[e]}setMatrix4x4(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=p.prototype.setMatrix4x4)}getMatrix3x3(e){return this._data[e]}setMatrix3x3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=p.prototype.setMatrix3x3)}getBuffer(e){return this._data[e]}setBuffer(e,t){this._data[e]=t,this._needCacheData&&(this._updateCacheArray[e]=p.prototype.setBuffer)}setTexture(e,t){var r=this._data[e];if(t){let r=g._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t,r&&r._removeReference(),t&&t._addReference()}_setInternalTexture(e,t){if(this._data[e],t){let r=g._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t}getTexture(e){return this._data[e]}getSourceIndex(e){for(var t in this._data)if(this._data[t]==e)return Number(t);return-1}cloneTo(e){e.clearData();var r=e._data;for(var a in this._data){var i=this._data[a];if(null!=i)if("number"==typeof i)r[a]=i;else if("boolean"==typeof i)r[a]=i;else if(i instanceof t.Vector2){let e=r[a]||(r[a]=new t.Vector2);i.cloneTo(e)}else if(i instanceof t.Vector3){let e=r[a]||(r[a]=new t.Vector3);i.cloneTo(e)}else if(i instanceof t.Vector4){let s=this.getColor(parseInt(a));if(s){let t=s.clone();e.setColor(parseInt(a),t)}else{let e=r[a]||(r[a]=new t.Vector4);i.cloneTo(e)}}else if(i instanceof t.Matrix3x3){let e=r[a]||(r[a]=new t.Matrix3x3);i.cloneTo(e)}else if(i instanceof t.Matrix4x4){let e=r[a]||(r[a]=new t.Matrix4x4);i.cloneTo(e)}else i instanceof t.Resource&&(r[a]=i,i._addReference())}this._defineDatas.cloneTo(e._defineDatas),this._gammaColorMap.forEach(((t,r)=>{e._gammaColorMap.set(r,t.clone())}))}getDefineData(){return this._defineDatas}clone(){var e=new A;return this.cloneTo(e),e}destroy(){this.clearData(),this._defineDatas.destroy(),this._defineDatas=null,this._gammaColorMap.clear(),this._gammaColorMap=null}}class b{get renderState(){return this._renderState}set renderState(e){this._renderState=e}get validDefine(){return this._validDefine}set validDefine(e){this._validDefine=e}constructor(e){this._cacheShaderHierarchy=1,this._cacheSharders={},this._renderState=new t.RenderState,this._renderState.setNull()}_resizeCacheShaderMap(e,t,r){var a=this._cacheShaderHierarchy-1;if(t==a)for(var i in e)for(var s=e[i],n=0,_=r-a;n<_;n++)n==_-1?e[0]=s:e=e[0==n?i:0]={};else for(var i in++t,e)this._resizeCacheShaderMap(e[i],t,r)}setCacheShader(e,t){for(var r=this._cacheSharders,a=e._mask,i=e._length-1,s=this._cacheShaderHierarchy-1,n=0;n<s;n++){var _=i<n?0:a[n],o=r[_];o||(r[_]=o={}),r=o}r[i<s?0:a[s]]=t}getCacheShader(e){e._intersectionDefineDatas(this._validDefine);var t=this._cacheSharders,r=e._length;r>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(t,0,r),this._cacheShaderHierarchy=r);for(var a=e._mask,i=e._length-1,s=this._cacheShaderHierarchy-1,n=0;n<s;n++){var _=i<n?0:a[n],o=t[_];o||(t[_]=o={}),t=o}return t[i<s?0:a[s]]}destroy(){}}class P{setUniformMap(e){}destroy(){throw new t.NotImplementedError}addShaderPass(e){}}class B{createSubShader(){return new P}createShaderPass(e){return new b(e)}createRenderState(){return new t.RenderState}createDefineDatas(){return new r}}t.Laya.addBeforeInitCallback((()=>{t.LayaGL.unitRenderModuleDataFactory||(t.LayaGL.unitRenderModuleDataFactory=new B)}));class C extends t.SetRendertarget2DCMD{constructor(){super(),this.type=t.RenderCMDType.ChangeRenderTarget,this._clearColorValue=new t.Color}apply(e){this.rt?e.invertY=this.invertY:e.invertY=!1,e.setRenderTarget(this.rt,this.clearColor,this.clearColorValue)}}class F extends t.Draw2DElementCMD{constructor(){super(),this.type=t.RenderCMDType.DrawElement}setRenderelements(e){this._elemets=e}apply(e){1==this._elemets.length?e.drawRenderElementOne(this._elemets[0]):this._elemets.forEach((t=>{e.drawRenderElementOne(t)}))}}class D extends t.Blit2DQuadCMD{static _init_(){D.SCREENTEXTURE_ID=t.Shader3D.propertyNameToID("u_MainTex"),D.SCREENTEXTUREOFFSETSCALE_ID=t.Shader3D.propertyNameToID("u_OffsetScale"),D.MAINTEXTURE_TEXELSIZE_ID=t.Shader3D.propertyNameToID("u_MainTex_TexelSize")}constructor(){super(),D.SCREENTEXTURE_ID||D._init_(),this.type=t.RenderCMDType.Blit,this._offsetScale=new t.Vector4,this._sourceTexelSize=new t.Vector4}set source(e){this._source=e,this._source&&this._sourceTexelSize.setValue(1/this._source.width,1/this._source.height,this._source.width,this._source.height)}apply(e){let r=e.invertY;this._dest||(e.invertY=!1),this.element.materialShaderData._setInternalTexture(D.SCREENTEXTURE_ID,this._source),this.element.materialShaderData.setVector(D.SCREENTEXTUREOFFSETSCALE_ID,this._offsetScale),this.element.materialShaderData.setVector(D.MAINTEXTURE_TEXELSIZE_ID,this._sourceTexelSize),e.setRenderTarget(this._dest,!1,t.Color.BLACK),e.drawRenderElementOne(this.element),e.invertY=r}}class L extends t.SetRenderDataCMD{get dataType(){return this._dataType}set dataType(e){this._dataType=e}get propertyID(){return this._propertyID}set propertyID(e){this._propertyID=e}get dest(){return this._dest}set dest(e){this._dest=e}get value(){return this._value}set value(e){switch(this.dataType){case t.ShaderDataType.Int:case t.ShaderDataType.Float:case t.ShaderDataType.Bool:this.data_number=e,this._value=this.data_number;break;case t.ShaderDataType.Matrix4x4:!this.data_mat&&(this.data_mat=new t.Matrix4x4),e.cloneTo(this.data_mat),this._value=this.data_mat;break;case t.ShaderDataType.Color:!this.data_Color&&(this.data_Color=new t.Color),e.cloneTo(this.data_Color),this._value=this.data_Color;break;case t.ShaderDataType.Texture2D:this._value=this.data_texture=e;break;case t.ShaderDataType.Vector4:!this.data_v4&&(this.data_v4=new t.Vector4),e.cloneTo(this.data_v4),this._value=this.data_v4;break;case t.ShaderDataType.Vector2:!this.data_v2&&(this.data_v2=new t.Vector2),e.cloneTo(this.data_v2),this._value=this.data_v2;break;case t.ShaderDataType.Vector3:!this.data_v3&&(this.data_v3=new t.Vector3),e.cloneTo(this.data_v3),this._value=this.data_v3;break;case t.ShaderDataType.Buffer:this._value=this.data_Buffer=e}}constructor(){super(),this.type=t.RenderCMDType.ChangeData}apply(e){switch(this.dataType){case t.ShaderDataType.Int:this.dest.setInt(this.propertyID,this.value);break;case t.ShaderDataType.Float:this.dest.setNumber(this.propertyID,this.value);break;case t.ShaderDataType.Bool:this.dest.setBool(this.propertyID,this.value);break;case t.ShaderDataType.Matrix4x4:this.dest.setMatrix4x4(this.propertyID,this.value);break;case t.ShaderDataType.Color:this.dest.setColor(this.propertyID,this.value);break;case t.ShaderDataType.Texture2D:this.dest.setTexture(this.propertyID,this.value);break;case t.ShaderDataType.Vector4:this.dest.setVector(this.propertyID,this.value);break;case t.ShaderDataType.Vector2:this.dest.setVector2(this.propertyID,this.value);break;case t.ShaderDataType.Vector3:this.dest.setVector3(this.propertyID,this.value);break;case t.ShaderDataType.Buffer:this.dest.setBuffer(this.propertyID,this.value)}}}class M extends t.SetShaderDefineCMD{get define(){return this._define}set define(e){this._define=e}get dest(){return this._dest}set dest(e){this._dest=e}get add(){return this._add}set add(e){this._add=e}constructor(){super(),this.type=t.RenderCMDType.ChangeShaderDefine}apply(e){this.add?this._dest.addDefine(this.define):this._dest.removeDefine(this.define)}}class y{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e,this._shaderValues=this._vertexDeclaration._shaderValues}constructor(e,r){this._glBuffer=g.instance.createBuffer(e,r),g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_VertexBuffer,1)}_changeMemory(e){g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_VertexBuffer,-this._glBuffer._byteLength+e)}setDataLength(e){this._changeMemory(e),this._glBuffer.setDataLength(e)}setData(e,t,r,a){if(this.bind(),0!==r||a!==Number.MAX_SAFE_INTEGER){var i=new Uint8Array(e,r,a);this._glBuffer.setData(i,t)}else this._glBuffer.setData(e,t)}bind(){return this._glBuffer.bindBuffer()}unbind(){return this._glBuffer.unbindBuffer()}orphanStorage(){this.bind(),this._glBuffer.setDataLength(this._glBuffer._byteLength)}destroy(){this._glBuffer.destroy(),this._vertexDeclaration=null,this._changeMemory(0),g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_VertexBuffer,-1)}}class G{constructor(){if(this._clearColor=new t.Color(0,0,0,0),this.invertY=!1,this.pipelineMode="Forward",this._globalConfigShaderData=t.Shader3D._configDefineValues,t.LayaEnv.isConch&&!G.isCreateBlitScreenELement){!G.isCreateBlitScreenELement&&this.setBlitScreenElement(),G.blitContext=new G;let e=t.LayaGL.renderEngine;e.on("endFrame",(()=>{let r=g._lastFrameBuffer_WebGLOBJ,a=g._lastFrameBuffer;g._lastFrameBuffer_WebGLOBJ=null,g._lastFrameBuffer=null,G.blitContext.setOffscreenView(e.getInnerWidth(),e.getInnerHeight()),G.blitContext.setRenderTarget(null,!0,t.Color.BLACK),G.blitScreenElement.materialShaderData._setInternalTexture(t.Shader3D.propertyNameToID("u_MainTex"),a._textures[0]),G.blitContext.drawRenderElementOne(G.blitScreenElement),g._lastFrameBuffer_WebGLOBJ=r,g._lastFrameBuffer=a,g.instance.getTextureContext().bindRenderTarget(a)}))}}setBlitScreenElement(){let e=t.LayaGL.render2DRenderPassFactory.createRenderElement2D(),r=t.LayaGL.renderDeviceFactory.createShaderData(),a=new Float32Array([1,1,1,1,1,-1,1,0,-1,1,0,1,-1,-1,0,0]),i=new y(t.BufferTargetType.ARRAY_BUFFER,t.BufferUsage.Dynamic);i.setDataLength(64),i.setData(a.buffer,0,0,a.buffer.byteLength);let s=new t.VertexDeclaration(16,[new t.VertexElement(0,t.VertexElementFormat.Vector4,0)]);i.vertexDeclaration=s;let n=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.TriangleStrip,t.DrawType.DrawArray);n.setDrawArrayParams(0,4);let _=t.LayaGL.renderDeviceFactory.createBufferState();_.applyState([i],null),n.bufferState=_;let o={a_PositionTexcoord:[0,t.ShaderDataType.Vector4]},l={u_MainTex:t.ShaderDataType.Texture2D},h=t.Shader3D.add("GLESblitScreen",!1,!1);h.shaderType=t.ShaderFeatureType.DEFAULT;let u=new t.SubShader(o,l,{});h.addSubShader(u);let d=u.addShaderPass("\n            #define SHADER_NAME GLESblitScreenVS\n\n            varying vec2 v_Texcoord0;\n\n            void main()\n            {\n                gl_Position = vec4(- 1.0 + (a_PositionTexcoord.x + 1.0), (1.0 - ((- 1.0 + (-a_PositionTexcoord.y + 1.0)) + 1.0) / 2.0) * 2.0 - 1.0, 0.0, 1.0);\n\n                v_Texcoord0 = a_PositionTexcoord.zw;\n            }\n        ",'\n            #define SHADER_NAME GLESblitScreenFS\n\n            #include "Color.glsl";\n\n            varying vec2 v_Texcoord0;\n\n            void main()\n            {\n                vec4 mainColor = texture2D(u_MainTex, v_Texcoord0);\n               \n                gl_FragColor = mainColor;\n            }\n        ');d.statefirst=!0;let m=d.renderState;m.depthTest=t.RenderState.DEPTHTEST_ALWAYS,m.depthWrite=!1,m.cull=t.RenderState.CULL_NONE,m.blend=t.RenderState.BLEND_DISABLE,m.stencilRef=1,m.stencilTest=t.RenderState.STENCILTEST_OFF,m.stencilWrite=!1,m.stencilOp=new t.Vector3(t.RenderState.STENCILOP_KEEP,t.RenderState.STENCILOP_KEEP,t.RenderState.STENCILOP_REPLACE),e.geometry=n,e.materialShaderData=r,e.subShader=u,e.renderStateIsBySprite=!1,G.isCreateBlitScreenELement=!0,G.blitScreenElement=e}drawRenderElementList(e){for(var t=0,r=e.length;t<r;t++){e.elements[t]._prepare(this)}for(t=0,r=e.length;t<r;t++){e.elements[t]._render(this)}return 0}setOffscreenView(e,t){this._offscreenWidth=e,this._offscreenHeight=t}setRenderTarget(e,r,a){this._destRT=e,a.cloneTo(this._clearColor),this._destRT?(g.instance.getTextureContext().bindRenderTarget(this._destRT),g.instance.viewport(0,0,this._destRT._textures[0].width,this._destRT._textures[0].height)):(g.instance.getTextureContext().bindoutScreenTarget(),g.instance.viewport(0,0,this._offscreenWidth,this._offscreenHeight)),g.instance.scissorTest(!1),g.instance.clearRenderTexture(r?t.RenderClearFlag.Color:t.RenderClearFlag.Nothing,this._clearColor)}getRenderTarget(){return this._destRT}drawRenderElementOne(e){e._prepare(this),e._render(this)}runOneCMD(e){e.apply(this)}runCMDList(e){e.forEach((e=>{e.apply(this)}))}}G.isCreateBlitScreenELement=!1;class U{constructor(){this.renderStateIsBySprite=!0,this._shaderInstances=new t.FastSinglelist}_compileShader(e){var r=this.subShader._passes;this._shaderInstances.clear();for(var a=0,i=r.length;a<i;a++){var s=r[a];if(s.pipelineMode!==e.pipelineMode)continue;var n=U._compileDefine;e.sceneData?e.sceneData._defineDatas.cloneTo(n):e._globalConfigShaderData.cloneTo(n),!e._destRT||1!=e._destRT._textures[0].gammaCorrection?n.add(t.ShaderDefines2D.GAMMASPACE):n.remove(t.ShaderDefines2D.GAMMASPACE),e.invertY?n.add(t.ShaderDefines2D.INVERTY):n.remove(t.ShaderDefines2D.INVERTY),this.value2DShaderData&&(n.addDefineDatas(this.value2DShaderData.getDefineData()),s.nodeCommonMap=this.nodeCommonMap),this.materialShaderData&&n.addDefineDatas(this.materialShaderData._defineDatas);var _=s.withCompile(n,!0);this._shaderInstances.add(_)}}_prepare(e){this._compileShader(e)}_render(e){if(1==this._shaderInstances.length)this.renderByShaderInstance(this._shaderInstances.elements[0],e);else for(var t=this._shaderInstances.elements,r=0,a=this._shaderInstances.length;r<a;r++)this.renderByShaderInstance(t[r],e)}renderByShaderInstance(e,t){e.complete&&(e.bind(),this.value2DShaderData&&e.uploadUniforms(e._sprite2DUniformParamsMap,this.value2DShaderData,!0),t.sceneData&&e.uploadUniforms(e._sceneUniformParamsMap,t.sceneData,!0),this.materialShaderData&&e.uploadUniforms(e._materialUniformParamsMap,this.materialShaderData,!0),this.renderStateIsBySprite||!this.materialShaderData?(e.uploadRenderStateBlendDepth(this.value2DShaderData),e.uploadRenderStateFrontFace(this.value2DShaderData,!1,t.invertY)):(e.uploadRenderStateBlendDepth(this.materialShaderData),e.uploadRenderStateFrontFace(this.materialShaderData,!1,t.invertY)),g.instance.getDrawContext().drawGeometryElement(this.geometry))}destroy(){}}U._compileDefine=new r;class I{constructor(){}createSetRenderDataCMD(){return new L}createSetShaderDefineCMD(){return new M}createBlit2DQuadCMDData(){return new D}createDraw2DElementCMDData(){return new F}createSetRendertarget2DCMD(){return new C}createRenderElement2D(){return new U}createRenderContext2D(){return new G}}t.Laya.addBeforeInitCallback((()=>{t.LayaGL.render2DRenderPassFactory||(t.LayaGL.render2DRenderPassFactory=new I)}));class N{constructor(){this._glVertexState=g.instance.createVertexState()}applyVertexBuffers(){this._glVertexState.applyVertexBuffer(this._vertexBuffers)}applyIndexBuffers(){this._glVertexState.applyIndexBuffer(this._bindedIndexBuffer)}applyState(e,t){this._vertexBuffers=e.slice(),this._bindedIndexBuffer=t,t&&t._glBuffer.unbindBuffer(),this.bind(),this.applyVertexBuffers(),this.applyIndexBuffers(),this.unBind(),t&&t._glBuffer.unbindBuffer()}bind(){this._glVertexState.bindVertexArray(),N._curBindedBufferState=this}unBind(){if(N._curBindedBufferState!=this)throw"BufferState: must call bind() function first.";this._glVertexState.unbindVertexArray(),N._curBindedBufferState=null}isBind(){return N._curBindedBufferState==this}destroy(){N._curBindedBufferState==this&&(this._glVertexState.unbindVertexArray(),N._curBindedBufferState=null),this._glVertexState.destroy(),this._vertexBuffers=null,this._bindedIndexBuffer=null}}class O extends t.CommandUniformMap{constructor(e){super(e),this._idata=new Map,this._stateName=e,this._stateID=t.Shader3D.propertyNameToID(e)}hasPtrID(e){return this._stateID==e||this._idata.has(e)}addShaderUniform(e,t,r){this._idata.set(e,{id:e,uniformtype:r,propertyName:t,arrayLength:0})}addShaderUniformArray(e,r,a,i,s=""){if(a!==t.ShaderDataType.Matrix4x4&&a!==t.ShaderDataType.Vector4)throw"because of align rule, the engine does not support other types as arrays.";this._idata.set(e,{id:e,uniformtype:a,propertyName:r,arrayLength:i})}}class v{constructor(e,r){this._glBuffer=this._glBuffer=g.instance.createBuffer(e,r),g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_IndexBuffer,1)}_changeMemory(e){g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_IndexBuffer,-this._glBuffer._byteLength+e)}_setIndexDataLength(e){this._changeMemory(e);var t=N._curBindedBufferState;t?(t.unBind(),this._glBuffer.bindBuffer(),this._glBuffer.setDataLength(e),t.bind()):(this._glBuffer.bindBuffer(),this._glBuffer.setDataLength(e))}_setIndexData(e,t){var r=N._curBindedBufferState;r?(r.unBind(),this._glBuffer.bindBuffer(),this._glBuffer.setData(e,t),r.bind()):(this._glBuffer.bindBuffer(),this._glBuffer.setData(e,t))}destroy(){this._glBuffer.destroy(),this._changeMemory(0),g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_IndexBuffer,-1)}}class w{get indexFormat(){return this._indexFormat}set indexFormat(e){this._indexFormat=e,this._glindexFormat=g.instance.getDrawContext().getIndexType(this._indexFormat)}get mode(){return this._mode}set mode(e){this._mode=e,this._glmode=g.instance.getDrawContext().getMeshTopology(this._mode)}constructor(e,r){this._id=++w._idCounter,this.mode=e,this.drawParams=new t.FastSinglelist,this.drawType=r}getDrawDataParams(e){e&&this.drawParams.cloneTo(e)}setDrawArrayParams(e,t){this.drawParams.add(e),this.drawParams.add(t)}setDrawElemenParams(e,t){this.drawParams.add(t),this.drawParams.add(e)}destroy(){delete this.drawParams}clearRenderParams(){this.drawParams.length=0}cloneTo(e){e.mode=this.mode,e.drawType=this.drawType,e.indexFormat=this.indexFormat,e.instanceCount=this.instanceCount,e.drawParams.elements=this.drawParams.elements.slice(),e.drawParams.length=this.drawParams.length}}w._idCounter=0;class W{constructor(){this._customUniformParamsMap=[],this._uploadMark=-1,this._uploadRenderType=-1}_serializeShader(){return null}_deserialize(e){return!1}get complete(){return this._renderShaderInstance._complete}_create(e,r){let a=t.Config.matUseUBO;t.Config.matUseUBO=!e.is2D&&t.Config.matUseUBO;let i=t.GLSLCodeGenerator.GLShaderLanguageProcess3D(e.defineString,e.attributeMap,e.uniformMap,e.vs,e.ps,r._owner._owner.name);this._renderShaderInstance=g.instance.createShaderInstance(i.vs,i.fs,e.attributeMap),t.Config.matUseUBO=a,g._lastShaderError&&console.warn(`[ShaderCompile]Error compiling shader '${r._owner._owner.name}' (pipelineMode=${r.pipelineMode})\n`,g._lastShaderError),this._renderShaderInstance._complete&&(this._shaderPass=r,e.is2D?this._create2D():this._create3D())}_create3D(){this._sceneUniformParamsMap=new t.CommandEncoder,this._cameraUniformParamsMap=new t.CommandEncoder,this._spriteUniformParamsMap=new t.CommandEncoder,this._materialUniformParamsMap=new t.CommandEncoder;const e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Scene3D"),r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("BaseCamera"),a=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Custom");let i,s,n=this._renderShaderInstance.getUniformMap();for(i=0,s=n.length;i<s;i++){let t=n[i];e.hasPtrID(t.dataOffset)?this._sceneUniformParamsMap.addShaderUniform(t):r.hasPtrID(t.dataOffset)?this._cameraUniformParamsMap.addShaderUniform(t):this.hasSpritePtrID(t.dataOffset)?this._spriteUniformParamsMap.addShaderUniform(t):a.hasPtrID(t.dataOffset)?(this._customUniformParamsMap||(this._customUniformParamsMap=[]),this._customUniformParamsMap[t.dataOffset]=t):this._materialUniformParamsMap.addShaderUniform(t)}}_create2D(){this._sprite2DUniformParamsMap=new t.CommandEncoder,this._materialUniformParamsMap=new t.CommandEncoder,this._sceneUniformParamsMap=new t.CommandEncoder;const e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal");let r,a,i=this._renderShaderInstance.getUniformMap();for(r=0,a=i.length;r<a;r++){let t=i[r];this.hasSpritePtrID(t.dataOffset)?this._sprite2DUniformParamsMap.addShaderUniform(t):e.hasPtrID(t.dataOffset)?this._sceneUniformParamsMap.addShaderUniform(t):this._materialUniformParamsMap.addShaderUniform(t)}}hasSpritePtrID(e){let r=this._shaderPass.nodeCommonMap;if(r){for(let a=0,i=r.length;a<i;a++)if(t.LayaGL.renderDeviceFactory.createGlobalUniformMap(r[a]).hasPtrID(e))return!0;return!1}return!1}_disposeResource(){this._renderShaderInstance.destroy(),this._sceneUniformParamsMap=null,this._cameraUniformParamsMap=null,this._spriteUniformParamsMap=null,this._materialUniformParamsMap=null,this._customUniformParamsMap=null,this._uploadMaterial=null,this._uploadRender=null,this._uploadCameraShaderValue=null,this._uploadScene=null}bind(){return this._renderShaderInstance.bind()}uploadUniforms(e,r,a){g.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_UniformBufferUploadCount,g.instance.uploadUniforms(this._renderShaderInstance,e,r,a))}uploadRenderStateBlendDepth(e){this._shaderPass.statefirst?this.uploadRenderStateBlendDepthByShader(e):this.uploadRenderStateBlendDepthByMaterial(e)}uploadRenderStateBlendDepthByShader(e){var r,a,i,s,n,_,o,l,h,u,d,m,c,f,E,T,g,p,x,R,S,A,b,P,B,C,F,D,L,M,y,G,U=e._data,I=this._shaderPass.renderState,N=null!==(a=null!==(r=I.depthWrite)&&void 0!==r?r:U[t.Shader3D.DEPTH_WRITE])&&void 0!==a?a:t.RenderState.Default.depthWrite;t.RenderStateContext.setDepthMask(N);var O=null!==(s=null!==(i=I.depthTest)&&void 0!==i?i:U[t.Shader3D.DEPTH_TEST])&&void 0!==s?s:t.RenderState.Default.depthTest;O==t.RenderState.DEPTHTEST_OFF?t.RenderStateContext.setDepthTest(!1):(t.RenderStateContext.setDepthTest(!0),t.RenderStateContext.setDepthFunc(O));var v=null!==(_=null!==(n=I.stencilWrite)&&void 0!==n?n:U[t.Shader3D.STENCIL_WRITE])&&void 0!==_?_:t.RenderState.Default.stencilWrite,w=null!==(l=null!==(o=I.stencilTest)&&void 0!==o?o:U[t.Shader3D.STENCIL_TEST])&&void 0!==l?l:t.RenderState.Default.stencilTest;if(t.RenderStateContext.setStencilMask(v),v){var W=null!==(u=null!==(h=I.stencilOp)&&void 0!==h?h:U[t.Shader3D.STENCIL_Op])&&void 0!==u?u:t.RenderState.Default.stencilOp;t.RenderStateContext.setstencilOp(W.x,W.y,W.z)}if(w==t.RenderState.STENCILTEST_OFF)t.RenderStateContext.setStencilTest(!1);else{var V=null!==(m=null!==(d=I.stencilRef)&&void 0!==d?d:U[t.Shader3D.STENCIL_Ref])&&void 0!==m?m:t.RenderState.Default.stencilRef;t.RenderStateContext.setStencilTest(!0),t.RenderStateContext.setStencilFunc(w,V)}switch(null!==(f=null!==(c=I.blend)&&void 0!==c?c:U[t.Shader3D.BLEND])&&void 0!==f?f:t.RenderState.Default.blend){case t.RenderState.BLEND_DISABLE:t.RenderStateContext.setBlend(!1);break;case t.RenderState.BLEND_ENABLE_ALL:var X=null!==(T=null!==(E=I.blendEquation)&&void 0!==E?E:U[t.Shader3D.BLEND_EQUATION])&&void 0!==T?T:t.RenderState.Default.blendEquation,k=null!==(p=null!==(g=I.srcBlend)&&void 0!==g?g:U[t.Shader3D.BLEND_SRC])&&void 0!==p?p:t.RenderState.Default.srcBlend,H=null!==(R=null!==(x=I.dstBlend)&&void 0!==x?x:U[t.Shader3D.BLEND_DST])&&void 0!==R?R:t.RenderState.Default.dstBlend;t.RenderStateContext.setBlend(!0),t.RenderStateContext.setBlendEquation(X),t.RenderStateContext.setBlendFunc(k,H);break;case t.RenderState.BLEND_ENABLE_SEPERATE:var Y=null!==(A=null!==(S=I.blendEquationRGB)&&void 0!==S?S:U[t.Shader3D.BLEND_EQUATION_RGB])&&void 0!==A?A:t.RenderState.Default.blendEquationRGB,K=null!==(P=null!==(b=I.blendEquationAlpha)&&void 0!==b?b:U[t.Shader3D.BLEND_EQUATION_ALPHA])&&void 0!==P?P:t.RenderState.Default.blendEquationAlpha,z=null!==(C=null!==(B=I.srcBlendRGB)&&void 0!==B?B:U[t.Shader3D.BLEND_SRC_RGB])&&void 0!==C?C:t.RenderState.Default.srcBlendRGB,j=null!==(D=null!==(F=I.dstBlendRGB)&&void 0!==F?F:U[t.Shader3D.BLEND_DST_RGB])&&void 0!==D?D:t.RenderState.Default.dstBlendRGB,q=null!==(M=null!==(L=I.srcBlendAlpha)&&void 0!==L?L:U[t.Shader3D.BLEND_SRC_ALPHA])&&void 0!==M?M:t.RenderState.Default.srcBlendAlpha,Z=null!==(G=null!==(y=I.dstBlendAlpha)&&void 0!==y?y:U[t.Shader3D.BLEND_DST_ALPHA])&&void 0!==G?G:t.RenderState.Default.dstBlendAlpha;t.RenderStateContext.setBlend(!0),t.RenderStateContext.setBlendEquationSeparate(Y,K),t.RenderStateContext.setBlendFuncSeperate(z,j,q,Z)}}uploadRenderStateBlendDepthByMaterial(e){var r=e.getData(),a=r[t.Shader3D.DEPTH_WRITE];a=null!=a?a:t.RenderState.Default.depthWrite,t.RenderStateContext.setDepthMask(a);var i=r[t.Shader3D.DEPTH_TEST];(i=null!=i?i:t.RenderState.Default.depthTest)===t.RenderState.DEPTHTEST_OFF?t.RenderStateContext.setDepthTest(!1):(t.RenderStateContext.setDepthTest(!0),t.RenderStateContext.setDepthFunc(i));var s=r[t.Shader3D.STENCIL_WRITE];if(s=null!=s?s:t.RenderState.Default.stencilWrite,t.RenderStateContext.setStencilMask(s),s){var n=r[t.Shader3D.STENCIL_Op];n=null!=n?n:t.RenderState.Default.stencilOp,t.RenderStateContext.setstencilOp(n.x,n.y,n.z)}var _=r[t.Shader3D.STENCIL_TEST];if((_=null!=_?_:t.RenderState.Default.stencilTest)==t.RenderState.STENCILTEST_OFF)t.RenderStateContext.setStencilTest(!1);else{var o=r[t.Shader3D.STENCIL_Ref];o=null!=o?o:t.RenderState.Default.stencilRef,t.RenderStateContext.setStencilTest(!0),t.RenderStateContext.setStencilFunc(_,o)}var l=r[t.Shader3D.BLEND];switch(l=null!=l?l:t.RenderState.Default.blend){case t.RenderState.BLEND_ENABLE_ALL:var h=r[t.Shader3D.BLEND_EQUATION];h=null!=h?h:t.RenderState.Default.blendEquation;var u=r[t.Shader3D.BLEND_SRC];u=null!=u?u:t.RenderState.Default.srcBlend;var d=r[t.Shader3D.BLEND_DST];d=null!=d?d:t.RenderState.Default.dstBlend,t.RenderStateContext.setBlend(!0),t.RenderStateContext.setBlendEquation(h),t.RenderStateContext.setBlendFunc(u,d);break;case t.RenderState.BLEND_ENABLE_SEPERATE:var m=r[t.Shader3D.BLEND_EQUATION_RGB];m=null!=m?m:t.RenderState.Default.blendEquationRGB;var c=r[t.Shader3D.BLEND_EQUATION_ALPHA];c=null!=c?c:t.RenderState.Default.blendEquationAlpha;var f=r[t.Shader3D.BLEND_SRC_RGB];f=null!=f?f:t.RenderState.Default.srcBlendRGB;var E=r[t.Shader3D.BLEND_DST_RGB];E=null!=E?E:t.RenderState.Default.dstBlendRGB;var T=r[t.Shader3D.BLEND_SRC_ALPHA];T=null!=T?T:t.RenderState.Default.srcBlendAlpha;var g=r[t.Shader3D.BLEND_DST_ALPHA];g=null!=g?g:t.RenderState.Default.dstBlendAlpha,t.RenderStateContext.setBlend(!0),t.RenderStateContext.setBlendEquationSeparate(m,c),t.RenderStateContext.setBlendFuncSeperate(f,E,T,g);break;case t.RenderState.BLEND_DISABLE:default:t.RenderStateContext.setBlend(!1)}}uploadRenderStateFrontFace(e,r,a){var i,s,n=this._shaderPass.renderState,_=e.getData()[t.Shader3D.CULL];switch(this._shaderPass.statefirst&&(_=null!==(i=n.cull)&&void 0!==i?i:_),_=null!=_?_:t.RenderState.Default.cull){case t.RenderState.CULL_NONE:t.RenderStateContext.setCullFace(!1),s=r!=a?t.CullMode.Front:t.CullMode.Back,t.RenderStateContext.setFrontFace(s);break;case t.RenderState.CULL_FRONT:t.RenderStateContext.setCullFace(!0),s=r==a?t.CullMode.Front:t.CullMode.Back,t.RenderStateContext.setFrontFace(s);break;case t.RenderState.CULL_BACK:default:t.RenderStateContext.setCullFace(!0),s=r!=a?t.CullMode.Front:t.CullMode.Back,t.RenderStateContext.setFrontFace(s)}}uploadCustomUniform(e,t){g.instance.uploadCustomUniforms(this._renderShaderInstance,this._customUniformParamsMap,e,t)}}class V{constructor(){this.globalBlockMap={}}createShaderData(e){return new A(e)}createShaderInstance(e,t){let r=new W;return r._create(e,t),r}createIndexBuffer(e){return new v(t.BufferTargetType.ELEMENT_ARRAY_BUFFER,e)}createVertexBuffer(e){return new y(t.BufferTargetType.ARRAY_BUFFER,e)}createBufferState(){return new N}createRenderGeometryElement(e,t){return new w(e,t)}createGlobalUniformMap(e){let t=this.globalBlockMap[e];return t||(t=this.globalBlockMap[e]=new O(e)),t}createEngine(r,a){let i,s={stencil:t.Config.isStencil,alpha:t.Config.isAlpha,antialias:t.Config.isAntialias,premultipliedAlpha:t.Config.premultipliedAlpha,preserveDrawingBuffer:t.Config.preserveDrawingBuffer,depth:t.Config.isDepth,failIfMajorPerformanceCaveat:t.Config.isfailIfMajorPerformanceCaveat,powerPreference:t.Config.powerPreference};const n=t.Config.useWebGL2?e.WebGLMode.Auto:e.WebGLMode.WebGL1;i=new g(s,n),i.initRenderEngine(a._source);var _=i._context;return t.Config.printWebglOrder&&this._replaceWebglcall(_),_&&new t.LayaGL,t.LayaGL.renderEngine=i,t.LayaGL.textureContext=i.getTextureContext(),Promise.resolve()}_replaceWebglcall(e){var t={};for(const r in e)"function"==typeof e[r]&&"getError"!=r&&"__SPECTOR_Origin_getError"!=r&&"__proto__"!=r&&(t[r]=e[r],e[r]=function(){let a=[];for(let e=0;e<arguments.length;e++)a.push(arguments[e]);let i=t[r].apply(e,a);e.getError();return i})}}t.Laya.addBeforeInitCallback((()=>{t.LayaGL.renderDeviceFactory||(t.LayaGL.renderDeviceFactory=new V)}));class X{constructor(){this.globalBlockMap={}}createEngine(r,a){let i,s={stencil:t.Config.isStencil,alpha:t.Config.isAlpha,antialias:t.Config.isAntialias,premultipliedAlpha:t.Config.premultipliedAlpha,preserveDrawingBuffer:t.Config.preserveDrawingBuffer,depth:t.Config.isDepth,failIfMajorPerformanceCaveat:t.Config.isfailIfMajorPerformanceCaveat,powerPreference:t.Config.powerPreference};const n=t.Config.useWebGL2?e.WebGLMode.Auto:e.WebGLMode.WebGL1;i=new g(s,n),i.initRenderEngine(a._source);var _=i._context;return t.Config.printWebglOrder&&this._replaceWebglcall(_),_&&new t.LayaGL,t.LayaGL.renderEngine=i,t.LayaGL.textureContext=i.getTextureContext(),Promise.resolve()}_replaceWebglcall(e){var t={};for(const r in e)"function"==typeof e[r]&&"getError"!=r&&"__SPECTOR_Origin_getError"!=r&&"__proto__"!=r&&(t[r]=e[r],e[r]=function(){let a=[];for(let e=0;e<arguments.length;e++)a.push(arguments[e]);let i=t[r].apply(e,a);e.getError();return i})}}t.Laya.addBeforeInitCallback((()=>{t.LayaGL.renderOBJCreate||(t.LayaGL.renderOBJCreate=new X)})),e.GL2TextureContext=l,e.GLBuffer=h,e.GLObject=s,e.GLParams=u,e.GLRenderDrawContext=d,e.GLRenderState=m,e.GLShaderInstance=c,e.GLTextureContext=o,e.GLVertexState=f,e.GlCapable=E,e.VertexArrayObject=class{constructor(){}},e.WebDefineDatas=r,e.WebGLBlit2DQuadCMD=D,e.WebGLBufferState=N,e.WebGLCommandUniformMap=O,e.WebGLConfig=class{},e.WebGLDraw2DElementCMD=F,e.WebGLEngine=g,e.WebGLIndexBuffer=v,e.WebGLInternalRT=n,e.WebGLInternalTex=_,e.WebGLRender2DProcess=I,e.WebGLRenderDeviceFactory=V,e.WebGLRenderEngineFactory=X,e.WebGLRenderGeometryElement=w,e.WebGLRenderelement2D=U,e.WebGLSetRenderData=L,e.WebGLSetRendertarget2DCMD=C,e.WebGLSetShaderDefine=M,e.WebGLShaderData=A,e.WebGLShaderInstance=W,e.WebGLSubUniformBuffer=S,e.WebGLUniformBuffer=R,e.WebGLUniformBufferBase=p,e.WebGLUniformBufferDescriptor=x,e.WebGLUniformBufferManager=T,e.WebGLVertexBuffer=y,e.WebShaderPass=b,e.WebSubShader=P,e.WebUnitRenderModuleDataFactory=B,e.WebglRenderContext2D=G}(window.Laya=window.Laya||{},Laya);